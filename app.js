var t,e,s,n,i,a,r,o,c,l,h,d,p,u,g=Object.defineProperty,_=Object.getOwnPropertyNames,m=Object.getOwnPropertyDescriptor,f=Object.prototype.hasOwnProperty,E=t=>{const e=E.moduleCache??=new WeakMap;var s=e.get(t);if(s)return s;var n=g({},'__esModule',{value:!0}),i={enumerable:!1};if(t&&'object'==typeof t||'function'==typeof t)for(let e of _(t))f.call(n,e)||g(n,e,{get:()=>t[e],enumerable:!(i=m(t,e))||i.enumerable});return e.set(t,n),n},O=(t,e)=>{for(var s in e)g(t,s,{get:e[s],enumerable:!0,configurable:!0,set:t=>e[s]=()=>t})},A=(t,e)=>()=>(t&&(e=t(t=0)),e),T=(t=function(t){if('undefined'!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')},'undefined'!=typeof require?require:'undefined'!=typeof Proxy?new Proxy(t,{get:(t,e)=>('undefined'!=typeof require?require:t)[e]}):t),I={};O(I,{default:()=>u});var N,P,L,y,S,v,C,w,R,b,U,D,M,k,x,B,F,H,G,W,z,V,Y,j,K,Z=A((()=>{e=Object.create,s=Object.defineProperty,n=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,a=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty,o=(t,e)=>{for(var n in e)s(t,n,{get:e[n],enumerable:!0})},c=(t,e,a,o)=>{if(e&&'object'==typeof e||'function'==typeof e)for(let c of i(e))!r.call(t,c)&&c!==a&&s(t,c,{get:()=>e[c],enumerable:!(o=n(e,c))||o.enumerable});return t},l=(t,e,s)=>(c(t,e,'default'),s&&c(s,e,'default')),h=(t,n,i)=>(i=null!=t?e(a(t)):{},c(!n&&t&&t.__esModule?i:s(i,'default',{value:t,enumerable:!0}),t)),d=((t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports))(((t,e)=>{function s(t){if('string'!=typeof t)throw new TypeError('Path must be a string. Received '+JSON.stringify(t))}function n(t,e){for(var s,n='',i=0,a=-1,r=0,o=0;o<=t.length;++o){if(o<t.length)s=t.charCodeAt(o);else{if(47===s)break;s=47}if(47===s){if(a!==o-1&&1!==r)if(a!==o-1&&2===r){if(n.length<2||2!==i||46!==n.charCodeAt(n.length-1)||46!==n.charCodeAt(n.length-2))if(n.length>2){var c=n.lastIndexOf('/');if(c!==n.length-1){-1===c?(n='',i=0):i=(n=n.slice(0,c)).length-1-n.lastIndexOf('/'),a=o,r=0;continue}}else if(2===n.length||1===n.length){n='',i=0,a=o,r=0;continue}e&&(n.length>0?n+='/..':n='..',i=2)}else n.length>0?n+='/'+t.slice(a+1,o):n=t.slice(a+1,o),i=o-a-1;a=o,r=0}else 46===s&&-1!==r?++r:r=-1}return n}var i={resolve:function(){for(var t,e='',i=!1,a=arguments.length-1;a>=-1&&!i;a--){var r;a>=0?r=arguments[a]:(void 0===t&&(t=process.cwd()),r=t),s(r),0!==r.length&&(e=r+'/'+e,i=47===r.charCodeAt(0))}return e=n(e,!i),i?e.length>0?'/'+e:'/':e.length>0?e:'.'},normalize:function(t){if(s(t),0===t.length)return'.';var e=47===t.charCodeAt(0),i=47===t.charCodeAt(t.length-1);return 0===(t=n(t,!e)).length&&!e&&(t='.'),t.length>0&&i&&(t+='/'),e?'/'+t:t},isAbsolute:function(t){return s(t),t.length>0&&47===t.charCodeAt(0)},join:function(){if(0===arguments.length)return'.';for(var t,e=0;e<arguments.length;++e){var n=arguments[e];s(n),n.length>0&&(void 0===t?t=n:t+='/'+n)}return void 0===t?'.':i.normalize(t)},relative:function(t,e){if(s(t),s(e),t===e||(t=i.resolve(t))===(e=i.resolve(e)))return'';for(var n=1;n<t.length&&47===t.charCodeAt(n);++n);for(var a=t.length,r=a-n,o=1;o<e.length&&47===e.charCodeAt(o);++o);for(var c=e.length-o,l=r<c?r:c,h=-1,d=0;d<=l;++d){if(d===l){if(c>l){if(47===e.charCodeAt(o+d))return e.slice(o+d+1);if(0===d)return e.slice(o+d)}else r>l&&(47===t.charCodeAt(n+d)?h=d:0===d&&(h=0));break}var p=t.charCodeAt(n+d);if(p!==e.charCodeAt(o+d))break;47===p&&(h=d)}var u='';for(d=n+h+1;d<=a;++d)(d===a||47===t.charCodeAt(d))&&(0===u.length?u+='..':u+='/..');return u.length>0?u+e.slice(o+h):(o+=h,47===e.charCodeAt(o)&&++o,e.slice(o))},_makeLong:function(t){return t},dirname:function(t){if(s(t),0===t.length)return'.';for(var e=t.charCodeAt(0),n=47===e,i=-1,a=!0,r=t.length-1;r>=1;--r)if(47===(e=t.charCodeAt(r))){if(!a){i=r;break}}else a=!1;return-1===i?n?'/':'.':n&&1===i?'//':t.slice(0,i)},basename:function(t,e){if(void 0!==e&&'string'!=typeof e)throw new TypeError('"ext" argument must be a string');s(t);var n,i=0,a=-1,r=!0;if(void 0!==e&&e.length>0&&e.length<=t.length){if(e.length===t.length&&e===t)return'';var o=e.length-1,c=-1;for(n=t.length-1;n>=0;--n){var l=t.charCodeAt(n);if(47===l){if(!r){i=n+1;break}}else-1===c&&(r=!1,c=n+1),o>=0&&(l===e.charCodeAt(o)?-1==--o&&(a=n):(o=-1,a=c))}return i===a?a=c:-1===a&&(a=t.length),t.slice(i,a)}for(n=t.length-1;n>=0;--n)if(47===t.charCodeAt(n)){if(!r){i=n+1;break}}else-1===a&&(r=!1,a=n+1);return-1===a?'':t.slice(i,a)},extname:function(t){s(t);for(var e=-1,n=0,i=-1,a=!0,r=0,o=t.length-1;o>=0;--o){var c=t.charCodeAt(o);if(47!==c)-1===i&&(a=!1,i=o+1),46===c?-1===e?e=o:1!==r&&(r=1):-1!==e&&(r=-1);else if(!a){n=o+1;break}}return-1===e||-1===i||0===r||1===r&&e===i-1&&e===n+1?'':t.slice(e,i)},format:function(t){if(null===t||'object'!=typeof t)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof t);return function(t,e){var s=e.dir||e.root,n=e.base||(e.name||'')+(e.ext||'');return s?s===e.root?s+n:s+t+n:n}('/',t)},parse:function(t){s(t);var e={root:'',dir:'',base:'',ext:'',name:''};if(0===t.length)return e;var n,i=t.charCodeAt(0),a=47===i;a?(e.root='/',n=1):n=0;for(var r=-1,o=0,c=-1,l=!0,h=t.length-1,d=0;h>=n;--h)if(47!==(i=t.charCodeAt(h)))-1===c&&(l=!1,c=h+1),46===i?-1===r?r=h:1!==d&&(d=1):-1!==r&&(d=-1);else if(!l){o=h+1;break}return-1===r||-1===c||0===d||1===d&&r===c-1&&r===o+1?-1!==c&&(e.base=e.name=0===o&&a?t.slice(1,c):t.slice(o,c)):(0===o&&a?(e.name=t.slice(1,r),e.base=t.slice(1,c)):(e.name=t.slice(o,r),e.base=t.slice(o,c)),e.ext=t.slice(r,c)),o>0?e.dir=t.slice(0,o-1):a&&(e.dir='/'),e},sep:'/',delimiter:':',win32:null,posix:null};i.posix=i,e.exports=i})),o(p={},{default:()=>u}),l(p,h(d())),u=h(d())})),$={};O($,{resolveObject:()=>R,resolve:()=>w,parse:()=>v,format:()=>C,default:()=>K,Url:()=>S,URLSearchParams:()=>U,URL:()=>b});var J,X,q,Q,tt=A((()=>{N=function(t){return'string'==typeof t},P=function(t){return'object'==typeof t&&null!==t},L=function(t){return null===t},y=function(t){return null==t},S=function(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null},v=function(t,e,s){if(t&&P(t)&&t instanceof S)return t;var n=new S;return n.parse(t,e,s),n},C=function(t){return N(t)&&(t=v(t)),t instanceof S?t.format():S.prototype.format.call(t)},w=function(t,e){return v(t,!1,!0).resolve(e)},R=function(t,e){return t?v(t,!1,!0).resolveObject(e):e},({URL:b,URLSearchParams:U}=globalThis),D=/^([a-z0-9.+-]+:)/i,M=/:[0-9]*$/,k=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,x=['{','}','|','\\','^','`'].concat(['<','>','"','`',' ','\r',"\n",'\t']),B=["'"].concat(x),F=['%','/','?',';','#'].concat(B),H=['/','?','#'],255,G=/^[+a-z0-9A-Z_-]{0,63}$/,W=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,z={javascript:!0,'javascript:':!0},V={javascript:!0,'javascript:':!0},Y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,'http:':!0,'https:':!0,'ftp:':!0,'gopher:':!0,'file:':!0},j={parse(t){var e=decodeURIComponent;return(t+'').replace(/\+/g,' ').split('&').filter(Boolean).reduce((function(t,s,n){var i=s.split('='),a=e(i[0]||''),r=e(i[1]||''),o=t[a];return t[a]=void 0===o?r:[].concat(o,r),t}),{})},stringify(t){var e=encodeURIComponent;return Object.keys(t||{}).reduce((function(s,n){return[].concat(t[n]).forEach((function(t){s.push(e(n)+'='+e(t))})),s}),[]).join('&').replace(/\s/g,'+')}},S.prototype.parse=function(t,e,s){if(!N(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var n=t.indexOf('?'),i=-1!==n&&n<t.indexOf('#')?'?':'#',a=t.split(i);a[0]=a[0].replace(/\\/g,'/');var r=t=a.join(i);if(r=r.trim(),!s&&1===t.split('#').length){var o=k.exec(r);if(o)return this.path=r,this.href=r,this.pathname=o[1],o[2]?(this.search=o[2],this.query=e?j.parse(this.search.substr(1)):this.search.substr(1)):e&&(this.search='',this.query={}),this}var c=D.exec(r);if(c){var l=(c=c[0]).toLowerCase();this.protocol=l,r=r.substr(c.length)}if(s||c||r.match(/^\/\/[^@\/]+@[^@\/]+/)){var h='//'===r.substr(0,2);h&&(!c||!V[c])&&(r=r.substr(2),this.slashes=!0)}if(!V[c]&&(h||c&&!Y[c])){for(var d=-1,p=0;p<H.length;p++){-1!==(_=r.indexOf(H[p]))&&(-1===d||_<d)&&(d=_)}var u,g;-1!==(g=-1===d?r.lastIndexOf('@'):r.lastIndexOf('@',d))&&(u=r.slice(0,g),r=r.slice(g+1),this.auth=decodeURIComponent(u)),d=-1;for(p=0;p<F.length;p++){var _;-1!==(_=r.indexOf(F[p]))&&(-1===d||_<d)&&(d=_)}-1===d&&(d=r.length),this.host=r.slice(0,d),r=r.slice(d),this.parseHost(),this.hostname=this.hostname||'';var m='['===this.hostname[0]&&']'===this.hostname[this.hostname.length-1];if(!m)for(var f=this.hostname.split(/\./),E=(p=0,f.length);p<E;p++){var O=f[p];if(O&&!O.match(G)){for(var A='',T=0,I=O.length;T<I;T++)O.charCodeAt(T)>127?A+='x':A+=O[T];if(!A.match(G)){var P=f.slice(0,p),L=f.slice(p+1),y=O.match(W);y&&(P.push(y[1]),L.unshift(y[2])),L.length&&(r='/'+L.join('.')+r),this.hostname=P.join('.');break}}}this.hostname.length>255?this.hostname='':this.hostname=this.hostname.toLowerCase(),m||(this.hostname=new b(`https://${this.hostname}`).hostname);var S=this.port?':'+this.port:'',v=this.hostname||'';this.host=v+S,this.href+=this.host,m&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),'/'!==r[0]&&(r='/'+r))}if(!z[l])for(p=0,E=B.length;p<E;p++){var C=B[p];if(-1!==r.indexOf(C)){var w=encodeURIComponent(C);w===C&&(w=escape(C)),r=r.split(C).join(w)}}var R=r.indexOf('#');-1!==R&&(this.hash=r.substr(R),r=r.slice(0,R));var U=r.indexOf('?');if(-1!==U?(this.search=r.substr(U),this.query=r.substr(U+1),e&&(this.query=j.parse(this.query)),r=r.slice(0,U)):e&&(this.search='',this.query={}),r&&(this.pathname=r),Y[l]&&this.hostname&&!this.pathname&&(this.pathname='/'),this.pathname||this.search){S=this.pathname||'';var M=this.search||'';this.path=S+M}return this.href=this.format(),this},S.prototype.format=function(){var t=this.auth||'';t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,':'),t+='@');var e=this.protocol||'',s=this.pathname||'',n=this.hash||'',i=!1,a='';this.host?i=t+this.host:this.hostname&&(i=t+(-1===this.hostname.indexOf(':')?this.hostname:'['+this.hostname+']'),this.port&&(i+=':'+this.port)),this.query&&P(this.query)&&Object.keys(this.query).length&&(a=j.stringify(this.query));var r=this.search||a&&'?'+a||'';return e&&':'!==e.substr(-1)&&(e+=':'),this.slashes||(!e||Y[e])&&!1!==i?(i='//'+(i||''),s&&'/'!==s.charAt(0)&&(s='/'+s)):i||(i=''),n&&'#'!==n.charAt(0)&&(n='#'+n),r&&'?'!==r.charAt(0)&&(r='?'+r),e+i+(s=s.replace(/[?#]/g,(function(t){return encodeURIComponent(t)})))+(r=r.replace('#','%23'))+n},S.prototype.resolve=function(t){return this.resolveObject(v(t,!1,!0)).format()},S.prototype.resolveObject=function(t){if(N(t)){var e=new S;e.parse(t,!1,!0),t=e}for(var s=new S,n=Object.keys(this),i=0;i<n.length;i++){var a=n[i];s[a]=this[a]}if(s.hash=t.hash,''===t.href)return s.href=s.format(),s;if(t.slashes&&!t.protocol){for(var r=Object.keys(t),o=0;o<r.length;o++){var c=r[o];'protocol'!==c&&(s[c]=t[c])}return Y[s.protocol]&&s.hostname&&!s.pathname&&(s.path=s.pathname='/'),s.href=s.format(),s}if(t.protocol&&t.protocol!==s.protocol){if(!Y[t.protocol]){for(var l=Object.keys(t),h=0;h<l.length;h++){var d=l[h];s[d]=t[d]}return s.href=s.format(),s}if(s.protocol=t.protocol,t.host||V[t.protocol])s.pathname=t.pathname;else{for(var p=(t.pathname||'').split('/');p.length&&!(t.host=p.shift()););t.host||(t.host=''),t.hostname||(t.hostname=''),''!==p[0]&&p.unshift(''),p.length<2&&p.unshift(''),s.pathname=p.join('/')}if(s.search=t.search,s.query=t.query,s.host=t.host||'',s.auth=t.auth,s.hostname=t.hostname||t.host,s.port=t.port,s.pathname||s.search){var u=s.pathname||'',g=s.search||'';s.path=u+g}return s.slashes=s.slashes||t.slashes,s.href=s.format(),s}var _=s.pathname&&'/'===s.pathname.charAt(0),m=t.host||t.pathname&&'/'===t.pathname.charAt(0),f=m||_||s.host&&t.pathname,E=f,O=s.pathname&&s.pathname.split('/')||[],A=(p=t.pathname&&t.pathname.split('/')||[],s.protocol&&!Y[s.protocol]);if(A&&(s.hostname='',s.port=null,s.host&&(''===O[0]?O[0]=s.host:O.unshift(s.host)),s.host='',t.protocol&&(t.hostname=null,t.port=null,t.host&&(''===p[0]?p[0]=t.host:p.unshift(t.host)),t.host=null),f=f&&(''===p[0]||''===O[0])),m)s.host=t.host||''===t.host?t.host:s.host,s.hostname=t.hostname||''===t.hostname?t.hostname:s.hostname,s.search=t.search,s.query=t.query,O=p;else if(p.length)O||(O=[]),O.pop(),O=O.concat(p),s.search=t.search,s.query=t.query;else if(!y(t.search)){if(A)s.hostname=s.host=O.shift(),(C=!!(s.host&&s.host.indexOf('@')>0)&&s.host.split('@'))&&(s.auth=C.shift(),s.host=s.hostname=C.shift());return s.search=t.search,s.query=t.query,(!L(s.pathname)||!L(s.search))&&(s.path=(s.pathname?s.pathname:'')+(s.search?s.search:'')),s.href=s.format(),s}if(!O.length)return s.pathname=null,s.search?s.path='/'+s.search:s.path=null,s.href=s.format(),s;for(var T=O.slice(-1)[0],I=(s.host||t.host||O.length>1)&&('.'===T||'..'===T)||''===T,P=0,v=O.length;v>=0;v--)'.'===(T=O[v])?O.splice(v,1):'..'===T?(O.splice(v,1),P++):P&&(O.splice(v,1),P--);if(!f&&!E)for(;P--;P)O.unshift('..');f&&''!==O[0]&&(!O[0]||'/'!==O[0].charAt(0))&&O.unshift(''),I&&'/'!==O.join('/').substr(-1)&&O.push('');var C,w=''===O[0]||O[0]&&'/'===O[0].charAt(0);A&&(s.hostname=s.host=w?'':O.length?O.shift():'',(C=!!(s.host&&s.host.indexOf('@')>0)&&s.host.split('@'))&&(s.auth=C.shift(),s.host=s.hostname=C.shift()));return(f=f||s.host&&O.length)&&!w&&O.unshift(''),O.length?s.pathname=O.join('/'):(s.pathname=null,s.path=null),(!L(s.pathname)||!L(s.search))&&(s.path=(s.pathname?s.pathname:'')+(s.search?s.search:'')),s.auth=t.auth||s.auth,s.slashes=s.slashes||t.slashes,s.href=s.format(),s},S.prototype.parseHost=function(){var t=this.host,e=M.exec(t);e&&(':'!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)},K={parse:v,resolve:w,resolveObject:R,format:C,Url:S,URL:b,URLSearchParams:U}})),et=function(t,e){let s,n=0,i='',a='';for(;n<t.length;n++)s=t[n],i+=s.open,a+=s.close,~e.indexOf(s.close)&&(e=e.replace(s.rgx,s.close+s.open));return i+e+a},st=function(t,e){let s={open:`[${t}m`,close:`[${e}m`,rgx:new RegExp(`\\x1b\\[${e}m`,'g')};return function(e){return void 0!==this&&void 0!==this.has?(~this.has.indexOf(t)||(this.has.push(t),this.keys.push(s)),void 0===e?this:it.enabled?et(this.keys,e+''):e+''):void 0===e?function(t,e){let s={has:t,keys:e};return s.reset=it.reset.bind(s),s.bold=it.bold.bind(s),s.dim=it.dim.bind(s),s.italic=it.italic.bind(s),s.underline=it.underline.bind(s),s.inverse=it.inverse.bind(s),s.hidden=it.hidden.bind(s),s.strikethrough=it.strikethrough.bind(s),s.black=it.black.bind(s),s.red=it.red.bind(s),s.green=it.green.bind(s),s.yellow=it.yellow.bind(s),s.blue=it.blue.bind(s),s.magenta=it.magenta.bind(s),s.cyan=it.cyan.bind(s),s.white=it.white.bind(s),s.gray=it.gray.bind(s),s.grey=it.grey.bind(s),s.bgBlack=it.bgBlack.bind(s),s.bgRed=it.bgRed.bind(s),s.bgGreen=it.bgGreen.bind(s),s.bgYellow=it.bgYellow.bind(s),s.bgBlue=it.bgBlue.bind(s),s.bgMagenta=it.bgMagenta.bind(s),s.bgCyan=it.bgCyan.bind(s),s.bgWhite=it.bgWhite.bind(s),s}([t],[s]):it.enabled?et([s],e+''):e+''}},nt=!0;'undefined'!=typeof process&&(({FORCE_COLOR:J,NODE_DISABLE_COLORS:X,NO_COLOR:q,TERM:Q}=process.env||{}),nt=process.stdout&&process.stdout.isTTY);var it={enabled:!X&&null==q&&'dumb'!==Q&&(null!=J&&'0'!==J||nt),reset:st(0,0),bold:st(1,22),dim:st(2,22),italic:st(3,23),underline:st(4,24),inverse:st(7,27),hidden:st(8,28),strikethrough:st(9,29),black:st(30,39),red:st(31,39),green:st(32,39),yellow:st(33,39),blue:st(34,39),magenta:st(35,39),cyan:st(36,39),white:st(37,39),gray:st(90,39),grey:st(90,39),bgBlack:st(40,49),bgRed:st(41,49),bgGreen:st(42,49),bgYellow:st(43,49),bgBlue:st(44,49),bgMagenta:st(45,49),bgCyan:st(46,49),bgWhite:st(47,49)},at=it;function rt(t){t=t.trim();let e=0n;for(let s=0;s<t.length&&s<12;s++){const n=t.charCodeAt(s);e*=37n,n>=65&&n<=90?e+=BigInt(n+1-65):n>=97&&n<=122?e+=BigInt(n+1-97):n>=48&&n<=57&&(e+=BigInt(n+27-48))}return e}function ot(t){if(t<0n||t>=6582952005840035281n)return'invalid_name';if(t%37n===0n)return'invalid_name';let e=0;const s=Array(12);for(;0n!==t;){const n=t;t/=37n,s[11-e++]=lt[Number(n-37n*t)]}return s.slice(12-e).join('')}function ct(t){return e=function(t){return ot(rt(t))}(t).replaceAll('_',' '),e.replace(/\w\S*/g,(t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()));var e}var lt=['_','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','0','1','2','3','4','5','6','7','8','9'];class ht{key;next;prev;constructor(){this.key=0n,this.next=this,this.prev=this}unlink(){this.prev&&this.next&&(this.prev.next=this.next,this.next.prev=this.prev,this.next=null,this.prev=null)}}class dt{sentinel;cursor=null;constructor(){const t=new ht;t.next=t,t.prev=t,this.sentinel=t}addTail(t){t.prev&&t.unlink(),t.prev=this.sentinel.prev,t.next=this.sentinel,t.prev&&(t.prev.next=t),t.next.prev=t}addHead(t){t.prev&&t.unlink(),t.prev=this.sentinel,t.next=this.sentinel.next,t.prev.next=t,t.next&&(t.next.prev=t)}removeHead(){const t=this.sentinel.next;return t===this.sentinel?null:(t?.unlink(),t)}head(){const t=this.sentinel.next;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.next||null,t)}tail(){const t=this.sentinel.prev;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.prev||null,t)}next(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.next||null,t)}prev(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.prev||null,t)}clear(){for(;;){const t=this.sentinel.next;if(t===this.sentinel)return;t?.unlink()}}}class pt extends ht{nextHashable;prevHashable;constructor(){super(),this.nextHashable=this,this.prevHashable=this}uncache(){this.prevHashable&&this.nextHashable&&(this.prevHashable.nextHashable=this.nextHashable,this.nextHashable.prevHashable=this.prevHashable,this.nextHashable=null,this.prevHashable=null)}}class ut extends pt{static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static crc32b=3988292384;static{for(let t=0;t<32;t++)this.bitmask[t]=(1<<t)-1;this.bitmask[32]=4294967295;for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1&~e?e>>>=1:e=e>>>1^this.crc32b;this.crctable[t]=e}}static getcrc(t,e,s){let n=4294967295;for(let i=e;i<s;i++)n=n>>>8^this.crctable[255&(n^t[i])];return~n}static checkcrc(t,e,s,n=0){return ut.getcrc(t,e,s)==n}static alloc(t){let e=null;return 0===t&&this.cacheMinCount>0?(e=this.cacheMin.removeHead(),this.cacheMinCount--):1===t&&this.cacheMidCount>0?(e=this.cacheMid.removeHead(),this.cacheMidCount--):2===t&&this.cacheMaxCount>0?(e=this.cacheMax.removeHead(),this.cacheMaxCount--):3===t&&this.cacheBigCount>0?(e=this.cacheBig.removeHead(),this.cacheBigCount--):4===t&&this.cacheHugeCount>0?(e=this.cacheHuge.removeHead(),this.cacheHugeCount--):5===t&&this.cacheUnimaginableCount>0&&(e=this.cacheUnimaginable.removeHead(),this.cacheUnimaginableCount--),null!==e?(e.pos=0,e.bitPos=0,e):new ut(0===t?new Uint8Array(100):1===t?new Uint8Array(5e3):2===t?new Uint8Array(3e4):3===t?new Uint8Array(1e5):4===t?new Uint8Array(5e5):5===t?new Uint8Array(2e6):new Uint8Array(t))}static async load(t,e=!1){const s=new ut(new Uint8Array(await(await fetch(t)).arrayBuffer()));return e&&(s.pos=s.data.length),s}static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static cacheBigCount=0;static cacheHugeCount=0;static cacheUnimaginableCount=0;static cacheMin=new dt;static cacheMid=new dt;static cacheMax=new dt;static cacheBig=new dt;static cacheHuge=new dt;static cacheUnimaginable=new dt;data;#t;pos;bitPos;constructor(t){super(),this.data=t,this.#t=new DataView(this.data.buffer),this.pos=0,this.bitPos=0}get available(){return this.data.length-this.pos}get length(){return this.data.length}release(){this.pos=0,this.bitPos=0,100===this.data.length&&ut.cacheMinCount<1e3?(ut.cacheMin.addTail(this),ut.cacheMinCount++):5e3===this.data.length&&ut.cacheMidCount<250?(ut.cacheMid.addTail(this),ut.cacheMidCount++):3e4===this.data.length&&ut.cacheMaxCount<50?(ut.cacheMax.addTail(this),ut.cacheMaxCount++):1e5===this.data.length&&ut.cacheBigCount<10?(ut.cacheBig.addTail(this),ut.cacheBigCount++):5e5===this.data.length&&ut.cacheHugeCount<5?(ut.cacheHuge.addTail(this),ut.cacheHugeCount++):2e6===this.data.length&&ut.cacheUnimaginableCount<2&&(ut.cacheUnimaginable.addTail(this),ut.cacheUnimaginableCount++)}save(t,e=this.pos,s=0){const n=new Blob([this.data.subarray(s,s+e)],{type:'application/octet-stream'}),i=URL.createObjectURL(n);self.postMessage({type:'save',value:i,path:t})}p1(t){this.#t.setUint8(this.pos++,t)}p2(t){this.#t.setUint16(this.pos,t),this.pos+=2}ip2(t){this.#t.setUint16(this.pos,t,!0),this.pos+=2}p3(t){this.#t.setUint8(this.pos++,t>>16),this.#t.setUint16(this.pos,t),this.pos+=2}p4(t){this.#t.setInt32(this.pos,t),this.pos+=4}ip4(t){this.#t.setInt32(this.pos,t,!0),this.pos+=4}p8(t){this.#t.setBigInt64(this.pos,t),this.pos+=8}pbool(t){this.p1(t?1:0)}pjstr(t,e=10){const s=t.length;for(let e=0;e<s;e++)this.#t.setUint8(this.pos++,t.charCodeAt(e));this.#t.setUint8(this.pos++,e)}pdata(t,e,s){this.data.set(t.subarray(e,e+s),this.pos),this.pos+=s-e}psize4(t){this.#t.setUint32(this.pos-t-4,t)}psize2(t){this.#t.setUint16(this.pos-t-2,t)}psize1(t){this.#t.setUint8(this.pos-t-1,t)}psmarts(t){if(t<64&&t>=64)this.p1(t+64);else{if(!(t<16384&&t>=-16384))throw new Error('Error psmarts out of range: '+t);this.p2(t+49152)}}psmart(t){if(t>=0&&t<128)this.p1(t);else{if(!(t>=0&&t<32768))throw new Error('Error psmart out of range: '+t);this.p2(t+32768)}}g1(){return this.#t.getUint8(this.pos++)}g1b(){return this.#t.getInt8(this.pos++)}g2(){return this.pos+=2,this.#t.getUint16(this.pos-2)}g2s(){return this.pos+=2,this.#t.getInt16(this.pos-2)}ig2(){return this.pos+=2,this.#t.getUint16(this.pos-2,!0)}g3(){const t=this.#t.getUint8(this.pos++)<<16|this.#t.getUint16(this.pos);return this.pos+=2,t}g4(){return this.pos+=4,this.#t.getInt32(this.pos-4)}ig4(){return this.pos+=4,this.#t.getInt32(this.pos-4,!0)}g8(){return this.pos+=8,this.#t.getBigInt64(this.pos-8)}gbool(){return 1===this.g1()}gjstr(t=10){const e=this.data.length;let s,n='';for(;(s=this.#t.getUint8(this.pos++))!==t&&this.pos<e;)n+=String.fromCharCode(s);return n}gdata(t,e,s){t.set(this.data.subarray(this.pos,this.pos+s),e),this.pos+=s}gsmarts(){return this.#t.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmart(){return this.#t.getUint8(this.pos)<128?this.g1():this.g2()-32768}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(t){let e=this.bitPos>>>3,s=8-(7&this.bitPos),n=0;for(this.bitPos+=t;t>s;s=8)n+=(this.#t.getUint8(e++)&ut.bitmask[s])<<t-s,t-=s;return n+=t==s?this.#t.getUint8(e)&ut.bitmask[s]:this.#t.getUint8(e)>>>s-t&ut.bitmask[t],n}pBit(t,e){const s=this.bitPos;this.bitPos+=t;let n=s>>>3,i=8-(7&s);const a=this.#t;for(;t>i;i=8){const s=(1<<i)-1,r=a.getUint8(n);a.setUint8(n++,r&~s|e>>>t-i&s),t-=i}const r=i-t,o=(1<<t)-1,c=a.getUint8(n);a.setUint8(n,c&~o<<r|(e&o)<<r)}}class gt{id;debugname=null;constructor(t){this.id=t}decodeType(t){for(;t.available>0;){const e=t.g1();if(0===e)break;this.decode(e,t)}}}class _t extends gt{static configNames=new Map;static configs=[];static async load(t){if(_t.configNames=new Map,_t.configs=[],!(await fetch(`${t}/server/category.dat`)).ok)return void console.log('Warning: No category.dat found.');const e=await ut.load(`${t}/server/category.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new _t(t);s.decodeType(e),_t.configs[t]=s,s.debugname&&_t.configNames.set(s.debugname,t)}}static get(t){return _t.configs[t]}static getId(t){return _t.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}decode(t,e){this.debugname=e.gjstr()}toString(){return this.debugname??`category_${this.id}`}}class mt{static INT=105;static AUTOINT=255;static STRING=115;static ENUM=103;static OBJ=111;static LOC=108;static COMPONENT=73;static NAMEDOBJ=79;static STRUCT=74;static BOOLEAN=49;static COORD=99;static CATEGORY=121;static SPOTANIM=116;static NPC=110;static INV=118;static SYNTH=80;static SEQ=65;static STAT=83;static VARP=86;static PLAYER_UID=112;static NPC_UID=78;static INTERFACE=97;static NPC_STAT=254;static IDKIT=75;static getType(t){switch(t){case mt.INT:return'int';case mt.STRING:return'string';case mt.ENUM:return'enum';case mt.OBJ:return'obj';case mt.LOC:return'loc';case mt.COMPONENT:return'component';case mt.NAMEDOBJ:return'namedobj';case mt.STRUCT:return'struct';case mt.BOOLEAN:return'boolean';case mt.COORD:return'coord';case mt.CATEGORY:return'category';case mt.SPOTANIM:return'spotanim';case mt.NPC:return'npc';case mt.INV:return'inv';case mt.SYNTH:return'synth';case mt.SEQ:return'seq';case mt.STAT:return'stat';case mt.AUTOINT:return'autoint';case mt.VARP:return'varp';case mt.PLAYER_UID:return'player_uid';case mt.NPC_UID:return'npc_uid';case mt.INTERFACE:return'interface';case mt.NPC_STAT:return'npc_stat';case mt.IDKIT:return'idkit';default:return'unknown'}}static getTypeChar(t){let e='i';switch(t){case'int':e='i';break;case'autoint':e='ÿ';break;case'string':e='s';break;case'enum':e='g';break;case'obj':e='o';break;case'loc':e='l';break;case'component':e='I';break;case'namedobj':e='O';break;case'struct':e='J';break;case'boolean':e='1';break;case'coord':e='c';break;case'category':e='y';break;case'spotanim':e='t';break;case'npc':e='n';break;case'inv':e='v';break;case'synth':e='P';break;case'seq':e='A';break;case'stat':e='S';break;case'varp':e='V';break;case'player_uid':e='p';break;case'npc_uid':e='N';break;case'interface':e='a';break;case'npc_stat':e='þ';break;case'idkit':e='K';break;default:return null}return e.charCodeAt(0)}static getDefault(t){return t===mt.STRING?'':t===mt.BOOLEAN?0:-1}}class ft extends gt{static configNames=new Map;static configs=[];static async load(t){if(ft.configNames=new Map,ft.configs=[],!(await fetch(`${t}/server/dbtable.dat`)).ok)return void console.log('Warning: No dbtable.dat found.');const e=await ut.load(`${t}/server/dbtable.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new ft(t);s.decodeType(e),ft.configs[t]=s,s.debugname&&ft.configNames.set(s.debugname,t)}}static get(t){return ft.configs[t]}static getId(t){return ft.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}types=[];defaultValues=[];columnNames=[];decode(t,e){if(1===t){this.types=new Array(e.g1());for(let t=e.g1();255!=t;t=e.g1()){const s=127&t,n=!!(128&t),i=new Array(e.g1());for(let t=0;t<i.length;t++)i[t]=e.g1();this.types[s]=i,n&&(this.defaultValues||(this.defaultValues=new Array(this.types.length)),this.defaultValues[s]=this.decodeValues(e,s))}}else if(250===t)this.debugname=e.gjstr();else{if(251!==t)throw new Error(`Unrecognized dbtable config code: ${t}`);this.columnNames=new Array(e.g1());for(let t=0;t<this.columnNames.length;t++)this.columnNames[t]=e.gjstr()}}getDefault(t){if(!this.defaultValues[t]){const e=[];for(let s=0;s<this.types[t].length;s++)e[s]=mt.getDefault(this.types[t][s]);return e}return this.defaultValues[t]}decodeValues(t,e){const s=this.types[e],n=t.g1(),i=new Array(n*s.length);for(let e=0;e<n;e++)for(let n=0;n<s.length;n++){const a=s[n],r=n+e*s.length;a===mt.STRING?i[r]=t.gjstr():i[r]=t.g4()}return i}}class Et extends gt{static configNames=new Map;static configs=[];static async load(t){if(Et.configNames=new Map,Et.configs=[],!(await fetch(`${t}/server/dbrow.dat`)).ok)return void console.log('Warning: No dbrow.dat found.');const e=await ut.load(`${t}/server/dbrow.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Et(t);s.decodeType(e),Et.configs[t]=s,s.debugname&&Et.configNames.set(s.debugname,t)}}static get(t){return Et.configs[t]}static getId(t){return Et.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}static getInTable(t){return Et.configs.filter((e=>e.tableId===t))}tableId=0;types=[];columnValues=[];decode(t,e){if(3===t){const t=e.g1();this.types=new Array(t),this.columnValues=new Array(t);for(let t=e.g1();255!=t;t=e.g1()){const s=new Array(e.g1());for(let t=0;t<s.length;t++)s[t]=e.g1();this.types[t]=s,this.columnValues[t]=this.decodeValues(e,t)}}else if(4===t)this.tableId=e.g2();else{if(250!==t)throw new Error(`Unrecognized dbtable config code: ${t}`);this.debugname=e.gjstr()}}getValue(t,e){const s=this.columnValues[t].slice(e*this.types[t].length,(e+1)*this.types[t].length);return s.length?s:ft.get(this.tableId).getDefault(t)}decodeValues(t,e){const s=this.types[e],n=t.g1(),i=new Array(n*s.length);for(let e=0;e<n;e++)for(let n=0;n<s.length;n++){const a=s[n],r=n+e*s.length;a===mt.STRING?i[r]=t.gjstr():i[r]=t.g4()}return i}}class Ot extends gt{static configNames=new Map;static configs=[];static async load(t){if(Ot.configNames=new Map,Ot.configs=[],!(await fetch(`${t}/server/enum.dat`)).ok)return void console.log('Warning: No enum.dat found.');const e=await ut.load(`${t}/server/enum.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Ot(t);s.decodeType(e),Ot.configs[t]=s,s.debugname&&Ot.configNames.set(s.debugname,t)}}static get(t){return Ot.configs[t]}static getId(t){return Ot.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}inputtype=mt.INT;outputtype=mt.INT;defaultInt=0;defaultString='null';values=new Map;decode(t,e){if(1===t)this.inputtype=e.g1();else if(2===t)this.outputtype=e.g1();else if(3===t)this.defaultString=e.gjstr();else if(4===t)this.defaultInt=e.g4();else if(5===t){const t=e.g2();for(let s=0;s<t;s++)this.values.set(e.g4(),e.gjstr())}else if(6===t){const t=e.g2();for(let s=0;s<t;s++)this.values.set(e.g4(),e.g4())}else{if(250!==t)throw new Error(`Unrecognized enum config code: ${t}`);this.debugname=e.gjstr()}}}var At,Tt=(At=import.meta.url,async function(t={}){var e,s,n,i=Object.assign({},t),a=new Promise(((t,e)=>{s=t,n=e}));['_BZ2_bzBuffToBuffDecompress','_BZ2_bzBuffToBuffCompress','_malloc','_free','_memory','___indirect_function_table','onRuntimeInitialized'].forEach((t=>{Object.getOwnPropertyDescriptor(a,t)||Object.defineProperty(a,t,{get:()=>K('You are getting '+t+' on the Promise object, instead of the instance. Use .then() to get called back with the instance, see the MODULARIZE docs in src/settings.js'),set:()=>K('You are setting '+t+' on the Promise object, instead of the instance. Use .then() to get called back with the instance, see the MODULARIZE docs in src/settings.js')})}));var r='object'==typeof window,o='function'==typeof importScripts,c='object'==typeof process&&'object'==typeof process.versions&&'string'==typeof process.versions.node,l=!r&&!c&&!o;if(i.ENVIRONMENT)throw new Error('Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)');var h,d,p,u=Object.assign({},i),g=(t,e)=>{throw e},_='';if(c){if('undefined'==typeof process||!process.release||'node'!==process.release.name)throw new Error('not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)');var m=process.versions.node,f=m.split('.').slice(0,3);if((f=1e4*f[0]+100*f[1]+1*f[2].split('-')[0])<16e4)throw new Error('This emscripten-generated code requires node v16.0.0 (detected v'+m+')');var O=()=>({}),A=(Z(),E(I));_=(tt(),E($)).fileURLToPath(new URL('./',import.meta.url)),h=(t,e)=>(t=Q(t)?new URL(t):A.normalize(t),O.readFileSync(t,e?void 0:'utf8')),p=t=>{var e=h(t,!0);return e.buffer||(e=new Uint8Array(e)),k(e.buffer),e},d=(t,e,s,n=!0)=>{t=Q(t)?new URL(t):A.normalize(t),O.readFile(t,n?void 0:'utf8',((t,i)=>{t?s(t):e(n?i.buffer:i)}))},!i.thisProgram&&process.argv.length>1&&process.argv[1].replace(/\\/g,'/'),process.argv.slice(2),g=(t,e)=>{throw process.exitCode=t,e}}else if(l){if('object'==typeof process&&'function'==typeof T||'object'==typeof window||'function'==typeof importScripts)throw new Error('not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)')}else{if(!r&&!o)throw new Error('environment detection error');if(o?_=self.location.href:'undefined'!=typeof document&&document.currentScript&&(_=document.currentScript.src),At&&(_=At),_=_.startsWith('blob:')?'':_.substr(0,_.replace(/[?#].*/,'').lastIndexOf('/')+1),'object'!=typeof window&&'function'!=typeof importScripts)throw new Error('not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)');h=t=>{var e=new XMLHttpRequest;return e.open('GET',t,!1),e.send(null),e.responseText},o&&(p=t=>{var e=new XMLHttpRequest;return e.open('GET',t,!1),e.responseType='arraybuffer',e.send(null),new Uint8Array(e.response)}),d=(t,e,s)=>{var n=new XMLHttpRequest;n.open('GET',t,!0),n.responseType='arraybuffer',n.onload=()=>{200==n.status||0==n.status&&n.response?e(n.response):s()},n.onerror=s,n.send(null)}}var N,P,L,y=i.print||console.log.bind(console),S=i.printErr||console.error.bind(console);Object.assign(i,u),u=null,N='fetchSettings',Object.getOwnPropertyDescriptor(i,N)&&K(`\`Module.${N}\` was supplied but \`${N}\` not included in INCOMING_MODULE_JS_API`),i.arguments&&i.arguments,at('arguments','arguments_'),i.thisProgram&&i.thisProgram,at('thisProgram','thisProgram'),i.quit&&(g=i.quit),at('quit','quit_'),k(void 0===i.memoryInitializerPrefixURL,'Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead'),k(void 0===i.pthreadMainPrefixURL,'Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead'),k(void 0===i.cdInitializerPrefixURL,'Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead'),k(void 0===i.filePackagePrefixURL,'Module.filePackagePrefixURL option was removed, use Module.locateFile instead'),k(void 0===i.read,'Module.read option was removed (modify read_ in JS)'),k(void 0===i.readAsync,'Module.readAsync option was removed (modify readAsync in JS)'),k(void 0===i.readBinary,'Module.readBinary option was removed (modify readBinary in JS)'),k(void 0===i.setWindowTitle,'Module.setWindowTitle option was removed (modify emscripten_set_window_title in JS)'),k(void 0===i.TOTAL_MEMORY,'Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY'),at('asm','wasmExports'),at('read','read_'),at('readAsync','readAsync'),at('readBinary','readBinary'),at('setWindowTitle','setWindowTitle'),k(!l,'shell environment detected but not enabled at build time.  Add `shell` to `-sENVIRONMENT` to enable.'),i.wasmBinary&&(P=i.wasmBinary),at('wasmBinary','wasmBinary'),'object'!=typeof WebAssembly&&S('no native wasm support detected');var v,C,w,R,b,U,D,M=!1;function k(t,e){t||K('Assertion failed'+(e?': '+e:''))}function x(){var t=L.buffer;i.HEAP8=v=new Int8Array(t),i.HEAP16=w=new Int16Array(t),i.HEAPU8=C=new Uint8Array(t),i.HEAPU16=new Uint16Array(t),i.HEAP32=R=new Int32Array(t),i.HEAPU32=b=new Uint32Array(t),i.HEAPF32=U=new Float32Array(t),i.HEAPF64=D=new Float64Array(t)}function B(){if(!M){var t=vt();0==t&&(t+=4);var e=b[t>>2],s=b[t+4>>2];34821223==e&&2310721022==s||K(`Stack overflow! Stack cookie has been overwritten at ${ut(t)}, expected hex dwords 0x89BACDFE and 0x2135467, but received ${ut(s)} ${ut(e)}`),1668509029!=b[0]&&K('Runtime error: The application has corrupted its heap memory area (address zero)!')}}k(!i.STACK_SIZE,'STACK_SIZE can no longer be set at runtime.  Use -sSTACK_SIZE at link time'),k('undefined'!=typeof Int32Array&&'undefined'!=typeof Float64Array&&null!=Int32Array.prototype.subarray&&null!=Int32Array.prototype.set,'JS engine does not provide full typed array support'),k(!i.wasmMemory,'Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally'),k(!i.INITIAL_MEMORY,'Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically'),function(){var t=new Int16Array(1),e=new Int8Array(t.buffer);if(t[0]=25459,115!==e[0]||99!==e[1])throw'Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)'}();var F=[],H=[],G=[],W=!1;k(Math.imul,'This browser does not support Math.imul(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill'),k(Math.fround,'This browser does not support Math.fround(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill'),k(Math.clz32,'This browser does not support Math.clz32(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill'),k(Math.trunc,'This browser does not support Math.trunc(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill');var z=0,V=null,Y=null,j={};function K(t){i.onAbort?.(t),S(t='Aborted('+t+')'),M=!0;var e=new WebAssembly.RuntimeError(t);throw n(e),e}var J={error(){K('Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM')},init(){J.error()},createDataFile(){J.error()},createPreloadedFile(){J.error()},createLazyFile(){J.error()},open(){J.error()},mkdev(){J.error()},registerDevice(){J.error()},analyzePath(){J.error()},ErrnoError(){J.error()}};i.FS_createDataFile=J.createDataFile,i.FS_createPreloadedFile=J.createPreloadedFile;var X,q=t=>t.startsWith("data:application/octet-stream;base64,"),Q=t=>t.startsWith('file://');function et(t,e){return(...s)=>{k(W,`native function \`${t}\` called before runtime initialization`);var n=Lt[t];return k(n,`exported native function \`${t}\` not found`),k(s.length<=e,`native function \`${t}\` called with ${s.length} args but expects ${e}`),n(...s)}}function st(){if(i.locateFile){var t='bzip2.wasm';return q(t)?t:(e=t,i.locateFile?i.locateFile(e,_):_+e)}var e;return new URL('bzip2.wasm',import.meta.url).href}function nt(t){if(t==X&&P)return new Uint8Array(P);if(p)return p(t);throw'both async and sync fetching of the wasm failed'}function it(t,e,s){return function(t){if(!P&&(r||o)){if('function'==typeof fetch&&!Q(t))return fetch(t,{credentials:'same-origin'}).then((e=>{if(!e.ok)throw`failed to load wasm binary file at '${t}'`;return e.arrayBuffer()})).catch((()=>nt(t)));if(d)return new Promise(((e,s)=>{d(t,(t=>e(new Uint8Array(t))),s)}))}return Promise.resolve().then((()=>nt(t)))}(t).then((t=>WebAssembly.instantiate(t,e))).then(s,(t=>{S(`failed to asynchronously prepare wasm: ${t}`),Q(X)&&S(`warning: Loading from a file URI (${X}) is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing`),K(t)}))}function at(t,e,s=!0){Object.getOwnPropertyDescriptor(i,t)||Object.defineProperty(i,t,{configurable:!0,get(){K(`\`Module.${t}\` has been replaced by \`${e}\``+(s?' (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)':''))}})}function rt(t){return'FS_createPath'===t||'FS_createDataFile'===t||'FS_createPreloadedFile'===t||'FS_unlink'===t||'addRunDependency'===t||'FS_createLazyFile'===t||'FS_createDevice'===t||'removeRunDependency'===t}function ot(t,e){'undefined'!=typeof globalThis&&Object.defineProperty(globalThis,t,{configurable:!0,get(){gt(`\`${t}\` is not longer defined by emscripten. ${e}`)}})}function ct(t){Object.getOwnPropertyDescriptor(i,t)||Object.defineProperty(i,t,{configurable:!0,get(){var e=`'${t}' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the Emscripten FAQ)`;rt(t)&&(e+='. Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you'),K(e)}})}function lt(t){this.name='ExitStatus',this.message=`Program terminated with exit(${t})`,this.status=t}ot('buffer','Please use HEAP8.buffer or wasmMemory.buffer'),ot('asm','Please use wasmExports instead');var ht,dt=t=>{for(;t.length>0;)t.shift()(i)},pt=i.noExitRuntime||!0,ut=t=>(k('number'==typeof t),'0x'+(t>>>=0).toString(16).padStart(8,'0')),gt=t=>{gt.shown||={},gt.shown[t]||(gt.shown[t]=1,c&&(t='warning: '+t),S(t))},_t=t=>{var e=L.buffer,s=(t-e.byteLength+65535)/65536;try{return L.grow(s),x(),1}catch(s){S(`growMemory: Attempted to grow heap from ${e.byteLength} bytes to ${t} bytes, but got error: ${s}`)}},mt=()=>pt||!1,ft=(t,e)=>{if(function(){var t=y,e=S,s=!1;y=S=t=>{s=!0};try{Nt()}catch(t){}y=t,S=e,s&&(gt('stdio streams had content in them that was not flushed. you should set EXIT_RUNTIME to 1 (see the Emscripten FAQ), or make sure to emit a newline when you printf etc.'),gt('(this may also be due to not including full filesystem support - try building with -sFORCE_FILESYSTEM)'))}(),mt()&&!e){var s=`program exited (with status: ${t}), but keepRuntimeAlive() is set (counter=0) due to an async operation, so halting execution but not exiting the runtime or preventing further async execution (you can use emscripten_force_exit, if you want to force a true shutdown)`;n(s),S(s)}var a;a=t,mt()||(i.onExit?.(a),M=!0),g(a,new lt(a))},Et='undefined'!=typeof TextDecoder?new TextDecoder('utf8'):void 0,Ot=(t,e,s)=>{for(var n=e+s,i=e;t[i]&&!(i>=n);)++i;if(i-e>16&&t.buffer&&Et)return Et.decode(t.subarray(e,i));for(var a='';e<i;){var r=t[e++];if(128&r){var o=63&t[e++];if(192!=(224&r)){var c=63&t[e++];if(224==(240&r)?r=(15&r)<<12|o<<6|c:(240!=(248&r)&&gt('Invalid UTF-8 leading byte '+ut(r)+' encountered when deserializing a UTF-8 string in wasm memory to a JS string!'),r=(7&r)<<18|o<<12|c<<6|63&t[e++]),r<65536)a+=String.fromCharCode(r);else{var l=r-65536;a+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else a+=String.fromCharCode((31&r)<<6|o)}else a+=String.fromCharCode(r)}return a},Tt=[null,[],[]],It=(t,e)=>{var s=Tt[t];k(s),0===e||10===e?((1===t?y:S)(Ot(s,0)),s.length=0):s.push(e)},Nt=()=>{yt(0),Tt[1].length&&It(1,10),Tt[2].length&&It(2,10)},Pt={_emscripten_memcpy_js:(t,e,s)=>C.copyWithin(t,e,e+s),emscripten_resize_heap:t=>{var e=C.length;k((t>>>=0)>e);var s=2147483648;if(t>s)return S(`Cannot enlarge memory, requested ${t} bytes, but the limit is 2147483648 bytes!`),!1;for(var n=(t,e)=>t+(e-t%e)%e,i=1;i<=4;i*=2){var a=e*(1+.2/i);a=Math.min(a,t+100663296);var r=Math.min(s,n(Math.max(t,a),65536));if(_t(r))return!0}return S(`Failed to grow the heap from ${e} bytes to ${r} bytes, not enough memory!`),!1},exit:ft,fd_close:t=>{K('fd_close called without SYSCALLS_REQUIRE_FILESYSTEM')},fd_seek:function(t,e,s,n,i){var a,r;return r=s,k((a=e)==a>>>0||a==(0|a)),k(r===(0|r)),70},fd_write:(t,e,s,n)=>{for(var i=0,a=0;a<s;a++){var r=b[e>>2],o=b[e+4>>2];e+=8;for(var c=0;c<o;c++)It(t,C[r+c]);i+=o}return b[n>>2]=i,0}},Lt=function(){var t,e={env:Pt,wasi_snapshot_preview1:Pt};function s(t,e){var s;return Lt=t.exports,k(L=Lt.memory,'memory not found in wasm exports'),x(),s=Lt.__wasm_call_ctors,H.unshift(s),function(t){if(z--,i.monitorRunDependencies?.(z),t?(k(j[t]),delete j[t]):S('warning: run dependency removed without ID'),0==z&&(null!==V&&(clearInterval(V),V=null),Y)){var e=Y;Y=null,e()}}('wasm-instantiate'),Lt}t='wasm-instantiate',z++,i.monitorRunDependencies?.(z),t?(k(!j[t]),j[t]=1,null===V&&'undefined'!=typeof setInterval&&(V=setInterval((()=>{if(M)return clearInterval(V),void(V=null);var t=!1;for(var e in j)t||(t=!0,S('still waiting on run dependencies:')),S(`dependency: ${e}`);t&&S('(end of list)')}),1e4))):S('warning: run dependency added without ID');var a,r,o,l,h=i;if(i.instantiateWasm)try{return i.instantiateWasm(e,s)}catch(t){S(`Module.instantiateWasm callback failed with error: ${t}`),n(t)}return X||(X=st()),(a=P,r=X,o=e,l=function(t){k(i===h,'the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?'),h=null,s(t.instance)},a||'function'!=typeof WebAssembly.instantiateStreaming||q(r)||Q(r)||c||'function'!=typeof fetch?it(r,o,l):fetch(r,{credentials:'same-origin'}).then((t=>WebAssembly.instantiateStreaming(t,o).then(l,(function(t){return S(`wasm streaming compile failed: ${t}`),S('falling back to ArrayBuffer instantiation'),it(r,o,l)}))))).catch(n),{}}(),yt=(et('__wasm_call_ctors',0),i._malloc=et('malloc',1),i._free=et('free',1),et('fflush',1)),St=(i._BZ2_bzBuffToBuffCompress=et('BZ2_bzBuffToBuffCompress',7),i._BZ2_bzBuffToBuffDecompress=et('BZ2_bzBuffToBuffDecompress',6),()=>(St=Lt.emscripten_stack_init)()),vt=()=>(vt=Lt.emscripten_stack_get_end)();function Ct(){var t;St(),k(!(3&(t=vt()))),0==t&&(t+=4),b[t>>2]=34821223,b[t+4>>2]=2310721022,b[0]=1668509029}function wt(){function t(){ht||(ht=!0,i.calledRun=!0,M||(k(!W),W=!0,B(),dt(H),s(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),k(!i._main,'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]'),function(){if(B(),i.postRun)for('function'==typeof i.postRun&&(i.postRun=[i.postRun]);i.postRun.length;)t=i.postRun.shift(),G.unshift(t);var t;dt(G)}()))}z>0||(Ct(),function(){if(i.preRun)for('function'==typeof i.preRun&&(i.preRun=[i.preRun]);i.preRun.length;)t=i.preRun.shift(),F.unshift(t);var t;dt(F)}(),z>0||(i.setStatus?(i.setStatus('Running...'),setTimeout((function(){setTimeout((function(){i.setStatus('')}),1),t()}),1)):t(),B()))}if(i.dynCall_jiji=et('dynCall_jiji',5),i.setValue=function(t,e,s="i8"){switch(s.endsWith('*')&&(s='*'),s){case'i1':case'i8':v[t]=e;break;case'i16':w[t>>1]=e;break;case'i32':R[t>>2]=e;break;case'i64':K('to do setValue(i64) use WASM_BIGINT');case'float':U[t>>2]=e;break;case'double':D[t>>3]=e;break;case'*':b[t>>2]=e;break;default:K(`invalid type for setValue: ${s}`)}},i.getValue=function(t,e="i8"){switch(e.endsWith('*')&&(e='*'),e){case'i1':case'i8':return v[t];case'i16':return w[t>>1];case'i32':return R[t>>2];case'i64':K('to do getValue(i64) use WASM_BIGINT');case'float':return U[t>>2];case'double':return D[t>>3];case'*':return b[t>>2];default:K(`invalid type for getValue: ${e}`)}},['writeI53ToI64','writeI53ToI64Clamped','writeI53ToI64Signaling','writeI53ToU64Clamped','writeI53ToU64Signaling','readI53FromI64','readI53FromU64','convertI32PairToI53','convertU32PairToI53','stackAlloc','getTempRet0','setTempRet0','zeroMemory','isLeapYear','ydayFromDate','arraySum','addDays','inetPton4','inetNtop4','inetPton6','inetNtop6','readSockaddr','writeSockaddr','initRandomFill','randomFill','emscriptenLog','readEmAsmArgs','jstoi_q','getExecutableName','listenOnce','autoResumeAudioContext','dynCallLegacy','getDynCaller','dynCall','handleException','runtimeKeepalivePush','runtimeKeepalivePop','callUserCallback','maybeExit','asmjsMangle','asyncLoad','alignMemory','mmapAlloc','HandleAllocator','getNativeTypeSize','STACK_SIZE','STACK_ALIGN','POINTER_SIZE','ASSERTIONS','getCFunc','ccall','cwrap','uleb128Encode','sigToWasmTypes','generateFuncType','convertJsFunctionToWasm','getEmptyTableSlot','updateTableMap','getFunctionAddress','addFunction','removeFunction','reallyNegative','unSign','strLen','reSign','formatString','stringToUTF8Array','stringToUTF8','lengthBytesUTF8','intArrayFromString','intArrayToString','AsciiToString','stringToAscii','UTF16ToString','stringToUTF16','lengthBytesUTF16','UTF32ToString','stringToUTF32','lengthBytesUTF32','stringToNewUTF8','stringToUTF8OnStack','writeArrayToMemory','registerKeyEventCallback','maybeCStringToJsString','findEventTarget','getBoundingClientRect','fillMouseEventData','registerMouseEventCallback','registerWheelEventCallback','registerUiEventCallback','registerFocusEventCallback','fillDeviceOrientationEventData','registerDeviceOrientationEventCallback','fillDeviceMotionEventData','registerDeviceMotionEventCallback','screenOrientation','fillOrientationChangeEventData','registerOrientationChangeEventCallback','fillFullscreenChangeEventData','registerFullscreenChangeEventCallback','JSEvents_requestFullscreen','JSEvents_resizeCanvasForFullscreen','registerRestoreOldStyle','hideEverythingExceptGivenElement','restoreHiddenElements','setLetterbox','softFullscreenResizeWebGLRenderTarget','doRequestFullscreen','fillPointerlockChangeEventData','registerPointerlockChangeEventCallback','registerPointerlockErrorEventCallback','requestPointerLock','fillVisibilityChangeEventData','registerVisibilityChangeEventCallback','registerTouchEventCallback','fillGamepadEventData','registerGamepadEventCallback','registerBeforeUnloadEventCallback','fillBatteryEventData','battery','registerBatteryEventCallback','setCanvasElementSize','getCanvasElementSize','jsStackTrace','getCallstack','convertPCtoSourceLocation','getEnvStrings','checkWasiClock','wasiRightsToMuslOFlags','wasiOFlagsToMuslOFlags','createDyncallWrapper','safeSetTimeout','setImmediateWrapped','clearImmediateWrapped','polyfillSetImmediate','getPromise','makePromise','idsToPromises','makePromiseCallback','ExceptionInfo','findMatchingCatch','Browser_asyncPrepareDataCounter','setMainLoop','getSocketFromFD','getSocketAddress','FS_createPreloadedFile','FS_modeStringToFlags','FS_getMode','FS_stdin_getChar','FS_createDataFile','FS_unlink','FS_mkdirTree','_setNetworkCallback','heapObjectForWebGLType','toTypedArrayIndex','webgl_enable_ANGLE_instanced_arrays','webgl_enable_OES_vertex_array_object','webgl_enable_WEBGL_draw_buffers','webgl_enable_WEBGL_multi_draw','emscriptenWebGLGet','computeUnpackAlignedImageSize','colorChannelsInGlTextureFormat','emscriptenWebGLGetTexPixelData','emscriptenWebGLGetUniform','webglGetUniformLocation','webglPrepareUniformLocationsBeforeFirstUse','webglGetLeftBracePos','emscriptenWebGLGetVertexAttrib','__glGetActiveAttribOrUniform','writeGLArray','registerWebGlEventCallback','runAndAbortIfError','ALLOC_NORMAL','ALLOC_STACK','allocate','writeStringToMemory','writeAsciiToMemory','setErrNo','demangle','stackTrace'].forEach((function(t){'undefined'==typeof globalThis||Object.getOwnPropertyDescriptor(globalThis,t)||Object.defineProperty(globalThis,t,{configurable:!0,get(){var e=`\`${t}\` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line`,s=t;s.startsWith('_')||(s='$'+t),e+=` (e.g. -sDEFAULT_LIBRARY_FUNCS_TO_INCLUDE='${s}')`,rt(t)&&(e+='. Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you'),gt(e)}}),ct(t)})),['run','addOnPreRun','addOnInit','addOnPreMain','addOnExit','addOnPostRun','addRunDependency','removeRunDependency','FS_createFolder','FS_createPath','FS_createLazyFile','FS_createLink','FS_createDevice','FS_readFile','out','err','callMain','abort','wasmMemory','wasmExports','writeStackCookie','checkStackCookie','convertI32PairToI53Checked','stackSave','stackRestore','ptrToString','exitJS','getHeapMax','growMemory','ENV','MONTH_DAYS_REGULAR','MONTH_DAYS_LEAP','MONTH_DAYS_REGULAR_CUMULATIVE','MONTH_DAYS_LEAP_CUMULATIVE','ERRNO_CODES','ERRNO_MESSAGES','DNS','Protocols','Sockets','timers','warnOnce','readEmAsmArgsArray','jstoi_s','keepRuntimeAlive','wasmTable','noExitRuntime','freeTableIndexes','functionsInTableMap','PATH','PATH_FS','UTF8Decoder','UTF8ArrayToString','UTF8ToString','UTF16Decoder','JSEvents','specialHTMLTargets','findCanvasEventTarget','currentFullscreenStrategy','restoreOldWindowedStyle','UNWIND_CACHE','ExitStatus','flush_NO_FILESYSTEM','promiseMap','uncaughtExceptionCount','exceptionLast','exceptionCaught','Browser','getPreloadedImageData__data','wget','SYSCALLS','preloadPlugins','FS_stdin_getChar_buffer','FS','MEMFS','TTY','PIPEFS','SOCKFS','tempFixedLengthArray','miniTempWebGLFloatBuffers','miniTempWebGLIntBuffers','GL','AL','GLUT','EGL','GLEW','IDBStore','SDL','SDL_gfx','allocateUTF8','allocateUTF8OnStack'].forEach(ct),Y=function t(){ht||wt(),ht||(Y=t)},i.preInit)for('function'==typeof i.preInit&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();wt(),e=a;for(const e of Object.keys(i))e in t||Object.defineProperty(t,e,{configurable:!0,get(){K(`Access to module property ('${e}') is no longer possible via the module constructor argument; Instead, use the result of the module constructor.`)}});return e}),It=Tt,Nt={'-2':'BZ_PARAM_ERROR: incorrect parameters','-3':"BZ_MEM_ERROR: couldn't allocate enough memory",'-4':'BZ_DATA_ERROR: data integrity error when decompressing','-5':'BZ_DATA_ERROR_MAGIC: compressed data has incorrect header','-7':'BZ_UNEXPECTED_EOF: compressed data ends too early','-8':'BZ_OUTBUFF_FULL: destination buffer is full'};var Pt=new class{constructor(){this.wasmModule=void 0}async init(){this.wasmModule||(this.wasmModule=await It())}ensureInitialized(){if(!this.wasmModule)throw new Error(`${this.constructor.name} not initalized. call .init()`)}handleError(t,e,s){if(0===t)return;this.wasmModule._free(e),this.wasmModule._free(s);const n=Nt[t];if(n)throw new Error(n);throw new Error(`error code: ${t}`)}createWASMBuffers(t,e){const{_malloc:s,setValue:n,HEAPU8:i}=this.wasmModule,a=s(t.length);i.set(t,a);const r=s(e),o=s(e);return n(o,e,'i32'),{sourcePtr:a,destPtr:r,destLengthPtr:o}}createBuffer(t,e){const{_free:s,getValue:n,HEAPU8:i}=this.wasmModule,a=n(e,'i32'),r=new Uint8Array(a);return r.set(i.subarray(t,t+a)),s(t),s(e),r}decompress(t,e,s=!1,n=!1){if(n&&(e=t[0]<<24|t[1]<<16|t[2]<<8|t[3],t[0]='B'.charCodeAt(0),t[1]='Z'.charCodeAt(0),t[2]='h'.charCodeAt(0),t[3]='1'.charCodeAt(0),s=!1),s){const e=new Uint8Array(t.length+4);e[0]='B'.charCodeAt(0),e[1]='Z'.charCodeAt(0),e[2]='h'.charCodeAt(0),e[3]='1'.charCodeAt(0),e.set(t,4),t=e}this.ensureInitialized();const{sourcePtr:i,destPtr:a,destLengthPtr:r}=this.createWASMBuffers(t,e),o=this.wasmModule._BZ2_bzBuffToBuffDecompress(a,r,i,t.length,0,0);return this.wasmModule._free(i),this.handleError(o,a,r),this.createBuffer(a,r)}compress(t,e=!1,s=!1,n=1,i=0){if(this.ensureInitialized(),i||(i=t.length+1024),i<128&&(i=128),n<=0||n>9)throw new RangeError('blockSize should be between 1-9');const{sourcePtr:a,destPtr:r,destLengthPtr:o}=this.createWASMBuffers(t,i),c=this.wasmModule._BZ2_bzBuffToBuffCompress(r,o,a,t.length,n,0,30);this.wasmModule._free(a),this.handleError(c,r,o);const l=this.createBuffer(r,o);return e&&(l[0]=t.length>>24&255,l[1]=t.length>>16&255,l[2]=t.length>>8&255,l[3]=255&t.length),s?l.subarray(4):l}};await Pt.init();var Lt=Pt;function yt(t){let e=0;t=t.toUpperCase();for(let s=0;s<t.length;s++)e=61*e+t.charCodeAt(s)-32|0;return e}class St{data=null;fileCount=0;fileHash=[];fileName=[];fileUnpackedSize=[];filePackedSize=[];filePos=[];unpacked=!1;fileQueue=[];fileWrite=[];static async load(t){return new St(await ut.load(t))}constructor(t){if(!t)return;const e=t.g3();e===t.g3()?(this.data=new Uint8Array(t.data),this.unpacked=!1):(this.data=Lt.decompress(t.data,e,!0),t=new ut(this.data),this.unpacked=!0),this.fileCount=t.g2();let s=t.pos+10*this.fileCount;for(let e=0;e<this.fileCount;e++){this.fileHash[e]=t.g4();const n=Rt.findIndex((t=>t===this.fileHash[e]));-1!==n&&(this.fileName[e]=wt[n]),this.fileUnpackedSize[e]=t.g3(),this.filePackedSize[e]=t.g3(),this.filePos[e]=s,s+=this.filePackedSize[e]}}get(t){if(t<0||t>=this.fileCount)return null;if(null===this.data)throw new Error('Jagfile data is not loaded');const e=this.data.subarray(this.filePos[t],this.filePos[t]+this.filePackedSize[t]);return this.unpacked?new ut(e):new ut(Lt.decompress(e,this.fileUnpackedSize[t],!0))}read(t){const e=yt(t);for(let t=0;t<this.fileCount;t++)if(this.fileHash[t]===e)return this.get(t);return null}write(t,e){const s=yt(t);this.fileQueue.push({hash:s,name:t,write:!0,data:e.data.subarray(0,e.pos)})}delete(t){const e=yt(t);this.fileQueue.push({hash:e,name:t,delete:!0})}rename(t,e){const s=yt(t),n=yt(e);this.fileQueue.push({hash:s,name:t,rename:!0,newName:e,newHash:n})}save(t,e=!1){let s=ut.alloc(5);for(let t=0;t<this.fileQueue.length;t++){const e=this.fileQueue[t];let s=this.fileHash.findIndex((t=>t===e.hash));if(e.write){if(-1===s&&(s=this.fileCount++,this.fileHash[s]=e.hash,this.fileName[s]=e.name),!e.data)throw new Error('Cannot write without data');this.fileUnpackedSize[s]=e.data.length,this.filePackedSize[s]=e.data.length,this.filePos[s]=-1,this.fileWrite[s]=e.data}if(e.delete&&-1!==s&&(this.fileHash.splice(s,1),this.fileName.splice(s,1),this.fileUnpackedSize.splice(s,1),this.filePackedSize.splice(s,1),this.filePos.splice(s,1),this.fileCount--),e.rename&&-1!==s){if(!e.newHash)throw new Error('Cannot rename without newHash');if(!e.newName)throw new Error('Cannot rename without newName');this.fileHash[s]=e.newHash,this.fileName[s]=e.newName}this.fileQueue.splice(t,1),t--}let n=1===this.fileCount;e&&n&&(n=!1),s.p2(this.fileCount);for(let t=0;t<this.fileCount;t++)s.p4(this.fileHash[t]),s.p3(this.fileUnpackedSize[t]),this.fileWrite[t]&&!n&&(this.fileWrite[t]=Lt.compress(this.fileWrite[t],!1,!0),this.filePackedSize[t]=this.fileWrite[t].length),s.p3(this.filePackedSize[t]);for(let t=0;t<this.fileCount;t++){const e=this.fileWrite[t];s.pdata(e,0,e.length)}const i=ut.alloc(5);i.p3(s.pos),n&&(s=new ut(Lt.compress(s.data,!1,!0))),n?(i.p3(s.data.length),i.pdata(s.data,0,s.data.length)):(i.p3(s.pos),i.pdata(s.data,0,s.pos)),i.save(t),s.release(),i.release()}deconstruct(t){const e=this.read(t+'.dat'),s=this.read(t+'.idx');if(null===e||null===s)throw new Error('Failed to read dat or idx');const n=s.g2(),i=new Array(n),a=new Array(n);let r=2;for(let t=0;t<n;t++)i[t]=s.g2(),a[t]=r,r+=i[t];const o=new Array(n);for(let t=0;t<n;t++)e.pos=a[t],o[t]=ut.getcrc(e.data,r,i[t]);return{count:n,sizes:i,offsets:a,checksums:o}}}var vt,Ct,wt=['index.dat','logo.dat','p11.dat','p12.dat','b12.dat','q8.dat','runes.dat','title.dat','titlebox.dat','titlebutton.dat','p11_full.dat','p12_full.dat','b12_full.dat','q8_full.dat','flo.dat','flo.idx','idk.dat','idk.idx','loc.dat','loc.idx','npc.dat','npc.idx','obj.dat','obj.idx','seq.dat','seq.idx','spotanim.dat','spotanim.idx','varp.dat','varp.idx','varbit.dat','varbit.idx','mesanim.dat','mesanim.idx','mes.dat','mes.idx','param.dat','param.idx','hunt.dat','hunt.idx','data','backbase1.dat','backbase2.dat','backhmid1.dat','backhmid2.dat','backleft1.dat','backleft2.dat','backright1.dat','backright2.dat','backtop1.dat','backtop2.dat','backvmid1.dat','backvmid2.dat','backvmid3.dat','chatback.dat','combatboxes.dat','combaticons.dat','combaticons2.dat','combaticons3.dat','compass.dat','cross.dat','gnomeball_buttons.dat','headicons.dat','hitmarks.dat','invback.dat','leftarrow.dat','magicoff.dat','magicoff2.dat','magicon.dat','magicon2.dat','mapback.dat','mapdots.dat','mapflag.dat','mapfunction.dat','mapscene.dat','miscgraphics.dat','miscgraphics2.dat','miscgraphics3.dat','prayerglow.dat','prayeroff.dat','prayeron.dat','redstone1.dat','redstone2.dat','redstone3.dat','rightarrow.dat','scrollbar.dat','sideicons.dat','staticons.dat','staticons2.dat','steelborder.dat','steelborder2.dat','sworddecor.dat','tradebacking.dat','wornicons.dat','mapmarker.dat','mod_icons.dat','mapedge.dat','blackmark.dat','button_brown.dat','button_brown_big.dat','button_red.dat','chest.dat','coins.dat','headicons_hint.dat','headicons_pk.dat','headicons_prayer.dat','key.dat','keys.dat','leftarrow_small.dat','letter.dat','number_button.dat','overlay_duel.dat','overlay_multiway.dat','pen.dat','rightarrow_small.dat','startgame.dat','tex_brown.dat','tex_red.dat','titlescroll.dat','base_head.dat','base_label.dat','base_type.dat','frame_del.dat','frame_head.dat','frame_tran1.dat','frame_tran2.dat','ob_axis.dat','ob_face1.dat','ob_face2.dat','ob_face3.dat','ob_face4.dat','ob_face5.dat','ob_head.dat','ob_point1.dat','ob_point2.dat','ob_point3.dat','ob_point4.dat','ob_point5.dat','ob_vertex1.dat','ob_vertex2.dat','anim_crc','anim_index','anim_version','map_crc','map_index','map_version','midi_crc','midi_index','midi_version','model_crc','model_index','model_version','0.dat','1.dat','2.dat','3.dat','4.dat','5.dat','6.dat','7.dat','8.dat','9.dat','10.dat','11.dat','12.dat','13.dat','14.dat','15.dat','16.dat','17.dat','18.dat','19.dat','20.dat','21.dat','22.dat','23.dat','24.dat','25.dat','26.dat','27.dat','28.dat','29.dat','30.dat','31.dat','32.dat','33.dat','34.dat','35.dat','36.dat','37.dat','38.dat','39.dat','40.dat','41.dat','42.dat','43.dat','44.dat','45.dat','46.dat','47.dat','48.dat','49.dat','badenc.txt','domainenc.txt','fragmentsenc.txt','tldlist.txt','sounds.dat','labels.dat','floorcol.dat','underlay.dat','overlay.dat','size.dat'],Rt=[];for(let t=0;t<wt.length;t++)Rt[t]=yt(wt[t]);class bt{static CHAR_LOOKUP=[];static instances=[];static{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| ";for(let e=0;e<256;e++){let s=t.indexOf(String.fromCharCode(e));-1==s&&(s=74),bt.CHAR_LOOKUP[e]=s}}static async load(t){const e=await St.load(`${t}/client/title`);bt.instances[0]=new bt(e,'p11'),bt.instances[1]=new bt(e,'p12'),bt.instances[2]=new bt(e,'b12'),bt.instances[3]=new bt(e,'q8')}static get(t){return bt.instances[t]}static get count(){return this.instances.length}charMask=new Array(94);charMaskWidth=new Uint8Array(94);charMaskHeight=new Uint8Array(94);charOffsetX=new Uint8Array(94);charOffsetY=new Uint8Array(94);charAdvance=new Uint8Array(95);drawWidth=new Uint8Array(256);height=0;constructor(t,e){const s=t.read(`${e}.dat`),n=t.read('index.dat');if(!s||!n)return;n.pos=s.g2()+4;const i=n.g1();i>0&&(n.pos+=3*(i-1));for(let t=0;t<94;t++){this.charOffsetX[t]=n.g1(),this.charOffsetY[t]=n.g1();const e=this.charMaskWidth[t]=n.g2(),i=this.charMaskHeight[t]=n.g2(),a=n.g1(),r=e*i;if(this.charMask[t]=new Uint8Array(r),0==a)for(let e=0;e<r;e++)this.charMask[t][e]=s.g1();else if(1==a)for(let n=0;n<e;n++)for(let a=0;a<i;a++)this.charMask[t][n+a*e]=s.g1();i>this.height&&(this.height=i),this.charOffsetX[t]=1,this.charAdvance[t]=e+2;let o=0;for(let s=Math.floor(i/7);s<i;s++)o+=this.charMask[t][s*e];o<=Math.floor(i/7)&&(this.charAdvance[t]--,this.charOffsetX[t]=0),o=0;for(let s=Math.floor(i/7);s<i;s++)o+=this.charMask[t][e+s*e-1];o<=Math.floor(i/7)&&this.charAdvance[t]--}this.charAdvance[94]=this.charAdvance[8];for(let t=0;t<256;t++)this.drawWidth[t]=this.charAdvance[bt.CHAR_LOOKUP[t]]}stringWidth(t){if(null==t)return 0;let e=0;for(let s=0;s<t.length;s++)'@'==t.charAt(s)&&s+4<t.length&&'@'==t.charAt(s+4)?s+=4:e+=this.drawWidth[t.charCodeAt(s)];return e}split(t,e){if(0===t.length)return[t];const s=[];for(;t.length>0;){if(this.stringWidth(t)<=e&&-1===t.indexOf('|')){s.push(t);break}let n=t.length;for(let s=0;s<t.length;s++)if(' '===t[s]){if(this.stringWidth(t.substring(0,s))>e)break;n=s}else if('|'===t[s]){n=s;break}s.push(t.substring(0,n)),t=t.substring(n+1)}return s}}(Ct=vt||={})[Ct.OFF=0]='OFF',Ct[Ct.OUTSIDE_WILDERNESS=1]='OUTSIDE_WILDERNESS';var Ut,Dt,Mt=vt;(Dt=Ut||={})[Dt.OFF=0]='OFF',Dt[Dt.PLAYER=1]='PLAYER',Dt[Dt.NPC=2]='NPC',Dt[Dt.OBJ=3]='OBJ',Dt[Dt.SCENERY=4]='SCENERY';var kt,xt,Bt=Ut;(xt=kt||={})[xt.KEEPHUNTING=0]='KEEPHUNTING',xt[xt.PAUSEHUNT=1]='PAUSEHUNT';var Ft,Ht,Gt=kt;(Ht=Ft||={})[Ht.OFF=0]='OFF',Ht[Ht.LINEOFSIGHT=1]='LINEOFSIGHT',Ht[Ht.LINEOFWALK=2]='LINEOFWALK';var Wt,zt,Vt=Ft;(zt=Wt||={})[zt.NULL=-1]='NULL',zt[zt.NONE=0]='NONE',zt[zt.WANDER=1]='WANDER',zt[zt.PATROL=2]='PATROL',zt[zt.PLAYERESCAPE=3]='PLAYERESCAPE',zt[zt.PLAYERFOLLOW=4]='PLAYERFOLLOW',zt[zt.PLAYERFACE=5]='PLAYERFACE',zt[zt.PLAYERFACECLOSE=6]='PLAYERFACECLOSE',zt[zt.OPPLAYER1=7]='OPPLAYER1',zt[zt.OPPLAYER2=8]='OPPLAYER2',zt[zt.OPPLAYER3=9]='OPPLAYER3',zt[zt.OPPLAYER4=10]='OPPLAYER4',zt[zt.OPPLAYER5=11]='OPPLAYER5',zt[zt.APPLAYER1=12]='APPLAYER1',zt[zt.APPLAYER2=13]='APPLAYER2',zt[zt.APPLAYER3=14]='APPLAYER3',zt[zt.APPLAYER4=15]='APPLAYER4',zt[zt.APPLAYER5=16]='APPLAYER5',zt[zt.OPLOC1=17]='OPLOC1',zt[zt.OPLOC2=18]='OPLOC2',zt[zt.OPLOC3=19]='OPLOC3',zt[zt.OPLOC4=20]='OPLOC4',zt[zt.OPLOC5=21]='OPLOC5',zt[zt.APLOC1=22]='APLOC1',zt[zt.APLOC2=23]='APLOC2',zt[zt.APLOC3=24]='APLOC3',zt[zt.APLOC4=25]='APLOC4',zt[zt.APLOC5=26]='APLOC5',zt[zt.OPOBJ1=27]='OPOBJ1',zt[zt.OPOBJ2=28]='OPOBJ2',zt[zt.OPOBJ3=29]='OPOBJ3',zt[zt.OPOBJ4=30]='OPOBJ4',zt[zt.OPOBJ5=31]='OPOBJ5',zt[zt.APOBJ1=32]='APOBJ1',zt[zt.APOBJ2=33]='APOBJ2',zt[zt.APOBJ3=34]='APOBJ3',zt[zt.APOBJ4=35]='APOBJ4',zt[zt.APOBJ5=36]='APOBJ5',zt[zt.OPNPC1=37]='OPNPC1',zt[zt.OPNPC2=38]='OPNPC2',zt[zt.OPNPC3=39]='OPNPC3',zt[zt.OPNPC4=40]='OPNPC4',zt[zt.OPNPC5=41]='OPNPC5',zt[zt.APNPC1=42]='APNPC1',zt[zt.APNPC2=43]='APNPC2',zt[zt.APNPC3=44]='APNPC3',zt[zt.APNPC4=45]='APNPC4',zt[zt.APNPC5=46]='APNPC5',zt[zt.QUEUE1=47]='QUEUE1',zt[zt.QUEUE2=48]='QUEUE2',zt[zt.QUEUE3=49]='QUEUE3',zt[zt.QUEUE4=50]='QUEUE4',zt[zt.QUEUE5=51]='QUEUE5',zt[zt.QUEUE6=52]='QUEUE6',zt[zt.QUEUE7=53]='QUEUE7',zt[zt.QUEUE8=54]='QUEUE8',zt[zt.QUEUE9=55]='QUEUE9',zt[zt.QUEUE10=56]='QUEUE10',zt[zt.QUEUE11=57]='QUEUE11',zt[zt.QUEUE12=58]='QUEUE12',zt[zt.QUEUE13=59]='QUEUE13',zt[zt.QUEUE14=60]='QUEUE14',zt[zt.QUEUE15=61]='QUEUE15',zt[zt.QUEUE16=62]='QUEUE16',zt[zt.QUEUE17=63]='QUEUE17',zt[zt.QUEUE18=64]='QUEUE18',zt[zt.QUEUE19=65]='QUEUE19',zt[zt.QUEUE20=66]='QUEUE20';var Yt=Wt;class jt extends gt{static configNames=new Map;static configs=[];static async load(t){if(jt.configNames=new Map,jt.configs=[],!(await fetch(`${t}/server/hunt.dat`)).ok)return void console.log('Warning: No hunt.dat found.');const e=await ut.load(`${t}/server/hunt.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new jt(t);s.decodeType(e),jt.configs[t]=s,s.debugname&&jt.configNames.set(s.debugname,t)}}static get(t){return jt.configs[t]}static getId(t){return jt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=Bt.OFF;checkVis=Vt.OFF;checkNotTooStrong=Mt.OFF;checkNotBusy=!1;findKeepHunting=!1;findNewMode=Yt.NONE;nobodyNear=Gt.PAUSEHUNT;checkNotCombat=-1;checkNotCombatSelf=-1;checkAfk=!0;rate=1;checkCategory=-1;checkNpc=-1;checkObj=-1;checkLoc=-1;checkInv=-1;checkObjParam=-1;checkInvMinQuantity=-1;checkInvMaxQuantity=-1;decode(t,e){if(1===t)this.type=e.g1();else if(2==t)this.checkVis=e.g1();else if(3==t)this.checkNotTooStrong=e.g1();else if(4==t)this.checkNotBusy=!0;else if(5==t)this.findKeepHunting=!0;else if(6==t)this.findNewMode=e.g1();else if(7==t)this.nobodyNear=e.g1();else if(8===t)this.checkNotCombat=e.g2();else if(9===t)this.checkNotCombatSelf=e.g2();else if(10===t)this.checkAfk=!1;else if(11===t)this.rate=e.g2();else if(12===t)this.checkCategory=e.g2();else if(13===t)this.checkNpc=e.g2();else if(14===t)this.checkObj=e.g2();else if(15===t)this.checkLoc=e.g2();else if(16===t)this.checkInv=e.g2(),this.checkObj=e.g2(),this.checkInvMinQuantity=e.g4(),this.checkInvMaxQuantity=e.g4();else if(17===t)this.checkInv=e.g2(),this.checkObjParam=e.g2(),this.checkInvMinQuantity=e.g4(),this.checkInvMaxQuantity=e.g4();else{if(250!==t)throw new Error(`Unrecognized hunt config code: ${t}`);this.debugname=e.gjstr()}}}class Kt extends gt{static configNames=new Map;static configs=[];static async load(t){if(Kt.configNames=new Map,Kt.configs=[],!(await fetch(`${t}/server/idk.dat`)).ok)return void console.log('Warning: No idk.dat found.');const e=await ut.load(`${t}/server/idk.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('idk.dat');n.pos=2;for(let t=0;t<s;t++){const s=new Kt(t);s.decodeType(e),s.decodeType(n),Kt.configs[t]=s,s.debugname&&Kt.configNames.set(s.debugname,t)}}static get(t){return Kt.configs[t]}static getId(t){return Kt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=-1;models=null;heads=new Uint16Array(5).fill(-1);recol_s=new Uint16Array(6).fill(0);recol_d=new Uint16Array(6).fill(0);disable=!1;decode(t,e){if(1===t)this.type=e.g1();else if(2===t){const t=e.g1();this.models=new Uint16Array(t);for(let s=0;s<t;s++)this.models[s]=e.g2()}else if(3===t)this.disable=!0;else if(t>=40&&t<50)this.recol_s[t-40]=e.g2();else if(t>=50&&t<60)this.recol_d[t-50]=e.g2();else if(t>=60&&t<70)this.heads[t-60]=e.g2();else{if(250!==t)throw new Error(`Unrecognized idk config code: ${t}`);this.debugname=e.gjstr()}}}class Zt{static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INVENTORY=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_SPRITE=5;static TYPE_MODEL=6;static TYPE_INVENTORY_TEXT=7;static NO_BUTTON=0;static BUTTON=1;static TARGET_BUTTON=2;static CLOSE_BUTTON=3;static TOGGLE_BUTTON=4;static SELECT_BUTTON=5;static PAUSE_BUTTON=6;static componentNames=new Map;static components=[];static async load(t){if(this.componentNames=new Map,this.components=[],!(await fetch(`${t}/server/interface.dat`)).ok)return void console.log('Warning: No interface.dat found.');const e=await ut.load(`${t}/server/interface.dat`);e.g2();let s=-1;for(;e.available>0;){let t=e.g2();65535===t&&(s=e.g2(),t=e.g2());const n=new Zt;n.id=t,n.rootLayer=s,n.comName=e.gjstr(),n.overlay=e.gbool(),n.type=e.g1(),n.buttonType=e.g1(),n.clientCode=e.g2(),n.width=e.g2(),n.height=e.g2(),n.overLayer=e.g1(),0==n.overLayer?n.overLayer=-1:n.overLayer=(n.overLayer-1<<8)+e.g1();const i=e.g1();if(i>0){n.scriptComparator=new Uint8Array(i).fill(0),n.scriptOperand=new Uint16Array(i).fill(0);for(let t=0;t<i;t++)n.scriptComparator[t]=e.g1(),n.scriptOperand[t]=e.g2()}const a=e.g1();if(a>0){n.scripts=new Array(a).fill(null);for(let t=0;t<a;t++){const s=e.g2();n.scripts[t]=new Uint16Array(s).fill(0);for(let i=0;i<s;i++)n.scripts[t][i]=e.g2()}}switch(n.type){case Zt.TYPE_LAYER:{n.scroll=e.g2(),n.hide=e.gbool();const t=e.g1();n.childId=new Uint16Array(t).fill(0),n.childX=new Uint16Array(t).fill(0),n.childY=new Uint16Array(t).fill(0);for(let s=0;s<t;s++)n.childId[s]=e.g2(),n.childX[s]=e.g2s(),n.childY[s]=e.g2s();break}case Zt.TYPE_UNUSED:e.pos+=10;break;case Zt.TYPE_INVENTORY:n.draggable=e.gbool(),n.interactable=e.gbool(),n.usable=e.gbool(),n.marginX=e.g1(),n.marginY=e.g1(),n.inventorySlotOffsetX=new Uint16Array(20).fill(0),n.inventorySlotOffsetY=new Uint16Array(20).fill(0),n.inventorySlotGraphic=new Array(20).fill(null);for(let t=0;t<20;t++)e.gbool()&&(n.inventorySlotOffsetX[t]=e.g2s(),n.inventorySlotOffsetY[t]=e.g2s(),n.inventorySlotGraphic[t]=e.gjstr());n.inventoryOptions=new Array(5).fill(null);for(let t=0;t<5;t++)n.inventoryOptions[t]=e.gjstr();n.actionVerb=e.gjstr(),n.action=e.gjstr(),n.actionTarget=e.g2();break;case Zt.TYPE_RECT:n.fill=e.gbool(),n.colour=e.g4(),n.activeColour=e.g4(),n.overColour=e.g4();break;case Zt.TYPE_TEXT:n.center=e.gbool(),n.font=e.g1(),n.shadowed=e.gbool(),n.text=e.gjstr(),n.activeText=e.gjstr(),n.colour=e.g4(),n.activeColour=e.g4(),n.overColour=e.g4();break;case Zt.TYPE_SPRITE:n.graphic=e.gjstr(),n.activeGraphic=e.gjstr();break;case Zt.TYPE_MODEL:n.model=e.g1(),0!=n.model&&(n.model=(n.model-1<<8)+e.g1()),n.activeModel=e.g1(),0!=n.activeModel&&(n.activeModel=(n.activeModel-1<<8)+e.g1()),n.anim=e.g1(),0==n.anim?n.anim=-1:n.anim=(n.anim-1<<8)+e.g1(),n.activeAnim=e.g1(),0==n.activeAnim?n.activeAnim=-1:n.activeAnim=(n.activeAnim-1<<8)+e.g1(),n.zoom=e.g2(),n.xan=e.g2(),n.yan=e.g2();break;case Zt.TYPE_INVENTORY_TEXT:n.center=e.gbool(),n.font=e.g1(),n.shadowed=e.gbool(),n.colour=e.g4(),n.marginX=e.g2s(),n.marginY=e.g2s(),n.interactable=e.gbool(),n.inventoryOptions=new Array(5).fill(null);for(let t=0;t<5;t++)n.inventoryOptions[t]=e.gjstr()}switch(n.buttonType){case Zt.NO_BUTTON:break;case Zt.TARGET_BUTTON:n.actionVerb=e.gjstr(),n.action=e.gjstr(),n.actionTarget=e.g2();break;case Zt.BUTTON:case Zt.TOGGLE_BUTTON:case Zt.SELECT_BUTTON:case Zt.PAUSE_BUTTON:n.option=e.gjstr()}Zt.components[t]=n,n.comName&&Zt.componentNames.set(n.comName,t)}}static get(t){return Zt.components[t]}static getId(t){return Zt.componentNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}id=-1;rootLayer=-1;comName=null;overlay=!1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;inventorySlotOffsetX=null;inventorySlotOffsetY=null;inventorySlotGraphic=null;inventoryOptions=null;fill=!1;center=!1;font=0;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=-1;activeModel=-1;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null}class $t extends gt{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static SCOPE_SHARED=2;static INV=-1;static WORN=-1;static async load(t){if($t.configNames=new Map,$t.configs=[],!(await fetch(`${t}/server/inv.dat`)).ok)return void console.log('Warning: No inv.dat found.');const e=await ut.load(`${t}/server/inv.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new $t(t);s.decodeType(e),$t.configs[t]=s,s.debugname&&$t.configNames.set(s.debugname,t)}$t.INV=$t.getId('inv'),$t.WORN=$t.getId('worn')}static get(t){return $t.configs[t]}static getId(t){return $t.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}scope=0;size=1;stackall=!1;restock=!1;allstock=!1;stockobj=null;stockcount=null;stockrate=null;protect=!0;runweight=!1;dummyinv=!1;decode(t,e){if(1===t)this.scope=e.g1();else if(2===t)this.size=e.g2();else if(3===t)this.stackall=!0;else if(4===t){const t=e.g1();this.stockobj=new Uint16Array(t),this.stockcount=new Uint16Array(t),this.stockrate=new Int32Array(t);for(let s=0;s<t;s++)this.stockobj[s]=e.g2(),this.stockcount[s]=e.g2(),this.stockrate[s]=e.g4()}else if(5===t)this.restock=!0;else if(6===t)this.allstock=!0;else if(7===t)this.protect=!1;else if(8===t)this.runweight=!0;else if(9===t)this.dummyinv=!0;else{if(250!==t)throw new Error(`Unrecognized inv config code: ${t}`);this.debugname=e.gjstr()}}}var Jt,Xt,qt=function(t,e,s){const n=e.params?.get(t);return'string'!=typeof n?s??'null':n},Qt=function(t,e,s){const n=e.params?.get(t);return'number'!=typeof n?s:n},te=function(t){const e=t.g1(),s=new Map;for(let n=0;n<e;n++){const e=t.g3();t.gbool()?s.set(e,t.gjstr()):s.set(e,t.g4())}return s};class ee extends gt{static configNames=new Map;static configs=[];static async load(t){if(ee.configNames=new Map,ee.configs=[],!(await fetch(`${t}/server/loc.dat`)).ok)return void console.log('Warning: No loc.dat found.');const e=await ut.load(`${t}/server/loc.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('loc.dat');n.pos=2;for(let t=0;t<s;t++){const s=new ee(t);s.active=-1,s.decodeType(e),s.decodeType(n),-1===s.active&&s.shapes&&(s.active=s.shapes.length>0&&10===s.shapes[0]?1:0,s.op&&s.op.length>0&&(s.active=1)),ee.configs[t]=s,s.debugname&&ee.configNames.set(s.debugname,t)}}static get(t){return ee.configs[t]}static getId(t){return ee.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return void 0===e||-1===e?null:this.get(e)}static get count(){return this.configs.length}models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=0;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;hasalpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;xoff=0;yoff=0;zoff=0;forcedecor=!1;category=-1;params=new Map;decode(t,e){if(1===t){const t=e.g1();this.models=new Uint16Array(t),this.shapes=new Uint8Array(t);for(let s=0;s<t;s++)this.models[s]=e.g2(),this.shapes[s]=e.g1()}else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(14===t)this.width=e.g1();else if(15===t)this.length=e.g1();else if(17===t)this.blockwalk=!1;else if(18===t)this.blockrange=!1;else if(19===t)this.active=e.g1();else if(21===t)this.hillskew=!0;else if(22===t)this.sharelight=!0;else if(23===t)this.occlude=!0;else if(24===t)this.anim=e.g2(),65535==this.anim&&(this.anim=-1);else if(25===t)this.hasalpha=!0;else if(28===t)this.wallwidth=e.g1();else if(29===t)this.ambient=e.g1b();else if(39===t)this.contrast=e.g1b();else if(t>=30&&t<35)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr(),'hidden'===this.op[t-30]&&(this.op[t-30]=null);else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let s=0;s<t;s++)this.recol_s[s]=e.g2(),this.recol_d[s]=e.g2()}else if(60===t)this.mapfunction=e.g2();else if(62===t)this.mirror=!0;else if(64===t)this.shadow=!1;else if(65===t)this.resizex=e.g2();else if(66===t)this.resizey=e.g2();else if(67===t)this.resizez=e.g2();else if(68===t)this.mapscene=e.g2();else if(69===t)this.forceapproach=e.g1();else if(70===t)this.xoff=e.g2s();else if(71===t)this.yoff=e.g2s();else if(72===t)this.zoff=e.g2s();else if(73===t)this.forcedecor=!0;else if(200===t)this.category=e.g2();else if(249===t)this.params=te(e);else{if(250!==t)throw new Error(`Unrecognized loc config code: ${t}`);this.debugname=e.gjstr()}}}class se extends gt{static configNames=new Map;static configs=[];static async load(t){if(se.configNames=new Map,se.configs=[],!(await fetch(`${t}/server/mesanim.dat`)).ok)return void console.log('Warning: No mesanim.dat found.');const e=await ut.load(`${t}/server/mesanim.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new se(t);s.decodeType(e),se.configs[t]=s,s.debugname&&se.configNames.set(s.debugname,t)}}static get(t){return se.configs[t]}static getId(t){return se.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}len=new Array(4).fill(-1);decode(t,e){if(t>=1&&t<5)this.len[t-1]=e.g2();else{if(250!==t)throw new Error(`Unrecognized mesanim config code: ${t}`);this.debugname=e.gjstr()}}}(Xt=Jt||={})[Xt.NONE=0]='NONE',Xt[Xt.NPC=1]='NPC',Xt[Xt.ALL=2]='ALL';var ne,ie,ae=Jt;(ie=ne||={})[ie.NORMAL=0]='NORMAL',ie[ie.BLOCKED=1]='BLOCKED',ie[ie.BLOCKED_NORMAL=2]='BLOCKED_NORMAL',ie[ie.INDOORS=3]='INDOORS',ie[ie.OUTDOORS=4]='OUTDOORS',ie[ie.NOMOVE=5]='NOMOVE',ie[ie.PASSTHRU=6]='PASSTHRU';var re,oe,ce=ne;(oe=re||={})[oe.ATTACK=0]='ATTACK',oe[oe.DEFENCE=1]='DEFENCE',oe[oe.STRENGTH=2]='STRENGTH',oe[oe.HITPOINTS=3]='HITPOINTS',oe[oe.RANGED=4]='RANGED',oe[oe.MAGIC=5]='MAGIC';var le=re;class he extends gt{static configNames=new Map;static configs=[];static async load(t){if(he.configNames=new Map,he.configs=[],!(await fetch(`${t}/server/npc.dat`)).ok)return void console.log('Warning: No npc.dat found.');const e=await ut.load(`${t}/server/npc.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('npc.dat');n.pos=2;for(let t=0;t<s;t++){const s=new he(t);s.decodeType(e),s.decodeType(n),he.configs[t]=s,s.debugname&&he.configNames.set(s.debugname,t)}}static get(t){return he.configs[t]}static getId(t){return he.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}name=null;desc=null;size=1;models=null;heads=null;hasanim=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;hasalpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;category=-1;wanderrange=5;maxrange=10;huntrange=5;timer=-1;respawnrate=100;stats=[1,1,1,1,1,1];moverestrict=ce.NORMAL;attackrange=7;huntmode=-1;defaultmode=Yt.WANDER;members=!1;blockwalk=ae.NPC;params=new Map;patrolCoord=[];patrolDelay=[];givechase=!0;decode(t,e){if(1===t){const t=e.g1();this.models=new Uint16Array(t);for(let s=0;s<t;s++)this.models[s]=e.g2()}else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(12===t)this.size=e.g1();else if(13===t)this.readyanim=e.g2();else if(14===t)this.walkanim=e.g2();else if(16===t)this.hasanim=!0;else if(17===t)this.walkanim=e.g2(),this.walkanim_b=e.g2(),this.walkanim_r=e.g2(),this.walkanim_l=e.g2();else if(18===t)this.category=e.g2();else if(t>=30&&t<40)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr(),'hidden'===this.op[t-30]&&(this.op[t-30]=null);else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let s=0;s<t;s++)this.recol_s[s]=e.g2(),this.recol_d[s]=e.g2()}else if(60===t){const t=e.g1();this.heads=new Uint16Array(t);for(let s=0;s<t;s++)this.heads[s]=e.g2()}else if(74===t)this.stats[le.ATTACK]=e.g2();else if(75===t)this.stats[le.DEFENCE]=e.g2();else if(76===t)this.stats[le.STRENGTH]=e.g2();else if(77===t)this.stats[le.HITPOINTS]=e.g2();else if(78===t)this.stats[le.RANGED]=e.g2();else if(79===t)this.stats[le.MAGIC]=e.g2();else if(90===t)this.resizex=e.g2();else if(91===t)this.resizey=e.g2();else if(92===t)this.resizez=e.g2();else if(93===t)this.minimap=!1;else if(95===t)this.vislevel=e.g2();else if(97===t)this.resizeh=e.g2();else if(98===t)this.resizev=e.g2();else if(200===t)this.wanderrange=e.g1();else if(201===t)this.maxrange=e.g1();else if(202===t)this.huntrange=e.g1();else if(203===t)this.timer=e.g2();else if(204===t)this.respawnrate=e.g2();else if(206===t)this.moverestrict=e.g1();else if(207==t)this.attackrange=e.g1();else if(208===t)this.blockwalk=e.g1();else if(209===t)this.huntmode=e.g1();else if(210===t)this.defaultmode=e.g1();else if(211===t)this.members=!0;else if(212===t){const t=e.g1();this.patrolCoord=new Array(t),this.patrolDelay=new Array(t);for(let s=0;s<t;s++)this.patrolCoord[s]=e.g4(),this.patrolDelay[s]=e.g1()}else 213===t?this.givechase=!1:249===t?this.params=te(e):250===t?this.debugname=e.gjstr():(console.error('Unrecognized npc config code: '+t),console.error('Try `npm run build` and report an issue if this still happens.'),process.exit(1))}}class de extends gt{static configNames=new Map;static configs=[];static async load(t){de.configNames=new Map,de.configs=[],(await fetch(`${t}/server/param.dat`)).ok||console.log('Warning: No param.dat found.');const e=await ut.load(`${t}/server/param.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new de(t);s.decodeType(e),de.configs[t]=s,s.debugname&&de.configNames.set(s.debugname,t)}}static get(t){return de.configs[t]}static getId(t){return de.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=mt.INT;defaultInt=-1;defaultString=null;autodisable=!0;decode(t,e){if(1===t)this.type=e.g1();else if(2===t)this.defaultInt=e.g4();else if(4===t)this.autodisable=!1;else if(5===t)this.defaultString=e.gjstr();else{if(250!==t)throw new Error(`Unrecognized param config code: ${t}`);this.debugname=e.gjstr()}}getType(){switch(this.type){case mt.INT:return'int';case mt.STRING:return'string';case mt.ENUM:return'enum';case mt.OBJ:return'obj';case mt.LOC:return'loc';case mt.COMPONENT:return'component';case mt.NAMEDOBJ:return'namedobj';case mt.STRUCT:return'struct';case mt.BOOLEAN:return'boolean';case mt.COORD:return'coord';case mt.CATEGORY:return'category';case mt.SPOTANIM:return'spotanim';case mt.NPC:return'npc';case mt.INV:return'inv';case mt.SYNTH:return'synth';case mt.SEQ:return'seq';case mt.STAT:return'stat';case mt.INTERFACE:return'interface';default:return'unknown'}}isString(){return this.type===mt.STRING}get default(){return this.isString()?this.defaultString:this.defaultInt}}var pe,ue,ge={WEB_PORT:80,WEB_CORS:!0,NODE_ID:10,NODE_PORT:43594,NODE_MEMBERS:!0,NODE_XPRATE:1,NODE_PRODUCTION:!1,NODE_KILLTIMER:50,NODE_ALLOW_CHEATS:!0,NODE_DEBUG:!0,NODE_DEBUG_PROFILE:!1,NODE_STAFF:['pazaz'],NODE_CLIENT_ROUTEFINDER:!0,NODE_SOCKET_TIMEOUT:!0,LOGIN_HOST:'localhost',LOGIN_PORT:43500,LOGIN_KEY:'',DB_HOST:'localhost',DB_USER:'root',DB_PASS:'password',DB_NAME:'lostcity',BUILD_JAVA_PATH:'java',BUILD_STARTUP:!0,BUILD_STARTUP_UPDATE:!0,BUILD_VERIFY:!0,BUILD_VERIFY_FOLDER:!0,BUILD_VERIFY_PACK:!0,BUILD_SRC_DIR:'data/src'};class _e extends gt{static configNames=new Map;static configs=[];static async load(t){if(_e.configNames=new Map,_e.configs=[],!(await fetch(`${t}/server/obj.dat`)).ok)return void console.log('Warning: No obj.dat found.');const e=await ut.load(`${t}/server/obj.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('obj.dat');n.pos=2;for(let t=0;t<s;t++){const s=new _e(t);s.decodeType(e),s.decodeType(n),_e.configs[t]=s,s.debugname&&_e.configNames.set(s.debugname,t)}for(let t=0;t<s;t++){const e=_e.configs[t];-1!=e.certtemplate&&e.toCertificate(),!ge.NODE_MEMBERS&&e.members&&(e.tradeable=!1,e.op=null,e.iop=null,e.params.forEach(((t,s)=>{de.get(s)?.autodisable&&e.params.delete(s)})))}}static get(t){return _e.configs[t]}static getId(t){return _e.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}static getWearPosId(t){switch(t){case'hat':return 0;case'back':return 1;case'front':return 2;case'righthand':return 3;case'torso':return 4;case'lefthand':return 5;case'arms':return 6;case'legs':return 7;case'head':return 8;case'hands':return 9;case'feet':return 10;case'jaw':return 11;case'ring':return 12;case'quiver':return 13;default:return-1}}model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;wearpos=-1;wearpos2=-1;wearpos3=-1;weight=0;category=-1;dummyitem=0;tradeable=!1;respawnrate=100;params=new Map;decode(t,e){if(1===t)this.model=e.g2();else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(4===t)this.zoom2d=e.g2();else if(5===t)this.xan2d=e.g2();else if(6===t)this.yan2d=e.g2();else if(7===t)this.xof2d=e.g2s();else if(8===t)this.yof2d=e.g2s();else if(9===t)this.code9=!0;else if(10===t)this.code10=e.g2();else if(11===t)this.stackable=!0;else if(12===t)this.cost=e.g4();else if(13===t)this.wearpos=e.g1();else if(14===t)this.wearpos2=e.g1();else if(16===t)this.members=!0;else if(23===t)this.manwear=e.g2(),this.manwearOffsetY=e.g1b();else if(24===t)this.manwear2=e.g2();else if(25===t)this.womanwear=e.g2(),this.womanwearOffsetY=e.g1b();else if(26===t)this.womanwear2=e.g2();else if(27===t)this.wearpos3=e.g1();else if(t>=30&&t<35)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr();else if(t>=35&&t<40)this.iop||(this.iop=new Array(5).fill(null)),this.iop[t-35]=e.gjstr();else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let s=0;s<t;s++)this.recol_s[s]=e.g2(),this.recol_d[s]=e.g2()}else if(75===t)this.weight=e.g2s();else if(78===t)this.manwear3=e.g2();else if(79===t)this.womanwear3=e.g2();else if(90===t)this.manhead=e.g2();else if(91===t)this.womanhead=e.g2();else if(92===t)this.manhead2=e.g2();else if(93===t)this.womanhead2=e.g2();else if(94===t)this.category=e.g2();else if(95===t)this.zan2d=e.g2();else if(96===t)this.dummyitem=e.g1();else if(97===t)this.certlink=e.g2();else if(98===t)this.certtemplate=e.g2();else if(t>=100&&t<110)this.countobj&&this.countco||(this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10)),this.countobj[t-100]=e.g2(),this.countco[t-100]=e.g2();else if(200===t)this.tradeable=!0;else if(201===t)this.respawnrate=e.g2();else if(249===t)this.params=te(e);else{if(250!==t)throw new Error(`Unrecognized obj config code: ${t}`);this.debugname=e.gjstr()}}toCertificate(){const t=_e.get(this.certtemplate);this.model=t.model,this.zoom2d=t.zoom2d,this.xan2d=t.xan2d,this.yan2d=t.yan2d,this.zan2d=t.zan2d,this.xof2d=t.xof2d,this.yof2d=t.yof2d,this.recol_s=t.recol_s,this.recol_d=t.recol_d;const e=_e.get(this.certlink);this.name=e.name,this.members=e.members,this.cost=e.cost,this.tradeable=e.tradeable;let s='a';const n=(e.name||'').toLowerCase().charAt(0);'a'!==n&&'e'!==n&&'i'!==n&&'o'!==n&&'u'!==n||(s='an'),this.desc=`Swap this note at any bank for ${s} ${e.name}.`,this.stackable=!0}}class me{static instances=[];static async load(t){if(me.instances=[],!(await fetch(`${t}/server/frame_del.dat`)).ok)return void console.log('Warning: No frame_del.dat found.');const e=await ut.load(`${t}/server/frame_del.dat`);for(let t=0;t<e.data.length;t++){const s=new me;s.delay=e.g1(),me.instances[t]=s}}delay=0}class fe extends gt{static configNames=new Map;static configs=[];static async load(t){if(fe.configNames=new Map,fe.configs=[],!(await fetch(`${t}/server/seq.dat`)).ok)return void console.log('Warning: No seq.dat found.');const e=await ut.load(`${t}/server/seq.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('seq.dat');n.pos=2;for(let t=0;t<s;t++){const s=new fe(t);s.decodeType(e),s.decodeType(n),fe.configs[t]=s,s.debugname&&fe.configNames.set(s.debugname,t)}}static get(t){return fe.configs[t]}static getId(t){return fe.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return fe.configs.length}frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;mainhand=-1;offhand=-1;replaycount=99;duration=0;decode(t,e){if(1===t){const t=e.g1();this.frames=new Int32Array(t),this.iframes=new Int32Array(t),this.delay=new Int32Array(t);for(let s=0;s<t;s++)this.frames[s]=e.g2(),this.iframes[s]=e.g2(),65535===this.iframes[s]&&(this.iframes[s]=-1),this.delay[s]=e.g2(),0===this.delay[s]&&(this.delay[s]=me.instances[this.frames[s]].delay),0===this.delay[s]&&(this.delay[s]=1),this.duration+=this.delay[s]}else if(2===t)this.replayoff=e.g2();else if(3===t){const t=e.g1();this.walkmerge=new Int32Array(t+1);for(let s=0;s<t;s++)this.walkmerge[s]=e.g1();this.walkmerge[t]=9999999}else if(4===t)this.stretches=!0;else if(5===t)this.priority=e.g1();else if(6===t)this.mainhand=e.g2();else if(7===t)this.offhand=e.g2();else if(8===t)this.replaycount=e.g1();else{if(250!==t)throw new Error(`Unrecognized seq config code: ${t}`);this.debugname=e.gjstr()}}}class Ee extends gt{static configNames=new Map;static configs=[];static async load(t){if(Ee.configNames=new Map,Ee.configs=[],!(await fetch(`${t}/server/struct.dat`)).ok)return void console.log('Warning: No struct.dat found.');const e=await ut.load(`${t}/server/struct.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Ee(t);s.decodeType(e),Ee.configs[t]=s,s.debugname&&Ee.configNames.set(s.debugname,t)}}static get(t){return Ee.configs[t]}static getId(t){return Ee.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}params=null;decode(t,e){if(249===t)this.params=te(e);else{if(250!==t)throw new Error(`Unrecognized struct config code: ${t}`);this.debugname=e.gjstr()}}}class Oe extends gt{static configNames=new Map;static configs=[];static async load(t){if(Oe.configNames=new Map,Oe.configs=[],!(await fetch(`${t}/server/varn.dat`)).ok)return void console.log('Warning: No varn.dat found.');const e=await ut.load(`${t}/server/varn.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Oe(t);s.decodeType(e),Oe.configs[t]=s,s.debugname&&Oe.configNames.set(s.debugname,t)}}static get(t){return Oe.configs[t]}static getId(t){return Oe.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=mt.INT;decode(t,e){1===t?this.type=e.g1():250===t?this.debugname=e.gjstr():console.error(`Unrecognized varn config code: ${t}`)}}class Ae extends gt{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static PLAYER_RUN=-1;static TEMP_RUN=-1;static LASTCOMBAT=-1;static async load(t){Ae.configNames=new Map,Ae.configs=[],(await fetch(`${t}/server/varp.dat`)).ok||console.log('Warning: No varp.dat found.');const e=await ut.load(`${t}/server/varp.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('varp.dat');n.pos=2;for(let t=0;t<s;t++){const s=new Ae(t);s.decodeType(e),s.decodeType(n),Ae.configs[t]=s,s.debugname&&Ae.configNames.set(s.debugname,t)}Ae.PLAYER_RUN=Ae.getId('player_run'),Ae.TEMP_RUN=Ae.getId('temp_run'),Ae.LASTCOMBAT=Ae.getId('lastcombat')}static get(t){return Ae.configs[t]}static getId(t){return Ae.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}clientcode=0;scope=Ae.SCOPE_TEMP;type=mt.INT;protect=!0;transmit=!1;decode(t,e){1===t?this.scope=e.g1():2===t?this.type=e.g1():4===t?this.protect=!1:5===t?this.clientcode=e.g2():6===t?this.transmit=!0:250===t?this.debugname=e.gjstr():console.error(`Unrecognized varp config code: ${t}`)}}class Te extends gt{static configNames=new Map;static configs=[];static async load(t){if(Te.configNames=new Map,Te.configs=[],!(await fetch(`${t}/server/vars.dat`)).ok)return void console.log('Warning: No vars.dat found.');const e=await ut.load(`${t}/server/vars.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Te(t);s.decodeType(e),Te.configs[t]=s,s.debugname&&Te.configNames.set(s.debugname,t)}}static get(t){return Te.configs[t]}static getId(t){return Te.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=mt.INT;decode(t,e){switch(t){case 1:this.type=e.g1();break;case 250:this.debugname=e.gjstr();break;default:console.error(`Unrecognized vars config code: ${t}`)}}}class Ie{fragments=[];filter(t){for(let e=0;e<t.length;){const s=this.indexOfNumber(t,e);if(-1===s)return;let n=!1;for(let i=e;i>=0&&i<s&&!n;i++)ye.isSymbol(t[i])||ye.isNotLowercaseAlpha(t[i])||(n=!0);let i=0;n&&(i=0),0===i&&(i=1,e=s);let a=0;for(let n=s;n<t.length&&n<e;n++)a=10*a+t[n].charCodeAt(0)-48;a<=255&&e-s<=8?i++:i=0,4===i&&(ye.maskChars(s,e,t),i=0),e=this.indexOfNonNumber(e,t)}}isBadFragment(t){if(ye.isNumericalChars(t))return!0;const e=this.getInteger(t),s=this.fragments,n=s.length;if(e===s[0]||e===s[n-1])return!0;let i=0,a=n-1;for(;i<=a;){const t=(i+a)/2|0;if(e===s[t])return!0;e<s[t]?a=t-1:i=t+1}return!1}getInteger(t){if(t.length>6)return 0;let e=0;for(let s=0;s<t.length;s++){const n=t[t.length-s-1];if(ye.isLowercaseAlpha(n))e=38*e+n.charCodeAt(0)+1-'a'.charCodeAt(0);else if("'"==n)e=38*e+27;else if(ye.isNumerical(n))e=38*e+n.charCodeAt(0)+28-'0'.charCodeAt(0);else if('\0'!=n)return 0}return e}indexOfNumber(t,e){for(let s=e;s<t.length&&s>=0;s++)if(ye.isNumerical(t[s]))return s;return-1}indexOfNonNumber(t,e){for(let s=t;s<e.length&&s>=0;s++)if(!ye.isNumerical(e[s]))return s;return e.length}}class Ne{wordEncFragments;bads=[];badCombinations=[];constructor(t){this.wordEncFragments=t}filter(t){for(let e=0;e<2;e++)for(let e=this.bads.length-1;e>=0;e--)this.filterBadCombinations(this.badCombinations[e],t,this.bads[e])}filterBadCombinations(t,e,s){if(!(s.length>e.length))for(let n=0;n<=e.length-s.length;n++){let i=n;const{currentIndex:a,badIndex:r,hasSymbol:o,hasNumber:c,hasDigit:l}=this.processBadCharacters(e,s,i);i=a;let h=e[i],d=i+1<e.length?e[i+1]:'\0';if(!(r>=s.length)||c&&l)continue;let p,u=!0;if(o){let t=!1,s=!1;if((n-1<0||ye.isSymbol(e[n-1])&&"'"!=e[n-1])&&(t=!0),(i>=e.length||ye.isSymbol(e[i])&&"'"!=e[i])&&(s=!0),!t||!s){let s=!1;for(p=n-2,t&&(p=n);!s&&p<i;){if(p>=0&&(!ye.isSymbol(e[p])||"'"==e[p])){const t=[];let n;for(n=0;n<3&&p+n<e.length&&(!ye.isSymbol(e[p+n])||"'"==e[p+n]);n++)t[n]=e[p+n];let i=!0;0==n&&(i=!1),n<3&&p-1>=0&&(!ye.isSymbol(e[p-1])||"'"==e[p-1])&&(i=!1),i&&!this.wordEncFragments.isBadFragment(t)&&(s=!0)}p++}s||(u=!1)}}else{h=' ',n-1>=0&&(h=e[n-1]),d=' ',i<e.length&&(d=e[i]);const s=this.getIndex(h),a=this.getIndex(d);null!=t&&this.comboMatches(s,t,a)&&(u=!1)}if(!u)continue;let g=0,_=0;for(let t=n;t<i;t++)ye.isNumerical(e[t])?g++:ye.isAlpha(e[t])&&_++;g<=_&&ye.maskChars(n,i,e)}}processBadCharacters(t,e,s){let n=s,i=0,a=0,r=!1,o=!1,c=!1;for(;n<t.length&&(!o||!c)&&!(n>=t.length||o&&c);){const l=t[n],h=n+1<t.length?t[n+1]:'\0';let d;if(i<e.length&&(d=this.getEmulatedBadCharLen(h,String.fromCharCode(e[i]),l))>0)1===d&&ye.isNumerical(l)&&(o=!0),2===d&&(ye.isNumerical(l)||ye.isNumerical(h))&&(o=!0),n+=d,i++;else{if(0===i)break;let t;if((t=this.getEmulatedBadCharLen(h,String.fromCharCode(e[i-1]),l))>0)n+=t;else{if(i>=e.length||!ye.isNotLowercaseAlpha(l))break;if(ye.isSymbol(l)&&"'"!==l&&(r=!0),ye.isNumerical(l)&&(c=!0),n++,a++,(100*a/(n-s)|0)>90)break}}}return{currentIndex:n,badIndex:i,hasSymbol:r,hasNumber:o,hasDigit:c}}getEmulatedBadCharLen(t,e,s){if(e==s)return 1;if(e>='a'&&e<='m'){if('a'==e)return'4'!=s&&'@'!=s&&'^'!=s?'/'==s&&'\\'==t?2:0:1;if('b'==e)return'6'!=s&&'8'!=s?'1'==s&&'3'==t?2:0:1;if('c'==e)return'('!=s&&'<'!=s&&'{'!=s&&'['!=s?0:1;if('d'==e)return'['==s&&')'==t?2:0;if('e'==e)return'3'!=s&&'€'!=s?0:1;if('f'==e)return'p'==s&&'h'==t?2:'£'==s?1:0;if('g'==e)return'9'!=s&&'6'!=s?0:1;if('h'==e)return'#'==s?1:0;if('i'==e)return'y'!=s&&'l'!=s&&'j'!=s&&'1'!=s&&'!'!=s&&':'!=s&&';'!=s&&'|'!=s?0:1;if('j'==e)return 0;if('k'==e)return 0;if('l'==e)return'1'!=s&&'|'!=s&&'i'!=s?0:1;if('m'==e)return 0}if(e>='n'&&e<='z'){if('n'==e)return 0;if('o'==e)return'0'!=s&&'*'!=s?'('==s&&')'==t||'['==s&&']'==t||'{'==s&&'}'==t||'<'==s&&'>'==t?2:0:1;if('p'==e)return 0;if('q'==e)return 0;if('r'==e)return 0;if('s'==e)return'5'!=s&&'z'!=s&&'$'!=s&&'2'!=s?0:1;if('t'==e)return'7'!=s&&'+'!=s?0:1;if('u'==e)return'v'==s?1:'\\'==s&&'/'==t||'\\'==s&&'|'==t||'|'==s&&'/'==t?2:0;if('v'==e)return'\\'==s&&'/'==t||'\\'==s&&'|'==t||'|'==s&&'/'==t?2:0;if('w'==e)return'v'==s&&'v'==t?2:0;if('x'==e)return')'==s&&'('==t||'}'==s&&'{'==t||']'==s&&'['==t||'>'==s&&'<'==t?2:0;if('y'==e)return 0;if('z'==e)return 0}return e>='0'&&e<='9'?'0'==e?'o'==s||'O'==s?1:'('==s&&')'==t||'{'==s&&'}'==t||'['==s&&']'==t?2:0:'1'==e&&'l'==s?1:0:','==e?'.'==s?1:0:'.'==e?','==s?1:0:'!'==e&&'i'==s?1:0}comboMatches(t,e,s){let n=0,i=e.length-1;for(;n<=i;){const a=(n+i)/2|0;if(e[a][0]===t&&e[a][1]===s)return!0;t<e[a][0]||t===e[a][0]&&s<e[a][1]?i=a-1:n=a+1}return!1}getIndex(t){return ye.isLowercaseAlpha(t)?t.charCodeAt(0)+1-'a'.charCodeAt(0):"'"==t?28:ye.isNumerical(t)?t.charCodeAt(0)+29-'0'.charCodeAt(0):27}}class Pe{wordEncBadWords;domains=[];constructor(t){this.wordEncBadWords=t}filter(t){const e=[...t],s=[...t];this.wordEncBadWords.filterBadCombinations(null,e,ye.AMPERSAT),this.wordEncBadWords.filterBadCombinations(null,s,ye.PERIOD);for(let n=this.domains.length-1;n>=0;n--)this.filterDomain(s,e,this.domains[n],t)}getEmulatedDomainCharLen(t,e,s){return e==s||'o'==e&&'0'==s?1:'o'==e&&'('==s&&')'==t?2:'c'!=e||'('!=s&&'<'!=s&&'['!=s?'e'==e&&'€'==s||'s'==e&&'$'==s||'l'==e&&'i'==s?1:0:1}filterDomain(t,e,s,n){const i=s.length,a=n.length;for(let r=0;r<=a-i;r++){const{matched:i,currentIndex:a}=this.findMatchingDomain(r,s,n);if(!i)continue;const o=ye.prefixSymbolStatus(r,n,3,e,['@']),c=ye.suffixSymbolStatus(a-1,n,3,t,['.',',']);(o>2||c>2)&&ye.maskChars(r,a,n)}}findMatchingDomain(t,e,s){const n=e.length;let i=t,a=0;for(;i<s.length&&a<n;){const r=s[i],o=i+1<s.length?s[i+1]:'\0',c=this.getEmulatedDomainCharLen(o,String.fromCharCode(e[a]),r);if(c>0)i+=c,a++;else{if(0===a)break;const s=this.getEmulatedDomainCharLen(o,String.fromCharCode(e[a-1]),r);if(s>0)i+=s,1===a&&t++;else{if(a>=n||!ye.isSymbol(r))break;i++}}}return{matched:a>=n,currentIndex:i}}}class Le{wordEncBadWords;wordEncDomains;tlds=[];tldTypes=[];constructor(t,e){this.wordEncBadWords=t,this.wordEncDomains=e}filter(t){const e=[...t],s=[...t];this.wordEncBadWords.filterBadCombinations(null,e,ye.PERIOD),this.wordEncBadWords.filterBadCombinations(null,s,ye.SLASH);for(let n=0;n<this.tlds.length;n++)this.filterTld(s,this.tldTypes[n],t,this.tlds[n],e)}filterTld(t,e,s,n,i){if(!(n.length>s.length))for(let a=0;a<=s.length-n.length;a++){const{currentIndex:r,tldIndex:o}=this.processTlds(s,n,a);if(o<n.length)continue;let c=!1;const l=ye.prefixSymbolStatus(a,s,3,i,[',','.']),h=ye.suffixSymbolStatus(r-1,s,5,t,['\\','/']);if(1==e&&l>0&&h>0&&(c=!0),2==e&&(l>2&&h>0||l>0&&h>2)&&(c=!0),3==e&&l>0&&h>2&&(c=!0),!c)continue;let d,p=a,u=r-1,g=!1;if(l>2){if(4==l)for(g=!1,d=a-1;d>=0;d--)if(g){if('*'!=i[d])break;p=d}else'*'==i[d]&&(p=d,g=!0);for(g=!1,d=p-1;d>=0;d--)if(g){if(ye.isSymbol(s[d]))break;p=d}else ye.isSymbol(s[d])||(g=!0,p=d)}if(h>2){if(4==h)for(g=!1,d=u+1;d<s.length;d++)if(g){if('*'!=t[d])break;u=d}else'*'==t[d]&&(u=d,g=!0);for(g=!1,d=u+1;d<s.length;d++)if(g){if(ye.isSymbol(s[d]))break;u=d}else ye.isSymbol(s[d])||(g=!0,u=d)}ye.maskChars(p,u+1,s)}}processTlds(t,e,s){let n=0;for(;s<t.length&&n<e.length;){const i=t[s],a=s+1<t.length?t[s+1]:'\0';let r;if((r=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(e[n]),i))>0)s+=r,n++;else{if(0===n)break;let t;if((t=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(e[n-1]),i))>0)s+=t;else{if(!ye.isSymbol(i))break;s++}}}return{currentIndex:s,tldIndex:n}}}class ye{static PERIOD=new Uint16Array(['d','o','t'].join('').split('').map((t=>t.charCodeAt(0))));static AMPERSAT=new Uint16Array(['(','a',')'].join('').split('').map((t=>t.charCodeAt(0))));static SLASH=new Uint16Array(['s','l','a','s','h'].join('').split('').map((t=>t.charCodeAt(0))));static wordEncFragments=new Ie;static wordEncBadWords=new Ne(this.wordEncFragments);static wordEncDomains=new Pe(this.wordEncBadWords);static wordEncTlds=new Le(this.wordEncBadWords,this.wordEncDomains);static whitelist=['cook',"cook's",'cooks','seeks','sheet'];static async load(t){if(!(await fetch(`${t}/client/wordenc`)).ok)return void console.log('Warning: No wordenc found.');const e=await St.load(`${t}/client/wordenc`),s=e.read('fragmentsenc.txt');if(!s)return void console.log('Warning: No fragmentsenc found.');const n=e.read('badenc.txt');if(!n)return void console.log('Warning: No badenc found.');const i=e.read('domainenc.txt');if(!i)return void console.log('Warning: No domainenc found.');const a=e.read('tldlist.txt');a?(this.decodeBadEnc(n),this.decodeDomainEnc(i),this.decodeFragmentsEnc(s),this.decodeTldList(a)):console.log('Warning: No tldlist found.')}static filter(t){const e=[...t];this.format(e);const s=e.join('').trim(),n=s.toLowerCase(),i=[...n];this.wordEncTlds.filter(i),this.wordEncBadWords.filter(i),this.wordEncDomains.filter(i),this.wordEncFragments.filter(i);for(let t=0;t<this.whitelist.length;t++){let e=-1;for(;-1!==(e=n.indexOf(this.whitelist[t],e+1));){const s=[...this.whitelist[t]];for(let t=0;t<s.length;t++)i[t+e]=s[t]}}return this.replaceUppercases(i,[...s]),this.formatUppercases(i),i.join('').trim()}static isSymbol(t){return!this.isAlpha(t)&&!this.isNumerical(t)}static isNotLowercaseAlpha(t){return!this.isLowercaseAlpha(t)||('v'==t||'x'==t||'j'==t||'q'==t||'z'==t)}static isAlpha(t){return this.isLowercaseAlpha(t)||this.isUppercaseAlpha(t)}static isNumerical(t){return t>='0'&&t<='9'}static isLowercaseAlpha(t){return t>='a'&&t<='z'}static isUppercaseAlpha(t){return t>='A'&&t<='Z'}static isNumericalChars(t){for(let e=0;e<t.length;e++)if(!this.isNumerical(t[e])&&'\0'!==t[e])return!1;return!0}static maskChars(t,e,s){for(let n=t;n<e;n++)s[n]='*'}static maskedCountBackwards(t,e){let s=0;for(let n=e-1;n>=0&&ye.isSymbol(t[n]);n--)'*'===t[n]&&s++;return s}static maskedCountForwards(t,e){let s=0;for(let n=e+1;n<t.length&&this.isSymbol(t[n]);n++)'*'===t[n]&&s++;return s}static maskedCharsStatus(t,e,s,n,i){return(i?this.maskedCountBackwards(e,s):this.maskedCountForwards(e,s))>=n?4:this.isSymbol(i?t[s-1]:t[s+1])?1:0}static prefixSymbolStatus(t,e,s,n,i){if(0===t)return 2;for(let s=t-1;s>=0&&ye.isSymbol(e[s]);s--)if(i.includes(e[s]))return 3;return ye.maskedCharsStatus(e,n,t,s,!0)}static suffixSymbolStatus(t,e,s,n,i){if(t+1===e.length)return 2;for(let s=t+1;s<e.length&&ye.isSymbol(e[s]);s++)if(i.includes(e[s]))return 3;return ye.maskedCharsStatus(e,n,t,s,!1)}static decodeTldList(t){const e=t.g4();for(let s=0;s<e;s++)this.wordEncTlds.tldTypes[s]=t.g1(),this.wordEncTlds.tlds[s]=new Uint16Array(t.g1()).map((()=>t.g1()))}static decodeBadEnc(t){const e=t.g4();for(let s=0;s<e;s++){this.wordEncBadWords.bads[s]=new Uint16Array(t.g1()).map((()=>t.g1()));const e=new Array(t.g1()).fill([]).map((()=>[t.g1b(),t.g1b()]));e.length>0&&(this.wordEncBadWords.badCombinations[s]=e)}}static decodeDomainEnc(t){const e=t.g4();for(let s=0;s<e;s++)this.wordEncDomains.domains[s]=new Uint16Array(t.g1()).map((()=>t.g1()))}static decodeFragmentsEnc(t){const e=t.g4();for(let s=0;s<e;s++)this.wordEncFragments.fragments[s]=t.g2()}static format(t){let e=0;for(let s=0;s<t.length;s++)this.isCharacterAllowed(t[s])?t[e]=t[s]:t[e]=' ',0!==e&&' '===t[e]&&' '===t[e-1]||e++;for(let s=e;s<t.length;s++)t[s]=' '}static isCharacterAllowed(t){return t>=' '&&t<=''||' '==t||'\n'==t||'\t'==t||'£'==t||'€'==t}static replaceUppercases(t,e){for(let s=0;s<e.length;s++)'*'!==t[s]&&this.isUppercaseAlpha(e[s])&&(t[s]=e[s])}static formatUppercases(t){let e=!0;for(let s=0;s<t.length;s++){const n=t[s];this.isAlpha(n)?e?this.isLowercaseAlpha(n)&&(e=!1):this.isUppercaseAlpha(n)&&(t[s]=String.fromCharCode(n.charCodeAt(0)+'a'.charCodeAt(0)-65)):e=!0}}}class Se extends gt{static configNames=new Map;static configs=[];static async load(t){if(Se.configNames=new Map,Se.configs=[],!(await fetch(`${t}/server/spotanim.dat`)).ok)return void console.log('Warning: No spotanim.dat found.');const e=await ut.load(`${t}/server/spotanim.dat`),s=e.g2(),n=(await St.load(`${t}/client/config`)).read('spotanim.dat');n.pos=2;for(let t=0;t<s;t++){const s=new Se(t);s.decodeType(e),s.decodeType(n),Se.configs[t]=s,s.debugname&&Se.configNames.set(s.debugname,t)}}static get(t){return Se.configs[t]}static getId(t){return Se.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}model=0;anim=-1;hasalpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(t,e){if(1===t)this.model=e.g2();else if(2===t)this.anim=e.g2();else if(3===t)this.hasalpha=!0;else if(4===t)this.resizeh=e.g2();else if(5===t)this.resizev=e.g2();else if(6===t)this.orientation=e.g2();else if(7===t)this.ambient=e.g1();else if(8===t)this.contrast=e.g1();else if(t>=40&&t<50)this.recol_s[t-40]=e.g2();else if(t>=50&&t<60)this.recol_d[t-50]=e.g2();else{if(250!==t)throw new Error(`Unrecognized spotanim config code: ${t}`);this.debugname=e.gjstr()}}}function ve(t,e){return function(s){'number'==typeof t?s.pointerCheck(t):s.pointerCheck(t[s.intOperand]),e(s)}}(ue=pe||={})[ue.ActivePlayer=0]='ActivePlayer',ue[ue.ActivePlayer2=1]='ActivePlayer2',ue[ue.ProtectedActivePlayer=2]='ProtectedActivePlayer',ue[ue.ProtectedActivePlayer2=3]='ProtectedActivePlayer2',ue[ue.ActiveNpc=4]='ActiveNpc',ue[ue.ActiveNpc2=5]='ActiveNpc2',ue[ue.ActiveLoc=6]='ActiveLoc',ue[ue.ActiveLoc2=7]='ActiveLoc2',ue[ue.ActiveObj=8]='ActiveObj',ue[ue.ActiveObj2=9]='ActiveObj2',ue[ue._LAST=10]='_LAST';var Ce,we,Re=[4,5],be=[6,7],Ue=[8,9],De=[0,1],Me=[2,3],ke=pe;Z(),(we=Ce||={})[we.PUSH_CONSTANT_INT=0]='PUSH_CONSTANT_INT',we[we.PUSH_VARP=1]='PUSH_VARP',we[we.POP_VARP=2]='POP_VARP',we[we.PUSH_CONSTANT_STRING=3]='PUSH_CONSTANT_STRING',we[we.PUSH_VARN=4]='PUSH_VARN',we[we.POP_VARN=5]='POP_VARN',we[we.BRANCH=6]='BRANCH',we[we.BRANCH_NOT=7]='BRANCH_NOT',we[we.BRANCH_EQUALS=8]='BRANCH_EQUALS',we[we.BRANCH_LESS_THAN=9]='BRANCH_LESS_THAN',we[we.BRANCH_GREATER_THAN=10]='BRANCH_GREATER_THAN',we[we.PUSH_VARS=11]='PUSH_VARS',we[we.POP_VARS=12]='POP_VARS',we[we.RETURN=21]='RETURN',we[we.GOSUB=22]='GOSUB',we[we.JUMP=23]='JUMP',we[we.SWITCH=24]='SWITCH',we[we.BRANCH_LESS_THAN_OR_EQUALS=31]='BRANCH_LESS_THAN_OR_EQUALS',we[we.BRANCH_GREATER_THAN_OR_EQUALS=32]='BRANCH_GREATER_THAN_OR_EQUALS',we[we.PUSH_INT_LOCAL=33]='PUSH_INT_LOCAL',we[we.POP_INT_LOCAL=34]='POP_INT_LOCAL',we[we.PUSH_STRING_LOCAL=35]='PUSH_STRING_LOCAL',we[we.POP_STRING_LOCAL=36]='POP_STRING_LOCAL',we[we.JOIN_STRING=37]='JOIN_STRING',we[we.POP_INT_DISCARD=38]='POP_INT_DISCARD',we[we.POP_STRING_DISCARD=39]='POP_STRING_DISCARD',we[we.GOSUB_WITH_PARAMS=40]='GOSUB_WITH_PARAMS',we[we.JUMP_WITH_PARAMS=41]='JUMP_WITH_PARAMS',we[we.DEFINE_ARRAY=44]='DEFINE_ARRAY',we[we.PUSH_ARRAY_INT=45]='PUSH_ARRAY_INT',we[we.POP_ARRAY_INT=46]='POP_ARRAY_INT',we[we.COORDX=1e3]='COORDX',we[we.COORDY=1001]='COORDY',we[we.COORDZ=1002]='COORDZ',we[we.DISTANCE=1003]='DISTANCE',we[we.HUNTALL=1004]='HUNTALL',we[we.HUNTNEXT=1005]='HUNTNEXT',we[we.INZONE=1006]='INZONE',we[we.LINEOFSIGHT=1007]='LINEOFSIGHT',we[we.LINEOFWALK=1008]='LINEOFWALK',we[we.MAP_BLOCKED=1009]='MAP_BLOCKED',we[we.MAP_INDOORS=1010]='MAP_INDOORS',we[we.MAP_CLOCK=1011]='MAP_CLOCK',we[we.MAP_LOCADDUNSAFE=1012]='MAP_LOCADDUNSAFE',we[we.MAP_MEMBERS=1013]='MAP_MEMBERS',we[we.MAP_PLAYERCOUNT=1014]='MAP_PLAYERCOUNT',we[we.MOVECOORD=1015]='MOVECOORD',we[we.PLAYERCOUNT=1016]='PLAYERCOUNT',we[we.PROJANIM_MAP=1017]='PROJANIM_MAP',we[we.PROJANIM_NPC=1018]='PROJANIM_NPC',we[we.PROJANIM_PL=1019]='PROJANIM_PL',we[we.SEQLENGTH=1020]='SEQLENGTH',we[we.SPLIT_GET=1021]='SPLIT_GET',we[we.SPLIT_GETANIM=1022]='SPLIT_GETANIM',we[we.SPLIT_INIT=1023]='SPLIT_INIT',we[we.SPLIT_LINECOUNT=1024]='SPLIT_LINECOUNT',we[we.SPLIT_PAGECOUNT=1025]='SPLIT_PAGECOUNT',we[we.SPOTANIM_MAP=1026]='SPOTANIM_MAP',we[we.STAT_RANDOM=1027]='STAT_RANDOM',we[we.STRUCT_PARAM=1028]='STRUCT_PARAM',we[we.WORLD_DELAY=1029]='WORLD_DELAY',we[we.NPCCOUNT=1030]='NPCCOUNT',we[we.ZONECOUNT=1031]='ZONECOUNT',we[we.LOCCOUNT=1032]='LOCCOUNT',we[we.OBJCOUNT=1033]='OBJCOUNT',we[we.ALLOWDESIGN=2e3]='ALLOWDESIGN',we[we.ANIM=2001]='ANIM',we[we.BAS_READYANIM=2002]='BAS_READYANIM',we[we.BAS_RUNNING=2003]='BAS_RUNNING',we[we.BAS_TURNONSPOT=2004]='BAS_TURNONSPOT',we[we.BAS_WALK_B=2005]='BAS_WALK_B',we[we.BAS_WALK_F=2006]='BAS_WALK_F',we[we.BAS_WALK_L=2007]='BAS_WALK_L',we[we.BAS_WALK_R=2008]='BAS_WALK_R',we[we.BUFFER_FULL=2009]='BUFFER_FULL',we[we.BUILDAPPEARANCE=2010]='BUILDAPPEARANCE',we[we.BUSY=2011]='BUSY',we[we.CAM_LOOKAT=2012]='CAM_LOOKAT',we[we.CAM_MOVETO=2013]='CAM_MOVETO',we[we.CAM_RESET=2014]='CAM_RESET',we[we.CAM_SHAKE=2015]='CAM_SHAKE',we[we.CLEARQUEUE=2016]='CLEARQUEUE',we[we.CLEARSOFTTIMER=2017]='CLEARSOFTTIMER',we[we.CLEARTIMER=2018]='CLEARTIMER',we[we.COORD=2019]='COORD',we[we.DAMAGE=2020]='DAMAGE',we[we.DISPLAYNAME=2021]='DISPLAYNAME',we[we.FACESQUARE=2022]='FACESQUARE',we[we.FINDUID=2023]='FINDUID',we[we.GENDER=2024]='GENDER',we[we.GETQUEUE=2025]='GETQUEUE',we[we.GIVEXP=2026]='GIVEXP',we[we.HEADICONS_GET=2027]='HEADICONS_GET',we[we.HEADICONS_SET=2028]='HEADICONS_SET',we[we.HEALENERGY=2029]='HEALENERGY',we[we.HINT_COORD=2030]='HINT_COORD',we[we.HINT_NPC=2031]='HINT_NPC',we[we.HINT_PLAYER=2032]='HINT_PLAYER',we[we.HINT_STOP=2033]='HINT_STOP',we[we.IF_CLOSE=2034]='IF_CLOSE',we[we.IF_CLOSESTICKY=2035]='IF_CLOSESTICKY',we[we.IF_MULTIZONE=2036]='IF_MULTIZONE',we[we.IF_OPENCHAT=2037]='IF_OPENCHAT',we[we.IF_OPENCHATSTICKY=2038]='IF_OPENCHATSTICKY',we[we.IF_OPENMAINMODAL=2039]='IF_OPENMAINMODAL',we[we.IF_OPENMAINMODALSIDEOVERLAY=2040]='IF_OPENMAINMODALSIDEOVERLAY',we[we.IF_OPENSIDEOVERLAY=2041]='IF_OPENSIDEOVERLAY',we[we.IF_SETANIM=2042]='IF_SETANIM',we[we.IF_SETCOLOUR=2043]='IF_SETCOLOUR',we[we.IF_SETHIDE=2044]='IF_SETHIDE',we[we.IF_SETMODEL=2045]='IF_SETMODEL',we[we.IF_SETRECOL=2046]='IF_SETRECOL',we[we.IF_SETNPCHEAD=2047]='IF_SETNPCHEAD',we[we.IF_SETOBJECT=2048]='IF_SETOBJECT',we[we.IF_SETPLAYERHEAD=2049]='IF_SETPLAYERHEAD',we[we.IF_SETPOSITION=2050]='IF_SETPOSITION',we[we.IF_SETRESUMEBUTTONS=2051]='IF_SETRESUMEBUTTONS',we[we.IF_SETTAB=2052]='IF_SETTAB',we[we.IF_SETTABACTIVE=2053]='IF_SETTABACTIVE',we[we.IF_SETTABFLASH=2054]='IF_SETTABFLASH',we[we.IF_SETTEXT=2055]='IF_SETTEXT',we[we.LAST_LOGIN_INFO=2056]='LAST_LOGIN_INFO',we[we.LAST_COM=2057]='LAST_COM',we[we.LAST_INT=2058]='LAST_INT',we[we.LAST_ITEM=2059]='LAST_ITEM',we[we.LAST_SLOT=2060]='LAST_SLOT',we[we.LAST_TARGETSLOT=2061]='LAST_TARGETSLOT',we[we.LAST_USEITEM=2062]='LAST_USEITEM',we[we.LAST_USESLOT=2063]='LAST_USESLOT',we[we.LONGQUEUE=2064]='LONGQUEUE',we[we.MES=2065]='MES',we[we.MIDI_JINGLE=2066]='MIDI_JINGLE',we[we.MIDI_SONG=2067]='MIDI_SONG',we[we.NAME=2068]='NAME',we[we.P_APRANGE=2069]='P_APRANGE',we[we.P_ARRIVEDELAY=2070]='P_ARRIVEDELAY',we[we.P_COUNTDIALOG=2071]='P_COUNTDIALOG',we[we.P_DELAY=2072]='P_DELAY',we[we.P_EXACTMOVE=2073]='P_EXACTMOVE',we[we.P_FINDUID=2074]='P_FINDUID',we[we.P_LOCMERGE=2075]='P_LOCMERGE',we[we.P_LOGOUT=2076]='P_LOGOUT',we[we.P_OPHELD=2077]='P_OPHELD',we[we.P_OPLOC=2078]='P_OPLOC',we[we.P_OPNPC=2079]='P_OPNPC',we[we.P_OPNPCT=2080]='P_OPNPCT',we[we.P_OPOBJ=2081]='P_OPOBJ',we[we.P_OPPLAYER=2082]='P_OPPLAYER',we[we.P_OPPLAYERT=2083]='P_OPPLAYERT',we[we.P_PAUSEBUTTON=2084]='P_PAUSEBUTTON',we[we.P_STOPACTION=2085]='P_STOPACTION',we[we.P_TELEJUMP=2086]='P_TELEJUMP',we[we.P_TELEPORT=2087]='P_TELEPORT',we[we.P_WALK=2088]='P_WALK',we[we.PLAYER_FINDALLZONE=2089]='PLAYER_FINDALLZONE',we[we.PLAYER_FINDNEXT=2090]='PLAYER_FINDNEXT',we[we.QUEUE=2091]='QUEUE',we[we.SAY=2092]='SAY',we[we.WALKTRIGGER=2093]='WALKTRIGGER',we[we.SETTIMER=2094]='SETTIMER',we[we.SOFTTIMER=2095]='SOFTTIMER',we[we.SOUND_SYNTH=2096]='SOUND_SYNTH',we[we.SPOTANIM_PL=2097]='SPOTANIM_PL',we[we.STAFFMODLEVEL=2098]='STAFFMODLEVEL',we[we.STAT=2099]='STAT',we[we.STAT_ADD=2100]='STAT_ADD',we[we.STAT_BASE=2101]='STAT_BASE',we[we.STAT_HEAL=2102]='STAT_HEAL',we[we.STAT_SUB=2103]='STAT_SUB',we[we.STRONGQUEUE=2104]='STRONGQUEUE',we[we.UID=2105]='UID',we[we.WEAKQUEUE=2106]='WEAKQUEUE',we[we.IF_OPENMAINOVERLAY=2107]='IF_OPENMAINOVERLAY',we[we.AFK_EVENT=2108]='AFK_EVENT',we[we.LOWMEMORY=2109]='LOWMEMORY',we[we.SETIDKIT=2110]='SETIDKIT',we[we.P_CLEARPENDINGACTION=2111]='P_CLEARPENDINGACTION',we[we.GETWALKTRIGGER=2112]='GETWALKTRIGGER',we[we.BUSY2=2113]='BUSY2',we[we.FINDHERO=2114]='FINDHERO',we[we.BOTH_HEROPOINTS=2115]='BOTH_HEROPOINTS',we[we.SETGENDER=2116]='SETGENDER',we[we.SETSKINCOLOUR=2117]='SETSKINCOLOUR',we[we.P_ANIMPROTECT=2118]='P_ANIMPROTECT',we[we.RUNENERGY=2119]='RUNENERGY',we[we.NPC_ADD=2500]='NPC_ADD',we[we.NPC_ANIM=2501]='NPC_ANIM',we[we.NPC_BASESTAT=2502]='NPC_BASESTAT',we[we.NPC_CATEGORY=2503]='NPC_CATEGORY',we[we.NPC_CHANGETYPE=2504]='NPC_CHANGETYPE',we[we.NPC_COORD=2505]='NPC_COORD',we[we.NPC_DAMAGE=2506]='NPC_DAMAGE',we[we.NPC_DEL=2507]='NPC_DEL',we[we.NPC_DELAY=2508]='NPC_DELAY',we[we.NPC_FACESQUARE=2509]='NPC_FACESQUARE',we[we.NPC_FIND=2510]='NPC_FIND',we[we.NPC_FINDALLANY=2511]='NPC_FINDALLANY',we[we.NPC_FINDEXACT=2512]='NPC_FINDEXACT',we[we.NPC_FINDHERO=2513]='NPC_FINDHERO',we[we.NPC_FINDALLZONE=2514]='NPC_FINDALLZONE',we[we.NPC_FINDNEXT=2515]='NPC_FINDNEXT',we[we.NPC_FINDUID=2516]='NPC_FINDUID',we[we.NPC_GETMODE=2517]='NPC_GETMODE',we[we.NPC_HEROPOINTS=2518]='NPC_HEROPOINTS',we[we.NPC_NAME=2519]='NPC_NAME',we[we.NPC_PARAM=2520]='NPC_PARAM',we[we.NPC_QUEUE=2521]='NPC_QUEUE',we[we.NPC_RANGE=2522]='NPC_RANGE',we[we.NPC_SAY=2523]='NPC_SAY',we[we.NPC_HUNTALL=2524]='NPC_HUNTALL',we[we.NPC_HUNTNEXT=2525]='NPC_HUNTNEXT',we[we.NPC_SETHUNT=2526]='NPC_SETHUNT',we[we.NPC_SETHUNTMODE=2527]='NPC_SETHUNTMODE',we[we.NPC_SETMODE=2528]='NPC_SETMODE',we[we.NPC_WALKTRIGGER=2529]='NPC_WALKTRIGGER',we[we.NPC_SETTIMER=2530]='NPC_SETTIMER',we[we.NPC_STAT=2531]='NPC_STAT',we[we.NPC_STATADD=2532]='NPC_STATADD',we[we.NPC_STATHEAL=2533]='NPC_STATHEAL',we[we.NPC_STATSUB=2534]='NPC_STATSUB',we[we.NPC_TELE=2535]='NPC_TELE',we[we.NPC_TYPE=2536]='NPC_TYPE',we[we.NPC_UID=2537]='NPC_UID',we[we.SPOTANIM_NPC=2538]='SPOTANIM_NPC',we[we.NPC_WALK=2539]='NPC_WALK',we[we.NPC_ATTACKRANGE=2540]='NPC_ATTACKRANGE',we[we.LOC_ADD=3e3]='LOC_ADD',we[we.LOC_ANGLE=3001]='LOC_ANGLE',we[we.LOC_ANIM=3002]='LOC_ANIM',we[we.LOC_CATEGORY=3003]='LOC_CATEGORY',we[we.LOC_CHANGE=3004]='LOC_CHANGE',we[we.LOC_COORD=3005]='LOC_COORD',we[we.LOC_DEL=3006]='LOC_DEL',we[we.LOC_FIND=3007]='LOC_FIND',we[we.LOC_FINDALLZONE=3008]='LOC_FINDALLZONE',we[we.LOC_FINDNEXT=3009]='LOC_FINDNEXT',we[we.LOC_NAME=3010]='LOC_NAME',we[we.LOC_PARAM=3011]='LOC_PARAM',we[we.LOC_SHAPE=3012]='LOC_SHAPE',we[we.LOC_TYPE=3013]='LOC_TYPE',we[we.OBJ_ADD=3500]='OBJ_ADD',we[we.OBJ_ADDALL=3501]='OBJ_ADDALL',we[we.OBJ_COORD=3502]='OBJ_COORD',we[we.OBJ_COUNT=3503]='OBJ_COUNT',we[we.OBJ_DEL=3504]='OBJ_DEL',we[we.OBJ_NAME=3505]='OBJ_NAME',we[we.OBJ_PARAM=3506]='OBJ_PARAM',we[we.OBJ_TAKEITEM=3507]='OBJ_TAKEITEM',we[we.OBJ_TYPE=3508]='OBJ_TYPE',we[we.NC_CATEGORY=4e3]='NC_CATEGORY',we[we.NC_DEBUGNAME=4001]='NC_DEBUGNAME',we[we.NC_DESC=4002]='NC_DESC',we[we.NC_NAME=4003]='NC_NAME',we[we.NC_OP=4004]='NC_OP',we[we.NC_PARAM=4005]='NC_PARAM',we[we.LC_CATEGORY=4100]='LC_CATEGORY',we[we.LC_DEBUGNAME=4101]='LC_DEBUGNAME',we[we.LC_DESC=4102]='LC_DESC',we[we.LC_NAME=4103]='LC_NAME',we[we.LC_OP=4104]='LC_OP',we[we.LC_PARAM=4105]='LC_PARAM',we[we.LC_WIDTH=4106]='LC_WIDTH',we[we.LC_LENGTH=4107]='LC_LENGTH',we[we.OC_CATEGORY=4200]='OC_CATEGORY',we[we.OC_CERT=4201]='OC_CERT',we[we.OC_COST=4202]='OC_COST',we[we.OC_DEBUGNAME=4203]='OC_DEBUGNAME',we[we.OC_DESC=4204]='OC_DESC',we[we.OC_IOP=4205]='OC_IOP',we[we.OC_MEMBERS=4206]='OC_MEMBERS',we[we.OC_NAME=4207]='OC_NAME',we[we.OC_OP=4208]='OC_OP',we[we.OC_PARAM=4209]='OC_PARAM',we[we.OC_STACKABLE=4210]='OC_STACKABLE',we[we.OC_TRADEABLE=4211]='OC_TRADEABLE',we[we.OC_UNCERT=4212]='OC_UNCERT',we[we.OC_WEARPOS2=4213]='OC_WEARPOS2',we[we.OC_WEARPOS3=4214]='OC_WEARPOS3',we[we.OC_WEARPOS=4215]='OC_WEARPOS',we[we.OC_WEIGHT=4216]='OC_WEIGHT',we[we.INV_ALLSTOCK=4300]='INV_ALLSTOCK',we[we.INV_SIZE=4301]='INV_SIZE',we[we.INV_STOCKBASE=4302]='INV_STOCKBASE',we[we.INV_ADD=4303]='INV_ADD',we[we.INV_CHANGESLOT=4304]='INV_CHANGESLOT',we[we.INV_CLEAR=4305]='INV_CLEAR',we[we.INV_DEL=4306]='INV_DEL',we[we.INV_DELSLOT=4307]='INV_DELSLOT',we[we.INV_DROPITEM=4308]='INV_DROPITEM',we[we.INV_DROPSLOT=4309]='INV_DROPSLOT',we[we.INV_FREESPACE=4310]='INV_FREESPACE',we[we.INV_GETNUM=4311]='INV_GETNUM',we[we.INV_GETOBJ=4312]='INV_GETOBJ',we[we.INV_ITEMSPACE=4313]='INV_ITEMSPACE',we[we.INV_ITEMSPACE2=4314]='INV_ITEMSPACE2',we[we.INV_MOVEFROMSLOT=4315]='INV_MOVEFROMSLOT',we[we.INV_MOVETOSLOT=4316]='INV_MOVETOSLOT',we[we.BOTH_MOVEINV=4317]='BOTH_MOVEINV',we[we.INV_MOVEITEM=4318]='INV_MOVEITEM',we[we.INV_MOVEITEM_CERT=4319]='INV_MOVEITEM_CERT',we[we.INV_MOVEITEM_UNCERT=4320]='INV_MOVEITEM_UNCERT',we[we.INV_SETSLOT=4321]='INV_SETSLOT',we[we.INV_TOTAL=4322]='INV_TOTAL',we[we.INV_TOTALCAT=4323]='INV_TOTALCAT',we[we.INV_TRANSMIT=4324]='INV_TRANSMIT',we[we.INVOTHER_TRANSMIT=4325]='INVOTHER_TRANSMIT',we[we.INV_STOPTRANSMIT=4326]='INV_STOPTRANSMIT',we[we.BOTH_DROPSLOT=4327]='BOTH_DROPSLOT',we[we.INV_DROPALL=4328]='INV_DROPALL',we[we.INV_TOTALPARAM=4329]='INV_TOTALPARAM',we[we.INV_TOTALPARAM_STACK=4330]='INV_TOTALPARAM_STACK',we[we.ENUM=4400]='ENUM',we[we.ENUM_GETOUTPUTCOUNT=4401]='ENUM_GETOUTPUTCOUNT',we[we.APPEND_NUM=4500]='APPEND_NUM',we[we.APPEND=4501]='APPEND',we[we.APPEND_SIGNNUM=4502]='APPEND_SIGNNUM',we[we.LOWERCASE=4503]='LOWERCASE',we[we.TEXT_GENDER=4504]='TEXT_GENDER',we[we.TOSTRING=4505]='TOSTRING',we[we.COMPARE=4506]='COMPARE',we[we.TEXT_SWITCH=4507]='TEXT_SWITCH',we[we.APPEND_CHAR=4508]='APPEND_CHAR',we[we.STRING_LENGTH=4509]='STRING_LENGTH',we[we.SUBSTRING=4510]='SUBSTRING',we[we.STRING_INDEXOF_CHAR=4511]='STRING_INDEXOF_CHAR',we[we.STRING_INDEXOF_STRING=4512]='STRING_INDEXOF_STRING',we[we.ADD=4600]='ADD',we[we.SUB=4601]='SUB',we[we.MULTIPLY=4602]='MULTIPLY',we[we.DIVIDE=4603]='DIVIDE',we[we.RANDOM=4604]='RANDOM',we[we.RANDOMINC=4605]='RANDOMINC',we[we.INTERPOLATE=4606]='INTERPOLATE',we[we.ADDPERCENT=4607]='ADDPERCENT',we[we.SETBIT=4608]='SETBIT',we[we.CLEARBIT=4609]='CLEARBIT',we[we.TESTBIT=4610]='TESTBIT',we[we.MODULO=4611]='MODULO',we[we.POW=4612]='POW',we[we.INVPOW=4613]='INVPOW',we[we.AND=4614]='AND',we[we.OR=4615]='OR',we[we.MIN=4616]='MIN',we[we.MAX=4617]='MAX',we[we.SCALE=4618]='SCALE',we[we.BITCOUNT=4619]='BITCOUNT',we[we.TOGGLEBIT=4620]='TOGGLEBIT',we[we.SETBIT_RANGE=4621]='SETBIT_RANGE',we[we.CLEARBIT_RANGE=4622]='CLEARBIT_RANGE',we[we.GETBIT_RANGE=4623]='GETBIT_RANGE',we[we.SETBIT_RANGE_TOINT=4624]='SETBIT_RANGE_TOINT',we[we.SIN_DEG=4625]='SIN_DEG',we[we.COS_DEG=4626]='COS_DEG',we[we.ATAN2_DEG=4627]='ATAN2_DEG',we[we.ABS=4628]='ABS',we[we.DB_FIND_WITH_COUNT=7500]='DB_FIND_WITH_COUNT',we[we.DB_FINDNEXT=7501]='DB_FINDNEXT',we[we.DB_GETFIELD=7502]='DB_GETFIELD',we[we.DB_GETFIELDCOUNT=7503]='DB_GETFIELDCOUNT',we[we.DB_LISTALL_WITH_COUNT=7504]='DB_LISTALL_WITH_COUNT',we[we.DB_GETROWTABLE=7505]='DB_GETROWTABLE',we[we.DB_FINDBYINDEX=7506]='DB_FINDBYINDEX',we[we.DB_FIND_REFINE_WITH_COUNT=7507]='DB_FIND_REFINE_WITH_COUNT',we[we.DB_FIND=7508]='DB_FIND',we[we.DB_FIND_REFINE=7509]='DB_FIND_REFINE',we[we.DB_LISTALL=7510]='DB_LISTALL',we[we.ERROR=1e4]='ERROR',we[we.MAP_PRODUCTION=10001]='MAP_PRODUCTION',we[we.MAP_LASTCLOCK=10002]='MAP_LASTCLOCK',we[we.MAP_LASTWORLD=10003]='MAP_LASTWORLD',we[we.MAP_LASTCLIENTIN=10004]='MAP_LASTCLIENTIN',we[we.MAP_LASTNPC=10005]='MAP_LASTNPC',we[we.MAP_LASTPLAYER=10006]='MAP_LASTPLAYER',we[we.MAP_LASTLOGOUT=10007]='MAP_LASTLOGOUT',we[we.MAP_LASTLOGIN=10008]='MAP_LASTLOGIN',we[we.MAP_LASTZONE=10009]='MAP_LASTZONE',we[we.MAP_LASTCLIENTOUT=10010]='MAP_LASTCLIENTOUT',we[we.MAP_LASTCLEANUP=10011]='MAP_LASTCLEANUP',we[we.MAP_LASTBANDWIDTHIN=10012]='MAP_LASTBANDWIDTHIN',we[we.MAP_LASTBANDWIDTHOUT=10013]='MAP_LASTBANDWIDTHOUT';var xe=Ce;class Be{info={scriptName:'<unknown>',sourceFilePath:'<unknown>',lookupKey:-1,parameterTypes:[],pcs:[],lines:[]};id;intLocalCount=0;stringLocalCount=0;intArgCount=0;stringArgCount=0;switchTables=[];opcodes=[];intOperands=[];stringOperands=[];static isLargeOperand(t){if(t>100)return!1;switch(t){case xe.RETURN:case xe.POP_INT_DISCARD:case xe.POP_STRING_DISCARD:case xe.GOSUB:case xe.JUMP:return!1}return!0}static decode(t,e){const s=e.data.length;if(s<16)throw new Error('Invalid script file (minimum length)');e.pos=s-2;const n=s-e.g2()-12-2;if(n<0||n>=s)throw new Error('Invalid script file (bad trailer pos)');e.pos=n;const i=new Be(t);e.g4();i.intLocalCount=e.g2(),i.stringLocalCount=e.g2(),i.intArgCount=e.g2(),i.stringArgCount=e.g2();const a=e.g1();for(let t=0;t<a;t++){const s=e.g2(),n=[];for(let t=0;t<s;t++){const t=e.g4(),s=e.g4();n[t]=s}i.switchTables[t]=n}e.pos=0,i.info.scriptName=e.gjstr(0),i.info.sourceFilePath=e.gjstr(0),i.info.lookupKey=e.g4();const r=e.g1();for(let t=0;t<r;t++)i.info.parameterTypes.push(e.g1());const o=e.g2();for(let t=0;t<o;t++)i.info.pcs.push(e.g4()),i.info.lines.push(e.g4());let c=0;for(;n>e.pos;){const t=e.g2();t===xe.PUSH_CONSTANT_STRING?i.stringOperands[c]=e.gjstr(0):Be.isLargeOperand(t)?i.intOperands[c]=e.g4():i.intOperands[c]=e.g1(),i.opcodes[c++]=t}return i}constructor(t){this.id=t}get name(){return this.info.scriptName}get fileName(){return u.basename(this.info.sourceFilePath)}lineNumber(t){for(let e=0;e<this.info.pcs.length;e++)if(this.info.pcs[e]>t)return this.info.lines[e-1];return this.info.lines[this.info.lines.length-1]}}class Fe{static COMPILER_VERSION=18;static scripts=[];static scriptLookup=new Map;static scriptNames=new Map;static async load(t){const e=await ut.load(`${t}/server/script.dat`),s=await ut.load(`${t}/server/script.idx`);e.data.length&&s.data.length||(console.log('\nFatal: No script.dat or script.idx found. Please run the server:build script.'),process.exit(1));const n=e.g2();s.pos+=2;e.g4()!==Fe.COMPILER_VERSION&&(console.error('\nFatal: Scripts were compiled with an older RuneScript compiler. Please update it, try `npm run build` and then restart the server.'),process.exit(1));const i=new Array(n),a=new Map,r=new Map;let o=0;for(let t=0;t<n;t++){const n=s.g2();if(0!==n)try{const s=new Uint8Array(n);e.gdata(s,0,s.length);const c=Be.decode(t,new ut(s));i[t]=c,a.set(c.name,t),4294967295!==c.info.lookupKey&&r.set(c.info.lookupKey,c),o++}catch(e){return console.error(e),console.error(`Warning: Failed to load script ${t}, something may have been partially written`),-1}}return Fe.scripts=i,Fe.scriptNames=a,Fe.scriptLookup=r,o}static get(t){return this.scripts[t]}static getByName(t){const e=Fe.scriptNames.get(t);if(void 0!==e)return Fe.scripts[e]}static getByTrigger(t,e=-1,s=-1){let n=Fe.scriptLookup.get(512|t|e<<10);return n||(n=Fe.scriptLookup.get(256|t|s<<10),n||Fe.scriptLookup.get(t))}static getByTriggerSpecific(t,e=-1,s=-1){return-1!==e?Fe.scriptLookup.get(512|t|e<<10):-1!==s?Fe.scriptLookup.get(256|t|s<<10):Fe.scriptLookup.get(t)}}function He(t){return 0|t}function Ge(t,e,s){return t&~(We[s-e+1]<<e)}Z();var We=function(){const t=[0];let e=2;for(let s=1;s<33;++s)t[s]=He(e-1),e+=e;return t}();class ze{static ABORTED=-1;static RUNNING=0;static FINISHED=1;static SUSPENDED=2;static PAUSEBUTTON=3;static COUNTDIALOG=4;static NPC_SUSPENDED=5;static WORLD_SUSPENDED=6;script;trigger;execution=ze.RUNNING;executionHistory=[];pc=-1;opcount=0;frames=[];fp=0;debugFrames=[];debugFp=0;intStack=[];isp=0;stringStack=[];ssp=0;intLocals=[];stringLocals=[];pointers=0;self=null;_activePlayer=null;_activePlayer2=null;_activeNpc=null;_activeNpc2=null;_activeLoc=null;_activeLoc2=null;_activeObj=null;_activeObj2=null;splitPages=[];splitMesanim=-1;dbTable=null;dbColumn=-1;dbRow=-1;dbRowQuery=[];huntIterator=null;npcIterator=null;locIterator=null;lastInt=0;constructor(t,e=[]){if(this.script=t,this.trigger=255&t.info.lookupKey,e)for(let t=0;t<e.length;t++){const s=e[t];'number'==typeof s?this.intLocals.push(s):this.stringLocals.push(s)}}pointerSet(...t){this.pointers=0;for(let e=0;e<t.length;e++)this.pointers|=1<<t[e]}pointerAdd(t){this.pointers|=1<<t}pointerRemove(t){this.pointers&=~(1<<t)}pointerGet(t){return!!(this.pointers&1<<t)}pointerCheck(...t){for(let e=0;e<t.length;e++){const s=1<<t[e];if((this.pointers&s)!=s)throw new Error(`Required pointer: ${ze.pointerPrint(s)}, current: ${ze.pointerPrint(this.pointers)}`)}}static pointerPrint(t){let e='';for(let s=0;s<ke._LAST;s++)t&1<<s&&(e+=`${ke[s]}, `);return e.substring(0,e.lastIndexOf(','))}get activePlayer(){const t=0===this.intOperand?this._activePlayer:this._activePlayer2;if(null===t)throw new Error('Attempt to access null active_player');return t}set activePlayer(t){0===this.intOperand?this._activePlayer=t:this._activePlayer2=t}get activeNpc(){const t=0===this.intOperand?this._activeNpc:this._activeNpc2;if(null===t)throw new Error('Attempt to access null active_npc');return t}set activeNpc(t){0===this.intOperand?this._activeNpc=t:this._activeNpc2=t}get activeLoc(){const t=0===this.intOperand?this._activeLoc:this._activeLoc2;if(null===t)throw new Error('Attempt to access null active_loc');return t}set activeLoc(t){0===this.intOperand?this._activeLoc=t:this._activeLoc2=t}get activeObj(){const t=0===this.intOperand?this._activeObj:this._activeObj2;if(null===t)throw new Error('Attempt to access null active_obj');return t}set activeObj(t){0===this.intOperand?this._activeObj=t:this._activeObj2=t}get intOperand(){return this.script.intOperands[this.pc]}get stringOperand(){return this.script.stringOperands[this.pc]}popInt(){const t=this.intStack[--this.isp];return t?He(t):0}popInts(t){const e=Array(t);for(let s=t-1;s>=0;s--)e[s]=this.popInt();return e}pushInt(t){this.intStack[this.isp++]=He(t)}popString(){return this.stringStack[--this.ssp]??''}popStrings(t){const e=Array(t);for(let s=t-1;s>=0;s--)e[s]=this.popString();return e}pushString(t){this.stringStack[this.ssp++]=t}reset(){this.pc=-1,this.frames=[],this.fp=0,this.intStack=[],this.isp=0,this.stringStack=[],this.ssp=0,this.intLocals=[],this.stringLocals=[],this.pointers=0}}class Ve{requested=0;completed=0;items=[];constructor(t,e=0,s=[]){this.requested=t,this.completed=e,this.items=s}getLeftOver(){return this.requested-this.completed}hasSucceeded(){return this.completed==this.requested}hasFailed(){return!this.hasSucceeded()}revert(t){for(let e=0;e<this.items.length;e++){const s=this.items[e].item;t.remove(s.id,s.count,this.items[e].slot)}}}class Ye{static STACK_LIMIT=2147483647;static NORMAL_STACK=0;static ALWAYS_STACK=1;static NEVER_STACK=2;static fromType(t){if(-1===t)throw new Error('Invalid inventory type');const e=$t.get(t);let s=Ye.NORMAL_STACK;e.stackall&&(s=Ye.ALWAYS_STACK);const n=new Ye(t,e.size,s);if(e.stockobj&&e.stockcount&&e.stockobj.length)for(let t=0;t<e.stockobj.length;t++)n.set(t,{id:e.stockobj[t],count:e.stockcount[t]});return n}stackType;capacity;type;items;update=!1;constructor(t,e,s=Ye.NORMAL_STACK){this.type=t,this.capacity=e,this.stackType=s,this.items=new Array(e).fill(null)}contains(t){return this.items.some((e=>e&&e.id==t))}hasAt(t,e){const s=this.items[t];return s&&s.id==e}get nextFreeSlot(){return this.items.indexOf(null,0)}get freeSlotCount(){return this.items.filter((t=>null==t)).length}get occupiedSlotCount(){return this.items.filter((t=>null!=t)).length}get isFull(){return this.occupiedSlotCount==this.capacity}get isEmpty(){return 0==this.occupiedSlotCount}get hasAny(){return this.items.some((t=>null!=t))}get hasSpace(){return-1!=this.nextFreeSlot}get itemsFiltered(){return this.items.filter((t=>null!=t))}getItemCount(t){let e=0;for(let s=0;s<this.capacity;s++){const n=this.items[s];n&&n.id==t&&(e+=n.count)}return Math.min(Ye.STACK_LIMIT,e)}getItemIndex(t){return this.items.findIndex((e=>e&&e.id==t))}removeAll(){this.items.fill(null,0,this.capacity),this.update=!0}add(t,e=1,s=-1,n=!0,i=!1,a=!1){const r=_e.get(t),o=!0===$t.get(this.type).stockobj?.includes(t),c=!i&&this.stackType!=Ye.NEVER_STACK&&(r.stackable||this.stackType==Ye.ALWAYS_STACK);let l=0;if(c&&(l=this.getItemCount(t)),l==Ye.STACK_LIMIT)return new Ve(e,0,[]);const h=this.freeSlotCount;if(0==h&&(!c||c&&0==l&&!o))return new Ve(e,0,[]);if(n){if(c&&l>Ye.STACK_LIMIT-e)return new Ve(e,0,[]);if(!c&&e>h)return new Ve(e,0,[])}else{if(c&&l==Ye.STACK_LIMIT)return new Ve(e,0,[]);if(!c&&0==h)return new Ve(e,0,[])}let d=0;const p=[];if(c){let n=this.getItemIndex(t);if(-1==n&&(n=-1==s?this.nextFreeSlot:this.items.indexOf(null,s),-1==n))return new Ve(e,d,[]);const i=this.get(n)?.count??0,r=Math.min(Ye.STACK_LIMIT,i+e),o={id:t,count:r};a||this.set(n,o),p.push({slot:n,item:o}),d=r-i}else{for(let n=Math.max(0,s);n<this.capacity;n++){if(null!=this.items[n])continue;const s={id:t,count:1};if(a||this.set(n,s),p.push({slot:n,item:s}),++d>=e)break}}return new Ve(e,d,p)}remove(t,e=1,s=-1,n=!1){const i=this.getItemCount(t),a=!0===$t.get(this.type).stockobj?.includes(t);if(n&&i<e)return new Ve(e,0,[]);if(!n&&i<1)return new Ve(e,0,[]);let r=0;const o=[];let c=null;if(-1!=s){c=[];for(let t=0;t<s;t++)c.push(t)}let l=0;-1!=s&&(l=s);for(let s=l;s<this.capacity;s++){const n=this.items[s];if(!n||n.id!=t)continue;const i=Math.min(n.count,e-r);if(r+=i,n.count-=i,0==n.count&&!a){const t=this.items[s];this.items[s]=null,t&&o.push({slot:s,item:t})}if(r>=e)break}if(null!=c&&r<e)for(let s=0;s<c.length;s++){const n=this.items[s];if(!n||n.id!=t)continue;const i=Math.min(n.count,e-r);if(r+=i,n.count-=i,0==n.count&&!a){const t=this.items[s];this.items[s]=null,t&&o.push({slot:s,item:t})}if(r>=e)break}return r>0&&(this.update=!0),new Ve(e,r,o)}delete(t){this.items[t]=null,this.update=!0}swap(t,e){const s=this.items[t];this.set(t,this.items[e]),this.set(e,s)}shift(){this.items.sort(((t,e)=>null===t||null===e?+(null===t)-+(null===e):+(t>e)||-(t<e))),this.update=!0}get(t){return this.items[t]}set(t,e){this.items[t]=e,this.update=!0}validSlot(t){return t>=0&&t<this.capacity}transfer(t,e,s=-1,n=-1,i=!1,a=!1){if(e.count<=0)return null;const r=Math.min(e.count,this.getItemCount(e.id)),o=_e.get(e.id);let c={id:e.id,count:r};(i&&-1!==o.certlink&&-1===o.certtemplate||a&&-1!==o.certlink&&o.certtemplate>=0)&&(c={id:o.certlink,count:r});const l=t.add(c.id,c.count,n,!1);if(0==l.completed)return null;const h=this.remove(e.id,l.completed,s,!1);return 0==h.completed?null:h}}async function je(t,e={}){const s={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,s,n){t=o(t>>>0),e=o(e>>>0),s>>>=0,n>>>=0,(()=>{throw Error(`${t} in ${e}:${s}:${n}`)})()},seed:()=>Date.now()*Math.random()})},{exports:n}=await WebAssembly.instantiate(t,s),i=n.memory||e.env.memory,a=Object.setPrototypeOf({findPath(t,e,s,i,a,r,o,l,d,p,u,g,_,m){return u=u?1:0,n.__setArgumentsLength(arguments.length),c(h,2,n.findPath(t,e,s,i,a,r,o,l,d,p,u,g,_,m)>>>0)},findNaivePath(t,e,s,i,a,r,o,l,d,p,u){return n.__setArgumentsLength(arguments.length),c(h,2,n.findNaivePath(t,e,s,i,a,r,o,l,d,p,u)>>>0)},changeFloor(t,e,s,i){i=i?1:0,n.changeFloor(t,e,s,i)},changeLoc(t,e,s,i,a,r,o,c){r=r?1:0,o=o?1:0,c=c?1:0,n.changeLoc(t,e,s,i,a,r,o,c)},changeNpc(t,e,s,i,a){a=a?1:0,n.changeNpc(t,e,s,i,a)},changePlayer(t,e,s,i,a){a=a?1:0,n.changePlayer(t,e,s,i,a)},changeRoof(t,e,s,i){i=i?1:0,n.changeRoof(t,e,s,i)},changeWall(t,e,s,i,a,r,o,c){r=r?1:0,o=o?1:0,c=c?1:0,n.changeWall(t,e,s,i,a,r,o,c)},allocateIfAbsent:(t,e,s)=>c(h,2,n.allocateIfAbsent(t,e,s)>>>0),isZoneAllocated:(t,e,s)=>0!=n.isZoneAllocated(t,e,s),isFlagged:(t,e,s,i)=>0!=n.isFlagged(t,e,s,i),canTravel(t,e,s,i,a,r,o,c){return n.__setArgumentsLength(arguments.length),0!=n.canTravel(t,e,s,i,a,r,o,c)},hasLineOfSight(t,e,s,i,a,r,o,c,l,h){return n.__setArgumentsLength(arguments.length),0!=n.hasLineOfSight(t,e,s,i,a,r,o,c,l,h)},hasLineOfWalk(t,e,s,i,a,r,o,c,l,h){return n.__setArgumentsLength(arguments.length),0!=n.hasLineOfWalk(t,e,s,i,a,r,o,c,l,h)},lineOfSight(t,e,s,i,a,r,o,l,d,p){return n.__setArgumentsLength(arguments.length),c(h,2,n.lineOfSight(t,e,s,i,a,r,o,l,d,p)>>>0)},lineOfWalk(t,e,s,i,a,r,o,l,d,p){return n.__setArgumentsLength(arguments.length),c(h,2,n.lineOfWalk(t,e,s,i,a,r,o,l,d,p)>>>0)},reached(t,e,s,i,a,r,o,c,l,h,d){return n.__setArgumentsLength(arguments.length),0!=n.reached(t,e,s,i,a,r,o,c,l,h,d)},__collides:(t,e,s,i,a,r,o,c)=>0!=n.__collides(t,e,s,i,a,r,o,c),__reachRectangle1:(t,e,s,i,a,r,o,c)=>0!=n.__reachRectangle1(t,e,s,i,a,r,o,c),__reachRectangleN:(t,e,s,i,a,r,o,c,l,h)=>0!=n.__reachRectangleN(t,e,s,i,a,r,o,c,l,h),__reachRectangle:(t,e,s,i,a,r,o,c,l,h)=>0!=n.__reachRectangle(t,e,s,i,a,r,o,c,l,h),__reachExclusiveRectangle:(t,e,s,i,a,r,o,c,l,h)=>0!=n.__reachExclusiveRectangle(t,e,s,i,a,r,o,c,l,h),CollisionFlag:(r={},r[r.NULL=n['CollisionFlag.NULL'].valueOf()]='NULL',r[r.OPEN=n['CollisionFlag.OPEN'].valueOf()]='OPEN',r[r.WALL_NORTH_WEST=n['CollisionFlag.WALL_NORTH_WEST'].valueOf()]='WALL_NORTH_WEST',r[r.WALL_NORTH=n['CollisionFlag.WALL_NORTH'].valueOf()]='WALL_NORTH',r[r.WALL_NORTH_EAST=n['CollisionFlag.WALL_NORTH_EAST'].valueOf()]='WALL_NORTH_EAST',r[r.WALL_EAST=n['CollisionFlag.WALL_EAST'].valueOf()]='WALL_EAST',r[r.WALL_SOUTH_EAST=n['CollisionFlag.WALL_SOUTH_EAST'].valueOf()]='WALL_SOUTH_EAST',r[r.WALL_SOUTH=n['CollisionFlag.WALL_SOUTH'].valueOf()]='WALL_SOUTH',r[r.WALL_SOUTH_WEST=n['CollisionFlag.WALL_SOUTH_WEST'].valueOf()]='WALL_SOUTH_WEST',r[r.WALL_WEST=n['CollisionFlag.WALL_WEST'].valueOf()]='WALL_WEST',r[r.LOC=n['CollisionFlag.LOC'].valueOf()]='LOC',r[r.WALL_NORTH_WEST_PROJ_BLOCKER=n['CollisionFlag.WALL_NORTH_WEST_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_WEST_PROJ_BLOCKER',r[r.WALL_NORTH_PROJ_BLOCKER=n['CollisionFlag.WALL_NORTH_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_PROJ_BLOCKER',r[r.WALL_NORTH_EAST_PROJ_BLOCKER=n['CollisionFlag.WALL_NORTH_EAST_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_EAST_PROJ_BLOCKER',r[r.WALL_EAST_PROJ_BLOCKER=n['CollisionFlag.WALL_EAST_PROJ_BLOCKER'].valueOf()]='WALL_EAST_PROJ_BLOCKER',r[r.WALL_SOUTH_EAST_PROJ_BLOCKER=n['CollisionFlag.WALL_SOUTH_EAST_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_EAST_PROJ_BLOCKER',r[r.WALL_SOUTH_PROJ_BLOCKER=n['CollisionFlag.WALL_SOUTH_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_PROJ_BLOCKER',r[r.WALL_SOUTH_WEST_PROJ_BLOCKER=n['CollisionFlag.WALL_SOUTH_WEST_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_WEST_PROJ_BLOCKER',r[r.WALL_WEST_PROJ_BLOCKER=n['CollisionFlag.WALL_WEST_PROJ_BLOCKER'].valueOf()]='WALL_WEST_PROJ_BLOCKER',r[r.LOC_PROJ_BLOCKER=n['CollisionFlag.LOC_PROJ_BLOCKER'].valueOf()]='LOC_PROJ_BLOCKER',r[r.FLOOR_DECORATION=n['CollisionFlag.FLOOR_DECORATION'].valueOf()]='FLOOR_DECORATION',r[r.NPC=n['CollisionFlag.NPC'].valueOf()]='NPC',r[r.PLAYER=n['CollisionFlag.PLAYER'].valueOf()]='PLAYER',r[r.FLOOR=n['CollisionFlag.FLOOR'].valueOf()]='FLOOR',r[r.WALL_NORTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.WALL_NORTH_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_WEST_ROUTE_BLOCKER',r[r.WALL_NORTH_ROUTE_BLOCKER=n['CollisionFlag.WALL_NORTH_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_ROUTE_BLOCKER',r[r.WALL_NORTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.WALL_NORTH_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_EAST_ROUTE_BLOCKER',r[r.WALL_EAST_ROUTE_BLOCKER=n['CollisionFlag.WALL_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_EAST_ROUTE_BLOCKER',r[r.WALL_SOUTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.WALL_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_EAST_ROUTE_BLOCKER',r[r.WALL_SOUTH_ROUTE_BLOCKER=n['CollisionFlag.WALL_SOUTH_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_ROUTE_BLOCKER',r[r.WALL_SOUTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.WALL_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_WEST_ROUTE_BLOCKER',r[r.WALL_WEST_ROUTE_BLOCKER=n['CollisionFlag.WALL_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_WEST_ROUTE_BLOCKER',r[r.LOC_ROUTE_BLOCKER=n['CollisionFlag.LOC_ROUTE_BLOCKER'].valueOf()]='LOC_ROUTE_BLOCKER',r[r.ROOF=n['CollisionFlag.ROOF'].valueOf()]='ROOF',r[r.FLOOR_BLOCKED=n['CollisionFlag.FLOOR_BLOCKED'].valueOf()]='FLOOR_BLOCKED',r[r.WALK_BLOCKED=n['CollisionFlag.WALK_BLOCKED'].valueOf()]='WALK_BLOCKED',r[r.BLOCK_WEST=n['CollisionFlag.BLOCK_WEST'].valueOf()]='BLOCK_WEST',r[r.BLOCK_EAST=n['CollisionFlag.BLOCK_EAST'].valueOf()]='BLOCK_EAST',r[r.BLOCK_SOUTH=n['CollisionFlag.BLOCK_SOUTH'].valueOf()]='BLOCK_SOUTH',r[r.BLOCK_NORTH=n['CollisionFlag.BLOCK_NORTH'].valueOf()]='BLOCK_NORTH',r[r.BLOCK_SOUTH_WEST=n['CollisionFlag.BLOCK_SOUTH_WEST'].valueOf()]='BLOCK_SOUTH_WEST',r[r.BLOCK_SOUTH_EAST=n['CollisionFlag.BLOCK_SOUTH_EAST'].valueOf()]='BLOCK_SOUTH_EAST',r[r.BLOCK_NORTH_WEST=n['CollisionFlag.BLOCK_NORTH_WEST'].valueOf()]='BLOCK_NORTH_WEST',r[r.BLOCK_NORTH_EAST=n['CollisionFlag.BLOCK_NORTH_EAST'].valueOf()]='BLOCK_NORTH_EAST',r[r.BLOCK_NORTH_AND_SOUTH_EAST=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST'].valueOf()]='BLOCK_NORTH_AND_SOUTH_EAST',r[r.BLOCK_NORTH_AND_SOUTH_WEST=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST'].valueOf()]='BLOCK_NORTH_AND_SOUTH_WEST',r[r.BLOCK_NORTH_EAST_AND_WEST=n['CollisionFlag.BLOCK_NORTH_EAST_AND_WEST'].valueOf()]='BLOCK_NORTH_EAST_AND_WEST',r[r.BLOCK_SOUTH_EAST_AND_WEST=n['CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST'].valueOf()]='BLOCK_SOUTH_EAST_AND_WEST',r[r.BLOCK_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_WEST_ROUTE_BLOCKER',r[r.BLOCK_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_EAST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_ROUTE_BLOCKER',r[r.BLOCK_NORTH_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER',r),LocShape:(t=>(t[t.WALL_STRAIGHT=n['LocShape.WALL_STRAIGHT'].valueOf()]='WALL_STRAIGHT',t[t.WALL_DIAGONAL_CORNER=n['LocShape.WALL_DIAGONAL_CORNER'].valueOf()]='WALL_DIAGONAL_CORNER',t[t.WALL_L=n['LocShape.WALL_L'].valueOf()]='WALL_L',t[t.WALL_SQUARE_CORNER=n['LocShape.WALL_SQUARE_CORNER'].valueOf()]='WALL_SQUARE_CORNER',t[t.WALLDECOR_STRAIGHT_NOOFFSET=n['LocShape.WALLDECOR_STRAIGHT_NOOFFSET'].valueOf()]='WALLDECOR_STRAIGHT_NOOFFSET',t[t.WALLDECOR_STRAIGHT_OFFSET=n['LocShape.WALLDECOR_STRAIGHT_OFFSET'].valueOf()]='WALLDECOR_STRAIGHT_OFFSET',t[t.WALLDECOR_DIAGONAL_OFFSET=n['LocShape.WALLDECOR_DIAGONAL_OFFSET'].valueOf()]='WALLDECOR_DIAGONAL_OFFSET',t[t.WALLDECOR_DIAGONAL_NOOFFSET=n['LocShape.WALLDECOR_DIAGONAL_NOOFFSET'].valueOf()]='WALLDECOR_DIAGONAL_NOOFFSET',t[t.WALLDECOR_DIAGONAL_BOTH=n['LocShape.WALLDECOR_DIAGONAL_BOTH'].valueOf()]='WALLDECOR_DIAGONAL_BOTH',t[t.WALL_DIAGONAL=n['LocShape.WALL_DIAGONAL'].valueOf()]='WALL_DIAGONAL',t[t.CENTREPIECE_STRAIGHT=n['LocShape.CENTREPIECE_STRAIGHT'].valueOf()]='CENTREPIECE_STRAIGHT',t[t.CENTREPIECE_DIAGONAL=n['LocShape.CENTREPIECE_DIAGONAL'].valueOf()]='CENTREPIECE_DIAGONAL',t[t.ROOF_STRAIGHT=n['LocShape.ROOF_STRAIGHT'].valueOf()]='ROOF_STRAIGHT',t[t.ROOF_DIAGONAL_WITH_ROOFEDGE=n['LocShape.ROOF_DIAGONAL_WITH_ROOFEDGE'].valueOf()]='ROOF_DIAGONAL_WITH_ROOFEDGE',t[t.ROOF_DIAGONAL=n['LocShape.ROOF_DIAGONAL'].valueOf()]='ROOF_DIAGONAL',t[t.ROOF_L_CONCAVE=n['LocShape.ROOF_L_CONCAVE'].valueOf()]='ROOF_L_CONCAVE',t[t.ROOF_L_CONVEX=n['LocShape.ROOF_L_CONVEX'].valueOf()]='ROOF_L_CONVEX',t[t.ROOF_FLAT=n['LocShape.ROOF_FLAT'].valueOf()]='ROOF_FLAT',t[t.ROOFEDGE_STRAIGHT=n['LocShape.ROOFEDGE_STRAIGHT'].valueOf()]='ROOFEDGE_STRAIGHT',t[t.ROOFEDGE_DIAGONAL_CORNER=n['LocShape.ROOFEDGE_DIAGONAL_CORNER'].valueOf()]='ROOFEDGE_DIAGONAL_CORNER',t[t.ROOFEDGE_L=n['LocShape.ROOFEDGE_L'].valueOf()]='ROOFEDGE_L',t[t.ROOFEDGE_SQUARE_CORNER=n['LocShape.ROOFEDGE_SQUARE_CORNER'].valueOf()]='ROOFEDGE_SQUARE_CORNER',t[t.GROUND_DECOR=n['LocShape.GROUND_DECOR'].valueOf()]='GROUND_DECOR',t))({}),LocAngle:(t=>(t[t.WEST=n['LocAngle.WEST'].valueOf()]='WEST',t[t.NORTH=n['LocAngle.NORTH'].valueOf()]='NORTH',t[t.EAST=n['LocAngle.EAST'].valueOf()]='EAST',t[t.SOUTH=n['LocAngle.SOUTH'].valueOf()]='SOUTH',t))({}),CollisionType:(t=>(t[t.NORMAL=n['CollisionType.NORMAL'].valueOf()]='NORMAL',t[t.BLOCKED=n['CollisionType.BLOCKED'].valueOf()]='BLOCKED',t[t.INDOORS=n['CollisionType.INDOORS'].valueOf()]='INDOORS',t[t.OUTDOORS=n['CollisionType.OUTDOORS'].valueOf()]='OUTDOORS',t[t.LINE_OF_SIGHT=n['CollisionType.LINE_OF_SIGHT'].valueOf()]='LINE_OF_SIGHT',t))({}),LocLayer:(t=>(t[t.WALL=n['LocLayer.WALL'].valueOf()]='WALL',t[t.WALL_DECOR=n['LocLayer.WALL_DECOR'].valueOf()]='WALL_DECOR',t[t.GROUND=n['LocLayer.GROUND'].valueOf()]='GROUND',t[t.GROUND_DECOR=n['LocLayer.GROUND_DECOR'].valueOf()]='GROUND_DECOR',t))({}),BlockAccessFlag:(t=>(t[t.BLOCK_NORTH=n['BlockAccessFlag.BLOCK_NORTH'].valueOf()]='BLOCK_NORTH',t[t.BLOCK_EAST=n['BlockAccessFlag.BLOCK_EAST'].valueOf()]='BLOCK_EAST',t[t.BLOCK_SOUTH=n['BlockAccessFlag.BLOCK_SOUTH'].valueOf()]='BLOCK_SOUTH',t[t.BLOCK_WEST=n['BlockAccessFlag.BLOCK_WEST'].valueOf()]='BLOCK_WEST',t))({})},n);var r;function o(t){if(!t)return null;const e=t+new Uint32Array(i.buffer)[t-4>>>2]>>>1,s=new Uint16Array(i.buffer);let n=t>>>1,a='';for(;e-n>1024;)a+=String.fromCharCode(...s.subarray(n,n+=1024));return a+String.fromCharCode(...s.subarray(n,e))}function c(t,e,s){if(!s)return null;const n=function(t){try{return l.getUint32(t,!0)}catch{return l=new DataView(i.buffer),l.getUint32(t,!0)}}(s-4)>>>e,a=new Array(n);for(let i=0;i<n;++i)a[i]=t(s+(i<<e>>>0));return a}let l=new DataView(i.buffer);function h(t){try{return l.getInt32(t,!0)}catch{return l=new DataView(i.buffer),l.getInt32(t,!0)}}return a}var Ke,Ze,{memory:$e,findPath:Je,findNaivePath:Xe,changeFloor:qe,changeLoc:Qe,changeNpc:ts,changePlayer:es,changeRoof:ss,changeWall:ns,allocateIfAbsent:is,deallocateIfPresent:as,isZoneAllocated:rs,isFlagged:os,canTravel:cs,hasLineOfSight:ls,hasLineOfWalk:hs,lineOfSight:ds,lineOfWalk:ps,reached:us,locShapeLayer:gs,__get:_s,__set:ms,__add:Es,__remove:Os,__rotate:As,__rotateFlags:Ts,__collides:Is,__reachRectangle1:Ns,__reachRectangleN:Ps,__alteredRotation:Ls,__reachRectangle:ys,__reachExclusiveRectangle:Ss,CollisionFlag:vs,LocShape:Cs,LocAngle:ws,CollisionType:Rs,LocLayer:bs,BlockAccessFlag:Us}=await(async t=>je(await(async()=>{try{return await globalThis.WebAssembly.compileStreaming(globalThis.fetch(t))}catch{return globalThis.WebAssembly.compile(await(await import('node:fs/promises')).readFile(t))}})(),{}))(new URL('rsmod-pathfinder.wasm',import.meta.url)),Ds=0,Ms=1,ks=2,xs=3,Bs=4,Fs=5,Hs=6,Gs=7,Ws={zone:t=>t>>3,zoneCenter:t=>Ws.zone(t)-6,zoneOrigin:t=>Ws.zoneCenter(t)<<3,mapsquare:t=>t>>6,local:t=>t-(Ws.zoneCenter(t)<<3),localOrigin:t=>t-(Ws.mapsquare(t)<<6),zoneUpdate:t=>t-(t>>3<<3),face:(t,e,s,n)=>t!=s?t>s?e>n?Fs:e<n?Ds:xs:e>n?Gs:e<n?ks:Bs:e>n?Hs:e<n?Ms:-1,moveX:(t,e)=>t+Ws.deltaX(e),moveZ:(t,e)=>t+Ws.deltaZ(e),distanceTo(t,e){const s=Ws.closest(t,e),n=Ws.closest(e,t);return Math.max(Math.abs(s.x-n.x),Math.abs(s.z-n.z))},closest(t,e){const s=t.x+t.width-1,n=t.z+t.length-1;return{x:e.x<=t.x?t.x:e.x>=s?s:e.x,z:e.z<=t.z?t.z:e.z>=n?n:e.z}},distanceToSW(t,e){const s=Math.abs(t.x-e.x),n=Math.abs(t.z-e.z);return Math.max(s,n)},isWithinDistanceSW(t,e,s){const n=Math.abs(t.x-e.x);return Math.abs(t.z-e.z)<s&&n<s},deltaX(t){switch(t){case Gs:case ks:case Bs:return 1;case Fs:case Ds:case xs:return-1}return 0},deltaZ(t){switch(t){case Ds:case ks:case Ms:return 1;case Fs:case Gs:case Hs:return-1}return 0},unpackCoord:t=>({level:t>>28&3,x:t>>14&16383,z:16383&t}),packCoord:(t,e,s)=>16383&s|(16383&e)<<14|(3&t)<<28,packZoneCoord:(t,e)=>(7&t)<<4|7&e,intersects:(t,e,s,n,i,a,r,o)=>!(i>=t+s||i+r<=t||a>=e+n||a+o<=e),formatString:(t,e,s,n="_")=>t+n+(e>>6)+n+(s>>6)+n+(63&e)+n+(63&s)};(Ze=Ke||={})[Ze.BLOCK=0]='BLOCK',Ze[Ze.DAMAGE=1]='DAMAGE',Ze[Ze.POISON=2]='POISON';var zs,Vs,Ys=Ke;(Vs=zs||={})[Vs.ATTACK=0]='ATTACK',Vs[Vs.DEFENCE=1]='DEFENCE',Vs[Vs.STRENGTH=2]='STRENGTH',Vs[Vs.HITPOINTS=3]='HITPOINTS',Vs[Vs.RANGED=4]='RANGED',Vs[Vs.PRAYER=5]='PRAYER',Vs[Vs.MAGIC=6]='MAGIC',Vs[Vs.COOKING=7]='COOKING',Vs[Vs.WOODCUTTING=8]='WOODCUTTING',Vs[Vs.FLETCHING=9]='FLETCHING',Vs[Vs.FISHING=10]='FISHING',Vs[Vs.FIREMAKING=11]='FIREMAKING',Vs[Vs.CRAFTING=12]='CRAFTING',Vs[Vs.SMITHING=13]='SMITHING',Vs[Vs.MINING=14]='MINING',Vs[Vs.HERBLORE=15]='HERBLORE',Vs[Vs.AGILITY=16]='AGILITY',Vs[Vs.THIEVING=17]='THIEVING',Vs[Vs.STAT18=18]='STAT18',Vs[Vs.STAT19=19]='STAT19',Vs[Vs.RUNECRAFT=20]='RUNECRAFT';var js=zs;function Ks(t,e){return e.validate(t)}class Zs{type;count;name;constructor(t,e,s){this.type=t,this.count=e,this.name=s}validate(t){if(this.count(t))return this.type(t);throw new Error(`An input for a ${this.name} type was not valid to use. Input was ${t}.`)}}class $s{min;max;name;constructor(t,e,s){this.min=t,this.max=e,this.name=s}validate(t){if(t>=this.min&&t<=this.max)return t;throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${t}.`)}}var Js,Xs,qs=new class{validate(t){if(-1!==t)return t;throw Error('An input number was null(-1).')}},Qs=new class{validate(t){if(t.length>0)return t;throw Error('An input string was null(-1).')}},tn=new Zs(ee.get,(t=>t>=0&&t<ee.count),'Loc'),en=new $s(ws.WEST,ws.SOUTH,'LocAngle'),sn=new $s(Cs.WALL_STRAIGHT,Cs.GROUND_DECOR,'LocShape'),nn=new $s(1,2147483647,'Duration'),an=new class extends $s{validate(t){if(t>=this.min&&t<=this.max)return Ws.unpackCoord(t);throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${t}.`)}}(0,2147483647,'Coord'),rn=new Zs(de.get,(t=>t>=0&&t<de.count),'Param'),on=new Zs(he.get,(t=>t>=0&&t<he.count),'Npc'),cn=new $s(le.ATTACK,le.MAGIC,'NpcStat'),ln=new $s(js.ATTACK,js.RUNECRAFT,'PlayerStat'),hn=new $s(0,19,'AIQueue'),dn=new Zs(jt.get,(t=>t>=0&&t<jt.count),'Hunt'),pn=new $s(Yt.NULL,Yt.APNPC5,'NpcMode'),un=new $s(Ys.BLOCK,Ys.POISON,'Hit'),gn=new Zs(Se.get,(t=>t>=0&&t<Se.count),'Spotanim'),_n=new Zs(Ot.get,(t=>t>=0&&t<Ot.count),'Enum'),mn=new Zs(_e.get,(t=>t>=0&&t<_e.count),'Obj'),fn=new $s(1,Ye.STACK_LIMIT,'ObjStack'),En=new Zs($t.get,(t=>t>=0&&t<$t.count),'Inv'),On=new Zs(_t.get,(t=>t>=0&&t<_t.count),'Cat'),An=new Zs(Kt.get,(t=>t>=0&&t<Kt.count),'Idk'),Tn=new $s(Vt.OFF,Vt.LINEOFWALK,'HuntVis'),In=new Zs(fe.get,(t=>t>=0&&t<fe.count),'Seq'),Nn=new Zs(Ae.get,(t=>t>=0&&t<Ae.count),'Varp'),Pn=new Zs(Oe.get,(t=>t>=0&&t<Oe.count),'Varn'),Ln=new Zs(Te.get,(t=>t>=0&&t<Te.count),'Vars'),yn=new Zs(bt.get,(t=>t>=0&&t<bt.count),'Font'),Sn=new Zs(se.get,(t=>t>=0&&t<se.count),'Mesanim'),vn=new Zs(Ee.get,(t=>t>=0&&t<Ee.count),'Struct'),Cn=new Zs(Et.get,(t=>t>=0&&t<Et.count),'Dbrow'),wn=new Zs(ft.get,(t=>t>=0&&t<ft.count),'Dbtable'),Rn=new $s(0,1,'Gender'),bn=new $s(0,7,'SkinColour'),Un=function(t,e){if(t.fp>=50)throw new Error('stack overflow');t.frames[t.fp++]={script:t.script,pc:t.pc,intLocals:t.intLocals,stringLocals:t.stringLocals};const s=Fe.get(e);if(!s)throw new Error(`unable to find proc ${s}`);Mn(t,s)},Dn=function(t,e){const s=Fe.get(e);if(!s)throw new Error(`unable to find label ${e}`);t.debugFrames[t.debugFp++]={script:t.script,pc:t.pc},Mn(t,s),t.fp=0,t.frames=[]},Mn=function(t,e){t.script=e,t.pc=-1,t.intLocals=t.popInts(e.intArgCount),t.stringLocals=t.popStrings(e.stringArgCount)},kn={[xe.PUSH_CONSTANT_INT]:t=>{t.pushInt(t.intOperand)},[xe.PUSH_CONSTANT_STRING]:t=>{t.pushString(t.stringOperand)},[xe.PUSH_VARP]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activePlayer2)throw new Error('No secondary active_player.');if(!e&&!t._activePlayer)throw new Error('No active_player.');const s=Ks(65535&t.intOperand,Nn);s.type===mt.STRING?t.pushString(e?t._activePlayer2.getVar(s.id):t._activePlayer.getVar(s.id)):t.pushInt(e?t._activePlayer2.getVar(s.id):t._activePlayer.getVar(s.id))},[xe.POP_VARP]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activePlayer2)throw new Error('No secondary active_player.');if(!e&&!t._activePlayer)throw new Error('No active_player.');const s=Ks(65535&t.intOperand,Nn);if(!t.pointerGet(Me[e])&&s.protect)throw new Error(`%${s.debugname} requires protected access`);if(s.type===mt.STRING){const n=t.popString();e?t._activePlayer2.setVar(s.id,n):t._activePlayer.setVar(s.id,n)}else{const n=t.popInt();e?t._activePlayer2.setVar(s.id,n):t._activePlayer.setVar(s.id,n)}},[xe.PUSH_VARN]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activeNpc2)throw new Error('No secondary active_npc.');if(!e&&!t._activeNpc)throw new Error('No active_npc.');const s=Ks(65535&t.intOperand,Pn);s.type===mt.STRING?t.pushString(e?t._activeNpc2.getVar(s.id):t._activeNpc.getVar(s.id)):t.pushInt(e?t._activeNpc2.getVar(s.id):t._activeNpc.getVar(s.id))},[xe.POP_VARN]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activeNpc2)throw new Error('No secondary active_npc.');if(!e&&!t._activeNpc)throw new Error('No active_npc.');const s=Ks(65535&t.intOperand,Pn);if(s.type===mt.STRING){const n=t.popInt();e?t._activeNpc2.setVar(s.id,n):t._activeNpc.setVar(s.id,n)}else{const n=t.popInt();e?t._activeNpc2.setVar(s.id,n):t._activeNpc.setVar(s.id,n)}},[xe.PUSH_INT_LOCAL]:t=>{t.pushInt(t.intLocals[t.intOperand])},[xe.POP_INT_LOCAL]:t=>{t.intLocals[t.intOperand]=t.popInt()},[xe.PUSH_STRING_LOCAL]:t=>{t.pushString(t.stringLocals[t.intOperand])},[xe.POP_STRING_LOCAL]:t=>{t.stringLocals[t.intOperand]=t.popString()},[xe.BRANCH]:t=>{t.pc+=t.intOperand},[xe.BRANCH_NOT]:t=>{const e=t.popInt();t.popInt()!==e&&(t.pc+=t.intOperand)},[xe.BRANCH_EQUALS]:t=>{const e=t.popInt();t.popInt()===e&&(t.pc+=t.intOperand)},[xe.BRANCH_LESS_THAN]:t=>{const e=t.popInt();t.popInt()<e&&(t.pc+=t.intOperand)},[xe.BRANCH_GREATER_THAN]:t=>{const e=t.popInt();t.popInt()>e&&(t.pc+=t.intOperand)},[xe.BRANCH_LESS_THAN_OR_EQUALS]:t=>{const e=t.popInt();t.popInt()<=e&&(t.pc+=t.intOperand)},[xe.BRANCH_GREATER_THAN_OR_EQUALS]:t=>{const e=t.popInt();t.popInt()>=e&&(t.pc+=t.intOperand)},[xe.POP_INT_DISCARD]:t=>{t.isp--},[xe.POP_STRING_DISCARD]:t=>{t.ssp--},[xe.RETURN]:t=>{if(0===t.fp)return void(t.execution=ze.FINISHED);const e=t.frames[--t.fp];t.pc=e.pc,t.script=e.script,t.intLocals=e.intLocals,t.stringLocals=e.stringLocals},[xe.JOIN_STRING]:t=>{const e=t.intOperand,s=[];for(let n=0;n<e;n++)s.push(t.popString());t.pushString(s.reverse().join(''))},[xe.GOSUB]:t=>{Un(t,t.popInt())},[xe.GOSUB_WITH_PARAMS]:t=>{Un(t,t.intOperand)},[xe.JUMP]:t=>{Dn(t,t.popInt())},[xe.JUMP_WITH_PARAMS]:t=>{Dn(t,t.intOperand)},[xe.DEFINE_ARRAY]:t=>{throw new Error('unimplemented')},[xe.PUSH_ARRAY_INT]:t=>{throw new Error('unimplemented')},[xe.POP_ARRAY_INT]:t=>{throw new Error('unimplemented')},[xe.SWITCH]:t=>{const e=t.popInt(),s=t.script.switchTables[t.intOperand];if(void 0===s)return;const n=s[e];n&&(t.pc+=n)},[xe.PUSH_VARS]:t=>{const e=Ks(65535&t.intOperand,Ln);e.type===mt.STRING?t.pushString(zl.varsString[e.id]??''):t.pushInt(zl.vars[e.id])},[xe.POP_VARS]:t=>{const e=Ks(65535&t.intOperand,Ln);e.type===mt.STRING?zl.varsString[e.id]=t.popString():zl.vars[e.id]=t.popInt()}},xn={[xe.DB_FIND_WITH_COUNT]:t=>{throw new Error('unimplemented')},[xe.DB_FINDNEXT]:t=>{if(!t.dbTable)throw new Error('No table selected');t.dbRow+1>=t.dbRowQuery.length?t.pushInt(-1):(t.dbRow++,t.pushInt(Ks(t.dbRowQuery[t.dbRow],Cn).id))},[xe.DB_GETFIELD]:t=>{const[e,s,n]=t.popInts(3),i=s>>12&65535,a=s>>4&127,r=Ks(e,Cn),o=Ks(i,wn);let c;c=r.tableId!==i?o.getDefault(a):r.getValue(a,n);const l=o.types[a];for(let e=0;e<c.length;e++)l[e]===mt.STRING?t.pushString(c[e]):t.pushInt(c[e])},[xe.DB_GETFIELDCOUNT]:t=>{const[e,s]=t.popInts(2),n=s>>12&65535,i=s>>4&127,a=Ks(e,Cn),r=Ks(n,wn);a.tableId===n?t.pushInt(a.columnValues[i].length/r.types[i].length):t.pushInt(0)},[xe.DB_LISTALL_WITH_COUNT]:t=>{throw new Error('unimplemented')},[xe.DB_GETROWTABLE]:t=>{t.pushInt(Ks(t.popInt(),Cn).tableId)},[xe.DB_FINDBYINDEX]:t=>{throw new Error('unimplemented')},[xe.DB_FIND_REFINE_WITH_COUNT]:t=>{throw new Error('unimplemented')},[xe.DB_FIND]:t=>{const e=2==t.popInt()?t.popString():t.popInt(),s=t.popInt(),n=s>>12&65535,i=s>>4&127;t.dbTable=Ks(n,wn),t.dbRow=-1,t.dbRowQuery=[];const a=Et.getInTable(n);for(let s=0;s<a.length;s++){const n=a[s];n.columnValues[i].includes(e)&&t.dbRowQuery.push(n.id)}t.pushInt(t.dbRowQuery.length)},[xe.DB_FIND_REFINE]:t=>{const e=2==t.popInt()?t.popString():t.popInt(),s=t.popInt(),n=s>>12&65535,i=s>>4&127,a=[],r=Et.getInTable(n);for(let t=0;t<r.length;t++){const s=r[t];s.columnValues[i].includes(e)&&a.push(s.id)}const o=t.dbRowQuery;t.dbRow=-1,t.dbRowQuery=[];for(let e=0;e<o.length;e++)a.includes(o[e])&&t.dbRowQuery.push(o[e]);t.pushInt(t.dbRowQuery.length)},[xe.DB_LISTALL]:t=>{throw new Error('unimplemented')}};(Xs=Js||={})[Xs.CYCLE=0]='CYCLE',Xs[Xs.WORLD=1]='WORLD',Xs[Xs.CLIENT_IN=2]='CLIENT_IN',Xs[Xs.NPC=3]='NPC',Xs[Xs.PLAYER=4]='PLAYER',Xs[Xs.LOGOUT=5]='LOGOUT',Xs[Xs.LOGIN=6]='LOGIN',Xs[Xs.ZONE=7]='ZONE',Xs[Xs.CLIENT_OUT=8]='CLIENT_OUT',Xs[Xs.CLEANUP=9]='CLEANUP',Xs[Xs.BANDWIDTH_IN=10]='BANDWIDTH_IN',Xs[Xs.BANDWIDTH_OUT=11]='BANDWIDTH_OUT';var Bn,Fn,Hn=Js,Gn={[xe.ERROR]:t=>{throw new Error(t.popString())},[xe.MAP_PRODUCTION]:t=>{t.pushInt(ge.NODE_PRODUCTION?1:0)},[xe.MAP_LASTCLOCK]:t=>{t.pushInt(zl.lastCycleStats[Hn.CYCLE])},[xe.MAP_LASTWORLD]:t=>{t.pushInt(zl.lastCycleStats[Hn.WORLD])},[xe.MAP_LASTCLIENTIN]:t=>{t.pushInt(zl.lastCycleStats[Hn.CLIENT_IN])},[xe.MAP_LASTNPC]:t=>{t.pushInt(zl.lastCycleStats[Hn.NPC])},[xe.MAP_LASTPLAYER]:t=>{t.pushInt(zl.lastCycleStats[Hn.PLAYER])},[xe.MAP_LASTLOGOUT]:t=>{t.pushInt(zl.lastCycleStats[Hn.LOGOUT])},[xe.MAP_LASTLOGIN]:t=>{t.pushInt(zl.lastCycleStats[Hn.LOGIN])},[xe.MAP_LASTZONE]:t=>{t.pushInt(zl.lastCycleStats[Hn.ZONE])},[xe.MAP_LASTCLIENTOUT]:t=>{t.pushInt(zl.lastCycleStats[Hn.CLIENT_OUT])},[xe.MAP_LASTCLEANUP]:t=>{t.pushInt(zl.lastCycleStats[Hn.CLEANUP])},[xe.MAP_LASTBANDWIDTHIN]:t=>{t.pushInt(zl.lastCycleStats[Hn.BANDWIDTH_IN])},[xe.MAP_LASTBANDWIDTHOUT]:t=>{t.pushInt(zl.lastCycleStats[Hn.BANDWIDTH_OUT])}},Wn={[xe.ENUM]:t=>{const[e,s,n,i]=t.popInts(4),a=Ks(n,_n);if(a.inputtype!==e||a.outputtype!==s)throw new Error(`Type validation error: ${a.debugname} key: ${i}. Expected input: ${e} got: ${a.inputtype}. Expected output: ${s} got: ${a.outputtype}`);const r=a.values.get(i);'string'==typeof r?t.pushString(r??a.defaultString):t.pushInt(r??a.defaultInt)},[xe.ENUM_GETOUTPUTCOUNT]:t=>{t.pushInt(Ks(t.popInt(),_n).values.size)}};(Fn=Bn||={})[Fn.FOREVER=0]='FOREVER',Fn[Fn.RESPAWN=1]='RESPAWN',Fn[Fn.DESPAWN=2]='DESPAWN';var zn=Bn;class Vn{level;x;z;width;length;lifecycle;lifecycleTick=-1;lastLifecycleTick=-1;constructor(t,e,s,n,i,a){this.level=t,this.x=e,this.z=s,this.width=n,this.length=i,this.lifecycle=a}updateLifeCycle(t){return this.lifecycleTick===t&&this.lifecycle!==zn.FOREVER}checkLifeCycle(t){return this.lifecycle===zn.FOREVER||(this.lifecycle===zn.RESPAWN?this.lifecycleTick<t:this.lifecycle===zn.DESPAWN&&this.lifecycleTick>t)}setLifeCycle(t){this.lifecycleTick=t,this.lastLifecycleTick=zl.currentTick}}class Yn extends Vn{resetEntity(t){}}class jn extends Yn{type;count;receiverId=-1;reveal=-1;constructor(t,e,s,n,i,a){super(t,e,s,1,1,n),this.type=i,this.count=a}}var Kn,Zn,$n={[xe.INV_ALLSTOCK]:t=>{const e=Ks(t.popInt(),En);t.pushInt(e.allstock?1:0)},[xe.INV_SIZE]:t=>{const e=Ks(t.popInt(),En);t.pushInt(e.size)},[xe.INV_STOCKBASE]:t=>{const[e,s]=t.popInts(2),n=Ks(e,En),i=Ks(s,mn);if(!n.stockobj||!n.stockcount)return void t.pushInt(-1);const a=n.stockobj.indexOf(i.id);t.pushInt(a>=0?n.stockcount[a]:-1)},[xe.INV_ADD]:ve(De,(t=>{const[e,s,n]=t.popInts(3),i=Ks(e,En),a=Ks(s,mn);if(Ks(n,fn),!t.pointerGet(Me[t.intOperand])&&i.protect&&i.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);if(!i.dummyinv&&0!==a.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${a.debugname} -> ${i.debugname}`);const r=t.activePlayer,o=n-r.invAdd(i.id,a.id,n);o>0&&zl.addObj(new jn(r.level,r.x,r.z,zn.DESPAWN,a.id,o),r.pid,200)})),[xe.INV_CHANGESLOT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4);throw new Error('unimplemented')})),[xe.INV_CLEAR]:ve(De,(t=>{const e=Ks(t.popInt(),En);if(!t.pointerGet(Me[t.intOperand])&&e.protect&&e.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${e.debugname}`);t.activePlayer.invClear(e.id)})),[xe.INV_DEL]:ve(De,(t=>{const[e,s,n]=t.popInts(3),i=Ks(e,En),a=Ks(s,mn);if(Ks(n,fn),!t.pointerGet(Me[t.intOperand])&&i.protect&&i.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);t.activePlayer.invDel(i.id,a.id,n)})),[xe.INV_DELSLOT]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En);if(!t.pointerGet(Me[t.intOperand])&&n.protect&&n.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${n.debugname}`);t.activePlayer.invGetSlot(n.id,s)&&t.activePlayer.invDelSlot(n.id,s)})),[xe.INV_DROPITEM]:ve(De,(t=>{const[e,s,n,i,a]=t.popInts(5),r=Ks(e,En),o=Ks(s,an),c=Ks(n,mn);if(Ks(i,fn),Ks(a,nn),!t.pointerGet(Me[t.intOperand])&&r.protect&&r.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const l=t.activePlayer,h=l.invDel(r.id,c.id,i);if(0==h)return;l.playerLog('Dropped item from',r.debugname,c.debugname);const d=new jn(o.level,o.x,o.z,zn.DESPAWN,c.id,h);zl.addObj(d,l.pid,a),t.activeObj=d,t.pointerAdd(Ue[t.intOperand])})),[xe.INV_DROPSLOT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En);Ks(i,nn);const r=Ks(s,an);if(!t.pointerGet(Me[t.intOperand])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const o=t.activePlayer.invGetSlot(a.id,n);if(!o)throw new Error('$slot is empty');const c=t.activePlayer,l=c.invDel(a.id,o.id,o.count,n);if(0===l)return;const h=_e.get(o.id);c.playerLog('Dropped item from',a.debugname,h.debugname);const d=new jn(r.level,r.x,r.z,zn.DESPAWN,o.id,l);zl.addObj(d,c.pid,i),t.activeObj=d,t.pointerAdd(Ue[t.intOperand])})),[xe.INV_FREESPACE]:ve(De,(t=>{const e=Ks(t.popInt(),En);t.pushInt(t.activePlayer.invFreeSpace(e.id))})),[xe.INV_GETNUM]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En);t.pushInt(t.activePlayer.invGetSlot(n.id,s)?.count??0)})),[xe.INV_GETOBJ]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En);t.pushInt(t.activePlayer.invGetSlot(n.id,s)?.id??-1)})),[xe.INV_ITEMSPACE]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(s,mn);if(Ks(n,fn),i<0||i>a.size)throw new Error(`$count is out of range: ${n}`);t.pushInt(0===t.activePlayer.invItemSpace(a.id,r.id,n,i)?1:0)})),[xe.INV_ITEMSPACE2]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(s,mn);Ks(n,fn),t.pushInt(t.activePlayer.invItemSpace(a.id,r.id,n,i))})),[xe.INV_MOVEFROMSLOT]:ve(De,(t=>{const[e,s,n]=t.popInts(3),i=Ks(e,En),a=Ks(s,En);if(!t.pointerGet(Me[t.intOperand])&&i.protect&&i.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);if(!t.pointerGet(Me[t.intOperand])&&a.protect&&i.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const r=t.activePlayer,{overflow:o,fromObj:c}=r.invMoveFromSlot(i.id,a.id,n);o>0&&zl.addObj(new jn(r.level,r.x,r.z,zn.DESPAWN,c,o),r.pid,200)})),[xe.INV_MOVETOSLOT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(s,En);if(!t.pointerGet(Me[t.intOperand])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Me[t.intOperand])&&r.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);t.activePlayer.invMoveToSlot(a.id,r.id,n,i)})),[xe.BOTH_MOVEINV]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En),i=Ks(s,En),a=1==t.intOperand,r=a?t._activePlayer2:t._activePlayer,o=a?t._activePlayer:t._activePlayer2;if(!r||!o)throw new Error('player is null');if(!t.pointerGet(Me[a?1:0])&&n.protect&&n.scope!==$t.SCOPE_SHARED)throw new Error(`$from_inv requires protected access: ${n.debugname}`);if(!t.pointerGet(Me[a?0:1])&&i.protect&&n.scope!==$t.SCOPE_SHARED)throw new Error(`$to_inv requires protected access: ${i.debugname}`);const c=r.getInventory(e),l=o.getInventory(s);if(!c||!l)throw new Error('inv is null');for(let t=0;t<c.capacity;t++){const e=c.get(t);e&&(c.delete(t),l.add(e.id,e.count),r.playerLog('Gave '+_e.get(e.id).name+' x'+e.count+' during trade with '+o.username),o.playerLog('Received '+_e.get(e.id).name+' x'+e.count+' during trade with '+r.username))}})),[xe.INV_MOVEITEM]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(s,En),o=Ks(n,mn);if(Ks(i,fn),!t.pointerGet(Me[t.intOperand])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Me[t.intOperand])&&r.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);if(0==l)return;const h=i-c.invAdd(r.id,o.id,l);h>0&&zl.addObj(new jn(c.level,c.x,c.z,zn.DESPAWN,o.id,h),c.pid,200)})),[xe.INV_MOVEITEM_CERT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(s,En),o=Ks(n,mn);if(Ks(i,fn),!t.pointerGet(Me[t.intOperand])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Me[t.intOperand])&&r.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);if(0==l)return;let h=o.id;-1===o.certtemplate&&o.certlink>=0&&(h=o.certlink);const d=i-c.invAdd(r.id,h,l);d>0&&zl.addObj(new jn(c.level,c.x,c.z,zn.DESPAWN,h,d),c.pid,200)})),[xe.INV_MOVEITEM_UNCERT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(s,En),o=Ks(n,mn);if(Ks(i,fn),!t.pointerGet(Me[t.intOperand])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Me[t.intOperand])&&r.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);0!=l&&(o.certtemplate>=0&&o.certlink>=0?c.invAdd(r.id,o.certlink,l):c.invAdd(r.id,o.id,l))})),[xe.INV_SETSLOT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En),r=Ks(n,mn);if(Ks(i,fn),!t.pointerGet(Me[t.intOperand])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!a.dummyinv&&0!==r.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${r.debugname} -> ${a.debugname}`);t.activePlayer.invSet(a.id,r.id,i,s)})),[xe.INV_TOTAL]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En);-1!==s?t.pushInt(t.activePlayer.invTotal(n.id,s)):t.pushInt(0)})),[xe.INV_TOTALCAT]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En),i=Ks(s,On);t.pushInt(t.activePlayer.invTotalCat(n.id,i.id))})),[xe.INV_TRANSMIT]:ve(De,(t=>{const[e,s]=t.popInts(2),n=Ks(e,En);Ks(s,qs),t.activePlayer.invListenOnCom(n.id,s,t.activePlayer.uid)})),[xe.INVOTHER_TRANSMIT]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,qs);const i=Ks(s,En);Ks(n,qs),t.activePlayer.invListenOnCom(i.id,n,e)})),[xe.INV_STOPTRANSMIT]:ve(De,(t=>{const e=Ks(t.popInt(),qs);t.activePlayer.invStopListenOnCom(e)})),[xe.BOTH_DROPSLOT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,En);Ks(i,nn);const r=Ks(s,an),o=1==t.intOperand,c=o?t._activePlayer2:t._activePlayer,l=o?t._activePlayer:t._activePlayer2;if(!c||!l)throw new Error('player is null');if(!t.pointerGet(Me[o?1:0])&&a.protect&&a.scope!==$t.SCOPE_SHARED)throw new Error(`inv requires protected access: ${a.debugname}`);const h=c.invGetSlot(a.id,n);if(!h)throw new Error('$slot is empty');const d=c.invDel(a.id,h.id,h.count,n);if(0===d)return;const p=_e.get(h.id);c.playerLog('Dropped item from',a.debugname,p.debugname),p.tradeable&&zl.addObj(new jn(r.level,r.x,r.z,zn.DESPAWN,h.id,d),l.pid,i)})),[xe.INV_DROPALL]:ve(De,(t=>{const[e,s,n]=t.popInts(3),i=Ks(e,En);Ks(n,nn);const a=Ks(s,an);if(!t.pointerGet(Me[t.intOperand])&&i.protect&&i.scope!==$t.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);const r=t.activePlayer.getInventory(i.id);if(r)for(let t=0;t<r.capacity;t++){const e=r.get(t);if(!e)continue;r.delete(t);_e.get(e.id).tradeable&&zl.addObj(new jn(a.level,a.x,a.z,zn.DESPAWN,e.id,e.count),-1,n)}})),[xe.INV_TOTALPARAM]:ve(De,(t=>{const[e,s]=t.popInts(2);t.pushInt(t.activePlayer.invTotalParam(e,s))})),[xe.INV_TOTALPARAM_STACK]:ve(De,(t=>{const[e,s]=t.popInts(2);t.pushInt(t.activePlayer.invTotalParamStack(e,s))}))};(Zn=Kn||={})[Zn.ZONE=0]='ZONE',Zn[Zn.DISTANCE=1]='DISTANCE';var Jn=Kn;class Xn{iterator;tick;constructor(t){this.iterator=this.generator(),this.tick=t}[Symbol.iterator](){return this.iterator}next(){return this.iterator.next()}}class qn extends Xn{x;z;level;minX;maxX;minZ;maxZ;distance;checkVis;checkType;checkCategory;type;constructor(t,e,s,n,i,a,r,o,c){super(t);const l=Ws.zone(s),h=Ws.zone(n),d=1+i/8|0;this.x=s,this.z=n,this.level=e,this.maxX=l+d,this.minX=l-d,this.maxZ=h+d,this.minZ=h-d,this.distance=i,this.checkVis=a,this.checkType=r,this.checkCategory=o,this.type=c}*generator(){for(let t=this.maxX;t>=this.minX;t--){const e=t<<3;for(let t=this.maxZ;t>=this.minZ;t--){const s=t<<3;if(this.type===Bt.PLAYER)for(const t of zl.getZone(e,s,this.level).getAllPlayersSafe()){if(zl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');Ws.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==Vt.LINEOFSIGHT||ls(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==Vt.LINEOFWALK||hs(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t)}else if(this.type===Bt.NPC)for(const t of zl.getZone(e,s,this.level).getAllNpcsSafe()){if(zl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=he.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||e.op&&e.op[1]&&(Ws.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==Vt.LINEOFSIGHT||ls(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==Vt.LINEOFWALK||hs(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}else if(this.type===Bt.OBJ)for(const t of zl.getZone(e,s,this.level).getAllObjsSafe()){if(zl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=_e.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||(Ws.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==Vt.LINEOFSIGHT||ls(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==Vt.LINEOFWALK||hs(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}else if(this.type===Bt.SCENERY)for(const t of zl.getZone(e,s,this.level).getAllLocsSafe()){if(zl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=ee.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||(Ws.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==Vt.LINEOFSIGHT||ls(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==Vt.LINEOFWALK||hs(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}}}}}class Qn extends Xn{level;x;z;minX;maxX;minZ;maxZ;distance;checkVis;type;constructor(t,e,s,n,i,a,r){super(t);const o=Ws.zone(s),c=Ws.zone(n),l=1+i/8|0;this.x=s,this.z=n,this.level=e,this.maxX=o+l,this.minX=o-l,this.maxZ=c+l,this.minZ=c-l,this.distance=i,this.checkVis=a,this.type=r}*generator(){if(this.type===Jn.ZONE)for(const t of zl.getZone(this.x,this.z,this.level).getAllNpcsSafe()){if(zl.currentTick>this.tick)throw new Error('[NpcIterator] tried to use an old iterator. Create a new iterator instead.');yield t}else if(this.type===Jn.DISTANCE)for(let t=this.maxX;t>=this.minX;t--){const e=t<<3;for(let t=this.maxZ;t>=this.minZ;t--){const s=t<<3;for(const t of zl.getZone(e,s,this.level).getAllNpcsSafe()){if(zl.currentTick>this.tick)throw new Error('[NpcIterator] tried to use an old iterator. Create a new iterator instead.');Ws.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==Vt.LINEOFSIGHT||ls(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==Vt.LINEOFWALK||hs(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t)}}}}}class ti extends Xn{level;x;z;constructor(t,e,s,n){super(t),this.level=e,this.x=s,this.z=n}*generator(){for(const t of zl.getZone(this.x,this.z,this.level).getAllLocsSafe()){if(zl.currentTick>this.tick)throw new Error('[LocIterator] tried to use an old iterator. Create a new iterator instead.');yield t}}}class ei extends Yn{info;constructor(t,e,s,n,i,a,r,o,c){super(t,e,s,n,i,a),this.info=16383&r|(31&o)<<14|(3&c)<<19}get type(){return 16383&this.info}get shape(){return this.info>>14&31}get angle(){return this.info>>19&3}}var si,ni,ii={[xe.LOC_ADD]:t=>{const[e,s,n,i,a]=t.popInts(5),r=Ks(e,an),o=Ks(s,tn),c=Ks(n,en),l=Ks(i,sn);Ks(a,nn);const h=new ei(r.level,r.x,r.z,o.width,o.length,zn.DESPAWN,o.id,l,c),d=zl.getZone(r.x,r.z,r.level).getLocsUnsafe(Ws.packZoneCoord(r.x,r.z));for(const t of d)if(t!==h&&t.angle===c&&t.shape===l){zl.removeLoc(t,a);break}zl.addLoc(h,a),t.activeLoc=h,t.pointerAdd(be[t.intOperand])},[xe.LOC_ANGLE]:ve(be,(t=>{t.pushInt(Ks(t.activeLoc.angle,en))})),[xe.LOC_ANIM]:ve(be,(t=>{const e=Ks(t.popInt(),In);zl.animLoc(t.activeLoc,e.id)})),[xe.LOC_CATEGORY]:ve(be,(t=>{t.pushInt(Ks(t.activeLoc.type,tn).category)})),[xe.LOC_CHANGE]:ve(be,(t=>{const[e,s]=t.popInts(2),n=Ks(e,tn);Ks(s,nn),zl.removeLoc(t.activeLoc,s);const{level:i,x:a,z:r,angle:o,shape:c}=t.activeLoc,l=new ei(i,a,r,n.width,n.length,zn.DESPAWN,n.id,c,o),h=zl.getZone(a,r,i).getLocsUnsafe(Ws.packZoneCoord(a,r));for(const t of h)if(t!==l&&t.angle===o&&t.shape===c){zl.removeLoc(t,s);break}zl.addLoc(l,s),t.activeLoc=l,t.pointerAdd(be[t.intOperand])})),[xe.LOC_COORD]:ve(be,(t=>{const e=t.activeLoc;t.pushInt(Ws.packCoord(e.level,e.x,e.z))})),[xe.LOC_DEL]:ve(be,(t=>{const e=Ks(t.popInt(),nn),{level:s,x:n,z:i,angle:a,shape:r}=t.activeLoc,o=zl.getZone(n,i,s).getLocsUnsafe(Ws.packZoneCoord(n,i));for(const s of o)if(s!==t.activeLoc&&s.angle===a&&s.shape===r){zl.removeLoc(s,e);break}zl.removeLoc(t.activeLoc,e)})),[xe.LOC_FIND]:t=>{const[e,s]=t.popInts(2),n=Ks(s,tn),i=Ks(e,an),a=zl.getLoc(i.x,i.z,i.level,n.id);a?(t.activeLoc=a,t.pointerAdd(be[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.LOC_FINDALLZONE]:t=>{const e=Ks(t.popInt(),an);t.locIterator=new ti(zl.currentTick,e.level,e.x,e.z),t._activeLoc&&(t._activeLoc2=t._activeLoc,t.pointerAdd(ke.ActiveLoc2))},[xe.LOC_FINDNEXT]:t=>{const e=t.locIterator?.next();e&&!e.done?(t.activeLoc=e.value,t.pointerAdd(be[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.LOC_PARAM]:ve(be,(t=>{const e=Ks(t.popInt(),rn),s=Ks(t.activeLoc.type,tn);e.isString()?t.pushString(qt(e.id,s,e.defaultString)):t.pushInt(Qt(e.id,s,e.defaultInt))})),[xe.LOC_TYPE]:ve(be,(t=>{t.pushInt(Ks(t.activeLoc.type,tn).id)})),[xe.LOC_NAME]:ve(be,(t=>{t.pushString(Ks(t.activeLoc.type,tn).name??'null')})),[xe.LOC_SHAPE]:ve(be,(t=>{t.pushInt(Ks(t.activeLoc.shape,sn))}))},ai=ii,ri={[xe.LC_NAME]:t=>{const e=Ks(t.popInt(),tn);t.pushString(e.name??e.debugname??'null')},[xe.LC_PARAM]:t=>{const[e,s]=t.popInts(2),n=Ks(e,tn),i=Ks(s,rn);i.isString()?t.pushString(qt(i.id,n,i.defaultString)):t.pushInt(Qt(i.id,n,i.defaultInt))},[xe.LC_CATEGORY]:t=>{t.pushInt(Ks(t.popInt(),tn).category)},[xe.LC_DESC]:t=>{t.pushString(Ks(t.popInt(),tn).desc??'null')},[xe.LC_DEBUGNAME]:t=>{t.pushString(Ks(t.popInt(),tn).debugname??'null')},[xe.LC_WIDTH]:t=>{t.pushInt(Ks(t.popInt(),tn).width)},[xe.LC_LENGTH]:t=>{t.pushInt(Ks(t.popInt(),tn).length)}};(ni=si||={})[ni.PROC=0]='PROC',ni[ni.LABEL=1]='LABEL',ni[ni.DEBUGPROC=2]='DEBUGPROC',ni[ni.APNPC1=3]='APNPC1',ni[ni.APNPC2=4]='APNPC2',ni[ni.APNPC3=5]='APNPC3',ni[ni.APNPC4=6]='APNPC4',ni[ni.APNPC5=7]='APNPC5',ni[ni.APNPCU=8]='APNPCU',ni[ni.APNPCT=9]='APNPCT',ni[ni.OPNPC1=10]='OPNPC1',ni[ni.OPNPC2=11]='OPNPC2',ni[ni.OPNPC3=12]='OPNPC3',ni[ni.OPNPC4=13]='OPNPC4',ni[ni.OPNPC5=14]='OPNPC5',ni[ni.OPNPCU=15]='OPNPCU',ni[ni.OPNPCT=16]='OPNPCT',ni[ni.AI_APNPC1=17]='AI_APNPC1',ni[ni.AI_APNPC2=18]='AI_APNPC2',ni[ni.AI_APNPC3=19]='AI_APNPC3',ni[ni.AI_APNPC4=20]='AI_APNPC4',ni[ni.AI_APNPC5=21]='AI_APNPC5',ni[ni.AI_OPNPC1=24]='AI_OPNPC1',ni[ni.AI_OPNPC2=25]='AI_OPNPC2',ni[ni.AI_OPNPC3=26]='AI_OPNPC3',ni[ni.AI_OPNPC4=27]='AI_OPNPC4',ni[ni.AI_OPNPC5=28]='AI_OPNPC5',ni[ni.APOBJ1=31]='APOBJ1',ni[ni.APOBJ2=32]='APOBJ2',ni[ni.APOBJ3=33]='APOBJ3',ni[ni.APOBJ4=34]='APOBJ4',ni[ni.APOBJ5=35]='APOBJ5',ni[ni.APOBJU=36]='APOBJU',ni[ni.APOBJT=37]='APOBJT',ni[ni.OPOBJ1=38]='OPOBJ1',ni[ni.OPOBJ2=39]='OPOBJ2',ni[ni.OPOBJ3=40]='OPOBJ3',ni[ni.OPOBJ4=41]='OPOBJ4',ni[ni.OPOBJ5=42]='OPOBJ5',ni[ni.OPOBJU=43]='OPOBJU',ni[ni.OPOBJT=44]='OPOBJT',ni[ni.AI_APOBJ1=45]='AI_APOBJ1',ni[ni.AI_APOBJ2=46]='AI_APOBJ2',ni[ni.AI_APOBJ3=47]='AI_APOBJ3',ni[ni.AI_APOBJ4=48]='AI_APOBJ4',ni[ni.AI_APOBJ5=49]='AI_APOBJ5',ni[ni.AI_OPOBJ1=52]='AI_OPOBJ1',ni[ni.AI_OPOBJ2=53]='AI_OPOBJ2',ni[ni.AI_OPOBJ3=54]='AI_OPOBJ3',ni[ni.AI_OPOBJ4=55]='AI_OPOBJ4',ni[ni.AI_OPOBJ5=56]='AI_OPOBJ5',ni[ni.APLOC1=59]='APLOC1',ni[ni.APLOC2=60]='APLOC2',ni[ni.APLOC3=61]='APLOC3',ni[ni.APLOC4=62]='APLOC4',ni[ni.APLOC5=63]='APLOC5',ni[ni.APLOCU=64]='APLOCU',ni[ni.APLOCT=65]='APLOCT',ni[ni.OPLOC1=66]='OPLOC1',ni[ni.OPLOC2=67]='OPLOC2',ni[ni.OPLOC3=68]='OPLOC3',ni[ni.OPLOC4=69]='OPLOC4',ni[ni.OPLOC5=70]='OPLOC5',ni[ni.OPLOCU=71]='OPLOCU',ni[ni.OPLOCT=72]='OPLOCT',ni[ni.AI_APLOC1=73]='AI_APLOC1',ni[ni.AI_APLOC2=74]='AI_APLOC2',ni[ni.AI_APLOC3=75]='AI_APLOC3',ni[ni.AI_APLOC4=76]='AI_APLOC4',ni[ni.AI_APLOC5=77]='AI_APLOC5',ni[ni.AI_OPLOC1=80]='AI_OPLOC1',ni[ni.AI_OPLOC2=81]='AI_OPLOC2',ni[ni.AI_OPLOC3=82]='AI_OPLOC3',ni[ni.AI_OPLOC4=83]='AI_OPLOC4',ni[ni.AI_OPLOC5=84]='AI_OPLOC5',ni[ni.APPLAYER1=87]='APPLAYER1',ni[ni.APPLAYER2=88]='APPLAYER2',ni[ni.APPLAYER3=89]='APPLAYER3',ni[ni.APPLAYER4=90]='APPLAYER4',ni[ni.APPLAYER5=91]='APPLAYER5',ni[ni.APPLAYERU=92]='APPLAYERU',ni[ni.APPLAYERT=93]='APPLAYERT',ni[ni.OPPLAYER1=94]='OPPLAYER1',ni[ni.OPPLAYER2=95]='OPPLAYER2',ni[ni.OPPLAYER3=96]='OPPLAYER3',ni[ni.OPPLAYER4=97]='OPPLAYER4',ni[ni.OPPLAYER5=98]='OPPLAYER5',ni[ni.OPPLAYERU=99]='OPPLAYERU',ni[ni.OPPLAYERT=100]='OPPLAYERT',ni[ni.AI_APPLAYER1=101]='AI_APPLAYER1',ni[ni.AI_APPLAYER2=102]='AI_APPLAYER2',ni[ni.AI_APPLAYER3=103]='AI_APPLAYER3',ni[ni.AI_APPLAYER4=104]='AI_APPLAYER4',ni[ni.AI_APPLAYER5=105]='AI_APPLAYER5',ni[ni.AI_OPPLAYER1=108]='AI_OPPLAYER1',ni[ni.AI_OPPLAYER2=109]='AI_OPPLAYER2',ni[ni.AI_OPPLAYER3=110]='AI_OPPLAYER3',ni[ni.AI_OPPLAYER4=111]='AI_OPPLAYER4',ni[ni.AI_OPPLAYER5=112]='AI_OPPLAYER5',ni[ni.QUEUE=116]='QUEUE',ni[ni.AI_QUEUE1=117]='AI_QUEUE1',ni[ni.AI_QUEUE2=118]='AI_QUEUE2',ni[ni.AI_QUEUE3=119]='AI_QUEUE3',ni[ni.AI_QUEUE4=120]='AI_QUEUE4',ni[ni.AI_QUEUE5=121]='AI_QUEUE5',ni[ni.AI_QUEUE6=122]='AI_QUEUE6',ni[ni.AI_QUEUE7=123]='AI_QUEUE7',ni[ni.AI_QUEUE8=124]='AI_QUEUE8',ni[ni.AI_QUEUE9=125]='AI_QUEUE9',ni[ni.AI_QUEUE10=126]='AI_QUEUE10',ni[ni.AI_QUEUE11=127]='AI_QUEUE11',ni[ni.AI_QUEUE12=128]='AI_QUEUE12',ni[ni.AI_QUEUE13=129]='AI_QUEUE13',ni[ni.AI_QUEUE14=130]='AI_QUEUE14',ni[ni.AI_QUEUE15=131]='AI_QUEUE15',ni[ni.AI_QUEUE16=132]='AI_QUEUE16',ni[ni.AI_QUEUE17=133]='AI_QUEUE17',ni[ni.AI_QUEUE18=134]='AI_QUEUE18',ni[ni.AI_QUEUE19=135]='AI_QUEUE19',ni[ni.AI_QUEUE20=136]='AI_QUEUE20',ni[ni.SOFTTIMER=137]='SOFTTIMER',ni[ni.TIMER=138]='TIMER',ni[ni.AI_TIMER=139]='AI_TIMER',ni[ni.OPHELD1=140]='OPHELD1',ni[ni.OPHELD2=141]='OPHELD2',ni[ni.OPHELD3=142]='OPHELD3',ni[ni.OPHELD4=143]='OPHELD4',ni[ni.OPHELD5=144]='OPHELD5',ni[ni.OPHELDU=145]='OPHELDU',ni[ni.OPHELDT=146]='OPHELDT',ni[ni.IF_BUTTON=147]='IF_BUTTON',ni[ni.INV_BUTTON1=148]='INV_BUTTON1',ni[ni.INV_BUTTON2=149]='INV_BUTTON2',ni[ni.INV_BUTTON3=150]='INV_BUTTON3',ni[ni.INV_BUTTON4=151]='INV_BUTTON4',ni[ni.INV_BUTTON5=152]='INV_BUTTON5',ni[ni.INV_BUTTOND=153]='INV_BUTTOND',ni[ni.IF_CLOSE=154]='IF_CLOSE',ni[ni.LOGIN=155]='LOGIN',ni[ni.LOGOUT=156]='LOGOUT',ni[ni.TUTORIAL_CLICKSIDE=157]='TUTORIAL_CLICKSIDE',ni[ni.MOVE=158]='MOVE',ni[ni.WALKTRIGGER=159]='WALKTRIGGER',ni[ni.AI_WALKTRIGGER=160]='AI_WALKTRIGGER',ni[ni.LEVELUP=161]='LEVELUP',(t=>{t.toString=function(e){return t[e].toLowerCase()}})(si||={});var oi,ci,li=si;(ci=oi||={})[ci.SCRIPT=0]='SCRIPT',ci[ci.ENGINE=1]='ENGINE';var hi=oi,di={[xe.NPC_FINDUID]:t=>{const e=t.popInt(),s=65535&e,n=e>>16&65535,i=zl.getNpc(s);i&&i.type===n?(t.activeNpc=i,t.pointerAdd(Re[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.NPC_ADD]:t=>{const[e,s,n]=t.popInts(3),i=Ks(e,an),a=Ks(s,on);Ks(n,nn);const r=new bl(i.level,i.x,i.z,a.size,a.size,zn.DESPAWN,zl.getNextNid(),a.id,a.moverestrict,a.blockwalk);zl.addNpc(r,n),t.activeNpc=r,t.pointerAdd(Re[t.intOperand])},[xe.NPC_ANIM]:ve(Re,(t=>{const e=Ks(t.popInt(),qs),s=t.popInt();t.activeNpc.playAnimation(s,e)})),[xe.NPC_BASESTAT]:ve(Re,(t=>{const e=Ks(t.popInt(),cn);t.pushInt(t.activeNpc.baseLevels[e])})),[xe.NPC_CATEGORY]:ve(Re,(t=>{t.pushInt(Ks(t.activeNpc.type,on).category)})),[xe.NPC_COORD]:ve(Re,(t=>{const e=t.activeNpc;t.pushInt(Ws.packCoord(e.level,e.x,e.z))})),[xe.NPC_DEL]:ve(Re,(t=>{zl.removeNpc(t.activeNpc,Ks(t.activeNpc.type,on).respawnrate)})),[xe.NPC_DELAY]:ve(Re,(t=>{t.activeNpc.delay=t.popInt()+1,t.execution=ze.NPC_SUSPENDED})),[xe.NPC_FACESQUARE]:ve(Re,(t=>{const e=Ks(t.popInt(),an);t.activeNpc.faceSquare(e.x,e.z)})),[xe.NPC_FINDEXACT]:t=>{const[e,s]=t.popInts(2),n=Ks(e,an),i=Ks(s,on);t.npcIterator=new Qn(zl.currentTick,n.level,n.x,n.z,0,0,Jn.ZONE);for(const e of t.npcIterator)if(e.type===i.id&&e.x===n.x&&e.level===n.level&&e.z===n.z)return t.activeNpc=e,t.pointerAdd(Re[t.intOperand]),void t.pushInt(1);t.pushInt(0)},[xe.NPC_FINDHERO]:ve(Re,(t=>{const e=t.activeNpc.findHero();if(-1===e)return void t.pushInt(0);const s=zl.getPlayerByUid(e);s?(t.activePlayer=s,t.pointerAdd(ke.ActivePlayer),t.pushInt(1)):t.pushInt(0)})),[xe.NPC_PARAM]:ve(Re,(t=>{const e=Ks(t.popInt(),rn),s=Ks(t.activeNpc.type,on);e.isString()?t.pushString(qt(e.id,s,e.defaultString)):t.pushInt(Qt(e.id,s,e.defaultInt))})),[xe.NPC_QUEUE]:ve(Re,(t=>{const e=Ks(t.popInt(),qs),s=t.popInt(),n=Ks(t.popInt(),hn),i=Ks(t.activeNpc.type,on),a=Fe.getByTrigger(li.AI_QUEUE1+n-1,i.id,i.category);a&&t.activeNpc.enqueueScript(a,e,s)})),[xe.NPC_RANGE]:ve(Re,(t=>{const e=Ks(t.popInt(),an),s=t.activeNpc;e.level!==s.level?t.pushInt(-1):t.pushInt(Ws.distanceTo(s,{x:e.x,z:e.z,width:1,length:1}))})),[xe.NPC_SAY]:ve(Re,(t=>{t.activeNpc.say(t.popString())})),[xe.NPC_SETHUNT]:ve(Re,(t=>{t.activeNpc.huntrange=Ks(t.popInt(),qs)})),[xe.NPC_SETHUNTMODE]:ve(Re,(t=>{t.activeNpc.huntMode=Ks(t.popInt(),dn).id})),[xe.NPC_SETMODE]:ve(Re,(t=>{const e=Ks(t.popInt(),pn);if(t.activeNpc.clearWaypoints(),e===Yt.NULL||e===Yt.NONE||e===Yt.WANDER||e===Yt.PATROL)return t.activeNpc.clearInteraction(),void(t.activeNpc.targetOp=e);let s;t.activeNpc.targetOp=e,s=e>=Yt.OPNPC1?t._activeNpc2:e>=Yt.OPOBJ1?t._activeObj:e>=Yt.OPLOC1?t._activeLoc:t._activePlayer,s?s instanceof bl||s instanceof jn||s instanceof ei?t.activeNpc.setInteraction(hi.SCRIPT,s,e,{type:s.type,com:-1}):t.activeNpc.setInteraction(hi.SCRIPT,s,e):t.activeNpc.noMode()})),[xe.NPC_STAT]:ve(Re,(t=>{const e=Ks(t.popInt(),cn);t.pushInt(t.activeNpc.levels[e])})),[xe.NPC_STATHEAL]:ve(Re,(t=>{const[e,s,n]=t.popInts(3);Ks(e,cn),Ks(s,qs),Ks(n,qs);const i=t.activeNpc,a=i.baseLevels[e],r=i.levels[e],o=r+(s+r*n/100);i.levels[e]=Math.min(o,a),0===e&&i.levels[e]===i.baseLevels[e]&&i.resetHeroPoints()})),[xe.NPC_TYPE]:ve(Re,(t=>{t.pushInt(Ks(t.activeNpc.type,on).id)})),[xe.NPC_DAMAGE]:ve(Re,(t=>{const e=Ks(t.popInt(),qs),s=Ks(t.popInt(),un);t.activeNpc.applyDamage(e,s)})),[xe.NPC_NAME]:ve(Re,(t=>{t.pushString(Ks(t.activeNpc.type,on).name??'null')})),[xe.NPC_UID]:ve(Re,(t=>{t.pushInt(t.activeNpc.uid)})),[xe.NPC_SETTIMER]:ve(Re,(t=>{t.activeNpc.setTimer(Ks(t.popInt(),qs))})),[xe.SPOTANIM_NPC]:ve(Re,(t=>{const e=Ks(t.popInt(),qs),s=Ks(t.popInt(),qs),n=Ks(t.popInt(),gn);t.activeNpc.spotanim(n.id,s,e)})),[xe.NPC_FIND]:t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,an),r=Ks(s,on);Ks(n,qs);const o=Ks(i,Tn);let c,l=n;const h=new Qn(zl.currentTick,a.level,a.x,a.z,n,o,Jn.DISTANCE);for(const t of h)if(t&&t.type===r.id){const e=Ws.distanceToSW(a,t);e<=l&&(c=t,l=e)}c?(t.activeNpc=c,t.pointerAdd(Re[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.NPC_FINDALLANY]:t=>{const[e,s,n]=t.popInts(3),i=Ks(e,an);Ks(s,qs);const a=Ks(n,Tn);t.npcIterator=new Qn(zl.currentTick,i.level,i.x,i.z,s,a,Jn.DISTANCE),t._activeNpc&&(t._activeNpc2=t._activeNpc,t.pointerAdd(ke.ActiveNpc2))},[xe.NPC_FINDALLZONE]:t=>{const e=Ks(t.popInt(),an);t.npcIterator=new Qn(zl.currentTick,e.level,e.x,e.z,0,0,Jn.ZONE),t._activeNpc&&(t._activeNpc2=t._activeNpc,t.pointerAdd(ke.ActiveNpc2))},[xe.NPC_FINDNEXT]:t=>{const e=t.npcIterator?.next();e&&!e.done?(t.activeNpc=e.value,t.pointerAdd(Re[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.NPC_TELE]:ve(Re,(t=>{const e=Ks(t.popInt(),an);t.activeNpc.teleport(e.x,e.z,e.level)})),[xe.NPC_WALK]:ve(Re,(t=>{const e=Ks(t.popInt(),an);t.activeNpc.queueWaypoint(e.x,e.z)})),[xe.NPC_CHANGETYPE]:ve(Re,(t=>{t.activeNpc.changeType(Ks(t.popInt(),on).id)})),[xe.NPC_GETMODE]:ve(Re,(t=>{t.pushInt(t.activeNpc.targetOp)})),[xe.NPC_HEROPOINTS]:ve([ke.ActivePlayer,...Re],(t=>{t.activeNpc.addHero(t.activePlayer.uid,Ks(t.popInt(),qs))})),[xe.NPC_WALKTRIGGER]:ve(Re,(t=>{const[e,s]=t.popInts(2);Ks(e,hn),t.activeNpc.walktrigger=e-1,t.activeNpc.walktriggerArg=s})),[xe.NPC_STATADD]:ve(Re,(t=>{const[e,s,n]=t.popInts(3);Ks(e,cn),Ks(s,qs),Ks(n,qs);const i=t.activeNpc,a=i.levels[e],r=a+(s+a*n/100);i.levels[e]=Math.min(r,255),0===e&&i.levels[e]>=i.baseLevels[e]&&i.resetHeroPoints()})),[xe.NPC_STATSUB]:ve(Re,(t=>{const[e,s,n]=t.popInts(3);Ks(e,cn),Ks(s,qs),Ks(n,qs);const i=t.activeNpc,a=i.levels[e],r=a-(s+a*n/100);i.levels[e]=Math.max(r,0)})),[xe.NPC_ATTACKRANGE]:ve(Re,(t=>{t.pushInt(Ks(t.activeNpc.type,on).attackrange)}))},pi={[xe.NC_NAME]:t=>{const e=Ks(t.popInt(),on);t.pushString(e.name??e.debugname??'null')},[xe.NC_PARAM]:t=>{const[e,s]=t.popInts(2),n=Ks(e,on),i=Ks(s,rn);i.isString()?t.pushString(qt(s,n,i.defaultString)):t.pushInt(Qt(s,n,i.defaultInt))},[xe.NC_CATEGORY]:t=>{t.pushInt(Ks(t.popInt(),on).category)},[xe.NC_DESC]:t=>{t.pushString(Ks(t.popInt(),on).desc??'null')},[xe.NC_DEBUGNAME]:t=>{t.pushString(Ks(t.popInt(),on).debugname??'null')},[xe.NC_OP]:t=>{const[e,s]=t.popInts(2),n=Ks(e,on);Ks(s,qs),n.op?t.pushString(n.op[s-1]??''):t.pushString('')}};class ui{static _sin=new Int32Array(16384);static _cos=new Int32Array(16384);static{const t=.0003834951969714103;for(let e=0;e<16384;e++)this._sin[e]=16384*Math.sin(e*t)|0,this._cos[e]=16384*Math.cos(e*t)|0}static radians(t){return(16383&t)/16384*6.283185307179586}static atan2(t,e){return 16383&Math.round(2607.5945876176133*Math.atan2(t,e))}static sin(t){return this._sin[16383&t]}static cos(t){return this._cos[16383&t]}}var gi,_i,mi={[xe.ADD]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s+e)},[xe.SUB]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s-e)},[xe.MULTIPLY]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s*e)},[xe.DIVIDE]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s/e)},[xe.RANDOM]:t=>{const e=t.popInt();t.pushInt(Math.random()*e)},[xe.RANDOMINC]:t=>{const e=t.popInt();t.pushInt(Math.random()*(e+1))},[xe.INTERPOLATE]:t=>{const[e,s,n,i,a]=t.popInts(5),r=Math.floor((s-e)/(i-n))*(a-n)+e;t.pushInt(r)},[xe.ADDPERCENT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e*s/100+e|0)},[xe.SETBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e|1<<s)},[xe.CLEARBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e&~(1<<s))},[xe.TESTBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e&1<<s?1:0)},[xe.MODULO]:t=>{const[e,s]=t.popInts(2);t.pushInt(e%s)},[xe.POW]:t=>{const[e,s]=t.popInts(2);t.pushInt(Math.pow(e,s))},[xe.INVPOW]:t=>{const[e,s]=t.popInts(2);if(0===e||0===s)t.pushInt(0);else switch(s){case 1:return void t.pushInt(e);case 2:return void t.pushInt(Math.sqrt(e));case 3:return void t.pushInt(Math.cbrt(e));case 4:return void t.pushInt(Math.sqrt(Math.sqrt(e)));default:return void t.pushInt(Math.pow(e,1/s))}},[xe.AND]:t=>{const[e,s]=t.popInts(2);t.pushInt(e&s)},[xe.OR]:t=>{const[e,s]=t.popInts(2);t.pushInt(e|s)},[xe.MIN]:t=>{const[e,s]=t.popInts(2);t.pushInt(Math.min(e,s))},[xe.MAX]:t=>{const[e,s]=t.popInts(2);t.pushInt(Math.max(e,s))},[xe.SCALE]:t=>{const[e,s,n]=t.popInts(3);t.pushInt(e*n/s)},[xe.BITCOUNT]:t=>{var e;t.pushInt((e=t.popInt(),16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24))},[xe.TOGGLEBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e^1<<s)},[xe.SETBIT_RANGE]:t=>{const[e,s,n]=t.popInts(3);t.pushInt(function(t,e,s){return t|We[s-e+1]<<e}(e,s,n))},[xe.CLEARBIT_RANGE]:t=>{const[e,s,n]=t.popInts(3);t.pushInt(Ge(e,s,n))},[xe.GETBIT_RANGE]:t=>{const[e,s,n]=t.popInts(3),i=31-n;t.pushInt(e<<i>>>s+i)},[xe.SETBIT_RANGE_TOINT]:t=>{const[e,s,n,i]=t.popInts(4),a=Ge(e,n,i),r=We[i-n+1];let o=s;s>r&&(o=r),t.pushInt(a|o<<n)},[xe.SIN_DEG]:t=>{t.pushInt(ui.sin(t.popInt()))},[xe.COS_DEG]:t=>{t.pushInt(ui.cos(t.popInt()))},[xe.ATAN2_DEG]:t=>{t.pushInt(ui.atan2(t.popInt(),t.popInt()))},[xe.ABS]:t=>{t.pushInt(Math.abs(t.popInt()))}},fi=mi,Ei={[xe.OBJ_ADD]:t=>{const[e,s,n,i]=t.popInts(4);if(-1===s||-1===n)return;const a=Ks(s,mn);Ks(i,nn);const r=Ks(e,an);if(Ks(n,fn),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);if(!a.members||ge.NODE_MEMBERS)if(a.stackable&&1!==n){const e=new jn(r.level,r.x,r.z,zn.DESPAWN,s,n);zl.addObj(e,t.activePlayer.pid,i),t.activeObj=e,t.pointerAdd(Ue[t.intOperand])}else for(let e=0;e<n;e++){const e=new jn(r.level,r.x,r.z,zn.DESPAWN,s,1);zl.addObj(e,t.activePlayer.pid,i),t.activeObj=e,t.pointerAdd(Ue[t.intOperand])}},[xe.OBJ_ADDALL]:t=>{const[e,s,n,i]=t.popInts(4);if(-1===s||-1===n)return;const a=Ks(s,mn);Ks(i,nn);const r=Ks(e,an);if(Ks(n,fn),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);if(!a.members||ge.NODE_MEMBERS)if(a.stackable&&1!==n){const e=new jn(r.level,r.x,r.z,zn.DESPAWN,s,n);zl.addObj(e,-1,i),t.activeObj=e,t.pointerAdd(Ue[t.intOperand])}else for(let e=0;e<n;e++){const e=new jn(r.level,r.x,r.z,zn.DESPAWN,s,1);zl.addObj(e,-1,i),t.activeObj=e,t.pointerAdd(Ue[t.intOperand])}},[xe.OBJ_PARAM]:t=>{const e=Ks(t.popInt(),rn),s=Ks(t.activeObj.type,mn);e.isString()?t.pushString(qt(e.id,s,e.defaultString)):t.pushInt(Qt(e.id,s,e.defaultInt))},[xe.OBJ_NAME]:t=>{const e=Ks(t.activeObj.type,mn);t.pushString(e.name??e.debugname??'null')},[xe.OBJ_DEL]:t=>{const e=_e.get(t.activeObj.type).respawnrate;t.pointerGet(De[t.intOperand]),zl.removeObj(t.activeObj,e)},[xe.OBJ_COUNT]:t=>{t.pushInt(Ks(t.activeObj.count,fn))},[xe.OBJ_TYPE]:t=>{t.pushInt(Ks(t.activeObj.type,mn).id)},[xe.OBJ_TAKEITEM]:t=>{const e=Ks(t.popInt(),En),s=t.activeObj,n=_e.get(s.type),i=zl.getZone(s.x,s.z,s.level);for(const a of i.getObjsSafe(Ws.packZoneCoord(s.x,s.z)))if(a.type===s.type&&a.count===s.count&&(-1===a.receiverId||a.receiverId===t.activePlayer.pid)){if(t.activePlayer.playerLog('Picked up item',n.debugname),t.activePlayer.invAdd(e.id,s.type,s.count),s.lifecycle===zn.RESPAWN){zl.removeObj(s,n.respawnrate);break}if(s.lifecycle===zn.DESPAWN){zl.removeObj(s,0);break}}},[xe.OBJ_COORD]:t=>{const e=t.activeObj;t.pushInt(Ws.packCoord(e.level,e.x,e.z))}},Oi={[xe.OC_NAME]:t=>{const e=Ks(t.popInt(),mn);t.pushString(e.name??e.debugname??'null')},[xe.OC_PARAM]:t=>{const[e,s]=t.popInts(2),n=Ks(e,mn),i=Ks(s,rn);i.isString()?t.pushString(qt(i.id,n,i.defaultString)):t.pushInt(Qt(i.id,n,i.defaultInt))},[xe.OC_CATEGORY]:t=>{t.pushInt(Ks(t.popInt(),mn).category)},[xe.OC_DESC]:t=>{t.pushString(Ks(t.popInt(),mn).desc??'null')},[xe.OC_MEMBERS]:t=>{t.pushInt(Ks(t.popInt(),mn).members?1:0)},[xe.OC_WEIGHT]:t=>{t.pushInt(Ks(t.popInt(),mn).weight)},[xe.OC_WEARPOS]:t=>{t.pushInt(Ks(t.popInt(),mn).wearpos)},[xe.OC_WEARPOS2]:t=>{t.pushInt(Ks(t.popInt(),mn).wearpos2)},[xe.OC_WEARPOS3]:t=>{t.pushInt(Ks(t.popInt(),mn).wearpos3)},[xe.OC_COST]:t=>{t.pushInt(Ks(t.popInt(),mn).cost)},[xe.OC_TRADEABLE]:t=>{t.pushInt(Ks(t.popInt(),mn).tradeable?1:0)},[xe.OC_DEBUGNAME]:t=>{t.pushString(Ks(t.popInt(),mn).debugname??'null')},[xe.OC_CERT]:t=>{const e=Ks(t.popInt(),mn);-1==e.certtemplate&&e.certlink>=0?t.pushInt(e.certlink):t.pushInt(e.id)},[xe.OC_UNCERT]:t=>{const e=Ks(t.popInt(),mn);e.certtemplate>=0&&e.certlink>=0?t.pushInt(e.certlink):t.pushInt(e.id)},[xe.OC_STACKABLE]:t=>{t.pushInt(Ks(t.popInt(),mn).stackable?1:0)}};class Ai extends ht{type;script;args;delay;lastInt=0;constructor(t,e,s,n){super(),this.type=t,this.script=e,this.args=s,this.delay=n}}class Ti extends ht{script;delay;constructor(t,e){super(),this.script=t,this.delay=e}}class Ii{id;length;static all=[];static byId=[];static IF_OPENCHATMODAL=new Ii(14,2);static IF_OPENMAINSIDEMODAL=new Ii(28,4);static IF_CLOSE=new Ii(129,0);static IF_OPENSIDEOVERLAY=new Ii(167,3);static IF_OPENMAINMODAL=new Ii(168,2);static IF_OPENSIDEMODAL=new Ii(195,2);static IF_SETCOLOUR=new Ii(2,4);static IF_SETHIDE=new Ii(26,3);static IF_SETOBJECT=new Ii(46,6);static IF_SHOWSIDE=new Ii(84,1);static IF_SETMODEL=new Ii(87,4);static IF_SETRECOL=new Ii(103,6);static IF_SETANIM=new Ii(146,4);static IF_SETPLAYERHEAD=new Ii(197,2);static IF_SETTEXT=new Ii(201,-2);static IF_SETNPCHEAD=new Ii(204,4);static IF_SETPOSITION=new Ii(209,6);static TUTORIAL_FLASHSIDE=new Ii(126,1);static TUTORIAL_OPENCHAT=new Ii(185,2);static UPDATE_INV_STOP_TRANSMIT=new Ii(15,2);static UPDATE_INV_FULL=new Ii(98,-2);static UPDATE_INV_PARTIAL=new Ii(213,-2);static CAM_LOOKAT=new Ii(74,6);static CAM_SHAKE=new Ii(13,4);static CAM_MOVETO=new Ii(3,6);static CAM_RESET=new Ii(239,0);static NPC_INFO=new Ii(1,-2);static PLAYER_INFO=new Ii(184,-2);static FINISH_TRACKING=new Ii(133,0);static ENABLE_TRACKING=new Ii(226,0);static MESSAGE_GAME=new Ii(4,-1);static UPDATE_IGNORELIST=new Ii(21,-2);static CHAT_FILTER_SETTINGS=new Ii(32,3);static MESSAGE_PRIVATE=new Ii(41,-1);static UPDATE_FRIENDLIST=new Ii(152,9);static UNSET_MAP_FLAG=new Ii(19,0);static UPDATE_RUNWEIGHT=new Ii(22,2);static HINT_ARROW=new Ii(25,6);static UPDATE_REBOOT_TIMER=new Ii(43,2);static UPDATE_STAT=new Ii(44,6);static UPDATE_RUNENERGY=new Ii(68,1);static RESET_ANIMS=new Ii(136,0);static UPDATE_UID192=new Ii(139,2);static LAST_LOGIN_INFO=new Ii(140,9);static LOGOUT=new Ii(142,0);static P_COUNTDIALOG=new Ii(243,0);static SET_MULTIWAY=new Ii(254,1);static DATA_LOC_DONE=new Ii(20,2);static DATA_LAND_DONE=new Ii(80,2);static DATA_LAND=new Ii(132,-2);static DATA_LOC=new Ii(220,-2);static REBUILD_NORMAL=new Ii(237,-2);static VARP_SMALL=new Ii(150,3);static VARP_LARGE=new Ii(175,6);static RESET_CLIENT_VARCACHE=new Ii(193,0);static SYNTH_SOUND=new Ii(12,5);static MIDI_SONG=new Ii(54,-1);static MIDI_JINGLE=new Ii(212,-2);static UPDATE_ZONE_PARTIAL_FOLLOWS=new Ii(7,2);static UPDATE_ZONE_FULL_FOLLOWS=new Ii(135,2);static UPDATE_ZONE_PARTIAL_ENCLOSED=new Ii(162,-2);constructor(t,e){this.id=t,this.length=e,Ii.all.push(this),Ii.byId[t]=this}}(_i=gi||={})[_i.STATIONARY=0]='STATIONARY',_i[_i.CRAWL=1]='CRAWL',_i[_i.WALK=2]='WALK',_i[_i.RUN=3]='RUN',_i[_i.INSTANT=4]='INSTANT';var Ni,Pi,Li=gi;(Pi=Ni||={})[Pi.SMART=0]='SMART',Pi[Pi.NAIVE=1]='NAIVE',Pi[Pi.FLY=2]='FLY';var yi=Ni;class Si extends Vn{moveRestrict;blockWalk;moveStrategy;coordmask;entitymask;moveSpeed=Li.INSTANT;walkDir=-1;runDir=-1;waypointIndex=-1;waypoints=new Int32Array(25);lastX=-1;lastZ=-1;tele=!1;jump=!1;lastStepX=-1;lastStepZ=-1;stepsTaken=0;lastInt=-1;lastCrawl=!1;walktrigger=-1;walktriggerArg=0;orientation=Hs;interacted=!1;repathed=!1;target=null;targetOp=-1;targetSubject={type:-1,com:-1};targetX=-1;targetZ=-1;apRange=10;apRangeCalled=!1;alreadyFacedCoord=!1;alreadyFacedEntity=!1;mask=0;exactStartX=-1;exactStartZ=-1;exactEndX=-1;exactEndZ=-1;exactMoveStart=-1;exactMoveEnd=-1;exactMoveDirection=-1;faceX=-1;faceZ=-1;faceEntity=-1;damageTaken=-1;damageType=-1;animId=-1;animDelay=-1;chat=null;graphicId=-1;graphicHeight=-1;graphicDelay=-1;constructor(t,e,s,n,i,a,r,o,c,l,h){super(t,e,s,n,i,a),this.moveRestrict=r,this.blockWalk=o,this.moveStrategy=c,this.coordmask=l,this.entitymask=h,this.lastStepX=e-1,this.lastStepZ=s}processMovement(){return!(!this.hasWaypoints()||this.moveSpeed===Li.STATIONARY||this.moveSpeed===Li.INSTANT)&&(this.moveSpeed===Li.CRAWL?(this.lastCrawl=!this.lastCrawl,this.lastCrawl&&-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep()),!0):(-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep(),this.moveSpeed===Li.RUN&&-1!==this.walkDir&&-1===this.runDir&&(this.runDir=this.validateAndAdvanceStep())),!0))}refreshZonePresence(t,e,s){if(this.x!=t||this.z!==e||this.level!==s){switch(this.blockWalk){case ae.NPC:zl.gameMap.changeNpcCollision(this.width,t,e,s,!1),zl.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0);break;case ae.ALL:zl.gameMap.changeNpcCollision(this.width,t,e,s,!1),zl.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0),zl.gameMap.changePlayerCollision(this.width,t,e,s,!1),zl.gameMap.changePlayerCollision(this.width,this.x,this.z,this.level,!0)}this.lastStepX=t,this.lastStepZ=e}Ws.zone(t)===Ws.zone(this.x)&&Ws.zone(e)===Ws.zone(this.z)&&s==this.level||(zl.getZone(t,e,s).leave(this),zl.getZone(this.x,this.z,this.level).enter(this))}validateAndAdvanceStep(){const t=this.takeStep();if(null===t)return-1;if(-1===t)return this.waypointIndex--,-1!=this.waypointIndex?this.validateAndAdvanceStep():-1;const e=this.x,s=this.z;return this.x=Ws.moveX(this.x,t),this.z=Ws.moveZ(this.z,t),this.orientation=t,this.stepsTaken++,this.refreshZonePresence(e,s,this.level),t}queueWaypoint(t,e){this.waypoints[0]=Ws.packCoord(0,t,e),this.waypointIndex=0}queueWaypoints(t){let e=-1;for(let s=t.length-1,n=0;s>=0&&n<this.waypoints.length;s--,n++)this.waypoints[n]=t[s],e++;this.waypointIndex=e}clearWaypoints(){this.waypointIndex=-1}teleJump(t,e,s){this.teleport(t,e,s),this.jump=!0}teleport(t,e,s){isNaN(s)&&(s=0),s=Math.max(0,Math.min(s,3));const n=this.x,i=this.z,a=this.level;this.x=t,this.z=e,this.level=s,this.refreshZonePresence(n,i,a),this.lastStepX=this.x-1,this.lastStepZ=this.z,this.moveSpeed=Li.INSTANT,a!=s&&(this.jump=!0)}validateDistanceWalked(){Ws.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length})>2&&(this.jump=!0)}convertMovementDir(){let t=this.walkDir,e=this.runDir,s=this.moveSpeed===Li.INSTANT;const n=Ws.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length});if(s&&!this.jump&&n<=2){if(2===n){const s=(this.x+this.lastX)/2|0,n=(this.z+this.lastZ)/2|0;t=Ws.face(this.lastX,this.lastZ,s,n),e=Ws.face(s,n,this.x,this.z)}else t=Ws.face(this.lastX,this.lastZ,this.x,this.z),e=-1;s=!1}this.walkDir=t,this.runDir=e,this.tele=s}hasWaypoints(){return-1!==this.waypointIndex}isLastOrNoWaypoint(){return this.waypointIndex<=0}inOperableDistance(t){if(t.level!==this.level)return!1;if(t instanceof Si)return us(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,t.orientation,-2);if(t instanceof ei){const e=ee.get(t.type).forceapproach;return us(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,t.angle,t.shape,e)}const e=us(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,0,-2);return os(t.x,t.z,t.level,vs.WALK_BLOCKED)?e:!(this.hasWaypoints()||!e)||us(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,0,-1)}inApproachDistance(t,e){return e.level===this.level&&(!(e instanceof Si&&Ws.intersects(this.x,this.z,this.width,this.length,e.x,e.z,e.width,e.length))&&(Ws.distanceTo(this,e)<=t&&ls(this.level,this.x,this.z,e.x,e.z,this.width,this.length,e.width,e.length,vs.PLAYER)))}pathToMoveClick(t,e){if(this.moveStrategy===yi.SMART)if(e){const{x:e,z:s}=Ws.unpackCoord(t[0]);this.queueWaypoints(Je(this.level,this.x,this.z,e,s))}else this.queueWaypoints(t);else{const{x:e,z:s}=Ws.unpackCoord(t[t.length-1]);this.queueWaypoint(e,s)}}pathToPathingTarget(){this.target&&this.target instanceof Si&&this.isLastOrNoWaypoint()&&(this.targetOp!==li.APPLAYER3&&this.targetOp!==li.OPPLAYER3?this.pathToTarget():this.queueWaypoint(this.target.lastStepX,this.target.lastStepZ))}pathToTarget(){if(this.target)if(this.targetX=this.target.x,this.targetZ=this.target.z,this.moveStrategy===yi.SMART)if(this.target instanceof Si)this.queueWaypoints(Je(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.orientation,-2));else if(this.target instanceof ei){const t=ee.get(this.target.type).forceapproach;this.queueWaypoints(Je(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.angle,this.target.shape,!0,t))}else this.queueWaypoints(Je(this.level,this.x,this.z,this.target.x,this.target.z));else if(this.moveStrategy===yi.NAIVE){const t=this.getCollisionStrategy();if(null===t)return;const e=this.blockWalkFlag();if(e===vs.NULL)return;this.target instanceof Si?this.queueWaypoints(Xe(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.length,this.target.width,this.target.length,e,t)):this.queueWaypoint(this.target.x,this.target.z)}else{if(null===this.getCollisionStrategy())return;if(this.blockWalkFlag()===vs.NULL)return;this.queueWaypoint(this.target.x,this.target.z)}}setInteraction(t,e,s,n){if(this.target=e,this.targetOp=s,this.targetSubject=n??{type:-1,com:-1},this.targetX=e.x,this.targetZ=e.z,this.apRange=10,this.apRangeCalled=!1,e instanceof bo){const t=e.pid+32768;this.faceEntity!==t&&(this.faceEntity=t,this.mask|=this.entitymask)}else if(e instanceof bl){const t=e.nid;this.faceEntity!==t&&(this.faceEntity=t,this.mask|=this.entitymask)}else{const t=2*e.x+e.width,s=2*e.z+e.length;this.faceX===t&&this.faceZ===s||(this.faceX=t,this.faceZ=s,this.mask|=this.coordmask)}t===hi.SCRIPT&&this.pathToTarget()}clearInteraction(){this.target=null,this.targetOp=-1,this.targetSubject={type:-1,com:-1},this.targetX=-1,this.targetZ=-1,this.apRange=10,this.apRangeCalled=!1,this.alreadyFacedCoord=!0,this.alreadyFacedEntity=!0}getCollisionStrategy(){return this.moveRestrict===ce.NORMAL?Rs.NORMAL:this.moveRestrict===ce.BLOCKED?Rs.BLOCKED:this.moveRestrict===ce.BLOCKED_NORMAL?Rs.LINE_OF_SIGHT:this.moveRestrict===ce.INDOORS?Rs.INDOORS:this.moveRestrict===ce.OUTDOORS?Rs.OUTDOORS:this.moveRestrict===ce.NOMOVE?null:this.moveRestrict===ce.PASSTHRU?Rs.NORMAL:null}resetPathingEntity(){this.moveSpeed=this.defaultMoveSpeed(),this.walkDir=-1,this.runDir=-1,this.jump=!1,this.tele=!1,this.lastX=this.x,this.lastZ=this.z,this.stepsTaken=0,this.interacted=!1,this.apRangeCalled=!1,this.mask=0,this.exactStartX=-1,this.exactStartZ=-1,this.exactEndX=-1,this.exactEndZ=-1,this.exactMoveStart=-1,this.exactMoveEnd=-1,this.exactMoveDirection=-1,this.animId=-1,this.animDelay=-1,this.animId=-1,this.animDelay=-1,this.chat=null,this.damageTaken=-1,this.damageType=-1,this.graphicId=-1,this.graphicHeight=-1,this.graphicDelay=-1,-1!==this.faceX?this.orientation=Ws.face(this.x,this.z,this.faceX,this.faceZ):this.target&&(this.orientation=Ws.face(this.x,this.z,this.target.x,this.target.z)),this.alreadyFacedCoord&&-1!==this.faceX&&!this.hasWaypoints()?(this.faceX=-1,this.faceZ=-1,this.alreadyFacedCoord=!1):this.alreadyFacedEntity&&!this.target&&-1!==this.faceEntity&&(this.mask|=this.entitymask,this.faceEntity=-1,this.alreadyFacedEntity=!1)}takeStep(){if(-1===this.waypointIndex)return null;const t=this.x,e=this.z,{x:s,z:n}=Ws.unpackCoord(this.waypoints[this.waypointIndex]),i=Ws.face(t,e,s,n),a=Ws.deltaX(i),r=Ws.deltaZ(i);if(0==a&&0==r)return-1;const o=this.getCollisionStrategy();if(null===o)return-1;const c=this.blockWalkFlag();return c===vs.NULL?-1:this.moveStrategy===yi.FLY||cs(this.level,this.x,this.z,a,r,this.width,c,o)?i:0!=a&&cs(this.level,this.x,this.z,a,0,this.width,c,o)?Ws.face(t,e,s,e):0!=r&&cs(this.level,this.x,this.z,0,r,this.width,c,o)?Ws.face(t,e,t,n):null}}class vi{sentinel;cursor=null;constructor(){const t=new pt;t.nextHashable=t,t.prevHashable=t,this.sentinel=t}push(t){t.prevHashable&&t.uncache(),t.prevHashable=this.sentinel.prevHashable,t.nextHashable=this.sentinel,t.prevHashable&&(t.prevHashable.nextHashable=t),t.nextHashable.prevHashable=t}pop(){const t=this.sentinel.nextHashable;return t===this.sentinel?null:(t?.uncache(),t)}head(){const t=this.sentinel.nextHashable;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.nextHashable||null,t)}next(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.nextHashable||null,t)}}var Ci,wi,Ri=new Map,bi=new Map;class Ui extends pt{}class Di{static LOW=new Di;static HIGH=new Di}class Mi extends Ui{priority=Di.LOW}class ki extends Ui{uid;priority=Di.HIGH;constructor(t){super(),this.uid=t}}class xi extends Ui{priority=Di.HIGH}class Bi extends Ui{priority=Di.HIGH}class Fi extends Ui{component;priority=Di.LOW;constructor(t){super(),this.component=t}}class Hi extends Ui{component;priority=Di.HIGH;constructor(t){super(),this.component=t}}class Gi extends Ui{varp;value;priority=Di.HIGH;constructor(t,e){super(),this.varp=t,this.value=e}}class Wi extends Ui{varp;value;priority=Di.HIGH;constructor(t,e){super(),this.varp=t,this.value=e}}class zi extends Ui{name;crc;length;priority=Di.LOW;constructor(t,e,s){super(),this.name=t,this.crc=e,this.length=s}}class Vi extends Ui{delay;data;priority=Di.LOW;constructor(t,e){super(),this.delay=t,this.data=e}}class Yi extends Ui{component;tab;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.tab=e}}class ji extends Ui{priority=Di.HIGH}class Ki extends Ui{type;nid;pid;x;z2;y2;priority=Di.LOW;constructor(t,e,s,n,i,a){super(),this.type=t,this.nid=e,this.pid=s,this.x=n,this.z=i,this.y=a}}class Zi extends Ui{lastLoginIp;daysSinceLogin;daysSinceRecoveryChange;unreadMessageCount;priority=Di.LOW;constructor(t,e,s,n){super(),this.lastLoginIp=t,this.daysSinceLogin=e,this.daysSinceRecoveryChange=s,this.unreadMessageCount=n}}class $i extends Ui{msg;priority=Di.HIGH;constructor(t){super(),this.msg=t}}(wi=Ci||={})[wi.ENCLOSED=0]='ENCLOSED',wi[wi.FOLLOWS=1]='FOLLOWS';var Ji=Ci;class Xi extends Ui{zoneX;zoneZ;originX;originZ;data;priority=Di.HIGH;constructor(t,e,s,n,i){super(),this.zoneX=t,this.zoneZ=e,this.originX=s,this.originZ=n,this.data=i}}class qi extends Ui{zoneX;zoneZ;originX;originZ;priority=Di.HIGH;constructor(t,e,s,n){super(),this.zoneX=t,this.zoneZ=e,this.originX=s,this.originZ=n}}class Qi extends Ui{zoneX;zoneZ;originX;originZ;priority=Di.HIGH;constructor(t,e,s,n){super(),this.zoneX=t,this.zoneZ=e,this.originX=s,this.originZ=n}}class ta extends Ui{coord;priority=Di.HIGH;constructor(t){super(),this.coord=t}}class ea extends ta{coord;obj;count;constructor(t,e,s){super(t),this.coord=t,this.obj=e,this.count=s}}class sa extends ta{coord;loc;shape;angle;constructor(t,e,s,n){super(t),this.coord=t,this.loc=e,this.shape=s,this.angle=n}}class na extends ta{coord;shape;angle;constructor(t,e,s){super(t),this.coord=t,this.shape=e,this.angle=s}}class ia extends ta{srcX;srcZ;dstX;dstZ;target;spotanim;srcHeight;dstHeight;startDelay;endDelay;peak;arc;constructor(t,e,s,n,i,a,r,o,c,l,h,d){super(Ws.packZoneCoord(t,e)),this.srcX=t,this.srcZ=e,this.dstX=s,this.dstZ=n,this.target=i,this.spotanim=a,this.srcHeight=r,this.dstHeight=o,this.startDelay=c,this.endDelay=l,this.peak=h,this.arc=d}}class aa extends ta{coord;spotanim;height;delay;constructor(t,e,s,n){super(t),this.coord=t,this.spotanim=e,this.height=s,this.delay=n}}class ra extends ta{coord;obj;constructor(t,e){super(t),this.coord=t,this.obj=e}}class oa extends ta{coord;obj;oldCount;newCount;constructor(t,e,s,n){super(t),this.coord=t,this.obj=e,this.oldCount=s,this.newCount=n}}class ca extends ta{coord;obj;count;receiverId;constructor(t,e,s,n){super(t),this.coord=t,this.obj=e,this.count=s,this.receiverId=n}}class la extends ta{coord;shape;angle;seq;constructor(t,e,s,n){super(t),this.coord=t,this.shape=e,this.angle=s,this.seq=n}}class ha extends ta{srcX;srcZ;shape;angle;locId;startCycle;endCycle;pid;east;south;west;north;constructor(t,e,s,n,i,a,r,o,c,l,h,d){super(Ws.packZoneCoord(t,e)),this.srcX=t,this.srcZ=e,this.shape=s,this.angle=n,this.locId=i,this.startCycle=a,this.endCycle=r,this.pid=o,this.east=c,this.south=l,this.west=h,this.north=d}}class da{test(t){return this.prot.length}}class pa extends da{prot=Ii.IF_OPENCHATMODAL;encode(t,e){t.p2(e.component)}}class ua extends Ui{component;priority=Di.LOW;constructor(t){super(),this.component=t}}class ga extends Ui{buildArea;level;x;z2;originX;originZ;uid;mask;tele;jump2;walkDir;runDir;priority=Di.HIGH;accumulator=0;constructor(t,e,s,n,i,a,r,o,c,l,h,d){super(),this.buildArea=t,this.level=e,this.x=s,this.z=n,this.originX=i,this.originZ=a,this.uid=r,this.mask=o,this.tele=c,this.jump=l,this.walkDir=h,this.runDir=d}}class _a extends da{static BITS_NEW=34;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=Ii.PLAYER_INFO;encode(t,e){const s=e.buildArea;s.resize(),this.writeLocalPlayer(t,e),this.writePlayers(t,e),this.writeNewPlayers(t,e);const n=s.extendedInfo;if(n.size>0)for(const s of n){const n=zl.getPlayerByUid(s.id);n&&this.writeUpdate(n,e,t,s.id===e.uid,s.added)}s.reset()}test(t){return _a.BYTES_LIMIT}writeLocalPlayer(t,e){const{buildArea:s,uid:n,level:i,x:a,z:r,mask:o,tele:c,jump:l,walkDir:h,runDir:d}=e,p=zl.getPlayerByUid(n);p&&(t.bits(),t.pBit(1,c||-1!==h||-1!==d||o>0?1:0),c?(t.pBit(2,3),t.pBit(2,i),t.pBit(7,Ws.local(a)),t.pBit(7,Ws.local(r)),t.pBit(1,l?1:0),t.pBit(1,o>0?1:0)):-1!==d?(t.pBit(2,2),t.pBit(3,h),t.pBit(3,d),t.pBit(1,o>0?1:0)):-1!==h?(t.pBit(2,1),t.pBit(3,h),t.pBit(1,o>0?1:0)):o>0&&t.pBit(2,0),o>0&&(s.extendedInfo.add({id:n,added:!1}),e.accumulator+=this.calculateUpdateSize(p,e,!0,!0)))}writePlayers(t,e){const s=e.buildArea;t.pBit(8,s.players.size);for(const n of s.players){const i=zl.getPlayerByUid(n);if(!i||i.tele||i.level!==e.level||!Ws.isWithinDistanceSW(e,i,s.viewDistance)||!i.checkLifeCycle(zl.currentTick)){t.pBit(1,1),t.pBit(2,3),s.players.delete(n);continue}let a=i.mask>0;const{walkDir:r,runDir:o}=i;let c=0;-1!==o?c=_a.BITS_RUN:-1!==r?c=_a.BITS_WALK:a&&(c=_a.BITS_EXTENDED);const l=a?this.calculateUpdateSize(i,e,!1,!1):0;(t.bitPos+c+7+24>>>3)+t.pos+(e.accumulator+=l)>this.test(e)&&(a=!1),t.pBit(1,-1!==r||-1!==o||a?1:0),-1!==o?(t.pBit(2,2),t.pBit(3,r),t.pBit(3,o),t.pBit(1,a?1:0)):-1!==r?(t.pBit(2,1),t.pBit(3,r),t.pBit(1,a?1:0)):a&&t.pBit(2,0),a&&s.extendedInfo.add({id:n,added:!1})}}writeNewPlayers(t,e){const s=e.buildArea;for(const n of s.getNearbyPlayers(e.uid,e.x,e.z,e.originX,e.originZ)){const i=!s.hasAppearance(n.pid,n.lastAppearance),a=i?this.calculateUpdateSize(n,e,!1,!0):0;if((t.bitPos+_a.BITS_NEW+7+24>>>3)+t.pos+(e.accumulator+=a)>this.test(e))break;t.pBit(11,n.pid),t.pBit(5,n.x-e.x),t.pBit(5,n.z-e.z),t.pBit(1,n.jump?1:0),t.pBit(1,i?1:0),i&&s.extendedInfo.add({id:n.uid,added:!0}),s.players.add(n.uid)}s.extendedInfo.size>0&&t.pBit(11,2047),t.bytes()}writeUpdate(t,e,s,n=!1,i=!1){let a=t.mask;if(i&&(a|=bo.APPEARANCE),!i||-1===t.orientation&&-1===t.faceX&&-1===t.faceZ||(a|=bo.FACE_COORD),i&&-1!==t.faceEntity&&(a|=bo.FACE_ENTITY),a>255&&(a|=bo.BIG_UPDATE),n&&a&bo.CHAT&&(a&=~bo.CHAT),e.buildArea.hasAppearance(t.pid,t.lastAppearance)&&(a&=~bo.APPEARANCE),s.p1(255&a),a&bo.BIG_UPDATE&&s.p1(a>>8),a&bo.APPEARANCE&&(s.p1(t.appearance.length),s.pdata(t.appearance,0,t.appearance.length),e.buildArea.saveAppearance(t.pid,t.lastAppearance)),a&bo.ANIM&&(s.p2(t.animId),s.p1(t.animDelay)),a&bo.FACE_ENTITY&&(-1!==t.faceEntity&&(t.alreadyFacedEntity=!0),s.p2(t.faceEntity)),a&bo.SAY&&s.pjstr(t.chat??''),a&bo.DAMAGE&&(s.p1(t.damageTaken),s.p1(t.damageType),s.p1(t.levels[js.HITPOINTS]),s.p1(t.baseLevels[js.HITPOINTS])),a&bo.FACE_COORD)if(-1!==t.faceX&&(t.alreadyFacedCoord=!0),i&&-1!==t.faceX)s.p2(t.faceX),s.p2(t.faceZ);else if(i&&-1!==t.orientation){const e=Ws.moveX(t.x,t.orientation),n=Ws.moveZ(t.z,t.orientation);s.p2(2*e+1),s.p2(2*n+1)}else s.p2(t.faceX),s.p2(t.faceZ);a&bo.CHAT&&(s.p1(t.messageColor),s.p1(t.messageEffect),s.p1(t.messageType),s.p1(t.message.length),s.pdata(t.message,0,t.message.length)),a&bo.SPOTANIM&&(s.p2(t.graphicId),s.p2(t.graphicHeight),s.p2(t.graphicDelay)),a&bo.EXACT_MOVE&&(s.p1(t.exactStartX-Ws.zoneOrigin(e.originX)),s.p1(t.exactStartZ-Ws.zoneOrigin(e.originZ)),s.p1(t.exactEndX-Ws.zoneOrigin(e.originX)),s.p1(t.exactEndZ-Ws.zoneOrigin(e.originZ)),s.p2(t.exactMoveStart),s.p2(t.exactMoveEnd),s.p1(t.exactMoveDirection))}calculateUpdateSize(t,e,s=!1,n=!1){let i=0,a=t.mask;return n&&(a|=bo.APPEARANCE),!n||-1===t.orientation&&-1===t.faceX&&-1===t.faceZ||(a|=bo.FACE_COORD),n&&-1!==t.faceEntity&&(a|=bo.FACE_ENTITY),a>255&&(a|=bo.BIG_UPDATE),s&&a&bo.CHAT&&(a&=~bo.CHAT),e.buildArea.hasAppearance(t.pid,t.lastAppearance)&&(a&=~bo.APPEARANCE),i+=1,a&bo.BIG_UPDATE&&(i+=1),a&bo.APPEARANCE&&(i+=1,i+=t.appearance?.length??0),a&bo.ANIM&&(i+=3),a&bo.FACE_ENTITY&&(i+=2),a&bo.SAY&&(i+=(t.chat?.length??0)+1),a&bo.DAMAGE&&(i+=4),a&bo.FACE_COORD&&(i+=4),a&bo.CHAT&&(i+=4,i+=t.message?.length??0),a&bo.SPOTANIM&&(i+=6),a&bo.EXACT_MOVE&&(i+=9),i}}class ma extends Ui{zoneX;zoneZ;priority=Di.HIGH;constructor(t,e){super(),this.zoneX=t,this.zoneZ=e}get mapsquares(){const t=this.zoneX-6,e=this.zoneX+6,s=this.zoneZ-6,n=this.zoneZ+6,i=new Set;for(let a=t;a<=e;a++){const t=Ws.mapsquare(a<<3);for(let e=s;e<=n;e++){const s=Ws.mapsquare(e<<3);i.add(t<<8|s)}}return i}}class fa extends da{prot=Ii.REBUILD_NORMAL;encode(t,e){t.p2(e.zoneX),t.p2(e.zoneZ);for(const s of e.mapsquares){const e=s>>8,n=255&s;t.p1(e),t.p1(n),t.p4(bi.get(`m${e}_${n}`)??0),t.p4(bi.get(`l${e}_${n}`)??0)}}test(t){return 4+10*t.mapsquares.size}}class Ea extends Ui{x;z2;offset;length;data;priority=Di.HIGH;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.offset=s,this.length=n,this.data=i}}class Oa extends da{prot=Ii.DATA_LAND;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.offset),t.p2(e.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class Aa extends Ui{x;z2;priority=Di.HIGH;constructor(t,e){super(),this.x=t,this.z=e}}class Ta extends da{prot=Ii.DATA_LAND_DONE;encode(t,e){t.p1(e.x),t.p1(e.z)}}class Ia extends Ui{x;z2;offset;length;data;priority=Di.HIGH;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.offset=s,this.length=n,this.data=i}}class Na extends da{prot=Ii.DATA_LOC;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.offset),t.p2(e.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class Pa extends Ui{x;z2;priority=Di.HIGH;constructor(t,e){super(),this.x=t,this.z=e}}class La extends da{prot=Ii.DATA_LOC_DONE;encode(t,e){t.p1(e.x),t.p1(e.z)}}class ya extends Ui{x;z2;height;speed;multiplier;priority=Di.LOW;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.height=s,this.speed=n,this.multiplier=i}}class Sa extends da{prot=Ii.CAM_LOOKAT;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.height),t.p1(e.speed),t.p1(e.multiplier)}}class va extends Ui{x;z2;height;speed;multiplier;priority=Di.LOW;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.height=s,this.speed=n,this.multiplier=i}}class Ca extends da{prot=Ii.CAM_MOVETO;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.height),t.p1(e.speed),t.p1(e.multiplier)}}class wa extends Ui{priority=Di.LOW}class Ra extends da{prot=Ii.CAM_RESET;encode(t,e){}}class ba extends Ui{type;jitter;amplitude;frequency;priority=Di.LOW;constructor(t,e,s,n){super(),this.type=t,this.jitter=e,this.amplitude=s,this.frequency=n}}class Ua extends da{prot=Ii.CAM_SHAKE;encode(t,e){t.p1(e.type),t.p1(e.jitter),t.p1(e.amplitude),t.p1(e.frequency)}}class Da extends Ui{publicChat;privateChat;tradeDuel;priority=Di.HIGH;constructor(t,e,s){super(),this.publicChat=t,this.privateChat=e,this.tradeDuel=s}}class Ma extends da{prot=Ii.CHAT_FILTER_SETTINGS;encode(t,e){t.p1(e.publicChat),t.p1(e.privateChat),t.p1(e.tradeDuel)}}class ka extends Ui{priority=Di.LOW}class xa extends da{prot=Ii.ENABLE_TRACKING;encode(t,e){}}class Ba extends Ui{priority=Di.LOW}class Fa extends da{prot=Ii.FINISH_TRACKING;encode(t,e){}}class Ha extends da{prot=Ii.HINT_ARROW;encode(t,e){const{type:s,nid:n,pid:i,x:a,z:r,y:o}=e;1===s?(t.p1(s),t.p2(n),t.p2(0),t.p1(0)):s>=2&&s<=6?(t.p1(s),t.p2(a),t.p2(r),t.p1(o)):10===s?(t.p1(s),t.p2(i),t.p2(0),t.p1(0)):-1===s&&(t.p1(-1),t.p2(0),t.p2(0),t.p1(0))}}class Ga extends da{prot=Ii.IF_CLOSE;encode(t,e){}}class Wa extends Ui{component;priority=Di.LOW;constructor(t){super(),this.component=t}}class za extends da{prot=Ii.IF_OPENMAINMODAL;encode(t,e){t.p2(e.component)}}class Va extends Ui{main;side;priority=Di.LOW;constructor(t,e){super(),this.main=t,this.side=e}}class Ya extends da{prot=Ii.IF_OPENMAINSIDEMODAL;encode(t,e){t.p2(e.main),t.p2(e.side)}}class ja extends Ui{component;priority=Di.LOW;constructor(t){super(),this.component=t}}class Ka extends da{prot=Ii.IF_OPENSIDEMODAL;encode(t,e){t.p2(e.component)}}class Za extends da{prot=Ii.IF_OPENSIDEOVERLAY;encode(t,e){t.p2(e.component),t.p1(e.tab)}}class $a extends Ui{component;seq;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.seq=e}}class Ja extends da{prot=Ii.IF_SETANIM;encode(t,e){t.p2(e.component),t.p2(e.seq)}}class Xa extends Ui{component;colour;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.colour=e}}class qa extends da{prot=Ii.IF_SETCOLOUR;encode(t,e){t.p2(e.component),t.p2(e.colour)}}class Qa extends Ui{component;hidden;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.hidden=e}}class tr extends da{prot=Ii.IF_SETHIDE;encode(t,e){t.p2(e.component),t.pbool(e.hidden)}}class er extends Ui{component;model;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.model=e}}class sr extends da{prot=Ii.IF_SETMODEL;encode(t,e){t.p2(e.component),t.p2(e.model)}}class nr extends Ui{component;npc;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.npc=e}}class ir extends da{prot=Ii.IF_SETNPCHEAD;encode(t,e){t.p2(e.component),t.p2(e.npc)}}class ar extends Ui{component;obj;scale;priority=Di.LOW;constructor(t,e,s){super(),this.component=t,this.obj=e,this.scale=s}}class rr extends da{prot=Ii.IF_SETOBJECT;encode(t,e){t.p2(e.component),t.p2(e.obj),t.p2(e.scale)}}class or extends Ui{component;priority=Di.LOW;constructor(t){super(),this.component=t}}class cr extends da{prot=Ii.IF_SETPLAYERHEAD;encode(t,e){t.p2(e.component)}}class lr extends Ui{component;x;y2;priority=Di.LOW;constructor(t,e,s){super(),this.component=t,this.x=e,this.y=s}}class hr extends da{prot=Ii.IF_SETPOSITION;encode(t,e){t.p2(e.component),t.p2(e.x),t.p2(e.y)}}class dr extends Ui{component;src;dst;priority=Di.LOW;constructor(t,e,s){super(),this.component=t,this.src=e,this.dst=s}}class pr extends da{prot=Ii.IF_SETRECOL;encode(t,e){t.p2(e.component),t.p2(e.src),t.p2(e.dst)}}class ur extends Ui{component;text;priority=Di.LOW;constructor(t,e){super(),this.component=t,this.text=e}}class gr extends da{prot=Ii.IF_SETTEXT;encode(t,e){t.p2(e.component),t.pjstr(e.text)}test(t){return 3+t.text.length}}class _r extends Ui{tab;priority=Di.LOW;constructor(t){super(),this.tab=t}}class mr extends da{prot=Ii.IF_SHOWSIDE;encode(t,e){t.p1(e.tab)}}class fr extends da{prot=Ii.LAST_LOGIN_INFO;encode(t,e){t.p4(e.lastLoginIp),t.p2(e.daysSinceLogin),t.p1(e.daysSinceRecoveryChange),t.p2(e.unreadMessageCount)}}class Er extends Ii{static LOC_MERGE=new Er(23,14);static LOC_ANIM=new Er(42,4);static OBJ_DEL=new Er(49,3);static OBJ_REVEAL=new Er(50,7);static LOC_ADD_CHANGE=new Er(59,4);static MAP_PROJANIM=new Er(69,15);static LOC_DEL=new Er(76,2);static OBJ_COUNT=new Er(151,7);static MAP_ANIM=new Er(191,6);static OBJ_ADD=new Er(223,5)}class Or extends da{enclose(t){const e=new ut(new Uint8Array(1+this.prot.length));return e.p1(this.prot.id),this.encode(e,t),e.data}}class Ar extends Or{prot=Er.LOC_ADD_CHANGE;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.loc)}}class Tr extends Or{prot=Er.LOC_ANIM;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.seq)}}class Ir extends Or{prot=Er.LOC_DEL;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle)}}class Nr extends Or{prot=Er.LOC_MERGE;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.locId),t.p2(e.startCycle),t.p2(e.endCycle),t.p2(e.pid),t.p1(e.east-e.srcX),t.p1(e.south-e.srcZ),t.p1(e.west-e.srcX),t.p1(e.north-e.srcZ)}}class Pr extends Ui{priority=Di.HIGH}class Lr extends da{prot=Ii.LOGOUT;encode(t,e){}}class yr extends Or{prot=Er.MAP_ANIM;encode(t,e){t.p1(e.coord),t.p2(e.spotanim),t.p1(e.height),t.p2(e.delay)}}class Sr extends Or{prot=Er.MAP_PROJANIM;encode(t,e){t.p1(e.coord),t.p1(e.dstX-e.srcX),t.p1(e.dstZ-e.srcZ),t.p2(e.target),t.p2(e.spotanim),t.p1(e.srcHeight),t.p1(e.dstHeight),t.p2(e.startDelay),t.p2(e.endDelay),t.p1(e.peak),t.p1(e.arc)}}class vr extends da{prot=Ii.MESSAGE_GAME;encode(t,e){t.pjstr(e.msg)}test(t){return 1+t.msg.length}}class Cr{static CHAR_LOOKUP=[' ','e','t','a','o','i','h','n','s','r','d','l','u','m','w','c','y','f','g','p','b','v','k','x','j','q','z','0','1','2','3','4','5','6','7','8','9',' ','!','?','.',',',':',';','(',')','-','&','*','\\',"'",'@','#','+','=','£','$','%','"','[',']'];static unpack(t,e){const s=[];let n,i=0,a=-1;for(let r=0;r<e&&i<80;r++){const e=t.g1();n=e>>4&15,-1!==a?(s[i++]=this.CHAR_LOOKUP[(a<<4)+n-195],a=-1):n<13?s[i++]=this.CHAR_LOOKUP[n]:a=n,n=15&e,-1!=a?(s[i++]=this.CHAR_LOOKUP[(a<<4)+n-195],a=-1):n<13?s[i++]=this.CHAR_LOOKUP[n]:a=n}return this.toSentenceCase(s.slice(0,i).join(''))}static pack(t,e){e.length>80&&(e=e.substring(0,80)),e=e.toLowerCase();let s=-1;for(let n=0;n<e.length;n++){const i=e.charAt(n);let a=0;for(let t=0;t<this.CHAR_LOOKUP.length;t++)if(i===this.CHAR_LOOKUP[t]){a=t;break}a>12&&(a+=195),-1==s?a<13?s=a:t.p1(a):a<13?(t.p1((s<<4)+a),s=-1):(t.p1((s<<4)+(a>>4)),s=15&a)}-1!=s&&t.p1(s<<4)}static toSentenceCase(t){const e=[...t.toLowerCase()];let s=!0;for(let t=0;t<e.length;t++){const n=e[t];s&&n>='a'&&n<='z'&&(e[t]=n.toUpperCase(),s=!1),'.'!==n&&'!'!==n||(s=!0)}return e.join('')}}class wr extends da{prot=Ii.MESSAGE_PRIVATE;encode(t,e){t.p8(e.from),t.p4(e.messageId),t.p1(e.staffModLevel),Cr.pack(t,ye.filter(e.msg))}test(t){return 14+t.msg.length}}class Rr extends Ui{from;messageId;staffModLevel;msg;priority=Di.HIGH;constructor(t,e,s,n){super(),this.from=t,this.messageId=e,this.staffModLevel=s,this.msg=n}}class br extends da{prot=Ii.MIDI_JINGLE;encode(t,e){t.p2(e.delay),t.p4(e.data.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class Ur extends da{prot=Ii.MIDI_SONG;encode(t,e){t.pjstr(e.name),t.p4(e.crc),t.p4(e.length)}test(t){return 1+t.name.length+4+4}}class Dr extends Or{prot=Er.OBJ_ADD;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.count,65535))}}class Mr extends Or{prot=Er.OBJ_COUNT;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.oldCount,65535)),t.p2(Math.min(e.newCount,65535))}}class kr extends Or{prot=Er.OBJ_DEL;encode(t,e){t.p1(e.coord),t.p2(e.obj)}}class xr extends Or{prot=Er.OBJ_REVEAL;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.count,65535)),t.p2(e.receiverId)}}class Br extends Ui{priority=Di.LOW}class Fr extends da{prot=Ii.P_COUNTDIALOG;encode(t,e){}}class Hr extends da{prot=Ii.RESET_ANIMS;encode(t,e){}}class Gr extends da{prot=Ii.RESET_CLIENT_VARCACHE;encode(t,e){}}class Wr extends Ui{hidden;priority=Di.LOW;constructor(t){super(),this.hidden=t}}class zr extends da{prot=Ii.SET_MULTIWAY;encode(t,e){t.pbool(e.hidden)}}class Vr extends Ui{synth;loops;delay;priority=Di.LOW;constructor(t,e,s){super(),this.synth=t,this.loops=e,this.delay=s}}class Yr extends da{prot=Ii.SYNTH_SOUND;encode(t,e){t.p2(e.synth),t.p1(e.loops),t.p2(e.delay)}}class jr extends Ui{tab;priority=Di.LOW;constructor(t){super(),this.tab=t}}class Kr extends da{prot=Ii.TUTORIAL_FLASHSIDE;encode(t,e){t.p1(e.tab)}}class Zr extends da{prot=Ii.TUTORIAL_OPENCHAT;encode(t,e){t.p2(e.component)}}class $r extends da{prot=Ii.UNSET_MAP_FLAG;encode(t,e){}}class Jr extends Ui{name;nodeId;priority=Di.LOW;constructor(t,e){super(),this.name=t,this.nodeId=e}}class Xr extends da{prot=Ii.UPDATE_FRIENDLIST;encode(t,e){t.p8(e.name),t.p1(e.nodeId)}}class qr extends Ui{names;priority=Di.LOW;constructor(t){super(),this.names=t}}class Qr extends da{prot=Ii.UPDATE_IGNORELIST;encode(t,e){for(const s of e.names)t.p8(s)}test(t){return 8*t.names.length}}class to extends Ui{component;inv;priority=Di.HIGH;constructor(t,e){super(),this.component=t,this.inv=e}}class eo extends da{prot=Ii.UPDATE_INV_FULL;encode(t,e){const{component:s,inv:n}=e,i=Zt.get(s),a=Math.min(n.capacity,i.width*i.height);t.p2(s),t.p1(a);for(let e=0;e<a;e++){const s=n.get(e);s?(t.p2(s.id+1),s.count>=255?(t.p1(255),t.p4(s.count)):t.p1(s.count)):(t.p2(0),t.p1(0))}}test(t){const{component:e,inv:s}=t,n=Zt.get(e),i=Math.min(s.capacity,n.width*n.height);let a=0;a+=3;for(let t=0;t<i;t++){const e=s.get(t);e?(a+=2,e.count>=255?a+=5:a+=1):a+=3}return a}}class so extends Ui{component;inv;priority=Di.HIGH;slots;constructor(t,e,...s){super(),this.component=t,this.inv=e,this.slots=s}}class no extends da{prot=Ii.UPDATE_INV_PARTIAL;encode(t,e){const{component:s,inv:n}=e;t.p2(s);for(const s of e.slots){const e=n.get(s);t.p1(s),e?(t.p2(e.id+1),e.count>=255?(t.p1(255),t.p4(e.count)):t.p1(e.count)):(t.p2(0),t.p1(0))}}test(t){const{inv:e}=t;let s=0;s+=2;for(const n of t.slots){const t=e.get(n);s+=1,t?(s+=2,t.count>=255?s+=5:s+=1):s+=3}return s}}class io extends da{prot=Ii.UPDATE_INV_STOP_TRANSMIT;encode(t,e){t.p2(e.component)}}class ao extends Ui{energy;priority=Di.LOW;constructor(t){super(),this.energy=t}}class ro extends da{prot=Ii.UPDATE_RUNENERGY;encode(t,e){t.p1(e.energy/100|0)}}class oo extends Ui{kg;priority=Di.LOW;constructor(t){super(),this.kg=t}}class co extends da{prot=Ii.UPDATE_RUNWEIGHT;encode(t,e){t.p2(e.kg)}}class lo extends Ui{stat;exp;level;priority=Di.LOW;constructor(t,e,s){super(),this.stat=t,this.exp=e,this.level=s}}class ho extends da{prot=Ii.UPDATE_STAT;encode(t,e){t.p1(e.stat),t.p4(e.exp/10|0),t.p1(e.level)}}class po extends da{prot=Ii.UPDATE_UID192;encode(t,e){t.p2(e.uid)}}class uo extends da{prot=Ii.UPDATE_ZONE_FULL_FOLLOWS;encode(t,e){t.p1((e.zoneX<<3)-Ws.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-Ws.zoneOrigin(e.originZ))}}class go extends da{prot=Ii.UPDATE_ZONE_PARTIAL_FOLLOWS;encode(t,e){t.p1((e.zoneX<<3)-Ws.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-Ws.zoneOrigin(e.originZ))}}class _o extends da{prot=Ii.UPDATE_ZONE_PARTIAL_ENCLOSED;encode(t,e){t.p1((e.zoneX<<3)-Ws.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-Ws.zoneOrigin(e.originZ)),t.pdata(e.data,0,e.data.length)}test(t){return 2+t.data.length}}class mo extends da{prot=Ii.VARP_LARGE;encode(t,e){t.p2(e.varp),t.p4(e.value)}}class fo extends da{prot=Ii.VARP_SMALL;encode(t,e){t.p2(e.varp),t.p1(e.value)}}class Eo extends Ui{buildArea;level;x;z2;originX;originZ;priority=Di.HIGH;accumulator=0;constructor(t,e,s,n,i,a){super(),this.buildArea=t,this.level=e,this.x=s,this.z=n,this.originX=i,this.originZ=a}}class Oo extends da{static BITS_NEW=35;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=Ii.NPC_INFO;encode(t,e){const s=e.buildArea;this.writeNpcs(t,e),this.writeNewNpcs(t,e);const n=s.extendedInfo;if(n.size>0)for(const e of n){const s=zl.getNpc(e.id);s&&this.writeUpdate(s,t,e.added)}s.reset()}test(t){return Oo.BYTES_LIMIT}writeNpcs(t,e){const s=e.buildArea;t.bits(),t.pBit(8,s.npcs.size);for(const n of s.npcs){const i=zl.getNpc(n);if(!i||i.tele||i.level!==e.level||!Ws.isWithinDistanceSW(e,i,16)||!i.checkLifeCycle(zl.currentTick)){t.pBit(1,1),t.pBit(2,3),s.npcs.delete(n);continue}let a=i.mask>0;const{walkDir:r,runDir:o}=i;let c=0;-1!==o?c=Oo.BITS_RUN:-1!==r?c=Oo.BITS_WALK:a&&(c=Oo.BITS_EXTENDED);const l=a?this.calculateUpdateSize(i,!1):0;(t.bitPos+c+7+24>>>3)+t.pos+(e.accumulator+=l)>this.test(e)&&(a=!1),t.pBit(1,-1!==o||-1!==r||a?1:0),-1!==o?(t.pBit(2,2),t.pBit(3,r),t.pBit(3,o),t.pBit(1,a?1:0)):-1!==r?(t.pBit(2,1),t.pBit(3,r),t.pBit(1,a?1:0)):a&&t.pBit(2,0),a&&s.extendedInfo.add({id:n,added:!1})}}writeNewNpcs(t,e){const s=e.buildArea;for(const n of s.getNearbyNpcs(e.x,e.z,e.originX,e.originZ)){const i=n.mask>0||-1!==n.orientation||-1!==n.faceX||-1!==n.faceZ||-1!==n.faceEntity,a=i?this.calculateUpdateSize(n,!0):0;if((t.bitPos+Oo.BITS_NEW+7+24>>>3)+t.pos+(e.accumulator+=a)>this.test(e))break;t.pBit(13,n.nid),t.pBit(11,n.type),t.pBit(5,n.x-e.x),t.pBit(5,n.z-e.z),t.pBit(1,i?1:0),s.npcs.add(n.nid),i&&s.extendedInfo.add({id:n.nid,added:!0})}s.extendedInfo.size>0&&t.pBit(13,8191),t.bytes()}writeUpdate(t,e,s){let n=t.mask;if(!s||-1===t.orientation&&-1===t.faceX&&-1==t.faceZ||(n|=bl.FACE_COORD),s&&-1!==t.faceEntity&&(n|=bl.FACE_ENTITY),e.p1(n),n&bl.ANIM&&(e.p2(t.animId),e.p1(t.animDelay)),n&bl.FACE_ENTITY&&(-1!==t.faceEntity&&(t.alreadyFacedEntity=!0),e.p2(t.faceEntity)),n&bl.SAY&&e.pjstr(t.chat??''),n&bl.DAMAGE&&(e.p1(t.damageTaken),e.p1(t.damageType),e.p1(t.levels[le.HITPOINTS]),e.p1(t.baseLevels[le.HITPOINTS])),n&bl.CHANGE_TYPE&&e.p2(t.type),n&bl.SPOTANIM&&(e.p2(t.graphicId),e.p2(t.graphicHeight),e.p2(t.graphicDelay)),n&bl.FACE_COORD)if(-1!==t.faceX&&(t.alreadyFacedCoord=!0),s&&-1!=t.faceX)e.p2(t.faceX),e.p2(t.faceZ);else if(s&&-1!=t.orientation){const s=Ws.moveX(t.x,t.orientation),n=Ws.moveZ(t.z,t.orientation);e.p2(2*s+1),e.p2(2*n+1)}else e.p2(t.faceX),e.p2(t.faceZ)}calculateUpdateSize(t,e){let s=0,n=t.mask;return!e||-1===t.orientation&&-1===t.faceX&&-1==t.faceZ||(n|=bl.FACE_COORD),e&&-1!==t.faceEntity&&(n|=bl.FACE_ENTITY),s+=1,n&bl.ANIM&&(s+=3),n&bl.FACE_ENTITY&&(s+=2),n&bl.SAY&&(s+=(t.chat?.length??0)+1),n&bl.DAMAGE&&(s+=4),n&bl.CHANGE_TYPE&&(s+=2),n&bl.SPOTANIM&&(s+=6),n&bl.FACE_COORD&&(s+=4),s}}var Ao=new class{encoders=new Map;bind(t,e){if(this.encoders.has(t))throw new Error(`[ServerProtRepository] Already defines a ${t.name}.`);this.encoders.set(t,e)}constructor(){this.bind(ya,new Sa),this.bind(va,new Ca),this.bind(wa,new Ra),this.bind(ba,new Ua),this.bind(Da,new Ma),this.bind(Ea,new Oa),this.bind(Aa,new Ta),this.bind(Ia,new Na),this.bind(Pa,new La),this.bind(ka,new xa),this.bind(Ba,new Fa),this.bind(Ki,new Ha),this.bind(Mi,new Ga),this.bind(ua,new pa),this.bind(Wa,new za),this.bind(Va,new Ya),this.bind(ja,new Ka),this.bind(Yi,new Za),this.bind($a,new Ja),this.bind(Xa,new qa),this.bind(Qa,new tr),this.bind(er,new sr),this.bind(nr,new ir),this.bind(ar,new rr),this.bind(or,new cr),this.bind(lr,new hr),this.bind(dr,new pr),this.bind(ur,new gr),this.bind(_r,new mr),this.bind(Zi,new fr),this.bind(sa,new Ar),this.bind(la,new Tr),this.bind(na,new Ir),this.bind(ha,new Nr),this.bind(Pr,new Lr),this.bind(aa,new yr),this.bind(ia,new Sr),this.bind($i,new vr),this.bind(Rr,new wr),this.bind(Vi,new br),this.bind(zi,new Ur),this.bind(Eo,new Oo),this.bind(ea,new Dr),this.bind(oa,new Mr),this.bind(ra,new kr),this.bind(ca,new xr),this.bind(Br,new Fr),this.bind(ga,new _a),this.bind(ma,new fa),this.bind(xi,new Hr),this.bind(Bi,new Gr),this.bind(Wr,new zr),this.bind(Vr,new Yr),this.bind(jr,new Kr),this.bind(Fi,new Zr),this.bind(ji,new $r),this.bind(Jr,new Xr),this.bind(qr,new Qr),this.bind(to,new eo),this.bind(so,new no),this.bind(Hi,new io),this.bind(ao,new ro),this.bind(oo,new co),this.bind(lo,new ho),this.bind(ki,new po),this.bind(qi,new uo),this.bind(Xi,new _o),this.bind(Qi,new go),this.bind(Wi,new mo),this.bind(Gi,new fo)}getEncoder(t){return this.encoders.get(t.constructor)}getZoneEncoder(t){return this.encoders.get(t.constructor)}};class To extends Array{capacity;onFilled;constructor(t,e){super(),this.capacity=t,this.onFilled=e}*stack(t){const e=this[t];if(void 0!==e)for(let t=0;t<e.length;t++)yield e[t]}*all(t=!1){for(let e=0;e<this.length;e++){const s=this[e];if(void 0!==s)if(t)for(let t=0;t<s.length;t++)yield s[t];else for(let t=0;t<s.length;t++)yield s[t]}}addLast(t,e,s=!1){this.check(t,s),this[t]?.push(e)}addFirst(t,e,s=!1){this.check(t,s),this[t]?.unshift(e)}sortStack(t,e=!1){const s=this.nextTopStack(t);if(void 0===s)return;const n=this[t];void 0!==n&&n[0]!==s&&(this.remove(t,s),this.addFirst(t,s,e))}remove(t,e){const s=this[t];if(void 0===s)return;const n=s.indexOf(e);-1!==n&&s.splice(n,1)}contains(t,e){const s=this[t];return void 0!==s&&-1!==s.indexOf(e)}check(t,e){if(void 0===this[t]&&(this[t]=[]),!e&&this.total===this.capacity){const t=this.nextBottomAll();void 0!==t&&this.onFilled(t)}}get total(){let t=0;for(let e=0;e<this.length;e++){const s=this[e];void 0!==s&&(t+=s.length)}return t}}class Io extends To{nextTopStack(t){const e=this[t];if(void 0===e)return;let s,n=-99999999;for(const t of e){const e=t.lifecycle;e>n&&(n=e,s=t)}return s}nextBottomAll(){let t,e=Number.POSITIVE_INFINITY;for(let s=0;s<this.length;s++){const n=this[s];if(void 0!==n)for(const s of n){if(0===e)break;if(s.lifecycle!==zn.DESPAWN)continue;const n=s.lifecycle;n<e&&(e=n,t=s)}}return t}}class No extends To{nextTopStack(t){const e=this[t];if(void 0===e)return;let s,n=-99999999;for(const t of e){const e=_e.get(t.type);let i=e.cost;e.stackable&&(i*=t.count+1),i+=t.lifecycle,i>n&&(n=i,s=t)}return s}nextBottomAll(){let t,e=Number.POSITIVE_INFINITY;for(let s=0;s<this.length;s++){const n=this[s];if(void 0!==n)for(const s of n){if(0===e)break;if(s.lifecycle!==zn.DESPAWN)continue;const n=_e.get(s.type);let i=n.cost;n.stackable&&(i*=s.count+1),i+=s.lifecycle,i<e&&(e=i,t=s)}}return t}}class Po{static SIZE=64;static LOCS=this.SIZE<<2;static OBJS=1+(this.SIZE<<1);index;x;z;level;players;npcs;locs;objs;events;shared=null;totalLocs=0;totalObjs=0;constructor(t){this.index=t;const e=yo.unpackIndex(t);this.x=e.x>>3,this.z=e.z>>3,this.level=e.level,this.events=new Set,this.players=new Set,this.npcs=new Set,this.locs=new Io(Po.LOCS,(t=>zl.removeLoc(t,100))),this.objs=new No(Po.OBJS,(t=>zl.removeObj(t,100)))}enter(t){t instanceof bo?(this.players.add(t.uid),zl.getZoneGrid(this.level).flag(this.x,this.z)):t instanceof bl&&this.npcs.add(t.nid)}leave(t){t instanceof bo?(this.players.delete(t.uid),0===this.players.size&&zl.getZoneGrid(this.level).unflag(this.x,this.z)):t instanceof bl&&this.npcs.delete(t.nid)}tick(t){let e;do{e=!1;for(const s of this.getAllObjsUnsafe())s.updateLifeCycle(t)&&s.lastLifecycleTick!==t&&(s.lifecycle===zn.DESPAWN?-1!==s.receiverId?zl.revealObj(s):(zl.removeObj(s,0),e=!0):s.lifecycle===zn.RESPAWN&&(zl.addObj(s,-1,0),e=!0));for(const s of this.getAllLocsUnsafe())s.updateLifeCycle(t)&&s.lastLifecycleTick!==t&&(s.lifecycle===zn.DESPAWN?(zl.removeLoc(s,0),e=!0):s.lifecycle===zn.RESPAWN&&(zl.addLoc(s,0),e=!0))}while(e)}computeShared(){this.shared=null;let t=0;const e=[];for(const s of this.events.values()){if(s.type!==Ji.ENCLOSED)continue;const n=Ao.getZoneEncoder(s.message);if(void 0===n)continue;const i=n.enclose(s.message);e.push(i),t+=i.length}if(0===e.length||0===t)return;const s=new Uint8Array(t);let n=0;for(const t of e)s.set(t,n),n+=t.length;this.shared=s}writeFullFollows(t){t.write(new qi(this.x,this.z,t.originX,t.originZ));for(const e of this.getAllObjsUnsafe(!0))-1!==e.receiverId&&e.receiverId!==t.pid||(t.write(new Qi(this.x,this.z,t.originX,t.originZ)),(e.lifecycle===zn.DESPAWN&&e.checkLifeCycle(zl.currentTick)||e.lifecycle===zn.RESPAWN&&e.checkLifeCycle(zl.currentTick))&&t.write(new ea(Ws.packZoneCoord(e.x,e.z),e.type,e.count)));for(const e of this.getAllLocsUnsafe(!0))e.lifecycle===zn.DESPAWN&&e.checkLifeCycle(zl.currentTick)?t.write(new sa(Ws.packZoneCoord(e.x,e.z),e.type,e.shape,e.angle)):e.lifecycle!==zn.RESPAWN||e.checkLifeCycle(zl.currentTick)||t.write(new na(Ws.packZoneCoord(e.x,e.z),e.shape,e.angle))}writePartialEncloses(t){this.shared&&t.write(new Xi(this.x,this.z,t.originX,t.originZ,this.shared))}writePartialFollows(t){if(0!==this.events.size){t.write(new Qi(this.x,this.z,t.originX,t.originZ));for(const e of this.events)e.type===Ji.FOLLOWS&&(-1!==e.receiverId&&e.receiverId!==t.pid||t.write(e.message))}}reset(){this.events.clear()}addStaticLoc(t){const e=Ws.packZoneCoord(t.x,t.z);this.locs.addLast(e,t,!0),this.totalLocs++,this.locs.sortStack(e,!0)}addStaticObj(t){const e=Ws.packZoneCoord(t.x,t.z);this.objs.addLast(e,t,!0),this.totalObjs++,this.objs.sortStack(e,!0)}addLoc(t){const e=Ws.packZoneCoord(t.x,t.z);t.lifecycle===zn.DESPAWN&&(this.locs.addLast(e,t),this.totalLocs++),this.locs.sortStack(e),this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new sa(e,t.type,t.shape,t.angle)})}removeLoc(t){const e=Ws.packZoneCoord(t.x,t.z);t.lifecycle===zn.DESPAWN&&(this.locs.remove(e,t),this.totalLocs--),this.locs.sortStack(e),this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new na(e,t.shape,t.angle)})}getLoc(t,e,s){for(const n of this.getLocsSafe(Ws.packZoneCoord(t,e)))if(n.type===s)return n;return null}mergeLoc(t,e,s,n,i,a,r,o){this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new ha(t.x,t.z,t.shape,t.angle,t.type,s,n,e.pid,a,i,o,r)})}animLoc(t,e){this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new la(Ws.packZoneCoord(t.x,t.z),t.shape,t.angle,e)})}addObj(t,e){const s=Ws.packZoneCoord(t.x,t.z);t.lifecycle===zn.DESPAWN&&(this.objs.addLast(s,t),this.totalObjs++),this.objs.sortStack(s),t.lifecycle===zn.RESPAWN||-1===t.receiverId?this.events.add({type:Ji.ENCLOSED,receiverId:e,message:new ea(s,t.type,t.count)}):t.lifecycle===zn.DESPAWN&&this.events.add({type:Ji.FOLLOWS,receiverId:e,message:new ea(s,t.type,t.count)})}revealObj(t,e){t.receiverId=-1,t.reveal=-1;const s=Ws.packZoneCoord(t.x,t.z);this.objs.sortStack(s),this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new ca(s,t.type,t.count,e)})}changeObj(t,e,s,n){t.count=n;const i=Ws.packZoneCoord(t.x,t.z);this.objs.sortStack(i),this.events.add({type:Ji.FOLLOWS,receiverId:e,message:new oa(i,t.type,s,n)})}removeObj(t){const e=Ws.packZoneCoord(t.x,t.z);t.lifecycle===zn.DESPAWN&&(this.objs.remove(e,t),this.totalObjs--),this.objs.sortStack(e),t.lifecycle===zn.RESPAWN||-1===t.receiverId?this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new ra(e,t.type)}):t.lifecycle===zn.DESPAWN&&this.events.add({type:Ji.FOLLOWS,receiverId:-1,message:new ra(e,t.type)})}animMap(t,e,s,n,i){this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new aa(Ws.packZoneCoord(t,e),s,n,i)})}mapProjAnim(t,e,s,n,i,a,r,o,c,l,h,d){this.events.add({type:Ji.ENCLOSED,receiverId:-1,message:new ia(t,e,s,n,i,a,r,o,c,l,h,d)})}getObj(t,e,s,n){for(const i of this.getObjsSafe(Ws.packZoneCoord(t,e)))if((-1===i.receiverId||i.receiverId===n)&&i.type===s)return i;return null}*getAllPlayersSafe(){for(const t of this.players){const e=zl.getPlayerByUid(t);e&&e.checkLifeCycle(zl.currentTick)&&(yield e)}}*getAllNpcsSafe(){for(const t of this.npcs){const e=zl.getNpc(t);e&&e.checkLifeCycle(zl.currentTick)&&(yield e)}}*getAllObjsSafe(){for(const t of this.objs.all())t.checkLifeCycle(zl.currentTick)&&(yield t)}*getObjsSafe(t){for(const e of this.objs.stack(t))e.checkLifeCycle(zl.currentTick)&&(yield e)}*getObjsUnsafe(t){yield*this.objs.stack(t)}*getAllObjsUnsafe(t=!1){yield*this.objs.all(t)}*getAllLocsSafe(){for(const t of this.locs.all())t.checkLifeCycle(zl.currentTick)&&(yield t)}*getLocsSafe(t){for(const e of this.locs.stack(t))e.checkLifeCycle(zl.currentTick)&&(yield e)}*getLocsUnsafe(t){yield*this.locs.stack(t)}*getAllLocsUnsafe(t=!1){yield*this.locs.all(t)}}class Lo{static GRID_SIZE=2048;static INT_BITS=5;static INT_BITS_FLAG=(1<<this.INT_BITS)-1;static DEFAULT_GRID_SIZE=this.GRID_SIZE*(this.GRID_SIZE>>this.INT_BITS);grid;constructor(t=Lo.DEFAULT_GRID_SIZE){this.grid=new Int32Array(t)}index(t,e){return t<<Lo.INT_BITS|e>>>Lo.INT_BITS}flag(t,e){this.grid[this.index(t,e)]|=1<<(e&Lo.INT_BITS_FLAG)}unflag(t,e){this.grid[this.index(t,e)]&=~(1<<(e&Lo.INT_BITS_FLAG))}isFlagged(t,e,s){const n=Math.max(0,t-s),i=Math.min(Lo.GRID_SIZE-1,t+s),a=Math.max(0,e-s),r=Math.min(Lo.GRID_SIZE-1,e+s),o=Lo.INT_BITS_FLAG,c=a&~o,l=r>>>Lo.INT_BITS<<Lo.INT_BITS;for(let t=n;t<=i;t++)for(let e=c;e<=l;e+=32){const s=this.index(t,e),n=this.grid[s];let i=n;e+o>r&&(i=n&(1<<r-e+1)-1);let c=i;if(e<a&&(c=i>>>a-e),0!==c)return!0}return!1}}class yo{static zoneIndex(t,e,s){return t>>3&2047|(e>>3&2047)<<11|(3&s)<<22}static unpackIndex(t){return{x:(2047&t)<<3,z:(t>>11&2047)<<3,level:t>>22}}zones;grids;constructor(){this.zones=new Map,this.grids=new Map}zone(t,e,s){const n=yo.zoneIndex(t,e,s);let i=this.zones.get(n);return void 0===i&&(i=new Po(n),this.zones.set(n,i)),i}zoneByIndex(t){let e=this.zones.get(t);return void 0===e&&(e=new Po(t),this.zones.set(t,e)),e}grid(t){let e=this.grids.get(t);return void 0===e&&(e=new Lo,this.grids.set(t,e)),e}zoneCount(){return this.zones.size}locCount(){let t=0;for(const e of this.zones.values())t+=e.totalLocs;return t}objCount(){let t=0;for(const e of this.zones.values())t+=e.totalObjs;return t}}class So{static INTERVAL=10;static PREFERRED_PLAYERS=250;static PREFERRED_NPCS=255;static PREFERRED_VIEW_DISTANCE=16;npcs;players;loadedZones;activeZones;extendedInfo;appearances;forceViewDistance=!1;viewDistance=So.PREFERRED_VIEW_DISTANCE;lastResize=0;constructor(){this.npcs=new Set,this.players=new Set,this.loadedZones=new Set,this.activeZones=new Set,this.extendedInfo=new Set,this.appearances=new Map}resize(){if(!this.forceViewDistance)return this.players.size>=So.PREFERRED_PLAYERS?(this.viewDistance>1&&this.viewDistance--,void(this.lastResize=0)):void(++this.lastResize>=So.INTERVAL&&(this.viewDistance<So.PREFERRED_VIEW_DISTANCE?this.viewDistance++:this.lastResize=0))}reset(){this.extendedInfo.clear()}hasAppearance(t,e){const s=this.appearances.get(t);return void 0!==s&&s===e}saveAppearance(t,e){this.appearances.set(t,e)}*getNearbyPlayers(t,e,s,n,i){t:for(const a of this.proximitySort(e,s,this.activeZones))for(const r of this.getNearby(zl.getZoneIndex(a).getAllPlayersSafe(),e,s,n,i,this.viewDistance)){if(this.players.size>=So.PREFERRED_PLAYERS)break t;this.players.has(r.uid)||r.uid!==t&&(yield r)}}*getNearbyNpcs(t,e,s,n){t:for(const i of this.proximitySort(t,e,this.activeZones))for(const a of this.getNearby(zl.getZoneIndex(i).getAllNpcsSafe(),t,e,s,n,16)){if(this.npcs.size>=So.PREFERRED_NPCS)break t;this.npcs.has(a.nid)||(yield a)}}*getNearby(t,e,s,n,i,a){const r=n-48,o=n+48,c=i+48,l=i-48;for(const n of t)n.x<=r||n.x>=o||n.z>=c||n.z<=l||Ws.isWithinDistanceSW({x:e,z:s},n,a)&&(yield n)}proximitySort(t,e,s){return Array.from(s.values()).map((s=>this.zoneToDistance(s,t,e))).sort(((t,e)=>t.distance-e.distance)).map((({zoneIndex:t})=>t))}zoneToDistance(t,e,s){const n=yo.unpackIndex(t);return{zoneIndex:t,distance:Math.abs(n.x-e)+Math.abs(n.z-s)}}}function vo(t){for(let e=98;e>=0;e--)if(t>=wo[e])return Math.min(e+2,99);return 1}function Co(t){return wo[t-2]}var wo=new Int32Array(99),Ro=0;for(let t=0;t<99;t++){const e=t+1;Ro+=Math.floor(e+300*Math.pow(2,e/7)),wo[t]=10*Math.floor(Ro/4)}class bo extends Si{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static SKILLS=['attack','defence','strength','hitpoints','ranged','prayer','magic','cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing','mining','herblore','agility','thieving','stat18','stat19','runecraft'];static DESIGN_BODY_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];save(){const t=ut.alloc(1);t.p2(8196),t.p2(3),t.p2(this.x),t.p2(this.z),t.p1(this.level);for(let e=0;e<7;e++)t.p1(this.body[e]);for(let e=0;e<5;e++)t.p1(this.colors[e]);t.p1(this.gender),t.p2(this.runenergy),t.p4(this.playtime);for(let e=0;e<21;e++)t.p4(this.stats[e]),t.p1(this.levels[e]);t.p2(this.vars.length);for(let e=0;e<this.vars.length;e++){Ae.get(e).scope===Ae.SCOPE_PERM?t.p4(this.vars[e]):t.p4(0)}let e=0;const s=t.pos;t.p1(0);for(const[s,n]of this.invs){if($t.get(s).scope===$t.SCOPE_PERM){t.p2(s);for(let e=0;e<n.capacity;e++){const s=n.get(e);s?(t.p2(s.id+1),s.count>=255?(t.p1(255),t.p4(s.count)):t.p1(s.count)):t.p2(0)}e++}}t.data[s]=e,t.p1(this.afkZones.length);for(let e=0;e<this.afkZones.length;e++)t.p4(this.afkZones[e]);t.p2(this.lastAfkZone),t.p4(ut.getcrc(t.data,0,t.pos));const n=ot(this.username37);return t.save('data/players/'+n+'.sav'),t}username;username37;displayName;body;colors;gender;runenergy=1e4;lastRunEnergy=-1;runweight;playtime;stats=new Int32Array(21);levels=new Uint8Array(21);vars;varsString;invs=new Map;pid=-1;uid=-1;lowMemory=!1;combatLevel=3;headicons=0;appearance=null;lastAppearance=0;baseLevels=new Uint8Array(21);lastStats=new Int32Array(21);lastLevels=new Uint8Array(21);originX=-1;originZ=-1;buildArea=new So;lastMovement=0;basReadyAnim=-1;basTurnOnSpot=-1;basWalkForward=-1;basWalkBackward=-1;basWalkLeft=-1;basWalkRight=-1;basRunning=-1;animProtect=0;logoutRequested=!1;invListeners=[];allowDesign=!1;afkEventReady=!1;interactWalkTrigger=!1;highPriorityOut=new vi;lowPriorityOut=new vi;lastResponse=-1;messageColor=null;messageEffect=null;messageType=null;message=null;delay=0;queue=new dt;weakQueue=new dt;engineQueue=new dt;cameraPackets=new dt;timers=new Map;modalState=0;modalTop=-1;lastModalTop=-1;modalBottom=-1;lastModalBottom=-1;modalSidebar=-1;lastModalSidebar=-1;refreshModalClose=!1;refreshModal=!1;modalSticky=-1;overlaySide=new Array(14).fill(-1);receivedFirstClose=!1;protect=!1;activeScript=null;resumeButtons=[];lastItem=-1;lastSlot=-1;lastUseItem=-1;lastUseSlot=-1;lastTargetSlot=-1;lastCom=-1;staffModLevel=0;heroPoints=new Array(16);afkZones=new Int32Array(2);lastAfkZone=0;constructor(t,e){super(0,3094,3106,1,1,zn.FOREVER,ce.NORMAL,ae.NPC,yi.SMART,bo.FACE_COORD,bo.FACE_ENTITY),this.username=t,this.username37=e,this.displayName=ct(t),this.vars=new Int32Array(Ae.count),this.varsString=new Array(Ae.count),this.body=[0,10,18,26,33,36,42],this.colors=[0,0,0,0,0],this.gender=0,this.runenergy=1e4,this.runweight=0,this.playtime=0,this.lastStats.fill(-1),this.lastLevels.fill(-1)}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(t,e){const s=this.heroPoints.findIndex((e=>e&&e.uid===t));if(-1!==s)return void(this.heroPoints[s].points+=e);const n=this.heroPoints.findIndex((t=>t&&-1===t.uid));-1===n||(this.heroPoints[n]={uid:t,points:e})}findHero(){return this.heroPoints.sort(((t,e)=>e.points-t.points)),this.heroPoints[0]?.uid??-1}resetEntity(t){super.resetPathingEntity(),this.repathed=!1,this.protect=!1,this.messageColor=null,this.messageEffect=null,this.messageType=null,this.message=null}onLogin(){this.playerLog('Logging in'),this.write(new Mi),this.write(new ki(this.pid)),this.unsetMapFlag(),this.write(new xi),this.resetHeroPoints(),this.write(new Bi);for(let t=0;t<this.vars.length;t++){const e=Ae.get(t),s=this.vars[t];e.transmit&&this.writeVarp(t,s)}const t=Fe.getByTriggerSpecific(li.LOGIN,-1,-1);t&&this.executeScript(Rl.init(t,this),!0);const e=Fe.getByTriggerSpecific(li.MOVE,-1,-1);if(e){const t=Rl.init(e,this);this.runScript(t,!0)}this.lastStepX=this.x-1,this.lastStepZ=this.z}calculateRunWeight(){this.runweight=0;const t=this.invs.values();for(let e=0;e<this.invs.size;e++){const e=t.next().value;if(!e)continue;const s=$t.get(e.type);if(s&&s.runweight)for(let t=0;t<e.capacity;t++){const s=e.get(t);if(!s)continue;const n=_e.get(s.id);n&&!n.stackable&&(this.runweight+=n.weight*s.count)}}}playerLog(t,...e){}processEngineQueue(){for(let t=this.engineQueue.head();null!==t;t=this.engineQueue.next()){const e=t.delay--;if(this.canAccess()&&e<=0){const e=Rl.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}updateMovement(t=!0){if(this.containsModalInterface())return this.recoverEnergy(!1),!1;if(t&&this.target instanceof Si&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),this.hasWaypoints()&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const t=Fe.get(this.walktrigger);if(this.walktrigger=-1,t){const e=Rl.init(t,this);this.runScript(e,!0)}}this.moveSpeed!==Li.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed(),-1===this.basRunning?this.moveSpeed=Li.WALK:this.getVar(Ae.TEMP_RUN)&&(this.moveSpeed=Li.RUN)),super.processMovement()||this.setVar(Ae.TEMP_RUN,0);const e=this.lastX!==this.x||this.lastZ!==this.z;if(e){const t=Fe.getByTriggerSpecific(li.MOVE,-1,-1);t&&this.runScript(Rl.init(t,this),!0)}return this.drainEnergy(e),this.recoverEnergy(e),0===this.runenergy&&(this.setVar(Ae.PLAYER_RUN,0),this.setVar(Ae.TEMP_RUN,0)),e}drainEnergy(t){if(t&&0!==this.stepsTaken&&!this.delayed()&&this.moveSpeed===Li.RUN&&this.stepsTaken>1){const t=Math.floor(this.runweight/1e3),e=67+67*Math.min(Math.max(t,0),64)/64|0;this.runenergy=Math.max(this.runenergy-e,0)}}recoverEnergy(t){if(!this.delayed()&&(!t||this.moveSpeed!==Li.RUN)&&this.runenergy<1e4){const t=8+(this.baseLevels[js.AGILITY]/9|0);this.runenergy=Math.min(this.runenergy+t,1e4)}}blockWalkFlag(){return vs.PLAYER}defaultMoveSpeed(){return this.getVar(Ae.PLAYER_RUN)?Li.RUN:Li.WALK}closeSticky(){if(-1!==this.modalSticky){const t=Fe.getByTrigger(li.IF_CLOSE,this.modalSticky);t&&this.enqueueScript(t,1),this.modalSticky=-1,this.write(new Fi(-1))}}closeModal(){if(this.receivedFirstClose){if(this.weakQueue.clear(),this.delayed()||(this.protect=!1),0!==this.modalState){if(-1!==this.modalTop){const t=Fe.getByTrigger(li.IF_CLOSE,this.modalTop);t&&this.enqueueScript(t,1),this.modalTop=-1}if(-1!==this.modalBottom){const t=Fe.getByTrigger(li.IF_CLOSE,this.modalBottom);t&&this.enqueueScript(t,1),this.modalBottom=-1}if(-1!==this.modalSidebar){const t=Fe.getByTrigger(li.IF_CLOSE,this.modalSidebar);t&&this.enqueueScript(t,1),this.modalSidebar=-1}this.modalState=0,this.refreshModalClose=!0}}else this.receivedFirstClose=!0}delayed(){return this.delay>0}containsModalInterface(){return!(1&~this.modalState&&2&~this.modalState&&16&~this.modalState)}busy(){return this.delayed()||this.containsModalInterface()}canAccess(){return!this.protect&&!this.busy()}enqueueScript(t,e=0,s=0,n=[]){const i=new Ai(e,t,n,s);1===e?(i.delay=0,this.engineQueue.addTail(i)):2===e?this.weakQueue.addTail(i):this.queue.addTail(i)}processQueues(){let t=!1;for(let e=this.queue.head();null!==e;e=this.queue.next())if(3===e.type){t=!0;break}t&&this.closeModal(),this.processQueue(),this.processWeakQueue()}processQueue(){for(let t=this.queue.head();null!==t;t=this.queue.next()){3===t.type&&this.closeModal();const e=t.delay--;if(this.canAccess()&&e<=0){const e=Rl.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}processWeakQueue(){for(let t=this.weakQueue.head();null!==t;t=this.weakQueue.next()){const e=t.delay--;if(this.canAccess()&&e<=0){const e=Rl.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}setTimer(t,e,s=[],n){const i=e.id,a={type:t,script:e,args:s,interval:n,clock:n};this.timers.set(i,a)}clearTimer(t){this.timers.delete(t)}processTimers(t){for(const e of this.timers.values())if(t===e.type&&--e.clock<=0&&(1===e.type||this.canAccess())){e.clock=e.interval;const t=Rl.init(e.script,this,null,e.args);this.runScript(t,0===e.type)}}stopAction(){this.clearPendingAction(),this.unsetMapFlag()}clearPendingAction(){this.clearInteraction(),this.closeModal()}hasInteraction(){return null!==this.target}getOpTrigger(){if(!this.target)return null;let t=-1,e=-1;if(this.target instanceof bl||this.target instanceof ei||this.target instanceof jn){const s=this.target instanceof bl?he.get(this.target.type):this.target instanceof ei?ee.get(this.target.type):_e.get(this.target.type);t=s.id,e=s.category}return-1!==this.targetSubject.type&&(t=this.targetSubject.type),-1!==this.targetSubject.com&&(t=this.targetSubject.com),Fe.getByTrigger(this.targetOp+7,t,e)??null}getApTrigger(){if(!this.target)return null;let t=-1,e=-1;if(this.target instanceof bl||this.target instanceof ei||this.target instanceof jn){const s=this.target instanceof bl?he.get(this.target.type):this.target instanceof ei?ee.get(this.target.type):_e.get(this.target.type);t=s.id,e=s.category}return-1!==this.targetSubject.type&&(t=this.targetSubject.type),-1!==this.targetSubject.com&&(t=this.targetSubject.com),Fe.getByTrigger(this.targetOp,t,e)??null}processInteraction(){if(null===this.target||!this.canAccess())return void this.updateMovement();if(this.target.level!==this.level)return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof bl&&(void 0===zl.getNpc(this.target.nid)||this.target.delayed()))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof bl&&-1!==this.targetSubject.type&&null===zl.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof jn&&null===zl.getObj(this.target.x,this.target.z,this.level,this.target.type,this.pid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof ei&&null===zl.getLoc(this.target.x,this.target.z,this.level,this.target.type))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof bo&&null===zl.getPlayerByUid(this.target.uid))return this.clearInteraction(),void this.unsetMapFlag();if(this.targetOp===li.APPLAYER3||this.targetOp===li.OPPLAYER3){return void(this.updateMovement(!1)&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=zl.currentTick+1))}const t=this.getOpTrigger(),e=this.getApTrigger();if(t&&this.target instanceof Si&&this.inOperableDistance(this.target)){const e=this.target;this.target=null,this.executeScript(Rl.init(t,this,e),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(e&&this.inApproachDistance(this.apRange,this.target)){const t=this.target;this.target=null,this.executeScript(Rl.init(e,this,t),!0),this.apRangeCalled?this.target=t:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if(this.target instanceof Si&&this.inOperableDistance(this.target)){if(ge.NODE_DEBUG&&!t&&!e){let t='_';this.target instanceof bl?t=-1!==this.targetSubject.com&&this.targetOp===li.APNPCT||this.targetOp===li.OPNPCT?Zt.get(this.targetSubject.com)?.comName??this.targetSubject.toString():he.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof ei?t=ee.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof jn?t=_e.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===li.APNPCT||this.targetOp===li.APPLAYERT||this.targetOp===li.APLOCT||this.targetOp===li.APOBJT?t=Zt.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(t=_e.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${li[this.targetOp+7].toLowerCase()},${t}]`)}this.target=null,this.messageGame('Nothing interesting happens.'),this.interacted=!0,this.clearWaypoints()}const s=this.updateMovement();if(s&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=zl.currentTick+1),this.target&&(!this.interacted||this.apRangeCalled))if(this.interacted=!1,t&&(this.target instanceof Si||!s)&&this.inOperableDistance(this.target)){const e=this.target;this.target=null,this.executeScript(Rl.init(t,this,e),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(e&&this.inApproachDistance(this.apRange,this.target)){this.apRangeCalled=!1;const t=this.target;this.target=null,this.executeScript(Rl.init(e,this,t),!0),this.apRangeCalled?this.target=t:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if((this.target instanceof Si||!s)&&this.inOperableDistance(this.target)){if(!ge.NODE_PRODUCTION&&!t&&!e){let t='_';this.target instanceof bl?t=he.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof ei?t=ee.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof jn?t=_e.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===li.APNPCT||this.targetOp===li.APPLAYERT||this.targetOp===li.APLOCT||this.targetOp===li.APOBJT?t=Zt.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(t=_e.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${li[this.targetOp+7].toLowerCase()},${t}]`)}this.target=null,this.messageGame('Nothing interesting happens.'),this.interacted=!0,this.clearWaypoints()}if(!this.interactWalkTrigger&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const t=Fe.get(this.walktrigger);if(this.walktrigger=-1,t){const e=Rl.init(t,this);this.interactWalkTrigger=!0,this.unsetMapFlag(),this.runScript(e,!0)}}this.interacted||this.hasWaypoints()||s||(this.messageGame("I can't reach that!"),this.clearInteraction()),this.interacted&&!this.apRangeCalled&&null===this.target&&this.clearInteraction()}getAppearanceInSlot(t){let e=-1;return 8===t?e=this.body[0]:11===t?e=this.body[1]:4===t?e=this.body[2]:6===t?e=this.body[3]:9===t?e=this.body[4]:7===t?e=this.body[5]:10===t&&(e=this.body[6]),-1===e?0:256+e}getCombatLevel(){const t=.25*(this.baseLevels[js.DEFENCE]+this.baseLevels[js.HITPOINTS]+Math.floor(this.baseLevels[js.PRAYER]/2)),e=.325*(this.baseLevels[js.ATTACK]+this.baseLevels[js.STRENGTH]),s=.325*(Math.floor(this.baseLevels[js.RANGED]/2)+this.baseLevels[js.RANGED]),n=.325*(Math.floor(this.baseLevels[js.MAGIC]/2)+this.baseLevels[js.MAGIC]);return Math.floor(t+Math.max(e,s,n))}generateAppearance(t){const e=ut.alloc(0);e.p1(this.gender),e.p1(this.headicons);const s=[];let n=this.getInventory(t);n||(n=new Ye($t.WORN,0));for(let t=0;t<n.capacity;t++){const e=n.get(t);if(!e)continue;const i=_e.get(e.id);-1!==i.wearpos2&&-1===s.indexOf(i.wearpos2)&&s.push(i.wearpos2),-1!==i.wearpos3&&-1===s.indexOf(i.wearpos3)&&s.push(i.wearpos3)}for(let t=0;t<12;t++){if(-1!==s.indexOf(t)){e.p1(0);continue}const i=n.get(t);if(i)e.p2(512+i.id);else{const s=this.getAppearanceInSlot(t);s<1?e.p1(0):e.p2(s)}}for(let t=0;t<this.colors.length;t++)e.p1(this.colors[t]);e.p2(this.basReadyAnim),e.p2(this.basTurnOnSpot),e.p2(this.basWalkForward),e.p2(this.basWalkBackward),e.p2(this.basWalkLeft),e.p2(this.basWalkRight),e.p2(this.basRunning),e.p8(this.username37),e.p1(this.combatLevel),this.mask|=bo.APPEARANCE,this.appearance=new Uint8Array(e.pos),e.pos=0,e.gdata(this.appearance,0,this.appearance.length),e.release(),this.lastAppearance=zl.currentTick}getInventoryFromListener(t){if(-1===t.source)return zl.getInventory(t.type);{const e=zl.getPlayerByUid(t.source);return e?e.getInventory(t.type):null}}getInventory(t){if(-1===t)return null;const e=$t.get(t);let s=null;return e?(e.scope===$t.SCOPE_SHARED?s=zl.getInventory(t):(s=this.invs.get(t),s||(s=Ye.fromType(t),this.invs.set(t,s))),s):null}invListenOnCom(t,e,s){if(-1===t)return;if(-1!==this.invListeners.findIndex((s=>s.type===t&&s.com===e)))return;$t.get(t).scope===$t.SCOPE_SHARED&&(s=-1),this.invListeners.push({type:t,com:e,source:s,firstSeen:!0})}invStopListenOnCom(t){const e=this.invListeners.findIndex((e=>e.com===t));-1!==e&&(this.invListeners.splice(e,1),this.write(new Hi(t)))}invGetSlot(t,e){const s=this.getInventory(t);if(!s)throw new Error('invGetSlot: Invalid inventory type: '+t);if(!s.validSlot(e))throw new Error('invGetSlot: Invalid slot: '+e);return s.get(e)}invClear(t){const e=this.getInventory(t);if(!e)throw new Error('invClear: Invalid inventory type: '+t);e.removeAll()}invAdd(t,e,s,n=!0){const i=this.getInventory(t);if(!i)throw new Error('invAdd: Invalid inventory type: '+t);return i.add(e,s,-1,n).completed}invSet(t,e,s,n){const i=this.getInventory(t);if(!i)throw new Error('invSet: Invalid inventory type: '+t);if(!i.validSlot(n))throw new Error('invSet: Invalid slot: '+n);i.set(n,{id:e,count:s})}invDel(t,e,s,n=-1){const i=this.getInventory(t);if(!i)throw new Error('invDel: Invalid inventory type: '+t);if(n<-1||n>=this.invSize(t))throw new Error('invDel: Invalid beginSlot: '+n);return i.remove(e,s,n).completed}invDelSlot(t,e){const s=this.getInventory(t);if(!s)throw new Error('invDelSlot: Invalid inventory type: '+t);if(!s.validSlot(e))throw new Error('invDelSlot: Invalid slot: '+e);s.delete(e)}invSize(t){const e=this.getInventory(t);if(!e)throw new Error('invSize: Invalid inventory type: '+t);return e.capacity}invTotal(t,e){const s=this.getInventory(t);if(!s)throw new Error('invTotal: Invalid inventory type: '+t);return s.getItemCount(e)}invFreeSpace(t){const e=this.getInventory(t);if(!e)throw new Error('invFreeSpace: Invalid inventory type: '+t);return e.freeSlotCount}invItemSpace(t,e,s,n){const i=this.getInventory(t);if(!i)throw new Error('invItemSpace: Invalid inventory type: '+t);const a=_e.get(e);let r=e;if(a.certtemplate>=0&&a.certlink>=0&&(r=a.certlink),a.stackable||r!=e||i.stackType==Ye.ALWAYS_STACK){const n=!0===$t.get(t).stockobj?.includes(e);return 0!=this.invTotal(t,e)||0!=this.invFreeSpace(t)||n?Math.max(0,s-(Ye.STACK_LIMIT-this.invTotal(t,e))):s}return Math.max(0,s-(this.invFreeSpace(t)-(this.invSize(t)-n)))}invMoveToSlot(t,e,s,n){const i=this.getInventory(t);if(!i)throw new Error('invMoveToSlot: Invalid inventory type: '+t);if(!i.validSlot(s))throw new Error('invMoveToSlot: Invalid from slot: '+s);const a=this.getInventory(e);if(!a)throw new Error('invMoveToSlot: Invalid inventory type: '+e);if(!a.validSlot(n))throw new Error('invMoveToSlot: Invalid to slot: '+n);const r=this.invGetSlot(t,s);if(!r)throw new Error(`invMoveToSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${s}`);const o=this.invGetSlot(e,n);this.invSet(e,r.id,r.count,n),o?this.invSet(t,o.id,o.count,s):this.invDelSlot(t,s)}invMoveFromSlot(t,e,s){const n=this.getInventory(t);if(!n)throw new Error('invMoveFromSlot: Invalid inventory type: '+t);if(!this.getInventory(e))throw new Error('invMoveFromSlot: Invalid inventory type: '+e);if(!n.validSlot(s))throw new Error('invMoveFromSlot: Invalid from slot: '+s);const i=this.invGetSlot(t,s);if(!i)throw new Error(`invMoveFromSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${s}`);return{overflow:i.count-this.invAdd(e,i.id,i.count),fromObj:i.id}}invTotalCat(t,e){const s=this.getInventory(t);if(!s)throw new Error('invTotalCat: Invalid inventory type: '+t);return s.itemsFiltered.filter((t=>_e.get(t.id).category==e)).reduce(((t,e)=>t+e.count),0)}_invTotalParam(t,e,s){const n=this.getInventory(t);if(!n)throw new Error('invTotalParam: Invalid inventory type: '+t);const i=de.get(e);let a=0;for(let t=0;t<n.capacity;t++){const e=n.items[t];if(!e||e.id<0||e.id>=_e.count)continue;const r=_e.get(e.id),o=Qt(i.id,r,i.defaultInt);a+=s?e.count*o:o}return a}invTotalParam(t,e){return this._invTotalParam(t,e,!1)}invTotalParamStack(t,e){return this._invTotalParam(t,e,!0)}getVar(t){const e=Ae.get(t);return e.type===mt.STRING?this.varsString[e.id]:this.vars[e.id]}setVar(t,e){const s=Ae.get(t);s.type===mt.STRING&&'string'==typeof e?this.varsString[s.id]=e:'number'==typeof e&&(this.vars[s.id]=e,s.transmit&&this.writeVarp(t,e))}writeVarp(t,e){e>=-128&&e<=127?this.write(new Gi(t,e)):this.write(new Wi(t,e))}addXp(t,e){if(e<0)throw new Error(`Invalid xp parameter for addXp call: Stat was: ${t}, Exp was: ${e}`);if(0==e)return;const s=Number(ge.NODE_XPRATE)||1;this.stats[t]+=e*s,this.stats[t]>2e9&&(this.stats[t]=2e9);const n=this.baseLevels[t];if(this.levels[t]===this.baseLevels[t]&&(this.levels[t]=vo(this.stats[t])),this.baseLevels[t]=vo(this.stats[t]),this.baseLevels[t]>n){this.levels[t]<n&&(this.levels[t]+=1);const e=Fe.getByTriggerSpecific(li.LEVELUP,t,-1);e&&this.enqueueScript(e,1)}this.combatLevel!=this.getCombatLevel()&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance($t.WORN))}setLevel(t,e){e=Math.min(99,Math.max(1,e)),this.baseLevels[t]=e,this.levels[t]=e,this.stats[t]=Co(e),this.getCombatLevel()!=this.combatLevel&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance($t.WORN))}playAnimation(t,e){t>=fe.count||this.animProtect||(-1==t||-1==this.animId||fe.get(t).priority>fe.get(this.animId).priority||0===fe.get(this.animId).priority)&&(this.animId=t,this.animDelay=e,this.mask|=bo.ANIM)}spotanim(t,e,s){this.graphicId=t,this.graphicHeight=e,this.graphicDelay=s,this.mask|=bo.SPOTANIM}applyDamage(t,e){this.damageTaken=t,this.damageType=e;const s=this.levels[js.HITPOINTS];s-t<=0?(this.levels[js.HITPOINTS]=0,this.damageTaken=s):this.levels[js.HITPOINTS]=s-t,this.mask|=bo.DAMAGE}say(t){this.chat=t,this.mask|=bo.SAY}faceSquare(t,e){this.faceX=2*t+1,this.faceZ=2*e+1,this.orientation=Ws.face(this.x,this.z,t,e),this.mask|=bo.FACE_COORD}playSong(t){if(!(t=t.toLowerCase().replaceAll(' ','_')))return;const e=Ri.get(t+'.mid'),s=bi.get(t+'.mid');if(e&&s){const n=e.length;this.write(new zi(t,s,n))}}playJingle(t,e){if(!(e=e.toLowerCase().replaceAll('_',' ')))return;const s=Ri.get(e+'.mid');s&&this.write(new Vi(t,s))}openMainModal(t){4&this.modalState&&(this.write(new Mi),this.modalState&=-5,this.modalSidebar=-1),this.modalState|=1,this.modalTop=t,this.refreshModal=!0}openChat(t){this.modalState|=2,this.modalBottom=t,this.refreshModal=!0}openSideOverlay(t){this.modalState|=4,this.modalSidebar=t,this.refreshModal=!0}openChatSticky(t){this.write(new Fi(t)),this.modalState|=8,this.modalSticky=t}openMainModalSideOverlay(t,e){this.modalState|=1,this.modalTop=t,this.modalState|=4,this.modalSidebar=e,this.refreshModal=!0}exactMove(t,e,s,n,i,a,r){this.exactStartX=t,this.exactStartZ=e,this.exactEndX=s,this.exactEndZ=n,this.exactMoveStart=i,this.exactMoveEnd=a,this.exactMoveDirection=r,this.mask|=bo.EXACT_MOVE,this.x=s,this.z=n,this.lastStepX=this.x-1,this.lastStepZ=this.z}setTab(t,e){this.overlaySide[e]=t,this.write(new Yi(t,e))}isComponentVisible(t){return this.modalTop===t.rootLayer||this.modalBottom===t.rootLayer||this.modalSidebar===t.rootLayer||-1!==this.overlaySide.findIndex((e=>e===t.rootLayer))||this.modalSticky===t.rootLayer}updateAfkZones(){if(this.lastAfkZone=Math.min(1e3,this.lastAfkZone+1),this.withinAfkZone())return;const t=Ws.packCoord(0,this.x-10,this.z-10);this.moveSpeed===Li.INSTANT&&this.jump?this.afkZones[1]=t:this.afkZones[1]=this.afkZones[0],this.afkZones[0]=t,this.lastAfkZone=0}zonesAfk(){return 1e3===this.lastAfkZone}withinAfkZone(){for(let t=0;t<this.afkZones.length;t++){const e=Ws.unpackCoord(this.afkZones[t]);if(Ws.intersects(this.x,this.z,this.width,this.length,e.x,e.z,21,21))return!0}return!1}isInWilderness(){return this.x>=2944&&this.x<3392&&this.z>=3520&&this.z<6400||this.x>=2944&&this.x<3392&&this.z>=9920&&this.z<12800}runScript(t,e=!1,s=!1){if(!s&&e&&(this.protect||this.delayed()))return-1;e&&(t.pointerAdd(ke.ProtectedActivePlayer),this.protect=!0);const n=Rl.execute(t);return e&&(this.protect=!1),t.pointerGet(ke.ProtectedActivePlayer)&&t._activePlayer&&(t.pointerRemove(ke.ProtectedActivePlayer),t._activePlayer.protect=!1),t.pointerGet(ke.ProtectedActivePlayer2)&&t._activePlayer2&&(t.pointerRemove(ke.ProtectedActivePlayer2),t._activePlayer2.protect=!1),n}executeScript(t,e=!1,s=!1){const n=this.runScript(t,e,s);-1!==n&&(n!==ze.FINISHED&&n!==ze.ABORTED?n===ze.WORLD_SUSPENDED?zl.enqueueScript(t,t.popInt()):n===ze.NPC_SUSPENDED?t.activeNpc.activeScript=t:(t.activePlayer.activeScript=t,t.activePlayer.protect=e):t===this.activeScript&&(this.activeScript=null,1&this.modalState||this.closeModal()))}wrappedMessageGame(t){const e=bt.get(1).split(t,456);for(const t of e)this.messageGame(t)}write(t){t.priority===Di.HIGH?this.highPriorityOut.push(t):this.lowPriorityOut.push(t)}unsetMapFlag(){this.clearWaypoints(),this.write(new ji)}hintNpc(t){this.write(new Ki(1,t,0,0,0,0))}hintTile(t,e,s,n){this.write(new Ki(t,0,0,e,s,n))}hintPlayer(t){this.write(new Ki(10,0,t,0,0,0))}stopHint(){this.write(new Ki(-1,0,0,0,0,0))}lastLoginInfo(t,e,s,n){this.write(new Zi(t,e,s,n)),this.modalState|=16}logout(){}terminate(){}messageGame(t){this.write(new $i(t))}}class Uo{index;id;length;static all=[];static byId=[];static REBUILD_GETMAPS=new Uo(4,150,-1);static NO_TIMEOUT=new Uo(6,108,0);static IDLE_TIMER=new Uo(30,70,0);static EVENT_TRACKING=new Uo(34,81,-2);static EVENT_CAMERA_POSITION=new Uo(35,189,6);static ANTICHEAT_OPLOGIC1=new Uo(60,7,4);static ANTICHEAT_OPLOGIC2=new Uo(61,88,4);static ANTICHEAT_OPLOGIC3=new Uo(62,30,3);static ANTICHEAT_OPLOGIC4=new Uo(63,176,2);static ANTICHEAT_OPLOGIC5=new Uo(64,220,0);static ANTICHEAT_OPLOGIC6=new Uo(65,66,4);static ANTICHEAT_OPLOGIC7=new Uo(66,17,4);static ANTICHEAT_OPLOGIC8=new Uo(67,2,2);static ANTICHEAT_OPLOGIC9=new Uo(68,238,1);static ANTICHEAT_CYCLELOGIC1=new Uo(70,233,1);static ANTICHEAT_CYCLELOGIC2=new Uo(71,146,-1);static ANTICHEAT_CYCLELOGIC3=new Uo(74,215,3);static ANTICHEAT_CYCLELOGIC4=new Uo(72,236,4);static ANTICHEAT_CYCLELOGIC5=new Uo(75,85,0);static ANTICHEAT_CYCLELOGIC6=new Uo(73,219,-1);static OPOBJ1=new Uo(80,140,6);static OPOBJ2=new Uo(81,40,6);static OPOBJ3=new Uo(82,200,6);static OPOBJ4=new Uo(83,178,6);static OPOBJ5=new Uo(84,247,6);static OPOBJT=new Uo(88,138,8);static OPOBJU=new Uo(89,239,12);static OPNPC1=new Uo(100,194,2);static OPNPC2=new Uo(101,8,2);static OPNPC3=new Uo(102,27,2);static OPNPC4=new Uo(103,113,2);static OPNPC5=new Uo(104,100,2);static OPNPCT=new Uo(108,134,4);static OPNPCU=new Uo(109,202,8);static OPLOC1=new Uo(120,245,6);static OPLOC2=new Uo(121,172,6);static OPLOC3=new Uo(122,96,6);static OPLOC4=new Uo(123,97,6);static OPLOC5=new Uo(124,116,6);static OPLOCT=new Uo(128,9,8);static OPLOCU=new Uo(129,75,12);static OPPLAYER1=new Uo(140,164,2);static OPPLAYER2=new Uo(141,53,2);static OPPLAYER3=new Uo(142,185,2);static OPPLAYER4=new Uo(143,206,2);static OPPLAYERT=new Uo(148,177,4);static OPPLAYERU=new Uo(149,248,8);static OPHELD1=new Uo(160,195,6);static OPHELD2=new Uo(161,71,6);static OPHELD3=new Uo(162,133,6);static OPHELD4=new Uo(163,157,6);static OPHELD5=new Uo(164,211,6);static OPHELDT=new Uo(168,48,8);static OPHELDU=new Uo(169,130,12);static INV_BUTTON1=new Uo(190,31,6);static INV_BUTTON2=new Uo(191,59,6);static INV_BUTTON3=new Uo(192,212,6);static INV_BUTTON4=new Uo(193,38,6);static INV_BUTTON5=new Uo(194,6,6);static IF_BUTTON=new Uo(200,155,2);static RESUME_PAUSEBUTTON=new Uo(201,235,2);static CLOSE_MODAL=new Uo(202,231,0);static RESUME_P_COUNTDIALOG=new Uo(203,237,4);static TUTORIAL_CLICKSIDE=new Uo(204,175,1);static MOVE_OPCLICK=new Uo(242,93,-1);static BUG_REPORT=new Uo(243,190,10);static MOVE_MINIMAPCLICK=new Uo(244,165,-1);static INV_BUTTOND=new Uo(245,159,6);static IGNORELIST_DEL=new Uo(246,171,8);static IGNORELIST_ADD=new Uo(247,79,8);static IF_PLAYERDESIGN=new Uo(248,52,13);static CHAT_SETMODE=new Uo(249,244,3);static MESSAGE_PRIVATE=new Uo(250,148,-1);static FRIENDLIST_DEL=new Uo(251,11,8);static FRIENDLIST_ADD=new Uo(252,118,8);static CLIENT_CHEAT=new Uo(253,4,-1);static MESSAGE_PUBLIC=new Uo(254,158,-1);static MOVE_GAMECLICK=new Uo(255,181,-1);constructor(t,e,s){this.index=t,this.id=e,this.length=s,Uo.all[t]=this,Uo.byId[e]=this}}class Do{}class Mo{}class ko{id;limit;static CLIENT_EVENT=new ko(0,20);static USER_EVENT=new ko(1,5);constructor(t,e){this.id=t,this.limit=e}}class xo extends Mo{input;category=ko.USER_EVENT;constructor(t){super(),this.input=t}}class Bo extends Do{prot=Uo.CLIENT_CHEAT;decode(t){const e=t.gjstr();return new xo(e)}}class Fo extends Mo{category=ko.USER_EVENT}class Ho extends Do{prot=Uo.CLOSE_MODAL;decode(){return new Fo}}class Go extends Mo{category=ko.CLIENT_EVENT}class Wo extends Do{prot=Uo.IDLE_TIMER;decode(){return new Go}}class zo extends Mo{component;category=ko.USER_EVENT;constructor(t){super(),this.component=t}}class Vo extends Do{prot=Uo.IF_BUTTON;decode(t){const e=t.g2();return new zo(e)}}class Yo extends Mo{gender;idkit;color;category=ko.USER_EVENT;constructor(t,e,s){super(),this.gender=t,this.idkit=e,this.color=s}}class jo extends Do{prot=Uo.IF_PLAYERDESIGN;decode(t){const e=t.g1(),s=[];for(let e=0;e<7;e++)s[e]=t.g1(),255===s[e]&&(s[e]=-1);const n=[];for(let e=0;e<5;e++)n[e]=t.g1();return new Yo(e,s,n)}}class Ko extends Mo{op;obj;slot;component;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.obj=e,this.slot=s,this.component=n}}class Zo extends Do{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new Ko(this.op,e,s,n)}}class $o extends Mo{component;slot;targetSlot;category=ko.USER_EVENT;constructor(t,e,s){super(),this.component=t,this.slot=e,this.targetSlot=s}}class Jo extends Do{prot=Uo.INV_BUTTOND;decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new $o(e,s,n)}}class Xo extends Mo{username;input;category=ko.USER_EVENT;constructor(t,e){super(),this.username=t,this.input=e}}class qo extends Do{prot=Uo.MESSAGE_PRIVATE;decode(t){const e=t.g8(),s=Cr.unpack(t,t.length-8);return new Xo(e,s)}}class Qo extends Mo{input;color;effect;category=ko.USER_EVENT;constructor(t,e,s){super(),this.input=t,this.color=e,this.effect=s}}class tc extends Do{prot=Uo.MESSAGE_PUBLIC;decode(t){const e=t.g1(),s=t.g1(),n=Cr.unpack(t,t.length-2);return new Qo(n,e,s)}}class ec extends Mo{op;obj;slot;component;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.obj=e,this.slot=s,this.component=n}}class sc extends Do{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new ec(this.op,e,s,n)}}class nc extends Mo{obj;slot;component;spellComponent;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.obj=t,this.slot=e,this.component=s,this.spellComponent=n}}class ic extends Do{prot=Uo.OPHELDT;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new nc(e,s,n,i)}}class ac extends Mo{obj;slot;component;useObj;useSlot;useComponent;category=ko.USER_EVENT;constructor(t,e,s,n,i,a){super(),this.obj=t,this.slot=e,this.component=s,this.useObj=n,this.useSlot=i,this.useComponent=a}}class rc extends Do{prot=Uo.OPHELDU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new ac(e,s,n,i,a,r)}}class oc extends Mo{op;x;z2;loc;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.x=e,this.z=s,this.loc=n}}class cc extends Do{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new oc(this.op,e,s,n)}}class lc extends Mo{x;z2;loc;spellComponent;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.x=t,this.z=e,this.loc=s,this.spellComponent=n}}class hc extends Do{prot=Uo.OPLOCT;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new lc(e,s,n,i)}}class dc extends Mo{x;z2;loc;useObj;useSlot;useComponent;category=ko.USER_EVENT;constructor(t,e,s,n,i,a){super(),this.x=t,this.z=e,this.loc=s,this.useObj=n,this.useSlot=i,this.useComponent=a}}class pc extends Do{prot=Uo.OPLOCU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new dc(e,s,n,i,a,r)}}class uc extends Mo{op;nid;category=ko.USER_EVENT;constructor(t,e){super(),this.op=t,this.nid=e}}class gc extends Do{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2();return new uc(this.op,e)}}class _c extends Mo{nid;spellComponent;category=ko.USER_EVENT;constructor(t,e){super(),this.nid=t,this.spellComponent=e}}class mc extends Do{prot=Uo.OPNPCT;decode(t){const e=t.g2(),s=t.g2();return new _c(e,s)}}class fc extends Mo{nid;useObj;useSlot;useComponent;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.nid=t,this.useObj=e,this.useSlot=s,this.useComponent=n}}class Ec extends Do{prot=Uo.OPNPCU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new fc(e,s,n,i)}}class Oc extends Mo{op;x;z2;obj;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.x=e,this.z=s,this.obj=n}}class Ac extends Do{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new Oc(this.op,e,s,n)}}class Tc extends Mo{x;z2;obj;spellComponent;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.x=t,this.z=e,this.obj=s,this.spellComponent=n}}class Ic extends Do{prot=Uo.OPOBJT;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new Tc(e,s,n,i)}}class Nc extends Mo{x;z2;obj;useObj;useSlot;useComponent;category=ko.USER_EVENT;constructor(t,e,s,n,i,a){super(),this.x=t,this.z=e,this.obj=s,this.useObj=n,this.useSlot=i,this.useComponent=a}}class Pc extends Do{prot=Uo.OPOBJU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new Nc(e,s,n,i,a,r)}}class Lc extends Mo{op;pid;category=ko.USER_EVENT;constructor(t,e){super(),this.op=t,this.pid=e}}class yc extends Do{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2();return new Lc(this.op,e)}}class Sc extends Mo{pid;spellComponent;category=ko.USER_EVENT;constructor(t,e){super(),this.pid=t,this.spellComponent=e}}class vc extends Do{prot=Uo.OPPLAYERT;decode(t){const e=t.g2(),s=t.g2();return new Sc(e,s)}}class Cc extends Mo{pid;useObj;useSlot;useComponent;category=ko.USER_EVENT;constructor(t,e,s,n){super(),this.pid=t,this.useObj=e,this.useSlot=s,this.useComponent=n}}class wc extends Do{prot=Uo.OPPLAYERU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new Cc(e,s,n,i)}}class Rc extends Mo{maps;category=ko.USER_EVENT;constructor(t){super(),this.maps=t}}class bc extends Do{prot=Uo.REBUILD_GETMAPS;decode(t){const e=[],s=t.length/3;for(let n=0;n<s;n++){const s=t.g1(),n=t.g1(),i=t.g1();e.push({type:s,x:n,z:i})}return new Rc(e)}}class Uc extends Mo{category=ko.USER_EVENT}class Dc extends Do{prot=Uo.RESUME_PAUSEBUTTON;decode(){return new Uc}}class Mc extends Mo{input;category=ko.USER_EVENT;constructor(t){super(),this.input=t}}class kc extends Do{prot=Uo.RESUME_P_COUNTDIALOG;decode(t){const e=t.g4();return new Mc(e)}}class xc extends Mo{tab;category=ko.USER_EVENT;constructor(t){super(),this.tab=t}}class Bc extends Do{prot=Uo.TUTORIAL_CLICKSIDE;decode(t){const e=t.g1();return new xc(e)}}class Fc{}class Hc extends Fc{handle(t,e){const{op:s,obj:n,slot:i,component:a}=t,r=Zt.get(a);if(void 0===r||!r.inventoryOptions||!r.inventoryOptions.length||!e.isComponentVisible(r))return!1;if(!r.inventoryOptions[s-1])return!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,n))return!1;if(e.delayed())return!1;let l;e.lastItem=n,e.lastSlot=i,l=1===s?li.INV_BUTTON1:2===s?li.INV_BUTTON2:3===s?li.INV_BUTTON3:4===s?li.INV_BUTTON4:li.INV_BUTTON5;const h=Fe.getByTrigger(l,a,-1);if(h){const t=Zt.get(r.rootLayer);e.executeScript(Rl.init(h,e),0==t.overlay)}else ge.NODE_DEBUG&&e.messageGame(`No trigger for [${li.toString(l)},${r.comName}]`);return!0}}class Gc{state=-1;remoteAddress;totalBytesRead=0;totalBytesWritten=0;uniqueId='0';encryptor=null;decryptor=null;in=new Uint8Array(5e3);inOffset=0;inCount=new Uint8Array(256);out=new ut(new Uint8Array(5e3));player=null;constructor(t="127.0.0.1",e=-1){this.remoteAddress=t,this.state=e}send(t){this.totalBytesWritten+=t.length,self.postMessage(t)}close(){setTimeout((()=>{self.close()}),100)}terminate(){self.close()}reset(){this.inOffset=0,this.inCount.fill(0)}writeImmediate(t){this.send(t)}flush(){const t=this.out;0!==t.pos&&(this.send(t.data.subarray(0,t.pos)),t.pos=0)}}class Wc extends Gc{constructor(){super(null,'')}isTCP(){return this.type===Gc.TCP}isWebSocket(){return this.type===Gc.WEBSOCKET}send(t){this.socket}close(){this.socket}terminate(){this.socket}reset(){this.inOffset=0,this.inCount.fill(0)}}function zc(t,e){if('number'==typeof t)return t;if('string'!=typeof t&&'number'!=typeof t)return e;const s=parseInt(t);return isNaN(s)?e:s}class Vc extends Fc{handle(t,e){if(t.input.length>80)return!1;const{input:s}=t,n=s.toLowerCase().split(' '),i=n.shift();if(void 0===i||i.length<=0)return!1;if(e.playerLog('Cheat ran',s),e.staffModLevel>=3)if('reload'!==i||ge.NODE_PRODUCTION)if('rebuild'!==i||ge.NODE_PRODUCTION){if('serverdrop'===i)e.terminate();else if('bench'===i){const t=Date.now();for(let t=0;t<1e5;t++)Je(e.level,e.x,e.z,e.x,e.z+10);const s=Date.now();console.log(`took = ${s-t} ms`)}else if('bots'===i){e.messageGame('Adding bots');for(let t=0;t<2e3;t++){const e=new Il(`bot${t}`,rt(`bot${t}`),new Wc);e.onLogin(),zl.addPlayer(e)}}else if('teleall'===i){e.messageGame('Teleporting all players');for(const t of zl.players){t.closeModal();do{const e=Math.floor(64*Math.random())+3200,s=Math.floor(64*Math.random())+3200;t.teleport(e+Math.floor(64*Math.random())-32,s+Math.floor(64*Math.random())-32,0)}while(os(t.x,t.z,t.level,vs.WALK_BLOCKED))}}else if('moveall'===i){e.messageGame('Moving all players'),console.time('moveall');for(const t of zl.players)t.closeModal(),t.queueWaypoints(Je(t.level,t.x,t.z,32+(t.x>>>6<<6),32+(t.z>>>6<<6)));console.timeEnd('moveall')}else if('speed'===i){if(n.length<1)return e.messageGame('Usage: ::speed <ms>'),!1;const t=zc(n.shift(),20);if(t<20)return e.messageGame('::speed input was too low.'),!1;e.messageGame(`World speed was changed to ${t}ms`),zl.tickRate=t}else if('fly'===i)e.moveStrategy===yi.FLY?e.moveStrategy=yi.SMART:e.moveStrategy=yi.FLY,e.messageGame(`Fly is on? ${e.moveStrategy===yi.FLY}`);else if('naive'===i)e.moveStrategy===yi.NAIVE?e.moveStrategy=yi.SMART:e.moveStrategy=yi.NAIVE,e.messageGame(`Naive is on? ${e.moveStrategy===yi.NAIVE}`);else if('teleto'===i){if(n.length<1)return!1;const t=zl.getPlayerByUsername(n[0]);if(!t)return e.messageGame(`${n[0]} is not logged in.`),!1;e.teleJump(t.x,t.z,t.level)}else if('teleother'===i){if(n.length<1)return!1;const t=zl.getPlayerByUsername(n[0]);if(!t)return e.messageGame(`${n[0]} is not logged in.`),!1;t.teleJump(e.x,e.z,e.level)}else if('setvarother'===i){if(n.length<3)return!1;const t=zl.getPlayerByUsername(n[0]);if(!t)return e.messageGame(`${n[0]} is not logged in.`),!1;const s=Ae.getId(n[1]),i=Math.max(-2147483648,Math.min(zc(n[2],0),2147483647));if(-1===s)return!1;t.setVar(s,i),e.messageGame('set '+n[1]+': to '+i+' on '+t.username)}}else zl.devThread.postMessage({type:'pack'});else{zl.reload();const t=Fe.load('data/pack');e.messageGame(`Reloaded ${t} scripts.`)}if(ge.NODE_ALLOW_CHEATS||e.staffModLevel>=2)if('tele'===i){if(n.length<1)return!1;if('up'===n[0])e.teleJump(e.x,e.z,e.level+1),e.messageGame('::tele '+Ws.formatString(e.level,e.x,e.z,','));else if('down'===n[0])e.teleJump(e.x,e.z,e.level-1),e.messageGame('::tele '+Ws.formatString(e.level,e.x,e.z,','));else if(-1===n[0].indexOf(','))e.teleJump(zc(n[0],3200),zc(n[1],3200),zc(n[2],e.level));else{const t=n[0].split(',');if(5!==t.length)return!1;const s=zc(t[0],0),i=zc(t[1],50),a=zc(t[2],50),r=zc(t[3],0),o=zc(t[4],0);if(s<0||s>3||i<0||i>255||a<0||a>255||r<0||r>63||o<0||o>63)return!1;e.teleJump((i<<6)+r,(a<<6)+o,s)}}else if('setvar'===i){if(n.length<2)return!1;const t=Ae.getId(n[0]),s=Math.max(-2147483648,Math.min(zc(n[1],0),2147483647));if(-1===t)return!1;e.setVar(t,s),e.messageGame('set '+n[0]+': to '+s)}else if('random'===i)e.afkEventReady=!0;else if('minme'===i)for(let t=0;t<bo.SKILLS.length;t++)t===js.HITPOINTS?e.setLevel(t,10):e.setLevel(t,1);else if('setxp'===i){if(n.length<2)return e.messageGame('Usage: ::setxp <stat> <xp>'),!1;const t=bo.SKILLS.indexOf(n[0]);if(-1===t)return e.messageGame(`Unknown stat ${n[0]}`),!1;const s=10*parseInt(n[1]);e.stats[t]=s}else if('setstat'===i){if(n.length<2)return!1;const t=bo.SKILLS.indexOf(n[0]);if(-1===t)return!1;e.setLevel(t,parseInt(n[1]))}else if('advancestat'===i){if(n.length<1)return!1;const t=bo.SKILLS.indexOf(n[0]),s=Math.min(99,Math.max(1,zc(n[1],1)));if(-1===t)return!1;e.setLevel(t,e.baseLevels[t]+s)}else if('getvar'===i){if(n.length<1)return!1;const t=Ae.getId(n[0]);if(-1===t)return!1;const s=e.getVar(t);e.messageGame('get '+n[0]+': '+s)}else if('give'===i){if(n.length<1)return!1;const t=_e.getId(n[0]),s=Math.max(1,Math.min(zc(n[1],1),2147483647));if(-1===t)return!1;e.invAdd($t.INV,t,s,!1)}if((ge.NODE_ALLOW_CHEATS||e.staffModLevel>=1)&&'getcoord'===i&&e.messageGame(Ws.formatString(e.level,e.x,e.z,'_')),ge.NODE_ALLOW_CHEATS||e.staffModLevel>=2){const t=Fe.getByName(`[debugproc,${i}]`);if(!t)return!1;const a=new Array(t.info.parameterTypes.length).fill(-1);for(let e=0;e<t.info.parameterTypes.length;e++){const i=t.info.parameterTypes[e];try{switch(i){case mt.STRING:{const t=n.shift();a[e]=t??'';break}case mt.INT:{const t=n.shift();a[e]=0|parseInt(t??'0',10);break}case mt.OBJ:case mt.NAMEDOBJ:{const t=n.shift();a[e]=_e.getId(t??'');break}case mt.NPC:{const t=n.shift();a[e]=he.getId(t??'');break}case mt.LOC:{const t=n.shift();a[e]=ee.getId(t??'');break}case mt.SEQ:{const t=n.shift();a[e]=fe.getId(t??'');break}case mt.STAT:{const t=n.shift();a[e]=bo.SKILLS.indexOf(t??'');break}case mt.INV:{const t=n.shift();a[e]=$t.getId(t??'');break}case mt.COORD:{const t=s.split('_'),n=parseInt(t[0].slice(6)),i=parseInt(t[1]),r=parseInt(t[2]),o=parseInt(t[3]),c=parseInt(t[4]);a[e]=Ws.packCoord(n,(i<<6)+o,(r<<6)+c);break}case mt.INTERFACE:{const t=n.shift();a[e]=Zt.getId(t??'');break}case mt.SPOTANIM:{const t=n.shift();a[e]=Se.getId(t??'');break}case mt.IDKIT:{const t=n.shift();a[e]=Kt.getId(t??'');break}}}catch(t){return!1}}e.executeScript(Rl.init(t,e,null,a),!1)}return!0}}class Yc extends Fc{handle(t,e){return e.closeModal(),!0}}class jc extends Fc{handle(t,e){return ge.NODE_PRODUCTION&&(e.logout(),e.logoutRequested=!0),!0}}class Kc extends Fc{handle(t,e){const{component:s}=t,n=Zt.get(s);if(void 0===n||!e.isComponentVisible(n))return!1;if(e.lastCom=s,-1!==e.resumeButtons.indexOf(e.lastCom))e.activeScript&&e.executeScript(e.activeScript,!0);else{const t=Zt.get(n.rootLayer),i=Fe.getByTriggerSpecific(li.IF_BUTTON,s,-1);i?e.executeScript(Rl.init(i,e),0==t.overlay):ge.NODE_DEBUG&&e.messageGame(`No trigger for [if_button,${n.comName}]`)}return!0}}class Zc extends Fc{handle(t,e){const{gender:s,idkit:n,color:i}=t;if(!e.allowDesign)return!1;if(s>1)return!1;let a=!0;for(let t=0;t<7;t++){let e=t;if(1===s&&(e+=7),8==e&&-1===n[t])continue;const i=Kt.get(n[t]);if(!i||i.disable||i.type!=e){a=!1;break}}if(!a)return!1;for(let t=0;t<5;t++)if(i[t]>=bo.DESIGN_BODY_COLORS[t].length){a=!1;break}return!!a&&(e.gender=s,e.body=n,e.colors=i,e.generateAppearance($t.WORN),!0)}}class $c extends Fc{handle(t,e){const{component:s,slot:n,targetSlot:i}=t,a=Zt.get(s);if(void 0===a||!e.isComponentVisible(a))return!1;const r=e.invListeners.find((t=>t.com===s));if(!r)return!1;const o=e.getInventoryFromListener(r);if(!(o&&o.validSlot(n)&&o.get(n)&&o.validSlot(i)))return!1;if(e.delayed())return e.write(new so(s,o,n,i)),!1;e.lastSlot=n,e.lastTargetSlot=i;const c=Fe.getByTrigger(li.INV_BUTTOND,s);if(c){const t=Zt.get(a.rootLayer);e.executeScript(Rl.init(c,e),0==t.overlay)}else ge.NODE_DEBUG&&e.messageGame(`No trigger for [inv_buttond,${a.comName}]`);return!0}}class Jc extends Fc{handle(t,e){return!0}}class Xc extends Fc{handle(t,e){const{color:s,effect:n,input:i}=t;if(s<0||s>11||n<0||n>2||i.length>100)return!1;e.messageColor=s,e.messageEffect=n,e.messageType=0;const a=ut.alloc(0);return Cr.pack(a,ye.filter(i)),e.message=new Uint8Array(a.pos),a.pos=0,a.gdata(e.message,0,e.message.length),a.release(),e.mask|=bo.CHAT,!0}}class qc extends Fc{handle(t,e){const{obj:s,slot:n,component:i}=t,a=Zt.get(i);if(void 0===a||!e.isComponentVisible(a))return!1;const r=_e.get(s);if(5!==t.op&&(r.iop&&!r.iop[t.op-1]||!r.iop))return!1;const o=e.invListeners.find((t=>t.com===i));if(!o)return!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(n)||!c.hasAt(n,s))return!1;if(e.delayed())return!1;let l;e.lastItem=s,e.lastSlot=n,e.clearInteraction(),e.closeModal(),l=1===t.op?li.OPHELD1:2===t.op?li.OPHELD2:3===t.op?li.OPHELD3:4===t.op?li.OPHELD4:li.OPHELD5;const h=Fe.getByTrigger(l,r.id,r.category);return h?e.executeScript(Rl.init(h,e),!0):ge.NODE_DEBUG&&e.messageGame(`No trigger for [${li.toString(l)},${r.debugname}]`),!0}}class Qc extends Fc{handle(t,e){const{obj:s,slot:n,component:i,spellComponent:a}=t,r=Zt.get(i);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=Zt.get(i);if(void 0===o||!e.isComponentVisible(o))return e.unsetMapFlag(),!1;const c=e.invListeners.find((t=>t.com===i));if(!c)return e.unsetMapFlag(),!1;const l=e.getInventoryFromListener(c);if(!l||!l.validSlot(n)||!l.hasAt(n,s))return e.unsetMapFlag(),!1;if(e.delayed())return e.unsetMapFlag(),!1;e.lastItem=s,e.lastSlot=n,e.clearInteraction(),e.closeModal();const h=Fe.getByTrigger(li.OPHELDT,a,-1);return h?e.executeScript(Rl.init(h,e),!0):(ge.NODE_DEBUG&&e.messageGame(`No trigger for [opheldt,${o.comName}]`),e.messageGame('Nothing interesting happens.')),!0}}class tl extends Fc{handle(t,e){const{obj:s,slot:n,component:i,useObj:a,useSlot:r,useComponent:o}=t,c=Zt.get(i);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=Zt.get(i);if(void 0===l||!e.isComponentVisible(l))return e.unsetMapFlag(),!1;{const t=e.invListeners.find((t=>t.com===i));if(!t)return e.unsetMapFlag(),!1;const a=e.getInventoryFromListener(t);if(!a||!a.validSlot(n)||!a.hasAt(n,s))return e.unsetMapFlag(),!1}{const t=e.invListeners.find((t=>t.com===o));if(!t)return e.unsetMapFlag(),!1;const s=e.getInventoryFromListener(t);if(!s||!s.validSlot(r)||!s.hasAt(r,a))return e.unsetMapFlag(),!1}if(e.delayed())return e.unsetMapFlag(),!1;e.lastItem=s,e.lastSlot=n,e.lastUseItem=a,e.lastUseSlot=r;const h=_e.get(e.lastItem),d=_e.get(e.lastUseItem);if((h.members||d.members)&&!ge.NODE_MEMBERS)return e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1;let p=Fe.getByTriggerSpecific(li.OPHELDU,h.id,-1);p||(p=Fe.getByTriggerSpecific(li.OPHELDU,d.id,-1),[e.lastItem,e.lastUseItem]=[e.lastUseItem,e.lastItem],[e.lastSlot,e.lastUseSlot]=[e.lastUseSlot,e.lastSlot]);const u=-1!==h.category?_t.get(h.category):null;!p&&u&&(p=Fe.getByTriggerSpecific(li.OPHELDU,-1,u.id));const g=-1!==d.category?_t.get(d.category):null;return!p&&g&&(p=Fe.getByTriggerSpecific(li.OPHELDU,-1,g.id),[e.lastItem,e.lastUseItem]=[e.lastUseItem,e.lastItem],[e.lastSlot,e.lastUseSlot]=[e.lastUseSlot,e.lastSlot]),e.clearInteraction(),e.closeModal(),p?e.executeScript(Rl.init(p,e),!0):(ge.NODE_DEBUG&&e.messageGame(`No trigger for [opheldu,${h.debugname}]`),e.messageGame('Nothing interesting happens.')),!0}}class el extends Fc{handle(t,e){const{x:s,z:n,loc:i}=t;if(e.delayed())return e.unsetMapFlag(),!1;const a=e.originX-52,r=e.originX+52,o=e.originZ+52,c=e.originZ-52;if(s<a||s>r||n<c||n>o)return!1;const l=zl.getLoc(s,n,e.level,i);if(!l)return e.unsetMapFlag(),!1;const h=ee.get(l.type);if(!h.op||!h.op[t.op-1])return e.unsetMapFlag(),!1;let d;return d=1===t.op?li.APLOC1:2===t.op?li.APLOC2:3===t.op?li.APLOC3:4===t.op?li.APLOC4:li.APLOC5,e.clearPendingAction(),e.setInteraction(hi.ENGINE,l,d),e.opcalled=!0,!0}}class sl extends Fc{handle(t,e){const{x:s,z:n,loc:i,spellComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Zt.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.originX-52,c=e.originX+52,l=e.originZ+52,h=e.originZ-52;if(s<o||s>c||n<h||n>l)return e.unsetMapFlag(),!1;const d=zl.getLoc(s,n,e.level,i);return d?(e.clearPendingAction(),e.setInteraction(hi.ENGINE,d,li.APLOCT,{type:d.type,com:a}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class nl extends Fc{handle(t,e){const{x:s,z:n,loc:i,useObj:a,useSlot:r,useComponent:o}=t;if(e.delayed())return e.unsetMapFlag(),!1;const c=Zt.get(o);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=e.originX-52,h=e.originX+52,d=e.originZ+52,p=e.originZ-52;if(s<l||s>h||n<p||n>d)return e.unsetMapFlag(),!1;const u=e.invListeners.find((t=>t.com===o));if(!u)return e.unsetMapFlag(),!1;const g=e.getInventoryFromListener(u);if(!g||!g.validSlot(r)||!g.hasAt(r,a))return e.unsetMapFlag(),!1;const _=zl.getLoc(s,n,e.level,i);return _?_e.get(a).members&&!ge.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=a,e.lastUseSlot=r,e.clearPendingAction(),e.setInteraction(hi.ENGINE,_,li.APLOCU),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class il extends Fc{handle(t,e){const{nid:s}=t;if(e.delayed())return e.unsetMapFlag(),!1;const n=zl.getNpc(s);if(!n||n.delayed())return e.unsetMapFlag(),!1;if(!e.buildArea.npcs.has(n.nid))return e.unsetMapFlag(),!1;const i=he.get(n.type);if(!i.op||!i.op[t.op-1])return e.unsetMapFlag(),!1;let a;return a=1===t.op?li.APNPC1:2===t.op?li.APNPC2:3===t.op?li.APNPC3:4===t.op?li.APNPC4:li.APNPC5,e.clearPendingAction(),e.setInteraction(hi.ENGINE,n,a,{type:n.type,com:-1}),e.opcalled=!0,!0}}class al extends Fc{handle(t,e){const{nid:s,spellComponent:n}=t;if(e.delayed())return e.unsetMapFlag(),!1;const i=Zt.get(n);if(void 0===i||!e.isComponentVisible(i))return e.unsetMapFlag(),!1;const a=zl.getNpc(s);return!a||a.delayed()?(e.unsetMapFlag(),!1):e.buildArea.npcs.has(a.nid)?(e.clearPendingAction(),e.setInteraction(hi.ENGINE,a,li.APNPCT,{type:a.type,com:n}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class rl extends Fc{handle(t,e){const{nid:s,useObj:n,useSlot:i,useComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Zt.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return e.unsetMapFlag(),!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,n))return e.unsetMapFlag(),!1;const l=zl.getNpc(s);return!l||l.delayed()?(e.unsetMapFlag(),!1):e.buildArea.npcs.has(l.nid)?_e.get(n).members&&!ge.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=n,e.lastUseSlot=i,e.clearPendingAction(),e.setInteraction(hi.ENGINE,l,li.APNPCU,{type:l.type,com:-1}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class ol extends Fc{handle(t,e){const{x:s,z:n,obj:i}=t;if(e.delayed())return e.unsetMapFlag(),!1;const a=e.originX-52,r=e.originX+52,o=e.originZ+52,c=e.originZ-52;if(s<a||s>r||n<c||n>o)return e.unsetMapFlag(),!1;const l=zl.getObj(s,n,e.level,i,e.pid);if(!l)return e.unsetMapFlag(),!1;const h=_e.get(l.type);if(1===t.op&&(h.op&&!h.op[0]||!h.op)||4===t.op&&(h.op&&!h.op[3]||!h.op))return e.unsetMapFlag(),!1;let d;return d=1===t.op?li.APOBJ1:2===t.op?li.APOBJ2:3===t.op?li.APOBJ3:4===t.op?li.APOBJ4:li.APOBJ5,e.clearPendingAction(),e.setInteraction(hi.ENGINE,l,d),e.opcalled=!0,!0}}class cl extends Fc{handle(t,e){const{x:s,z:n,obj:i,spellComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Zt.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.originX-52,c=e.originX+52,l=e.originZ+52,h=e.originZ-52;if(s<o||s>c||n<h||n>l)return e.unsetMapFlag(),!1;const d=zl.getObj(s,n,e.level,i,e.pid);return d?(e.clearPendingAction(),e.setInteraction(hi.ENGINE,d,li.APOBJT,{type:d.type,com:a}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class ll extends Fc{handle(t,e){const{x:s,z:n,obj:i,useObj:a,useSlot:r,useComponent:o}=t;if(e.delayed())return e.unsetMapFlag(),!1;const c=Zt.get(o);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=e.originX-52,h=e.originX+52,d=e.originZ+52,p=e.originZ-52;if(s<l||s>h||n<p||n>d)return e.unsetMapFlag(),!1;const u=e.invListeners.find((t=>t.com===o));if(!u)return e.unsetMapFlag(),!1;const g=e.getInventoryFromListener(u);if(!g||!g.validSlot(r)||!g.hasAt(r,a))return e.unsetMapFlag(),!1;const _=zl.getObj(s,n,e.level,i,e.pid);return _?_e.get(a).members&&!ge.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=a,e.lastUseSlot=r,e.clearPendingAction(),e.setInteraction(hi.ENGINE,_,li.APOBJU),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class hl extends Fc{handle(t,e){const{pid:s}=t;if(e.delayed())return e.unsetMapFlag(),!1;const n=zl.getPlayer(s);if(!n)return e.unsetMapFlag(),!1;if(!e.buildArea.players.has(n.uid))return e.unsetMapFlag(),!1;let i;return i=1===t.op?li.APPLAYER1:2===t.op?li.APPLAYER2:3===t.op?li.APPLAYER3:li.APPLAYER4,e.clearPendingAction(),e.setInteraction(hi.ENGINE,n,i),e.opcalled=!0,!0}}class dl extends Fc{handle(t,e){const{pid:s,spellComponent:n}=t;if(e.delayed())return e.unsetMapFlag(),!1;const i=Zt.get(n);if(void 0===i||!e.isComponentVisible(i))return e.unsetMapFlag(),!1;const a=zl.getPlayer(s);return a&&e.buildArea.players.has(a.uid)?(e.clearPendingAction(),e.setInteraction(hi.ENGINE,a,li.APPLAYERT,{type:-1,com:n}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class pl extends Fc{handle(t,e){const{pid:s,useObj:n,useSlot:i,useComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Zt.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return e.unsetMapFlag(),!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,n))return e.unsetMapFlag(),!1;const l=zl.getPlayer(s);return l&&e.buildArea.players.has(l.uid)?_e.get(n).members&&!ge.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseSlot=i,e.clearPendingAction(),e.setInteraction(hi.ENGINE,l,li.APPLAYERU,{type:n,com:-1}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class ul extends Fc{handle(t,e){const{maps:s}=t;for(let t=0;t<s.length;t++){const{type:n,x:i,z:a}=s[t],r=991;if(0==n){const t=Ri.get(`m${i}_${a}`);if(!t)continue;for(let s=0;s<t.length;s+=r)e.write(new Ea(i,a,s,t.length,t.subarray(s,s+r)));e.write(new Aa(i,a))}else if(1==n){const t=Ri.get(`l${i}_${a}`);if(!t)continue;for(let s=0;s<t.length;s+=r)e.write(new Ia(i,a,s,t.length,t.subarray(s,s+r)));e.write(new Pa(i,a))}}return!0}}class gl extends Fc{handle(t,e){return!(!e.activeScript||e.activeScript.execution!==ze.PAUSEBUTTON)&&(e.executeScript(e.activeScript,!0),!0)}}class _l extends Fc{handle(t,e){const{input:s}=t;return!(!e.activeScript||e.activeScript.execution!==ze.COUNTDIALOG)&&(e.activeScript.lastInt=s,e.executeScript(e.activeScript,!0),!0)}}class ml extends Fc{handle(t,e){const{tab:s}=t;if(s<0||s>13)return!1;const n=Fe.getByTriggerSpecific(li.TUTORIAL_CLICKSIDE,-1,-1);return n&&e.executeScript(Rl.init(n,e),!0),!0}}class fl extends Mo{path;ctrlHeld;opClick;category=ko.USER_EVENT;constructor(t,e,s){super(),this.path=t,this.ctrlHeld=e,this.opClick=s}}class El extends Do{prot;constructor(t){super(),this.prot=t}decode(t){const e=t.g1(),s=t.g2(),n=t.g2(),i=this.prot===Uo.MOVE_MINIMAPCLICK?14:0,a=t.available-i>>1,r=[{x:s,z:n}];for(let e=1;e<=a&&e<25;e++)r.push({x:s+t.g1b(),z:n+t.g1b()});return new fl(r,e,this.prot===Uo.MOVE_OPCLICK)}}class Ol extends Fc{handle(t,e){const s=t.path[0];if(e.delayed()||t.ctrlHeld<0||t.ctrlHeld>1||Ws.distanceToSW(e,{x:s.x,z:s.z})>104)return e.unsetMapFlag(),e.userPath=[],!1;if(ge.NODE_CLIENT_ROUTEFINDER){e.userPath=[];for(let s=0;s<t.path.length;s++)e.userPath[s]=Ws.packCoord(e.level,t.path[s].x,t.path[s].z)}else{const s=t.path[t.path.length-1];e.userPath=[Ws.packCoord(e.level,s.x,s.z)]}return e.interactWalkTrigger=!1,t.opClick||(e.clearInteraction(),e.closeModal()),e.runenergy<100?e.setVar(Ae.TEMP_RUN,0):e.setVar(Ae.TEMP_RUN,t.ctrlHeld),!0}}var Al=new class{decoders=new Map;handlers=new Map;bind(t,e){if(this.decoders.has(t.prot.id))throw new Error(`[ClientProtRepository] Already defines a ${t.prot.id}.`);this.decoders.set(t.prot.id,t),e&&this.handlers.set(t.prot.id,e)}constructor(){this.bind(new Bo,new Vc),this.bind(new Ho,new Yc),this.bind(new Wo,new jc),this.bind(new Vo,new Kc),this.bind(new jo,new Zc),this.bind(new Zo(Uo.INV_BUTTON1,1),new Hc),this.bind(new Zo(Uo.INV_BUTTON2,2),new Hc),this.bind(new Zo(Uo.INV_BUTTON3,3),new Hc),this.bind(new Zo(Uo.INV_BUTTON4,4),new Hc),this.bind(new Zo(Uo.INV_BUTTON5,5),new Hc),this.bind(new Jo,new $c),this.bind(new qo,new Jc),this.bind(new tc,new Xc),this.bind(new El(Uo.MOVE_GAMECLICK),new Ol),this.bind(new El(Uo.MOVE_OPCLICK),new Ol),this.bind(new El(Uo.MOVE_MINIMAPCLICK),new Ol),this.bind(new sc(Uo.OPHELD1,1),new qc),this.bind(new sc(Uo.OPHELD2,2),new qc),this.bind(new sc(Uo.OPHELD3,3),new qc),this.bind(new sc(Uo.OPHELD4,4),new qc),this.bind(new sc(Uo.OPHELD5,5),new qc),this.bind(new ic,new Qc),this.bind(new rc,new tl),this.bind(new cc(Uo.OPLOC1,1),new el),this.bind(new cc(Uo.OPLOC2,2),new el),this.bind(new cc(Uo.OPLOC3,3),new el),this.bind(new cc(Uo.OPLOC4,4),new el),this.bind(new cc(Uo.OPLOC5,5),new el),this.bind(new hc,new sl),this.bind(new pc,new nl),this.bind(new gc(Uo.OPNPC1,1),new il),this.bind(new gc(Uo.OPNPC2,2),new il),this.bind(new gc(Uo.OPNPC3,3),new il),this.bind(new gc(Uo.OPNPC4,4),new il),this.bind(new gc(Uo.OPNPC5,5),new il),this.bind(new mc,new al),this.bind(new Ec,new rl),this.bind(new Ac(Uo.OPOBJ1,1),new ol),this.bind(new Ac(Uo.OPOBJ2,2),new ol),this.bind(new Ac(Uo.OPOBJ3,3),new ol),this.bind(new Ac(Uo.OPOBJ4,4),new ol),this.bind(new Ac(Uo.OPOBJ5,5),new ol),this.bind(new Ic,new cl),this.bind(new Pc,new ll),this.bind(new yc(Uo.OPPLAYER1,1),new hl),this.bind(new yc(Uo.OPPLAYER2,2),new hl),this.bind(new yc(Uo.OPPLAYER3,3),new hl),this.bind(new yc(Uo.OPPLAYER4,4),new hl),this.bind(new vc,new dl),this.bind(new wc,new pl),this.bind(new bc,new ul),this.bind(new Dc,new gl),this.bind(new kc,new _l),this.bind(new Bc,new ml)}getDecoder(t){return this.decoders.get(t.id)}getHandler(t){return this.handlers.get(t.id)}};function Tl(t){return null!==t.client&&void 0!==t.client}class Il extends bo{client=null;userPath=[];opcalled=!1;constructor(t,e,s){super(t,e),this.client=s,this.client.player=this}decodeIn(){if(null===this.client||this.client.inOffset<1)return;let t=0;for(this.lastResponse=zl.currentTick,this.userPath=[],this.opcalled=!1,zl.cycleStats[Hn.BANDWIDTH_IN]+=this.client.inOffset;this.client.inOffset>t;){const e=Uo.byId[this.client.in[t++]];let s=e.length;-1==s?s=this.client.in[t++]:-2==s&&(s=this.client.in[t++]<<8|this.client.in[t++]);const n=new ut(this.client.in.slice(t,t+s));t+=s;const i=Al.getDecoder(e);if(i){const t=i.decode(n),s=Al.getHandler(e);s&&s.handle(t,this)}}this.client?.reset()}encodeOut(){if(this.client){(this.modalTop!==this.lastModalTop||this.modalBottom!==this.lastModalBottom||this.modalSidebar!==this.lastModalSidebar||this.refreshModalClose)&&(this.refreshModalClose&&this.write(new Mi),this.refreshModalClose=!1,this.lastModalTop=this.modalTop,this.lastModalBottom=this.modalBottom,this.lastModalSidebar=this.modalSidebar),this.refreshModal&&(1&~this.modalState||4&~this.modalState?1&~this.modalState?2&~this.modalState?4&~this.modalState||this.write(new ja(this.modalSidebar)):this.write(new ua(this.modalBottom)):this.write(new Wa(this.modalTop)):this.write(new Va(this.modalTop,this.modalSidebar)),this.refreshModal=!1);for(let t=this.highPriorityOut.head();t;t=this.highPriorityOut.next())this.writeInner(t),t.uncache();for(let t=this.lowPriorityOut.head();t;t=this.lowPriorityOut.next())this.writeInner(t),t.uncache();this.client.flush()}}writeInner(t){const e=this.client;if(!e)return;const s=Ao.getEncoder(t);if(!s)return;const n=s.prot,i=e.out,a=1+(-1===n.length?1:-2===n.length?2:0)+s.test(t);i.pos+a>=i.length&&e.flush();const r=i.pos;i.p1(n.id),-1===n.length?i.pos+=1:-2===n.length&&(i.pos+=2);const o=i.pos;s.encode(i,t),-1===n.length?i.psize1(i.pos-o):-2===n.length&&i.psize2(i.pos-o),e.encryptor&&(i.data[r]=i.data[r]+e.encryptor.nextInt()&255),zl.cycleStats[Hn.BANDWIDTH_OUT]+=i.pos-r}logout(){this.writeInner(new Pr),this.client?.flush()}terminate(){this.client?.terminate(),this.client=null}playerLog(t,...e){}updateMap(){const t=this.buildArea.loadedZones,e=this.buildArea.activeZones,s=Ws.zone(this.originX)-4<<3,n=Ws.zone(this.originX)+5<<3,i=Ws.zone(this.originZ)+5<<3,a=Ws.zone(this.originZ)-4<<3;(this.x<s||this.z<a||this.x>n-1||this.z>i-1||this.tele&&(Ws.zone(this.x)!==Ws.zone(this.originX)||Ws.zone(this.z)!==Ws.zone(this.originZ)))&&(this.write(new ma(Ws.zone(this.x),Ws.zone(this.z))),this.originX=this.x,this.originZ=this.z,t.clear());for(let t=this.cameraPackets.head();null!==t;t=this.cameraPackets.next()){const e=t.camX-Ws.zoneOrigin(this.originX),s=t.camZ-Ws.zoneOrigin(this.originZ);t.type===Ii.CAM_MOVETO?this.write(new va(e,s,t.height,t.rotationSpeed,t.rotationMultiplier)):t.type===Ii.CAM_LOOKAT&&this.write(new ya(e,s,t.height,t.rotationSpeed,t.rotationMultiplier)),t.unlink()}this.moveSpeed===Li.INSTANT&&this.jump&&t.clear(),e.clear();const r=Ws.zone(this.x),o=Ws.zone(this.z),c=Ws.zone(this.originX)-6,l=Ws.zone(this.originX)+6,h=Ws.zone(this.originZ)+6,d=Ws.zone(this.originZ)-6;for(let t=r-3;t<=r+3;t++)for(let s=o-3;s<=o+3;s++)t<c||t>l||s>h||s<d||e.add(yo.zoneIndex(t<<3,s<<3,this.level))}updatePlayers(){this.write(new ga(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ,this.uid,this.mask,this.tele,this.jump,this.walkDir,this.runDir))}updateNpcs(){this.write(new Eo(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ))}updateZones(){const t=this.buildArea.loadedZones,e=this.buildArea.activeZones;for(const s of t)e.has(s)||t.delete(s);for(const s of e){const e=zl.getZoneIndex(s);t.has(e.index)?(e.writePartialEncloses(this),e.writePartialFollows(this)):e.writeFullFollows(this),t.add(e.index)}}updateStats(){for(let t=0;t<this.stats.length;t++)this.stats[t]===this.lastStats[t]&&this.levels[t]===this.lastLevels[t]||(this.write(new lo(t,this.stats[t],this.levels[t])),this.lastStats[t]=this.stats[t],this.lastLevels[t]=this.levels[t]);Math.floor(this.runenergy)/100!=Math.floor(this.lastRunEnergy)/100&&(this.write(new ao(this.runenergy)),this.lastRunEnergy=this.runenergy)}updateInvs(){let t=!1,e=!1;for(let s=0;s<this.invListeners.length;s++){const n=this.invListeners[s];if(n)if(-1===n.source){const t=zl.getInventory(n.type);if(!t)continue;(t.update||n.firstSeen)&&(this.write(new to(n.com,t)),n.firstSeen=!1)}else{const s=zl.getPlayerByUid(n.source);if(!s)continue;const i=s.getInventory(n.type);if(!i)continue;if(i.update||n.firstSeen){this.write(new to(n.com,i)),n.firstSeen&&(e=!0),n.firstSeen=!1;$t.get(n.type).runweight&&(t=!0)}}}if(t){const e=this.runweight;this.calculateRunWeight(),t=e!==this.runweight}(t||e)&&this.write(new oo(Math.ceil(this.runweight/1e3)))}}class Nl extends ht{type;camX;camZ;height;rotationSpeed;rotationMultiplier;constructor(t,e,s,n,i,a){super(),this.type=t,this.camX=e,this.camZ=s,this.height=n,this.rotationSpeed=i,this.rotationMultiplier=a}}class Pl{static hsl24to16(t,e,s){return s>243?e>>=4:s>217?e>>=3:s>192?e>>=2:s>179&&(e>>=1),((255&t)>>2<<10)+(e>>5<<7)+(s>>1)}static rgb15to24(t){return((t>>10&31)<<3<<16)+((t>>5&31)<<3<<8)+((31&t)<<3)}static rgb15toHsl16(t){const e=(t>>10&31)/31,s=(t>>5&31)/31,n=(31&t)/31;return Pl.rgbToHsl(e,s,n)}static rgb24to15(t){return((t>>16&255)>>3<<10)+((t>>8&255)>>3<<5)+((255&t)>>3)}static rgb24toHsl16(t){const e=(t>>16&255)/256,s=(t>>8&255)/256,n=(255&t)/256;return Pl.rgbToHsl(e,s,n)}static rgbToHsl(t,e,s){let n=t;e<n&&(n=e),s<n&&(n=s);let i=t;e>i&&(i=e),s>i&&(i=s);let a=0,r=0;const o=(n+i)/2;n!==i&&(o<.5?r=(i-n)/(i+n):o>=.5&&(r=(i-n)/(2-i-n)),t===i?a=(e-s)/(i-n):e===i?a=(s-t)/(i-n)+2:s===i&&(a=(t-e)/(i-n)+4)),a/=6;const c=256*a|0;let l=256*r|0,h=256*o|0;return l<0?l=0:l>255&&(l=255),h<0?h=0:h>255&&(h=255),Pl.hsl24to16(c,l,h)}static RGB15_HSL16=new Int32Array(32768);static{for(let t=0;t<32768;t++)Pl.RGB15_HSL16[t]=Pl.rgb15toHsl16(t)}static reverseHsl(t){const e=[];for(let s=0;s<32768;s++)Pl.RGB15_HSL16[s]===t&&e.push(s);return e}}var Ll=function(t){const e=t.popString(),s=[];for(let n=e.length-1;n>=0;n--){const i=e.charAt(n);s[n]='s'===i?t.popString():t.popInt()}return s},yl={[xe.FINDUID]:t=>{const e=t.popInt(),s=zl.getPlayerByUid(e);s?(t.activePlayer=s,t.pointerAdd(De[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.P_FINDUID]:t=>{const e=t.popInt()>>>0,s=zl.getPlayerByUid(e);t.pointerGet(Me[t.intOperand])&&t.activePlayer.uid===e?t.pushInt(1):s&&s.canAccess()?(t.activePlayer=s,t.pointerAdd(De[t.intOperand]),t.pointerAdd(Me[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[xe.STRONGQUEUE]:ve(De,(t=>{const e=Ll(t),s=Ks(t.popInt(),qs),n=t.popInt(),i=Fe.get(n);if(!i)throw new Error(`Unable to find queue script: ${n}`);t.activePlayer.enqueueScript(i,3,s,e)})),[xe.WEAKQUEUE]:ve(De,(t=>{const e=Ll(t),s=Ks(t.popInt(),qs),n=t.popInt(),i=Fe.get(n);if(!i)throw new Error(`Unable to find queue script: ${n}`);t.activePlayer.enqueueScript(i,2,s,e)})),[xe.QUEUE]:ve(De,(t=>{const e=Ll(t),s=Ks(t.popInt(),qs),n=t.popInt(),i=Fe.get(n);if(!i)throw new Error(`Unable to find queue script: ${n}`);t.activePlayer.enqueueScript(i,0,s,e)})),[xe.ANIM]:ve(De,(t=>{const e=t.popInt(),s=t.popInt();t.activePlayer.playAnimation(s,e)})),[xe.BUFFER_FULL]:ve(De,(t=>{throw new Error('unimplemented')})),[xe.BUILDAPPEARANCE]:ve(De,(t=>{t.activePlayer.generateAppearance(Ks(t.popInt(),En).id)})),[xe.CAM_LOOKAT]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,an);t.activePlayer.cameraPackets.addTail(new Nl(Ii.CAM_LOOKAT,a.x,a.z,s,n,i))})),[xe.CAM_MOVETO]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,an);t.activePlayer.cameraPackets.addTail(new Nl(Ii.CAM_MOVETO,a.x,a.z,s,n,i))})),[xe.CAM_SHAKE]:ve(De,(t=>{const[e,s,n,i]=t.popInts(4);t.activePlayer.write(new ba(e,s,n,i))})),[xe.CAM_RESET]:ve(De,(t=>{t.activePlayer.write(new wa)})),[xe.COORD]:ve(De,(t=>{const e=t.activePlayer;t.pushInt(Ws.packCoord(e.level,e.x,e.z))})),[xe.DISPLAYNAME]:ve(De,(t=>{t.pushString(t.activePlayer.displayName)})),[xe.FACESQUARE]:ve(De,(t=>{const e=Ks(t.popInt(),an);t.activePlayer.faceSquare(e.x,e.z)})),[xe.IF_CLOSE]:ve(De,(t=>{t.activePlayer.closeModal()})),[xe.LAST_COM]:t=>{t.pushInt(t.activePlayer.lastCom)},[xe.LAST_INT]:t=>{t.pushInt(t.lastInt)},[xe.LAST_ITEM]:t=>{if(![li.OPHELD1,li.OPHELD2,li.OPHELD3,li.OPHELD4,li.OPHELD5,li.OPHELDU,li.OPHELDT,li.INV_BUTTON1,li.INV_BUTTON2,li.INV_BUTTON3,li.INV_BUTTON4,li.INV_BUTTON5].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastItem)},[xe.LAST_SLOT]:t=>{if(![li.OPHELD1,li.OPHELD2,li.OPHELD3,li.OPHELD4,li.OPHELD5,li.OPHELDU,li.OPHELDT,li.INV_BUTTON1,li.INV_BUTTON2,li.INV_BUTTON3,li.INV_BUTTON4,li.INV_BUTTON5,li.INV_BUTTOND].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastSlot)},[xe.LAST_USEITEM]:t=>{if(![li.OPHELDU,li.APOBJU,li.APLOCU,li.APNPCU,li.APPLAYERU,li.OPOBJU,li.OPLOCU,li.OPNPCU,li.OPPLAYERU].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastUseItem)},[xe.LAST_USESLOT]:t=>{if(![li.OPHELDU,li.APOBJU,li.APLOCU,li.APNPCU,li.APPLAYERU,li.OPOBJU,li.OPLOCU,li.OPNPCU,li.OPPLAYERU].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastUseSlot)},[xe.MES]:ve(De,(t=>{const e=t.popString();t.activePlayer.messageGame(e)})),[xe.NAME]:ve(De,(t=>{t.pushString(t.activePlayer.username)})),[xe.P_APRANGE]:ve(Me,(t=>{t.activePlayer.apRange=Ks(t.popInt(),qs),t.activePlayer.apRangeCalled=!0})),[xe.P_ARRIVEDELAY]:ve(Me,(t=>{t.activePlayer.lastMovement<zl.currentTick||(t.activePlayer.delay=1,t.execution=ze.SUSPENDED)})),[xe.P_COUNTDIALOG]:ve(Me,(t=>{t.activePlayer.write(new Br),t.execution=ze.COUNTDIALOG})),[xe.P_DELAY]:ve(Me,(t=>{t.activePlayer.delay=Ks(t.popInt(),qs)+1,t.execution=ze.SUSPENDED})),[xe.P_OPHELD]:ve(Me,(t=>{throw new Error('unimplemented')})),[xe.P_OPLOC]:ve(Me,(t=>{const e=Ks(t.popInt(),qs)-1;if(e<0||e>=5)throw new Error(`Invalid oploc: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(hi.SCRIPT,t.activeLoc,li.APLOC1+e)})),[xe.P_OPNPC]:ve(Me,(t=>{const e=Ks(t.popInt(),qs)-1;if(e<0||e>=5)throw new Error(`Invalid opnpc: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(hi.SCRIPT,t.activeNpc,li.APNPC1+e,{type:t.activeNpc.type,com:-1})})),[xe.P_OPNPCT]:ve(Me,(t=>{const e=Ks(t.popInt(),qs);t.activePlayer.stopAction(),t.activePlayer.setInteraction(hi.SCRIPT,t.activeNpc,li.APNPCT,{type:t.activeNpc.type,com:e})})),[xe.P_PAUSEBUTTON]:ve(Me,(t=>{t.execution=ze.PAUSEBUTTON})),[xe.P_STOPACTION]:ve(Me,(t=>{t.activePlayer.stopAction()})),[xe.P_CLEARPENDINGACTION]:ve(Me,(t=>{t.activePlayer.clearPendingAction()})),[xe.P_TELEJUMP]:ve(Me,(t=>{const e=Ks(t.popInt(),an);t.activePlayer.teleJump(e.x,e.z,e.level)})),[xe.P_TELEPORT]:ve(Me,(t=>{const e=Ks(t.popInt(),an);t.activePlayer.teleport(e.x,e.z,e.level)})),[xe.P_WALK]:ve(Me,(t=>{const e=Ks(t.popInt(),an),s=t.activePlayer;s.queueWaypoints(Je(s.level,s.x,s.z,e.x,e.z,s.width,s.width,s.length,s.orientation)),s.updateMovement(!1)})),[xe.SAY]:ve(De,(t=>{t.activePlayer.say(t.popString())})),[xe.SOUND_SYNTH]:ve(De,(t=>{const[e,s,n]=t.popInts(3);t.activePlayer.write(new Vr(e,s,n))})),[xe.STAFFMODLEVEL]:ve(De,(t=>{t.pushInt(t.activePlayer.staffModLevel)})),[xe.STAT]:ve(De,(t=>{const e=Ks(t.popInt(),ln);t.pushInt(t.activePlayer.levels[e])})),[xe.STAT_BASE]:ve(De,(t=>{const e=Ks(t.popInt(),ln);t.pushInt(t.activePlayer.baseLevels[e])})),[xe.STAT_ADD]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,ln),Ks(s,qs),Ks(n,qs);const i=t.activePlayer,a=i.levels[e],r=a+(s+a*n/100);i.levels[e]=Math.min(r,255),3===e&&i.levels[3]>=i.baseLevels[3]&&i.resetHeroPoints()})),[xe.STAT_SUB]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,ln),Ks(s,qs),Ks(n,qs);const i=t.activePlayer,a=i.levels[e],r=a-(s+a*n/100);i.levels[e]=Math.max(r,0)})),[xe.SPOTANIM_PL]:ve(De,(t=>{const e=Ks(t.popInt(),qs),s=t.popInt(),n=Ks(t.popInt(),gn);t.activePlayer.spotanim(n.id,s,e)})),[xe.STAT_HEAL]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,ln),Ks(s,qs),Ks(n,qs);const i=t.activePlayer,a=i.baseLevels[e],r=i.levels[e],o=r+(s+r*n/100);i.levels[e]=Math.max(Math.min(o,a),r),3===e&&i.levels[3]>=i.baseLevels[3]&&i.resetHeroPoints()})),[xe.UID]:ve(De,(t=>{t.pushInt(t.activePlayer.uid)})),[xe.P_LOGOUT]:ve(Me,(t=>{t.activePlayer.logoutRequested=!0})),[xe.IF_SETCOLOUR]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),Ks(s,qs),t.activePlayer.write(new Xa(e,Pl.rgb24to15(s)))})),[xe.IF_OPENCHAT]:ve(De,(t=>{t.activePlayer.openChat(Ks(t.popInt(),qs))})),[xe.IF_OPENMAINMODALSIDEOVERLAY]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),Ks(s,qs),t.activePlayer.openMainModalSideOverlay(e,s)})),[xe.IF_SETHIDE]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),Ks(s,qs),t.activePlayer.write(new Qa(e,1===s))})),[xe.IF_SETOBJECT]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,qs),Ks(s,mn),Ks(n,qs),t.activePlayer.write(new ar(e,s,n))})),[xe.IF_SETTABACTIVE]:ve(De,(t=>{t.activePlayer.write(new _r(Ks(t.popInt(),qs)))})),[xe.IF_SETMODEL]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),Ks(s,qs),t.activePlayer.write(new er(e,s))})),[xe.IF_SETRECOL]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,qs),t.activePlayer.write(new dr(e,s,n))})),[xe.IF_SETTABFLASH]:ve(De,(t=>{t.activePlayer.write(new jr(Ks(t.popInt(),qs)))})),[xe.IF_SETANIM]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),-1!==s&&t.activePlayer.write(new $a(e,s))})),[xe.IF_SETTAB]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(s,qs),t.activePlayer.setTab(e,s)})),[xe.IF_OPENMAINMODAL]:ve(De,(t=>{t.activePlayer.openMainModal(Ks(t.popInt(),qs))})),[xe.IF_OPENCHATSTICKY]:ve(De,(t=>{t.activePlayer.openChatSticky(Ks(t.popInt(),qs))})),[xe.IF_OPENSIDEOVERLAY]:ve(De,(t=>{t.activePlayer.openSideOverlay(Ks(t.popInt(),qs))})),[xe.IF_SETPLAYERHEAD]:ve(De,(t=>{t.activePlayer.write(new or(Ks(t.popInt(),qs)))})),[xe.IF_SETTEXT]:ve(De,(t=>{const e=t.popString(),s=Ks(t.popInt(),qs);t.activePlayer.write(new ur(s,e))})),[xe.IF_SETNPCHEAD]:ve(De,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),Ks(s,on),t.activePlayer.write(new nr(e,s))})),[xe.IF_SETPOSITION]:ve(De,(t=>{const[e,s,n]=t.popInts(3);Ks(e,qs),t.activePlayer.write(new lr(e,s,n))})),[xe.IF_MULTIZONE]:ve(De,(t=>{t.activePlayer.write(new Wr(1===Ks(t.popInt(),qs)))})),[xe.GIVEXP]:ve(Me,(t=>{const[e,s]=t.popInts(2);Ks(e,qs),Ks(s,qs),t.activePlayer.addXp(e,s)})),[xe.DAMAGE]:t=>{const e=Ks(t.popInt(),qs),s=Ks(t.popInt(),un),n=Ks(t.popInt(),qs),i=zl.getPlayerByUid(n);i&&i.applyDamage(e,s)},[xe.IF_SETRESUMEBUTTONS]:ve(De,(t=>{const[e,s,n,i,a]=t.popInts(5);t.activePlayer.resumeButtons=[e,s,n,i,a]})),[xe.TEXT_GENDER]:ve(De,(t=>{const[e,s]=t.popStrings(2);0==t.activePlayer.gender?t.pushString(e):t.pushString(s)})),[xe.MIDI_SONG]:t=>{t.activePlayer.playSong(Ks(t.popString(),Qs))},[xe.MIDI_JINGLE]:t=>{const e=Ks(t.popInt(),qs),s=Ks(t.popString(),Qs);t.activePlayer.playJingle(e,s)},[xe.SOFTTIMER]:ve(De,(t=>{const e=Ll(t),s=t.popInt(),n=t.popInt(),i=Fe.get(n);if(!i)throw new Error(`Unable to find timer script: ${n}`);t.activePlayer.setTimer(1,i,e,s)})),[xe.CLEARSOFTTIMER]:ve(De,(t=>{t.activePlayer.clearTimer(t.popInt())})),[xe.SETTIMER]:ve(De,(t=>{const e=Ll(t),s=t.popInt(),n=t.popInt(),i=Fe.get(n);if(!i)throw new Error(`Unable to find timer script: ${n}`);t.activePlayer.setTimer(0,i,e,s)})),[xe.CLEARTIMER]:ve(De,(t=>{t.activePlayer.clearTimer(t.popInt())})),[xe.HINT_COORD]:t=>{const[e,s,n]=t.popInts(3),i=Ks(s,an);t.activePlayer.hintTile(e,i.x,i.z,n)},[xe.HINT_STOP]:t=>{t.activePlayer.stopHint()},[xe.IF_CLOSESTICKY]:t=>{t.activePlayer.closeSticky()},[xe.P_EXACTMOVE]:ve(Me,(t=>{const[e,s,n,i,a]=t.popInts(5),r=Ks(e,an),o=Ks(s,an);t.activePlayer.unsetMapFlag(),t.activePlayer.exactMove(r.x,r.z,o.x,o.z,n,i,a)})),[xe.BUSY]:t=>{t.pushInt(t.activePlayer.busy()?1:0)},[xe.BUSY2]:t=>{t.pushInt(t.activePlayer.hasInteraction()||t.activePlayer.hasWaypoints()?1:0)},[xe.GETQUEUE]:t=>{const e=t.popInt();let s=0;for(let n=t.activePlayer.queue.head();null!==n;n=t.activePlayer.queue.next())n.script.id===e&&s++;for(let n=t.activePlayer.weakQueue.head();null!==n;n=t.activePlayer.weakQueue.next())n.script.id===e&&s++;t.pushInt(s)},[xe.P_LOCMERGE]:ve(Me,(t=>{const[e,s,n,i]=t.popInts(4),a=Ks(n,an),r=Ks(i,an);zl.mergeLoc(t.activeLoc,t.activePlayer,e,s,a.z,a.x,r.z,r.x)})),[xe.LAST_LOGIN_INFO]:t=>{const e=t.activePlayer;if(!Tl(e)||null===e.client)return;const s=e.client.remoteAddress;if(null==s)return;const n=new Uint32Array(new Uint8Array(s.split('.').map((t=>parseInt(t)))).reverse().buffer)[0];e.lastLoginInfo(n,0,201,0)},[xe.BAS_READYANIM]:t=>{t.activePlayer.basReadyAnim=Ks(t.popInt(),In).id},[xe.BAS_TURNONSPOT]:t=>{t.activePlayer.basTurnOnSpot=Ks(t.popInt(),In).id},[xe.BAS_WALK_F]:t=>{t.activePlayer.basWalkForward=Ks(t.popInt(),In).id},[xe.BAS_WALK_B]:t=>{t.activePlayer.basWalkBackward=Ks(t.popInt(),In).id},[xe.BAS_WALK_L]:t=>{t.activePlayer.basWalkLeft=Ks(t.popInt(),In).id},[xe.BAS_WALK_R]:t=>{t.activePlayer.basWalkRight=Ks(t.popInt(),In).id},[xe.BAS_RUNNING]:t=>{const e=t.popInt();t.activePlayer.basRunning=-1!==e?Ks(e,In).id:-1},[xe.GENDER]:t=>{t.pushInt(t.activePlayer.gender)},[xe.HINT_NPC]:t=>{t.activePlayer.hintNpc(Ks(t.popInt(),qs))},[xe.HINT_PLAYER]:t=>{const e=Ks(t.popInt(),qs),s=zl.getPlayerByUid(e);s&&t.activePlayer.hintPlayer(s.pid)},[xe.HEADICONS_GET]:t=>{t.pushInt(t.activePlayer.headicons)},[xe.HEADICONS_SET]:t=>{t.activePlayer.headicons=Ks(t.popInt(),qs)},[xe.P_OPOBJ]:ve(Me,(t=>{const e=Ks(t.popInt(),qs)-1;if(e<0||e>=5)throw new Error(`Invalid opobj: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(hi.SCRIPT,t.activeObj,li.APOBJ1+e)})),[xe.P_OPPLAYER]:ve(Me,(t=>{const e=Ks(t.popInt(),qs)-1;if(e<0||e>=5)throw new Error(`Invalid opplayer: ${e+1}`);const s=t._activePlayer2;s&&(t.activePlayer.stopAction(),t.activePlayer.setInteraction(hi.SCRIPT,s,li.APPLAYER1+e))})),[xe.ALLOWDESIGN]:t=>{t.activePlayer.allowDesign=1===Ks(t.popInt(),qs)},[xe.LAST_TARGETSLOT]:t=>{if(![li.INV_BUTTOND].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastTargetSlot)},[xe.WALKTRIGGER]:t=>{t.activePlayer.walktrigger=t.popInt()},[xe.GETWALKTRIGGER]:t=>{t.pushInt(t.activePlayer.walktrigger)},[xe.CLEARQUEUE]:t=>{const e=t.popInt();for(let s=t.activePlayer.queue.head();null!==s;s=t.activePlayer.queue.next())s.script.id===e&&s.unlink();for(let s=t.activePlayer.weakQueue.head();null!==s;s=t.activePlayer.weakQueue.next())s.script.id===e&&s.unlink()},[xe.HEALENERGY]:t=>{const e=Ks(t.popInt(),qs),s=t.activePlayer;s.runenergy=Math.min(Math.max(s.runenergy+e,0),1e4)},[xe.AFK_EVENT]:t=>{t.pushInt(t.activePlayer.afkEventReady?1:0),t.activePlayer.afkEventReady=!1},[xe.LOWMEMORY]:t=>{t.pushInt(t.activePlayer.lowMemory?1:0)},[xe.SETIDKIT]:t=>{const[e,s]=t.popInts(2),n=Ks(e,An);let i=n.type;1===t.activePlayer.gender&&(i-=7),t.activePlayer.body[i]=n.id;let a=n.type;1===t.activePlayer.gender&&(a-=7);let r=-1;0===a||1===a?r=0:2===a||3===a?r=1:4===a||(5===a?r=2:6===a&&(r=3)),-1!==r&&(t.activePlayer.colors[r]=s)},[xe.SETGENDER]:t=>{const e=Ks(t.popInt(),Rn);for(let s=0;s<7;s++){t.activePlayer.body[s]=-1;for(let n=0;n<Kt.count;n++)if(!Kt.get(n).disable&&Kt.get(n).type==s+(0===e?0:7)){t.activePlayer.body[s]=n;break}}t.activePlayer.gender=e},[xe.SETSKINCOLOUR]:t=>{const e=Ks(t.popInt(),bn);t.activePlayer.colors[4]=e},[xe.P_OPPLAYERT]:ve(Me,(t=>{const e=Ks(t.popInt(),qs),s=t._activePlayer2;s&&(t.activePlayer.stopAction(),t.activePlayer.setInteraction(hi.SCRIPT,s,li.APPLAYERT,{type:-1,com:e}))})),[xe.FINDHERO]:ve(De,(t=>{const e=t.activePlayer.findHero();if(-1===e)return void t.pushInt(0);const s=zl.getPlayerByUid(e);s?(t._activePlayer2=s,t.pointerAdd(ke.ActivePlayer2),t.pushInt(1)):t.pushInt(0)})),[xe.BOTH_HEROPOINTS]:ve(De,(t=>{const e=Ks(t.popInt(),qs),s=1===t.intOperand,n=s?t._activePlayer2:t._activePlayer,i=s?t._activePlayer:t._activePlayer2;if(!n||!i)throw new Error('player is null');i.addHero(n.uid,e)})),[xe.P_ANIMPROTECT]:ve(Me,(t=>{t.activePlayer.animProtect=Ks(t.popInt(),qs)})),[xe.RUNENERGY]:ve(De,(t=>{const e=t.activePlayer;t.pushInt(e.runenergy)}))},Sl=yl,vl={[xe.MAP_CLOCK]:t=>{t.pushInt(zl.currentTick)},[xe.MAP_MEMBERS]:t=>{t.pushInt(ge.NODE_MEMBERS?1:0)},[xe.MAP_PLAYERCOUNT]:t=>{const[e,s]=t.popInts(2),n=Ks(e,an),i=Ks(s,an);let a=0;for(let t=Math.floor(n.x/8);t<=Math.ceil(i.x/8);t++)for(let e=Math.floor(n.z/8);e<=Math.ceil(i.z/8);e++)for(const s of zl.getZone(t<<3,e<<3,n.level).getAllPlayersSafe())s.x>=n.x&&s.x<=i.x&&s.z>=n.z&&s.z<=i.z&&a++;t.pushInt(a)},[xe.HUNTALL]:t=>{const[e,s,n]=t.popInts(3),i=Ks(e,an);Ks(s,qs);const a=Ks(n,Tn);t.huntIterator=new qn(zl.currentTick,i.level,i.x,i.z,s,a,-1,-1,Bt.PLAYER)},[xe.HUNTNEXT]:t=>{const e=t.huntIterator?.next();if(e&&!e.done){if(!(e.value instanceof bo))throw new Error('[ServerOps] huntnext command must result instance of Player.');t.activePlayer=e.value,t.pointerAdd(De[t.intOperand]),t.pushInt(1)}else t.pushInt(0)},[xe.NPC_HUNTALL]:t=>{const[e,s,n]=t.popInts(3),i=Ks(e,an);Ks(s,qs);const a=Ks(n,Tn);t.huntIterator=new qn(zl.currentTick,i.level,i.x,i.z,s,a,-1,-1,Bt.NPC)},[xe.NPC_HUNTNEXT]:t=>{const e=t.huntIterator?.next();if(e&&!e.done){if(!(e.value instanceof bl))throw new Error('[ServerOps] npc_huntnext command must result instance of Npc.');t.activeNpc=e.value,t.pointerAdd(Re[t.intOperand]),t.pushInt(1)}else t.pushInt(0)},[xe.INZONE]:t=>{const[e,s,n]=t.popInts(3),i=Ks(e,an),a=Ks(s,an),r=Ks(n,an);r.x<i.x||r.x>a.x||r.level<i.level||r.level>a.level||r.z<i.z||r.z>a.z?t.pushInt(0):t.pushInt(1)},[xe.LINEOFWALK]:t=>{const[e,s]=t.popInts(2),n=Ks(e,an),i=Ks(s,an);n.level===i.level?t.pushInt(hs(n.level,n.x,n.z,i.x,i.z,1,1,1,1)?1:0):t.pushInt(0)},[xe.STAT_RANDOM]:t=>{const[e,s,n]=t.popInts(3),i=Math.floor(s*(99-e)/98)+Math.floor(n*(e-1)/98)+1,a=Math.floor(256*Math.random());t.pushInt(i>a?1:0)},[xe.SPOTANIM_MAP]:t=>{const[e,s,n,i]=t.popInts(4),a=Ks(s,an),r=Ks(e,gn);zl.animMap(a.level,a.x,a.z,r.id,n,i)},[xe.DISTANCE]:t=>{const[e,s]=t.popInts(2),n=Ks(e,an),i=Ks(s,an);t.pushInt(Ws.distanceToSW(n,i))},[xe.MOVECOORD]:t=>{const[e,s,n,i]=t.popInts(4),a=Ks(e,an);t.pushInt(Ws.packCoord(a.level+n,a.x+s,a.z+i))},[xe.SEQLENGTH]:t=>{t.pushInt(Ks(t.popInt(),In).duration)},[xe.SPLIT_INIT]:t=>{const[e,s,n]=t.popInts(3);let i=t.popString();const a=Ks(n,yn);if(i.startsWith('<p,')&&-1!==i.indexOf('>')){const e=i.substring(3,i.indexOf('>'));t.splitMesanim=se.getId(e),i=i.substring(i.indexOf('>')+1)}else t.splitMesanim=-1;t.splitPages=[];const r=a.split(i,e);for(;r.length>0;)t.splitPages.push(r.splice(0,s))},[xe.SPLIT_GET]:t=>{const[e,s]=t.popInts(2);t.pushString(t.splitPages[e][s])},[xe.SPLIT_PAGECOUNT]:t=>{t.pushInt(t.splitPages.length)},[xe.SPLIT_LINECOUNT]:t=>{const e=t.popInt();t.pushInt(t.splitPages[e].length)},[xe.SPLIT_GETANIM]:t=>{const e=t.popInt();-1!==t.splitMesanim?t.pushInt(Ks(t.splitMesanim,Sn).len[t.splitPages[e].length-1]):t.pushInt(-1)},[xe.STRUCT_PARAM]:t=>{const[e,s]=t.popInts(2),n=Ks(s,rn),i=Ks(e,vn);n.isString()?t.pushString(qt(n.id,i,n.defaultString)):t.pushInt(Qt(n.id,i,n.defaultInt))},[xe.COORDX]:t=>{t.pushInt(Ks(t.popInt(),an).x)},[xe.COORDY]:t=>{t.pushInt(Ks(t.popInt(),an).level)},[xe.COORDZ]:t=>{t.pushInt(Ks(t.popInt(),an).z)},[xe.PLAYERCOUNT]:t=>{t.pushInt(zl.getTotalPlayers())},[xe.MAP_BLOCKED]:t=>{const e=Ks(t.popInt(),an);t.pushInt(os(e.x,e.z,e.level,vs.WALK_BLOCKED)?1:0)},[xe.MAP_INDOORS]:t=>{const e=Ks(t.popInt(),an);t.pushInt(os(e.x,e.z,e.level,vs.ROOF)?1:0)},[xe.LINEOFSIGHT]:t=>{const[e,s]=t.popInts(2),n=Ks(e,an),i=Ks(s,an);n.level===i.level?t.pushInt(ls(n.level,n.x,n.z,i.x,i.z,1,1,1,1)?1:0):t.pushInt(0)},[xe.WORLD_DELAY]:t=>{t.execution=ze.WORLD_SUSPENDED},[xe.PROJANIM_PL]:t=>{const[e,s,n,i,a,r,o,c,l]=t.popInts(9),h=Ks(e,an),d=Ks(n,gn),p=zl.getPlayerByUid(s);if(!p)throw new Error(`attempted to use invalid player uid: ${s}`);zl.mapProjAnim(h.level,h.x,h.z,p.x,p.z,-p.pid-1,d.id,i+100,a+100,r,o,c,l)},[xe.PROJANIM_NPC]:t=>{const[e,s,n,i,a,r,o,c,l]=t.popInts(9),h=Ks(e,an),d=Ks(n,gn),p=65535&s,u=zl.getNpc(p);if(!u)throw new Error(`attempted to use invalid npc uid: ${s}`);zl.mapProjAnim(h.level,h.x,h.z,u.x,u.z,u.nid+1,d.id,i+100,a+100,r,o,c,l)},[xe.PROJANIM_MAP]:t=>{const[e,s,n,i,a,r,o,c,l]=t.popInts(9),h=Ks(n,gn),d=Ks(e,an),p=Ks(s,an);zl.mapProjAnim(d.level,d.x,d.z,p.x,p.z,0,h.id,i+100,a,r,o,c,l)},[xe.MAP_LOCADDUNSAFE]:t=>{const e=Ks(t.popInt(),an);for(const s of zl.getZone(e.x,e.z,e.level).getAllLocsUnsafe()){if(1!==Ks(s.type,tn).active)continue;const n=gs(s.shape);if(s.checkLifeCycle(zl.currentTick)||n!==bs.WALL)if(n===bs.WALL){if(s.x===e.x&&s.z===e.z)return void t.pushInt(1)}else if(n===bs.GROUND){const n=s.angle===ws.NORTH||s.angle===ws.SOUTH?s.length:s.width,i=s.angle===ws.NORTH||s.angle===ws.SOUTH?s.width:s.length;for(let a=0;a<n*i;a++){const i=s.x+a%n,r=s.z+(a/n|0);if(i===e.x&&r===e.z)return void t.pushInt(1)}}else if(n===bs.GROUND_DECOR&&s.x===e.x&&s.z===e.z)return void t.pushInt(1)}t.pushInt(0)},[xe.NPCCOUNT]:t=>{t.pushInt(zl.getTotalNpcs())},[xe.ZONECOUNT]:t=>{t.pushInt(zl.getTotalZones())},[xe.LOCCOUNT]:t=>{t.pushInt(zl.getTotalLocs())},[xe.OBJCOUNT]:t=>{t.pushInt(zl.getTotalObjs())}},Cl=vl,wl={[xe.APPEND_NUM]:t=>{const e=t.popString(),s=t.popInt();t.pushString(e+s)},[xe.APPEND]:t=>{const[e,s]=t.popStrings(2);t.pushString(e+s)},[xe.APPEND_SIGNNUM]:t=>{const e=t.popString(),s=t.popInt();s>=0?t.pushString(`${e}+${s}`):t.pushString(e+s)},[xe.LOWERCASE]:t=>{t.pushString(t.popString().toLowerCase())},[xe.TOSTRING]:t=>{t.pushString(t.popInt().toString())},[xe.COMPARE]:t=>{const[e,s]=t.popStrings(2);t.pushInt(function(t,e){const s=t.length,n=e.length,i=Math.min(s,n);let a=0;for(;a<i;){const s=t.charCodeAt(a),n=e.charCodeAt(a);if(s!=n)return s-n;a++}return s-n}(e,s))},[xe.TEXT_SWITCH]:t=>{const e=t.popInt(),[s,n]=t.popStrings(2);t.pushString(1===e?s:n)},[xe.APPEND_CHAR]:t=>{const e=t.popString(),s=t.popInt();t.pushString(e+String.fromCharCode(s))},[xe.STRING_LENGTH]:t=>{t.pushInt(t.popString().length)},[xe.SUBSTRING]:t=>{const e=t.popString(),[s,n]=t.popInts(2);t.pushString(e.substring(s,n))},[xe.STRING_INDEXOF_CHAR]:t=>{const e=t.popString(),s=String.fromCharCode(t.popInt());t.pushInt(e.indexOf(s))},[xe.STRING_INDEXOF_STRING]:t=>{const e=t.popString(),s=t.popString();t.pushInt(e.indexOf(s))}};class Rl{static HANDLERS={...kn,...Cl,...Sl,...di,...ai,...Ei,...pi,...ri,...Oi,...$n,...Wn,...wl,...fi,...xn,...Gn};static init(t,e=null,s=null,n=[]){const i=new ze(t,n);return i.self=e,e instanceof bo?(i._activePlayer=e,i.pointerAdd(ke.ActivePlayer)):e instanceof bl?(i._activeNpc=e,i.pointerAdd(ke.ActiveNpc)):e instanceof ei?(i._activeLoc=e,i.pointerAdd(ke.ActiveLoc)):e instanceof jn&&(i._activeObj=e,i.pointerAdd(ke.ActiveObj)),s instanceof bo?e instanceof bo?(i._activePlayer2=s,i.pointerAdd(ke.ActivePlayer2)):(i._activePlayer=s,i.pointerAdd(ke.ActivePlayer)):s instanceof bl?e instanceof bl?(i._activeNpc2=s,i.pointerAdd(ke.ActiveNpc2)):(i._activeNpc=s,i.pointerAdd(ke.ActiveNpc)):s instanceof ei?e instanceof ei?(i._activeLoc2=s,i.pointerAdd(ke.ActiveLoc2)):(i._activeLoc=s,i.pointerAdd(ke.ActiveLoc)):s instanceof jn&&(e instanceof jn?(i._activeObj2=s,i.pointerAdd(ke.ActiveObj2)):(i._activeObj=s,i.pointerAdd(ke.ActiveObj))),i}static execute(t,e=!1,s=!1){if(!t||!t.script||!t.script.info)return ze.ABORTED;try{e&&t.reset(),t.execution!==ze.RUNNING&&t.executionHistory.push(t.execution),t.execution=ze.RUNNING;const n=1e3*performance.now();for(;t.execution===ze.RUNNING;){if(t.pc>=t.script.opcodes.length||t.pc<-1)throw new Error('Invalid program counter: '+t.pc+', max expected: '+t.script.opcodes.length);if(!s&&t.opcount>5e5)throw new Error('Too many instructions');t.opcount++,Rl.executeInner(t,t.script.opcodes[++t.pc])}const i=1e3*performance.now()-n|0;if(ge.NODE_DEBUG_PROFILE&&i>1e3){const e=`Warning [cpu time]: Script: ${t.script.info.scriptName}, time: ${i}us`;t.self instanceof bo?t.self.wrappedMessageGame(e):console.warn(e)}}catch(e){if(t.pc>=0&&t.pc<t.script.opcodes.length){const s=t.script.opcodes[t.pc];let n=t.intOperand;s===xe.POP_VARP||s===xe.POP_VARN||s===xe.PUSH_VARP||s===xe.PUSH_VARN?n=t.intOperand>>16&1:s<=xe.POP_ARRAY_INT&&(n=0),e.message=xe[s].toLowerCase()+' '+e.message,n&&(e.message='.'+e.message)}if(t.self instanceof bo){t.self.wrappedMessageGame(`script error: ${e.message}`),t.self.wrappedMessageGame(`file: ${u.basename(t.script.info.sourceFilePath)}`),t.self.wrappedMessageGame(''),t.self.wrappedMessageGame('stack backtrace:'),t.self.wrappedMessageGame(`    1: ${t.script.name} - ${t.script.fileName}:${t.script.lineNumber(t.pc)}`);let s=1;for(let e=t.fp;e>0;e--){const n=t.frames[e];n&&(s++,t.self.wrappedMessageGame(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}for(let e=t.debugFp;e>=0;e--){const n=t.debugFrames[e];n&&(s++,t.self.wrappedMessageGame(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}}console.error(`script error: ${e.message}`),console.error(`file: ${u.basename(t.script.info.sourceFilePath)}`),console.error(''),console.error('stack backtrace:'),console.error(`    1: ${t.script.name} - ${t.script.fileName}:${t.script.lineNumber(t.pc)}`);let s=1;for(let e=t.fp;e>0;e--){const n=t.frames[e];n&&(s++,console.error(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}for(let e=t.debugFp;e>=0;e--){const n=t.debugFrames[e];n&&(s++,console.error(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}t.execution=ze.ABORTED}return t.execution}static executeInner(t,e){const s=Rl.HANDLERS[e];if(!s)throw new Error(`Unknown opcode ${e}`);s(t)}}class bl extends Si{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;nid;type;uid;origType;startX;startZ;levels=new Uint8Array(6);baseLevels=new Uint8Array(6);vars;varsString;activeScript=null;delay=0;queue=new dt;timerInterval=0;timerClock=0;huntMode=-1;nextHuntTick=-1;huntrange=5;nextPatrolTick=-1;nextPatrolPoint=0;delayedPatrol=!1;heroPoints=new Array(16);constructor(t,e,s,n,i,a,r,o,c,l){super(t,e,s,n,i,a,c,l,yi.NAIVE,bl.FACE_COORD,bl.FACE_ENTITY),this.nid=r,this.type=o,this.uid=o<<16|r,this.startX=this.x,this.startZ=this.z,this.origType=o;const h=he.get(o);for(let t=0;t<h.stats.length;t++){const e=h.stats[t];this.levels[t]=e,this.baseLevels[t]=e}-1!==h.timer&&this.setTimer(h.timer),this.vars=new Int32Array(Oe.count),this.varsString=new Array(Oe.count),this.targetOp=h.defaultmode,this.huntMode=h.huntmode,this.huntrange=h.huntrange}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(t,e){const s=this.heroPoints.findIndex((e=>e&&e.uid===t));if(-1!==s)return void(this.heroPoints[s].points+=e);const n=this.heroPoints.findIndex((t=>t&&-1===t.uid));-1===n||(this.heroPoints[n]={uid:t,points:e})}findHero(){return this.heroPoints.sort(((t,e)=>e.points-t.points)),this.heroPoints[0]?.uid??-1}getVar(t){const e=Oe.get(t);return e.type===mt.STRING?this.varsString[e.id]:this.vars[e.id]}setVar(t,e){const s=Oe.get(t);s.type===mt.STRING&&'string'==typeof e?this.varsString[s.id]=e:'number'==typeof e&&(this.vars[s.id]=e)}resetEntity(t){if(t){this.type=this.origType,this.uid=this.type<<16|this.nid,this.orientation=Hs;for(let t=0;t<this.baseLevels.length;t++)this.levels[t]=this.baseLevels[t];this.resetHeroPoints(),this.defaultMode();const t=he.get(this.type);this.huntrange=t.huntrange}super.resetPathingEntity()}updateMovement(t=!0){const e=he.get(this.type);if(e.moverestrict===ce.NOMOVE)return!1;if(this.target&&this.targetOp!==Yt.PLAYERFOLLOW){const t=Ws.distanceTo(this,{x:this.startX,z:this.startZ,width:this.width,length:this.length});if(Ws.distanceTo(this.target,{x:this.startX,z:this.startZ,width:this.target.width,length:this.target.length})>e.maxrange&&t>e.maxrange)return!1}if(t&&this.target instanceof Si&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),-1!==this.walktrigger){const t=he.get(this.type),e=Fe.getByTrigger(li.AI_QUEUE1+this.walktrigger,t.id,t.category);if(this.walktrigger=-1,e){const t=Rl.init(e,this,null,[this.walktriggerArg]);Rl.execute(t)}}return this.moveSpeed!==Li.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed()),super.processMovement()}blockWalkFlag(){return this.moveRestrict===ce.NORMAL?vs.NPC:this.moveRestrict===ce.BLOCKED?vs.OPEN:this.moveRestrict===ce.BLOCKED_NORMAL||this.moveRestrict===ce.INDOORS||this.moveRestrict===ce.OUTDOORS?vs.NPC:this.moveRestrict===ce.NOMOVE?vs.NULL:this.moveRestrict===ce.PASSTHRU?vs.OPEN:vs.NULL}defaultMoveSpeed(){return Li.WALK}delayed(){return this.delay>0}setTimer(t){this.timerInterval=t,this.timerClock=0}executeScript(t){if(!t)return;const e=Rl.execute(t);e!==ze.FINISHED&&e!==ze.ABORTED?e===ze.WORLD_SUSPENDED?zl.enqueueScript(t,t.popInt()):e===ze.NPC_SUSPENDED?t.activeNpc.activeScript=t:t.activePlayer.activeScript=t:t===this.activeScript&&(this.activeScript=null),t.pointerGet(ke.ProtectedActivePlayer)&&t._activePlayer&&(t._activePlayer.protect=!1,t.pointerRemove(ke.ProtectedActivePlayer)),t.pointerGet(ke.ProtectedActivePlayer2)&&t._activePlayer2&&(t._activePlayer2.protect=!1,t.pointerRemove(ke.ProtectedActivePlayer2))}processTimers(){if(0!==this.timerInterval&&++this.timerClock>=this.timerInterval){this.timerClock=0;const t=he.get(this.type),e=Fe.getByTrigger(li.AI_TIMER,t.id,t.category);e&&this.executeScript(Rl.init(e,this))}}processQueue(){for(let t=this.queue.head();null!==t;t=this.queue.next())if(this.delayed()||t.delay--,!this.delayed()&&t.delay<=0){const e=Rl.init(t.script,this,null,t.args);e.lastInt=t.lastInt,this.executeScript(e),t.unlink()}}enqueueScript(t,e=0,s=0){const n=new Ai(0,t,[],e);n.lastInt=s,this.queue.addTail(n)}randomWalk(t){const e=Math.round(Math.random()*(2*t)-t),s=Math.round(Math.random()*(2*t)-t),n=this.startX+e,i=this.startZ+s;n===this.x&&i===this.z||this.queueWaypoint(n,i)}processNpcModes(){this.targetOp===Yt.NULL?this.defaultMode():this.targetOp===Yt.NONE?this.noMode():this.targetOp===Yt.WANDER?this.wanderMode():this.targetOp===Yt.PATROL?this.patrolMode():this.targetOp===Yt.PLAYERESCAPE?this.playerEscapeMode():this.targetOp===Yt.PLAYERFOLLOW?this.playerFollowMode():this.targetOp===Yt.PLAYERFACE?this.playerFaceMode():this.targetOp===Yt.PLAYERFACECLOSE?this.playerFaceCloseMode():this.aiMode()}noMode(){this.clearInteraction(),this.updateMovement(!1),this.targetOp=Yt.NONE,this.faceEntity=-1,this.mask|=bl.FACE_ENTITY}defaultMode(){this.clearInteraction(),this.updateMovement(!1);const t=he.get(this.type);this.targetOp=t.defaultmode,this.faceEntity=-1,this.mask|=bl.FACE_ENTITY}wanderMode(){const t=he.get(this.type);t.moverestrict!==ce.NOMOVE&&Math.random()<.125&&this.randomWalk(t.wanderrange),this.updateMovement(!1)}patrolMode(){const t=he.get(this.type),e=t.patrolCoord,s=t.patrolDelay[this.nextPatrolPoint];let n=Ws.unpackCoord(e[this.nextPatrolPoint]);this.updateMovement(!1),this.hasWaypoints()||this.target||this.queueWaypoint(n.x,n.z),(this.x!==n.x||this.z!==n.z)&&zl.currentTick>=this.nextPatrolTick&&this.teleport(n.x,n.z,n.level),this.x!==n.x||this.z!==n.z||this.delayedPatrol||(this.nextPatrolTick=zl.currentTick+s,this.delayedPatrol=!0),this.nextPatrolTick>zl.currentTick||(this.nextPatrolPoint=(this.nextPatrolPoint+1)%e.length,this.nextPatrolTick=zl.currentTick+30,this.delayedPatrol=!1,n=Ws.unpackCoord(e[this.nextPatrolPoint]),this.queueWaypoint(n.x,n.z))}playerEscapeMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof bo))throw new Error('[Npc] Target must be a Player for playerescape mode.');if(null===zl.getPlayerByUid(this.target.uid))return void this.defaultMode();if(Ws.distanceToSW(this,this.target)>25)return void this.defaultMode();let t,e;this.target.x>=this.x&&this.target.z>=this.z?(t=Fs,e=vs.WALL_SOUTH|vs.WALL_WEST):this.target.x>=this.x&&this.target.z<this.z?(t=Ds,e=vs.WALL_NORTH|vs.WALL_WEST):this.target.x<this.x&&this.target.z>=this.z?(t=Gs,e=vs.WALL_SOUTH|vs.WALL_EAST):(t=ks,e=vs.WALL_NORTH|vs.WALL_EAST);const s=Ws.moveX(this.x,t),n=Ws.moveZ(this.z,t);if(os(s,n,this.level,e))return void this.defaultMode();const i={x:s,z:n,level:this.level};if(Ws.distanceToSW(i,{x:this.startX,z:this.startZ})<he.get(this.type).maxrange)return this.queueWaypoint(i.x,i.z),void this.updateMovement(!1);t===ks||t===Ds?this.queueWaypoint(this.x,i.z):this.queueWaypoint(i.x,this.z),this.updateMovement(!1)}playerFollowMode(){if(this.target){if(!(this.target instanceof bo))throw new Error('[Npc] Target must be a Player for playerfollow mode.');null!==zl.getPlayerByUid(this.target.uid)&&this.level===this.target.level?(this.pathToTarget(),this.updateMovement()):this.defaultMode()}else this.defaultMode()}playerFaceMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof bo))throw new Error('[Npc] Target must be a Player for playerface mode.');if(null===zl.getPlayerByUid(this.target.uid))return void this.defaultMode();if(this.level!==this.target.level)return void this.defaultMode();const t=he.get(this.type);Ws.distanceTo(this,this.target)>t.maxrange?this.defaultMode():this.updateMovement(!1)}playerFaceCloseMode(){if(this.target){if(!(this.target instanceof bo))throw new Error('[Npc] Target must be a Player for playerfaceclose mode.');null!=zl.getPlayerByUid(this.target.uid)&&this.level===this.target.level?Ws.distanceTo(this,this.target)>1?this.defaultMode():this.updateMovement(!1):this.defaultMode()}else this.defaultMode()}aiMode(){if(this.delayed()||!this.target)return void this.defaultMode();if(this.target.level!==this.level)return void this.defaultMode();if(this.target instanceof bl&&(void 0===zl.getNpc(this.target.nid)||this.target.delayed()))return void this.defaultMode();if(this.target instanceof bl&&-1!==this.targetSubject.type&&null===zl.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return void this.defaultMode();if(this.target instanceof jn&&null===zl.getObj(this.target.x,this.target.z,this.level,this.target.type,-1))return void this.defaultMode();if(this.target instanceof ei&&null===zl.getLoc(this.target.x,this.target.z,this.level,this.target.type))return void this.defaultMode();if(this.target instanceof bo&&null===zl.getPlayerByUid(this.target.uid))return void this.defaultMode();const t=he.get(this.type);if(Ws.distanceTo(this,this.target)>t.attackrange)return void this.defaultMode();const e=this.targetOp>=Yt.APNPC1&&this.targetOp<=Yt.APNPC5||this.targetOp>=Yt.APPLAYER1&&this.targetOp<=Yt.APPLAYER5||this.targetOp>=Yt.APLOC1&&this.targetOp<=Yt.APLOC5||this.targetOp>=Yt.APOBJ1&&this.targetOp<=Yt.APOBJ5,s=!e,n=this.getTrigger();n&&s&&this.inOperableDistance(this.target)&&this.target instanceof Si||n&&e&&this.inApproachDistance(t.attackrange,this.target)?(this.executeScript(Rl.init(n,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&this.target instanceof Si&&(this.target=null,this.interacted=!0,this.clearWaypoints());const i=this.updateMovement();i&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1),this.target&&!this.interacted&&(this.interacted=!1,n&&s&&this.inOperableDistance(this.target)&&(this.target instanceof Si||!i)||n&&e&&this.inApproachDistance(t.attackrange,this.target)?(this.executeScript(Rl.init(n,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&(this.target instanceof Si||!i)&&(this.target=null,this.interacted=!0,this.clearWaypoints()))}getTrigger(){const t=this.getTriggerForMode(this.targetOp);return t?Fe.getByTrigger(t,this.type,-1)??null:null}getTriggerForMode(t){return t===Yt.OPPLAYER1?li.AI_OPPLAYER1:t===Yt.OPPLAYER2?li.AI_OPPLAYER2:t===Yt.OPPLAYER3?li.AI_OPPLAYER3:t===Yt.OPPLAYER4?li.AI_OPPLAYER4:t===Yt.OPPLAYER5?li.AI_OPPLAYER5:t===Yt.APPLAYER1?li.AI_APPLAYER1:t===Yt.APPLAYER2?li.AI_APPLAYER2:t===Yt.APPLAYER3?li.AI_APPLAYER3:t===Yt.APPLAYER4?li.AI_APPLAYER4:t===Yt.APPLAYER5?li.AI_APPLAYER5:t===Yt.OPLOC1?li.AI_OPLOC1:t===Yt.OPLOC2?li.AI_OPLOC2:t===Yt.OPLOC3?li.AI_OPLOC3:t===Yt.OPLOC4?li.AI_OPLOC4:t===Yt.OPLOC5?li.AI_OPLOC5:t===Yt.APLOC1?li.AI_APLOC1:t===Yt.APLOC2?li.AI_APLOC2:t===Yt.APLOC3?li.AI_APLOC3:t===Yt.APLOC4?li.AI_APLOC4:t===Yt.APLOC5?li.AI_APLOC5:t===Yt.OPOBJ1?li.AI_OPOBJ1:t===Yt.OPOBJ2?li.AI_OPOBJ2:t===Yt.OPOBJ3?li.AI_OPOBJ3:t===Yt.OPOBJ4?li.AI_OPOBJ4:t===Yt.OPOBJ5?li.AI_OPOBJ5:t===Yt.APOBJ1?li.AI_APOBJ1:t===Yt.APOBJ2?li.AI_APOBJ2:t===Yt.APOBJ3?li.AI_APOBJ3:t===Yt.APOBJ4?li.AI_APOBJ4:t===Yt.APOBJ5?li.AI_APOBJ5:t===Yt.OPNPC1?li.AI_OPNPC1:t===Yt.OPNPC2?li.AI_OPNPC2:t===Yt.OPNPC3?li.AI_OPNPC3:t===Yt.OPNPC4?li.AI_OPNPC4:t===Yt.OPNPC5?li.AI_OPNPC5:t===Yt.APNPC1?li.AI_APNPC1:t===Yt.APNPC2?li.AI_APNPC2:t===Yt.APNPC3?li.AI_APNPC3:t===Yt.APNPC4?li.AI_APNPC4:t===Yt.APNPC5?li.AI_APNPC5:t===Yt.QUEUE1?li.AI_QUEUE1:t===Yt.QUEUE2?li.AI_QUEUE2:t===Yt.QUEUE3?li.AI_QUEUE3:t===Yt.QUEUE4?li.AI_QUEUE4:t===Yt.QUEUE5?li.AI_QUEUE5:t===Yt.QUEUE6?li.AI_QUEUE6:t===Yt.QUEUE7?li.AI_QUEUE7:t===Yt.QUEUE8?li.AI_QUEUE8:t===Yt.QUEUE9?li.AI_QUEUE9:t===Yt.QUEUE10?li.AI_QUEUE10:t===Yt.QUEUE11?li.AI_QUEUE11:t===Yt.QUEUE12?li.AI_QUEUE12:t===Yt.QUEUE13?li.AI_QUEUE13:t===Yt.QUEUE14?li.AI_QUEUE14:t===Yt.QUEUE15?li.AI_QUEUE15:t===Yt.QUEUE16?li.AI_QUEUE16:t===Yt.QUEUE17?li.AI_QUEUE17:t===Yt.QUEUE18?li.AI_QUEUE18:t===Yt.QUEUE19?li.AI_QUEUE19:t===Yt.QUEUE20?li.AI_QUEUE20:null}huntAll(){if(this.nextHuntTick>zl.currentTick)return;const t=jt.get(this.huntMode);if(t.type===Bt.OFF)return;if(t.nobodyNear===Gt.PAUSEHUNT&&!zl.getZoneGrid(this.level).isFlagged(Ws.zone(this.x),Ws.zone(this.z),5))return;if(!t.findKeepHunting&&null!==this.target)return;let e;if(e=t.type===Bt.PLAYER?this.huntPlayers(t):t.type===Bt.NPC?this.huntNpcs(t):t.type===Bt.OBJ?this.huntObjs(t):this.huntLocs(t),e.length>0){const s=e[Math.floor(Math.random()*e.length)];this.setInteraction(hi.SCRIPT,s,t.findNewMode)}this.nextHuntTick=zl.currentTick+t.rate}huntPlayers(t){const e=he.get(this.type),s=[],n=new qn(zl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,-1,-1,Bt.PLAYER);for(const i of n){if(!(i instanceof bo))throw new Error('[Npc] huntAll must be of type Player here.');if((!t.checkAfk||!i.zonesAfk())&&((t.checkNotTooStrong!==Mt.OUTSIDE_WILDERNESS||i.isInWilderness()||!(i.combatLevel>2*e.vislevel))&&!(-1!==t.checkNotCombat&&i.getVar(t.checkNotCombat)+8>zl.currentTick||-1!==t.checkNotCombatSelf&&this.getVar(t.checkNotCombatSelf)>=zl.currentTick))){if(-1!==t.checkInv){let e=0;if(-1!==t.checkObj?e=i.invTotal(t.checkInv,t.checkObj):-1!==t.checkObjParam&&(e=i.invTotalParam(t.checkInv,t.checkObjParam)),e<t.checkInvMinQuantity||e>t.checkInvMaxQuantity)continue}t.checkNotBusy&&i.busy()||s.push(i)}}return s}huntNpcs(t){return Array.from(new qn(zl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkNpc,t.checkCategory,Bt.NPC))}huntObjs(t){return Array.from(new qn(zl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkObj,t.checkCategory,Bt.OBJ))}huntLocs(t){return Array.from(new qn(zl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkLoc,t.checkCategory,Bt.SCENERY))}playAnimation(t,e){this.animId=t,this.animDelay=e,this.mask|=bl.ANIM}spotanim(t,e,s){this.graphicId=t,this.graphicHeight=e,this.graphicDelay=s,this.mask|=bl.SPOTANIM}applyDamage(t,e){this.damageTaken=t,this.damageType=e;const s=this.levels[le.HITPOINTS];s-t<=0?(this.levels[le.HITPOINTS]=0,this.damageTaken=s):this.levels[le.HITPOINTS]=s-t,this.mask|=bl.DAMAGE}say(t){t&&(this.chat=t,this.mask|=bl.SAY)}faceSquare(t,e){this.faceX=2*t+1,this.faceZ=2*e+1,this.orientation=Ws.face(this.x,this.z,t,e),this.mask|=bl.FACE_COORD}changeType(t){this.type=t,this.mask|=bl.CHANGE_TYPE,this.uid=t<<16|this.nid;const e=he.get(t);this.setTimer(e.timer)}}class Ul{static OPEN=0;static BLOCKED=1;static BRIDGE=2;static ROOF=4;static WALL=8;static LOWMEMORY=16;static Y=4;static X=64;static Z=64;static MAPSQUARE=Ul.X*Ul.Y*Ul.Z;async init(t){console.time('Loading game map');const e='data/pack/server/maps/',s=['m29_75','m30_75','m31_75','m32_70','m32_71','m32_72','m32_73','m32_74','m32_75','m33_70','m33_71','m33_72','m33_73','m33_74','m33_75','m33_76','m34_70','m34_71','m34_72','m34_73','m34_74','m34_75','m34_76','m35_20','m35_75','m35_76','m36_146','m36_147','m36_148','m36_149','m36_150','m36_153','m36_154','m36_52','m36_53','m36_54','m36_72','m36_73','m36_74','m36_75','m36_76','m37_146','m37_147','m37_148','m37_149','m37_150','m37_151','m37_152','m37_153','m37_154','m37_48','m37_49','m37_50','m37_51','m37_52','m37_53','m37_54','m37_55','m37_72','m37_73','m37_74','m37_75','m38_146','m38_147','m38_148','m38_149','m38_150','m38_151','m38_152','m38_153','m38_154','m38_155','m38_45','m38_46','m38_47','m38_48','m38_49','m38_50','m38_51','m38_52','m38_53','m38_54','m38_55','m38_72','m38_73','m38_74','m39_147','m39_148','m39_149','m39_150','m39_151','m39_152','m39_153','m39_154','m39_155','m39_45','m39_46','m39_47','m39_48','m39_49','m39_50','m39_51','m39_52','m39_53','m39_54','m39_55','m39_72','m39_73','m39_74','m39_75','m39_76','m40_147','m40_148','m40_149','m40_150','m40_151','m40_152','m40_153','m40_154','m40_45','m40_46','m40_47','m40_48','m40_49','m40_50','m40_51','m40_52','m40_53','m40_54','m40_55','m40_72','m40_73','m40_74','m40_75','m40_76','m41_146','m41_149','m41_151','m41_152','m41_153','m41_154','m41_45','m41_46','m41_47','m41_48','m41_49','m41_50','m41_51','m41_52','m41_53','m41_54','m41_55','m41_56','m41_72','m41_73','m41_74','m41_75','m42_144','m42_145','m42_146','m42_151','m42_152','m42_153','m42_49','m42_50','m42_51','m42_52','m42_53','m42_54','m42_55','m42_56','m42_72','m42_73','m42_74','m42_75','m43_144','m43_145','m43_146','m43_153','m43_154','m43_45','m43_46','m43_47','m43_48','m43_49','m43_50','m43_51','m43_52','m43_53','m43_54','m43_55','m43_56','m43_72','m43_73','m43_74','m43_75','m44_144','m44_145','m44_146','m44_148','m44_149','m44_150','m44_151','m44_152','m44_153','m44_154','m44_155','m44_45','m44_46','m44_47','m44_48','m44_49','m44_50','m44_51','m44_52','m44_53','m44_54','m44_55','m44_72','m44_73','m44_74','m44_75','m45_145','m45_146','m45_148','m45_150','m45_151','m45_152','m45_153','m45_154','m45_155','m45_45','m45_46','m45_47','m45_48','m45_49','m45_50','m45_51','m45_52','m45_53','m45_54','m45_55','m45_56','m45_57','m45_58','m45_59','m45_60','m45_61','m45_62','m45_73','m45_74','m45_75','m45_76','m46_149','m46_150','m46_152','m46_153','m46_154','m46_161','m46_45','m46_46','m46_47','m46_48','m46_49','m46_50','m46_51','m46_52','m46_53','m46_54','m46_55','m46_56','m46_57','m46_58','m46_59','m46_60','m46_61','m46_62','m46_75','m47_148','m47_149','m47_150','m47_152','m47_153','m47_160','m47_161','m47_47','m47_48','m47_49','m47_50','m47_51','m47_52','m47_53','m47_54','m47_55','m47_56','m47_57','m47_58','m47_59','m47_60','m47_61','m47_62','m47_75','m48_148','m48_149','m48_152','m48_153','m48_154','m48_155','m48_156','m48_47','m48_48','m48_49','m48_50','m48_51','m48_52','m48_53','m48_54','m48_55','m48_56','m48_57','m48_58','m48_59','m48_60','m48_61','m48_62','m49_148','m49_149','m49_153','m49_154','m49_155','m49_156','m49_46','m49_47','m49_48','m49_49','m49_50','m49_51','m49_52','m49_53','m49_54','m49_55','m49_56','m49_57','m49_58','m49_59','m49_60','m49_61','m49_62','m50_149','m50_150','m50_152','m50_153','m50_154','m50_46','m50_47','m50_48','m50_49','m50_50','m50_51','m50_52','m50_53','m50_54','m50_55','m50_56','m50_57','m50_58','m50_59','m50_60','m50_61','m50_62','m51_147','m51_154','m51_46','m51_47','m51_48','m51_49','m51_50','m51_51','m51_52','m51_53','m51_54','m51_55','m51_56','m51_57','m51_58','m51_59','m51_60','m51_61','m51_62','m52_152','m52_153','m52_154','m52_46','m52_47','m52_48','m52_49','m52_50','m52_51','m52_52','m52_53','m52_54','m52_55','m52_56','m52_57','m52_58','m52_59','m52_60','m52_61','m52_62','m53_49','m53_50','m53_51','m53_52','m53_53'];for(let n=0;n<s.length;n++){const[i,a]=s[n].substring(1).split('_').map(Number),r=i<<6,o=a<<6;this.decodeNpcs(await ut.load(`${e}n${i}_${a}`),r,o),this.decodeObjs(await ut.load(`${e}o${i}_${a}`),r,o,t);const c=new Int8Array(Ul.MAPSQUARE);this.decodeLands(c,await ut.load(`${e}m${i}_${a}`),r,o),this.decodeLocs(c,await ut.load(`${e}l${i}_${a}`),r,o,t)}console.timeEnd('Loading game map')}changeLandCollision(t,e,s,n){qe(t,e,s,n)}changeLocCollision(t,e,s,n,i,a,r,o,c,l){const h=gs(t);h===bs.WALL?ns(r,o,c,e,t,s,!1,l):h===bs.GROUND?e===ws.NORTH||e===ws.SOUTH?Qe(r,o,c,n,i,s,!1,l):Qe(r,o,c,i,n,s,!1,l):h===bs.GROUND_DECOR&&1===a&&qe(r,o,c,l)}changeNpcCollision(t,e,s,n,i){ts(e,s,n,t,i)}changePlayerCollision(t,e,s,n,i){es(e,s,n,t,i)}changeRoofCollision(t,e,s,n){ss(t,e,s,n)}decodeNpcs(t,e,s){for(;t.available>0;){const{x:n,z:i,level:a}=this.unpackCoord(t.g2()),r=e+n,o=s+i,c=t.g1();for(let e=0;e<c;e++){const e=he.get(t.g2()),s=e.size,n=new bl(a,r,o,s,s,zn.RESPAWN,zl.getNextNid(),e.id,e.moverestrict,e.blockwalk);(e.members&&ge.NODE_MEMBERS||!e.members)&&zl.addNpc(n,-1)}}}decodeObjs(t,e,s,n){for(;t.available>0;){const{x:i,z:a,level:r}=this.unpackCoord(t.g2()),o=e+i,c=s+a,l=t.g1();for(let e=0;e<l;e++){const e=_e.get(t.g2()),s=new jn(r,o,c,zn.RESPAWN,e.id,t.g1());(e.members&&ge.NODE_MEMBERS||!e.members)&&n.zone(s.x,s.z,s.level).addStaticObj(s)}}}decodeLands(t,e,s,n){for(let s=0;s<Ul.Y;s++)for(let n=0;n<Ul.X;n++)for(let i=0;i<Ul.Z;i++)for(;;){const a=e.g1();if(0===a)break;if(1===a){e.pos++;break}a<=49?e.pos++:a<=81&&(t[this.packCoord(n,i,s)]=a-49)}for(let e=0;e<Ul.Y;e++)for(let i=0;i<Ul.X;i++){const a=i+s;for(let s=0;s<Ul.Z;s++){const r=s+n;i%7==0&&s%7==0&&is(a,r,e);const o=t[this.packCoord(i,s,e)];if((o&Ul.ROOF)!==Ul.OPEN&&this.changeRoofCollision(a,r,e,!0),(o&Ul.BLOCKED)!==Ul.BLOCKED)continue;const c=(1===e?o&Ul.BRIDGE:t[this.packCoord(i,s,1)]&Ul.BRIDGE)===Ul.BRIDGE?e-1:e;c<0||this.changeLandCollision(a,r,c,!0)}}}decodeLocs(t,e,s,n,i){let a=-1,r=e.gsmart();for(;0!==r;){a+=r;let o=0,c=e.gsmart();for(;0!==c;){const{x:r,z:l,level:h}=this.unpackCoord(o+=c-1),d=e.g1();c=e.gsmart();const p=(1===h?t[o]&Ul.BRIDGE:t[this.packCoord(r,l,1)]&Ul.BRIDGE)===Ul.BRIDGE?h-1:h;if(p<0)continue;const u=ee.get(a),g=u.width,_=u.length,m=d>>2,f=3&d,E=r+s,O=l+n;i.zone(E,O,p).addStaticLoc(new ei(p,E,O,g,_,zn.RESPAWN,a,m,f)),u.blockwalk&&this.changeLocCollision(m,f,u.blockrange,_,g,u.active,E,O,p,!0)}r=e.gsmart()}}packCoord(t,e,s){return 63&e|(63&t)<<6|(3&s)<<12}unpackCoord(t){return{x:t>>6&63,z:63&t,level:t>>12&3}}}class Dl{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(t=[0,0,0,0]){for(let e=0;e<t.length;e++)this.rsl[e]=t[e];this.init()}init(){let t=2654435769,e=2654435769,s=2654435769,n=2654435769,i=2654435769,a=2654435769,r=2654435769,o=2654435769;for(let c=0;c<4;c++)t^=e<<11,n+=t,e+=s,e^=s>>>2,i+=e,s+=n,s^=n<<8,a+=s,n+=i,n^=i>>>16,r+=n,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,s+=o,t+=e;for(let c=0;c<256;c+=8)t+=this.rsl[c],e+=this.rsl[c+1],s+=this.rsl[c+2],n+=this.rsl[c+3],i+=this.rsl[c+4],a+=this.rsl[c+5],r+=this.rsl[c+6],o+=this.rsl[c+7],t^=e<<11,n+=t,e+=s,e^=s>>>2,i+=e,s+=n,s^=n<<8,a+=s,n+=i,n^=i>>>16,r+=n,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,s+=o,t+=e,this.mem[c]=t,this.mem[c+1]=e,this.mem[c+2]=s,this.mem[c+3]=n,this.mem[c+4]=i,this.mem[c+5]=a,this.mem[c+6]=r,this.mem[c+7]=o;for(let c=0;c<256;c+=8)t+=this.mem[c],e+=this.mem[c+1],s+=this.mem[c+2],n+=this.mem[c+3],i+=this.mem[c+4],a+=this.mem[c+5],r+=this.mem[c+6],o+=this.mem[c+7],t^=e<<11,n+=t,e+=s,e^=s>>>2,i+=e,s+=n,s^=n<<8,a+=s,n+=i,n^=i>>>16,r+=n,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,s+=o,t+=e,this.mem[c]=t,this.mem[c+1]=e,this.mem[c+2]=s,this.mem[c+3]=n,this.mem[c+4]=i,this.mem[c+5]=a,this.mem[c+6]=r,this.mem[c+7]=o;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let t=0;t<256;t++){const e=this.mem[t];switch(3&t){case 0:this.a^=this.a<<13;break;case 1:this.a^=this.a>>>6;break;case 2:this.a^=this.a<<2;break;case 3:this.a^=this.a>>>16}let s;this.a+=this.mem[t+128&255],this.mem[t]=s=this.mem[e>>>2&255]+this.a+this.b,this.rsl[t]=this.b=this.mem[s>>>8>>>2&255]+e}}nextInt(){return 0==this.count--&&(this.isaac(),this.count=255),this.rsl[this.count]}}class Ml{static loadFromFile(t){const e=ot(rt(t));let s;return s=fs.existsSync(`data/players/${e}.sav`)?ut.load(`data/players/${e}.sav`):new ut(new Uint8Array),Ml.load(t,s,null)}static load(t,e,s){const n=rt(t),i=ot(n),a=s?new Il(i,n,s):new bo(i,n);if(e.data.length<2){for(let t=0;t<21;t++)a.stats[t]=0,a.baseLevels[t]=1,a.levels[t]=1;return a.stats[js.HITPOINTS]=Co(10),a.baseLevels[js.HITPOINTS]=10,a.levels[js.HITPOINTS]=10,a}if(8196!==e.g2())throw new Error('Invalid player save');const r=e.g2();if(r>3)throw new Error('Unsupported player save format');e.pos=e.data.length-4;if(e.g4()!=ut.getcrc(e.data,0,e.data.length-4))throw new Error('Player save corrupted');e.pos=4,a.x=e.g2(),a.z=e.g2(),a.level=e.g1();for(let t=0;t<7;t++)a.body[t]=e.g1(),255===a.body[t]&&(a.body[t]=-1);for(let t=0;t<5;t++)a.colors[t]=e.g1();a.gender=e.g1(),a.runenergy=e.g2(),a.playtime=r>=2?e.g4():e.g2();for(let t=0;t<21;t++)a.stats[t]=e.g4(),a.baseLevels[t]=vo(a.stats[t]),a.levels[t]=e.g1();const o=e.g2();for(let t=0;t<o;t++)a.vars[t]=e.g4();const c=e.g1();for(let t=0;t<c;t++){const t=e.g2(),s=a.getInventory(t);if(s)for(let t=0;t<s.capacity;t++){const n=e.g2();if(0===n)continue;let i=e.g1();255===i&&(i=e.g4()),s.set(t,{id:n-1,count:i})}}if(r>=3){const t=e.g1();for(let s=0;s<t;s++)a.afkZones[s]=e.g4();a.lastAfkZone=e.g2()}return a.combatLevel=a.getCombatLevel(),a.lastResponse=zl.currentTick,ge.NODE_PRODUCTION?void 0!==ge.NODE_STAFF.find((t=>t===i))&&(a.staffModLevel=3):a.staffModLevel=3,a}}class kl{static SUCCESSFUL=Uint8Array.from([2]);static INVALID_USER_OR_PASS=Uint8Array.from([3]);static ACCOUNT_DISABLED=Uint8Array.from([4]);static LOGGED_IN=Uint8Array.from([5]);static SERVER_UPDATED=Uint8Array.from([6]);static WORLD_FULL=Uint8Array.from([7]);static LOGIN_SERVER_OFFLINE=Uint8Array.from([8]);static LOGIN_LIMIT_EXCEEDED=Uint8Array.from([9]);static UNABLE_TO_CONNECT=Uint8Array.from([10]);static LOGIN_REJECTED=Uint8Array.from([11]);static NEED_MEMBERS_ACCOUNT=Uint8Array.from([12]);static COULD_NOT_COMPLETE=Uint8Array.from([13]);static SERVER_UPDATING=Uint8Array.from([14]);static RECONNECTING=Uint8Array.from([15]);static LOGIN_ATTEMPTS_EXCEEDED=Uint8Array.from([16]);static STANDING_IN_MEMBERS=Uint8Array.from([17]);static STAFF_MOD_LEVEL=Uint8Array.from([18])}var xl=new class{loginThread=function(t){const e=new Blob([t],{type:'application/javascript'}),s=URL.createObjectURL(e);return new Worker(s,{type:'module'})}("\n// src/jagex2/datastruct/Linkable.ts\nclass Linkable {\n  key;\n  next;\n  prev;\n  constructor() {\n    this.key = 0n;\n    this.next = this;\n    this.prev = this;\n  }\n  unlink() {\n    if (!this.prev || !this.next) {\n      return;\n    }\n    this.prev.next = this.next;\n    this.next.prev = this.prev;\n    this.next = null;\n    this.prev = null;\n  }\n}\n\n// src/jagex2/datastruct/LinkList.ts\nclass LinkList {\n  sentinel;\n  cursor = null;\n  constructor() {\n    const head = new Linkable;\n    head.next = head;\n    head.prev = head;\n    this.sentinel = head;\n  }\n  addTail(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel.prev;\n    node.next = this.sentinel;\n    if (node.prev) {\n      node.prev.next = node;\n    }\n    node.next.prev = node;\n  }\n  addHead(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel;\n    node.next = this.sentinel.next;\n    node.prev.next = node;\n    if (node.next) {\n      node.next.prev = node;\n    }\n  }\n  removeHead() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      return null;\n    }\n    node?.unlink();\n    return node;\n  }\n  head() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  tail() {\n    const node = this.sentinel.prev;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  next() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  prev() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  clear() {\n    while (true) {\n      const node = this.sentinel.next;\n      if (node === this.sentinel) {\n        return;\n      }\n      node?.unlink();\n    }\n  }\n}\n\n// src/jagex2/datastruct/Hashable.ts\nclass Hashable extends Linkable {\n  nextHashable;\n  prevHashable;\n  constructor() {\n    super();\n    this.nextHashable = this;\n    this.prevHashable = this;\n  }\n  uncache() {\n    if (!this.prevHashable || !this.nextHashable) {\n      return;\n    }\n    this.prevHashable.nextHashable = this.nextHashable;\n    this.nextHashable.prevHashable = this.prevHashable;\n    this.nextHashable = null;\n    this.prevHashable = null;\n  }\n}\n\n// src/jagex2/io/Packet.ts\nclass Packet extends Hashable {\n  static crctable = new Int32Array(256);\n  static bitmask = new Uint32Array(33);\n  static crc32b = 3988292384;\n  static {\n    for (let i = 0;i < 32; i++) {\n      this.bitmask[i] = (1 << i) - 1;\n    }\n    this.bitmask[32] = 4294967295;\n    for (let b = 0;b < 256; b++) {\n      let remainder = b;\n      for (let bit = 0;bit < 8; bit++) {\n        if ((remainder & 1) == 1) {\n          remainder = remainder >>> 1 ^ this.crc32b;\n        } else {\n          remainder >>>= 1;\n        }\n      }\n      this.crctable[b] = remainder;\n    }\n  }\n  static getcrc(src, offset, length) {\n    let crc = 4294967295;\n    for (let i = offset;i < length; i++) {\n      crc = crc >>> 8 ^ this.crctable[(crc ^ src[i]) & 255];\n    }\n    return ~crc;\n  }\n  static checkcrc(src, offset, length, expected = 0) {\n    const checksum = Packet.getcrc(src, offset, length);\n    return checksum == expected;\n  }\n  static alloc(type) {\n    let packet = null;\n    if (type === 0 && this.cacheMinCount > 0) {\n      packet = this.cacheMin.removeHead();\n      this.cacheMinCount--;\n    } else if (type === 1 && this.cacheMidCount > 0) {\n      packet = this.cacheMid.removeHead();\n      this.cacheMidCount--;\n    } else if (type === 2 && this.cacheMaxCount > 0) {\n      packet = this.cacheMax.removeHead();\n      this.cacheMaxCount--;\n    } else if (type === 3 && this.cacheBigCount > 0) {\n      packet = this.cacheBig.removeHead();\n      this.cacheBigCount--;\n    } else if (type === 4 && this.cacheHugeCount > 0) {\n      packet = this.cacheHuge.removeHead();\n      this.cacheHugeCount--;\n    } else if (type === 5 && this.cacheUnimaginableCount > 0) {\n      packet = this.cacheUnimaginable.removeHead();\n      this.cacheUnimaginableCount--;\n    }\n    if (packet !== null) {\n      packet.pos = 0;\n      packet.bitPos = 0;\n      return packet;\n    }\n    if (type === 0) {\n      return new Packet(new Uint8Array(100));\n    } else if (type === 1) {\n      return new Packet(new Uint8Array(5000));\n    } else if (type === 2) {\n      return new Packet(new Uint8Array(30000));\n    } else if (type === 3) {\n      return new Packet(new Uint8Array(1e5));\n    } else if (type === 4) {\n      return new Packet(new Uint8Array(500000));\n    } else if (type === 5) {\n      return new Packet(new Uint8Array(2000000));\n    } else {\n      return new Packet(new Uint8Array(type));\n    }\n  }\n  static async load(path, seekToEnd = false) {\n    const packet = new Packet(new Uint8Array(await (await fetch(path)).arrayBuffer()));\n    if (seekToEnd) {\n      packet.pos = packet.data.length;\n    }\n    return packet;\n  }\n  static cacheMinCount = 0;\n  static cacheMidCount = 0;\n  static cacheMaxCount = 0;\n  static cacheBigCount = 0;\n  static cacheHugeCount = 0;\n  static cacheUnimaginableCount = 0;\n  static cacheMin = new LinkList;\n  static cacheMid = new LinkList;\n  static cacheMax = new LinkList;\n  static cacheBig = new LinkList;\n  static cacheHuge = new LinkList;\n  static cacheUnimaginable = new LinkList;\n  data;\n  #view;\n  pos;\n  bitPos;\n  constructor(src) {\n    super();\n    this.data = src;\n    this.#view = new DataView(this.data.buffer);\n    this.pos = 0;\n    this.bitPos = 0;\n  }\n  get available() {\n    return this.data.length - this.pos;\n  }\n  get length() {\n    return this.data.length;\n  }\n  release() {\n    this.pos = 0;\n    this.bitPos = 0;\n    if (this.data.length === 100 && Packet.cacheMinCount < 1000) {\n      Packet.cacheMin.addTail(this);\n      Packet.cacheMinCount++;\n    } else if (this.data.length === 5000 && Packet.cacheMidCount < 250) {\n      Packet.cacheMid.addTail(this);\n      Packet.cacheMidCount++;\n    } else if (this.data.length === 30000 && Packet.cacheMaxCount < 50) {\n      Packet.cacheMax.addTail(this);\n      Packet.cacheMaxCount++;\n    } else if (this.data.length === 1e5 && Packet.cacheBigCount < 10) {\n      Packet.cacheBig.addTail(this);\n      Packet.cacheBigCount++;\n    } else if (this.data.length === 500000 && Packet.cacheHugeCount < 5) {\n      Packet.cacheHuge.addTail(this);\n      Packet.cacheHugeCount++;\n    } else if (this.data.length === 2000000 && Packet.cacheUnimaginableCount < 2) {\n      Packet.cacheUnimaginable.addTail(this);\n      Packet.cacheUnimaginableCount++;\n    }\n  }\n  save(path, length = this.pos, start = 0) {\n    const blob = new Blob([this.data.subarray(start, start + length)], { type: \"application/octet-stream\" });\n    const url = URL.createObjectURL(blob);\n    self.postMessage({ type: \"save\", value: url, path });\n  }\n  p1(value) {\n    this.#view.setUint8(this.pos++, value);\n  }\n  p2(value) {\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  ip2(value) {\n    this.#view.setUint16(this.pos, value, true);\n    this.pos += 2;\n  }\n  p3(value) {\n    this.#view.setUint8(this.pos++, value >> 16);\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  p4(value) {\n    this.#view.setInt32(this.pos, value);\n    this.pos += 4;\n  }\n  ip4(value) {\n    this.#view.setInt32(this.pos, value, true);\n    this.pos += 4;\n  }\n  p8(value) {\n    this.#view.setBigInt64(this.pos, value);\n    this.pos += 8;\n  }\n  pbool(value) {\n    this.p1(value ? 1 : 0);\n  }\n  pjstr(str, terminator = 10) {\n    const length = str.length;\n    for (let i = 0;i < length; i++) {\n      this.#view.setUint8(this.pos++, str.charCodeAt(i));\n    }\n    this.#view.setUint8(this.pos++, terminator);\n  }\n  pdata(src, offset, length) {\n    this.data.set(src.subarray(offset, offset + length), this.pos);\n    this.pos += length - offset;\n  }\n  psize4(size) {\n    this.#view.setUint32(this.pos - size - 4, size);\n  }\n  psize2(size) {\n    this.#view.setUint16(this.pos - size - 2, size);\n  }\n  psize1(size) {\n    this.#view.setUint8(this.pos - size - 1, size);\n  }\n  psmarts(value) {\n    if (value < 64 && value >= 64) {\n      this.p1(value + 64);\n    } else if (value < 16384 && value >= -16384) {\n      this.p2(value + 49152);\n    } else {\n      throw new Error(\"Error psmarts out of range: \" + value);\n    }\n  }\n  psmart(value) {\n    if (value >= 0 && value < 128) {\n      this.p1(value);\n    } else if (value >= 0 && value < 32768) {\n      this.p2(value + 32768);\n    } else {\n      throw new Error(\"Error psmart out of range: \" + value);\n    }\n  }\n  g1() {\n    return this.#view.getUint8(this.pos++);\n  }\n  g1b() {\n    return this.#view.getInt8(this.pos++);\n  }\n  g2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2);\n  }\n  g2s() {\n    this.pos += 2;\n    return this.#view.getInt16(this.pos - 2);\n  }\n  ig2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2, true);\n  }\n  g3() {\n    const result = this.#view.getUint8(this.pos++) << 16 | this.#view.getUint16(this.pos);\n    this.pos += 2;\n    return result;\n  }\n  g4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4);\n  }\n  ig4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4, true);\n  }\n  g8() {\n    this.pos += 8;\n    return this.#view.getBigInt64(this.pos - 8);\n  }\n  gbool() {\n    return this.g1() === 1;\n  }\n  gjstr(terminator = 10) {\n    const length = this.data.length;\n    let str = \"\";\n    let b;\n    while ((b = this.#view.getUint8(this.pos++)) !== terminator && this.pos < length) {\n      str += String.fromCharCode(b);\n    }\n    return str;\n  }\n  gdata(dest, offset, length) {\n    dest.set(this.data.subarray(this.pos, this.pos + length), offset);\n    this.pos += length;\n  }\n  gsmarts() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() - 64 : this.g2() - 49152;\n  }\n  gsmart() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() : this.g2() - 32768;\n  }\n  bits() {\n    this.bitPos = this.pos << 3;\n  }\n  bytes() {\n    this.pos = this.bitPos + 7 >>> 3;\n  }\n  gBit(n) {\n    let bytePos = this.bitPos >>> 3;\n    let remaining = 8 - (this.bitPos & 7);\n    let value = 0;\n    this.bitPos += n;\n    for (;n > remaining; remaining = 8) {\n      value += (this.#view.getUint8(bytePos++) & Packet.bitmask[remaining]) << n - remaining;\n      n -= remaining;\n    }\n    if (n == remaining) {\n      value += this.#view.getUint8(bytePos) & Packet.bitmask[remaining];\n    } else {\n      value += this.#view.getUint8(bytePos) >>> remaining - n & Packet.bitmask[n];\n    }\n    return value;\n  }\n  pBit(n, value) {\n    const pos = this.bitPos;\n    this.bitPos += n;\n    let bytePos = pos >>> 3;\n    let remaining = 8 - (pos & 7);\n    const view = this.#view;\n    for (;n > remaining; remaining = 8) {\n      const shift2 = (1 << remaining) - 1;\n      const byte2 = view.getUint8(bytePos);\n      view.setUint8(bytePos++, byte2 & ~shift2 | value >>> n - remaining & shift2);\n      n -= remaining;\n    }\n    const r = remaining - n;\n    const shift = (1 << n) - 1;\n    const byte = view.getUint8(bytePos);\n    view.setUint8(bytePos, byte & ~shift << r | (value & shift) << r);\n  }\n}\n\n// src/jagex2/jstring/JString.ts\nfunction toBase37(string) {\n  string = string.trim();\n  let l = 0n;\n  for (let i = 0;i < string.length && i < 12; i++) {\n    const c = string.charCodeAt(i);\n    l *= 37n;\n    if (c >= 65 && c <= 90) {\n      l += BigInt(c + 1 - 65);\n    } else if (c >= 97 && c <= 122) {\n      l += BigInt(c + 1 - 97);\n    } else if (c >= 48 && c <= 57) {\n      l += BigInt(c + 27 - 48);\n    }\n  }\n  return l;\n}\nfunction fromBase37(value) {\n  if (value < 0n || value >= 6582952005840035281n) {\n    return \"invalid_name\";\n  }\n  if (value % 37n === 0n) {\n    return \"invalid_name\";\n  }\n  let len = 0;\n  const chars = Array(12);\n  while (value !== 0n) {\n    const l1 = value;\n    value /= 37n;\n    chars[11 - len++] = BASE37_LOOKUP[Number(l1 - value * 37n)];\n  }\n  return chars.slice(12 - len).join(\"\");\n}\nfunction toSafeName(name) {\n  return fromBase37(toBase37(name));\n}\nvar BASE37_LOOKUP = [\n  \"_\",\n  \"a\",\n  \"b\",\n  \"c\",\n  \"d\",\n  \"e\",\n  \"f\",\n  \"g\",\n  \"h\",\n  \"i\",\n  \"j\",\n  \"k\",\n  \"l\",\n  \"m\",\n  \"n\",\n  \"o\",\n  \"p\",\n  \"q\",\n  \"r\",\n  \"s\",\n  \"t\",\n  \"u\",\n  \"v\",\n  \"w\",\n  \"x\",\n  \"y\",\n  \"z\",\n  \"0\",\n  \"1\",\n  \"2\",\n  \"3\",\n  \"4\",\n  \"5\",\n  \"6\",\n  \"7\",\n  \"8\",\n  \"9\"\n];\n\n// src/lostcity/server/NetworkStream.ts\nclass NetworkStream {\n  queue = [];\n  available = 0;\n  buffer = null;\n  offset = 0;\n  waiting = 0;\n  received(buf) {\n    this.queue.push(buf);\n    this.available += buf.length;\n  }\n  clear() {\n    this.queue = [];\n    this.available = 0;\n    this.buffer = null;\n    this.offset = 0;\n  }\n  async readByte(socket) {\n    if (socket === null || socket.closed) {\n      return 0;\n    }\n    if (this.available < 1) {\n      await new Promise((res) => setTimeout(res, 10));\n      return this.readByte(socket);\n    }\n    if (this.buffer === null) {\n      this.buffer = this.queue.shift() ?? null;\n      this.offset = 0;\n    }\n    const value = this.buffer?.[this.offset] ?? 0;\n    this.offset++;\n    this.available--;\n    if (this.buffer && this.offset === this.buffer.length) {\n      this.buffer = null;\n    }\n    return value;\n  }\n  async readBytes(socket, destination, offset, length, full = true) {\n    if (socket === null || socket.closed) {\n      return 0;\n    }\n    if (this.available < length) {\n      if (full) {\n        await new Promise((res) => setTimeout(res, 10));\n        return this.readBytes(socket, destination, offset, length);\n      } else {\n        length = this.available;\n      }\n    }\n    destination.pos = offset;\n    for (let i = 0;i < length; i++) {\n      if (this.buffer === null) {\n        this.buffer = this.queue.shift() ?? null;\n        this.offset = 0;\n      }\n      destination.data[offset + i] = this.buffer?.[this.offset] ?? 0;\n      this.offset++;\n      this.available--;\n      if (this.buffer && this.offset === this.buffer.length) {\n        this.buffer = null;\n      }\n    }\n    return length;\n  }\n}\n\n// src/lostcity/util/Environment.ts\nvar Environment_default = {\n  WEB_PORT: 80,\n  WEB_CORS: true,\n  NODE_ID: 10,\n  NODE_PORT: 43594,\n  NODE_MEMBERS: true,\n  NODE_XPRATE: 1,\n  NODE_PRODUCTION: false,\n  NODE_KILLTIMER: 50,\n  NODE_ALLOW_CHEATS: true,\n  NODE_DEBUG: true,\n  NODE_DEBUG_PROFILE: false,\n  NODE_STAFF: [\"pazaz\"],\n  NODE_CLIENT_ROUTEFINDER: true,\n  NODE_SOCKET_TIMEOUT: true,\n  LOGIN_HOST: \"localhost\",\n  LOGIN_PORT: 43500,\n  LOGIN_KEY: \"\",\n  DB_HOST: \"localhost\",\n  DB_USER: \"root\",\n  DB_PASS: \"password\",\n  DB_NAME: \"lostcity\",\n  BUILD_JAVA_PATH: \"java\",\n  BUILD_STARTUP: true,\n  BUILD_STARTUP_UPDATE: true,\n  BUILD_VERIFY: true,\n  BUILD_VERIFY_FOLDER: true,\n  BUILD_VERIFY_PACK: true,\n  BUILD_SRC_DIR: \"data/src\"\n};\n\n// src/lostcity/server/LoginServer.ts\nclass LoginResponse {\n  static SUCCESSFUL = Uint8Array.from([2]);\n  static INVALID_USER_OR_PASS = Uint8Array.from([3]);\n  static ACCOUNT_DISABLED = Uint8Array.from([4]);\n  static LOGGED_IN = Uint8Array.from([5]);\n  static SERVER_UPDATED = Uint8Array.from([6]);\n  static WORLD_FULL = Uint8Array.from([7]);\n  static LOGIN_SERVER_OFFLINE = Uint8Array.from([8]);\n  static LOGIN_LIMIT_EXCEEDED = Uint8Array.from([9]);\n  static UNABLE_TO_CONNECT = Uint8Array.from([10]);\n  static LOGIN_REJECTED = Uint8Array.from([11]);\n  static NEED_MEMBERS_ACCOUNT = Uint8Array.from([12]);\n  static COULD_NOT_COMPLETE = Uint8Array.from([13]);\n  static SERVER_UPDATING = Uint8Array.from([14]);\n  static RECONNECTING = Uint8Array.from([15]);\n  static LOGIN_ATTEMPTS_EXCEEDED = Uint8Array.from([16]);\n  static STANDING_IN_MEMBERS = Uint8Array.from([17]);\n  static STAFF_MOD_LEVEL = Uint8Array.from([18]);\n}\nclass LoginClient {\n  socket = null;\n  stream = new NetworkStream;\n  async connect() {\n    if (this.socket) {\n      return;\n    }\n    return new Promise((res) => {\n      this.socket = net.createConnection({\n        port: Environment_default.LOGIN_PORT,\n        host: Environment_default.LOGIN_HOST\n      });\n      this.socket.setNoDelay(true);\n      this.socket.setTimeout(1000);\n      this.socket.on(\"data\", async (buf) => {\n        this.stream.received(buf);\n      });\n      this.socket.once(\"close\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"error\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"connect\", () => {\n        res();\n      });\n    });\n  }\n  disconnect() {\n    if (this.socket === null) {\n      return;\n    }\n    this.socket.destroy();\n    this.socket = null;\n    this.stream.clear();\n  }\n  async write(socket, opcode, data = null, full = true) {\n    if (socket === null) {\n      return;\n    }\n    const packet = new Packet(new Uint8Array(1 + 2 + (data !== null ? data?.length : 0)));\n    packet.p1(opcode);\n    if (data !== null) {\n      packet.p2(data.length);\n      packet.pdata(data, 0, data.length);\n    } else {\n      packet.p2(0);\n    }\n    const done = socket.write(packet.data);\n    if (!done && full) {\n      await new Promise((res) => {\n        const interval = setInterval(() => {\n          if (socket === null || socket.closed) {\n            clearInterval(interval);\n            res();\n          }\n        }, 100);\n        socket.once(\"drain\", () => {\n          clearInterval(interval);\n          res();\n        });\n      });\n    }\n  }\n  async load(username37, password, uid) {\n    await this.connect();\n    if (this.socket === null) {\n      return { reply: -1, data: null };\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + password.length + 1 + 4));\n    request.p2(Environment_default.NODE_ID);\n    request.p8(username37);\n    request.pjstr(password);\n    request.p4(uid);\n    await this.write(this.socket, 1, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    if (reply !== 1) {\n      this.disconnect();\n      return { reply, data: null };\n    }\n    const data = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, data, 0, 2);\n    const length = data.g2();\n    const data2 = new Packet(new Uint8Array(length));\n    await this.stream.readBytes(this.socket, data2, 0, length);\n    this.disconnect();\n    return { reply, data: data2 };\n  }\n  async save(username37, save) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + 2 + save.length));\n    request.p2(Environment_default.NODE_ID);\n    request.p8(username37);\n    request.p2(save.length);\n    request.pdata(save, 0, save.length);\n    await this.write(this.socket, 2, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    this.disconnect();\n    return reply;\n  }\n  async reset() {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(Environment_default.NODE_ID);\n    await this.write(this.socket, 3, request.data);\n    this.disconnect();\n  }\n  async count(world) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(world);\n    await this.write(this.socket, 4, request.data);\n    const reply = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, reply, 0, 2);\n    const count = reply.g2();\n    this.disconnect();\n    return count;\n  }\n  async heartbeat(players) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 2 + players.length * 8));\n    request.p2(Environment_default.NODE_ID);\n    request.p2(players.length);\n    for (const player of players) {\n      request.p8(player);\n    }\n    await this.write(this.socket, 5, request.data);\n    this.disconnect();\n  }\n}\n\n// src/lostcity/server/LoginThread.ts\nself.onmessage = async (msg) => {\n  try {\n    switch (msg.data.type) {\n      case \"reset\": {\n        break;\n      }\n      case \"heartbeat\": {\n        break;\n      }\n      case \"loginreq\": {\n        const { opcode, data, socket } = msg.data;\n        const stream = new Packet(data);\n        const revision = stream.g1();\n        if (revision !== 225) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.SERVER_UPDATED,\n            socket\n          });\n          return;\n        }\n        const info = stream.g1();\n        const crcs = new Uint8Array(9 * 4);\n        stream.gdata(crcs, 0, crcs.length);\n        const enc = new Uint8Array(stream.g1());\n        stream.gdata(enc, 0, enc.length);\n        stream.pos = 0;\n        stream.pdata(enc, 0, enc.length);\n        stream.pos = 0;\n        if (stream.g1() !== 10) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.LOGIN_REJECTED,\n            socket\n          });\n          return;\n        }\n        const seed = [];\n        for (let i = 0;i < 4; i++) {\n          seed[i] = stream.g4();\n        }\n        const uid = stream.g4();\n        const username = stream.gjstr();\n        const password = stream.gjstr();\n        if (username.length < 1 || username.length > 12) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.INVALID_USER_OR_PASS,\n            socket\n          });\n          return;\n        }\n        if (Environment_default.LOGIN_KEY) {\n          if (password.length < 5 || password.length > 20) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.INVALID_USER_OR_PASS,\n              socket\n            });\n            return;\n          }\n          const login = new LoginClient;\n          const request = await login.load(toBase37(toSafeName(username)), password, uid);\n          if (request.reply === 1 && request.data) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.SUCCESSFUL,\n              socket,\n              info,\n              seed,\n              username: toSafeName(username),\n              save: request.data.data\n            });\n          } else if ((request.reply === 2 || request.reply === 3) && opcode === 16) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGGED_IN,\n              socket\n            });\n            return;\n          } else if (request.reply === 3 && opcode === 18) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGGED_IN,\n              socket\n            });\n            return;\n          } else if (request.reply === 4) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.SUCCESSFUL,\n              socket,\n              info,\n              seed,\n              username: toSafeName(username),\n              save: new Uint8Array\n            });\n          } else if (request.reply === 5) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.INVALID_USER_OR_PASS,\n              socket\n            });\n            return;\n          } else if (request.reply === -1) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGIN_SERVER_OFFLINE,\n              socket\n            });\n            return;\n          } else {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGIN_REJECTED,\n              socket\n            });\n            return;\n          }\n        } else {\n          let save = new Uint8Array;\n          const safeName = toSafeName(username);\n          const url = new URL(\"data/players/\" + safeName + \".sav\", self.location.origin);\n          if ((await fetch(url)).ok) {\n            save = new Uint8Array(await (await fetch(url)).arrayBuffer());\n          }\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.SUCCESSFUL,\n            socket,\n            info,\n            seed,\n            username: safeName,\n            save\n          });\n        }\n        break;\n      }\n      case \"logout\": {\n        const { username, save } = msg.data;\n        if (Environment_default.LOGIN_KEY) {\n          const login = new LoginClient;\n          const reply = await login.save(toBase37(username), save);\n          if (reply === 0) {\n            self.postMessage({\n              type: \"logoutreply\",\n              username\n            });\n          }\n        } else {\n          self.postMessage({\n            type: \"logoutreply\",\n            username\n          });\n        }\n        break;\n      }\n      default:\n        console.error(\"Unknown message type: \" + msg.data.type);\n        break;\n    }\n  } catch (err) {\n    console.error(err);\n  }\n};\n");loginRequests=new Map;logoutRequests=new Set;constructor(){this.loginThread.onmessage=t=>{try{this.onMessage(t)}catch(t){console.error('Login Thread:',t)}}}async readIn(t,e){const s=e.g1();if(16===s){const n=e.g1();if(e.available<n)return void t.terminate();const i=new Uint8Array(n);e.gdata(i,0,i.length),e.pos-=i.length;if(225!==e.g1())return void t.writeImmediate(kl.SERVER_UPDATED);e.pos+=1;const a=new Uint8Array(36);e.gdata(a,0,a.length),this.loginThread.postMessage({type:'loginreq',opcode:s,data:i,socket:t.uniqueId}),this.loginRequests.set(t.uniqueId,t)}else t.terminate()}logout(t){if(this.logoutRequests.has(t.username37))return;const e=t.save();this.loginThread.postMessage({type:'logout',username:t.username,save:e.data.subarray(0,e.pos)}),e.release()}onMessage(t){switch(t.data.type){case'loginreply':{const{status:e,socket:s}=t.data,n=this.loginRequests.get(s);if(!n)return;if(this.loginRequests.delete(s),2!==e[0])return n.writeImmediate(e),void n.close();const{info:i,seed:a,username:r,save:o}=t.data;if(zl.getTotalPlayers()>=2e3)return n.writeImmediate(kl.WORLD_FULL),void n.close();if(zl.shutdownTick>-1&&zl.currentTick-zl.shutdownTick>0)return n.writeImmediate(kl.SERVER_UPDATING),void n.close();if(!ge.LOGIN_KEY)for(const t of zl.players)if(t.username===r)return n.writeImmediate(kl.LOGGED_IN),void n.close();n.decryptor=new Dl(a);for(let t=0;t<4;t++)a[t]+=50;n.encryptor=new Dl(a);const c=Ml.load(r,new ut(o),n);c.lowMemory=!!(1&i),zl.addPlayer(c);break}case'logoutreply':{const{username:e}=t.data,s=zl.getPlayerByUsername(e);s&&(zl.getZone(s.x,s.z,s.level).leave(s),zl.players.remove(s.pid),s.pid=-1,s.terminate(),this.logoutRequests.delete(s.username37));break}default:throw new Error('Unknown message type: '+t.data.type)}}};class Bl extends Array{free;indexPadding;ids;lastUsedIndex=0;constructor(t,e){super(t),this.ids=new Int32Array(t).fill(-1),this.free=new Set(Array.from({length:t},((t,e)=>e))),this.indexPadding=e}next(t=!1,e=this.lastUsedIndex+1){const s=this.ids.length;for(let t=e;t<s;t++)if(-1===this.ids[t])return t;for(let t=this.indexPadding;t<e;t++)if(-1===this.ids[t])return t;throw new Error('[EntityList] cannot find next id')}*[Symbol.iterator](){for(const t of this.ids){if(-1===t)continue;const e=this[t];void 0!==e&&(yield e)}}get count(){let t=0;for(const e of this[Symbol.iterator]())t++;return t}get(t){const e=this.ids[t];return-1!==e?this[e]:void 0}set(t,e){if(!this.free.size)throw new Error('[EntityList] cannot find available entities slot.');const s=this.free.values().next().value;this.free.delete(s),this.ids[t]=s,this[s]=e,this.lastUsedIndex=t}remove(t){const e=this.ids[t];-1!==e&&(this.splice(e,1),this.ids[t]=-1,this.free.add(e))}reset(){this.length=0,this.ids.fill(-1),this.free.clear();for(let t=0;t<this.ids.length;t++)this.free.add(t)}}class Fl extends Bl{constructor(t){super(t,0)}}class Hl extends Bl{constructor(t){super(t,1)}next(t=!1,e=this.lastUsedIndex+1){if(t){for(let t=0===e?1:0;t<100;t++){const s=e+t;if(-1===this.ids[s])return s}}return super.next()}}class Gl extends Ui{ticks;priority=Di.LOW;constructor(t){super(),this.ticks=t}}class Wl{static PLAYERS=2048;static NPCS=8192;static NORMAL_TICKRATE=600;static SHUTDOWN_TICKRATE=1;static LOGIN_PINGRATE=100;static INV_STOCKRATE=100;static AFK_EVENTRATE=500;static PLAYER_SAVERATE=1500;static SHUTDOWN_TICKS=24e3;static TIMEOUT_IDLE_TICKS=75;static TIMEOUT_LOGOUT_TICKS=100;gameMap;zoneMap;invs;newPlayers;players;npcs;zonesTracking;queue;lastCycleStats;cycleStats;tickRate=Wl.NORMAL_TICKRATE;currentTick=0;shutdownTick=-1;allLastModified=0;datLastModified=new Map;vars=new Int32Array;varsString=[];constructor(){this.gameMap=new Ul,this.zoneMap=new yo,this.invs=new Set,this.newPlayers=new Set,this.players=new Hl(Wl.PLAYERS),this.npcs=new Fl(Wl.NPCS),this.zonesTracking=new Map,this.queue=new dt,this.lastCycleStats=new Array(12).fill(0),this.cycleStats=new Array(12).fill(0)}shouldReload(t,e=!1){return!0}async reload(){let t=!1;if(this.shouldReload('varp',!0)&&(await Ae.load('data/pack'),t=!0),this.shouldReload('param')&&await de.load('data/pack'),this.shouldReload('obj',!0)&&(await _e.load('data/pack'),t=!0),this.shouldReload('loc',!0)&&(await ee.load('data/pack'),t=!0),this.shouldReload('npc',!0)&&(await he.load('data/pack'),t=!0),this.shouldReload('idk',!0)&&(await Kt.load('data/pack'),t=!0),this.shouldReload('frame_del')&&await me.load('data/pack'),this.shouldReload('seq',!0)&&(await fe.load('data/pack'),t=!0),this.shouldReload('spotanim',!0)&&(await Se.load('data/pack'),t=!0),this.shouldReload('category')&&await _t.load('data/pack'),this.shouldReload('enum')&&await Ot.load('data/pack'),this.shouldReload('struct')&&await Ee.load('data/pack'),this.shouldReload('inv')){await $t.load('data/pack'),this.invs.clear();for(let t=0;t<$t.count;t++){const e=$t.get(t);e&&e.scope===$t.SCOPE_SHARED&&this.invs.add(Ye.fromType(t))}}if(this.shouldReload('mesanim')&&await se.load('data/pack'),this.shouldReload('dbtable')&&await ft.load('data/pack'),this.shouldReload('dbrow')&&await Et.load('data/pack'),this.shouldReload('hunt')&&await jt.load('data/pack'),this.shouldReload('varn')&&await Oe.load('data/pack'),this.shouldReload('vars')&&(await Te.load('data/pack'),this.vars.length!==Te.count)){const t=this.vars;this.vars=new Int32Array(Te.count);for(let e=0;e<Te.count&&e<t.length;e++)this.vars[e]=t[e];const e=this.varsString;this.varsString=new Array(Te.count);for(let s=0;s<Te.count&&s<t.length;s++)this.varsString[s]=e[s]}if(this.shouldReload('interface')&&(await Zt.load('data/pack'),t=!0),this.shouldReload('script')){const t=await Fe.load('data/pack');-1===t?this.broadcastMes('There was an issue while reloading scripts.'):this.broadcastMes(`Reloaded ${t} scripts.`)}await async function(){const t=['l29_75','l30_75','l31_75','l32_70','l32_71','l32_72','l32_73','l32_74','l32_75','l33_70','l33_71','l33_72','l33_73','l33_74','l33_75','l33_76','l34_70','l34_71','l34_72','l34_73','l34_74','l34_75','l34_76','l35_20','l35_75','l35_76','l36_146','l36_147','l36_148','l36_149','l36_150','l36_153','l36_154','l36_52','l36_53','l36_54','l36_72','l36_73','l36_74','l36_75','l36_76','l37_146','l37_147','l37_148','l37_149','l37_150','l37_151','l37_152','l37_153','l37_154','l37_48','l37_49','l37_50','l37_51','l37_52','l37_53','l37_54','l37_55','l37_72','l37_73','l37_74','l37_75','l38_146','l38_147','l38_148','l38_149','l38_150','l38_151','l38_152','l38_153','l38_154','l38_155','l38_45','l38_46','l38_47','l38_48','l38_49','l38_50','l38_51','l38_52','l38_53','l38_54','l38_55','l38_72','l38_73','l38_74','l39_147','l39_148','l39_149','l39_150','l39_151','l39_152','l39_153','l39_154','l39_155','l39_45','l39_46','l39_47','l39_48','l39_49','l39_50','l39_51','l39_52','l39_53','l39_54','l39_55','l39_72','l39_73','l39_74','l39_75','l39_76','l40_147','l40_148','l40_149','l40_150','l40_151','l40_152','l40_153','l40_154','l40_45','l40_46','l40_47','l40_48','l40_49','l40_50','l40_51','l40_52','l40_53','l40_54','l40_55','l40_72','l40_73','l40_74','l40_75','l40_76','l41_146','l41_149','l41_151','l41_152','l41_153','l41_154','l41_45','l41_46','l41_47','l41_48','l41_49','l41_50','l41_51','l41_52','l41_53','l41_54','l41_55','l41_56','l41_72','l41_73','l41_74','l41_75','l42_144','l42_145','l42_146','l42_151','l42_152','l42_153','l42_49','l42_50','l42_51','l42_52','l42_53','l42_54','l42_55','l42_56','l42_72','l42_73','l42_74','l42_75','l43_144','l43_145','l43_146','l43_153','l43_154','l43_45','l43_46','l43_47','l43_48','l43_49','l43_50','l43_51','l43_52','l43_53','l43_54','l43_55','l43_56','l43_72','l43_73','l43_74','l43_75','l44_144','l44_145','l44_146','l44_148','l44_149','l44_150','l44_151','l44_152','l44_153','l44_154','l44_155','l44_45','l44_46','l44_47','l44_48','l44_49','l44_50','l44_51','l44_52','l44_53','l44_54','l44_55','l44_72','l44_73','l44_74','l44_75','l45_145','l45_146','l45_148','l45_150','l45_151','l45_152','l45_153','l45_154','l45_155','l45_45','l45_46','l45_47','l45_48','l45_49','l45_50','l45_51','l45_52','l45_53','l45_54','l45_55','l45_56','l45_57','l45_58','l45_59','l45_60','l45_61','l45_62','l45_73','l45_74','l45_75','l45_76','l46_149','l46_150','l46_152','l46_153','l46_154','l46_161','l46_45','l46_46','l46_47','l46_48','l46_49','l46_50','l46_51','l46_52','l46_53','l46_54','l46_55','l46_56','l46_57','l46_58','l46_59','l46_60','l46_61','l46_62','l46_75','l47_148','l47_149','l47_150','l47_152','l47_153','l47_160','l47_161','l47_47','l47_48','l47_49','l47_50','l47_51','l47_52','l47_53','l47_54','l47_55','l47_56','l47_57','l47_58','l47_59','l47_60','l47_61','l47_62','l47_75','l48_148','l48_149','l48_152','l48_153','l48_154','l48_155','l48_156','l48_47','l48_48','l48_49','l48_50','l48_51','l48_52','l48_53','l48_54','l48_55','l48_56','l48_57','l48_58','l48_59','l48_60','l48_61','l48_62','l49_148','l49_149','l49_153','l49_154','l49_155','l49_156','l49_46','l49_47','l49_48','l49_49','l49_50','l49_51','l49_52','l49_53','l49_54','l49_55','l49_56','l49_57','l49_58','l49_59','l49_60','l49_61','l49_62','l50_149','l50_150','l50_152','l50_153','l50_154','l50_46','l50_47','l50_48','l50_49','l50_50','l50_51','l50_52','l50_53','l50_54','l50_55','l50_56','l50_57','l50_58','l50_59','l50_60','l50_61','l50_62','l51_147','l51_154','l51_46','l51_47','l51_48','l51_49','l51_50','l51_51','l51_52','l51_53','l51_54','l51_55','l51_56','l51_57','l51_58','l51_59','l51_60','l51_61','l51_62','l52_152','l52_153','l52_154','l52_46','l52_47','l52_48','l52_49','l52_50','l52_51','l52_52','l52_53','l52_54','l52_55','l52_56','l52_57','l52_58','l52_59','l52_60','l52_61','l52_62','l53_49','l53_50','l53_51','l53_52','l53_53','m29_75','m30_75','m31_75','m32_70','m32_71','m32_72','m32_73','m32_74','m32_75','m33_70','m33_71','m33_72','m33_73','m33_74','m33_75','m33_76','m34_70','m34_71','m34_72','m34_73','m34_74','m34_75','m34_76','m35_20','m35_75','m35_76','m36_146','m36_147','m36_148','m36_149','m36_150','m36_153','m36_154','m36_52','m36_53','m36_54','m36_72','m36_73','m36_74','m36_75','m36_76','m37_146','m37_147','m37_148','m37_149','m37_150','m37_151','m37_152','m37_153','m37_154','m37_48','m37_49','m37_50','m37_51','m37_52','m37_53','m37_54','m37_55','m37_72','m37_73','m37_74','m37_75','m38_146','m38_147','m38_148','m38_149','m38_150','m38_151','m38_152','m38_153','m38_154','m38_155','m38_45','m38_46','m38_47','m38_48','m38_49','m38_50','m38_51','m38_52','m38_53','m38_54','m38_55','m38_72','m38_73','m38_74','m39_147','m39_148','m39_149','m39_150','m39_151','m39_152','m39_153','m39_154','m39_155','m39_45','m39_46','m39_47','m39_48','m39_49','m39_50','m39_51','m39_52','m39_53','m39_54','m39_55','m39_72','m39_73','m39_74','m39_75','m39_76','m40_147','m40_148','m40_149','m40_150','m40_151','m40_152','m40_153','m40_154','m40_45','m40_46','m40_47','m40_48','m40_49','m40_50','m40_51','m40_52','m40_53','m40_54','m40_55','m40_72','m40_73','m40_74','m40_75','m40_76','m41_146','m41_149','m41_151','m41_152','m41_153','m41_154','m41_45','m41_46','m41_47','m41_48','m41_49','m41_50','m41_51','m41_52','m41_53','m41_54','m41_55','m41_56','m41_72','m41_73','m41_74','m41_75','m42_144','m42_145','m42_146','m42_151','m42_152','m42_153','m42_49','m42_50','m42_51','m42_52','m42_53','m42_54','m42_55','m42_56','m42_72','m42_73','m42_74','m42_75','m43_144','m43_145','m43_146','m43_153','m43_154','m43_45','m43_46','m43_47','m43_48','m43_49','m43_50','m43_51','m43_52','m43_53','m43_54','m43_55','m43_56','m43_72','m43_73','m43_74','m43_75','m44_144','m44_145','m44_146','m44_148','m44_149','m44_150','m44_151','m44_152','m44_153','m44_154','m44_155','m44_45','m44_46','m44_47','m44_48','m44_49','m44_50','m44_51','m44_52','m44_53','m44_54','m44_55','m44_72','m44_73','m44_74','m44_75','m45_145','m45_146','m45_148','m45_150','m45_151','m45_152','m45_153','m45_154','m45_155','m45_45','m45_46','m45_47','m45_48','m45_49','m45_50','m45_51','m45_52','m45_53','m45_54','m45_55','m45_56','m45_57','m45_58','m45_59','m45_60','m45_61','m45_62','m45_73','m45_74','m45_75','m45_76','m46_149','m46_150','m46_152','m46_153','m46_154','m46_161','m46_45','m46_46','m46_47','m46_48','m46_49','m46_50','m46_51','m46_52','m46_53','m46_54','m46_55','m46_56','m46_57','m46_58','m46_59','m46_60','m46_61','m46_62','m46_75','m47_148','m47_149','m47_150','m47_152','m47_153','m47_160','m47_161','m47_47','m47_48','m47_49','m47_50','m47_51','m47_52','m47_53','m47_54','m47_55','m47_56','m47_57','m47_58','m47_59','m47_60','m47_61','m47_62','m47_75','m48_148','m48_149','m48_152','m48_153','m48_154','m48_155','m48_156','m48_47','m48_48','m48_49','m48_50','m48_51','m48_52','m48_53','m48_54','m48_55','m48_56','m48_57','m48_58','m48_59','m48_60','m48_61','m48_62','m49_148','m49_149','m49_153','m49_154','m49_155','m49_156','m49_46','m49_47','m49_48','m49_49','m49_50','m49_51','m49_52','m49_53','m49_54','m49_55','m49_56','m49_57','m49_58','m49_59','m49_60','m49_61','m49_62','m50_149','m50_150','m50_152','m50_153','m50_154','m50_46','m50_47','m50_48','m50_49','m50_50','m50_51','m50_52','m50_53','m50_54','m50_55','m50_56','m50_57','m50_58','m50_59','m50_60','m50_61','m50_62','m51_147','m51_154','m51_46','m51_47','m51_48','m51_49','m51_50','m51_51','m51_52','m51_53','m51_54','m51_55','m51_56','m51_57','m51_58','m51_59','m51_60','m51_61','m51_62','m52_152','m52_153','m52_154','m52_46','m52_47','m52_48','m52_49','m52_50','m52_51','m52_52','m52_53','m52_54','m52_55','m52_56','m52_57','m52_58','m52_59','m52_60','m52_61','m52_62','m53_49','m53_50','m53_51','m53_52','m53_53'];for(let e=0;e<t.length;e++){const s=t[e],n=new Uint8Array(await(await fetch(`data/pack/client/maps/${s}`)).arrayBuffer()),i=ut.getcrc(n,0,n.length);Ri.set(s,n),bi.set(s,i)}const e=['adventure.mid','al_kharid.mid','alone.mid','ambience_2.mid','ambience_3.mid','ambience_4.mid','ambient_jungle.mid','arabian.mid','arabian2.mid','arabian3.mid','arabique.mid','army_of_darkness.mid','arrival.mid','attack1.mid','attack2.mid','attack3.mid','attack4.mid','attack5.mid','attack6.mid','attention.mid','autumn_voyage.mid','background2.mid','ballad_of_enchantment.mid','baroque.mid','beyond.mid','big_chords.mid','book_of_spells.mid','camelot.mid','cave_background1.mid','cavern.mid','cellar_song1.mid','chain_of_command.mid','chompy_hunt.mid','close_quarters.mid','crystal_cave.mid','crystal_sword.mid','cursed.mid','dangerous.mid','dark2.mid','deep_wildy.mid','desert_voyage.mid','doorways.mid','dream1.mid','duel_arena.mid','dunjun.mid','egypt.mid','emotion.mid','emperor.mid','escape.mid','expanse.mid','expecting.mid','expedition.mid','fade_test.mid','faerie.mid','fanfare.mid','fanfare2.mid','fanfare3.mid','fishing.mid','flute_salad.mid','forbidden.mid','forever.mid','game_intro_1.mid','gaol.mid','garden.mid','gnome.mid','gnome_king.mid','gnome_theme.mid','gnome_village.mid','gnome_village2.mid','gnomeball.mid','greatness.mid','grumpy.mid','harmony.mid','harmony2.mid','heart_and_mind.mid','high_seas.mid','horizon.mid','iban.mid','ice_melody.mid','in_the_manor.mid','inspiration.mid','intrepid.mid','jolly-r.mid','jungle_island.mid','jungly1.mid','jungly2.mid','jungly3.mid','knightly.mid','landlubber.mid','lasting.mid','legion.mid','lightness.mid','lightwalk.mid','lonesome.mid','long_ago.mid','long_way_home.mid','lullaby.mid','mage_arena.mid','magic_dance.mid','magical_journey.mid','march2.mid','medieval.mid','mellow.mid','miles_away.mid','miracle_dance.mid','monarch_waltz.mid','moody.mid','neverland.mid','newbie_melody.mid','nightfall.mid','nomad.mid','null.mid','organ_music_1.mid','organ_music_2.mid','oriental.mid','overture.mid','parade.mid','quest.mid','regal2.mid','reggae.mid','reggae2.mid','riverside.mid','royale.mid','rune_essence.mid','sad_meadow.mid','scape_cave.mid','scape_main.mid','scape_sad1.mid','scape_soft.mid','scape_wild1.mid','sea_shanty.mid','sea_shanty2.mid','serenade.mid','serene.mid','shine.mid','shining.mid','silence.mid','soundscape.mid','spirit.mid','splendour.mid','spooky2.mid','spooky_jungle.mid','starlight.mid','start.mid','still_night.mid','talking_forest.mid','the_desert.mid','the_shadow.mid','the_tower.mid','theme.mid','tomorrow.mid','trawler.mid','trawler_minor.mid','tree_spirits.mid','tribal.mid','tribal2.mid','tribal_background.mid','trinity.mid','troubled.mid','undercurrent.mid','underground.mid','understanding.mid','unknown_land.mid','upass1.mid','upcoming.mid','venture.mid','venture2.mid','vision.mid','voodoo_cult.mid','voyage.mid','wander.mid','waterfall.mid','wilderness2.mid','wilderness3.mid','wilderness4.mid','witching.mid','wolf_mountain.mid','wonder.mid','wonderous.mid','workshop.mid','yesteryear.mid','zealot.mid'];for(let t=0;t<e.length;t++){const s=e[t],n=new Uint8Array(await(await fetch(`data/pack/client/songs/${s}`)).arrayBuffer()),i=ut.getcrc(n,0,n.length);Ri.set(s,n),bi.set(s,i)}const s=['advance agility.mid','advance attack.mid','advance attack2.mid','advance cooking.mid','advance cooking2.mid','advance crafting.mid','advance crafting2.mid','advance defense.mid','advance defense2.mid','advance firemarking.mid','advance firemarking2.mid','advance fishing.mid','advance fishing2.mid','advance fletching.mid','advance fletching2.mid','advance herblaw.mid','advance herblaw2.mid','advance hitpoints.mid','advance hitpoints2.mid','advance magic.mid','advance magic2.mid','advance mining.mid','advance mining2.mid','advance prayer.mid','advance prayer2.mid','advance ranged.mid','advance ranged2.mid','advance runecraft.mid','advance runecraft2.mid','advance smithing.mid','advance smithing2.mid','advance strength.mid','advance strength2.mid','advance thieving.mid','advance thieving2.mid','advance woodcutting.mid','advance woodcutting2.mid','death.mid','death2.mid','dice lose.mid','dice win.mid','duel start.mid','duel win2.mid','quest complete 1.mid','quest complete 2.mid','quest complete 3.mid','sailing journey.mid','treasure hunt win.mid'];for(let t=0;t<s.length;t++){const e=s[t],n=new Uint8Array(await(await fetch(`data/pack/client/jingles/${e}`)).arrayBuffer()).subarray(4),i=ut.getcrc(n,0,n.length);Ri.set(e,n),bi.set(e,i)}}()}broadcastMes(t){for(const e of this.players)e.messageGame(t)}async start(t=!1,e=!0){console.log('Starting world...'),await bt.load('data/pack'),await ye.load('data/pack'),await this.reload(),t||await this.gameMap.init(this.zoneMap),xl.loginThread.postMessage({type:'reset'}),80===ge.WEB_PORT?console.log(at.green().bold('World ready')+at.white().bold(': http://localhost')):console.log(at.green().bold('World ready')+at.white().bold(': http://localhost:'+ge.WEB_PORT)),e&&await this.cycle()}rebootTimer(t){this.shutdownTick=this.currentTick+t;for(const t of this.players)t.write(new Gl(this.shutdownTick-this.currentTick))}async cycle(t=!0){const e=Date.now();this.processWorld(),await this.processClientsIn(),this.processNpcs(),await this.processPlayers(),await this.processLogouts(),await this.processLogins(),this.processZones(),this.processMovementDirections(),await this.processClientsOut(),this.processCleanup();const s=this.currentTick;s%Wl.LOGIN_PINGRATE==0&&this.heartbeat(),this.shutdownTick>-1&&s>=this.shutdownTick&&await this.processShutdown(),s%Wl.PLAYER_SAVERATE==0&&s>0&&this.savePlayers(),this.currentTick++,this.cycleStats[Hn.CYCLE]=Date.now()-e,this.lastCycleStats[Hn.CYCLE]=this.cycleStats[Hn.CYCLE],this.lastCycleStats[Hn.WORLD]=this.cycleStats[Hn.WORLD],this.lastCycleStats[Hn.CLIENT_IN]=this.cycleStats[Hn.CLIENT_IN],this.lastCycleStats[Hn.NPC]=this.cycleStats[Hn.NPC],this.lastCycleStats[Hn.PLAYER]=this.cycleStats[Hn.PLAYER],this.lastCycleStats[Hn.LOGOUT]=this.cycleStats[Hn.LOGOUT],this.lastCycleStats[Hn.LOGIN]=this.cycleStats[Hn.LOGIN],this.lastCycleStats[Hn.ZONE]=this.cycleStats[Hn.ZONE],this.lastCycleStats[Hn.CLIENT_OUT]=this.cycleStats[Hn.CLIENT_OUT],this.lastCycleStats[Hn.CLEANUP]=this.cycleStats[Hn.CLEANUP],this.lastCycleStats[Hn.BANDWIDTH_IN]=this.cycleStats[Hn.BANDWIDTH_IN],this.lastCycleStats[Hn.BANDWIDTH_OUT]=this.cycleStats[Hn.BANDWIDTH_OUT],t&&setTimeout(this.cycle.bind(this),this.tickRate-this.cycleStats[Hn.CYCLE])}processWorld(){const t=Date.now(),e=this.currentTick;for(let t=this.queue.head();t;t=this.queue.next()){if(t.delay-- >0)continue;const e=t.script;try{const s=Rl.execute(e);t.unlink(),s===ze.SUSPENDED?e.activePlayer.activeScript=e:s===ze.NPC_SUSPENDED?e.activeNpc.activeScript=e:s===ze.WORLD_SUSPENDED&&this.enqueueScript(e,e.popInt())}catch(t){console.error(t)}}if(e%Wl.AFK_EVENTRATE==0)for(const t of this.players)t.afkEventReady=Math.random()<(t.zonesAfk()?.1666:.0833);for(const t of this.npcs)t.updateLifeCycle(e)&&(t.lifecycle===zn.RESPAWN?this.addNpc(t,-1):t.lifecycle===zn.DESPAWN&&this.removeNpc(t,-1));for(const t of this.npcs)t.checkLifeCycle(e)&&!t.delayed()&&-1!==t.huntMode&&t.huntAll();this.cycleStats[Hn.WORLD]=Date.now()-t}async processClientsIn(){const t=Date.now();this.cycleStats[Hn.BANDWIDTH_IN]=0;for(const t of this.players)if(Tl(t))try{t.decodeIn()}catch(e){console.error(e),await this.removePlayer(t)}for(const t of this.players)if(Tl(t)){if(t.userPath.length>0||t.opcalled){if(t.delayed()){t.unsetMapFlag();continue}if((!t.target||t.target instanceof ei||t.target instanceof jn)&&-1!==t.faceEntity&&(t.faceEntity=-1,t.mask|=bo.FACE_ENTITY),t.opcalled&&(0===t.userPath.length||!ge.NODE_CLIENT_ROUTEFINDER)){t.pathToTarget();continue}t.pathToMoveClick(t.userPath,!ge.NODE_CLIENT_ROUTEFINDER)}t.target instanceof bo&&(t.targetOp===li.APPLAYER3||t.targetOp===li.OPPLAYER3)&&(Ws.distanceToSW(t,t.target)<=25?t.pathToPathingTarget():t.clearWaypoints())}this.cycleStats[Hn.CLIENT_IN]=Date.now()-t}processNpcs(){const t=Date.now();for(const t of this.npcs)if(t.checkLifeCycle(this.currentTick))try{if(t.delayed()&&t.delay--,t.delayed())continue;if(t.activeScript&&t.executeScript(t.activeScript),!t.checkLifeCycle(this.currentTick))continue;t.processTimers(),t.processQueue(),t.processNpcModes(),t.validateDistanceWalked()}catch(e){console.error(e),this.removeNpc(t,-1)}this.cycleStats[Hn.NPC]=Date.now()-t}async processPlayers(){const t=Date.now();for(const t of this.players)try{t.playtime++,t.delayed()&&t.delay--,t.activeScript&&!t.delayed()&&t.activeScript.execution===ze.SUSPENDED&&t.executeScript(t.activeScript,!0),t.processQueues(),t.processTimers(0),t.processTimers(1),t.processEngineQueue(),t.processInteraction(),t.mask&bo.EXACT_MOVE||t.validateDistanceWalked(),this.shutdownTick<this.currentTick&&ge.NODE_SOCKET_TIMEOUT&&this.currentTick-t.lastResponse>=Wl.TIMEOUT_IDLE_TICKS&&(t.logoutRequested=!0),t.logoutRequested&&t.closeModal()}catch(e){console.error(e),await this.removePlayer(t)}this.cycleStats[Hn.PLAYER]=Date.now()-t}async processLogouts(){const t=Date.now();for(const t of this.players)if(ge.NODE_SOCKET_TIMEOUT&&this.currentTick-t.lastResponse>=Wl.TIMEOUT_LOGOUT_TICKS&&(t.queue.clear(),t.weakQueue.clear(),t.engineQueue.clear(),t.clearInteraction(),t.closeModal(),t.unsetMapFlag(),t.logoutRequested=!0,t.setVar(Ae.LASTCOMBAT,0)),t.logoutRequested)if(null===t.queue.head()){const e=Fe.getByTriggerSpecific(li.LOGOUT,-1,-1);if(!e){console.error('LOGOUT TRIGGER IS BROKEN!');continue}const s=Rl.init(e,t);s.pointerAdd(ke.ProtectedActivePlayer),Rl.execute(s);0===s.popInt()&&(t.logoutRequested=!1),t.logoutRequested&&await this.removePlayer(t)}else t.messageGame('[DEBUG]: Waiting for queue to empty before logging out.');this.cycleStats[Hn.LOGOUT]=Date.now()-t}async processLogins(){const t=Date.now();t:for(const t of this.newPlayers){if(!Tl(t))continue;for(const e of this.players)if(t.username===e.username){t.client?.send(kl.LOGGED_IN),t.client?.close();continue t}let e;try{e=this.getNextPid(t.client)}catch(e){t.client?.send(kl.WORLD_FULL),t.client?.close();continue}this.players.set(e,t),t.pid=e,t.uid=(Number(0x1fffffn&t.username37)<<11|t.pid)>>>0,t.tele=!0,this.getZone(t.x,t.z,t.level).enter(t),t.onLogin(),this.shutdownTick>-1&&t.write(new Gl(this.shutdownTick-this.currentTick)),t.client&&(t.client.state=1,t.staffModLevel>=2?t.client.send(kl.STAFF_MOD_LEVEL):t.client.send(kl.SUCCESSFUL))}this.newPlayers.clear(),this.cycleStats[Hn.LOGIN]=Date.now()-t}processZones(){const t=Date.now(),e=this.currentTick,s=this.zonesTracking.get(e);if(void 0!==s)for(const t of s)t.tick(e);this.computeSharedEvents(),this.cycleStats[Hn.ZONE]=Date.now()-t}processMovementDirections(){for(const t of this.players)t.convertMovementDir();for(const t of this.npcs)t.convertMovementDir()}async processClientsOut(){const t=Date.now();this.cycleStats[Hn.BANDWIDTH_OUT]=0;for(const t of this.players)if(Tl(t))try{t.updateMap(),t.updatePlayers(),t.updateNpcs(),t.updateZones(),t.updateInvs(),t.updateStats(),t.updateAfkZones(),t.encodeOut()}catch(e){console.error(e),await this.removePlayer(t)}this.cycleStats[Hn.CLIENT_OUT]=Date.now()-t}processCleanup(){const t=Date.now(),e=this.currentTick,s=this.zonesTracking.get(e);if(void 0!==s)for(const t of s)t.reset();this.zonesTracking.delete(e);for(const t of this.players){t.resetEntity(!1);for(const e of t.invs.values())e&&(e.update=!1)}for(const t of this.npcs)t.checkLifeCycle(e)&&t.resetEntity(!1);for(const t of this.invs){t.update=!1;const s=$t.get(t.type);if(s.restock&&s.stockcount&&s.stockrate)for(let n=0;n<t.items.length;n++){const i=t.items[n];i&&(i.count<s.stockcount[n]&&e%s.stockrate[n]==0?(t.add(i?.id,1,n,!0,!1,!1),t.update=!0):(i.count>s.stockcount[n]&&e%s.stockrate[n]==0||s.allstock&&!s.stockcount[n]&&e%Wl.INV_STOCKRATE==0)&&(t.remove(i?.id,1,n,!0),t.update=!0))}}this.cycleStats[Hn.CLEANUP]=Date.now()-t}heartbeat(){const t=[];for(const e of this.players)t.push(e.username37);xl.loginThread.postMessage({type:'heartbeat',players:t})}async processShutdown(){const t=this.currentTick-this.shutdownTick;if(this.getTotalPlayers()){for(const e of this.players)e.logoutRequested=!0,Tl(e)&&(e.logout(),e.client&&t>2&&e.client.close());if(this.npcs.reset(),t>2&&(this.tickRate>Wl.SHUTDOWN_TICKRATE&&(this.tickRate=Wl.SHUTDOWN_TICKRATE),t>Wl.SHUTDOWN_TICKS)){for(const t of this.players)await this.removePlayer(t);this.tickRate=Wl.NORMAL_TICKRATE}}else process.exit(0)}savePlayers(){}enqueueScript(t,e=0){this.queue.addTail(new Ti(t,e+1))}getInventory(t){if(-1===t)return null;for(const e of this.invs)if(e.type===t)return e;const e=Ye.fromType(t);return this.invs.add(e),e}getZone(t,e,s){return this.zoneMap.zone(t,e,s)}getZoneIndex(t){return this.zoneMap.zoneByIndex(t)}getZoneGrid(t){return this.zoneMap.grid(t)}computeSharedEvents(){const t=new Set;for(const e of this.players)if(Tl(e))for(const s of e.buildArea.loadedZones)t.add(s);for(const e of t)this.getZoneIndex(e).computeShared()}addNpc(t,e){this.npcs.set(t.nid,t),t.x=t.startX,t.z=t.startZ;switch(this.getZone(t.x,t.z,t.level).enter(t),t.blockWalk){case ae.NPC:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!0);break;case ae.ALL:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!0),this.gameMap.changePlayerCollision(t.width,t.x,t.z,t.level,!0)}t.resetEntity(!0),t.playAnimation(-1,0),t.setLifeCycle(this.currentTick+e)}removeNpc(t,e){switch(this.getZone(t.x,t.z,t.level).leave(t),t.blockWalk){case ae.NPC:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!1);break;case ae.ALL:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!1),this.gameMap.changePlayerCollision(t.width,t.x,t.z,t.level,!1)}t.lifecycle===zn.DESPAWN?this.npcs.remove(t.nid):t.lifecycle===zn.RESPAWN&&t.setLifeCycle(this.currentTick+e)}getLoc(t,e,s,n){return this.getZone(t,e,s).getLoc(t,e,n)}getObj(t,e,s,n,i){return this.getZone(t,e,s).getObj(t,e,n,i)}trackZone(t,e){let s;const n=this.zonesTracking.get(t);s=n||new Set,s.add(e),this.zonesTracking.set(t,s)}addLoc(t,e){const s=ee.get(t.type);s.blockwalk&&this.gameMap.changeLocCollision(t.shape,t.angle,s.blockrange,s.length,s.width,s.active,t.x,t.z,t.level,!0);const n=this.getZone(t.x,t.z,t.level);n.addLoc(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,n),this.trackZone(this.currentTick,n)}mergeLoc(t,e,s,n,i,a,r,o){const c=this.getZone(t.x,t.z,t.level);c.mergeLoc(t,e,s,n,i,a,r,o),this.trackZone(this.currentTick,c)}animLoc(t,e){const s=this.getZone(t.x,t.z,t.level);s.animLoc(t,e),this.trackZone(this.currentTick,s)}removeLoc(t,e){const s=ee.get(t.type);s.blockwalk&&this.gameMap.changeLocCollision(t.shape,t.angle,s.blockrange,s.length,s.width,s.active,t.x,t.z,t.level,!1);const n=this.getZone(t.x,t.z,t.level);n.removeLoc(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,n),this.trackZone(this.currentTick,n)}addObj(t,e,s){const n=_e.get(t.type),i=this.getObj(t.x,t.z,t.level,t.type,e);if(i&&i.lifecycle===zn.DESPAWN&&t.lifecycle===zn.DESPAWN){const s=t.count+i.count;if(n.stackable&&s<=Ye.STACK_LIMIT)return void this.changeObj(i,e,s)}const a=this.getZone(t.x,t.z,t.level);a.addObj(t,e),-1!==e&&n.tradeable?(t.setLifeCycle(this.currentTick+100),this.trackZone(this.currentTick+100,a),this.trackZone(this.currentTick,a),t.receiverId=e,t.reveal=s):(t.setLifeCycle(this.currentTick+s),this.trackZone(this.currentTick+s,a),this.trackZone(this.currentTick,a))}revealObj(t){const e=t.reveal,s=this.getZone(t.x,t.z,t.level);s.revealObj(t,t.receiverId),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,s),this.trackZone(this.currentTick,s)}changeObj(t,e,s){const n=this.getZone(t.x,t.z,t.level);n.changeObj(t,e,t.count,s),this.trackZone(this.currentTick,n)}removeObj(t,e){const s=this.getZone(t.x,t.z,t.level);s.removeObj(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,s),this.trackZone(this.currentTick,s)}animMap(t,e,s,n,i,a){const r=this.getZone(e,s,t);r.animMap(e,s,n,i,a),this.trackZone(this.currentTick,r)}mapProjAnim(t,e,s,n,i,a,r,o,c,l,h,d,p){const u=this.getZone(e,s,t);u.mapProjAnim(e,s,n,i,a,r,o,c,l,h,d,p),this.trackZone(this.currentTick,u)}async readIn(t,e){for(;e.available>0;){const s=e.pos;let n=e.g1();if(t.decryptor&&(n=n-t.decryptor.nextInt()&255,e.data[s]=n),void 0===Uo.byId[n])return t.state=-1,void t.close();let i=Uo.byId[n].length;if(-1===i?i=e.g1():-2===i&&(i=e.g2()),e.available<i)break;if(e.pos+=i,t.inCount[n]++,t.inCount[n]>5)continue;const a=new Uint8Array(e.pos-s),r=e.pos;e.pos=s,e.gdata(a,0,a.length),e.pos=r,t.in.set(a,t.inOffset),t.inOffset+=e.pos-s}}addPlayer(t){this.newPlayers.add(t)}async removePlayer(t){-1!==t.pid&&(t.playerLog('Logging out'),Tl(t)&&(t.logout(),t.client.close(),t.client=null),xl.logout(t))}getPlayer(t){return this.players.get(t)}getPlayerByUid(t){const e=2047&t,s=t>>11&2097151,n=this.getPlayer(e);return n?Number(0x1fffffn&n.username37)!==s?null:n:null}getPlayerByUsername(t){const e=rt(t);for(const t of this.players)if(t.username37===e)return t;for(const t of this.newPlayers)if(t.username37===e)return t}getTotalPlayers(){return this.players.count}getTotalNpcs(){return this.npcs.count}getTotalZones(){return this.zoneMap.zoneCount()}getTotalLocs(){return this.zoneMap.locCount()}getTotalObjs(){return this.zoneMap.objCount()}getNpc(t){return this.npcs.get(t)}getNpcByUid(t){const e=65535&t,s=t>>16&65535,n=this.getNpc(e);return n&&n.type===s?n:null}getNextNid(){return this.npcs.next()}getNextPid(t=null){if(t){const e=t.remoteAddress.split('.'),s=parseInt(e[3])%20*100;return this.players.next(!0,s)}return this.players.next()}}var zl=new Wl;await zl.start(),(new class{socket=new Gc;constructor(){}start(){const t=new ut(new Uint8Array(8));t.p4(Math.floor(4294967295*Math.random())),t.p4(Math.floor(4294967295*Math.random())),this.socket.send(t.data),self.onmessage=async t=>{const e=new ut(new Uint8Array(t.data));t.data.type;try{1===this.socket.state?await zl.readIn(this.socket,e):await xl.readIn(this.socket,e)}catch(t){this.socket.close()}}}}).start();