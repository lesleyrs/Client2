var FORCE_COLOR,NODE_DISABLE_COLORS,NO_COLOR,TERM,__require=(e=>"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(e,{get:(e,t)=>("undefined"!=typeof require?require:e)[t]}):e)((function(e){if("undefined"!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')})),run=function(e,t){let i,n=0,r="",a="";for(;n<e.length;n++)i=e[n],r+=i.open,a+=i.close,~t.indexOf(i.close)&&(t=t.replace(i.rgx,i.close+i.open));return r+t+a},chain=function(e,t){let i={has:e,keys:t};return i.reset=$.reset.bind(i),i.bold=$.bold.bind(i),i.dim=$.dim.bind(i),i.italic=$.italic.bind(i),i.underline=$.underline.bind(i),i.inverse=$.inverse.bind(i),i.hidden=$.hidden.bind(i),i.strikethrough=$.strikethrough.bind(i),i.black=$.black.bind(i),i.red=$.red.bind(i),i.green=$.green.bind(i),i.yellow=$.yellow.bind(i),i.blue=$.blue.bind(i),i.magenta=$.magenta.bind(i),i.cyan=$.cyan.bind(i),i.white=$.white.bind(i),i.gray=$.gray.bind(i),i.grey=$.grey.bind(i),i.bgBlack=$.bgBlack.bind(i),i.bgRed=$.bgRed.bind(i),i.bgGreen=$.bgGreen.bind(i),i.bgYellow=$.bgYellow.bind(i),i.bgBlue=$.bgBlue.bind(i),i.bgMagenta=$.bgMagenta.bind(i),i.bgCyan=$.bgCyan.bind(i),i.bgWhite=$.bgWhite.bind(i),i},init=function(e,t){let i={open:`[${e}m`,close:`[${t}m`,rgx:new RegExp(`\\x1b\\[${t}m`,"g")};return function(t){return void 0!==this&&void 0!==this.has?(~this.has.indexOf(e)||(this.has.push(e),this.keys.push(i)),void 0===t?this:$.enabled?run(this.keys,t+""):t+""):void 0===t?chain([e],[i]):$.enabled?run([i],t+""):t+""}},isTTY=!0;"undefined"!=typeof process&&(({FORCE_COLOR,NODE_DISABLE_COLORS,NO_COLOR,TERM}=process.env||{}),isTTY=process.stdout&&process.stdout.isTTY);var $={enabled:!NODE_DISABLE_COLORS&&null==NO_COLOR&&"dumb"!==TERM&&(null!=FORCE_COLOR&&"0"!==FORCE_COLOR||isTTY),reset:init(0,0),bold:init(1,22),dim:init(2,22),italic:init(3,23),underline:init(4,24),inverse:init(7,27),hidden:init(8,28),strikethrough:init(9,29),black:init(30,39),red:init(31,39),green:init(32,39),yellow:init(33,39),blue:init(34,39),magenta:init(35,39),cyan:init(36,39),white:init(37,39),gray:init(90,39),grey:init(90,39),bgBlack:init(40,49),bgRed:init(41,49),bgGreen:init(42,49),bgYellow:init(43,49),bgBlue:init(44,49),bgMagenta:init(45,49),bgCyan:init(46,49),bgWhite:init(47,49)},kleur_default=$;function toBase37(e){e=e.trim();let t=0n;for(let i=0;i<e.length&&i<12;i++){const n=e.charCodeAt(i);t*=37n,n>=65&&n<=90?t+=BigInt(n+1-65):n>=97&&n<=122?t+=BigInt(n+1-97):n>=48&&n<=57&&(t+=BigInt(n+27-48))}return t}function fromBase37(e){if(e<0n||e>=6582952005840035281n)return"invalid_name";if(e%37n===0n)return"invalid_name";let t=0;const i=Array(12);for(;0n!==e;){const n=e;e/=37n,i[11-t++]=BASE37_LOOKUP[Number(n-37n*e)]}return i.slice(12-t).join("")}function toTitleCase(e){return e.replace(/\w\S*/g,(e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()))}function toSafeName(e){return fromBase37(toBase37(e))}function toDisplayName(e){return toTitleCase(toSafeName(e).replaceAll("_"," "))}var BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];class Linkable{key;next;prev;constructor(){this.key=0n,this.next=this,this.prev=this}unlink(){this.prev&&this.next&&(this.prev.next=this.next,this.next.prev=this.prev,this.next=null,this.prev=null)}}class LinkList{sentinel;cursor=null;constructor(){const e=new Linkable;e.next=e,e.prev=e,this.sentinel=e}addTail(e){e.prev&&e.unlink(),e.prev=this.sentinel.prev,e.next=this.sentinel,e.prev&&(e.prev.next=e),e.next.prev=e}addHead(e){e.prev&&e.unlink(),e.prev=this.sentinel,e.next=this.sentinel.next,e.prev.next=e,e.next&&(e.next.prev=e)}removeHead(){const e=this.sentinel.next;return e===this.sentinel?null:(e?.unlink(),e)}head(){const e=this.sentinel.next;return e===this.sentinel?(this.cursor=null,null):(this.cursor=e?.next||null,e)}tail(){const e=this.sentinel.prev;return e===this.sentinel?(this.cursor=null,null):(this.cursor=e?.prev||null,e)}next(){const e=this.cursor;return e===this.sentinel?(this.cursor=null,null):(this.cursor=e?.next||null,e)}prev(){const e=this.cursor;return e===this.sentinel?(this.cursor=null,null):(this.cursor=e?.prev||null,e)}clear(){for(;;){const e=this.sentinel.next;if(e===this.sentinel)return;e?.unlink()}}}class Hashable extends Linkable{nextHashable;prevHashable;constructor(){super(),this.nextHashable=this,this.prevHashable=this}uncache(){this.prevHashable&&this.nextHashable&&(this.prevHashable.nextHashable=this.nextHashable,this.nextHashable.prevHashable=this.prevHashable,this.nextHashable=null,this.prevHashable=null)}}class Packet extends Hashable{static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static crc32b=3988292384;static{for(let e=0;e<32;e++)this.bitmask[e]=(1<<e)-1;this.bitmask[32]=4294967295;for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)1&~t?t>>>=1:t=t>>>1^this.crc32b;this.crctable[e]=t}}static getcrc(e,t,i){let n=4294967295;for(let r=t;r<i;r++)n=n>>>8^this.crctable[255&(n^e[r])];return~n}static checkcrc(e,t,i,n=0){return Packet.getcrc(e,t,i)==n}static alloc(e){let t=null;return 0===e&&this.cacheMinCount>0?(t=this.cacheMin.removeHead(),this.cacheMinCount--):1===e&&this.cacheMidCount>0?(t=this.cacheMid.removeHead(),this.cacheMidCount--):2===e&&this.cacheMaxCount>0?(t=this.cacheMax.removeHead(),this.cacheMaxCount--):3===e&&this.cacheBigCount>0?(t=this.cacheBig.removeHead(),this.cacheBigCount--):4===e&&this.cacheHugeCount>0?(t=this.cacheHuge.removeHead(),this.cacheHugeCount--):5===e&&this.cacheUnimaginableCount>0&&(t=this.cacheUnimaginable.removeHead(),this.cacheUnimaginableCount--),null!==t?(t.pos=0,t.bitPos=0,t):new Packet(0===e?new Uint8Array(100):1===e?new Uint8Array(5e3):2===e?new Uint8Array(3e4):3===e?new Uint8Array(1e5):4===e?new Uint8Array(5e5):5===e?new Uint8Array(2e6):new Uint8Array(e))}static async load(e,t=!1){const i=new Packet(new Uint8Array(await(await fetch(e)).arrayBuffer()));return t&&(i.pos=i.data.length),i}static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static cacheBigCount=0;static cacheHugeCount=0;static cacheUnimaginableCount=0;static cacheMin=new LinkList;static cacheMid=new LinkList;static cacheMax=new LinkList;static cacheBig=new LinkList;static cacheHuge=new LinkList;static cacheUnimaginable=new LinkList;data;#e;pos;bitPos;constructor(e){super(),this.data=e,this.#e=new DataView(this.data.buffer),this.pos=0,this.bitPos=0}get available(){return this.data.length-this.pos}get length(){return this.data.length}release(){this.pos=0,this.bitPos=0,100===this.data.length&&Packet.cacheMinCount<1e3?(Packet.cacheMin.addTail(this),Packet.cacheMinCount++):5e3===this.data.length&&Packet.cacheMidCount<250?(Packet.cacheMid.addTail(this),Packet.cacheMidCount++):3e4===this.data.length&&Packet.cacheMaxCount<50?(Packet.cacheMax.addTail(this),Packet.cacheMaxCount++):1e5===this.data.length&&Packet.cacheBigCount<10?(Packet.cacheBig.addTail(this),Packet.cacheBigCount++):5e5===this.data.length&&Packet.cacheHugeCount<5?(Packet.cacheHuge.addTail(this),Packet.cacheHugeCount++):2e6===this.data.length&&Packet.cacheUnimaginableCount<2&&(Packet.cacheUnimaginable.addTail(this),Packet.cacheUnimaginableCount++)}p1(e){this.#e.setUint8(this.pos++,e)}p2(e){this.#e.setUint16(this.pos,e),this.pos+=2}ip2(e){this.#e.setUint16(this.pos,e,!0),this.pos+=2}p3(e){this.#e.setUint8(this.pos++,e>>16),this.#e.setUint16(this.pos,e),this.pos+=2}p4(e){this.#e.setInt32(this.pos,e),this.pos+=4}ip4(e){this.#e.setInt32(this.pos,e,!0),this.pos+=4}p8(e){this.#e.setBigInt64(this.pos,e),this.pos+=8}pbool(e){this.p1(e?1:0)}pjstr(e,t=10){const i=e.length;for(let t=0;t<i;t++)this.#e.setUint8(this.pos++,e.charCodeAt(t));this.#e.setUint8(this.pos++,t)}pdata(e,t,i){this.data.set(e.subarray(t,t+i),this.pos),this.pos+=i-t}psize4(e){this.#e.setUint32(this.pos-e-4,e)}psize2(e){this.#e.setUint16(this.pos-e-2,e)}psize1(e){this.#e.setUint8(this.pos-e-1,e)}psmarts(e){if(e<64&&e>=64)this.p1(e+64);else{if(!(e<16384&&e>=-16384))throw new Error("Error psmarts out of range: "+e);this.p2(e+49152)}}psmart(e){if(e>=0&&e<128)this.p1(e);else{if(!(e>=0&&e<32768))throw new Error("Error psmart out of range: "+e);this.p2(e+32768)}}g1(){return this.#e.getUint8(this.pos++)}g1b(){return this.#e.getInt8(this.pos++)}g2(){return this.pos+=2,this.#e.getUint16(this.pos-2)}g2s(){return this.pos+=2,this.#e.getInt16(this.pos-2)}ig2(){return this.pos+=2,this.#e.getUint16(this.pos-2,!0)}g3(){const e=this.#e.getUint8(this.pos++)<<16|this.#e.getUint16(this.pos);return this.pos+=2,e}g4(){return this.pos+=4,this.#e.getInt32(this.pos-4)}ig4(){return this.pos+=4,this.#e.getInt32(this.pos-4,!0)}g8(){return this.pos+=8,this.#e.getBigInt64(this.pos-8)}gbool(){return 1===this.g1()}gjstr(e=10){const t=this.data.length;let i,n="";for(;(i=this.#e.getUint8(this.pos++))!==e&&this.pos<t;)n+=String.fromCharCode(i);return n}gdata(e,t,i){e.set(this.data.subarray(this.pos,this.pos+i),t),this.pos+=i}gsmarts(){return this.#e.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmart(){return this.#e.getUint8(this.pos)<128?this.g1():this.g2()-32768}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(e){let t=this.bitPos>>>3,i=8-(7&this.bitPos),n=0;for(this.bitPos+=e;e>i;i=8)n+=(this.#e.getUint8(t++)&Packet.bitmask[i])<<e-i,e-=i;return n+=e==i?this.#e.getUint8(t)&Packet.bitmask[i]:this.#e.getUint8(t)>>>i-e&Packet.bitmask[e],n}pBit(e,t){const i=this.bitPos;this.bitPos+=e;let n=i>>>3,r=8-(7&i);const a=this.#e;for(;e>r;r=8){const i=(1<<r)-1,s=a.getUint8(n);a.setUint8(n++,s&~i|t>>>e-r&i),e-=r}const s=r-e,o=(1<<e)-1,c=a.getUint8(n);a.setUint8(n,c&~o<<s|(t&o)<<s)}}class ConfigType{id;debugname=null;constructor(e){this.id=e}decodeType(e){for(;e.available>0;){const t=e.g1();if(0===t)break;this.decode(t,e)}}}class CategoryType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(CategoryType.configNames=new Map,CategoryType.configs=[],!(await fetch(`${e}/server/category.dat`)).ok)return void console.log("Warning: No category.dat found.");const t=await Packet.load(`${e}/server/category.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new CategoryType(e);i.decodeType(t),CategoryType.configs[e]=i,i.debugname&&CategoryType.configNames.set(i.debugname,e)}}static get(e){return CategoryType.configs[e]}static getId(e){return CategoryType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}decode(e,t){this.debugname=t.gjstr()}toString(){return this.debugname??`category_${this.id}`}}class ScriptVarType{static INT=105;static AUTOINT=255;static STRING=115;static ENUM=103;static OBJ=111;static LOC=108;static COMPONENT=73;static NAMEDOBJ=79;static STRUCT=74;static BOOLEAN=49;static COORD=99;static CATEGORY=121;static SPOTANIM=116;static NPC=110;static INV=118;static SYNTH=80;static SEQ=65;static STAT=83;static VARP=86;static PLAYER_UID=112;static NPC_UID=78;static INTERFACE=97;static NPC_STAT=254;static IDKIT=75;static getType(e){switch(e){case ScriptVarType.INT:return"int";case ScriptVarType.STRING:return"string";case ScriptVarType.ENUM:return"enum";case ScriptVarType.OBJ:return"obj";case ScriptVarType.LOC:return"loc";case ScriptVarType.COMPONENT:return"component";case ScriptVarType.NAMEDOBJ:return"namedobj";case ScriptVarType.STRUCT:return"struct";case ScriptVarType.BOOLEAN:return"boolean";case ScriptVarType.COORD:return"coord";case ScriptVarType.CATEGORY:return"category";case ScriptVarType.SPOTANIM:return"spotanim";case ScriptVarType.NPC:return"npc";case ScriptVarType.INV:return"inv";case ScriptVarType.SYNTH:return"synth";case ScriptVarType.SEQ:return"seq";case ScriptVarType.STAT:return"stat";case ScriptVarType.AUTOINT:return"autoint";case ScriptVarType.VARP:return"varp";case ScriptVarType.PLAYER_UID:return"player_uid";case ScriptVarType.NPC_UID:return"npc_uid";case ScriptVarType.INTERFACE:return"interface";case ScriptVarType.NPC_STAT:return"npc_stat";case ScriptVarType.IDKIT:return"idkit";default:return"unknown"}}static getTypeChar(e){let t="i";switch(e){case"int":t="i";break;case"autoint":t="Ã¿";break;case"string":t="s";break;case"enum":t="g";break;case"obj":t="o";break;case"loc":t="l";break;case"component":t="I";break;case"namedobj":t="O";break;case"struct":t="J";break;case"boolean":t="1";break;case"coord":t="c";break;case"category":t="y";break;case"spotanim":t="t";break;case"npc":t="n";break;case"inv":t="v";break;case"synth":t="P";break;case"seq":t="A";break;case"stat":t="S";break;case"varp":t="V";break;case"player_uid":t="p";break;case"npc_uid":t="N";break;case"interface":t="a";break;case"npc_stat":t="Ã¾";break;case"idkit":t="K";break;default:return null}return t.charCodeAt(0)}static getDefault(e){return e===ScriptVarType.STRING?"":e===ScriptVarType.BOOLEAN?0:-1}}class DbTableType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(DbTableType.configNames=new Map,DbTableType.configs=[],!(await fetch(`${e}/server/dbtable.dat`)).ok)return void console.log("Warning: No dbtable.dat found.");const t=await Packet.load(`${e}/server/dbtable.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new DbTableType(e);i.decodeType(t),DbTableType.configs[e]=i,i.debugname&&DbTableType.configNames.set(i.debugname,e)}}static get(e){return DbTableType.configs[e]}static getId(e){return DbTableType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}types=[];defaultValues=[];columnNames=[];decode(e,t){if(1===e){this.types=new Array(t.g1());for(let e=t.g1();255!=e;e=t.g1()){const i=127&e,n=!!(128&e),r=new Array(t.g1());for(let e=0;e<r.length;e++)r[e]=t.g1();this.types[i]=r,n&&(this.defaultValues||(this.defaultValues=new Array(this.types.length)),this.defaultValues[i]=this.decodeValues(t,i))}}else if(250===e)this.debugname=t.gjstr();else{if(251!==e)throw new Error(`Unrecognized dbtable config code: ${e}`);this.columnNames=new Array(t.g1());for(let e=0;e<this.columnNames.length;e++)this.columnNames[e]=t.gjstr()}}getDefault(e){if(!this.defaultValues[e]){const t=[];for(let i=0;i<this.types[e].length;i++)t[i]=ScriptVarType.getDefault(this.types[e][i]);return t}return this.defaultValues[e]}decodeValues(e,t){const i=this.types[t],n=e.g1(),r=new Array(n*i.length);for(let t=0;t<n;t++)for(let n=0;n<i.length;n++){const a=i[n],s=n+t*i.length;a===ScriptVarType.STRING?r[s]=e.gjstr():r[s]=e.g4()}return r}}class DbRowType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(DbRowType.configNames=new Map,DbRowType.configs=[],!(await fetch(`${e}/server/dbrow.dat`)).ok)return void console.log("Warning: No dbrow.dat found.");const t=await Packet.load(`${e}/server/dbrow.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new DbRowType(e);i.decodeType(t),DbRowType.configs[e]=i,i.debugname&&DbRowType.configNames.set(i.debugname,e)}}static get(e){return DbRowType.configs[e]}static getId(e){return DbRowType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}static getInTable(e){return DbRowType.configs.filter((t=>t.tableId===e))}tableId=0;types=[];columnValues=[];decode(e,t){if(3===e){const e=t.g1();this.types=new Array(e),this.columnValues=new Array(e);for(let e=t.g1();255!=e;e=t.g1()){const i=new Array(t.g1());for(let e=0;e<i.length;e++)i[e]=t.g1();this.types[e]=i,this.columnValues[e]=this.decodeValues(t,e)}}else if(4===e)this.tableId=t.g2();else{if(250!==e)throw new Error(`Unrecognized dbtable config code: ${e}`);this.debugname=t.gjstr()}}getValue(e,t){const i=this.columnValues[e].slice(t*this.types[e].length,(t+1)*this.types[e].length);return i.length?i:DbTableType.get(this.tableId).getDefault(e)}decodeValues(e,t){const i=this.types[t],n=e.g1(),r=new Array(n*i.length);for(let t=0;t<n;t++)for(let n=0;n<i.length;n++){const a=i[n],s=n+t*i.length;a===ScriptVarType.STRING?r[s]=e.gjstr():r[s]=e.g4()}return r}}class EnumType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(EnumType.configNames=new Map,EnumType.configs=[],!(await fetch(`${e}/server/enum.dat`)).ok)return void console.log("Warning: No enum.dat found.");const t=await Packet.load(`${e}/server/enum.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new EnumType(e);i.decodeType(t),EnumType.configs[e]=i,i.debugname&&EnumType.configNames.set(i.debugname,e)}}static get(e){return EnumType.configs[e]}static getId(e){return EnumType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}inputtype=ScriptVarType.INT;outputtype=ScriptVarType.INT;defaultInt=0;defaultString="null";values=new Map;decode(e,t){if(1===e)this.inputtype=t.g1();else if(2===e)this.outputtype=t.g1();else if(3===e)this.defaultString=t.gjstr();else if(4===e)this.defaultInt=t.g4();else if(5===e){const e=t.g2();for(let i=0;i<e;i++)this.values.set(t.g4(),t.gjstr())}else if(6===e){const e=t.g2();for(let i=0;i<e;i++)this.values.set(t.g4(),t.g4())}else{if(250!==e)throw new Error(`Unrecognized enum config code: ${e}`);this.debugname=t.gjstr()}}}async function instantiate(e,t={}){const i={env:Object.assign(Object.create(globalThis),t.env||{},{abort(e,t,i,n){e=s(e>>>0),t=s(t>>>0),i>>>=0,n>>>=0,(()=>{throw Error(`${e} in ${t}:${i}:${n}`)})()}})},{exports:n}=await WebAssembly.instantiate(e,i),r=n.memory||t.env.memory,a=Object.setPrototypeOf({read:(e,t,i,a)=>(t=function(e,t,i,a,s){if(null==a)return 0;const o=a.length,c=n.__pin(n.__new(o<<i,t))>>>0;if(s)new s(r.buffer,c,o).set(a);else for(let t=0;t<o;t++)e(c+(t<<i>>>0),a[t]);return n.__unpin(c),c}(c,6,0,t,Int8Array)||function(){throw TypeError("value must not be null")}(),function(e,t,i){if(!i)return null;const n=function(e){try{return o.getUint32(e,!0)}catch{return o=new DataView(r.buffer),o.getUint32(e,!0)}}(i-4)>>>t,a=new Array(n);for(let r=0;r<n;++r)a[r]=e(i+(r<<t>>>0));return a}(l,0,n.read(e,t,i,a)>>>0))},n);function s(e){if(!e)return null;const t=e+new Uint32Array(r.buffer)[e-4>>>2]>>>1,i=new Uint16Array(r.buffer);let n=e>>>1,a="";for(;t-n>1024;)a+=String.fromCharCode(...i.subarray(n,n+=1024));return a+String.fromCharCode(...i.subarray(n,t))}let o=new DataView(r.buffer);function c(e,t){try{o.setUint8(e,t,!0)}catch{o=new DataView(r.buffer),o.setUint8(e,t,!0)}}function l(e){try{return o.getInt8(e,!0)}catch{return o=new DataView(r.buffer),o.getInt8(e,!0)}}return a}class Bzip{static bz2=null;static load=async e=>{this.bz2=await instantiate(new WebAssembly.Module(e),{env:void 0})};static read=(e,t,i,n)=>{if(!this.bz2)throw new Error("bz2 not found!!");return Int8Array.from(this.bz2.read(e,t,i,n))}}function genHash(e){let t=0;e=e.toUpperCase();for(let i=0;i<e.length;i++)t=61*t+e.charCodeAt(i)-32|0;return t}class Jagfile{data=null;fileCount=0;fileHash=[];fileName=[];fileUnpackedSize=[];filePackedSize=[];filePos=[];unpacked=!1;fileQueue=[];fileWrite=[];static async load(e){return new Jagfile(await Packet.load(e))}constructor(e){if(!e)return;const t=e.g3(),i=e.g3();t===i?(this.data=new Uint8Array(e.data),this.unpacked=!1):(this.data=new Uint8Array(Bzip.read(t,e.data,i,6)),e=new Packet(this.data),this.unpacked=!0),this.fileCount=e.g2();let n=e.pos+10*this.fileCount;for(let t=0;t<this.fileCount;t++){this.fileHash[t]=e.g4();const i=KNOWN_HASHES.findIndex((e=>e===this.fileHash[t]));-1!==i&&(this.fileName[t]=KNOWN_NAMES[i]),this.fileUnpackedSize[t]=e.g3(),this.filePackedSize[t]=e.g3(),this.filePos[t]=n,n+=this.filePackedSize[t]}}get(e){if(e<0||e>=this.fileCount)return null;if(null===this.data)throw new Error("Jagfile data is not loaded");const t=this.data.subarray(this.filePos[e],this.filePos[e]+this.filePackedSize[e]);return this.unpacked?new Packet(t):new Packet(Uint8Array.from(Bzip.read(this.fileUnpackedSize[e],this.data,this.filePackedSize[e],this.filePos[e])))}read(e){const t=genHash(e);for(let e=0;e<this.fileCount;e++)if(this.fileHash[e]===t)return this.get(e);return null}write(e,t){const i=genHash(e);this.fileQueue.push({hash:i,name:e,write:!0,data:t.data.subarray(0,t.pos)})}delete(e){const t=genHash(e);this.fileQueue.push({hash:t,name:e,delete:!0})}rename(e,t){const i=genHash(e),n=genHash(t);this.fileQueue.push({hash:i,name:e,rename:!0,newName:t,newHash:n})}save(e,t=!1){let i=Packet.alloc(5);for(let e=0;e<this.fileQueue.length;e++){const t=this.fileQueue[e];let i=this.fileHash.findIndex((e=>e===t.hash));if(t.write){if(-1===i&&(i=this.fileCount++,this.fileHash[i]=t.hash,this.fileName[i]=t.name),!t.data)throw new Error("Cannot write without data");this.fileUnpackedSize[i]=t.data.length,this.filePackedSize[i]=t.data.length,this.filePos[i]=-1,this.fileWrite[i]=t.data}if(t.delete&&-1!==i&&(this.fileHash.splice(i,1),this.fileName.splice(i,1),this.fileUnpackedSize.splice(i,1),this.filePackedSize.splice(i,1),this.filePos.splice(i,1),this.fileCount--),t.rename&&-1!==i){if(!t.newHash)throw new Error("Cannot rename without newHash");if(!t.newName)throw new Error("Cannot rename without newName");this.fileHash[i]=t.newHash,this.fileName[i]=t.newName}this.fileQueue.splice(e,1),e--}let n=1===this.fileCount;t&&n&&(n=!1),i.p2(this.fileCount);for(let e=0;e<this.fileCount;e++)i.p4(this.fileHash[e]),i.p3(this.fileUnpackedSize[e]),this.fileWrite[e]&&!n&&(this.fileWrite[e]=BZip2.compress(this.fileWrite[e],!1,!0),this.filePackedSize[e]=this.fileWrite[e].length),i.p3(this.filePackedSize[e]);for(let e=0;e<this.fileCount;e++){const t=this.fileWrite[e];i.pdata(t,0,t.length)}const r=Packet.alloc(5);r.p3(i.pos),n&&(i=new Packet(BZip2.compress(i.data,!1,!0))),n?(r.p3(i.data.length),r.pdata(i.data,0,i.data.length)):(r.p3(i.pos),r.pdata(i.data,0,i.pos)),r.save(e),i.release(),r.release()}deconstruct(e){const t=this.read(e+".dat"),i=this.read(e+".idx");if(null===t||null===i)throw new Error("Failed to read dat or idx");const n=i.g2(),r=new Array(n),a=new Array(n);let s=2;for(let e=0;e<n;e++)r[e]=i.g2(),a[e]=s,s+=r[e];const o=new Array(n);for(let e=0;e<n;e++)t.pos=a[e],o[e]=Packet.getcrc(t.data,s,r[e]);return{count:n,sizes:r,offsets:a,checksums:o}}}var HuntCheckNotTooStrong,KNOWN_NAMES=["index.dat","logo.dat","p11.dat","p12.dat","b12.dat","q8.dat","runes.dat","title.dat","titlebox.dat","titlebutton.dat","p11_full.dat","p12_full.dat","b12_full.dat","q8_full.dat","flo.dat","flo.idx","idk.dat","idk.idx","loc.dat","loc.idx","npc.dat","npc.idx","obj.dat","obj.idx","seq.dat","seq.idx","spotanim.dat","spotanim.idx","varp.dat","varp.idx","varbit.dat","varbit.idx","mesanim.dat","mesanim.idx","mes.dat","mes.idx","param.dat","param.idx","hunt.dat","hunt.idx","data","backbase1.dat","backbase2.dat","backhmid1.dat","backhmid2.dat","backleft1.dat","backleft2.dat","backright1.dat","backright2.dat","backtop1.dat","backtop2.dat","backvmid1.dat","backvmid2.dat","backvmid3.dat","chatback.dat","combatboxes.dat","combaticons.dat","combaticons2.dat","combaticons3.dat","compass.dat","cross.dat","gnomeball_buttons.dat","headicons.dat","hitmarks.dat","invback.dat","leftarrow.dat","magicoff.dat","magicoff2.dat","magicon.dat","magicon2.dat","mapback.dat","mapdots.dat","mapflag.dat","mapfunction.dat","mapscene.dat","miscgraphics.dat","miscgraphics2.dat","miscgraphics3.dat","prayerglow.dat","prayeroff.dat","prayeron.dat","redstone1.dat","redstone2.dat","redstone3.dat","rightarrow.dat","scrollbar.dat","sideicons.dat","staticons.dat","staticons2.dat","steelborder.dat","steelborder2.dat","sworddecor.dat","tradebacking.dat","wornicons.dat","mapmarker.dat","mod_icons.dat","mapedge.dat","blackmark.dat","button_brown.dat","button_brown_big.dat","button_red.dat","chest.dat","coins.dat","headicons_hint.dat","headicons_pk.dat","headicons_prayer.dat","key.dat","keys.dat","leftarrow_small.dat","letter.dat","number_button.dat","overlay_duel.dat","overlay_multiway.dat","pen.dat","rightarrow_small.dat","startgame.dat","tex_brown.dat","tex_red.dat","titlescroll.dat","base_head.dat","base_label.dat","base_type.dat","frame_del.dat","frame_head.dat","frame_tran1.dat","frame_tran2.dat","ob_axis.dat","ob_face1.dat","ob_face2.dat","ob_face3.dat","ob_face4.dat","ob_face5.dat","ob_head.dat","ob_point1.dat","ob_point2.dat","ob_point3.dat","ob_point4.dat","ob_point5.dat","ob_vertex1.dat","ob_vertex2.dat","anim_crc","anim_index","anim_version","map_crc","map_index","map_version","midi_crc","midi_index","midi_version","model_crc","model_index","model_version","0.dat","1.dat","2.dat","3.dat","4.dat","5.dat","6.dat","7.dat","8.dat","9.dat","10.dat","11.dat","12.dat","13.dat","14.dat","15.dat","16.dat","17.dat","18.dat","19.dat","20.dat","21.dat","22.dat","23.dat","24.dat","25.dat","26.dat","27.dat","28.dat","29.dat","30.dat","31.dat","32.dat","33.dat","34.dat","35.dat","36.dat","37.dat","38.dat","39.dat","40.dat","41.dat","42.dat","43.dat","44.dat","45.dat","46.dat","47.dat","48.dat","49.dat","badenc.txt","domainenc.txt","fragmentsenc.txt","tldlist.txt","sounds.dat","labels.dat","floorcol.dat","underlay.dat","overlay.dat","size.dat"],KNOWN_HASHES=[];for(let e=0;e<KNOWN_NAMES.length;e++)KNOWN_HASHES[e]=genHash(KNOWN_NAMES[e]);class FontType{static CHAR_LOOKUP=[];static instances=[];static{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"Â£$%^&*()-_=+[{]};:'@#~,<.>/?\\| ";for(let t=0;t<256;t++){let i=e.indexOf(String.fromCharCode(t));-1==i&&(i=74),FontType.CHAR_LOOKUP[t]=i}}static async load(e){const t=await Jagfile.load(`${e}/client/title`);FontType.instances[0]=new FontType(t,"p11"),FontType.instances[1]=new FontType(t,"p12"),FontType.instances[2]=new FontType(t,"b12"),FontType.instances[3]=new FontType(t,"q8")}static get(e){return FontType.instances[e]}static get count(){return this.instances.length}charMask=new Array(94);charMaskWidth=new Uint8Array(94);charMaskHeight=new Uint8Array(94);charOffsetX=new Uint8Array(94);charOffsetY=new Uint8Array(94);charAdvance=new Uint8Array(95);drawWidth=new Uint8Array(256);height=0;constructor(e,t){const i=e.read(`${t}.dat`),n=e.read("index.dat");if(!i||!n)return;n.pos=i.g2()+4;const r=n.g1();r>0&&(n.pos+=3*(r-1));for(let e=0;e<94;e++){this.charOffsetX[e]=n.g1(),this.charOffsetY[e]=n.g1();const t=this.charMaskWidth[e]=n.g2(),r=this.charMaskHeight[e]=n.g2(),a=n.g1(),s=t*r;if(this.charMask[e]=new Uint8Array(s),0==a)for(let t=0;t<s;t++)this.charMask[e][t]=i.g1();else if(1==a)for(let n=0;n<t;n++)for(let a=0;a<r;a++)this.charMask[e][n+a*t]=i.g1();r>this.height&&(this.height=r),this.charOffsetX[e]=1,this.charAdvance[e]=t+2;let o=0;for(let i=Math.floor(r/7);i<r;i++)o+=this.charMask[e][i*t];o<=Math.floor(r/7)&&(this.charAdvance[e]--,this.charOffsetX[e]=0),o=0;for(let i=Math.floor(r/7);i<r;i++)o+=this.charMask[e][t+i*t-1];o<=Math.floor(r/7)&&this.charAdvance[e]--}this.charAdvance[94]=this.charAdvance[8];for(let e=0;e<256;e++)this.drawWidth[e]=this.charAdvance[FontType.CHAR_LOOKUP[e]]}stringWidth(e){if(null==e)return 0;let t=0;for(let i=0;i<e.length;i++)"@"==e.charAt(i)&&i+4<e.length&&"@"==e.charAt(i+4)?i+=4:t+=this.drawWidth[e.charCodeAt(i)];return t}split(e,t){if(0===e.length)return[e];const i=[];for(;e.length>0;){if(this.stringWidth(e)<=t&&-1===e.indexOf("|")){i.push(e);break}let n=e.length;for(let i=0;i<e.length;i++)if(" "===e[i]){if(this.stringWidth(e.substring(0,i))>t)break;n=i}else if("|"===e[i]){n=i;break}i.push(e.substring(0,n)),e=e.substring(n+1)}return i}}(e=>{e[e.OFF=0]="OFF",e[e.OUTSIDE_WILDERNESS=1]="OUTSIDE_WILDERNESS"})(HuntCheckNotTooStrong||={});var HuntModeType,HuntCheckNotTooStrong_default=HuntCheckNotTooStrong;(e=>{e[e.OFF=0]="OFF",e[e.PLAYER=1]="PLAYER",e[e.NPC=2]="NPC",e[e.OBJ=3]="OBJ",e[e.SCENERY=4]="SCENERY"})(HuntModeType||={});var HuntNobodyNear,HuntModeType_default=HuntModeType;(e=>{e[e.KEEPHUNTING=0]="KEEPHUNTING",e[e.PAUSEHUNT=1]="PAUSEHUNT"})(HuntNobodyNear||={});var HuntVis,HuntNobodyNear_default=HuntNobodyNear;(e=>{e[e.OFF=0]="OFF",e[e.LINEOFSIGHT=1]="LINEOFSIGHT",e[e.LINEOFWALK=2]="LINEOFWALK"})(HuntVis||={});var NpcMode,HuntVis_default=HuntVis;(e=>{e[e.NULL=-1]="NULL",e[e.NONE=0]="NONE",e[e.WANDER=1]="WANDER",e[e.PATROL=2]="PATROL",e[e.PLAYERESCAPE=3]="PLAYERESCAPE",e[e.PLAYERFOLLOW=4]="PLAYERFOLLOW",e[e.PLAYERFACE=5]="PLAYERFACE",e[e.PLAYERFACECLOSE=6]="PLAYERFACECLOSE",e[e.OPPLAYER1=7]="OPPLAYER1",e[e.OPPLAYER2=8]="OPPLAYER2",e[e.OPPLAYER3=9]="OPPLAYER3",e[e.OPPLAYER4=10]="OPPLAYER4",e[e.OPPLAYER5=11]="OPPLAYER5",e[e.APPLAYER1=12]="APPLAYER1",e[e.APPLAYER2=13]="APPLAYER2",e[e.APPLAYER3=14]="APPLAYER3",e[e.APPLAYER4=15]="APPLAYER4",e[e.APPLAYER5=16]="APPLAYER5",e[e.OPLOC1=17]="OPLOC1",e[e.OPLOC2=18]="OPLOC2",e[e.OPLOC3=19]="OPLOC3",e[e.OPLOC4=20]="OPLOC4",e[e.OPLOC5=21]="OPLOC5",e[e.APLOC1=22]="APLOC1",e[e.APLOC2=23]="APLOC2",e[e.APLOC3=24]="APLOC3",e[e.APLOC4=25]="APLOC4",e[e.APLOC5=26]="APLOC5",e[e.OPOBJ1=27]="OPOBJ1",e[e.OPOBJ2=28]="OPOBJ2",e[e.OPOBJ3=29]="OPOBJ3",e[e.OPOBJ4=30]="OPOBJ4",e[e.OPOBJ5=31]="OPOBJ5",e[e.APOBJ1=32]="APOBJ1",e[e.APOBJ2=33]="APOBJ2",e[e.APOBJ3=34]="APOBJ3",e[e.APOBJ4=35]="APOBJ4",e[e.APOBJ5=36]="APOBJ5",e[e.OPNPC1=37]="OPNPC1",e[e.OPNPC2=38]="OPNPC2",e[e.OPNPC3=39]="OPNPC3",e[e.OPNPC4=40]="OPNPC4",e[e.OPNPC5=41]="OPNPC5",e[e.APNPC1=42]="APNPC1",e[e.APNPC2=43]="APNPC2",e[e.APNPC3=44]="APNPC3",e[e.APNPC4=45]="APNPC4",e[e.APNPC5=46]="APNPC5",e[e.QUEUE1=47]="QUEUE1",e[e.QUEUE2=48]="QUEUE2",e[e.QUEUE3=49]="QUEUE3",e[e.QUEUE4=50]="QUEUE4",e[e.QUEUE5=51]="QUEUE5",e[e.QUEUE6=52]="QUEUE6",e[e.QUEUE7=53]="QUEUE7",e[e.QUEUE8=54]="QUEUE8",e[e.QUEUE9=55]="QUEUE9",e[e.QUEUE10=56]="QUEUE10",e[e.QUEUE11=57]="QUEUE11",e[e.QUEUE12=58]="QUEUE12",e[e.QUEUE13=59]="QUEUE13",e[e.QUEUE14=60]="QUEUE14",e[e.QUEUE15=61]="QUEUE15",e[e.QUEUE16=62]="QUEUE16",e[e.QUEUE17=63]="QUEUE17",e[e.QUEUE18=64]="QUEUE18",e[e.QUEUE19=65]="QUEUE19",e[e.QUEUE20=66]="QUEUE20"})(NpcMode||={});var NpcMode_default=NpcMode;class HuntType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(HuntType.configNames=new Map,HuntType.configs=[],!(await fetch(`${e}/server/hunt.dat`)).ok)return void console.log("Warning: No hunt.dat found.");const t=await Packet.load(`${e}/server/hunt.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new HuntType(e);i.decodeType(t),HuntType.configs[e]=i,i.debugname&&HuntType.configNames.set(i.debugname,e)}}static get(e){return HuntType.configs[e]}static getId(e){return HuntType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}type=HuntModeType_default.OFF;checkVis=HuntVis_default.OFF;checkNotTooStrong=HuntCheckNotTooStrong_default.OFF;checkNotBusy=!1;findKeepHunting=!1;findNewMode=NpcMode_default.NONE;nobodyNear=HuntNobodyNear_default.PAUSEHUNT;checkNotCombat=-1;checkNotCombatSelf=-1;checkAfk=!0;rate=1;checkCategory=-1;checkNpc=-1;checkObj=-1;checkLoc=-1;checkInv=-1;checkObjParam=-1;checkInvMinQuantity=-1;checkInvMaxQuantity=-1;decode(e,t){if(1===e)this.type=t.g1();else if(2==e)this.checkVis=t.g1();else if(3==e)this.checkNotTooStrong=t.g1();else if(4==e)this.checkNotBusy=!0;else if(5==e)this.findKeepHunting=!0;else if(6==e)this.findNewMode=t.g1();else if(7==e)this.nobodyNear=t.g1();else if(8===e)this.checkNotCombat=t.g2();else if(9===e)this.checkNotCombatSelf=t.g2();else if(10===e)this.checkAfk=!1;else if(11===e)this.rate=t.g2();else if(12===e)this.checkCategory=t.g2();else if(13===e)this.checkNpc=t.g2();else if(14===e)this.checkObj=t.g2();else if(15===e)this.checkLoc=t.g2();else if(16===e)this.checkInv=t.g2(),this.checkObj=t.g2(),this.checkInvMinQuantity=t.g4(),this.checkInvMaxQuantity=t.g4();else if(17===e)this.checkInv=t.g2(),this.checkObjParam=t.g2(),this.checkInvMinQuantity=t.g4(),this.checkInvMaxQuantity=t.g4();else{if(250!==e)throw new Error(`Unrecognized hunt config code: ${e}`);this.debugname=t.gjstr()}}}class IdkType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(IdkType.configNames=new Map,IdkType.configs=[],!(await fetch(`${e}/server/idk.dat`)).ok)return void console.log("Warning: No idk.dat found.");const t=await Packet.load(`${e}/server/idk.dat`),i=t.g2(),n=(await Jagfile.load(`${e}/client/config`)).read("idk.dat");n.pos=2;for(let e=0;e<i;e++){const i=new IdkType(e);i.decodeType(t),i.decodeType(n),IdkType.configs[e]=i,i.debugname&&IdkType.configNames.set(i.debugname,e)}}static get(e){return IdkType.configs[e]}static getId(e){return IdkType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}type=-1;models=null;heads=new Uint16Array(5).fill(-1);recol_s=new Uint16Array(6).fill(0);recol_d=new Uint16Array(6).fill(0);disable=!1;decode(e,t){if(1===e)this.type=t.g1();else if(2===e){const e=t.g1();this.models=new Uint16Array(e);for(let i=0;i<e;i++)this.models[i]=t.g2()}else if(3===e)this.disable=!0;else if(e>=40&&e<50)this.recol_s[e-40]=t.g2();else if(e>=50&&e<60)this.recol_d[e-50]=t.g2();else if(e>=60&&e<70)this.heads[e-60]=t.g2();else{if(250!==e)throw new Error(`Unrecognized idk config code: ${e}`);this.debugname=t.gjstr()}}}class Component{static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INVENTORY=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_SPRITE=5;static TYPE_MODEL=6;static TYPE_INVENTORY_TEXT=7;static NO_BUTTON=0;static BUTTON=1;static TARGET_BUTTON=2;static CLOSE_BUTTON=3;static TOGGLE_BUTTON=4;static SELECT_BUTTON=5;static PAUSE_BUTTON=6;static componentNames=new Map;static components=[];static async load(e){if(this.componentNames=new Map,this.components=[],!(await fetch(`${e}/server/interface.dat`)).ok)return void console.log("Warning: No interface.dat found.");const t=await Packet.load(`${e}/server/interface.dat`);t.g2();let i=-1;for(;t.available>0;){let e=t.g2();65535===e&&(i=t.g2(),e=t.g2());const n=new Component;n.id=e,n.rootLayer=i,n.comName=t.gjstr(),n.overlay=t.gbool(),n.type=t.g1(),n.buttonType=t.g1(),n.clientCode=t.g2(),n.width=t.g2(),n.height=t.g2(),n.overLayer=t.g1(),0==n.overLayer?n.overLayer=-1:n.overLayer=(n.overLayer-1<<8)+t.g1();const r=t.g1();if(r>0){n.scriptComparator=new Uint8Array(r).fill(0),n.scriptOperand=new Uint16Array(r).fill(0);for(let e=0;e<r;e++)n.scriptComparator[e]=t.g1(),n.scriptOperand[e]=t.g2()}const a=t.g1();if(a>0){n.scripts=new Array(a).fill(null);for(let e=0;e<a;e++){const i=t.g2();n.scripts[e]=new Uint16Array(i).fill(0);for(let r=0;r<i;r++)n.scripts[e][r]=t.g2()}}switch(n.type){case Component.TYPE_LAYER:{n.scroll=t.g2(),n.hide=t.gbool();const e=t.g1();n.childId=new Uint16Array(e).fill(0),n.childX=new Uint16Array(e).fill(0),n.childY=new Uint16Array(e).fill(0);for(let i=0;i<e;i++)n.childId[i]=t.g2(),n.childX[i]=t.g2s(),n.childY[i]=t.g2s();break}case Component.TYPE_UNUSED:t.pos+=10;break;case Component.TYPE_INVENTORY:n.draggable=t.gbool(),n.interactable=t.gbool(),n.usable=t.gbool(),n.marginX=t.g1(),n.marginY=t.g1(),n.inventorySlotOffsetX=new Uint16Array(20).fill(0),n.inventorySlotOffsetY=new Uint16Array(20).fill(0),n.inventorySlotGraphic=new Array(20).fill(null);for(let e=0;e<20;e++)t.gbool()&&(n.inventorySlotOffsetX[e]=t.g2s(),n.inventorySlotOffsetY[e]=t.g2s(),n.inventorySlotGraphic[e]=t.gjstr());n.inventoryOptions=new Array(5).fill(null);for(let e=0;e<5;e++)n.inventoryOptions[e]=t.gjstr();n.actionVerb=t.gjstr(),n.action=t.gjstr(),n.actionTarget=t.g2();break;case Component.TYPE_RECT:n.fill=t.gbool(),n.colour=t.g4(),n.activeColour=t.g4(),n.overColour=t.g4();break;case Component.TYPE_TEXT:n.center=t.gbool(),n.font=t.g1(),n.shadowed=t.gbool(),n.text=t.gjstr(),n.activeText=t.gjstr(),n.colour=t.g4(),n.activeColour=t.g4(),n.overColour=t.g4();break;case Component.TYPE_SPRITE:n.graphic=t.gjstr(),n.activeGraphic=t.gjstr();break;case Component.TYPE_MODEL:n.model=t.g1(),0!=n.model&&(n.model=(n.model-1<<8)+t.g1()),n.activeModel=t.g1(),0!=n.activeModel&&(n.activeModel=(n.activeModel-1<<8)+t.g1()),n.anim=t.g1(),0==n.anim?n.anim=-1:n.anim=(n.anim-1<<8)+t.g1(),n.activeAnim=t.g1(),0==n.activeAnim?n.activeAnim=-1:n.activeAnim=(n.activeAnim-1<<8)+t.g1(),n.zoom=t.g2(),n.xan=t.g2(),n.yan=t.g2();break;case Component.TYPE_INVENTORY_TEXT:n.center=t.gbool(),n.font=t.g1(),n.shadowed=t.gbool(),n.colour=t.g4(),n.marginX=t.g2s(),n.marginY=t.g2s(),n.interactable=t.gbool(),n.inventoryOptions=new Array(5).fill(null);for(let e=0;e<5;e++)n.inventoryOptions[e]=t.gjstr()}switch(n.buttonType){case Component.NO_BUTTON:break;case Component.TARGET_BUTTON:n.actionVerb=t.gjstr(),n.action=t.gjstr(),n.actionTarget=t.g2();break;case Component.BUTTON:case Component.TOGGLE_BUTTON:case Component.SELECT_BUTTON:case Component.PAUSE_BUTTON:n.option=t.gjstr()}Component.components[e]=n,n.comName&&Component.componentNames.set(n.comName,e)}}static get(e){return Component.components[e]}static getId(e){return Component.componentNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}id=-1;rootLayer=-1;comName=null;overlay=!1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;inventorySlotOffsetX=null;inventorySlotOffsetY=null;inventorySlotGraphic=null;inventoryOptions=null;fill=!1;center=!1;font=0;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=-1;activeModel=-1;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null}class InvType extends ConfigType{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static SCOPE_SHARED=2;static INV=-1;static WORN=-1;static async load(e){if(InvType.configNames=new Map,InvType.configs=[],!(await fetch(`${e}/server/inv.dat`)).ok)return void console.log("Warning: No inv.dat found.");const t=await Packet.load(`${e}/server/inv.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new InvType(e);i.decodeType(t),InvType.configs[e]=i,i.debugname&&InvType.configNames.set(i.debugname,e)}InvType.INV=InvType.getId("inv"),InvType.WORN=InvType.getId("worn")}static get(e){return InvType.configs[e]}static getId(e){return InvType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}scope=0;size=1;stackall=!1;restock=!1;allstock=!1;stockobj=null;stockcount=null;stockrate=null;protect=!0;runweight=!1;dummyinv=!1;decode(e,t){if(1===e)this.scope=t.g1();else if(2===e)this.size=t.g2();else if(3===e)this.stackall=!0;else if(4===e){const e=t.g1();this.stockobj=new Uint16Array(e),this.stockcount=new Uint16Array(e),this.stockrate=new Int32Array(e);for(let i=0;i<e;i++)this.stockobj[i]=t.g2(),this.stockcount[i]=t.g2(),this.stockrate[i]=t.g4()}else if(5===e)this.restock=!0;else if(6===e)this.allstock=!0;else if(7===e)this.protect=!1;else if(8===e)this.runweight=!0;else if(9===e)this.dummyinv=!0;else{if(250!==e)throw new Error(`Unrecognized inv config code: ${e}`);this.debugname=t.gjstr()}}}var BlockWalk,ParamHelper={getStringParam:function(e,t,i){const n=t.params?.get(e);return"string"!=typeof n?i??"null":n},getIntParam:function(e,t,i){const n=t.params?.get(e);return"number"!=typeof n?i:n},decodeParams:function(e){const t=e.g1(),i=new Map;for(let n=0;n<t;n++){const t=e.g3();e.gbool()?i.set(t,e.gjstr()):i.set(t,e.g4())}return i}};class LocType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(LocType.configNames=new Map,LocType.configs=[],!(await fetch(`${e}/server/loc.dat`)).ok)return void console.log("Warning: No loc.dat found.");const t=await Packet.load(`${e}/server/loc.dat`),i=t.g2(),n=(await Jagfile.load(`${e}/client/config`)).read("loc.dat");n.pos=2;for(let e=0;e<i;e++){const i=new LocType(e);i.active=-1,i.decodeType(t),i.decodeType(n),-1===i.active&&i.shapes&&(i.active=i.shapes.length>0&&10===i.shapes[0]?1:0,i.op&&i.op.length>0&&(i.active=1)),LocType.configs[e]=i,i.debugname&&LocType.configNames.set(i.debugname,e)}}static get(e){return LocType.configs[e]}static getId(e){return LocType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return void 0===t||-1===t?null:this.get(t)}static get count(){return this.configs.length}models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=0;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;hasalpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;xoff=0;yoff=0;zoff=0;forcedecor=!1;category=-1;params=new Map;decode(e,t){if(1===e){const e=t.g1();this.models=new Uint16Array(e),this.shapes=new Uint8Array(e);for(let i=0;i<e;i++)this.models[i]=t.g2(),this.shapes[i]=t.g1()}else if(2===e)this.name=t.gjstr();else if(3===e)this.desc=t.gjstr();else if(14===e)this.width=t.g1();else if(15===e)this.length=t.g1();else if(17===e)this.blockwalk=!1;else if(18===e)this.blockrange=!1;else if(19===e)this.active=t.g1();else if(21===e)this.hillskew=!0;else if(22===e)this.sharelight=!0;else if(23===e)this.occlude=!0;else if(24===e)this.anim=t.g2(),65535==this.anim&&(this.anim=-1);else if(25===e)this.hasalpha=!0;else if(28===e)this.wallwidth=t.g1();else if(29===e)this.ambient=t.g1b();else if(39===e)this.contrast=t.g1b();else if(e>=30&&e<35)this.op||(this.op=new Array(5).fill(null)),this.op[e-30]=t.gjstr(),"hidden"===this.op[e-30]&&(this.op[e-30]=null);else if(40===e){const e=t.g1();this.recol_s=new Uint16Array(e),this.recol_d=new Uint16Array(e);for(let i=0;i<e;i++)this.recol_s[i]=t.g2(),this.recol_d[i]=t.g2()}else if(60===e)this.mapfunction=t.g2();else if(62===e)this.mirror=!0;else if(64===e)this.shadow=!1;else if(65===e)this.resizex=t.g2();else if(66===e)this.resizey=t.g2();else if(67===e)this.resizez=t.g2();else if(68===e)this.mapscene=t.g2();else if(69===e)this.forceapproach=t.g1();else if(70===e)this.xoff=t.g2s();else if(71===e)this.yoff=t.g2s();else if(72===e)this.zoff=t.g2s();else if(73===e)this.forcedecor=!0;else if(200===e)this.category=t.g2();else if(249===e)this.params=ParamHelper.decodeParams(t);else{if(250!==e)throw new Error(`Unrecognized loc config code: ${e}`);this.debugname=t.gjstr()}}}class MesanimType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(MesanimType.configNames=new Map,MesanimType.configs=[],!(await fetch(`${e}/server/mesanim.dat`)).ok)return void console.log("Warning: No mesanim.dat found.");const t=await Packet.load(`${e}/server/mesanim.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new MesanimType(e);i.decodeType(t),MesanimType.configs[e]=i,i.debugname&&MesanimType.configNames.set(i.debugname,e)}}static get(e){return MesanimType.configs[e]}static getId(e){return MesanimType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}len=new Array(4).fill(-1);decode(e,t){if(e>=1&&e<5)this.len[e-1]=t.g2();else{if(250!==e)throw new Error(`Unrecognized mesanim config code: ${e}`);this.debugname=t.gjstr()}}}(e=>{e[e.NONE=0]="NONE",e[e.NPC=1]="NPC",e[e.ALL=2]="ALL"})(BlockWalk||={});var MoveRestrict,BlockWalk_default=BlockWalk;(e=>{e[e.NORMAL=0]="NORMAL",e[e.BLOCKED=1]="BLOCKED",e[e.BLOCKED_NORMAL=2]="BLOCKED_NORMAL",e[e.INDOORS=3]="INDOORS",e[e.OUTDOORS=4]="OUTDOORS",e[e.NOMOVE=5]="NOMOVE",e[e.PASSTHRU=6]="PASSTHRU"})(MoveRestrict||={});var NpcStat,MoveRestrict_default=MoveRestrict;(e=>{e[e.ATTACK=0]="ATTACK",e[e.DEFENCE=1]="DEFENCE",e[e.STRENGTH=2]="STRENGTH",e[e.HITPOINTS=3]="HITPOINTS",e[e.RANGED=4]="RANGED",e[e.MAGIC=5]="MAGIC"})(NpcStat||={});var ScriptPointer,NpcStat_default=NpcStat;class NpcType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(NpcType.configNames=new Map,NpcType.configs=[],!(await fetch(`${e}/server/npc.dat`)).ok)return void console.log("Warning: No npc.dat found.");const t=await Packet.load(`${e}/server/npc.dat`),i=t.g2(),n=(await Jagfile.load(`${e}/client/config`)).read("npc.dat");n.pos=2;for(let e=0;e<i;e++){const i=new NpcType(e);i.decodeType(t),i.decodeType(n),NpcType.configs[e]=i,i.debugname&&NpcType.configNames.set(i.debugname,e)}}static get(e){return NpcType.configs[e]}static getId(e){return NpcType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}name=null;desc=null;size=1;models=null;heads=null;hasanim=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;hasalpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;category=-1;wanderrange=5;maxrange=10;huntrange=5;timer=-1;respawnrate=100;stats=[1,1,1,1,1,1];moverestrict=MoveRestrict_default.NORMAL;attackrange=7;huntmode=-1;defaultmode=NpcMode_default.WANDER;members=!1;blockwalk=BlockWalk_default.NPC;params=new Map;patrolCoord=[];patrolDelay=[];givechase=!0;decode(e,t){if(1===e){const e=t.g1();this.models=new Uint16Array(e);for(let i=0;i<e;i++)this.models[i]=t.g2()}else if(2===e)this.name=t.gjstr();else if(3===e)this.desc=t.gjstr();else if(12===e)this.size=t.g1();else if(13===e)this.readyanim=t.g2();else if(14===e)this.walkanim=t.g2();else if(16===e)this.hasanim=!0;else if(17===e)this.walkanim=t.g2(),this.walkanim_b=t.g2(),this.walkanim_r=t.g2(),this.walkanim_l=t.g2();else if(18===e)this.category=t.g2();else if(e>=30&&e<40)this.op||(this.op=new Array(5).fill(null)),this.op[e-30]=t.gjstr(),"hidden"===this.op[e-30]&&(this.op[e-30]=null);else if(40===e){const e=t.g1();this.recol_s=new Uint16Array(e),this.recol_d=new Uint16Array(e);for(let i=0;i<e;i++)this.recol_s[i]=t.g2(),this.recol_d[i]=t.g2()}else if(60===e){const e=t.g1();this.heads=new Uint16Array(e);for(let i=0;i<e;i++)this.heads[i]=t.g2()}else if(74===e)this.stats[NpcStat_default.ATTACK]=t.g2();else if(75===e)this.stats[NpcStat_default.DEFENCE]=t.g2();else if(76===e)this.stats[NpcStat_default.STRENGTH]=t.g2();else if(77===e)this.stats[NpcStat_default.HITPOINTS]=t.g2();else if(78===e)this.stats[NpcStat_default.RANGED]=t.g2();else if(79===e)this.stats[NpcStat_default.MAGIC]=t.g2();else if(90===e)this.resizex=t.g2();else if(91===e)this.resizey=t.g2();else if(92===e)this.resizez=t.g2();else if(93===e)this.minimap=!1;else if(95===e)this.vislevel=t.g2();else if(97===e)this.resizeh=t.g2();else if(98===e)this.resizev=t.g2();else if(200===e)this.wanderrange=t.g1();else if(201===e)this.maxrange=t.g1();else if(202===e)this.huntrange=t.g1();else if(203===e)this.timer=t.g2();else if(204===e)this.respawnrate=t.g2();else if(206===e)this.moverestrict=t.g1();else if(207==e)this.attackrange=t.g1();else if(208===e)this.blockwalk=t.g1();else if(209===e)this.huntmode=t.g1();else if(210===e)this.defaultmode=t.g1();else if(211===e)this.members=!0;else if(212===e){const e=t.g1();this.patrolCoord=new Array(e),this.patrolDelay=new Array(e);for(let i=0;i<e;i++)this.patrolCoord[i]=t.g4(),this.patrolDelay[i]=t.g1()}else 213===e?this.givechase=!1:249===e?this.params=ParamHelper.decodeParams(t):250===e?this.debugname=t.gjstr():(console.error("Unrecognized npc config code: "+e),console.error("Try `npm run build` and report an issue if this still happens."),process.exit(1))}}class ParamType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){ParamType.configNames=new Map,ParamType.configs=[],(await fetch(`${e}/server/param.dat`)).ok||console.log("Warning: No param.dat found.");const t=await Packet.load(`${e}/server/param.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new ParamType(e);i.decodeType(t),ParamType.configs[e]=i,i.debugname&&ParamType.configNames.set(i.debugname,e)}}static get(e){return ParamType.configs[e]}static getId(e){return ParamType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}type=ScriptVarType.INT;defaultInt=-1;defaultString=null;autodisable=!0;decode(e,t){if(1===e)this.type=t.g1();else if(2===e)this.defaultInt=t.g4();else if(4===e)this.autodisable=!1;else if(5===e)this.defaultString=t.gjstr();else{if(250!==e)throw new Error(`Unrecognized param config code: ${e}`);this.debugname=t.gjstr()}}getType(){switch(this.type){case ScriptVarType.INT:return"int";case ScriptVarType.STRING:return"string";case ScriptVarType.ENUM:return"enum";case ScriptVarType.OBJ:return"obj";case ScriptVarType.LOC:return"loc";case ScriptVarType.COMPONENT:return"component";case ScriptVarType.NAMEDOBJ:return"namedobj";case ScriptVarType.STRUCT:return"struct";case ScriptVarType.BOOLEAN:return"boolean";case ScriptVarType.COORD:return"coord";case ScriptVarType.CATEGORY:return"category";case ScriptVarType.SPOTANIM:return"spotanim";case ScriptVarType.NPC:return"npc";case ScriptVarType.INV:return"inv";case ScriptVarType.SYNTH:return"synth";case ScriptVarType.SEQ:return"seq";case ScriptVarType.STAT:return"stat";case ScriptVarType.INTERFACE:return"interface";default:return"unknown"}}isString(){return this.type===ScriptVarType.STRING}get default(){return this.isString()?this.defaultString:this.defaultInt}}class ObjType extends ConfigType{static configNames=new Map;static configs=[];static async load(e,t){if(ObjType.configNames=new Map,ObjType.configs=[],!(await fetch(`${e}/server/obj.dat`)).ok)return void console.log("Warning: No obj.dat found.");const i=await Packet.load(`${e}/server/obj.dat`),n=i.g2(),r=(await Jagfile.load(`${e}/client/config`)).read("obj.dat");r.pos=2;for(let e=0;e<n;e++){const t=new ObjType(e);t.decodeType(i),t.decodeType(r),ObjType.configs[e]=t,t.debugname&&ObjType.configNames.set(t.debugname,e)}for(let e=0;e<n;e++){const i=ObjType.configs[e];-1!=i.certtemplate&&i.toCertificate(),!t&&i.members&&(i.tradeable=!1,i.op=null,i.iop=null,i.params.forEach(((e,t)=>{ParamType.get(t)?.autodisable&&i.params.delete(t)})))}}static get(e){return ObjType.configs[e]}static getId(e){return ObjType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}static getWearPosId(e){switch(e){case"hat":return 0;case"back":return 1;case"front":return 2;case"righthand":return 3;case"torso":return 4;case"lefthand":return 5;case"arms":return 6;case"legs":return 7;case"head":return 8;case"hands":return 9;case"feet":return 10;case"jaw":return 11;case"ring":return 12;case"quiver":return 13;default:return-1}}model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;wearpos=-1;wearpos2=-1;wearpos3=-1;weight=0;category=-1;dummyitem=0;tradeable=!1;respawnrate=100;params=new Map;decode(e,t){if(1===e)this.model=t.g2();else if(2===e)this.name=t.gjstr();else if(3===e)this.desc=t.gjstr();else if(4===e)this.zoom2d=t.g2();else if(5===e)this.xan2d=t.g2();else if(6===e)this.yan2d=t.g2();else if(7===e)this.xof2d=t.g2s();else if(8===e)this.yof2d=t.g2s();else if(9===e)this.code9=!0;else if(10===e)this.code10=t.g2();else if(11===e)this.stackable=!0;else if(12===e)this.cost=t.g4();else if(13===e)this.wearpos=t.g1();else if(14===e)this.wearpos2=t.g1();else if(16===e)this.members=!0;else if(23===e)this.manwear=t.g2(),this.manwearOffsetY=t.g1b();else if(24===e)this.manwear2=t.g2();else if(25===e)this.womanwear=t.g2(),this.womanwearOffsetY=t.g1b();else if(26===e)this.womanwear2=t.g2();else if(27===e)this.wearpos3=t.g1();else if(e>=30&&e<35)this.op||(this.op=new Array(5).fill(null)),this.op[e-30]=t.gjstr();else if(e>=35&&e<40)this.iop||(this.iop=new Array(5).fill(null)),this.iop[e-35]=t.gjstr();else if(40===e){const e=t.g1();this.recol_s=new Uint16Array(e),this.recol_d=new Uint16Array(e);for(let i=0;i<e;i++)this.recol_s[i]=t.g2(),this.recol_d[i]=t.g2()}else if(75===e)this.weight=t.g2s();else if(78===e)this.manwear3=t.g2();else if(79===e)this.womanwear3=t.g2();else if(90===e)this.manhead=t.g2();else if(91===e)this.womanhead=t.g2();else if(92===e)this.manhead2=t.g2();else if(93===e)this.womanhead2=t.g2();else if(94===e)this.category=t.g2();else if(95===e)this.zan2d=t.g2();else if(96===e)this.dummyitem=t.g1();else if(97===e)this.certlink=t.g2();else if(98===e)this.certtemplate=t.g2();else if(e>=100&&e<110)this.countobj&&this.countco||(this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10)),this.countobj[e-100]=t.g2(),this.countco[e-100]=t.g2();else if(200===e)this.tradeable=!0;else if(201===e)this.respawnrate=t.g2();else if(249===e)this.params=ParamHelper.decodeParams(t);else{if(250!==e)throw new Error(`Unrecognized obj config code: ${e}`);this.debugname=t.gjstr()}}toCertificate(){const e=ObjType.get(this.certtemplate);this.model=e.model,this.zoom2d=e.zoom2d,this.xan2d=e.xan2d,this.yan2d=e.yan2d,this.zan2d=e.zan2d,this.xof2d=e.xof2d,this.yof2d=e.yof2d,this.recol_s=e.recol_s,this.recol_d=e.recol_d;const t=ObjType.get(this.certlink);this.name=t.name,this.members=t.members,this.cost=t.cost,this.tradeable=t.tradeable;let i="a";const n=(t.name||"").toLowerCase().charAt(0);"a"!==n&&"e"!==n&&"i"!==n&&"o"!==n&&"u"!==n||(i="an"),this.desc=`Swap this note at any bank for ${i} ${t.name}.`,this.stackable=!0}}class SeqFrame{static instances=[];static async load(e){SeqFrame.instances=[];const t=await Packet.load(`${e}/server/frame_del.dat`);for(let e=0;e<t.data.length;e++){const i=new SeqFrame;i.delay=t.g1(),SeqFrame.instances[e]=i}}delay=0}class SeqType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(SeqType.configNames=new Map,SeqType.configs=[],!(await fetch(`${e}/server/seq.dat`)).ok)return void console.log("Warning: No seq.dat found.");const t=await Packet.load(`${e}/server/seq.dat`),i=t.g2(),n=(await Jagfile.load(`${e}/client/config`)).read("seq.dat");n.pos=2;for(let e=0;e<i;e++){const i=new SeqType(e);i.decodeType(t),i.decodeType(n),SeqType.configs[e]=i,i.debugname&&SeqType.configNames.set(i.debugname,e)}}static get(e){return SeqType.configs[e]}static getId(e){return SeqType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return SeqType.configs.length}frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;mainhand=-1;offhand=-1;replaycount=99;duration=0;decode(e,t){if(1===e){const e=t.g1();this.frames=new Int32Array(e),this.iframes=new Int32Array(e),this.delay=new Int32Array(e);for(let i=0;i<e;i++)this.frames[i]=t.g2(),this.iframes[i]=t.g2(),65535===this.iframes[i]&&(this.iframes[i]=-1),this.delay[i]=t.g2(),0===this.delay[i]&&(this.delay[i]=SeqFrame.instances[this.frames[i]].delay),0===this.delay[i]&&(this.delay[i]=1),this.duration+=this.delay[i]}else if(2===e)this.replayoff=t.g2();else if(3===e){const e=t.g1();this.walkmerge=new Int32Array(e+1);for(let i=0;i<e;i++)this.walkmerge[i]=t.g1();this.walkmerge[e]=9999999}else if(4===e)this.stretches=!0;else if(5===e)this.priority=t.g1();else if(6===e)this.mainhand=t.g2();else if(7===e)this.offhand=t.g2();else if(8===e)this.replaycount=t.g1();else{if(250!==e)throw new Error(`Unrecognized seq config code: ${e}`);this.debugname=t.gjstr()}}}class StructType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(StructType.configNames=new Map,StructType.configs=[],!(await fetch(`${e}/server/struct.dat`)).ok)return void console.log("Warning: No struct.dat found.");const t=await Packet.load(`${e}/server/struct.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new StructType(e);i.decodeType(t),StructType.configs[e]=i,i.debugname&&StructType.configNames.set(i.debugname,e)}}static get(e){return StructType.configs[e]}static getId(e){return StructType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}params=null;decode(e,t){if(249===e)this.params=ParamHelper.decodeParams(t);else{if(250!==e)throw new Error(`Unrecognized struct config code: ${e}`);this.debugname=t.gjstr()}}}class VarNpcType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(VarNpcType.configNames=new Map,VarNpcType.configs=[],!(await fetch(`${e}/server/varn.dat`)).ok)return void console.log("Warning: No varn.dat found.");const t=await Packet.load(`${e}/server/varn.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new VarNpcType(e);i.decodeType(t),VarNpcType.configs[e]=i,i.debugname&&VarNpcType.configNames.set(i.debugname,e)}}static get(e){return VarNpcType.configs[e]}static getId(e){return VarNpcType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}type=ScriptVarType.INT;decode(e,t){1===e?this.type=t.g1():250===e?this.debugname=t.gjstr():console.error(`Unrecognized varn config code: ${e}`)}}class VarPlayerType extends ConfigType{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static PLAYER_RUN=-1;static TEMP_RUN=-1;static LASTCOMBAT=-1;static async load(e){VarPlayerType.configNames=new Map,VarPlayerType.configs=[],(await fetch(`${e}/server/varp.dat`)).ok||console.log("Warning: No varp.dat found.");const t=await Packet.load(`${e}/server/varp.dat`),i=t.g2(),n=(await Jagfile.load(`${e}/client/config`)).read("varp.dat");n.pos=2;for(let e=0;e<i;e++){const i=new VarPlayerType(e);i.decodeType(t),i.decodeType(n),VarPlayerType.configs[e]=i,i.debugname&&VarPlayerType.configNames.set(i.debugname,e)}VarPlayerType.PLAYER_RUN=VarPlayerType.getId("player_run"),VarPlayerType.TEMP_RUN=VarPlayerType.getId("temp_run"),VarPlayerType.LASTCOMBAT=VarPlayerType.getId("lastcombat")}static get(e){return VarPlayerType.configs[e]}static getId(e){return VarPlayerType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}clientcode=0;scope=VarPlayerType.SCOPE_TEMP;type=ScriptVarType.INT;protect=!0;transmit=!1;decode(e,t){1===e?this.scope=t.g1():2===e?this.type=t.g1():4===e?this.protect=!1:5===e?this.clientcode=t.g2():6===e?this.transmit=!0:250===e?this.debugname=t.gjstr():console.error(`Unrecognized varp config code: ${e}`)}}class VarSharedType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(VarSharedType.configNames=new Map,VarSharedType.configs=[],!(await fetch(`${e}/server/vars.dat`)).ok)return void console.log("Warning: No vars.dat found.");const t=await Packet.load(`${e}/server/vars.dat`),i=t.g2();for(let e=0;e<i;e++){const i=new VarSharedType(e);i.decodeType(t),VarSharedType.configs[e]=i,i.debugname&&VarSharedType.configNames.set(i.debugname,e)}}static get(e){return VarSharedType.configs[e]}static getId(e){return VarSharedType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}type=ScriptVarType.INT;decode(e,t){switch(e){case 1:this.type=t.g1();break;case 250:this.debugname=t.gjstr();break;default:console.error(`Unrecognized vars config code: ${e}`)}}}class WordEncFragments{fragments=[];filter(e){for(let t=0;t<e.length;){const i=this.indexOfNumber(e,t);if(-1===i)return;let n=!1;for(let r=t;r>=0&&r<i&&!n;r++)WordEnc2.isSymbol(e[r])||WordEnc2.isNotLowercaseAlpha(e[r])||(n=!0);let r=0;n&&(r=0),0===r&&(r=1,t=i);let a=0;for(let n=i;n<e.length&&n<t;n++)a=10*a+e[n].charCodeAt(0)-48;a<=255&&t-i<=8?r++:r=0,4===r&&(WordEnc2.maskChars(i,t,e),r=0),t=this.indexOfNonNumber(t,e)}}isBadFragment(e){if(WordEnc2.isNumericalChars(e))return!0;const t=this.getInteger(e),i=this.fragments,n=i.length;if(t===i[0]||t===i[n-1])return!0;let r=0,a=n-1;for(;r<=a;){const e=(r+a)/2|0;if(t===i[e])return!0;t<i[e]?a=e-1:r=e+1}return!1}getInteger(e){if(e.length>6)return 0;let t=0;for(let i=0;i<e.length;i++){const n=e[e.length-i-1];if(WordEnc2.isLowercaseAlpha(n))t=38*t+n.charCodeAt(0)+1-"a".charCodeAt(0);else if("'"==n)t=38*t+27;else if(WordEnc2.isNumerical(n))t=38*t+n.charCodeAt(0)+28-"0".charCodeAt(0);else if("\0"!=n)return 0}return t}indexOfNumber(e,t){for(let i=t;i<e.length&&i>=0;i++)if(WordEnc2.isNumerical(e[i]))return i;return-1}indexOfNonNumber(e,t){for(let i=e;i<t.length&&i>=0;i++)if(!WordEnc2.isNumerical(t[i]))return i;return t.length}}class WordEncBadWords{wordEncFragments;bads=[];badCombinations=[];constructor(e){this.wordEncFragments=e}filter(e){for(let t=0;t<2;t++)for(let t=this.bads.length-1;t>=0;t--)this.filterBadCombinations(this.badCombinations[t],e,this.bads[t])}filterBadCombinations(e,t,i){if(!(i.length>t.length))for(let n=0;n<=t.length-i.length;n++){let r=n;const{currentIndex:a,badIndex:s,hasSymbol:o,hasNumber:c,hasDigit:l}=this.processBadCharacters(t,i,r);r=a;let d=t[r],p=r+1<t.length?t[r+1]:"\0";if(!(s>=i.length)||c&&l)continue;let h,u=!0;if(o){let e=!1,i=!1;if((n-1<0||WordEnc2.isSymbol(t[n-1])&&"'"!=t[n-1])&&(e=!0),(r>=t.length||WordEnc2.isSymbol(t[r])&&"'"!=t[r])&&(i=!0),!e||!i){let i=!1;for(h=n-2,e&&(h=n);!i&&h<r;){if(h>=0&&(!WordEnc2.isSymbol(t[h])||"'"==t[h])){const e=[];let n;for(n=0;n<3&&h+n<t.length&&(!WordEnc2.isSymbol(t[h+n])||"'"==t[h+n]);n++)e[n]=t[h+n];let r=!0;0==n&&(r=!1),n<3&&h-1>=0&&(!WordEnc2.isSymbol(t[h-1])||"'"==t[h-1])&&(r=!1),r&&!this.wordEncFragments.isBadFragment(e)&&(i=!0)}h++}i||(u=!1)}}else{d=" ",n-1>=0&&(d=t[n-1]),p=" ",r<t.length&&(p=t[r]);const i=this.getIndex(d),a=this.getIndex(p);null!=e&&this.comboMatches(i,e,a)&&(u=!1)}if(!u)continue;let _=0,g=0;for(let e=n;e<r;e++)WordEnc2.isNumerical(t[e])?_++:WordEnc2.isAlpha(t[e])&&g++;_<=g&&WordEnc2.maskChars(n,r,t)}}processBadCharacters(e,t,i){let n=i,r=0,a=0,s=!1,o=!1,c=!1;for(;n<e.length&&(!o||!c)&&!(n>=e.length||o&&c);){const l=e[n],d=n+1<e.length?e[n+1]:"\0";let p;if(r<t.length&&(p=this.getEmulatedBadCharLen(d,String.fromCharCode(t[r]),l))>0)1===p&&WordEnc2.isNumerical(l)&&(o=!0),2===p&&(WordEnc2.isNumerical(l)||WordEnc2.isNumerical(d))&&(o=!0),n+=p,r++;else{if(0===r)break;let e;if((e=this.getEmulatedBadCharLen(d,String.fromCharCode(t[r-1]),l))>0)n+=e;else{if(r>=t.length||!WordEnc2.isNotLowercaseAlpha(l))break;if(WordEnc2.isSymbol(l)&&"'"!==l&&(s=!0),WordEnc2.isNumerical(l)&&(c=!0),n++,a++,(100*a/(n-i)|0)>90)break}}}return{currentIndex:n,badIndex:r,hasSymbol:s,hasNumber:o,hasDigit:c}}getEmulatedBadCharLen(e,t,i){if(t==i)return 1;if(t>="a"&&t<="m"){if("a"==t)return"4"!=i&&"@"!=i&&"^"!=i?"/"==i&&"\\"==e?2:0:1;if("b"==t)return"6"!=i&&"8"!=i?"1"==i&&"3"==e?2:0:1;if("c"==t)return"("!=i&&"<"!=i&&"{"!=i&&"["!=i?0:1;if("d"==t)return"["==i&&")"==e?2:0;if("e"==t)return"3"!=i&&"â¬"!=i?0:1;if("f"==t)return"p"==i&&"h"==e?2:"Â£"==i?1:0;if("g"==t)return"9"!=i&&"6"!=i?0:1;if("h"==t)return"#"==i?1:0;if("i"==t)return"y"!=i&&"l"!=i&&"j"!=i&&"1"!=i&&"!"!=i&&":"!=i&&";"!=i&&"|"!=i?0:1;if("j"==t)return 0;if("k"==t)return 0;if("l"==t)return"1"!=i&&"|"!=i&&"i"!=i?0:1;if("m"==t)return 0}if(t>="n"&&t<="z"){if("n"==t)return 0;if("o"==t)return"0"!=i&&"*"!=i?"("==i&&")"==e||"["==i&&"]"==e||"{"==i&&"}"==e||"<"==i&&">"==e?2:0:1;if("p"==t)return 0;if("q"==t)return 0;if("r"==t)return 0;if("s"==t)return"5"!=i&&"z"!=i&&"$"!=i&&"2"!=i?0:1;if("t"==t)return"7"!=i&&"+"!=i?0:1;if("u"==t)return"v"==i?1:"\\"==i&&"/"==e||"\\"==i&&"|"==e||"|"==i&&"/"==e?2:0;if("v"==t)return"\\"==i&&"/"==e||"\\"==i&&"|"==e||"|"==i&&"/"==e?2:0;if("w"==t)return"v"==i&&"v"==e?2:0;if("x"==t)return")"==i&&"("==e||"}"==i&&"{"==e||"]"==i&&"["==e||">"==i&&"<"==e?2:0;if("y"==t)return 0;if("z"==t)return 0}return t>="0"&&t<="9"?"0"==t?"o"==i||"O"==i?1:"("==i&&")"==e||"{"==i&&"}"==e||"["==i&&"]"==e?2:0:"1"==t&&"l"==i?1:0:","==t?"."==i?1:0:"."==t?","==i?1:0:"!"==t&&"i"==i?1:0}comboMatches(e,t,i){let n=0,r=t.length-1;for(;n<=r;){const a=(n+r)/2|0;if(t[a][0]===e&&t[a][1]===i)return!0;e<t[a][0]||e===t[a][0]&&i<t[a][1]?r=a-1:n=a+1}return!1}getIndex(e){return WordEnc2.isLowercaseAlpha(e)?e.charCodeAt(0)+1-"a".charCodeAt(0):"'"==e?28:WordEnc2.isNumerical(e)?e.charCodeAt(0)+29-"0".charCodeAt(0):27}}class WordEncDomains{wordEncBadWords;domains=[];constructor(e){this.wordEncBadWords=e}filter(e){const t=[...e],i=[...e];this.wordEncBadWords.filterBadCombinations(null,t,WordEnc2.AMPERSAT),this.wordEncBadWords.filterBadCombinations(null,i,WordEnc2.PERIOD);for(let n=this.domains.length-1;n>=0;n--)this.filterDomain(i,t,this.domains[n],e)}getEmulatedDomainCharLen(e,t,i){return t==i||"o"==t&&"0"==i?1:"o"==t&&"("==i&&")"==e?2:"c"!=t||"("!=i&&"<"!=i&&"["!=i?"e"==t&&"â¬"==i||"s"==t&&"$"==i||"l"==t&&"i"==i?1:0:1}filterDomain(e,t,i,n){const r=i.length,a=n.length;for(let s=0;s<=a-r;s++){const{matched:r,currentIndex:a}=this.findMatchingDomain(s,i,n);if(!r)continue;const o=WordEnc2.prefixSymbolStatus(s,n,3,t,["@"]),c=WordEnc2.suffixSymbolStatus(a-1,n,3,e,[".",","]);(o>2||c>2)&&WordEnc2.maskChars(s,a,n)}}findMatchingDomain(e,t,i){const n=t.length;let r=e,a=0;for(;r<i.length&&a<n;){const s=i[r],o=r+1<i.length?i[r+1]:"\0",c=this.getEmulatedDomainCharLen(o,String.fromCharCode(t[a]),s);if(c>0)r+=c,a++;else{if(0===a)break;const i=this.getEmulatedDomainCharLen(o,String.fromCharCode(t[a-1]),s);if(i>0)r+=i,1===a&&e++;else{if(a>=n||!WordEnc2.isSymbol(s))break;r++}}}return{matched:a>=n,currentIndex:r}}}class WordEncTlds{wordEncBadWords;wordEncDomains;tlds=[];tldTypes=[];constructor(e,t){this.wordEncBadWords=e,this.wordEncDomains=t}filter(e){const t=[...e],i=[...e];this.wordEncBadWords.filterBadCombinations(null,t,WordEnc2.PERIOD),this.wordEncBadWords.filterBadCombinations(null,i,WordEnc2.SLASH);for(let n=0;n<this.tlds.length;n++)this.filterTld(i,this.tldTypes[n],e,this.tlds[n],t)}filterTld(e,t,i,n,r){if(!(n.length>i.length))for(let a=0;a<=i.length-n.length;a++){const{currentIndex:s,tldIndex:o}=this.processTlds(i,n,a);if(o<n.length)continue;let c=!1;const l=WordEnc2.prefixSymbolStatus(a,i,3,r,[",","."]),d=WordEnc2.suffixSymbolStatus(s-1,i,5,e,["\\","/"]);if(1==t&&l>0&&d>0&&(c=!0),2==t&&(l>2&&d>0||l>0&&d>2)&&(c=!0),3==t&&l>0&&d>2&&(c=!0),!c)continue;let p,h=a,u=s-1,_=!1;if(l>2){if(4==l)for(_=!1,p=a-1;p>=0;p--)if(_){if("*"!=r[p])break;h=p}else"*"==r[p]&&(h=p,_=!0);for(_=!1,p=h-1;p>=0;p--)if(_){if(WordEnc2.isSymbol(i[p]))break;h=p}else WordEnc2.isSymbol(i[p])||(_=!0,h=p)}if(d>2){if(4==d)for(_=!1,p=u+1;p<i.length;p++)if(_){if("*"!=e[p])break;u=p}else"*"==e[p]&&(u=p,_=!0);for(_=!1,p=u+1;p<i.length;p++)if(_){if(WordEnc2.isSymbol(i[p]))break;u=p}else WordEnc2.isSymbol(i[p])||(_=!0,u=p)}WordEnc2.maskChars(h,u+1,i)}}processTlds(e,t,i){let n=0;for(;i<e.length&&n<t.length;){const r=e[i],a=i+1<e.length?e[i+1]:"\0";let s;if((s=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(t[n]),r))>0)i+=s,n++;else{if(0===n)break;let e;if((e=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(t[n-1]),r))>0)i+=e;else{if(!WordEnc2.isSymbol(r))break;i++}}}return{currentIndex:i,tldIndex:n}}}class WordEnc2{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((e=>e.charCodeAt(0))));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((e=>e.charCodeAt(0))));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((e=>e.charCodeAt(0))));static wordEncFragments=new WordEncFragments;static wordEncBadWords=new WordEncBadWords(this.wordEncFragments);static wordEncDomains=new WordEncDomains(this.wordEncBadWords);static wordEncTlds=new WordEncTlds(this.wordEncBadWords,this.wordEncDomains);static whitelist=["cook","cook's","cooks","seeks","sheet"];static async load(e){if(!(await fetch(`${e}/client/wordenc`)).ok)return void console.log("Warning: No wordenc found.");const t=await Jagfile.load(`${e}/client/wordenc`),i=t.read("fragmentsenc.txt");if(!i)return void console.log("Warning: No fragmentsenc found.");const n=t.read("badenc.txt");if(!n)return void console.log("Warning: No badenc found.");const r=t.read("domainenc.txt");if(!r)return void console.log("Warning: No domainenc found.");const a=t.read("tldlist.txt");a?(this.decodeBadEnc(n),this.decodeDomainEnc(r),this.decodeFragmentsEnc(i),this.decodeTldList(a)):console.log("Warning: No tldlist found.")}static filter(e){const t=[...e];this.format(t);const i=t.join("").trim(),n=i.toLowerCase(),r=[...n];this.wordEncTlds.filter(r),this.wordEncBadWords.filter(r),this.wordEncDomains.filter(r),this.wordEncFragments.filter(r);for(let e=0;e<this.whitelist.length;e++){let t=-1;for(;-1!==(t=n.indexOf(this.whitelist[e],t+1));){const i=[...this.whitelist[e]];for(let e=0;e<i.length;e++)r[e+t]=i[e]}}return this.replaceUppercases(r,[...i]),this.formatUppercases(r),r.join("").trim()}static isSymbol(e){return!this.isAlpha(e)&&!this.isNumerical(e)}static isNotLowercaseAlpha(e){return!this.isLowercaseAlpha(e)||("v"==e||"x"==e||"j"==e||"q"==e||"z"==e)}static isAlpha(e){return this.isLowercaseAlpha(e)||this.isUppercaseAlpha(e)}static isNumerical(e){return e>="0"&&e<="9"}static isLowercaseAlpha(e){return e>="a"&&e<="z"}static isUppercaseAlpha(e){return e>="A"&&e<="Z"}static isNumericalChars(e){for(let t=0;t<e.length;t++)if(!this.isNumerical(e[t])&&"\0"!==e[t])return!1;return!0}static maskChars(e,t,i){for(let n=e;n<t;n++)i[n]="*"}static maskedCountBackwards(e,t){let i=0;for(let n=t-1;n>=0&&WordEnc2.isSymbol(e[n]);n--)"*"===e[n]&&i++;return i}static maskedCountForwards(e,t){let i=0;for(let n=t+1;n<e.length&&this.isSymbol(e[n]);n++)"*"===e[n]&&i++;return i}static maskedCharsStatus(e,t,i,n,r){return(r?this.maskedCountBackwards(t,i):this.maskedCountForwards(t,i))>=n?4:this.isSymbol(r?e[i-1]:e[i+1])?1:0}static prefixSymbolStatus(e,t,i,n,r){if(0===e)return 2;for(let i=e-1;i>=0&&WordEnc2.isSymbol(t[i]);i--)if(r.includes(t[i]))return 3;return WordEnc2.maskedCharsStatus(t,n,e,i,!0)}static suffixSymbolStatus(e,t,i,n,r){if(e+1===t.length)return 2;for(let i=e+1;i<t.length&&WordEnc2.isSymbol(t[i]);i++)if(r.includes(t[i]))return 3;return WordEnc2.maskedCharsStatus(t,n,e,i,!1)}static decodeTldList(e){const t=e.g4();for(let i=0;i<t;i++)this.wordEncTlds.tldTypes[i]=e.g1(),this.wordEncTlds.tlds[i]=new Uint16Array(e.g1()).map((()=>e.g1()))}static decodeBadEnc(e){const t=e.g4();for(let i=0;i<t;i++){this.wordEncBadWords.bads[i]=new Uint16Array(e.g1()).map((()=>e.g1()));const t=new Array(e.g1()).fill([]).map((()=>[e.g1b(),e.g1b()]));t.length>0&&(this.wordEncBadWords.badCombinations[i]=t)}}static decodeDomainEnc(e){const t=e.g4();for(let i=0;i<t;i++)this.wordEncDomains.domains[i]=new Uint16Array(e.g1()).map((()=>e.g1()))}static decodeFragmentsEnc(e){const t=e.g4();for(let i=0;i<t;i++)this.wordEncFragments.fragments[i]=e.g2()}static format(e){let t=0;for(let i=0;i<e.length;i++)this.isCharacterAllowed(e[i])?e[t]=e[i]:e[t]=" ",0!==t&&" "===e[t]&&" "===e[t-1]||t++;for(let i=t;i<e.length;i++)e[i]=" "}static isCharacterAllowed(e){return e>=" "&&e<=""||" "==e||"\n"==e||"\t"==e||"Â£"==e||"â¬"==e}static replaceUppercases(e,t){for(let i=0;i<t.length;i++)"*"!==e[i]&&this.isUppercaseAlpha(t[i])&&(e[i]=t[i])}static formatUppercases(e){let t=!0;for(let i=0;i<e.length;i++){const n=e[i];this.isAlpha(n)?t?this.isLowercaseAlpha(n)&&(t=!1):this.isUppercaseAlpha(n)&&(e[i]=String.fromCharCode(n.charCodeAt(0)+"a".charCodeAt(0)-65)):t=!0}}}class SpotanimType extends ConfigType{static configNames=new Map;static configs=[];static async load(e){if(SpotanimType.configNames=new Map,SpotanimType.configs=[],!(await fetch(`${e}/server/spotanim.dat`)).ok)return void console.log("Warning: No spotanim.dat found.");const t=await Packet.load(`${e}/server/spotanim.dat`),i=t.g2(),n=(await Jagfile.load(`${e}/client/config`)).read("spotanim.dat");n.pos=2;for(let e=0;e<i;e++){const i=new SpotanimType(e);i.decodeType(t),i.decodeType(n),SpotanimType.configs[e]=i,i.debugname&&SpotanimType.configNames.set(i.debugname,e)}}static get(e){return SpotanimType.configs[e]}static getId(e){return SpotanimType.configNames.get(e)??-1}static getByName(e){const t=this.getId(e);return-1===t?null:this.get(t)}static get count(){return this.configs.length}model=0;anim=-1;hasalpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(e,t){if(1===e)this.model=t.g2();else if(2===e)this.anim=t.g2();else if(3===e)this.hasalpha=!0;else if(4===e)this.resizeh=t.g2();else if(5===e)this.resizev=t.g2();else if(6===e)this.orientation=t.g2();else if(7===e)this.ambient=t.g1();else if(8===e)this.contrast=t.g1();else if(e>=40&&e<50)this.recol_s[e-40]=t.g2();else if(e>=50&&e<60)this.recol_d[e-50]=t.g2();else{if(250!==e)throw new Error(`Unrecognized spotanim config code: ${e}`);this.debugname=t.gjstr()}}}function checkedHandler(e,t){return function(i){"number"==typeof e?i.pointerCheck(e):i.pointerCheck(e[i.intOperand]),t(i)}}(e=>{e[e.ActivePlayer=0]="ActivePlayer",e[e.ActivePlayer2=1]="ActivePlayer2",e[e.ProtectedActivePlayer=2]="ProtectedActivePlayer",e[e.ProtectedActivePlayer2=3]="ProtectedActivePlayer2",e[e.ActiveNpc=4]="ActiveNpc",e[e.ActiveNpc2=5]="ActiveNpc2",e[e.ActiveLoc=6]="ActiveLoc",e[e.ActiveLoc2=7]="ActiveLoc2",e[e.ActiveObj=8]="ActiveObj",e[e.ActiveObj2=9]="ActiveObj2",e[e._LAST=10]="_LAST"})(ScriptPointer||={});var ActiveNpc=[4,5],ActiveLoc=[6,7],ActiveObj=[8,9],ActivePlayer=[0,1],ProtectedActivePlayer=[2,3],ScriptPointer_default=ScriptPointer,L=Object.create,b=Object.defineProperty,z=Object.getOwnPropertyDescriptor,D=Object.getOwnPropertyNames,T=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty,_=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),E=(e,t)=>{for(var i in t)b(e,i,{get:t[i],enumerable:!0})},C=(e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of D(t))!R.call(e,r)&&r!==i&&b(e,r,{get:()=>t[r],enumerable:!(n=z(t,r))||n.enumerable});return e},A=(e,t,i)=>(C(e,t,"default"),i&&C(i,t,"default")),y=(e,t,i)=>(i=null!=e?L(T(e)):{},C(!t&&e&&e.__esModule?i:b(i,"default",{value:e,enumerable:!0}),e)),h=_(((e,t)=>{function i(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function n(e,t){for(var i,n="",r=0,a=-1,s=0,o=0;o<=e.length;++o){if(o<e.length)i=e.charCodeAt(o);else{if(47===i)break;i=47}if(47===i){if(a!==o-1&&1!==s)if(a!==o-1&&2===s){if(n.length<2||2!==r||46!==n.charCodeAt(n.length-1)||46!==n.charCodeAt(n.length-2))if(n.length>2){var c=n.lastIndexOf("/");if(c!==n.length-1){-1===c?(n="",r=0):r=(n=n.slice(0,c)).length-1-n.lastIndexOf("/"),a=o,s=0;continue}}else if(2===n.length||1===n.length){n="",r=0,a=o,s=0;continue}t&&(n.length>0?n+="/..":n="..",r=2)}else n.length>0?n+="/"+e.slice(a+1,o):n=e.slice(a+1,o),r=o-a-1;a=o,s=0}else 46===i&&-1!==s?++s:s=-1}return n}var r={resolve:function(){for(var e,t="",r=!1,a=arguments.length-1;a>=-1&&!r;a--){var s;a>=0?s=arguments[a]:(void 0===e&&(e=process.cwd()),s=e),i(s),0!==s.length&&(t=s+"/"+t,r=47===s.charCodeAt(0))}return t=n(t,!r),r?t.length>0?"/"+t:"/":t.length>0?t:"."},normalize:function(e){if(i(e),0===e.length)return".";var t=47===e.charCodeAt(0),r=47===e.charCodeAt(e.length-1);return 0===(e=n(e,!t)).length&&!t&&(e="."),e.length>0&&r&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return i(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,t=0;t<arguments.length;++t){var n=arguments[t];i(n),n.length>0&&(void 0===e?e=n:e+="/"+n)}return void 0===e?".":r.normalize(e)},relative:function(e,t){if(i(e),i(t),e===t||(e=r.resolve(e))===(t=r.resolve(t)))return"";for(var n=1;n<e.length&&47===e.charCodeAt(n);++n);for(var a=e.length,s=a-n,o=1;o<t.length&&47===t.charCodeAt(o);++o);for(var c=t.length-o,l=s<c?s:c,d=-1,p=0;p<=l;++p){if(p===l){if(c>l){if(47===t.charCodeAt(o+p))return t.slice(o+p+1);if(0===p)return t.slice(o+p)}else s>l&&(47===e.charCodeAt(n+p)?d=p:0===p&&(d=0));break}var h=e.charCodeAt(n+p);if(h!==t.charCodeAt(o+p))break;47===h&&(d=p)}var u="";for(p=n+d+1;p<=a;++p)(p===a||47===e.charCodeAt(p))&&(0===u.length?u+="..":u+="/..");return u.length>0?u+t.slice(o+d):(o+=d,47===t.charCodeAt(o)&&++o,t.slice(o))},_makeLong:function(e){return e},dirname:function(e){if(i(e),0===e.length)return".";for(var t=e.charCodeAt(0),n=47===t,r=-1,a=!0,s=e.length-1;s>=1;--s)if(47===(t=e.charCodeAt(s))){if(!a){r=s;break}}else a=!1;return-1===r?n?"/":".":n&&1===r?"//":e.slice(0,r)},basename:function(e,t){if(void 0!==t&&"string"!=typeof t)throw new TypeError('"ext" argument must be a string');i(e);var n,r=0,a=-1,s=!0;if(void 0!==t&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var o=t.length-1,c=-1;for(n=e.length-1;n>=0;--n){var l=e.charCodeAt(n);if(47===l){if(!s){r=n+1;break}}else-1===c&&(s=!1,c=n+1),o>=0&&(l===t.charCodeAt(o)?-1==--o&&(a=n):(o=-1,a=c))}return r===a?a=c:-1===a&&(a=e.length),e.slice(r,a)}for(n=e.length-1;n>=0;--n)if(47===e.charCodeAt(n)){if(!s){r=n+1;break}}else-1===a&&(s=!1,a=n+1);return-1===a?"":e.slice(r,a)},extname:function(e){i(e);for(var t=-1,n=0,r=-1,a=!0,s=0,o=e.length-1;o>=0;--o){var c=e.charCodeAt(o);if(47!==c)-1===r&&(a=!1,r=o+1),46===c?-1===t?t=o:1!==s&&(s=1):-1!==t&&(s=-1);else if(!a){n=o+1;break}}return-1===t||-1===r||0===s||1===s&&t===r-1&&t===n+1?"":e.slice(t,r)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var i=t.dir||t.root,n=t.base||(t.name||"")+(t.ext||"");return i?i===t.root?i+n:i+e+n:n}("/",e)},parse:function(e){i(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return t;var n,r=e.charCodeAt(0),a=47===r;a?(t.root="/",n=1):n=0;for(var s=-1,o=0,c=-1,l=!0,d=e.length-1,p=0;d>=n;--d)if(47!==(r=e.charCodeAt(d)))-1===c&&(l=!1,c=d+1),46===r?-1===s?s=d:1!==p&&(p=1):-1!==s&&(p=-1);else if(!l){o=d+1;break}return-1===s||-1===c||0===p||1===p&&s===c-1&&s===o+1?-1!==c&&(t.base=t.name=0===o&&a?e.slice(1,c):e.slice(o,c)):(0===o&&a?(t.name=e.slice(1,s),t.base=e.slice(1,c)):(t.name=e.slice(o,s),t.base=e.slice(o,c)),t.ext=e.slice(s,c)),o>0?t.dir=e.slice(0,o-1):a&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};r.posix=r,t.exports=r})),m={};E(m,{default:()=>q}),A(m,y(h()));var ScriptOpcode,q=y(h());(e=>{e[e.PUSH_CONSTANT_INT=0]="PUSH_CONSTANT_INT",e[e.PUSH_VARP=1]="PUSH_VARP",e[e.POP_VARP=2]="POP_VARP",e[e.PUSH_CONSTANT_STRING=3]="PUSH_CONSTANT_STRING",e[e.PUSH_VARN=4]="PUSH_VARN",e[e.POP_VARN=5]="POP_VARN",e[e.BRANCH=6]="BRANCH",e[e.BRANCH_NOT=7]="BRANCH_NOT",e[e.BRANCH_EQUALS=8]="BRANCH_EQUALS",e[e.BRANCH_LESS_THAN=9]="BRANCH_LESS_THAN",e[e.BRANCH_GREATER_THAN=10]="BRANCH_GREATER_THAN",e[e.PUSH_VARS=11]="PUSH_VARS",e[e.POP_VARS=12]="POP_VARS",e[e.RETURN=21]="RETURN",e[e.GOSUB=22]="GOSUB",e[e.JUMP=23]="JUMP",e[e.SWITCH=24]="SWITCH",e[e.BRANCH_LESS_THAN_OR_EQUALS=31]="BRANCH_LESS_THAN_OR_EQUALS",e[e.BRANCH_GREATER_THAN_OR_EQUALS=32]="BRANCH_GREATER_THAN_OR_EQUALS",e[e.PUSH_INT_LOCAL=33]="PUSH_INT_LOCAL",e[e.POP_INT_LOCAL=34]="POP_INT_LOCAL",e[e.PUSH_STRING_LOCAL=35]="PUSH_STRING_LOCAL",e[e.POP_STRING_LOCAL=36]="POP_STRING_LOCAL",e[e.JOIN_STRING=37]="JOIN_STRING",e[e.POP_INT_DISCARD=38]="POP_INT_DISCARD",e[e.POP_STRING_DISCARD=39]="POP_STRING_DISCARD",e[e.GOSUB_WITH_PARAMS=40]="GOSUB_WITH_PARAMS",e[e.JUMP_WITH_PARAMS=41]="JUMP_WITH_PARAMS",e[e.DEFINE_ARRAY=44]="DEFINE_ARRAY",e[e.PUSH_ARRAY_INT=45]="PUSH_ARRAY_INT",e[e.POP_ARRAY_INT=46]="POP_ARRAY_INT",e[e.COORDX=1e3]="COORDX",e[e.COORDY=1001]="COORDY",e[e.COORDZ=1002]="COORDZ",e[e.DISTANCE=1003]="DISTANCE",e[e.HUNTALL=1004]="HUNTALL",e[e.HUNTNEXT=1005]="HUNTNEXT",e[e.INZONE=1006]="INZONE",e[e.LINEOFSIGHT=1007]="LINEOFSIGHT",e[e.LINEOFWALK=1008]="LINEOFWALK",e[e.MAP_BLOCKED=1009]="MAP_BLOCKED",e[e.MAP_INDOORS=1010]="MAP_INDOORS",e[e.MAP_CLOCK=1011]="MAP_CLOCK",e[e.MAP_LOCADDUNSAFE=1012]="MAP_LOCADDUNSAFE",e[e.MAP_MEMBERS=1013]="MAP_MEMBERS",e[e.MAP_PLAYERCOUNT=1014]="MAP_PLAYERCOUNT",e[e.MOVECOORD=1015]="MOVECOORD",e[e.PLAYERCOUNT=1016]="PLAYERCOUNT",e[e.PROJANIM_MAP=1017]="PROJANIM_MAP",e[e.PROJANIM_NPC=1018]="PROJANIM_NPC",e[e.PROJANIM_PL=1019]="PROJANIM_PL",e[e.SEQLENGTH=1020]="SEQLENGTH",e[e.SPLIT_GET=1021]="SPLIT_GET",e[e.SPLIT_GETANIM=1022]="SPLIT_GETANIM",e[e.SPLIT_INIT=1023]="SPLIT_INIT",e[e.SPLIT_LINECOUNT=1024]="SPLIT_LINECOUNT",e[e.SPLIT_PAGECOUNT=1025]="SPLIT_PAGECOUNT",e[e.SPOTANIM_MAP=1026]="SPOTANIM_MAP",e[e.STAT_RANDOM=1027]="STAT_RANDOM",e[e.STRUCT_PARAM=1028]="STRUCT_PARAM",e[e.WORLD_DELAY=1029]="WORLD_DELAY",e[e.NPCCOUNT=1030]="NPCCOUNT",e[e.ZONECOUNT=1031]="ZONECOUNT",e[e.LOCCOUNT=1032]="LOCCOUNT",e[e.OBJCOUNT=1033]="OBJCOUNT",e[e.ALLOWDESIGN=2e3]="ALLOWDESIGN",e[e.ANIM=2001]="ANIM",e[e.BAS_READYANIM=2002]="BAS_READYANIM",e[e.BAS_RUNNING=2003]="BAS_RUNNING",e[e.BAS_TURNONSPOT=2004]="BAS_TURNONSPOT",e[e.BAS_WALK_B=2005]="BAS_WALK_B",e[e.BAS_WALK_F=2006]="BAS_WALK_F",e[e.BAS_WALK_L=2007]="BAS_WALK_L",e[e.BAS_WALK_R=2008]="BAS_WALK_R",e[e.BUFFER_FULL=2009]="BUFFER_FULL",e[e.BUILDAPPEARANCE=2010]="BUILDAPPEARANCE",e[e.BUSY=2011]="BUSY",e[e.CAM_LOOKAT=2012]="CAM_LOOKAT",e[e.CAM_MOVETO=2013]="CAM_MOVETO",e[e.CAM_RESET=2014]="CAM_RESET",e[e.CAM_SHAKE=2015]="CAM_SHAKE",e[e.CLEARQUEUE=2016]="CLEARQUEUE",e[e.CLEARSOFTTIMER=2017]="CLEARSOFTTIMER",e[e.CLEARTIMER=2018]="CLEARTIMER",e[e.COORD=2019]="COORD",e[e.DAMAGE=2020]="DAMAGE",e[e.DISPLAYNAME=2021]="DISPLAYNAME",e[e.FACESQUARE=2022]="FACESQUARE",e[e.FINDUID=2023]="FINDUID",e[e.GENDER=2024]="GENDER",e[e.GETQUEUE=2025]="GETQUEUE",e[e.GIVEXP=2026]="GIVEXP",e[e.HEADICONS_GET=2027]="HEADICONS_GET",e[e.HEADICONS_SET=2028]="HEADICONS_SET",e[e.HEALENERGY=2029]="HEALENERGY",e[e.HINT_COORD=2030]="HINT_COORD",e[e.HINT_NPC=2031]="HINT_NPC",e[e.HINT_PLAYER=2032]="HINT_PLAYER",e[e.HINT_STOP=2033]="HINT_STOP",e[e.IF_CLOSE=2034]="IF_CLOSE",e[e.IF_CLOSESTICKY=2035]="IF_CLOSESTICKY",e[e.IF_MULTIZONE=2036]="IF_MULTIZONE",e[e.IF_OPENCHAT=2037]="IF_OPENCHAT",e[e.IF_OPENCHATSTICKY=2038]="IF_OPENCHATSTICKY",e[e.IF_OPENMAINMODAL=2039]="IF_OPENMAINMODAL",e[e.IF_OPENMAINMODALSIDEOVERLAY=2040]="IF_OPENMAINMODALSIDEOVERLAY",e[e.IF_OPENSIDEOVERLAY=2041]="IF_OPENSIDEOVERLAY",e[e.IF_SETANIM=2042]="IF_SETANIM",e[e.IF_SETCOLOUR=2043]="IF_SETCOLOUR",e[e.IF_SETHIDE=2044]="IF_SETHIDE",e[e.IF_SETMODEL=2045]="IF_SETMODEL",e[e.IF_SETRECOL=2046]="IF_SETRECOL",e[e.IF_SETNPCHEAD=2047]="IF_SETNPCHEAD",e[e.IF_SETOBJECT=2048]="IF_SETOBJECT",e[e.IF_SETPLAYERHEAD=2049]="IF_SETPLAYERHEAD",e[e.IF_SETPOSITION=2050]="IF_SETPOSITION",e[e.IF_SETRESUMEBUTTONS=2051]="IF_SETRESUMEBUTTONS",e[e.IF_SETTAB=2052]="IF_SETTAB",e[e.IF_SETTABACTIVE=2053]="IF_SETTABACTIVE",e[e.IF_SETTABFLASH=2054]="IF_SETTABFLASH",e[e.IF_SETTEXT=2055]="IF_SETTEXT",e[e.LAST_LOGIN_INFO=2056]="LAST_LOGIN_INFO",e[e.LAST_COM=2057]="LAST_COM",e[e.LAST_INT=2058]="LAST_INT",e[e.LAST_ITEM=2059]="LAST_ITEM",e[e.LAST_SLOT=2060]="LAST_SLOT",e[e.LAST_TARGETSLOT=2061]="LAST_TARGETSLOT",e[e.LAST_USEITEM=2062]="LAST_USEITEM",e[e.LAST_USESLOT=2063]="LAST_USESLOT",e[e.LONGQUEUE=2064]="LONGQUEUE",e[e.MES=2065]="MES",e[e.MIDI_JINGLE=2066]="MIDI_JINGLE",e[e.MIDI_SONG=2067]="MIDI_SONG",e[e.NAME=2068]="NAME",e[e.P_APRANGE=2069]="P_APRANGE",e[e.P_ARRIVEDELAY=2070]="P_ARRIVEDELAY",e[e.P_COUNTDIALOG=2071]="P_COUNTDIALOG",e[e.P_DELAY=2072]="P_DELAY",e[e.P_EXACTMOVE=2073]="P_EXACTMOVE",e[e.P_FINDUID=2074]="P_FINDUID",e[e.P_LOCMERGE=2075]="P_LOCMERGE",e[e.P_LOGOUT=2076]="P_LOGOUT",e[e.P_OPHELD=2077]="P_OPHELD",e[e.P_OPLOC=2078]="P_OPLOC",e[e.P_OPNPC=2079]="P_OPNPC",e[e.P_OPNPCT=2080]="P_OPNPCT",e[e.P_OPOBJ=2081]="P_OPOBJ",e[e.P_OPPLAYER=2082]="P_OPPLAYER",e[e.P_OPPLAYERT=2083]="P_OPPLAYERT",e[e.P_PAUSEBUTTON=2084]="P_PAUSEBUTTON",e[e.P_STOPACTION=2085]="P_STOPACTION",e[e.P_TELEJUMP=2086]="P_TELEJUMP",e[e.P_TELEPORT=2087]="P_TELEPORT",e[e.P_WALK=2088]="P_WALK",e[e.PLAYER_FINDALLZONE=2089]="PLAYER_FINDALLZONE",e[e.PLAYER_FINDNEXT=2090]="PLAYER_FINDNEXT",e[e.QUEUE=2091]="QUEUE",e[e.SAY=2092]="SAY",e[e.WALKTRIGGER=2093]="WALKTRIGGER",e[e.SETTIMER=2094]="SETTIMER",e[e.SOFTTIMER=2095]="SOFTTIMER",e[e.SOUND_SYNTH=2096]="SOUND_SYNTH",e[e.SPOTANIM_PL=2097]="SPOTANIM_PL",e[e.STAFFMODLEVEL=2098]="STAFFMODLEVEL",e[e.STAT=2099]="STAT",e[e.STAT_ADD=2100]="STAT_ADD",e[e.STAT_BASE=2101]="STAT_BASE",e[e.STAT_HEAL=2102]="STAT_HEAL",e[e.STAT_SUB=2103]="STAT_SUB",e[e.STRONGQUEUE=2104]="STRONGQUEUE",e[e.UID=2105]="UID",e[e.WEAKQUEUE=2106]="WEAKQUEUE",e[e.IF_OPENMAINOVERLAY=2107]="IF_OPENMAINOVERLAY",e[e.AFK_EVENT=2108]="AFK_EVENT",e[e.LOWMEMORY=2109]="LOWMEMORY",e[e.SETIDKIT=2110]="SETIDKIT",e[e.P_CLEARPENDINGACTION=2111]="P_CLEARPENDINGACTION",e[e.GETWALKTRIGGER=2112]="GETWALKTRIGGER",e[e.BUSY2=2113]="BUSY2",e[e.FINDHERO=2114]="FINDHERO",e[e.BOTH_HEROPOINTS=2115]="BOTH_HEROPOINTS",e[e.SETGENDER=2116]="SETGENDER",e[e.SETSKINCOLOUR=2117]="SETSKINCOLOUR",e[e.P_ANIMPROTECT=2118]="P_ANIMPROTECT",e[e.NPC_ADD=2500]="NPC_ADD",e[e.NPC_ANIM=2501]="NPC_ANIM",e[e.NPC_BASESTAT=2502]="NPC_BASESTAT",e[e.NPC_CATEGORY=2503]="NPC_CATEGORY",e[e.NPC_CHANGETYPE=2504]="NPC_CHANGETYPE",e[e.NPC_COORD=2505]="NPC_COORD",e[e.NPC_DAMAGE=2506]="NPC_DAMAGE",e[e.NPC_DEL=2507]="NPC_DEL",e[e.NPC_DELAY=2508]="NPC_DELAY",e[e.NPC_FACESQUARE=2509]="NPC_FACESQUARE",e[e.NPC_FIND=2510]="NPC_FIND",e[e.NPC_FINDALLANY=2511]="NPC_FINDALLANY",e[e.NPC_FINDEXACT=2512]="NPC_FINDEXACT",e[e.NPC_FINDHERO=2513]="NPC_FINDHERO",e[e.NPC_FINDALLZONE=2514]="NPC_FINDALLZONE",e[e.NPC_FINDNEXT=2515]="NPC_FINDNEXT",e[e.NPC_FINDUID=2516]="NPC_FINDUID",e[e.NPC_GETMODE=2517]="NPC_GETMODE",e[e.NPC_HEROPOINTS=2518]="NPC_HEROPOINTS",e[e.NPC_NAME=2519]="NPC_NAME",e[e.NPC_PARAM=2520]="NPC_PARAM",e[e.NPC_QUEUE=2521]="NPC_QUEUE",e[e.NPC_RANGE=2522]="NPC_RANGE",e[e.NPC_SAY=2523]="NPC_SAY",e[e.NPC_HUNTALL=2524]="NPC_HUNTALL",e[e.NPC_HUNTNEXT=2525]="NPC_HUNTNEXT",e[e.NPC_SETHUNT=2526]="NPC_SETHUNT",e[e.NPC_SETHUNTMODE=2527]="NPC_SETHUNTMODE",e[e.NPC_SETMODE=2528]="NPC_SETMODE",e[e.NPC_WALKTRIGGER=2529]="NPC_WALKTRIGGER",e[e.NPC_SETTIMER=2530]="NPC_SETTIMER",e[e.NPC_STAT=2531]="NPC_STAT",e[e.NPC_STATADD=2532]="NPC_STATADD",e[e.NPC_STATHEAL=2533]="NPC_STATHEAL",e[e.NPC_STATSUB=2534]="NPC_STATSUB",e[e.NPC_TELE=2535]="NPC_TELE",e[e.NPC_TYPE=2536]="NPC_TYPE",e[e.NPC_UID=2537]="NPC_UID",e[e.SPOTANIM_NPC=2538]="SPOTANIM_NPC",e[e.NPC_WALK=2539]="NPC_WALK",e[e.NPC_ATTACKRANGE=2540]="NPC_ATTACKRANGE",e[e.LOC_ADD=3e3]="LOC_ADD",e[e.LOC_ANGLE=3001]="LOC_ANGLE",e[e.LOC_ANIM=3002]="LOC_ANIM",e[e.LOC_CATEGORY=3003]="LOC_CATEGORY",e[e.LOC_CHANGE=3004]="LOC_CHANGE",e[e.LOC_COORD=3005]="LOC_COORD",e[e.LOC_DEL=3006]="LOC_DEL",e[e.LOC_FIND=3007]="LOC_FIND",e[e.LOC_FINDALLZONE=3008]="LOC_FINDALLZONE",e[e.LOC_FINDNEXT=3009]="LOC_FINDNEXT",e[e.LOC_NAME=3010]="LOC_NAME",e[e.LOC_PARAM=3011]="LOC_PARAM",e[e.LOC_SHAPE=3012]="LOC_SHAPE",e[e.LOC_TYPE=3013]="LOC_TYPE",e[e.OBJ_ADD=3500]="OBJ_ADD",e[e.OBJ_ADDALL=3501]="OBJ_ADDALL",e[e.OBJ_COORD=3502]="OBJ_COORD",e[e.OBJ_COUNT=3503]="OBJ_COUNT",e[e.OBJ_DEL=3504]="OBJ_DEL",e[e.OBJ_NAME=3505]="OBJ_NAME",e[e.OBJ_PARAM=3506]="OBJ_PARAM",e[e.OBJ_TAKEITEM=3507]="OBJ_TAKEITEM",e[e.OBJ_TYPE=3508]="OBJ_TYPE",e[e.NC_CATEGORY=4e3]="NC_CATEGORY",e[e.NC_DEBUGNAME=4001]="NC_DEBUGNAME",e[e.NC_DESC=4002]="NC_DESC",e[e.NC_NAME=4003]="NC_NAME",e[e.NC_OP=4004]="NC_OP",e[e.NC_PARAM=4005]="NC_PARAM",e[e.LC_CATEGORY=4100]="LC_CATEGORY",e[e.LC_DEBUGNAME=4101]="LC_DEBUGNAME",e[e.LC_DESC=4102]="LC_DESC",e[e.LC_NAME=4103]="LC_NAME",e[e.LC_OP=4104]="LC_OP",e[e.LC_PARAM=4105]="LC_PARAM",e[e.LC_WIDTH=4106]="LC_WIDTH",e[e.LC_LENGTH=4107]="LC_LENGTH",e[e.OC_CATEGORY=4200]="OC_CATEGORY",e[e.OC_CERT=4201]="OC_CERT",e[e.OC_COST=4202]="OC_COST",e[e.OC_DEBUGNAME=4203]="OC_DEBUGNAME",e[e.OC_DESC=4204]="OC_DESC",e[e.OC_IOP=4205]="OC_IOP",e[e.OC_MEMBERS=4206]="OC_MEMBERS",e[e.OC_NAME=4207]="OC_NAME",e[e.OC_OP=4208]="OC_OP",e[e.OC_PARAM=4209]="OC_PARAM",e[e.OC_STACKABLE=4210]="OC_STACKABLE",e[e.OC_TRADEABLE=4211]="OC_TRADEABLE",e[e.OC_UNCERT=4212]="OC_UNCERT",e[e.OC_WEARPOS2=4213]="OC_WEARPOS2",e[e.OC_WEARPOS3=4214]="OC_WEARPOS3",e[e.OC_WEARPOS=4215]="OC_WEARPOS",e[e.OC_WEIGHT=4216]="OC_WEIGHT",e[e.INV_ALLSTOCK=4300]="INV_ALLSTOCK",e[e.INV_SIZE=4301]="INV_SIZE",e[e.INV_STOCKBASE=4302]="INV_STOCKBASE",e[e.INV_ADD=4303]="INV_ADD",e[e.INV_CHANGESLOT=4304]="INV_CHANGESLOT",e[e.INV_CLEAR=4305]="INV_CLEAR",e[e.INV_DEL=4306]="INV_DEL",e[e.INV_DELSLOT=4307]="INV_DELSLOT",e[e.INV_DROPITEM=4308]="INV_DROPITEM",e[e.INV_DROPSLOT=4309]="INV_DROPSLOT",e[e.INV_FREESPACE=4310]="INV_FREESPACE",e[e.INV_GETNUM=4311]="INV_GETNUM",e[e.INV_GETOBJ=4312]="INV_GETOBJ",e[e.INV_ITEMSPACE=4313]="INV_ITEMSPACE",e[e.INV_ITEMSPACE2=4314]="INV_ITEMSPACE2",e[e.INV_MOVEFROMSLOT=4315]="INV_MOVEFROMSLOT",e[e.INV_MOVETOSLOT=4316]="INV_MOVETOSLOT",e[e.BOTH_MOVEINV=4317]="BOTH_MOVEINV",e[e.INV_MOVEITEM=4318]="INV_MOVEITEM",e[e.INV_MOVEITEM_CERT=4319]="INV_MOVEITEM_CERT",e[e.INV_MOVEITEM_UNCERT=4320]="INV_MOVEITEM_UNCERT",e[e.INV_SETSLOT=4321]="INV_SETSLOT",e[e.INV_TOTAL=4322]="INV_TOTAL",e[e.INV_TOTALCAT=4323]="INV_TOTALCAT",e[e.INV_TRANSMIT=4324]="INV_TRANSMIT",e[e.INVOTHER_TRANSMIT=4325]="INVOTHER_TRANSMIT",e[e.INV_STOPTRANSMIT=4326]="INV_STOPTRANSMIT",e[e.BOTH_DROPSLOT=4327]="BOTH_DROPSLOT",e[e.INV_DROPALL=4328]="INV_DROPALL",e[e.INV_TOTALPARAM=4329]="INV_TOTALPARAM",e[e.INV_TOTALPARAM_STACK=4330]="INV_TOTALPARAM_STACK",e[e.ENUM=4400]="ENUM",e[e.ENUM_GETOUTPUTCOUNT=4401]="ENUM_GETOUTPUTCOUNT",e[e.APPEND_NUM=4500]="APPEND_NUM",e[e.APPEND=4501]="APPEND",e[e.APPEND_SIGNNUM=4502]="APPEND_SIGNNUM",e[e.LOWERCASE=4503]="LOWERCASE",e[e.TEXT_GENDER=4504]="TEXT_GENDER",e[e.TOSTRING=4505]="TOSTRING",e[e.COMPARE=4506]="COMPARE",e[e.TEXT_SWITCH=4507]="TEXT_SWITCH",e[e.APPEND_CHAR=4508]="APPEND_CHAR",e[e.STRING_LENGTH=4509]="STRING_LENGTH",e[e.SUBSTRING=4510]="SUBSTRING",e[e.STRING_INDEXOF_CHAR=4511]="STRING_INDEXOF_CHAR",e[e.STRING_INDEXOF_STRING=4512]="STRING_INDEXOF_STRING",e[e.ADD=4600]="ADD",e[e.SUB=4601]="SUB",e[e.MULTIPLY=4602]="MULTIPLY",e[e.DIVIDE=4603]="DIVIDE",e[e.RANDOM=4604]="RANDOM",e[e.RANDOMINC=4605]="RANDOMINC",e[e.INTERPOLATE=4606]="INTERPOLATE",e[e.ADDPERCENT=4607]="ADDPERCENT",e[e.SETBIT=4608]="SETBIT",e[e.CLEARBIT=4609]="CLEARBIT",e[e.TESTBIT=4610]="TESTBIT",e[e.MODULO=4611]="MODULO",e[e.POW=4612]="POW",e[e.INVPOW=4613]="INVPOW",e[e.AND=4614]="AND",e[e.OR=4615]="OR",e[e.MIN=4616]="MIN",e[e.MAX=4617]="MAX",e[e.SCALE=4618]="SCALE",e[e.BITCOUNT=4619]="BITCOUNT",e[e.TOGGLEBIT=4620]="TOGGLEBIT",e[e.SETBIT_RANGE=4621]="SETBIT_RANGE",e[e.CLEARBIT_RANGE=4622]="CLEARBIT_RANGE",e[e.GETBIT_RANGE=4623]="GETBIT_RANGE",e[e.SETBIT_RANGE_TOINT=4624]="SETBIT_RANGE_TOINT",e[e.SIN_DEG=4625]="SIN_DEG",e[e.COS_DEG=4626]="COS_DEG",e[e.ATAN2_DEG=4627]="ATAN2_DEG",e[e.ABS=4628]="ABS",e[e.DB_FIND_WITH_COUNT=7500]="DB_FIND_WITH_COUNT",e[e.DB_FINDNEXT=7501]="DB_FINDNEXT",e[e.DB_GETFIELD=7502]="DB_GETFIELD",e[e.DB_GETFIELDCOUNT=7503]="DB_GETFIELDCOUNT",e[e.DB_LISTALL_WITH_COUNT=7504]="DB_LISTALL_WITH_COUNT",e[e.DB_GETROWTABLE=7505]="DB_GETROWTABLE",e[e.DB_FINDBYINDEX=7506]="DB_FINDBYINDEX",e[e.DB_FIND_REFINE_WITH_COUNT=7507]="DB_FIND_REFINE_WITH_COUNT",e[e.DB_FIND=7508]="DB_FIND",e[e.DB_FIND_REFINE=7509]="DB_FIND_REFINE",e[e.DB_LISTALL=7510]="DB_LISTALL",e[e.ERROR=1e4]="ERROR",e[e.MAP_LOCALDEV=10001]="MAP_LOCALDEV",e[e.MAP_LASTCLOCK=10002]="MAP_LASTCLOCK",e[e.MAP_LASTWORLD=10003]="MAP_LASTWORLD",e[e.MAP_LASTCLIENTIN=10004]="MAP_LASTCLIENTIN",e[e.MAP_LASTNPC=10005]="MAP_LASTNPC",e[e.MAP_LASTPLAYER=10006]="MAP_LASTPLAYER",e[e.MAP_LASTLOGOUT=10007]="MAP_LASTLOGOUT",e[e.MAP_LASTLOGIN=10008]="MAP_LASTLOGIN",e[e.MAP_LASTZONE=10009]="MAP_LASTZONE",e[e.MAP_LASTCLIENTOUT=10010]="MAP_LASTCLIENTOUT",e[e.MAP_LASTCLEANUP=10011]="MAP_LASTCLEANUP",e[e.MAP_LASTBANDWIDTHIN=10012]="MAP_LASTBANDWIDTHIN",e[e.MAP_LASTBANDWIDTHOUT=10013]="MAP_LASTBANDWIDTHOUT"})(ScriptOpcode||={});var ScriptOpcode_default=ScriptOpcode;class Script{info={scriptName:"<unknown>",sourceFilePath:"<unknown>",lookupKey:-1,parameterTypes:[],pcs:[],lines:[]};id;intLocalCount=0;stringLocalCount=0;intArgCount=0;stringArgCount=0;switchTables=[];opcodes=[];intOperands=[];stringOperands=[];static isLargeOperand(e){if(e>100)return!1;switch(e){case ScriptOpcode_default.RETURN:case ScriptOpcode_default.POP_INT_DISCARD:case ScriptOpcode_default.POP_STRING_DISCARD:case ScriptOpcode_default.GOSUB:case ScriptOpcode_default.JUMP:return!1}return!0}static decode(e,t){const i=t.data.length;if(i<16)throw new Error("Invalid script file (minimum length)");t.pos=i-2;const n=i-t.g2()-12-2;if(n<0||n>=i)throw new Error("Invalid script file (bad trailer pos)");t.pos=n;const r=new Script(e);t.g4();r.intLocalCount=t.g2(),r.stringLocalCount=t.g2(),r.intArgCount=t.g2(),r.stringArgCount=t.g2();const a=t.g1();for(let e=0;e<a;e++){const i=t.g2(),n=[];for(let e=0;e<i;e++){const e=t.g4(),i=t.g4();n[e]=i}r.switchTables[e]=n}t.pos=0,r.info.scriptName=t.gjstr(0),r.info.sourceFilePath=t.gjstr(0),r.info.lookupKey=t.g4();const s=t.g1();for(let e=0;e<s;e++)r.info.parameterTypes.push(t.g1());const o=t.g2();for(let e=0;e<o;e++)r.info.pcs.push(t.g4()),r.info.lines.push(t.g4());let c=0;for(;n>t.pos;){const e=t.g2();e===ScriptOpcode_default.PUSH_CONSTANT_STRING?r.stringOperands[c]=t.gjstr(0):Script.isLargeOperand(e)?r.intOperands[c]=t.g4():r.intOperands[c]=t.g1(),r.opcodes[c++]=e}return r}constructor(e){this.id=e}get name(){return this.info.scriptName}get fileName(){return q.basename(this.info.sourceFilePath)}lineNumber(e){for(let t=0;t<this.info.pcs.length;t++)if(this.info.pcs[t]>e)return this.info.lines[t-1];return this.info.lines[this.info.lines.length-1]}}class ScriptProvider{static COMPILER_VERSION=18;static scripts=[];static scriptLookup=new Map;static scriptNames=new Map;static async load(e){const t=await Packet.load(`${e}/server/script.dat`),i=await Packet.load(`${e}/server/script.idx`);t.data.length&&i.data.length||(console.log("\nFatal: No script.dat or script.idx found. Please run the server:build script."),process.exit(1));const n=t.g2();i.pos+=2;t.g4()!==ScriptProvider.COMPILER_VERSION&&(console.error("\nFatal: Scripts were compiled with an older RuneScript compiler. Please update it, try `npm run build` and then restart the server."),process.exit(1));const r=new Array(n),a=new Map,s=new Map;let o=0;for(let e=0;e<n;e++){const n=i.g2();if(0!==n)try{const i=new Uint8Array(n);t.gdata(i,0,i.length);const c=Script.decode(e,new Packet(i));r[e]=c,a.set(c.name,e),4294967295!==c.info.lookupKey&&s.set(c.info.lookupKey,c),o++}catch(t){return console.error(t),console.error(`Warning: Failed to load script ${e}, something may have been partially written`),-1}}return ScriptProvider.scripts=r,ScriptProvider.scriptNames=a,ScriptProvider.scriptLookup=s,o}static get(e){return this.scripts[e]}static getByName(e){const t=ScriptProvider.scriptNames.get(e);if(void 0!==t)return ScriptProvider.scripts[t]}static getByTrigger(e,t=-1,i=-1){let n=ScriptProvider.scriptLookup.get(512|e|t<<10);return n||(n=ScriptProvider.scriptLookup.get(256|e|i<<10),n||ScriptProvider.scriptLookup.get(e))}static getByTriggerSpecific(e,t=-1,i=-1){return-1!==t?ScriptProvider.scriptLookup.get(512|e|t<<10):-1!==i?ScriptProvider.scriptLookup.get(256|e|i<<10):ScriptProvider.scriptLookup.get(e)}}function toInt32(e){return 0|e}function bitcount(e){return 16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24}function setBitRange(e,t,i){return e|MASK[i-t+1]<<t}function clearBitRange(e,t,i){return e&~(MASK[i-t+1]<<t)}var initMaskArray=function(){const e=[0];let t=2;for(let i=1;i<33;++i)e[i]=toInt32(t-1),t+=t;return e},MASK=initMaskArray();class ScriptState{static ABORTED=-1;static RUNNING=0;static FINISHED=1;static SUSPENDED=2;static PAUSEBUTTON=3;static COUNTDIALOG=4;static NPC_SUSPENDED=5;static WORLD_SUSPENDED=6;script;trigger;execution=ScriptState.RUNNING;executionHistory=[];pc=-1;opcount=0;frames=[];fp=0;debugFrames=[];debugFp=0;intStack=[];isp=0;stringStack=[];ssp=0;intLocals=[];stringLocals=[];pointers=0;self=null;_activePlayer=null;_activePlayer2=null;_activeNpc=null;_activeNpc2=null;_activeLoc=null;_activeLoc2=null;_activeObj=null;_activeObj2=null;splitPages=[];splitMesanim=-1;dbTable=null;dbColumn=-1;dbRow=-1;dbRowQuery=[];huntIterator=null;npcIterator=null;locIterator=null;lastInt=0;constructor(e,t=[]){if(this.script=e,this.trigger=255&e.info.lookupKey,t)for(let e=0;e<t.length;e++){const i=t[e];"number"==typeof i?this.intLocals.push(i):this.stringLocals.push(i)}}pointerSet(...e){this.pointers=0;for(let t=0;t<e.length;t++)this.pointers|=1<<e[t]}pointerAdd(e){this.pointers|=1<<e}pointerRemove(e){this.pointers&=~(1<<e)}pointerGet(e){return!!(this.pointers&1<<e)}pointerCheck(...e){for(let t=0;t<e.length;t++){const i=1<<e[t];if((this.pointers&i)!=i)throw new Error(`Required pointer: ${ScriptState.pointerPrint(i)}, current: ${ScriptState.pointerPrint(this.pointers)}`)}}static pointerPrint(e){let t="";for(let i=0;i<ScriptPointer_default._LAST;i++)e&1<<i&&(t+=`${ScriptPointer_default[i]}, `);return t.substring(0,t.lastIndexOf(","))}get activePlayer(){const e=0===this.intOperand?this._activePlayer:this._activePlayer2;if(null===e)throw new Error("Attempt to access null active_player");return e}set activePlayer(e){0===this.intOperand?this._activePlayer=e:this._activePlayer2=e}get activeNpc(){const e=0===this.intOperand?this._activeNpc:this._activeNpc2;if(null===e)throw new Error("Attempt to access null active_npc");return e}set activeNpc(e){0===this.intOperand?this._activeNpc=e:this._activeNpc2=e}get activeLoc(){const e=0===this.intOperand?this._activeLoc:this._activeLoc2;if(null===e)throw new Error("Attempt to access null active_loc");return e}set activeLoc(e){0===this.intOperand?this._activeLoc=e:this._activeLoc2=e}get activeObj(){const e=0===this.intOperand?this._activeObj:this._activeObj2;if(null===e)throw new Error("Attempt to access null active_obj");return e}set activeObj(e){0===this.intOperand?this._activeObj=e:this._activeObj2=e}get intOperand(){return this.script.intOperands[this.pc]}get stringOperand(){return this.script.stringOperands[this.pc]}popInt(){const e=this.intStack[--this.isp];return e?toInt32(e):0}popInts(e){const t=Array(e);for(let i=e-1;i>=0;i--)t[i]=this.popInt();return t}pushInt(e){this.intStack[this.isp++]=toInt32(e)}popString(){return this.stringStack[--this.ssp]??""}popStrings(e){const t=Array(e);for(let i=e-1;i>=0;i--)t[i]=this.popString();return t}pushString(e){this.stringStack[this.ssp++]=e}reset(){this.pc=-1,this.frames=[],this.fp=0,this.intStack=[],this.isp=0,this.stringStack=[],this.ssp=0,this.intLocals=[],this.stringLocals=[],this.pointers=0}}class InventoryTransaction{requested=0;completed=0;items=[];constructor(e,t=0,i=[]){this.requested=e,this.completed=t,this.items=i}getLeftOver(){return this.requested-this.completed}hasSucceeded(){return this.completed==this.requested}hasFailed(){return!this.hasSucceeded()}revert(e){for(let t=0;t<this.items.length;t++){const i=this.items[t].item;e.remove(i.id,i.count,this.items[t].slot)}}}class Inventory{static STACK_LIMIT=2147483647;static NORMAL_STACK=0;static ALWAYS_STACK=1;static NEVER_STACK=2;static fromType(e){if(-1===e)throw new Error("Invalid inventory type");const t=InvType.get(e);let i=Inventory.NORMAL_STACK;t.stackall&&(i=Inventory.ALWAYS_STACK);const n=new Inventory(t.size,i);if(n.type=e,t.stockobj&&t.stockcount&&t.stockobj.length)for(let e=0;e<t.stockobj.length;e++)n.set(e,{id:t.stockobj[e],count:t.stockcount[e]});return n}stackType=Inventory.NORMAL_STACK;capacity=0;items=[];update=!1;type=-1;constructor(e,t=Inventory.NORMAL_STACK){this.capacity=e,this.stackType=t;for(let t=0;t<e;t++)this.items.push(null)}contains(e){return this.items.some((t=>t&&t.id==e))}hasAt(e,t){const i=this.items[e];return i&&i.id==t}get nextFreeSlot(){return this.items.indexOf(null,0)}get freeSlotCount(){return this.items.filter((e=>null==e)).length}get occupiedSlotCount(){return this.items.filter((e=>null!=e)).length}get isFull(){return this.occupiedSlotCount==this.capacity}get isEmpty(){return 0==this.occupiedSlotCount}get hasAny(){return this.items.some((e=>null!=e))}get hasSpace(){return-1!=this.nextFreeSlot}get itemsFiltered(){return this.items.filter((e=>null!=e))}getItemCount(e){let t=0;for(let i=0;i<this.capacity;i++){const n=this.items[i];n&&n.id==e&&(t+=n.count)}return Math.min(Inventory.STACK_LIMIT,t)}getItemIndex(e){return this.items.findIndex((t=>t&&t.id==e))}removeAll(){this.items.fill(null,0,this.capacity),this.update=!0}add(e,t=1,i=-1,n=!0,r=!1,a=!1){const s=ObjType.get(e),o=!0===InvType.get(this.type).stockobj?.includes(e),c=!r&&this.stackType!=Inventory.NEVER_STACK&&(s.stackable||this.stackType==Inventory.ALWAYS_STACK);let l=0;if(c&&(l=this.getItemCount(e)),l==Inventory.STACK_LIMIT)return new InventoryTransaction(t,0,[]);const d=this.freeSlotCount;if(0==d&&(!c||c&&0==l&&!o))return new InventoryTransaction(t,0,[]);if(n){if(c&&l>Inventory.STACK_LIMIT-t)return new InventoryTransaction(t,0,[]);if(!c&&t>d)return new InventoryTransaction(t,0,[])}else{if(c&&l==Inventory.STACK_LIMIT)return new InventoryTransaction(t,0,[]);if(!c&&0==d)return new InventoryTransaction(t,0,[])}let p=0;const h=[];if(c){let n=this.getItemIndex(e);if(-1==n&&(n=-1==i?this.nextFreeSlot:this.items.indexOf(null,i),-1==n))return new InventoryTransaction(t,p,[]);const r=this.get(n)?.count??0,s=Math.min(Inventory.STACK_LIMIT,r+t),o={id:e,count:s};a||this.set(n,o),h.push({slot:n,item:o}),p=s-r}else{for(let n=Math.max(0,i);n<this.capacity;n++){if(null!=this.items[n])continue;const i={id:e,count:1};if(a||this.set(n,i),h.push({slot:n,item:i}),++p>=t)break}}return new InventoryTransaction(t,p,h)}remove(e,t=1,i=-1,n=!1){const r=this.getItemCount(e),a=!0===InvType.get(this.type).stockobj?.includes(e);if(n&&r<t)return new InventoryTransaction(t,0,[]);if(!n&&r<1)return new InventoryTransaction(t,0,[]);let s=0;const o=[];let c=null;if(-1!=i){c=[];for(let e=0;e<i;e++)c.push(e)}let l=0;-1!=i&&(l=i);for(let i=l;i<this.capacity;i++){const n=this.items[i];if(!n||n.id!=e)continue;const r=Math.min(n.count,t-s);if(s+=r,n.count-=r,0==n.count&&!a){const e=this.items[i];this.items[i]=null,e&&o.push({slot:i,item:e})}if(s>=t)break}if(null!=c&&s<t)for(let i=0;i<c.length;i++){const n=this.items[i];if(!n||n.id!=e)continue;const r=Math.min(n.count,t-s);if(s+=r,n.count-=r,0==n.count&&!a){const e=this.items[i];this.items[i]=null,e&&o.push({slot:i,item:e})}if(s>=t)break}return s>0&&(this.update=!0),new InventoryTransaction(t,s,o)}delete(e){this.items[e]=null,this.update=!0}swap(e,t){const i=this.items[e];this.set(e,this.items[t]),this.set(t,i)}shift(){this.items=this.items.sort(((e,t)=>null===e||null===t?+(null===e)-+(null===t):+(e>t)||-(e<t))),this.update=!0}get(e){return this.items[e]}set(e,t){this.items[e]=t,this.update=!0}validSlot(e){return e>=0&&e<this.capacity}transfer(e,t,i=-1,n=-1,r=!1,a=!1){if(t.count<=0)return null;const s=Math.min(t.count,this.getItemCount(t.id)),o=ObjType.get(t.id);let c={id:t.id,count:s};(r&&-1!==o.certlink&&-1===o.certtemplate||a&&-1!==o.certlink&&o.certtemplate>=0)&&(c={id:o.certlink,count:s});const l=e.add(c.id,c.count,n,!1);if(0==l.completed)return null;const d=this.remove(t.id,l.completed,i,!1);return 0==d.completed?null:d}}async function instantiate2(e,t={}){const i={env:Object.assign(Object.create(globalThis),t.env||{},{abort(e,t,i,n){e=o(e>>>0),t=o(t>>>0),i>>>=0,n>>>=0,(()=>{throw Error(`${e} in ${t}:${i}:${n}`)})()},seed:()=>Date.now()*Math.random()})},{exports:n}=await WebAssembly.instantiate(e,i),r=n.memory||t.env.memory,a=Object.setPrototypeOf({findPath(e,t,i,r,a,s,o,l,p,h,u,_,g,f){return u=u?1:0,n.__setArgumentsLength(arguments.length),c(d,2,n.findPath(e,t,i,r,a,s,o,l,p,h,u,_,g,f)>>>0)},findNaivePath(e,t,i,r,a,s,o,l,p,h,u){return n.__setArgumentsLength(arguments.length),c(d,2,n.findNaivePath(e,t,i,r,a,s,o,l,p,h,u)>>>0)},changeFloor(e,t,i,r){r=r?1:0,n.changeFloor(e,t,i,r)},changeLoc(e,t,i,r,a,s,o,c){s=s?1:0,o=o?1:0,c=c?1:0,n.changeLoc(e,t,i,r,a,s,o,c)},changeNpc(e,t,i,r,a){a=a?1:0,n.changeNpc(e,t,i,r,a)},changePlayer(e,t,i,r,a){a=a?1:0,n.changePlayer(e,t,i,r,a)},changeRoof(e,t,i,r){r=r?1:0,n.changeRoof(e,t,i,r)},changeWall(e,t,i,r,a,s,o,c){s=s?1:0,o=o?1:0,c=c?1:0,n.changeWall(e,t,i,r,a,s,o,c)},allocateIfAbsent:(e,t,i)=>c(d,2,n.allocateIfAbsent(e,t,i)>>>0),isZoneAllocated:(e,t,i)=>0!=n.isZoneAllocated(e,t,i),isFlagged:(e,t,i,r)=>0!=n.isFlagged(e,t,i,r),canTravel(e,t,i,r,a,s,o,c){return n.__setArgumentsLength(arguments.length),0!=n.canTravel(e,t,i,r,a,s,o,c)},hasLineOfSight(e,t,i,r,a,s,o,c,l,d){return n.__setArgumentsLength(arguments.length),0!=n.hasLineOfSight(e,t,i,r,a,s,o,c,l,d)},hasLineOfWalk(e,t,i,r,a,s,o,c,l,d){return n.__setArgumentsLength(arguments.length),0!=n.hasLineOfWalk(e,t,i,r,a,s,o,c,l,d)},lineOfSight(e,t,i,r,a,s,o,l,p,h){return n.__setArgumentsLength(arguments.length),c(d,2,n.lineOfSight(e,t,i,r,a,s,o,l,p,h)>>>0)},lineOfWalk(e,t,i,r,a,s,o,l,p,h){return n.__setArgumentsLength(arguments.length),c(d,2,n.lineOfWalk(e,t,i,r,a,s,o,l,p,h)>>>0)},reached(e,t,i,r,a,s,o,c,l,d,p){return n.__setArgumentsLength(arguments.length),0!=n.reached(e,t,i,r,a,s,o,c,l,d,p)},__collides:(e,t,i,r,a,s,o,c)=>0!=n.__collides(e,t,i,r,a,s,o,c),__reachRectangle1:(e,t,i,r,a,s,o,c)=>0!=n.__reachRectangle1(e,t,i,r,a,s,o,c),__reachRectangleN:(e,t,i,r,a,s,o,c,l,d)=>0!=n.__reachRectangleN(e,t,i,r,a,s,o,c,l,d),__reachRectangle:(e,t,i,r,a,s,o,c,l,d)=>0!=n.__reachRectangle(e,t,i,r,a,s,o,c,l,d),__reachExclusiveRectangle:(e,t,i,r,a,s,o,c,l,d)=>0!=n.__reachExclusiveRectangle(e,t,i,r,a,s,o,c,l,d),CollisionFlag:(s={},s[s.NULL=n["CollisionFlag.NULL"].valueOf()]="NULL",s[s.OPEN=n["CollisionFlag.OPEN"].valueOf()]="OPEN",s[s.WALL_NORTH_WEST=n["CollisionFlag.WALL_NORTH_WEST"].valueOf()]="WALL_NORTH_WEST",s[s.WALL_NORTH=n["CollisionFlag.WALL_NORTH"].valueOf()]="WALL_NORTH",s[s.WALL_NORTH_EAST=n["CollisionFlag.WALL_NORTH_EAST"].valueOf()]="WALL_NORTH_EAST",s[s.WALL_EAST=n["CollisionFlag.WALL_EAST"].valueOf()]="WALL_EAST",s[s.WALL_SOUTH_EAST=n["CollisionFlag.WALL_SOUTH_EAST"].valueOf()]="WALL_SOUTH_EAST",s[s.WALL_SOUTH=n["CollisionFlag.WALL_SOUTH"].valueOf()]="WALL_SOUTH",s[s.WALL_SOUTH_WEST=n["CollisionFlag.WALL_SOUTH_WEST"].valueOf()]="WALL_SOUTH_WEST",s[s.WALL_WEST=n["CollisionFlag.WALL_WEST"].valueOf()]="WALL_WEST",s[s.LOC=n["CollisionFlag.LOC"].valueOf()]="LOC",s[s.WALL_NORTH_WEST_PROJ_BLOCKER=n["CollisionFlag.WALL_NORTH_WEST_PROJ_BLOCKER"].valueOf()]="WALL_NORTH_WEST_PROJ_BLOCKER",s[s.WALL_NORTH_PROJ_BLOCKER=n["CollisionFlag.WALL_NORTH_PROJ_BLOCKER"].valueOf()]="WALL_NORTH_PROJ_BLOCKER",s[s.WALL_NORTH_EAST_PROJ_BLOCKER=n["CollisionFlag.WALL_NORTH_EAST_PROJ_BLOCKER"].valueOf()]="WALL_NORTH_EAST_PROJ_BLOCKER",s[s.WALL_EAST_PROJ_BLOCKER=n["CollisionFlag.WALL_EAST_PROJ_BLOCKER"].valueOf()]="WALL_EAST_PROJ_BLOCKER",s[s.WALL_SOUTH_EAST_PROJ_BLOCKER=n["CollisionFlag.WALL_SOUTH_EAST_PROJ_BLOCKER"].valueOf()]="WALL_SOUTH_EAST_PROJ_BLOCKER",s[s.WALL_SOUTH_PROJ_BLOCKER=n["CollisionFlag.WALL_SOUTH_PROJ_BLOCKER"].valueOf()]="WALL_SOUTH_PROJ_BLOCKER",s[s.WALL_SOUTH_WEST_PROJ_BLOCKER=n["CollisionFlag.WALL_SOUTH_WEST_PROJ_BLOCKER"].valueOf()]="WALL_SOUTH_WEST_PROJ_BLOCKER",s[s.WALL_WEST_PROJ_BLOCKER=n["CollisionFlag.WALL_WEST_PROJ_BLOCKER"].valueOf()]="WALL_WEST_PROJ_BLOCKER",s[s.LOC_PROJ_BLOCKER=n["CollisionFlag.LOC_PROJ_BLOCKER"].valueOf()]="LOC_PROJ_BLOCKER",s[s.FLOOR_DECORATION=n["CollisionFlag.FLOOR_DECORATION"].valueOf()]="FLOOR_DECORATION",s[s.NPC=n["CollisionFlag.NPC"].valueOf()]="NPC",s[s.PLAYER=n["CollisionFlag.PLAYER"].valueOf()]="PLAYER",s[s.FLOOR=n["CollisionFlag.FLOOR"].valueOf()]="FLOOR",s[s.WALL_NORTH_WEST_ROUTE_BLOCKER=n["CollisionFlag.WALL_NORTH_WEST_ROUTE_BLOCKER"].valueOf()]="WALL_NORTH_WEST_ROUTE_BLOCKER",s[s.WALL_NORTH_ROUTE_BLOCKER=n["CollisionFlag.WALL_NORTH_ROUTE_BLOCKER"].valueOf()]="WALL_NORTH_ROUTE_BLOCKER",s[s.WALL_NORTH_EAST_ROUTE_BLOCKER=n["CollisionFlag.WALL_NORTH_EAST_ROUTE_BLOCKER"].valueOf()]="WALL_NORTH_EAST_ROUTE_BLOCKER",s[s.WALL_EAST_ROUTE_BLOCKER=n["CollisionFlag.WALL_EAST_ROUTE_BLOCKER"].valueOf()]="WALL_EAST_ROUTE_BLOCKER",s[s.WALL_SOUTH_EAST_ROUTE_BLOCKER=n["CollisionFlag.WALL_SOUTH_EAST_ROUTE_BLOCKER"].valueOf()]="WALL_SOUTH_EAST_ROUTE_BLOCKER",s[s.WALL_SOUTH_ROUTE_BLOCKER=n["CollisionFlag.WALL_SOUTH_ROUTE_BLOCKER"].valueOf()]="WALL_SOUTH_ROUTE_BLOCKER",s[s.WALL_SOUTH_WEST_ROUTE_BLOCKER=n["CollisionFlag.WALL_SOUTH_WEST_ROUTE_BLOCKER"].valueOf()]="WALL_SOUTH_WEST_ROUTE_BLOCKER",s[s.WALL_WEST_ROUTE_BLOCKER=n["CollisionFlag.WALL_WEST_ROUTE_BLOCKER"].valueOf()]="WALL_WEST_ROUTE_BLOCKER",s[s.LOC_ROUTE_BLOCKER=n["CollisionFlag.LOC_ROUTE_BLOCKER"].valueOf()]="LOC_ROUTE_BLOCKER",s[s.ROOF=n["CollisionFlag.ROOF"].valueOf()]="ROOF",s[s.FLOOR_BLOCKED=n["CollisionFlag.FLOOR_BLOCKED"].valueOf()]="FLOOR_BLOCKED",s[s.WALK_BLOCKED=n["CollisionFlag.WALK_BLOCKED"].valueOf()]="WALK_BLOCKED",s[s.BLOCK_WEST=n["CollisionFlag.BLOCK_WEST"].valueOf()]="BLOCK_WEST",s[s.BLOCK_EAST=n["CollisionFlag.BLOCK_EAST"].valueOf()]="BLOCK_EAST",s[s.BLOCK_SOUTH=n["CollisionFlag.BLOCK_SOUTH"].valueOf()]="BLOCK_SOUTH",s[s.BLOCK_NORTH=n["CollisionFlag.BLOCK_NORTH"].valueOf()]="BLOCK_NORTH",s[s.BLOCK_SOUTH_WEST=n["CollisionFlag.BLOCK_SOUTH_WEST"].valueOf()]="BLOCK_SOUTH_WEST",s[s.BLOCK_SOUTH_EAST=n["CollisionFlag.BLOCK_SOUTH_EAST"].valueOf()]="BLOCK_SOUTH_EAST",s[s.BLOCK_NORTH_WEST=n["CollisionFlag.BLOCK_NORTH_WEST"].valueOf()]="BLOCK_NORTH_WEST",s[s.BLOCK_NORTH_EAST=n["CollisionFlag.BLOCK_NORTH_EAST"].valueOf()]="BLOCK_NORTH_EAST",s[s.BLOCK_NORTH_AND_SOUTH_EAST=n["CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST"].valueOf()]="BLOCK_NORTH_AND_SOUTH_EAST",s[s.BLOCK_NORTH_AND_SOUTH_WEST=n["CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST"].valueOf()]="BLOCK_NORTH_AND_SOUTH_WEST",s[s.BLOCK_NORTH_EAST_AND_WEST=n["CollisionFlag.BLOCK_NORTH_EAST_AND_WEST"].valueOf()]="BLOCK_NORTH_EAST_AND_WEST",s[s.BLOCK_SOUTH_EAST_AND_WEST=n["CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST"].valueOf()]="BLOCK_SOUTH_EAST_AND_WEST",s[s.BLOCK_WEST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_WEST_ROUTE_BLOCKER"].valueOf()]="BLOCK_WEST_ROUTE_BLOCKER",s[s.BLOCK_EAST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_EAST_ROUTE_BLOCKER"].valueOf()]="BLOCK_EAST_ROUTE_BLOCKER",s[s.BLOCK_SOUTH_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_SOUTH_ROUTE_BLOCKER"].valueOf()]="BLOCK_SOUTH_ROUTE_BLOCKER",s[s.BLOCK_NORTH_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_NORTH_ROUTE_BLOCKER"].valueOf()]="BLOCK_NORTH_ROUTE_BLOCKER",s[s.BLOCK_SOUTH_WEST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_SOUTH_WEST_ROUTE_BLOCKER"].valueOf()]="BLOCK_SOUTH_WEST_ROUTE_BLOCKER",s[s.BLOCK_SOUTH_EAST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_SOUTH_EAST_ROUTE_BLOCKER"].valueOf()]="BLOCK_SOUTH_EAST_ROUTE_BLOCKER",s[s.BLOCK_NORTH_WEST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_NORTH_WEST_ROUTE_BLOCKER"].valueOf()]="BLOCK_NORTH_WEST_ROUTE_BLOCKER",s[s.BLOCK_NORTH_EAST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_NORTH_EAST_ROUTE_BLOCKER"].valueOf()]="BLOCK_NORTH_EAST_ROUTE_BLOCKER",s[s.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER"].valueOf()]="BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER",s[s.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER"].valueOf()]="BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER",s[s.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER"].valueOf()]="BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER",s[s.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER=n["CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER"].valueOf()]="BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER",s),LocShape:(e=>(e[e.WALL_STRAIGHT=n["LocShape.WALL_STRAIGHT"].valueOf()]="WALL_STRAIGHT",e[e.WALL_DIAGONAL_CORNER=n["LocShape.WALL_DIAGONAL_CORNER"].valueOf()]="WALL_DIAGONAL_CORNER",e[e.WALL_L=n["LocShape.WALL_L"].valueOf()]="WALL_L",e[e.WALL_SQUARE_CORNER=n["LocShape.WALL_SQUARE_CORNER"].valueOf()]="WALL_SQUARE_CORNER",e[e.WALLDECOR_STRAIGHT_NOOFFSET=n["LocShape.WALLDECOR_STRAIGHT_NOOFFSET"].valueOf()]="WALLDECOR_STRAIGHT_NOOFFSET",e[e.WALLDECOR_STRAIGHT_OFFSET=n["LocShape.WALLDECOR_STRAIGHT_OFFSET"].valueOf()]="WALLDECOR_STRAIGHT_OFFSET",e[e.WALLDECOR_DIAGONAL_OFFSET=n["LocShape.WALLDECOR_DIAGONAL_OFFSET"].valueOf()]="WALLDECOR_DIAGONAL_OFFSET",e[e.WALLDECOR_DIAGONAL_NOOFFSET=n["LocShape.WALLDECOR_DIAGONAL_NOOFFSET"].valueOf()]="WALLDECOR_DIAGONAL_NOOFFSET",e[e.WALLDECOR_DIAGONAL_BOTH=n["LocShape.WALLDECOR_DIAGONAL_BOTH"].valueOf()]="WALLDECOR_DIAGONAL_BOTH",e[e.WALL_DIAGONAL=n["LocShape.WALL_DIAGONAL"].valueOf()]="WALL_DIAGONAL",e[e.CENTREPIECE_STRAIGHT=n["LocShape.CENTREPIECE_STRAIGHT"].valueOf()]="CENTREPIECE_STRAIGHT",e[e.CENTREPIECE_DIAGONAL=n["LocShape.CENTREPIECE_DIAGONAL"].valueOf()]="CENTREPIECE_DIAGONAL",e[e.ROOF_STRAIGHT=n["LocShape.ROOF_STRAIGHT"].valueOf()]="ROOF_STRAIGHT",e[e.ROOF_DIAGONAL_WITH_ROOFEDGE=n["LocShape.ROOF_DIAGONAL_WITH_ROOFEDGE"].valueOf()]="ROOF_DIAGONAL_WITH_ROOFEDGE",e[e.ROOF_DIAGONAL=n["LocShape.ROOF_DIAGONAL"].valueOf()]="ROOF_DIAGONAL",e[e.ROOF_L_CONCAVE=n["LocShape.ROOF_L_CONCAVE"].valueOf()]="ROOF_L_CONCAVE",e[e.ROOF_L_CONVEX=n["LocShape.ROOF_L_CONVEX"].valueOf()]="ROOF_L_CONVEX",e[e.ROOF_FLAT=n["LocShape.ROOF_FLAT"].valueOf()]="ROOF_FLAT",e[e.ROOFEDGE_STRAIGHT=n["LocShape.ROOFEDGE_STRAIGHT"].valueOf()]="ROOFEDGE_STRAIGHT",e[e.ROOFEDGE_DIAGONAL_CORNER=n["LocShape.ROOFEDGE_DIAGONAL_CORNER"].valueOf()]="ROOFEDGE_DIAGONAL_CORNER",e[e.ROOFEDGE_L=n["LocShape.ROOFEDGE_L"].valueOf()]="ROOFEDGE_L",e[e.ROOFEDGE_SQUARE_CORNER=n["LocShape.ROOFEDGE_SQUARE_CORNER"].valueOf()]="ROOFEDGE_SQUARE_CORNER",e[e.GROUND_DECOR=n["LocShape.GROUND_DECOR"].valueOf()]="GROUND_DECOR",e))({}),LocAngle:(e=>(e[e.WEST=n["LocAngle.WEST"].valueOf()]="WEST",e[e.NORTH=n["LocAngle.NORTH"].valueOf()]="NORTH",e[e.EAST=n["LocAngle.EAST"].valueOf()]="EAST",e[e.SOUTH=n["LocAngle.SOUTH"].valueOf()]="SOUTH",e))({}),CollisionType:(e=>(e[e.NORMAL=n["CollisionType.NORMAL"].valueOf()]="NORMAL",e[e.BLOCKED=n["CollisionType.BLOCKED"].valueOf()]="BLOCKED",e[e.INDOORS=n["CollisionType.INDOORS"].valueOf()]="INDOORS",e[e.OUTDOORS=n["CollisionType.OUTDOORS"].valueOf()]="OUTDOORS",e[e.LINE_OF_SIGHT=n["CollisionType.LINE_OF_SIGHT"].valueOf()]="LINE_OF_SIGHT",e))({}),LocLayer:(e=>(e[e.WALL=n["LocLayer.WALL"].valueOf()]="WALL",e[e.WALL_DECOR=n["LocLayer.WALL_DECOR"].valueOf()]="WALL_DECOR",e[e.GROUND=n["LocLayer.GROUND"].valueOf()]="GROUND",e[e.GROUND_DECOR=n["LocLayer.GROUND_DECOR"].valueOf()]="GROUND_DECOR",e))({}),BlockAccessFlag:(e=>(e[e.BLOCK_NORTH=n["BlockAccessFlag.BLOCK_NORTH"].valueOf()]="BLOCK_NORTH",e[e.BLOCK_EAST=n["BlockAccessFlag.BLOCK_EAST"].valueOf()]="BLOCK_EAST",e[e.BLOCK_SOUTH=n["BlockAccessFlag.BLOCK_SOUTH"].valueOf()]="BLOCK_SOUTH",e[e.BLOCK_WEST=n["BlockAccessFlag.BLOCK_WEST"].valueOf()]="BLOCK_WEST",e))({})},n);var s;function o(e){if(!e)return null;const t=e+new Uint32Array(r.buffer)[e-4>>>2]>>>1,i=new Uint16Array(r.buffer);let n=e>>>1,a="";for(;t-n>1024;)a+=String.fromCharCode(...i.subarray(n,n+=1024));return a+String.fromCharCode(...i.subarray(n,t))}function c(e,t,i){if(!i)return null;const n=function(e){try{return l.getUint32(e,!0)}catch{return l=new DataView(r.buffer),l.getUint32(e,!0)}}(i-4)>>>t,a=new Array(n);for(let r=0;r<n;++r)a[r]=e(i+(r<<t>>>0));return a}let l=new DataView(r.buffer);function d(e){try{return l.getInt32(e,!0)}catch{return l=new DataView(r.buffer),l.getInt32(e,!0)}}return a}var HitType,{memory,findPath,findNaivePath,changeFloor,changeLoc,changeNpc,changePlayer,changeRoof,changeWall,allocateIfAbsent,deallocateIfPresent,isZoneAllocated,isFlagged,canTravel,hasLineOfSight,hasLineOfWalk,lineOfSight,lineOfWalk,reached,locShapeLayer,__get,__set,__add,__remove,__rotate,__rotateFlags,__collides,__reachRectangle1,__reachRectangleN,__alteredRotation,__reachRectangle,__reachExclusiveRectangle,CollisionFlag,LocShape,LocAngle,CollisionType,LocLayer,BlockAccessFlag}=await((async e=>instantiate2(await(async()=>{try{return await globalThis.WebAssembly.compileStreaming(globalThis.fetch(e))}catch{return globalThis.WebAssembly.compile(await(await import("node:fs/promises")).readFile(e))}})(),{})))(new URL("rsmod-pathfinder.wasm",import.meta.url)),Direction={NORTH_WEST:0,NORTH:1,NORTH_EAST:2,WEST:3,EAST:4,SOUTH_WEST:5,SOUTH:6,SOUTH_EAST:7},Position={zone:e=>e>>3,zoneCenter:e=>Position.zone(e)-6,zoneOrigin:e=>Position.zoneCenter(e)<<3,mapsquare:e=>e>>6,local:e=>e-(Position.zoneCenter(e)<<3),localOrigin:e=>e-(Position.mapsquare(e)<<6),zoneUpdate:e=>e-(e>>3<<3),face:(e,t,i,n)=>e!=i?e>i?t>n?Direction.SOUTH_WEST:t<n?Direction.NORTH_WEST:Direction.WEST:t>n?Direction.SOUTH_EAST:t<n?Direction.NORTH_EAST:Direction.EAST:t>n?Direction.SOUTH:t<n?Direction.NORTH:-1,moveX:(e,t)=>e+Position.deltaX(t),moveZ:(e,t)=>e+Position.deltaZ(t),distanceTo(e,t){const i=Position.closest(e,t),n=Position.closest(t,e);return Math.max(Math.abs(i.x-n.x),Math.abs(i.z-n.z))},closest(e,t){const i=e.x+e.width-1,n=e.z+e.length-1;return{x:t.x<=e.x?e.x:t.x>=i?i:t.x,z:t.z<=e.z?e.z:t.z>=n?n:t.z}},distanceToSW(e,t){const i=Math.abs(e.x-t.x),n=Math.abs(e.z-t.z);return Math.max(i,n)},isWithinDistanceSW(e,t,i){const n=Math.abs(e.x-t.x);return Math.abs(e.z-t.z)<i&&n<i},deltaX(e){switch(e){case Direction.SOUTH_EAST:case Direction.NORTH_EAST:case Direction.EAST:return 1;case Direction.SOUTH_WEST:case Direction.NORTH_WEST:case Direction.WEST:return-1}return 0},deltaZ(e){switch(e){case Direction.NORTH_WEST:case Direction.NORTH_EAST:case Direction.NORTH:return 1;case Direction.SOUTH_WEST:case Direction.SOUTH_EAST:case Direction.SOUTH:return-1}return 0},unpackCoord:e=>({level:e>>28&3,x:e>>14&16383,z:16383&e}),packCoord:(e,t,i)=>16383&i|(16383&t)<<14|(3&e)<<28,packZoneCoord:(e,t)=>(7&e)<<4|7&t,intersects:(e,t,i,n,r,a,s,o)=>!(r>=e+i||r+s<=e||a>=t+n||a+o<=t),formatString:(e,t,i,n="_")=>e+n+(t>>6)+n+(i>>6)+n+(63&t)+n+(63&i)};(e=>{e[e.BLOCK=0]="BLOCK",e[e.DAMAGE=1]="DAMAGE",e[e.POISON=2]="POISON"})(HitType||={});var PlayerStat,HitType_default=HitType;(e=>{e[e.ATTACK=0]="ATTACK",e[e.DEFENCE=1]="DEFENCE",e[e.STRENGTH=2]="STRENGTH",e[e.HITPOINTS=3]="HITPOINTS",e[e.RANGED=4]="RANGED",e[e.PRAYER=5]="PRAYER",e[e.MAGIC=6]="MAGIC",e[e.COOKING=7]="COOKING",e[e.WOODCUTTING=8]="WOODCUTTING",e[e.FLETCHING=9]="FLETCHING",e[e.FISHING=10]="FISHING",e[e.FIREMAKING=11]="FIREMAKING",e[e.CRAFTING=12]="CRAFTING",e[e.SMITHING=13]="SMITHING",e[e.MINING=14]="MINING",e[e.HERBLORE=15]="HERBLORE",e[e.AGILITY=16]="AGILITY",e[e.THIEVING=17]="THIEVING",e[e.STAT18=18]="STAT18",e[e.STAT19=19]="STAT19",e[e.RUNECRAFT=20]="RUNECRAFT"})(PlayerStat||={});var PlayerStat_default=PlayerStat;function check(e,t){return t.validate(e)}class ScriptInputNumberNotNullValidator{validate(e){if(-1!==e)return e;throw Error("An input number was null(-1).")}}class ScriptInputStringNotNullValidator{validate(e){if(e.length>0)return e;throw Error("An input string was null(-1).")}}class ScriptInputConfigTypeValidator{type;count;name;constructor(e,t,i){this.type=e,this.count=t,this.name=i}validate(e){if(this.count(e))return this.type(e);throw new Error(`An input for a ${this.name} type was not valid to use. Input was ${e}.`)}}class ScriptInputRangeValidator{min;max;name;constructor(e,t,i){this.min=e,this.max=t,this.name=i}validate(e){if(e>=this.min&&e<=this.max)return e;throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${e}.`)}}class ScriptInputCoordValidator extends ScriptInputRangeValidator{validate(e){if(e>=this.min&&e<=this.max)return Position.unpackCoord(e);throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${e}.`)}}var EntityLifeCycle,NumberNotNull=new ScriptInputNumberNotNullValidator,StringNotNull=new ScriptInputStringNotNullValidator,LocTypeValid=new ScriptInputConfigTypeValidator(LocType.get,(e=>e>=0&&e<LocType.count),"Loc"),LocAngleValid=new ScriptInputRangeValidator(LocAngle.WEST,LocAngle.SOUTH,"LocAngle"),LocShapeValid=new ScriptInputRangeValidator(LocShape.WALL_STRAIGHT,LocShape.GROUND_DECOR,"LocShape"),DurationValid=new ScriptInputRangeValidator(1,2147483647,"Duration"),CoordValid=new ScriptInputCoordValidator(0,2147483647,"Coord"),ParamTypeValid=new ScriptInputConfigTypeValidator(ParamType.get,(e=>e>=0&&e<ParamType.count),"Param"),NpcTypeValid=new ScriptInputConfigTypeValidator(NpcType.get,(e=>e>=0&&e<NpcType.count),"Npc"),NpcStatValid=new ScriptInputRangeValidator(NpcStat_default.ATTACK,NpcStat_default.MAGIC,"NpcStat"),PlayerStatValid=new ScriptInputRangeValidator(PlayerStat_default.ATTACK,PlayerStat_default.RUNECRAFT,"PlayerStat"),QueueValid=new ScriptInputRangeValidator(0,19,"AIQueue"),HuntTypeValid=new ScriptInputConfigTypeValidator(HuntType.get,(e=>e>=0&&e<HuntType.count),"Hunt"),NpcModeValid=new ScriptInputRangeValidator(NpcMode_default.NULL,NpcMode_default.APNPC5,"NpcMode"),HitTypeValid=new ScriptInputRangeValidator(HitType_default.BLOCK,HitType_default.POISON,"Hit"),SpotAnimTypeValid=new ScriptInputConfigTypeValidator(SpotanimType.get,(e=>e>=0&&e<SpotanimType.count),"Spotanim"),EnumTypeValid=new ScriptInputConfigTypeValidator(EnumType.get,(e=>e>=0&&e<EnumType.count),"Enum"),ObjTypeValid=new ScriptInputConfigTypeValidator(ObjType.get,(e=>e>=0&&e<ObjType.count),"Obj"),ObjStackValid=new ScriptInputRangeValidator(1,Inventory.STACK_LIMIT,"ObjStack"),InvTypeValid=new ScriptInputConfigTypeValidator(InvType.get,(e=>e>=0&&e<InvType.count),"Inv"),CategoryTypeValid=new ScriptInputConfigTypeValidator(CategoryType.get,(e=>e>=0&&e<CategoryType.count),"Cat"),IDKTypeValid=new ScriptInputConfigTypeValidator(IdkType.get,(e=>e>=0&&e<IdkType.count),"Idk"),HuntVisValid=new ScriptInputRangeValidator(HuntVis_default.OFF,HuntVis_default.LINEOFWALK,"HuntVis"),SeqTypeValid=new ScriptInputConfigTypeValidator(SeqType.get,(e=>e>=0&&e<SeqType.count),"Seq"),VarPlayerValid=new ScriptInputConfigTypeValidator(VarPlayerType.get,(e=>e>=0&&e<VarPlayerType.count),"Varp"),VarNpcValid=new ScriptInputConfigTypeValidator(VarNpcType.get,(e=>e>=0&&e<VarNpcType.count),"Varn"),VarSharedValid=new ScriptInputConfigTypeValidator(VarSharedType.get,(e=>e>=0&&e<VarSharedType.count),"Vars"),FontTypeValid=new ScriptInputConfigTypeValidator(FontType.get,(e=>e>=0&&e<FontType.count),"Font"),MesanimValid=new ScriptInputConfigTypeValidator(MesanimType.get,(e=>e>=0&&e<MesanimType.count),"Mesanim"),StructTypeValid=new ScriptInputConfigTypeValidator(StructType.get,(e=>e>=0&&e<StructType.count),"Struct"),DbRowTypeValid=new ScriptInputConfigTypeValidator(DbRowType.get,(e=>e>=0&&e<DbRowType.count),"Dbrow"),DbTableTypeValid=new ScriptInputConfigTypeValidator(DbTableType.get,(e=>e>=0&&e<DbTableType.count),"Dbtable"),GenderValid=new ScriptInputRangeValidator(0,1,"Gender"),SkinColourValid=new ScriptInputRangeValidator(0,7,"SkinColour"),gosub=function(e,t){if(e.fp>=50)throw new Error("stack overflow");e.frames[e.fp++]={script:e.script,pc:e.pc,intLocals:e.intLocals,stringLocals:e.stringLocals};const i=ScriptProvider.get(t);if(!i)throw new Error(`unable to find proc ${i}`);setupNewScript(e,i)},jump=function(e,t){const i=ScriptProvider.get(t);if(!i)throw new Error(`unable to find label ${t}`);e.debugFrames[e.debugFp++]={script:e.script,pc:e.pc},setupNewScript(e,i),e.fp=0,e.frames=[]},setupNewScript=function(e,t){e.script=t,e.pc=-1,e.intLocals=e.popInts(t.intArgCount),e.stringLocals=e.popStrings(t.stringArgCount)},CoreOps={[ScriptOpcode_default.PUSH_CONSTANT_INT]:e=>{e.pushInt(e.intOperand)},[ScriptOpcode_default.PUSH_CONSTANT_STRING]:e=>{e.pushString(e.stringOperand)},[ScriptOpcode_default.PUSH_VARP]:e=>{const t=e.intOperand>>16&1;if(t&&!e._activePlayer2)throw new Error("No secondary active_player.");if(!t&&!e._activePlayer)throw new Error("No active_player.");const i=check(65535&e.intOperand,VarPlayerValid);i.type===ScriptVarType.STRING?e.pushString(t?e._activePlayer2.getVar(i.id):e._activePlayer.getVar(i.id)):e.pushInt(t?e._activePlayer2.getVar(i.id):e._activePlayer.getVar(i.id))},[ScriptOpcode_default.POP_VARP]:e=>{const t=e.intOperand>>16&1;if(t&&!e._activePlayer2)throw new Error("No secondary active_player.");if(!t&&!e._activePlayer)throw new Error("No active_player.");const i=check(65535&e.intOperand,VarPlayerValid);if(!e.pointerGet(ProtectedActivePlayer[t])&&i.protect)throw new Error(`%${i.debugname} requires protected access`);if(i.type===ScriptVarType.STRING){const n=e.popString();t?e._activePlayer2.setVar(i.id,n):e._activePlayer.setVar(i.id,n)}else{const n=e.popInt();t?e._activePlayer2.setVar(i.id,n):e._activePlayer.setVar(i.id,n)}},[ScriptOpcode_default.PUSH_VARN]:e=>{const t=e.intOperand>>16&1;if(t&&!e._activeNpc2)throw new Error("No secondary active_npc.");if(!t&&!e._activeNpc)throw new Error("No active_npc.");const i=check(65535&e.intOperand,VarNpcValid);i.type===ScriptVarType.STRING?e.pushString(t?e._activeNpc2.getVar(i.id):e._activeNpc.getVar(i.id)):e.pushInt(t?e._activeNpc2.getVar(i.id):e._activeNpc.getVar(i.id))},[ScriptOpcode_default.POP_VARN]:e=>{const t=e.intOperand>>16&1;if(t&&!e._activeNpc2)throw new Error("No secondary active_npc.");if(!t&&!e._activeNpc)throw new Error("No active_npc.");const i=check(65535&e.intOperand,VarNpcValid);if(i.type===ScriptVarType.STRING){const n=e.popInt();t?e._activeNpc2.setVar(i.id,n):e._activeNpc.setVar(i.id,n)}else{const n=e.popInt();t?e._activeNpc2.setVar(i.id,n):e._activeNpc.setVar(i.id,n)}},[ScriptOpcode_default.PUSH_INT_LOCAL]:e=>{e.pushInt(e.intLocals[e.intOperand])},[ScriptOpcode_default.POP_INT_LOCAL]:e=>{e.intLocals[e.intOperand]=e.popInt()},[ScriptOpcode_default.PUSH_STRING_LOCAL]:e=>{e.pushString(e.stringLocals[e.intOperand])},[ScriptOpcode_default.POP_STRING_LOCAL]:e=>{e.stringLocals[e.intOperand]=e.popString()},[ScriptOpcode_default.BRANCH]:e=>{e.pc+=e.intOperand},[ScriptOpcode_default.BRANCH_NOT]:e=>{const t=e.popInt();e.popInt()!==t&&(e.pc+=e.intOperand)},[ScriptOpcode_default.BRANCH_EQUALS]:e=>{const t=e.popInt();e.popInt()===t&&(e.pc+=e.intOperand)},[ScriptOpcode_default.BRANCH_LESS_THAN]:e=>{const t=e.popInt();e.popInt()<t&&(e.pc+=e.intOperand)},[ScriptOpcode_default.BRANCH_GREATER_THAN]:e=>{const t=e.popInt();e.popInt()>t&&(e.pc+=e.intOperand)},[ScriptOpcode_default.BRANCH_LESS_THAN_OR_EQUALS]:e=>{const t=e.popInt();e.popInt()<=t&&(e.pc+=e.intOperand)},[ScriptOpcode_default.BRANCH_GREATER_THAN_OR_EQUALS]:e=>{const t=e.popInt();e.popInt()>=t&&(e.pc+=e.intOperand)},[ScriptOpcode_default.POP_INT_DISCARD]:e=>{e.isp--},[ScriptOpcode_default.POP_STRING_DISCARD]:e=>{e.ssp--},[ScriptOpcode_default.RETURN]:e=>{if(0===e.fp)return void(e.execution=ScriptState.FINISHED);const t=e.frames[--e.fp];e.pc=t.pc,e.script=t.script,e.intLocals=t.intLocals,e.stringLocals=t.stringLocals},[ScriptOpcode_default.JOIN_STRING]:e=>{const t=e.intOperand,i=[];for(let n=0;n<t;n++)i.push(e.popString());e.pushString(i.reverse().join(""))},[ScriptOpcode_default.GOSUB]:e=>{gosub(e,e.popInt())},[ScriptOpcode_default.GOSUB_WITH_PARAMS]:e=>{gosub(e,e.intOperand)},[ScriptOpcode_default.JUMP]:e=>{jump(e,e.popInt())},[ScriptOpcode_default.JUMP_WITH_PARAMS]:e=>{jump(e,e.intOperand)},[ScriptOpcode_default.DEFINE_ARRAY]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.PUSH_ARRAY_INT]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.POP_ARRAY_INT]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.SWITCH]:e=>{const t=e.popInt(),i=e.script.switchTables[e.intOperand];if(void 0===i)return;const n=i[t];n&&(e.pc+=n)},[ScriptOpcode_default.PUSH_VARS]:e=>{const t=check(65535&e.intOperand,VarSharedValid);t.type===ScriptVarType.STRING?e.pushString(World_default.varsString[t.id]??""):e.pushInt(World_default.vars[t.id])},[ScriptOpcode_default.POP_VARS]:e=>{const t=check(65535&e.intOperand,VarSharedValid);t.type===ScriptVarType.STRING?World_default.varsString[t.id]=e.popString():World_default.vars[t.id]=e.popInt()}},CoreOps_default=CoreOps,DebugOps={[ScriptOpcode_default.DB_FIND_WITH_COUNT]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.DB_FINDNEXT]:e=>{if(!e.dbTable)throw new Error("No table selected");e.dbRow+1>=e.dbRowQuery.length?e.pushInt(-1):(e.dbRow++,e.pushInt(check(e.dbRowQuery[e.dbRow],DbRowTypeValid).id))},[ScriptOpcode_default.DB_GETFIELD]:e=>{const[t,i,n]=e.popInts(3),r=i>>12&65535,a=i>>4&127,s=check(t,DbRowTypeValid),o=check(r,DbTableTypeValid);let c;c=s.tableId!==r?o.getDefault(a):s.getValue(a,n);const l=o.types[a];for(let t=0;t<c.length;t++)l[t]===ScriptVarType.STRING?e.pushString(c[t]):e.pushInt(c[t])},[ScriptOpcode_default.DB_GETFIELDCOUNT]:e=>{const[t,i]=e.popInts(2),n=i>>12&65535,r=i>>4&127,a=check(t,DbRowTypeValid),s=check(n,DbTableTypeValid);a.tableId===n?e.pushInt(a.columnValues[r].length/s.types[r].length):e.pushInt(0)},[ScriptOpcode_default.DB_LISTALL_WITH_COUNT]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.DB_GETROWTABLE]:e=>{e.pushInt(check(e.popInt(),DbRowTypeValid).tableId)},[ScriptOpcode_default.DB_FINDBYINDEX]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.DB_FIND_REFINE_WITH_COUNT]:e=>{throw new Error("unimplemented")},[ScriptOpcode_default.DB_FIND]:e=>{const t=2==e.popInt()?e.popString():e.popInt(),i=e.popInt(),n=i>>12&65535,r=i>>4&127;e.dbTable=check(n,DbTableTypeValid),e.dbRow=-1,e.dbRowQuery=[];const a=DbRowType.getInTable(n);for(let i=0;i<a.length;i++){const n=a[i];n.columnValues[r].includes(t)&&e.dbRowQuery.push(n.id)}e.pushInt(e.dbRowQuery.length)},[ScriptOpcode_default.DB_FIND_REFINE]:e=>{const t=2==e.popInt()?e.popString():e.popInt(),i=e.popInt(),n=i>>12&65535,r=i>>4&127,a=[],s=DbRowType.getInTable(n);for(let e=0;e<s.length;e++){const i=s[e];i.columnValues[r].includes(t)&&a.push(i.id)}const o=e.dbRowQuery;e.dbRow=-1,e.dbRowQuery=[];for(let t=0;t<o.length;t++)a.includes(o[t])&&e.dbRowQuery.push(o[t]);e.pushInt(e.dbRowQuery.length)},[ScriptOpcode_default.DB_LISTALL]:e=>{throw new Error("unimplemented")}},DbOps_default=DebugOps,Environment_default={PUBLIC_IP:"localhost",WEB_PORT:80,GAME_PORT:43594,LOGIN_HOST:"localhost",LOGIN_PORT:43500,LOGIN_KEY:"",FRIEND_HOST:"localhost",FRIEND_PORT:43501,FRIEND_KEY:"",WORLD_ID:0,LOCAL_DEV:!0,MEMBERS_WORLD:!0,XP_MULTIPLIER:1,SHUTDOWN_TIMER:50,HTTPS_ENABLED:!1,ADDRESS_SHOWPORT:!0,CLIRUNNER:!1,CI_MODE:!1,SKIP_CORS:!1,DB_HOST:"",DB_USER:"",DB_PASS:"",DB_NAME:"",ADMIN_IP:"localhost",SKIP_CRC:!1,JAVA_PATH:"java",DATA_SRC_DIR:"data/src",VALIDATE_PACK:!0,STRICT_FOLDERS:!0,BUILD_ON_STARTUP:!0,UPDATE_ON_STARTUP:!0,JMODS:["pazaz"],CLIENT_PATHFINDER:!0,NO_SOCKET_TIMEOUT:!1,PROFILE_SCRIPTS:!1},DebugOps2={[ScriptOpcode_default.ERROR]:e=>{throw new Error(e.popString())},[ScriptOpcode_default.MAP_LOCALDEV]:e=>{e.pushInt(Environment_default.LOCAL_DEV?1:0)}},DebugOps_default=DebugOps2,EnumOps={[ScriptOpcode_default.ENUM]:e=>{const[t,i,n,r]=e.popInts(4),a=check(n,EnumTypeValid);if(a.inputtype!==t||a.outputtype!==i)throw new Error(`Type validation error: ${a.debugname} key: ${r}. Expected input: ${t} got: ${a.inputtype}. Expected output: ${i} got: ${a.outputtype}`);const s=a.values.get(r);"string"==typeof s?e.pushString(s??a.defaultString):e.pushInt(s??a.defaultInt)},[ScriptOpcode_default.ENUM_GETOUTPUTCOUNT]:e=>{e.pushInt(check(e.popInt(),EnumTypeValid).values.size)}},EnumOps_default=EnumOps;(e=>{e[e.FOREVER=0]="FOREVER",e[e.RESPAWN=1]="RESPAWN",e[e.DESPAWN=2]="DESPAWN"})(EntityLifeCycle||={});var EntityLifeCycle_default=EntityLifeCycle;class Entity{level;x;z;width;length;lifecycle;lifecycleTick=-1;lastLifecycleTick=-1;constructor(e,t,i,n,r,a){this.level=e,this.x=t,this.z=i,this.width=n,this.length=r,this.lifecycle=a}updateLifeCycle(e){return this.lifecycleTick===e&&this.lifecycle!==EntityLifeCycle_default.FOREVER}checkLifeCycle(e){return this.lifecycle===EntityLifeCycle_default.FOREVER||(this.lifecycle===EntityLifeCycle_default.RESPAWN?this.lifecycleTick<e:this.lifecycle===EntityLifeCycle_default.DESPAWN&&this.lifecycleTick>e)}setLifeCycle(e){this.lifecycleTick=e,this.lastLifecycleTick=World_default.currentTick}}class NonPathingEntity extends Entity{resetEntity(e){}}class Obj extends NonPathingEntity{type;count;receiverId=-1;reveal=-1;constructor(e,t,i,n,r,a){super(e,t,i,1,1,n),this.type=r,this.count=a}}var NpcIteratorType,InvOps={[ScriptOpcode_default.INV_ALLSTOCK]:e=>{const t=check(e.popInt(),InvTypeValid);e.pushInt(t.allstock?1:0)},[ScriptOpcode_default.INV_SIZE]:e=>{const t=check(e.popInt(),InvTypeValid);e.pushInt(t.size)},[ScriptOpcode_default.INV_STOCKBASE]:e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid),r=check(i,ObjTypeValid);if(!n.stockobj||!n.stockcount)return void e.pushInt(-1);const a=n.stockobj.indexOf(r.id);e.pushInt(a>=0?n.stockcount[a]:-1)},[ScriptOpcode_default.INV_ADD]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3),r=check(t,InvTypeValid),a=check(i,ObjTypeValid);if(check(n,ObjStackValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&r.protect&&r.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);if(!r.dummyinv&&0!==a.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${a.debugname} -> ${r.debugname}`);const s=e.activePlayer,o=n-s.invAdd(r.id,a.id,n);o>0&&World_default.addObj(new Obj(s.level,s.x,s.z,EntityLifeCycle_default.DESPAWN,a.id,o),s.pid,200)})),[ScriptOpcode_default.INV_CHANGESLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4);throw new Error("unimplemented")})),[ScriptOpcode_default.INV_CLEAR]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),InvTypeValid);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&t.protect&&t.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${t.debugname}`);e.activePlayer.invClear(t.id)})),[ScriptOpcode_default.INV_DEL]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3),r=check(t,InvTypeValid),a=check(i,ObjTypeValid);if(check(n,ObjStackValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&r.protect&&r.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);e.activePlayer.invDel(r.id,a.id,n)})),[ScriptOpcode_default.INV_DELSLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&n.protect&&n.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${n.debugname}`);e.activePlayer.invGetSlot(n.id,i)&&e.activePlayer.invDelSlot(n.id,i)})),[ScriptOpcode_default.INV_DROPITEM]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r,a]=e.popInts(5),s=check(t,InvTypeValid),o=check(i,CoordValid),c=check(n,ObjTypeValid);if(check(r,ObjStackValid),check(a,DurationValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&s.protect&&s.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${s.debugname}`);const l=e.activePlayer,d=l.invDel(s.id,c.id,r);if(0==d)return;l.playerLog("Dropped item from",s.debugname,c.debugname);const p=new Obj(o.level,o.x,o.z,EntityLifeCycle_default.DESPAWN,c.id,d);World_default.addObj(p,l.pid,a),e.activeObj=p,e.pointerAdd(ActiveObj[e.intOperand])})),[ScriptOpcode_default.INV_DROPSLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid);check(r,DurationValid);const s=check(i,CoordValid);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const o=e.activePlayer.invGetSlot(a.id,n);if(!o)throw new Error("$slot is empty");const c=e.activePlayer,l=c.invDel(a.id,o.id,o.count,n);if(0===l)return;const d=ObjType.get(o.id);c.playerLog("Dropped item from",a.debugname,d.debugname);const p=new Obj(s.level,s.x,s.z,EntityLifeCycle_default.DESPAWN,o.id,l);World_default.addObj(p,c.pid,r),e.activeObj=p,e.pointerAdd(ActiveObj[e.intOperand])})),[ScriptOpcode_default.INV_FREESPACE]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),InvTypeValid);e.pushInt(e.activePlayer.invFreeSpace(t.id))})),[ScriptOpcode_default.INV_GETNUM]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid);e.pushInt(e.activePlayer.invGetSlot(n.id,i)?.count??0)})),[ScriptOpcode_default.INV_GETOBJ]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid);e.pushInt(e.activePlayer.invGetSlot(n.id,i)?.id??-1)})),[ScriptOpcode_default.INV_ITEMSPACE]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(i,ObjTypeValid);if(check(n,ObjStackValid),r<0||r>a.size)throw new Error(`$count is out of range: ${n}`);e.pushInt(0===e.activePlayer.invItemSpace(a.id,s.id,n,r)?1:0)})),[ScriptOpcode_default.INV_ITEMSPACE2]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(i,ObjTypeValid);check(n,ObjStackValid),e.pushInt(e.activePlayer.invItemSpace(a.id,s.id,n,r))})),[ScriptOpcode_default.INV_MOVEFROMSLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3),r=check(t,InvTypeValid),a=check(i,InvTypeValid);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&r.protect&&r.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&r.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const s=e.activePlayer,{overflow:o,fromObj:c}=s.invMoveFromSlot(r.id,a.id,n);o>0&&World_default.addObj(new Obj(s.level,s.x,s.z,EntityLifeCycle_default.DESPAWN,c,o),s.pid,200)})),[ScriptOpcode_default.INV_MOVETOSLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(i,InvTypeValid);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&s.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${s.debugname}`);e.activePlayer.invMoveToSlot(a.id,s.id,n,r)})),[ScriptOpcode_default.BOTH_MOVEINV]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid),r=check(i,InvTypeValid),a=1==e.intOperand,s=a?e._activePlayer2:e._activePlayer,o=a?e._activePlayer:e._activePlayer2;if(!s||!o)throw new Error("player is null");if(!e.pointerGet(ProtectedActivePlayer[a?1:0])&&n.protect&&n.scope!==InvType.SCOPE_SHARED)throw new Error(`$from_inv requires protected access: ${n.debugname}`);if(!e.pointerGet(ProtectedActivePlayer[a?0:1])&&r.protect&&n.scope!==InvType.SCOPE_SHARED)throw new Error(`$to_inv requires protected access: ${r.debugname}`);const c=s.getInventory(t),l=o.getInventory(i);if(!c||!l)throw new Error("inv is null");for(let e=0;e<c.capacity;e++){const t=c.get(e);t&&(c.delete(e),l.add(t.id,t.count),s.playerLog("Gave "+ObjType.get(t.id).name+" x"+t.count+" during trade with "+o.username),o.playerLog("Received "+ObjType.get(t.id).name+" x"+t.count+" during trade with "+s.username))}})),[ScriptOpcode_default.INV_MOVEITEM]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(i,InvTypeValid),o=check(n,ObjTypeValid);if(check(r,ObjStackValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&s.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${s.debugname}`);const c=e.activePlayer,l=c.invDel(a.id,o.id,r);if(0==l)return;const d=r-c.invAdd(s.id,o.id,l);d>0&&World_default.addObj(new Obj(c.level,c.x,c.z,EntityLifeCycle_default.DESPAWN,o.id,d),c.pid,200)})),[ScriptOpcode_default.INV_MOVEITEM_CERT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(i,InvTypeValid),o=check(n,ObjTypeValid);if(check(r,ObjStackValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&s.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${s.debugname}`);const c=e.activePlayer,l=c.invDel(a.id,o.id,r);if(0==l)return;let d=o.id;-1===o.certtemplate&&o.certlink>=0&&(d=o.certlink);const p=r-c.invAdd(s.id,d,l);p>0&&World_default.addObj(new Obj(c.level,c.x,c.z,EntityLifeCycle_default.DESPAWN,d,p),c.pid,200)})),[ScriptOpcode_default.INV_MOVEITEM_UNCERT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(i,InvTypeValid),o=check(n,ObjTypeValid);if(check(r,ObjStackValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&s.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${s.debugname}`);const c=e.activePlayer,l=c.invDel(a.id,o.id,r);0!=l&&(o.certtemplate>=0&&o.certlink>=0?c.invAdd(s.id,o.certlink,l):c.invAdd(s.id,o.id,l))})),[ScriptOpcode_default.INV_SETSLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid),s=check(n,ObjTypeValid);if(check(r,ObjStackValid),!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!a.dummyinv&&0!==s.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${s.debugname} -> ${a.debugname}`);e.activePlayer.invSet(a.id,s.id,r,i)})),[ScriptOpcode_default.INV_TOTAL]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid);-1!==i?e.pushInt(e.activePlayer.invTotal(n.id,i)):e.pushInt(0)})),[ScriptOpcode_default.INV_TOTALCAT]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid),r=check(i,CategoryTypeValid);e.pushInt(e.activePlayer.invTotalCat(n.id,r.id))})),[ScriptOpcode_default.INV_TRANSMIT]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2),n=check(t,InvTypeValid);check(i,NumberNotNull),e.activePlayer.invListenOnCom(n.id,i,e.activePlayer.uid)})),[ScriptOpcode_default.INVOTHER_TRANSMIT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,NumberNotNull);const r=check(i,InvTypeValid);check(n,NumberNotNull),e.activePlayer.invListenOnCom(r.id,n,t)})),[ScriptOpcode_default.INV_STOPTRANSMIT]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull);e.activePlayer.invStopListenOnCom(t)})),[ScriptOpcode_default.BOTH_DROPSLOT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,InvTypeValid);check(r,DurationValid);const s=check(i,CoordValid),o=1==e.intOperand,c=o?e._activePlayer2:e._activePlayer,l=o?e._activePlayer:e._activePlayer2;if(!c||!l)throw new Error("player is null");if(!e.pointerGet(ProtectedActivePlayer[o?1:0])&&a.protect&&a.scope!==InvType.SCOPE_SHARED)throw new Error(`inv requires protected access: ${a.debugname}`);const d=c.invGetSlot(a.id,n);if(!d)throw new Error("$slot is empty");const p=c.invDel(a.id,d.id,d.count,n);if(0===p)return;const h=ObjType.get(d.id);c.playerLog("Dropped item from",a.debugname,h.debugname),h.tradeable&&World_default.addObj(new Obj(s.level,s.x,s.z,EntityLifeCycle_default.DESPAWN,d.id,p),l.pid,r)})),[ScriptOpcode_default.INV_DROPALL]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3),r=check(t,InvTypeValid);check(n,DurationValid);const a=check(i,CoordValid);if(!e.pointerGet(ProtectedActivePlayer[e.intOperand])&&r.protect&&r.scope!==InvType.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const s=e.activePlayer.getInventory(r.id);if(s)for(let e=0;e<s.capacity;e++){const t=s.get(e);if(!t)continue;s.delete(e);ObjType.get(t.id).tradeable&&World_default.addObj(new Obj(a.level,a.x,a.z,EntityLifeCycle_default.DESPAWN,t.id,t.count),-1,n)}})),[ScriptOpcode_default.INV_TOTALPARAM]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);e.pushInt(e.activePlayer.invTotalParam(t,i))})),[ScriptOpcode_default.INV_TOTALPARAM_STACK]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);e.pushInt(e.activePlayer.invTotalParamStack(t,i))}))},InvOps_default=InvOps;(e=>{e[e.ZONE=0]="ZONE",e[e.DISTANCE=1]="DISTANCE"})(NpcIteratorType||={});var NpcIteratorType_default=NpcIteratorType;class ScriptIterator{iterator;tick;constructor(e){this.iterator=this.generator(),this.tick=e}[Symbol.iterator](){return this.iterator}next(){return this.iterator.next()}}class HuntIterator extends ScriptIterator{x;z;level;minX;maxX;minZ;maxZ;distance;checkVis;checkType;checkCategory;type;constructor(e,t,i,n,r,a,s,o,c){super(e);const l=Position.zone(i),d=Position.zone(n),p=1+r/8|0;this.x=i,this.z=n,this.level=t,this.maxX=l+p,this.minX=l-p,this.maxZ=d+p,this.minZ=d-p,this.distance=r,this.checkVis=a,this.checkType=s,this.checkCategory=o,this.type=c}*generator(){for(let e=this.maxX;e>=this.minX;e--){const t=e<<3;for(let e=this.maxZ;e>=this.minZ;e--){const i=e<<3;if(this.type===HuntModeType_default.PLAYER)for(const e of World_default.getZone(t,i,this.level).getAllPlayersSafe()){if(World_default.currentTick>this.tick)throw new Error("[HuntIterator] tried to use an old iterator. Create a new iterator instead.");Position.distanceToSW({x:this.x,z:this.z},e)>this.distance||(this.checkVis!==HuntVis_default.LINEOFSIGHT||hasLineOfSight(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(this.checkVis!==HuntVis_default.LINEOFWALK||hasLineOfWalk(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(yield e)}else if(this.type===HuntModeType_default.NPC)for(const e of World_default.getZone(t,i,this.level).getAllNpcsSafe()){if(World_default.currentTick>this.tick)throw new Error("[HuntIterator] tried to use an old iterator. Create a new iterator instead.");if(-1!==this.checkType&&e.type!==this.checkType)continue;const t=NpcType.get(e.type);-1!==this.checkCategory&&t.category!==this.checkCategory||t.op&&t.op[1]&&(Position.distanceToSW({x:this.x,z:this.z},e)>this.distance||(this.checkVis!==HuntVis_default.LINEOFSIGHT||hasLineOfSight(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(this.checkVis!==HuntVis_default.LINEOFWALK||hasLineOfWalk(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(yield e))}else if(this.type===HuntModeType_default.OBJ)for(const e of World_default.getZone(t,i,this.level).getAllObjsSafe()){if(World_default.currentTick>this.tick)throw new Error("[HuntIterator] tried to use an old iterator. Create a new iterator instead.");if(-1!==this.checkType&&e.type!==this.checkType)continue;const t=ObjType.get(e.type);-1!==this.checkCategory&&t.category!==this.checkCategory||(Position.distanceToSW({x:this.x,z:this.z},e)>this.distance||(this.checkVis!==HuntVis_default.LINEOFSIGHT||hasLineOfSight(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(this.checkVis!==HuntVis_default.LINEOFWALK||hasLineOfWalk(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(yield e))}else if(this.type===HuntModeType_default.SCENERY)for(const e of World_default.getZone(t,i,this.level).getAllLocsSafe()){if(World_default.currentTick>this.tick)throw new Error("[HuntIterator] tried to use an old iterator. Create a new iterator instead.");if(-1!==this.checkType&&e.type!==this.checkType)continue;const t=LocType.get(e.type);-1!==this.checkCategory&&t.category!==this.checkCategory||(Position.distanceToSW({x:this.x,z:this.z},e)>this.distance||(this.checkVis!==HuntVis_default.LINEOFSIGHT||hasLineOfSight(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(this.checkVis!==HuntVis_default.LINEOFWALK||hasLineOfWalk(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(yield e))}}}}}class NpcIterator extends ScriptIterator{level;x;z;minX;maxX;minZ;maxZ;distance;checkVis;type;constructor(e,t,i,n,r,a,s){super(e);const o=Position.zone(i),c=Position.zone(n),l=1+r/8|0;this.x=i,this.z=n,this.level=t,this.maxX=o+l,this.minX=o-l,this.maxZ=c+l,this.minZ=c-l,this.distance=r,this.checkVis=a,this.type=s}*generator(){if(this.type===NpcIteratorType_default.ZONE)for(const e of World_default.getZone(this.x,this.z,this.level).getAllNpcsSafe()){if(World_default.currentTick>this.tick)throw new Error("[NpcIterator] tried to use an old iterator. Create a new iterator instead.");yield e}else if(this.type===NpcIteratorType_default.DISTANCE)for(let e=this.maxX;e>=this.minX;e--){const t=e<<3;for(let e=this.maxZ;e>=this.minZ;e--){const i=e<<3;for(const e of World_default.getZone(t,i,this.level).getAllNpcsSafe()){if(World_default.currentTick>this.tick)throw new Error("[NpcIterator] tried to use an old iterator. Create a new iterator instead.");Position.distanceToSW({x:this.x,z:this.z},e)>this.distance||(this.checkVis!==HuntVis_default.LINEOFSIGHT||hasLineOfSight(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(this.checkVis!==HuntVis_default.LINEOFWALK||hasLineOfWalk(this.level,this.x,this.z,e.x,e.z,1,1,1,1))&&(yield e)}}}}}class LocIterator extends ScriptIterator{level;x;z;constructor(e,t,i,n){super(e),this.level=t,this.x=i,this.z=n}*generator(){for(const e of World_default.getZone(this.x,this.z,this.level).getAllLocsSafe()){if(World_default.currentTick>this.tick)throw new Error("[LocIterator] tried to use an old iterator. Create a new iterator instead.");yield e}}}class Loc extends NonPathingEntity{info;constructor(e,t,i,n,r,a,s,o,c){super(e,t,i,n,r,a),this.info=16383&s|(31&o)<<14|(3&c)<<19}get type(){return 16383&this.info}get shape(){return this.info>>14&31}get angle(){return this.info>>19&3}}var ServerTriggerType,LocOps={[ScriptOpcode_default.LOC_ADD]:e=>{const[t,i,n,r,a]=e.popInts(5),s=check(t,CoordValid),o=check(i,LocTypeValid),c=check(n,LocAngleValid),l=check(r,LocShapeValid);check(a,DurationValid);const d=new Loc(s.level,s.x,s.z,o.width,o.length,EntityLifeCycle_default.DESPAWN,o.id,l,c),p=World_default.getZone(s.x,s.z,s.level).getLocsUnsafe(Position.packZoneCoord(s.x,s.z));for(const e of p)if(e!==d&&e.angle===c&&e.shape===l){World_default.removeLoc(e,a);break}World_default.addLoc(d,a),e.activeLoc=d,e.pointerAdd(ActiveLoc[e.intOperand])},[ScriptOpcode_default.LOC_ANGLE]:checkedHandler(ActiveLoc,(e=>{e.pushInt(check(e.activeLoc.angle,LocAngleValid))})),[ScriptOpcode_default.LOC_ANIM]:checkedHandler(ActiveLoc,(e=>{const t=check(e.popInt(),SeqTypeValid);World_default.animLoc(e.activeLoc,t.id)})),[ScriptOpcode_default.LOC_CATEGORY]:checkedHandler(ActiveLoc,(e=>{e.pushInt(check(e.activeLoc.type,LocTypeValid).category)})),[ScriptOpcode_default.LOC_CHANGE]:checkedHandler(ActiveLoc,(e=>{const[t,i]=e.popInts(2),n=check(t,LocTypeValid);check(i,DurationValid),World_default.removeLoc(e.activeLoc,i);const{level:r,x:a,z:s,angle:o,shape:c}=e.activeLoc,l=World_default.getZone(a,s,r).getLocsUnsafe(Position.packZoneCoord(a,s));let d=null;for(const e of l)if(e.type===n.id&&e.angle===o&&e.shape===c&&e.lifecycle===EntityLifeCycle_default.RESPAWN){d=e,World_default.addLoc(e,0);break}d||(d=new Loc(r,a,s,n.width,n.length,EntityLifeCycle_default.DESPAWN,n.id,c,o),World_default.addLoc(d,i)),e.activeLoc=d,e.pointerAdd(ActiveLoc[e.intOperand])})),[ScriptOpcode_default.LOC_COORD]:checkedHandler(ActiveLoc,(e=>{const t=e.activeLoc;e.pushInt(Position.packCoord(t.level,t.x,t.z))})),[ScriptOpcode_default.LOC_DEL]:checkedHandler(ActiveLoc,(e=>{const t=check(e.popInt(),DurationValid),{level:i,x:n,z:r,angle:a,shape:s}=e.activeLoc,o=World_default.getZone(n,r,i).getLocsUnsafe(Position.packZoneCoord(n,r));for(const i of o)if(i!==e.activeLoc&&i.angle===a&&i.shape===s){World_default.removeLoc(i,t);break}World_default.removeLoc(e.activeLoc,t)})),[ScriptOpcode_default.LOC_FIND]:e=>{const[t,i]=e.popInts(2),n=check(i,LocTypeValid),r=check(t,CoordValid),a=World_default.getLoc(r.x,r.z,r.level,n.id);a?(e.activeLoc=a,e.pointerAdd(ActiveLoc[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.LOC_FINDALLZONE]:e=>{const t=check(e.popInt(),CoordValid);e.locIterator=new LocIterator(World_default.currentTick,t.level,t.x,t.z),e._activeLoc&&(e._activeLoc2=e._activeLoc,e.pointerAdd(ScriptPointer_default.ActiveLoc2))},[ScriptOpcode_default.LOC_FINDNEXT]:e=>{const t=e.locIterator?.next();t&&!t.done?(e.activeLoc=t.value,e.pointerAdd(ActiveLoc[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.LOC_PARAM]:checkedHandler(ActiveLoc,(e=>{const t=check(e.popInt(),ParamTypeValid),i=check(e.activeLoc.type,LocTypeValid);t.isString()?e.pushString(ParamHelper.getStringParam(t.id,i,t.defaultString)):e.pushInt(ParamHelper.getIntParam(t.id,i,t.defaultInt))})),[ScriptOpcode_default.LOC_TYPE]:checkedHandler(ActiveLoc,(e=>{e.pushInt(check(e.activeLoc.type,LocTypeValid).id)})),[ScriptOpcode_default.LOC_NAME]:checkedHandler(ActiveLoc,(e=>{e.pushString(check(e.activeLoc.type,LocTypeValid).name??"null")})),[ScriptOpcode_default.LOC_SHAPE]:checkedHandler(ActiveLoc,(e=>{e.pushInt(check(e.activeLoc.shape,LocShapeValid))}))},LocOps_default=LocOps,LocConfigOps={[ScriptOpcode_default.LC_NAME]:e=>{const t=check(e.popInt(),LocTypeValid);e.pushString(t.name??t.debugname??"null")},[ScriptOpcode_default.LC_PARAM]:e=>{const[t,i]=e.popInts(2),n=check(t,LocTypeValid),r=check(i,ParamTypeValid);r.isString()?e.pushString(ParamHelper.getStringParam(r.id,n,r.defaultString)):e.pushInt(ParamHelper.getIntParam(r.id,n,r.defaultInt))},[ScriptOpcode_default.LC_CATEGORY]:e=>{e.pushInt(check(e.popInt(),LocTypeValid).category)},[ScriptOpcode_default.LC_DESC]:e=>{e.pushString(check(e.popInt(),LocTypeValid).desc??"null")},[ScriptOpcode_default.LC_DEBUGNAME]:e=>{e.pushString(check(e.popInt(),LocTypeValid).debugname??"null")},[ScriptOpcode_default.LC_WIDTH]:e=>{e.pushInt(check(e.popInt(),LocTypeValid).width)},[ScriptOpcode_default.LC_LENGTH]:e=>{e.pushInt(check(e.popInt(),LocTypeValid).length)}},LocConfigOps_default=LocConfigOps;(e=>{e[e.PROC=0]="PROC",e[e.LABEL=1]="LABEL",e[e.DEBUGPROC=2]="DEBUGPROC",e[e.APNPC1=3]="APNPC1",e[e.APNPC2=4]="APNPC2",e[e.APNPC3=5]="APNPC3",e[e.APNPC4=6]="APNPC4",e[e.APNPC5=7]="APNPC5",e[e.APNPCU=8]="APNPCU",e[e.APNPCT=9]="APNPCT",e[e.OPNPC1=10]="OPNPC1",e[e.OPNPC2=11]="OPNPC2",e[e.OPNPC3=12]="OPNPC3",e[e.OPNPC4=13]="OPNPC4",e[e.OPNPC5=14]="OPNPC5",e[e.OPNPCU=15]="OPNPCU",e[e.OPNPCT=16]="OPNPCT",e[e.AI_APNPC1=17]="AI_APNPC1",e[e.AI_APNPC2=18]="AI_APNPC2",e[e.AI_APNPC3=19]="AI_APNPC3",e[e.AI_APNPC4=20]="AI_APNPC4",e[e.AI_APNPC5=21]="AI_APNPC5",e[e.AI_OPNPC1=24]="AI_OPNPC1",e[e.AI_OPNPC2=25]="AI_OPNPC2",e[e.AI_OPNPC3=26]="AI_OPNPC3",e[e.AI_OPNPC4=27]="AI_OPNPC4",e[e.AI_OPNPC5=28]="AI_OPNPC5",e[e.APOBJ1=31]="APOBJ1",e[e.APOBJ2=32]="APOBJ2",e[e.APOBJ3=33]="APOBJ3",e[e.APOBJ4=34]="APOBJ4",e[e.APOBJ5=35]="APOBJ5",e[e.APOBJU=36]="APOBJU",e[e.APOBJT=37]="APOBJT",e[e.OPOBJ1=38]="OPOBJ1",e[e.OPOBJ2=39]="OPOBJ2",e[e.OPOBJ3=40]="OPOBJ3",e[e.OPOBJ4=41]="OPOBJ4",e[e.OPOBJ5=42]="OPOBJ5",e[e.OPOBJU=43]="OPOBJU",e[e.OPOBJT=44]="OPOBJT",e[e.AI_APOBJ1=45]="AI_APOBJ1",e[e.AI_APOBJ2=46]="AI_APOBJ2",e[e.AI_APOBJ3=47]="AI_APOBJ3",e[e.AI_APOBJ4=48]="AI_APOBJ4",e[e.AI_APOBJ5=49]="AI_APOBJ5",e[e.AI_OPOBJ1=52]="AI_OPOBJ1",e[e.AI_OPOBJ2=53]="AI_OPOBJ2",e[e.AI_OPOBJ3=54]="AI_OPOBJ3",e[e.AI_OPOBJ4=55]="AI_OPOBJ4",e[e.AI_OPOBJ5=56]="AI_OPOBJ5",e[e.APLOC1=59]="APLOC1",e[e.APLOC2=60]="APLOC2",e[e.APLOC3=61]="APLOC3",e[e.APLOC4=62]="APLOC4",e[e.APLOC5=63]="APLOC5",e[e.APLOCU=64]="APLOCU",e[e.APLOCT=65]="APLOCT",e[e.OPLOC1=66]="OPLOC1",e[e.OPLOC2=67]="OPLOC2",e[e.OPLOC3=68]="OPLOC3",e[e.OPLOC4=69]="OPLOC4",e[e.OPLOC5=70]="OPLOC5",e[e.OPLOCU=71]="OPLOCU",e[e.OPLOCT=72]="OPLOCT",e[e.AI_APLOC1=73]="AI_APLOC1",e[e.AI_APLOC2=74]="AI_APLOC2",e[e.AI_APLOC3=75]="AI_APLOC3",e[e.AI_APLOC4=76]="AI_APLOC4",e[e.AI_APLOC5=77]="AI_APLOC5",e[e.AI_OPLOC1=80]="AI_OPLOC1",e[e.AI_OPLOC2=81]="AI_OPLOC2",e[e.AI_OPLOC3=82]="AI_OPLOC3",e[e.AI_OPLOC4=83]="AI_OPLOC4",e[e.AI_OPLOC5=84]="AI_OPLOC5",e[e.APPLAYER1=87]="APPLAYER1",e[e.APPLAYER2=88]="APPLAYER2",e[e.APPLAYER3=89]="APPLAYER3",e[e.APPLAYER4=90]="APPLAYER4",e[e.APPLAYER5=91]="APPLAYER5",e[e.APPLAYERU=92]="APPLAYERU",e[e.APPLAYERT=93]="APPLAYERT",e[e.OPPLAYER1=94]="OPPLAYER1",e[e.OPPLAYER2=95]="OPPLAYER2",e[e.OPPLAYER3=96]="OPPLAYER3",e[e.OPPLAYER4=97]="OPPLAYER4",e[e.OPPLAYER5=98]="OPPLAYER5",e[e.OPPLAYERU=99]="OPPLAYERU",e[e.OPPLAYERT=100]="OPPLAYERT",e[e.AI_APPLAYER1=101]="AI_APPLAYER1",e[e.AI_APPLAYER2=102]="AI_APPLAYER2",e[e.AI_APPLAYER3=103]="AI_APPLAYER3",e[e.AI_APPLAYER4=104]="AI_APPLAYER4",e[e.AI_APPLAYER5=105]="AI_APPLAYER5",e[e.AI_OPPLAYER1=108]="AI_OPPLAYER1",e[e.AI_OPPLAYER2=109]="AI_OPPLAYER2",e[e.AI_OPPLAYER3=110]="AI_OPPLAYER3",e[e.AI_OPPLAYER4=111]="AI_OPPLAYER4",e[e.AI_OPPLAYER5=112]="AI_OPPLAYER5",e[e.QUEUE=116]="QUEUE",e[e.AI_QUEUE1=117]="AI_QUEUE1",e[e.AI_QUEUE2=118]="AI_QUEUE2",e[e.AI_QUEUE3=119]="AI_QUEUE3",e[e.AI_QUEUE4=120]="AI_QUEUE4",e[e.AI_QUEUE5=121]="AI_QUEUE5",e[e.AI_QUEUE6=122]="AI_QUEUE6",e[e.AI_QUEUE7=123]="AI_QUEUE7",e[e.AI_QUEUE8=124]="AI_QUEUE8",e[e.AI_QUEUE9=125]="AI_QUEUE9",e[e.AI_QUEUE10=126]="AI_QUEUE10",e[e.AI_QUEUE11=127]="AI_QUEUE11",e[e.AI_QUEUE12=128]="AI_QUEUE12",e[e.AI_QUEUE13=129]="AI_QUEUE13",e[e.AI_QUEUE14=130]="AI_QUEUE14",e[e.AI_QUEUE15=131]="AI_QUEUE15",e[e.AI_QUEUE16=132]="AI_QUEUE16",e[e.AI_QUEUE17=133]="AI_QUEUE17",e[e.AI_QUEUE18=134]="AI_QUEUE18",e[e.AI_QUEUE19=135]="AI_QUEUE19",e[e.AI_QUEUE20=136]="AI_QUEUE20",e[e.SOFTTIMER=137]="SOFTTIMER",e[e.TIMER=138]="TIMER",e[e.AI_TIMER=139]="AI_TIMER",e[e.OPHELD1=140]="OPHELD1",e[e.OPHELD2=141]="OPHELD2",e[e.OPHELD3=142]="OPHELD3",e[e.OPHELD4=143]="OPHELD4",e[e.OPHELD5=144]="OPHELD5",e[e.OPHELDU=145]="OPHELDU",e[e.OPHELDT=146]="OPHELDT",e[e.IF_BUTTON=147]="IF_BUTTON",e[e.INV_BUTTON1=148]="INV_BUTTON1",e[e.INV_BUTTON2=149]="INV_BUTTON2",e[e.INV_BUTTON3=150]="INV_BUTTON3",e[e.INV_BUTTON4=151]="INV_BUTTON4",e[e.INV_BUTTON5=152]="INV_BUTTON5",e[e.INV_BUTTOND=153]="INV_BUTTOND",e[e.IF_CLOSE=154]="IF_CLOSE",e[e.LOGIN=155]="LOGIN",e[e.LOGOUT=156]="LOGOUT",e[e.TUTORIAL_CLICKSIDE=157]="TUTORIAL_CLICKSIDE",e[e.MOVE=158]="MOVE",e[e.WALKTRIGGER=159]="WALKTRIGGER",e[e.AI_WALKTRIGGER=160]="AI_WALKTRIGGER",e[e.LEVELUP=161]="LEVELUP"})(ServerTriggerType||={}),(e=>{e.toString=function(t){return e[t].toLowerCase()}})(ServerTriggerType||={});var Interaction,ServerTriggerType_default=ServerTriggerType;(e=>{e[e.SCRIPT=0]="SCRIPT",e[e.ENGINE=1]="ENGINE"})(Interaction||={});var Interaction_default=Interaction,NpcOps={[ScriptOpcode_default.NPC_FINDUID]:e=>{const t=e.popInt(),i=65535&t,n=t>>16&65535,r=World_default.getNpc(i);r&&r.type===n?(e.activeNpc=r,e.pointerAdd(ActiveNpc[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.NPC_ADD]:e=>{const[t,i,n]=e.popInts(3),r=check(t,CoordValid),a=check(i,NpcTypeValid);check(n,DurationValid);const s=new Npc2(r.level,r.x,r.z,a.size,a.size,EntityLifeCycle_default.DESPAWN,World_default.getNextNid(),a.id,a.moverestrict,a.blockwalk);World_default.addNpc(s,n),e.activeNpc=s,e.pointerAdd(ActiveNpc[e.intOperand])},[ScriptOpcode_default.NPC_ANIM]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NumberNotNull),i=e.popInt();e.activeNpc.playAnimation(i,t)})),[ScriptOpcode_default.NPC_BASESTAT]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NpcStatValid);e.pushInt(e.activeNpc.baseLevels[t])})),[ScriptOpcode_default.NPC_CATEGORY]:checkedHandler(ActiveNpc,(e=>{e.pushInt(check(e.activeNpc.type,NpcTypeValid).category)})),[ScriptOpcode_default.NPC_COORD]:checkedHandler(ActiveNpc,(e=>{const t=e.activeNpc;e.pushInt(Position.packCoord(t.level,t.x,t.z))})),[ScriptOpcode_default.NPC_DEL]:checkedHandler(ActiveNpc,(e=>{Environment_default.CLIRUNNER||World_default.removeNpc(e.activeNpc,check(e.activeNpc.type,NpcTypeValid).respawnrate)})),[ScriptOpcode_default.NPC_DELAY]:checkedHandler(ActiveNpc,(e=>{Environment_default.CLIRUNNER||(e.activeNpc.delay=e.popInt()+1,e.execution=ScriptState.NPC_SUSPENDED)})),[ScriptOpcode_default.NPC_FACESQUARE]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),CoordValid);e.activeNpc.faceSquare(t.x,t.z)})),[ScriptOpcode_default.NPC_FINDEXACT]:e=>{const[t,i]=e.popInts(2),n=check(t,CoordValid),r=check(i,NpcTypeValid);e.npcIterator=new NpcIterator(World_default.currentTick,n.level,n.x,n.z,0,0,NpcIteratorType_default.ZONE);for(const t of e.npcIterator)if(t.type===r.id&&t.x===n.x&&t.level===n.level&&t.z===n.z)return e.activeNpc=t,e.pointerAdd(ActiveNpc[e.intOperand]),void e.pushInt(1);e.pushInt(0)},[ScriptOpcode_default.NPC_FINDHERO]:checkedHandler(ActiveNpc,(e=>{const t=e.activeNpc.findHero();if(-1===t)return void e.pushInt(0);const i=World_default.getPlayerByUid(t);i?(e.activePlayer=i,e.pointerAdd(ScriptPointer_default.ActivePlayer),e.pushInt(1)):e.pushInt(0)})),[ScriptOpcode_default.NPC_PARAM]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),ParamTypeValid),i=check(e.activeNpc.type,NpcTypeValid);t.isString()?e.pushString(ParamHelper.getStringParam(t.id,i,t.defaultString)):e.pushInt(ParamHelper.getIntParam(t.id,i,t.defaultInt))})),[ScriptOpcode_default.NPC_QUEUE]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NumberNotNull),i=e.popInt(),n=check(e.popInt(),QueueValid),r=check(e.activeNpc.type,NpcTypeValid),a=ScriptProvider.getByTrigger(ServerTriggerType_default.AI_QUEUE1+n-1,r.id,r.category);a&&e.activeNpc.enqueueScript(a,t,i)})),[ScriptOpcode_default.NPC_RANGE]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),CoordValid),i=e.activeNpc;t.level!==i.level?e.pushInt(-1):e.pushInt(Position.distanceTo(i,{x:t.x,z:t.z,width:1,length:1}))})),[ScriptOpcode_default.NPC_SAY]:checkedHandler(ActiveNpc,(e=>{e.activeNpc.say(e.popString())})),[ScriptOpcode_default.NPC_SETHUNT]:checkedHandler(ActiveNpc,(e=>{e.activeNpc.huntrange=check(e.popInt(),NumberNotNull)})),[ScriptOpcode_default.NPC_SETHUNTMODE]:checkedHandler(ActiveNpc,(e=>{e.activeNpc.huntMode=check(e.popInt(),HuntTypeValid).id})),[ScriptOpcode_default.NPC_SETMODE]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NpcModeValid);if(e.activeNpc.clearWaypoints(),t===NpcMode_default.NULL||t===NpcMode_default.NONE||t===NpcMode_default.WANDER||t===NpcMode_default.PATROL)return e.activeNpc.clearInteraction(),void(e.activeNpc.targetOp=t);let i;e.activeNpc.targetOp=t,i=t>=NpcMode_default.OPNPC1?e._activeNpc2:t>=NpcMode_default.OPOBJ1?e._activeObj:t>=NpcMode_default.OPLOC1?e._activeLoc:e._activePlayer,i?i instanceof Npc2||i instanceof Obj||i instanceof Loc?e.activeNpc.setInteraction(Interaction_default.SCRIPT,i,t,{type:i.type,com:-1}):e.activeNpc.setInteraction(Interaction_default.SCRIPT,i,t):e.activeNpc.noMode()})),[ScriptOpcode_default.NPC_STAT]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NpcStatValid);e.pushInt(e.activeNpc.levels[t])})),[ScriptOpcode_default.NPC_STATHEAL]:checkedHandler(ActiveNpc,(e=>{const[t,i,n]=e.popInts(3);check(t,NpcStatValid),check(i,NumberNotNull),check(n,NumberNotNull);const r=e.activeNpc,a=r.baseLevels[t],s=r.levels[t],o=s+(i+s*n/100);r.levels[t]=Math.min(o,a),0===t&&r.levels[t]===r.baseLevels[t]&&r.resetHeroPoints()})),[ScriptOpcode_default.NPC_TYPE]:checkedHandler(ActiveNpc,(e=>{e.pushInt(check(e.activeNpc.type,NpcTypeValid).id)})),[ScriptOpcode_default.NPC_DAMAGE]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NumberNotNull),i=check(e.popInt(),HitTypeValid);e.activeNpc.applyDamage(t,i)})),[ScriptOpcode_default.NPC_NAME]:checkedHandler(ActiveNpc,(e=>{e.pushString(check(e.activeNpc.type,NpcTypeValid).name??"null")})),[ScriptOpcode_default.NPC_UID]:checkedHandler(ActiveNpc,(e=>{e.pushInt(e.activeNpc.uid)})),[ScriptOpcode_default.NPC_SETTIMER]:checkedHandler(ActiveNpc,(e=>{e.activeNpc.setTimer(check(e.popInt(),NumberNotNull))})),[ScriptOpcode_default.SPOTANIM_NPC]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),NumberNotNull),i=check(e.popInt(),NumberNotNull),n=check(e.popInt(),SpotAnimTypeValid);e.activeNpc.spotanim(n.id,i,t)})),[ScriptOpcode_default.NPC_FIND]:e=>{const[t,i,n,r]=e.popInts(4),a=check(t,CoordValid),s=check(i,NpcTypeValid);check(n,NumberNotNull);const o=check(r,HuntVisValid);let c,l=n;const d=new NpcIterator(World_default.currentTick,a.level,a.x,a.z,n,o,NpcIteratorType_default.DISTANCE);for(const e of d)if(e&&e.type===s.id){const t=Position.distanceToSW(a,e);t<=l&&(c=e,l=t)}c?(e.activeNpc=c,e.pointerAdd(ActiveNpc[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.NPC_FINDALLANY]:e=>{const[t,i,n]=e.popInts(3),r=check(t,CoordValid);check(i,NumberNotNull);const a=check(n,HuntVisValid);e.npcIterator=new NpcIterator(World_default.currentTick,r.level,r.x,r.z,i,a,NpcIteratorType_default.DISTANCE),e._activeNpc&&(e._activeNpc2=e._activeNpc,e.pointerAdd(ScriptPointer_default.ActiveNpc2))},[ScriptOpcode_default.NPC_FINDALLZONE]:e=>{const t=check(e.popInt(),CoordValid);e.npcIterator=new NpcIterator(World_default.currentTick,t.level,t.x,t.z,0,0,NpcIteratorType_default.ZONE),e._activeNpc&&(e._activeNpc2=e._activeNpc,e.pointerAdd(ScriptPointer_default.ActiveNpc2))},[ScriptOpcode_default.NPC_FINDNEXT]:e=>{const t=e.npcIterator?.next();t&&!t.done?(e.activeNpc=t.value,e.pointerAdd(ActiveNpc[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.NPC_TELE]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),CoordValid);e.activeNpc.teleport(t.x,t.z,t.level)})),[ScriptOpcode_default.NPC_WALK]:checkedHandler(ActiveNpc,(e=>{const t=check(e.popInt(),CoordValid);e.activeNpc.queueWaypoint(t.x,t.z)})),[ScriptOpcode_default.NPC_CHANGETYPE]:checkedHandler(ActiveNpc,(e=>{e.activeNpc.changeType(check(e.popInt(),NpcTypeValid).id)})),[ScriptOpcode_default.NPC_GETMODE]:checkedHandler(ActiveNpc,(e=>{e.pushInt(e.activeNpc.targetOp)})),[ScriptOpcode_default.NPC_HEROPOINTS]:checkedHandler([ScriptPointer_default.ActivePlayer,...ActiveNpc],(e=>{e.activeNpc.addHero(e.activePlayer.uid,check(e.popInt(),NumberNotNull))})),[ScriptOpcode_default.NPC_WALKTRIGGER]:checkedHandler(ActiveNpc,(e=>{const[t,i]=e.popInts(2);check(t,QueueValid),e.activeNpc.walktrigger=t-1,e.activeNpc.walktriggerArg=i})),[ScriptOpcode_default.NPC_STATADD]:checkedHandler(ActiveNpc,(e=>{const[t,i,n]=e.popInts(3);check(t,NpcStatValid),check(i,NumberNotNull),check(n,NumberNotNull);const r=e.activeNpc,a=r.levels[t],s=a+(i+a*n/100);r.levels[t]=Math.min(s,255),0===t&&r.levels[t]>=r.baseLevels[t]&&r.resetHeroPoints()})),[ScriptOpcode_default.NPC_STATSUB]:checkedHandler(ActiveNpc,(e=>{const[t,i,n]=e.popInts(3);check(t,NpcStatValid),check(i,NumberNotNull),check(n,NumberNotNull);const r=e.activeNpc,a=r.levels[t],s=a-(i+a*n/100);r.levels[t]=Math.max(s,0)})),[ScriptOpcode_default.NPC_ATTACKRANGE]:checkedHandler(ActiveNpc,(e=>{e.pushInt(check(e.activeNpc.type,NpcTypeValid).attackrange)}))},NpcOps_default=NpcOps,NpcConfigOps={[ScriptOpcode_default.NC_NAME]:e=>{const t=check(e.popInt(),NpcTypeValid);e.pushString(t.name??t.debugname??"null")},[ScriptOpcode_default.NC_PARAM]:e=>{const[t,i]=e.popInts(2),n=check(t,NpcTypeValid),r=check(i,ParamTypeValid);r.isString()?e.pushString(ParamHelper.getStringParam(i,n,r.defaultString)):e.pushInt(ParamHelper.getIntParam(i,n,r.defaultInt))},[ScriptOpcode_default.NC_CATEGORY]:e=>{e.pushInt(check(e.popInt(),NpcTypeValid).category)},[ScriptOpcode_default.NC_DESC]:e=>{e.pushString(check(e.popInt(),NpcTypeValid).desc??"null")},[ScriptOpcode_default.NC_DEBUGNAME]:e=>{e.pushString(check(e.popInt(),NpcTypeValid).debugname??"null")},[ScriptOpcode_default.NC_OP]:e=>{const[t,i]=e.popInts(2),n=check(t,NpcTypeValid);check(i,NumberNotNull),n.op?e.pushString(n.op[i-1]??""):e.pushString("")}},NpcConfigOps_default=NpcConfigOps;class Trig{static _sin=new Int32Array(16384);static _cos=new Int32Array(16384);static{const e=.0003834951969714103;for(let t=0;t<16384;t++)this._sin[t]=16384*Math.sin(t*e)|0,this._cos[t]=16384*Math.cos(t*e)|0}static radians(e){return(16383&e)/16384*6.283185307179586}static atan2(e,t){return 16383&Math.round(2607.5945876176133*Math.atan2(e,t))}static sin(e){return this._sin[16383&e]}static cos(e){return this._cos[16383&e]}}var MoveSpeed,NumberOps={[ScriptOpcode_default.ADD]:e=>{const t=e.popInt(),i=e.popInt();e.pushInt(i+t)},[ScriptOpcode_default.SUB]:e=>{const t=e.popInt(),i=e.popInt();e.pushInt(i-t)},[ScriptOpcode_default.MULTIPLY]:e=>{const t=e.popInt(),i=e.popInt();e.pushInt(i*t)},[ScriptOpcode_default.DIVIDE]:e=>{const t=e.popInt(),i=e.popInt();e.pushInt(i/t)},[ScriptOpcode_default.RANDOM]:e=>{const t=e.popInt();e.pushInt(Math.random()*t)},[ScriptOpcode_default.RANDOMINC]:e=>{const t=e.popInt();e.pushInt(Math.random()*(t+1))},[ScriptOpcode_default.INTERPOLATE]:e=>{const[t,i,n,r,a]=e.popInts(5),s=Math.floor((i-t)/(r-n))*(a-n)+t;e.pushInt(s)},[ScriptOpcode_default.ADDPERCENT]:e=>{const[t,i]=e.popInts(2);e.pushInt(t*i/100+t|0)},[ScriptOpcode_default.SETBIT]:e=>{const[t,i]=e.popInts(2);e.pushInt(t|1<<i)},[ScriptOpcode_default.CLEARBIT]:e=>{const[t,i]=e.popInts(2);e.pushInt(t&~(1<<i))},[ScriptOpcode_default.TESTBIT]:e=>{const[t,i]=e.popInts(2);e.pushInt(t&1<<i?1:0)},[ScriptOpcode_default.MODULO]:e=>{const[t,i]=e.popInts(2);e.pushInt(t%i)},[ScriptOpcode_default.POW]:e=>{const[t,i]=e.popInts(2);e.pushInt(Math.pow(t,i))},[ScriptOpcode_default.INVPOW]:e=>{const[t,i]=e.popInts(2);if(0===t||0===i)e.pushInt(0);else switch(i){case 1:return void e.pushInt(t);case 2:return void e.pushInt(Math.sqrt(t));case 3:return void e.pushInt(Math.cbrt(t));case 4:return void e.pushInt(Math.sqrt(Math.sqrt(t)));default:return void e.pushInt(Math.pow(t,1/i))}},[ScriptOpcode_default.AND]:e=>{const[t,i]=e.popInts(2);e.pushInt(t&i)},[ScriptOpcode_default.OR]:e=>{const[t,i]=e.popInts(2);e.pushInt(t|i)},[ScriptOpcode_default.MIN]:e=>{const[t,i]=e.popInts(2);e.pushInt(Math.min(t,i))},[ScriptOpcode_default.MAX]:e=>{const[t,i]=e.popInts(2);e.pushInt(Math.max(t,i))},[ScriptOpcode_default.SCALE]:e=>{const[t,i,n]=e.popInts(3);e.pushInt(t*n/i)},[ScriptOpcode_default.BITCOUNT]:e=>{e.pushInt(bitcount(e.popInt()))},[ScriptOpcode_default.TOGGLEBIT]:e=>{const[t,i]=e.popInts(2);e.pushInt(t^1<<i)},[ScriptOpcode_default.SETBIT_RANGE]:e=>{const[t,i,n]=e.popInts(3);e.pushInt(setBitRange(t,i,n))},[ScriptOpcode_default.CLEARBIT_RANGE]:e=>{const[t,i,n]=e.popInts(3);e.pushInt(clearBitRange(t,i,n))},[ScriptOpcode_default.GETBIT_RANGE]:e=>{const[t,i,n]=e.popInts(3),r=31-n;e.pushInt(t<<r>>>i+r)},[ScriptOpcode_default.SETBIT_RANGE_TOINT]:e=>{const[t,i,n,r]=e.popInts(4),a=clearBitRange(t,n,r),s=MASK[r-n+1];let o=i;i>s&&(o=s),e.pushInt(a|o<<n)},[ScriptOpcode_default.SIN_DEG]:e=>{e.pushInt(Trig.sin(e.popInt()))},[ScriptOpcode_default.COS_DEG]:e=>{e.pushInt(Trig.cos(e.popInt()))},[ScriptOpcode_default.ATAN2_DEG]:e=>{e.pushInt(Trig.atan2(e.popInt(),e.popInt()))},[ScriptOpcode_default.ABS]:e=>{e.pushInt(Math.abs(e.popInt()))}},NumberOps_default=NumberOps,ObjOps={[ScriptOpcode_default.OBJ_ADD]:e=>{const[t,i,n,r]=e.popInts(4);if(-1===i||-1===n)return;const a=check(i,ObjTypeValid);check(r,DurationValid);const s=check(t,CoordValid);if(check(n,ObjStackValid),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);const o=new Obj(s.level,s.x,s.z,EntityLifeCycle_default.DESPAWN,i,n);World_default.addObj(o,e.activePlayer.pid,r),e.activeObj=o,e.pointerAdd(ActiveObj[e.intOperand]),Environment_default.CLIRUNNER&&e.activePlayer.invAdd(InvType.getByName("bank").id,i,n)},[ScriptOpcode_default.OBJ_ADDALL]:e=>{const[t,i,n,r]=e.popInts(4);if(-1===i||-1===n)return;const a=check(i,ObjTypeValid);check(r,DurationValid);const s=check(t,CoordValid);if(check(n,ObjStackValid),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);const o=new Obj(s.level,s.x,s.z,EntityLifeCycle_default.DESPAWN,i,n);World_default.addObj(o,-1,r),e.activeObj=o,e.pointerAdd(ActiveObj[e.intOperand])},[ScriptOpcode_default.OBJ_PARAM]:e=>{const t=check(e.popInt(),ParamTypeValid),i=check(e.activeObj.type,ObjTypeValid);t.isString()?e.pushString(ParamHelper.getStringParam(t.id,i,t.defaultString)):e.pushInt(ParamHelper.getIntParam(t.id,i,t.defaultInt))},[ScriptOpcode_default.OBJ_NAME]:e=>{const t=check(e.activeObj.type,ObjTypeValid);e.pushString(t.name??t.debugname??"null")},[ScriptOpcode_default.OBJ_DEL]:e=>{const t=ObjType.get(e.activeObj.type).respawnrate;e.pointerGet(ActivePlayer[e.intOperand]),World_default.removeObj(e.activeObj,t)},[ScriptOpcode_default.OBJ_COUNT]:e=>{e.pushInt(check(e.activeObj.count,ObjStackValid))},[ScriptOpcode_default.OBJ_TYPE]:e=>{e.pushInt(check(e.activeObj.type,ObjTypeValid).id)},[ScriptOpcode_default.OBJ_TAKEITEM]:e=>{const t=check(e.popInt(),InvTypeValid),i=e.activeObj,n=ObjType.get(i.type),r=World_default.getZone(i.x,i.z,i.level);for(const a of r.getObjsSafe(Position.packZoneCoord(i.x,i.z)))if(a.type===i.type&&a.count===i.count&&(-1===a.receiverId||a.receiverId===e.activePlayer.pid)){if(e.activePlayer.playerLog("Picked up item",n.debugname),e.activePlayer.invAdd(t.id,i.type,i.count),i.lifecycle===EntityLifeCycle_default.RESPAWN){World_default.removeObj(i,n.respawnrate);break}if(i.lifecycle===EntityLifeCycle_default.DESPAWN){World_default.removeObj(i,0);break}}},[ScriptOpcode_default.OBJ_COORD]:e=>{const t=e.activeObj;e.pushInt(Position.packCoord(t.level,t.x,t.z))}},ObjOps_default=ObjOps,ObjConfigOps={[ScriptOpcode_default.OC_NAME]:e=>{const t=check(e.popInt(),ObjTypeValid);e.pushString(t.name??t.debugname??"null")},[ScriptOpcode_default.OC_PARAM]:e=>{const[t,i]=e.popInts(2),n=check(t,ObjTypeValid),r=check(i,ParamTypeValid);r.isString()?e.pushString(ParamHelper.getStringParam(r.id,n,r.defaultString)):e.pushInt(ParamHelper.getIntParam(r.id,n,r.defaultInt))},[ScriptOpcode_default.OC_CATEGORY]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).category)},[ScriptOpcode_default.OC_DESC]:e=>{e.pushString(check(e.popInt(),ObjTypeValid).desc??"null")},[ScriptOpcode_default.OC_MEMBERS]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).members?1:0)},[ScriptOpcode_default.OC_WEIGHT]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).weight)},[ScriptOpcode_default.OC_WEARPOS]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).wearpos)},[ScriptOpcode_default.OC_WEARPOS2]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).wearpos2)},[ScriptOpcode_default.OC_WEARPOS3]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).wearpos3)},[ScriptOpcode_default.OC_COST]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).cost)},[ScriptOpcode_default.OC_TRADEABLE]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).tradeable?1:0)},[ScriptOpcode_default.OC_DEBUGNAME]:e=>{e.pushString(check(e.popInt(),ObjTypeValid).debugname??"null")},[ScriptOpcode_default.OC_CERT]:e=>{const t=check(e.popInt(),ObjTypeValid);-1==t.certtemplate&&t.certlink>=0?e.pushInt(t.certlink):e.pushInt(t.id)},[ScriptOpcode_default.OC_UNCERT]:e=>{const t=check(e.popInt(),ObjTypeValid);t.certtemplate>=0&&t.certlink>=0?e.pushInt(t.certlink):e.pushInt(t.id)},[ScriptOpcode_default.OC_STACKABLE]:e=>{e.pushInt(check(e.popInt(),ObjTypeValid).stackable?1:0)}},ObjConfigOps_default=ObjConfigOps;class EntityQueueRequest extends Linkable{type;script;args;delay;lastInt=0;constructor(e,t,i,n){super(),this.type=e,this.script=t,this.args=i,this.delay=n}}class EntityQueueState extends Linkable{script;delay;constructor(e,t){super(),this.script=e,this.delay=t}}class ServerProt{id;length;static all=[];static byId=[];static IF_OPENCHATMODAL=new ServerProt(14,2);static IF_OPENMAINSIDEMODAL=new ServerProt(28,4);static IF_CLOSE=new ServerProt(129,0);static IF_OPENSIDEOVERLAY=new ServerProt(167,3);static IF_OPENMAINMODAL=new ServerProt(168,2);static IF_OPENSIDEMODAL=new ServerProt(195,2);static IF_SETCOLOUR=new ServerProt(2,4);static IF_SETHIDE=new ServerProt(26,3);static IF_SETOBJECT=new ServerProt(46,6);static IF_SHOWSIDE=new ServerProt(84,1);static IF_SETMODEL=new ServerProt(87,4);static IF_SETRECOL=new ServerProt(103,6);static IF_SETANIM=new ServerProt(146,4);static IF_SETPLAYERHEAD=new ServerProt(197,2);static IF_SETTEXT=new ServerProt(201,-2);static IF_SETNPCHEAD=new ServerProt(204,4);static IF_SETPOSITION=new ServerProt(209,6);static TUTORIAL_FLASHSIDE=new ServerProt(126,1);static TUTORIAL_OPENCHAT=new ServerProt(185,2);static UPDATE_INV_STOP_TRANSMIT=new ServerProt(15,2);static UPDATE_INV_FULL=new ServerProt(98,-2);static UPDATE_INV_PARTIAL=new ServerProt(213,-2);static CAM_LOOKAT=new ServerProt(74,6);static CAM_SHAKE=new ServerProt(13,4);static CAM_MOVETO=new ServerProt(3,6);static CAM_RESET=new ServerProt(239,0);static NPC_INFO=new ServerProt(1,-2);static PLAYER_INFO=new ServerProt(184,-2);static FINISH_TRACKING=new ServerProt(133,0);static ENABLE_TRACKING=new ServerProt(226,0);static MESSAGE_GAME=new ServerProt(4,-1);static UPDATE_IGNORELIST=new ServerProt(21,-2);static CHAT_FILTER_SETTINGS=new ServerProt(32,3);static MESSAGE_PRIVATE=new ServerProt(41,-1);static UPDATE_FRIENDLIST=new ServerProt(152,9);static UNSET_MAP_FLAG=new ServerProt(19,0);static UPDATE_RUNWEIGHT=new ServerProt(22,2);static HINT_ARROW=new ServerProt(25,6);static UPDATE_REBOOT_TIMER=new ServerProt(43,2);static UPDATE_STAT=new ServerProt(44,6);static UPDATE_RUNENERGY=new ServerProt(68,1);static RESET_ANIMS=new ServerProt(136,0);static UPDATE_UID192=new ServerProt(139,2);static LAST_LOGIN_INFO=new ServerProt(140,9);static LOGOUT=new ServerProt(142,0);static P_COUNTDIALOG=new ServerProt(243,0);static SET_MULTIWAY=new ServerProt(254,1);static DATA_LOC_DONE=new ServerProt(20,2);static DATA_LAND_DONE=new ServerProt(80,2);static DATA_LAND=new ServerProt(132,-2);static DATA_LOC=new ServerProt(220,-2);static REBUILD_NORMAL=new ServerProt(237,-2);static VARP_SMALL=new ServerProt(150,3);static VARP_LARGE=new ServerProt(175,6);static RESET_CLIENT_VARCACHE=new ServerProt(193,0);static SYNTH_SOUND=new ServerProt(12,5);static MIDI_SONG=new ServerProt(54,-1);static MIDI_JINGLE=new ServerProt(212,-2);static UPDATE_ZONE_PARTIAL_FOLLOWS=new ServerProt(7,2);static UPDATE_ZONE_FULL_FOLLOWS=new ServerProt(135,2);static UPDATE_ZONE_PARTIAL_ENCLOSED=new ServerProt(162,-2);constructor(e,t){this.id=e,this.length=t,ServerProt.all.push(this),ServerProt.byId[e]=this}}(e=>{e[e.STATIONARY=0]="STATIONARY",e[e.CRAWL=1]="CRAWL",e[e.WALK=2]="WALK",e[e.RUN=3]="RUN",e[e.INSTANT=4]="INSTANT"})(MoveSpeed||={});var MoveStrategy,MoveSpeed_default=MoveSpeed;(e=>{e[e.SMART=0]="SMART",e[e.NAIVE=1]="NAIVE",e[e.FLY=2]="FLY"})(MoveStrategy||={});var MoveStrategy_default=MoveStrategy;class PathingEntity extends Entity{moveRestrict;blockWalk;moveStrategy;coordmask;entitymask;moveSpeed=MoveSpeed_default.INSTANT;walkDir=-1;runDir=-1;waypointIndex=-1;waypoints=new Int32Array(25);lastX=-1;lastZ=-1;tele=!1;jump=!1;lastStepX=-1;lastStepZ=-1;stepsTaken=0;lastInt=-1;lastCrawl=!1;walktrigger=-1;walktriggerArg=0;orientation=Direction.SOUTH;interacted=!1;repathed=!1;target=null;targetOp=-1;targetSubject={type:-1,com:-1};targetX=-1;targetZ=-1;apRange=10;apRangeCalled=!1;alreadyFacedCoord=!1;alreadyFacedEntity=!1;mask=0;exactStartX=-1;exactStartZ=-1;exactEndX=-1;exactEndZ=-1;exactMoveStart=-1;exactMoveEnd=-1;exactMoveDirection=-1;faceX=-1;faceZ=-1;faceEntity=-1;damageTaken=-1;damageType=-1;animId=-1;animDelay=-1;chat=null;graphicId=-1;graphicHeight=-1;graphicDelay=-1;constructor(e,t,i,n,r,a,s,o,c,l,d){super(e,t,i,n,r,a),this.moveRestrict=s,this.blockWalk=o,this.moveStrategy=c,this.coordmask=l,this.entitymask=d,this.lastStepX=t-1,this.lastStepZ=i}processMovement(){return!(!this.hasWaypoints()||this.moveSpeed===MoveSpeed_default.STATIONARY||this.moveSpeed===MoveSpeed_default.INSTANT)&&(this.moveSpeed===MoveSpeed_default.CRAWL?(this.lastCrawl=!this.lastCrawl,this.lastCrawl&&-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep()),!0):(-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep(),this.moveSpeed===MoveSpeed_default.RUN&&-1!==this.walkDir&&-1===this.runDir&&(this.runDir=this.validateAndAdvanceStep())),!0))}refreshZonePresence(e,t,i){if(this.x!=e||this.z!==t||this.level!==i){switch(this.blockWalk){case BlockWalk_default.NPC:World_default.gameMap.changeNpcCollision(this.width,e,t,i,!1),World_default.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0);break;case BlockWalk_default.ALL:World_default.gameMap.changeNpcCollision(this.width,e,t,i,!1),World_default.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0),World_default.gameMap.changePlayerCollision(this.width,e,t,i,!1),World_default.gameMap.changePlayerCollision(this.width,this.x,this.z,this.level,!0)}this.lastStepX=e,this.lastStepZ=t}Position.zone(e)===Position.zone(this.x)&&Position.zone(t)===Position.zone(this.z)&&i==this.level||(World_default.getZone(e,t,i).leave(this),World_default.getZone(this.x,this.z,this.level).enter(this))}validateAndAdvanceStep(){const e=this.takeStep();if(null===e)return-1;if(-1===e)return this.waypointIndex--,-1!=this.waypointIndex?this.validateAndAdvanceStep():-1;const t=this.x,i=this.z;return this.x=Position.moveX(this.x,e),this.z=Position.moveZ(this.z,e),this.orientation=e,this.stepsTaken++,this.refreshZonePresence(t,i,this.level),e}queueWaypoint(e,t){this.waypoints[0]=Position.packCoord(0,e,t),this.waypointIndex=0}queueWaypoints(e){let t=-1;for(let i=e.length-1,n=0;i>=0&&n<this.waypoints.length;i--,n++)this.waypoints[n]=e[i],t++;this.waypointIndex=t}clearWaypoints(){this.waypointIndex=-1}teleJump(e,t,i){this.teleport(e,t,i),this.jump=!0}teleport(e,t,i){isNaN(i)&&(i=0),i=Math.max(0,Math.min(i,3));const n=this.x,r=this.z,a=this.level;this.x=e,this.z=t,this.level=i,this.refreshZonePresence(n,r,a),this.lastStepX=this.x-1,this.lastStepZ=this.z,this.moveSpeed=MoveSpeed_default.INSTANT,a!=i&&(this.jump=!0)}validateDistanceWalked(){Position.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length})>2&&(this.jump=!0)}convertMovementDir(){let e=this.walkDir,t=this.runDir,i=this.moveSpeed===MoveSpeed_default.INSTANT;const n=Position.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length});if(i&&!this.jump&&n<=2){if(2===n){const i=(this.x+this.lastX)/2|0,n=(this.z+this.lastZ)/2|0;e=Position.face(this.lastX,this.lastZ,i,n),t=Position.face(i,n,this.x,this.z)}else e=Position.face(this.lastX,this.lastZ,this.x,this.z),t=-1;i=!1}this.walkDir=e,this.runDir=t,this.tele=i}hasWaypoints(){return-1!==this.waypointIndex}isLastOrNoWaypoint(){return this.waypointIndex<=0}inOperableDistance(e){if(e.level!==this.level)return!1;if(e instanceof PathingEntity)return reached(this.level,this.x,this.z,e.x,e.z,e.width,e.length,this.width,e.orientation,-2);if(e instanceof Loc){const t=LocType.get(e.type).forceapproach;return reached(this.level,this.x,this.z,e.x,e.z,e.width,e.length,this.width,e.angle,e.shape,t)}const t=reached(this.level,this.x,this.z,e.x,e.z,e.width,e.length,this.width,0,-2);return isFlagged(e.x,e.z,e.level,CollisionFlag.WALK_BLOCKED)?t:!(this.hasWaypoints()||!t)||reached(this.level,this.x,this.z,e.x,e.z,e.width,e.length,this.width,0,-1)}inApproachDistance(e,t){return t.level===this.level&&(!(t instanceof PathingEntity&&Position.intersects(this.x,this.z,this.width,this.length,t.x,t.z,t.width,t.length))&&(Position.distanceTo(this,t)<=e&&hasLineOfSight(this.level,this.x,this.z,t.x,t.z,this.width,this.length,t.width,t.length,CollisionFlag.PLAYER)))}pathToMoveClick(e,t){if(this.moveStrategy===MoveStrategy_default.SMART)if(t){const{x:t,z:i}=Position.unpackCoord(e[0]);this.queueWaypoints(findPath(this.level,this.x,this.z,t,i))}else this.queueWaypoints(e);else{const{x:t,z:i}=Position.unpackCoord(e[e.length-1]);this.queueWaypoint(t,i)}}pathToPathingTarget(){this.target&&this.target instanceof PathingEntity&&this.isLastOrNoWaypoint()&&(this.targetOp!==ServerTriggerType_default.APPLAYER3&&this.targetOp!==ServerTriggerType_default.OPPLAYER3?this.pathToTarget():this.queueWaypoint(this.target.lastStepX,this.target.lastStepZ))}pathToTarget(){if(this.target)if(this.targetX=this.target.x,this.targetZ=this.target.z,this.moveStrategy===MoveStrategy_default.SMART)if(this.target instanceof PathingEntity)this.queueWaypoints(findPath(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.orientation,-2));else if(this.target instanceof Loc){const e=LocType.get(this.target.type).forceapproach;this.queueWaypoints(findPath(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.angle,this.target.shape,!0,e))}else this.queueWaypoints(findPath(this.level,this.x,this.z,this.target.x,this.target.z));else if(this.moveStrategy===MoveStrategy_default.NAIVE){const e=this.getCollisionStrategy();if(null===e)return;const t=this.blockWalkFlag();if(t===CollisionFlag.NULL)return;this.target instanceof PathingEntity?this.queueWaypoints(findNaivePath(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.length,this.target.width,this.target.length,t,e)):this.queueWaypoint(this.target.x,this.target.z)}else{if(null===this.getCollisionStrategy())return;if(this.blockWalkFlag()===CollisionFlag.NULL)return;this.queueWaypoint(this.target.x,this.target.z)}}setInteraction(e,t,i,n){if(this.target=t,this.targetOp=i,this.targetSubject=n??{type:-1,com:-1},this.targetX=t.x,this.targetZ=t.z,this.apRange=10,this.apRangeCalled=!1,t instanceof Player2){const e=t.pid+32768;this.faceEntity!==e&&(this.faceEntity=e,this.mask|=this.entitymask)}else if(t instanceof Npc2){const e=t.nid;this.faceEntity!==e&&(this.faceEntity=e,this.mask|=this.entitymask)}else{const e=2*t.x+t.width,i=2*t.z+t.length;this.faceX===e&&this.faceZ===i||(this.faceX=e,this.faceZ=i,this.mask|=this.coordmask)}e===Interaction_default.SCRIPT&&this.pathToTarget()}clearInteraction(){this.target=null,this.targetOp=-1,this.targetSubject={type:-1,com:-1},this.targetX=-1,this.targetZ=-1,this.apRange=10,this.apRangeCalled=!1,this.alreadyFacedCoord=!0,this.alreadyFacedEntity=!0}getCollisionStrategy(){return this.moveRestrict===MoveRestrict_default.NORMAL?CollisionType.NORMAL:this.moveRestrict===MoveRestrict_default.BLOCKED?CollisionType.BLOCKED:this.moveRestrict===MoveRestrict_default.BLOCKED_NORMAL?CollisionType.LINE_OF_SIGHT:this.moveRestrict===MoveRestrict_default.INDOORS?CollisionType.INDOORS:this.moveRestrict===MoveRestrict_default.OUTDOORS?CollisionType.OUTDOORS:this.moveRestrict===MoveRestrict_default.NOMOVE?null:this.moveRestrict===MoveRestrict_default.PASSTHRU?CollisionType.NORMAL:null}resetPathingEntity(){this.moveSpeed=this.defaultMoveSpeed(),this.walkDir=-1,this.runDir=-1,this.jump=!1,this.tele=!1,this.lastX=this.x,this.lastZ=this.z,this.stepsTaken=0,this.interacted=!1,this.apRangeCalled=!1,this.mask=0,this.exactStartX=-1,this.exactStartZ=-1,this.exactEndX=-1,this.exactEndZ=-1,this.exactMoveStart=-1,this.exactMoveEnd=-1,this.exactMoveDirection=-1,this.animId=-1,this.animDelay=-1,this.animId=-1,this.animDelay=-1,this.chat=null,this.damageTaken=-1,this.damageType=-1,this.graphicId=-1,this.graphicHeight=-1,this.graphicDelay=-1,-1!==this.faceX?this.orientation=Position.face(this.x,this.z,this.faceX,this.faceZ):this.target&&(this.orientation=Position.face(this.x,this.z,this.target.x,this.target.z)),this.alreadyFacedCoord&&-1!==this.faceX&&!this.hasWaypoints()?(this.faceX=-1,this.faceZ=-1,this.alreadyFacedCoord=!1):this.alreadyFacedEntity&&!this.target&&-1!==this.faceEntity&&(this.mask|=this.entitymask,this.faceEntity=-1,this.alreadyFacedEntity=!1)}takeStep(){if(-1===this.waypointIndex)return null;const e=this.x,t=this.z,{x:i,z:n}=Position.unpackCoord(this.waypoints[this.waypointIndex]),r=Position.face(e,t,i,n),a=Position.deltaX(r),s=Position.deltaZ(r);if(0==a&&0==s)return-1;const o=this.getCollisionStrategy();if(null===o)return-1;const c=this.blockWalkFlag();return c===CollisionFlag.NULL?-1:this.moveStrategy===MoveStrategy_default.FLY||canTravel(this.level,this.x,this.z,a,s,this.width,c,o)?r:0!=a&&canTravel(this.level,this.x,this.z,a,0,this.width,c,o)?Position.face(e,t,i,t):0!=s&&canTravel(this.level,this.x,this.z,0,s,this.width,c,o)?Position.face(e,t,e,n):null}}class Stack{sentinel;cursor=null;constructor(){const e=new Hashable;e.nextHashable=e,e.prevHashable=e,this.sentinel=e}push(e){e.prevHashable&&e.uncache(),e.prevHashable=this.sentinel.prevHashable,e.nextHashable=this.sentinel,e.prevHashable&&(e.prevHashable.nextHashable=e),e.nextHashable.prevHashable=e}pop(){const e=this.sentinel.nextHashable;return e===this.sentinel?null:(e?.uncache(),e)}head(){const e=this.sentinel.nextHashable;return e===this.sentinel?(this.cursor=null,null):(this.cursor=e?.nextHashable||null,e)}next(){const e=this.cursor;return e===this.sentinel?(this.cursor=null,null):(this.cursor=e?.nextHashable||null,e)}}async function preloadClient(){const e=["l29_75","l30_75","l31_75","l32_70","l32_71","l32_72","l32_73","l32_74","l32_75","l33_70","l33_71","l33_72","l33_73","l33_74","l33_75","l33_76","l34_70","l34_71","l34_72","l34_73","l34_74","l34_75","l34_76","l35_20","l35_75","l35_76","l36_146","l36_147","l36_148","l36_149","l36_150","l36_153","l36_154","l36_52","l36_53","l36_54","l36_72","l36_73","l36_74","l36_75","l36_76","l37_146","l37_147","l37_148","l37_149","l37_150","l37_151","l37_152","l37_153","l37_154","l37_48","l37_49","l37_50","l37_51","l37_52","l37_53","l37_54","l37_55","l37_72","l37_73","l37_74","l37_75","l38_146","l38_147","l38_148","l38_149","l38_150","l38_151","l38_152","l38_153","l38_154","l38_155","l38_45","l38_46","l38_47","l38_48","l38_49","l38_50","l38_51","l38_52","l38_53","l38_54","l38_55","l38_72","l38_73","l38_74","l39_147","l39_148","l39_149","l39_150","l39_151","l39_152","l39_153","l39_154","l39_155","l39_45","l39_46","l39_47","l39_48","l39_49","l39_50","l39_51","l39_52","l39_53","l39_54","l39_55","l39_72","l39_73","l39_74","l39_75","l39_76","l40_147","l40_148","l40_149","l40_150","l40_151","l40_152","l40_153","l40_154","l40_45","l40_46","l40_47","l40_48","l40_49","l40_50","l40_51","l40_52","l40_53","l40_54","l40_55","l40_72","l40_73","l40_74","l40_75","l40_76","l41_146","l41_149","l41_151","l41_152","l41_153","l41_154","l41_45","l41_46","l41_47","l41_48","l41_49","l41_50","l41_51","l41_52","l41_53","l41_54","l41_55","l41_56","l41_72","l41_73","l41_74","l41_75","l42_144","l42_145","l42_146","l42_151","l42_152","l42_153","l42_49","l42_50","l42_51","l42_52","l42_53","l42_54","l42_55","l42_56","l42_72","l42_73","l42_74","l42_75","l43_144","l43_145","l43_146","l43_153","l43_154","l43_45","l43_46","l43_47","l43_48","l43_49","l43_50","l43_51","l43_52","l43_53","l43_54","l43_55","l43_56","l43_72","l43_73","l43_74","l43_75","l44_144","l44_145","l44_146","l44_148","l44_149","l44_150","l44_151","l44_152","l44_153","l44_154","l44_155","l44_45","l44_46","l44_47","l44_48","l44_49","l44_50","l44_51","l44_52","l44_53","l44_54","l44_55","l44_72","l44_73","l44_74","l44_75","l45_145","l45_146","l45_148","l45_150","l45_151","l45_152","l45_153","l45_154","l45_155","l45_45","l45_46","l45_47","l45_48","l45_49","l45_50","l45_51","l45_52","l45_53","l45_54","l45_55","l45_56","l45_57","l45_58","l45_59","l45_60","l45_61","l45_62","l45_73","l45_74","l45_75","l45_76","l46_149","l46_150","l46_152","l46_153","l46_154","l46_161","l46_45","l46_46","l46_47","l46_48","l46_49","l46_50","l46_51","l46_52","l46_53","l46_54","l46_55","l46_56","l46_57","l46_58","l46_59","l46_60","l46_61","l46_62","l46_75","l47_148","l47_149","l47_150","l47_152","l47_153","l47_160","l47_161","l47_47","l47_48","l47_49","l47_50","l47_51","l47_52","l47_53","l47_54","l47_55","l47_56","l47_57","l47_58","l47_59","l47_60","l47_61","l47_62","l47_75","l48_148","l48_149","l48_152","l48_153","l48_154","l48_155","l48_156","l48_47","l48_48","l48_49","l48_50","l48_51","l48_52","l48_53","l48_54","l48_55","l48_56","l48_57","l48_58","l48_59","l48_60","l48_61","l48_62","l49_148","l49_149","l49_153","l49_154","l49_155","l49_156","l49_46","l49_47","l49_48","l49_49","l49_50","l49_51","l49_52","l49_53","l49_54","l49_55","l49_56","l49_57","l49_58","l49_59","l49_60","l49_61","l49_62","l50_149","l50_150","l50_152","l50_153","l50_154","l50_46","l50_47","l50_48","l50_49","l50_50","l50_51","l50_52","l50_53","l50_54","l50_55","l50_56","l50_57","l50_58","l50_59","l50_60","l50_61","l50_62","l51_147","l51_154","l51_46","l51_47","l51_48","l51_49","l51_50","l51_51","l51_52","l51_53","l51_54","l51_55","l51_56","l51_57","l51_58","l51_59","l51_60","l51_61","l51_62","l52_152","l52_153","l52_154","l52_46","l52_47","l52_48","l52_49","l52_50","l52_51","l52_52","l52_53","l52_54","l52_55","l52_56","l52_57","l52_58","l52_59","l52_60","l52_61","l52_62","l53_49","l53_50","l53_51","l53_52","l53_53","m29_75","m30_75","m31_75","m32_70","m32_71","m32_72","m32_73","m32_74","m32_75","m33_70","m33_71","m33_72","m33_73","m33_74","m33_75","m33_76","m34_70","m34_71","m34_72","m34_73","m34_74","m34_75","m34_76","m35_20","m35_75","m35_76","m36_146","m36_147","m36_148","m36_149","m36_150","m36_153","m36_154","m36_52","m36_53","m36_54","m36_72","m36_73","m36_74","m36_75","m36_76","m37_146","m37_147","m37_148","m37_149","m37_150","m37_151","m37_152","m37_153","m37_154","m37_48","m37_49","m37_50","m37_51","m37_52","m37_53","m37_54","m37_55","m37_72","m37_73","m37_74","m37_75","m38_146","m38_147","m38_148","m38_149","m38_150","m38_151","m38_152","m38_153","m38_154","m38_155","m38_45","m38_46","m38_47","m38_48","m38_49","m38_50","m38_51","m38_52","m38_53","m38_54","m38_55","m38_72","m38_73","m38_74","m39_147","m39_148","m39_149","m39_150","m39_151","m39_152","m39_153","m39_154","m39_155","m39_45","m39_46","m39_47","m39_48","m39_49","m39_50","m39_51","m39_52","m39_53","m39_54","m39_55","m39_72","m39_73","m39_74","m39_75","m39_76","m40_147","m40_148","m40_149","m40_150","m40_151","m40_152","m40_153","m40_154","m40_45","m40_46","m40_47","m40_48","m40_49","m40_50","m40_51","m40_52","m40_53","m40_54","m40_55","m40_72","m40_73","m40_74","m40_75","m40_76","m41_146","m41_149","m41_151","m41_152","m41_153","m41_154","m41_45","m41_46","m41_47","m41_48","m41_49","m41_50","m41_51","m41_52","m41_53","m41_54","m41_55","m41_56","m41_72","m41_73","m41_74","m41_75","m42_144","m42_145","m42_146","m42_151","m42_152","m42_153","m42_49","m42_50","m42_51","m42_52","m42_53","m42_54","m42_55","m42_56","m42_72","m42_73","m42_74","m42_75","m43_144","m43_145","m43_146","m43_153","m43_154","m43_45","m43_46","m43_47","m43_48","m43_49","m43_50","m43_51","m43_52","m43_53","m43_54","m43_55","m43_56","m43_72","m43_73","m43_74","m43_75","m44_144","m44_145","m44_146","m44_148","m44_149","m44_150","m44_151","m44_152","m44_153","m44_154","m44_155","m44_45","m44_46","m44_47","m44_48","m44_49","m44_50","m44_51","m44_52","m44_53","m44_54","m44_55","m44_72","m44_73","m44_74","m44_75","m45_145","m45_146","m45_148","m45_150","m45_151","m45_152","m45_153","m45_154","m45_155","m45_45","m45_46","m45_47","m45_48","m45_49","m45_50","m45_51","m45_52","m45_53","m45_54","m45_55","m45_56","m45_57","m45_58","m45_59","m45_60","m45_61","m45_62","m45_73","m45_74","m45_75","m45_76","m46_149","m46_150","m46_152","m46_153","m46_154","m46_161","m46_45","m46_46","m46_47","m46_48","m46_49","m46_50","m46_51","m46_52","m46_53","m46_54","m46_55","m46_56","m46_57","m46_58","m46_59","m46_60","m46_61","m46_62","m46_75","m47_148","m47_149","m47_150","m47_152","m47_153","m47_160","m47_161","m47_47","m47_48","m47_49","m47_50","m47_51","m47_52","m47_53","m47_54","m47_55","m47_56","m47_57","m47_58","m47_59","m47_60","m47_61","m47_62","m47_75","m48_148","m48_149","m48_152","m48_153","m48_154","m48_155","m48_156","m48_47","m48_48","m48_49","m48_50","m48_51","m48_52","m48_53","m48_54","m48_55","m48_56","m48_57","m48_58","m48_59","m48_60","m48_61","m48_62","m49_148","m49_149","m49_153","m49_154","m49_155","m49_156","m49_46","m49_47","m49_48","m49_49","m49_50","m49_51","m49_52","m49_53","m49_54","m49_55","m49_56","m49_57","m49_58","m49_59","m49_60","m49_61","m49_62","m50_149","m50_150","m50_152","m50_153","m50_154","m50_46","m50_47","m50_48","m50_49","m50_50","m50_51","m50_52","m50_53","m50_54","m50_55","m50_56","m50_57","m50_58","m50_59","m50_60","m50_61","m50_62","m51_147","m51_154","m51_46","m51_47","m51_48","m51_49","m51_50","m51_51","m51_52","m51_53","m51_54","m51_55","m51_56","m51_57","m51_58","m51_59","m51_60","m51_61","m51_62","m52_152","m52_153","m52_154","m52_46","m52_47","m52_48","m52_49","m52_50","m52_51","m52_52","m52_53","m52_54","m52_55","m52_56","m52_57","m52_58","m52_59","m52_60","m52_61","m52_62","m53_49","m53_50","m53_51","m53_52","m53_53"];for(let t=0;t<e.length;t++){const i=e[t],n=new Uint8Array(await(await fetch(`data/pack/client/maps/${i}`)).arrayBuffer()),r=Packet.getcrc(n,0,n.length);PRELOADED.set(i,n),PRELOADED_CRC.set(i,r)}const t=["adventure.mid","al_kharid.mid","alone.mid","ambience_2.mid","ambience_3.mid","ambience_4.mid","ambient_jungle.mid","arabian.mid","arabian2.mid","arabian3.mid","arabique.mid","army_of_darkness.mid","arrival.mid","attack1.mid","attack2.mid","attack3.mid","attack4.mid","attack5.mid","attack6.mid","attention.mid","autumn_voyage.mid","background2.mid","ballad_of_enchantment.mid","baroque.mid","beyond.mid","big_chords.mid","book_of_spells.mid","camelot.mid","cave_background1.mid","cavern.mid","cellar_song1.mid","chain_of_command.mid","chompy_hunt.mid","close_quarters.mid","crystal_cave.mid","crystal_sword.mid","cursed.mid","dangerous.mid","dark2.mid","deep_wildy.mid","desert_voyage.mid","doorways.mid","dream1.mid","duel_arena.mid","dunjun.mid","egypt.mid","emotion.mid","emperor.mid","escape.mid","expanse.mid","expecting.mid","expedition.mid","fade_test.mid","faerie.mid","fanfare.mid","fanfare2.mid","fanfare3.mid","fishing.mid","flute_salad.mid","forbidden.mid","forever.mid","game_intro_1.mid","gaol.mid","garden.mid","gnome.mid","gnome_king.mid","gnome_theme.mid","gnome_village.mid","gnome_village2.mid","gnomeball.mid","greatness.mid","grumpy.mid","harmony.mid","harmony2.mid","heart_and_mind.mid","high_seas.mid","horizon.mid","iban.mid","ice_melody.mid","in_the_manor.mid","inspiration.mid","intrepid.mid","jolly-r.mid","jungle_island.mid","jungly1.mid","jungly2.mid","jungly3.mid","knightly.mid","landlubber.mid","lasting.mid","legion.mid","lightness.mid","lightwalk.mid","lonesome.mid","long_ago.mid","long_way_home.mid","lullaby.mid","mage_arena.mid","magic_dance.mid","magical_journey.mid","march2.mid","medieval.mid","mellow.mid","miles_away.mid","miracle_dance.mid","monarch_waltz.mid","moody.mid","neverland.mid","newbie_melody.mid","nightfall.mid","nomad.mid","null.mid","organ_music_1.mid","organ_music_2.mid","oriental.mid","overture.mid","parade.mid","quest.mid","regal2.mid","reggae.mid","reggae2.mid","riverside.mid","royale.mid","rune_essence.mid","sad_meadow.mid","scape_cave.mid","scape_main.mid","scape_sad1.mid","scape_soft.mid","scape_wild1.mid","sea_shanty.mid","sea_shanty2.mid","serenade.mid","serene.mid","shine.mid","shining.mid","silence.mid","soundscape.mid","spirit.mid","splendour.mid","spooky2.mid","spooky_jungle.mid","starlight.mid","start.mid","still_night.mid","talking_forest.mid","the_desert.mid","the_shadow.mid","the_tower.mid","theme.mid","tomorrow.mid","trawler.mid","trawler_minor.mid","tree_spirits.mid","tribal.mid","tribal2.mid","tribal_background.mid","trinity.mid","troubled.mid","undercurrent.mid","underground.mid","understanding.mid","unknown_land.mid","upass1.mid","upcoming.mid","venture.mid","venture2.mid","vision.mid","voodoo_cult.mid","voyage.mid","wander.mid","waterfall.mid","wilderness2.mid","wilderness3.mid","wilderness4.mid","witching.mid","wolf_mountain.mid","wonder.mid","wonderous.mid","workshop.mid","yesteryear.mid","zealot.mid"];for(let e=0;e<t.length;e++){const i=t[e],n=new Uint8Array(await(await fetch(`data/pack/client/songs/${i}`)).arrayBuffer()),r=Packet.getcrc(n,0,n.length);PRELOADED.set(i,n),PRELOADED_CRC.set(i,r)}const i=["advance agility.mid","advance attack.mid","advance attack2.mid","advance cooking.mid","advance cooking2.mid","advance crafting.mid","advance crafting2.mid","advance defense.mid","advance defense2.mid","advance firemarking.mid","advance firemarking2.mid","advance fishing.mid","advance fishing2.mid","advance fletching.mid","advance fletching2.mid","advance herblaw.mid","advance herblaw2.mid","advance hitpoints.mid","advance hitpoints2.mid","advance magic.mid","advance magic2.mid","advance mining.mid","advance mining2.mid","advance prayer.mid","advance prayer2.mid","advance ranged.mid","advance ranged2.mid","advance runecraft.mid","advance runecraft2.mid","advance smithing.mid","advance smithing2.mid","advance strength.mid","advance strength2.mid","advance thieving.mid","advance thieving2.mid","advance woodcutting.mid","advance woodcutting2.mid","death.mid","death2.mid","dice lose.mid","dice win.mid","duel start.mid","duel win2.mid","quest complete 1.mid","quest complete 2.mid","quest complete 3.mid","sailing journey.mid","treasure hunt win.mid"];for(let e=0;e<i.length;e++){const t=i[e],n=new Uint8Array(await(await fetch(`data/pack/client/jingles/${t}`)).arrayBuffer()).subarray(4),r=Packet.getcrc(n,0,n.length);PRELOADED.set(t,n),PRELOADED_CRC.set(t,r)}}var ZoneEventType,PRELOADED=new Map,PRELOADED_CRC=new Map;class OutgoingMessage extends Hashable{}class ServerProtPriority{static LOW=new ServerProtPriority;static HIGH=new ServerProtPriority}class IfClose extends OutgoingMessage{priority=ServerProtPriority.LOW}class UpdateUid192 extends OutgoingMessage{uid;priority=ServerProtPriority.HIGH;constructor(e){super(),this.uid=e}}class ResetAnims extends OutgoingMessage{priority=ServerProtPriority.HIGH}class ResetClientVarCache extends OutgoingMessage{priority=ServerProtPriority.HIGH}class TutorialOpenChat extends OutgoingMessage{component;priority=ServerProtPriority.LOW;constructor(e){super(),this.component=e}}class UpdateInvStopTransmit extends OutgoingMessage{component;priority=ServerProtPriority.HIGH;constructor(e){super(),this.component=e}}class VarpSmall extends OutgoingMessage{varp;value;priority=ServerProtPriority.HIGH;constructor(e,t){super(),this.varp=e,this.value=t}}class VarpLarge extends OutgoingMessage{varp;value;priority=ServerProtPriority.HIGH;constructor(e,t){super(),this.varp=e,this.value=t}}class MidiSong extends OutgoingMessage{name;crc;length;priority=ServerProtPriority.LOW;constructor(e,t,i){super(),this.name=e,this.crc=t,this.length=i}}class MidiJingle extends OutgoingMessage{delay;data;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.delay=e,this.data=t}}class IfOpenSideOverlay extends OutgoingMessage{component;tab;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.tab=t}}class UnsetMapFlag extends OutgoingMessage{priority=ServerProtPriority.HIGH}class HintArrow extends OutgoingMessage{type;nid;pid;x;z2;y2;priority=ServerProtPriority.LOW;constructor(e,t,i,n,r,a){super(),this.type=e,this.nid=t,this.pid=i,this.x=n,this.z=r,this.y=a}}class LastLoginInfo extends OutgoingMessage{lastLoginIp;daysSinceLogin;daysSinceRecoveryChange;unreadMessageCount;priority=ServerProtPriority.LOW;constructor(e,t,i,n){super(),this.lastLoginIp=e,this.daysSinceLogin=t,this.daysSinceRecoveryChange=i,this.unreadMessageCount=n}}class MessageGame extends OutgoingMessage{msg;priority=ServerProtPriority.HIGH;constructor(e){super(),this.msg=e}}(e=>{e[e.ENCLOSED=0]="ENCLOSED",e[e.FOLLOWS=1]="FOLLOWS"})(ZoneEventType||={});var ZoneEventType_default=ZoneEventType;class UpdateZonePartialEnclosed extends OutgoingMessage{zoneX;zoneZ;originX;originZ;data;priority=ServerProtPriority.HIGH;constructor(e,t,i,n,r){super(),this.zoneX=e,this.zoneZ=t,this.originX=i,this.originZ=n,this.data=r}}class UpdateZoneFullFollows extends OutgoingMessage{zoneX;zoneZ;originX;originZ;priority=ServerProtPriority.HIGH;constructor(e,t,i,n){super(),this.zoneX=e,this.zoneZ=t,this.originX=i,this.originZ=n}}class UpdateZonePartialFollows extends OutgoingMessage{zoneX;zoneZ;originX;originZ;priority=ServerProtPriority.HIGH;constructor(e,t,i,n){super(),this.zoneX=e,this.zoneZ=t,this.originX=i,this.originZ=n}}class ZoneMessage extends OutgoingMessage{coord;priority=ServerProtPriority.HIGH;constructor(e){super(),this.coord=e}}class ObjAdd extends ZoneMessage{coord;obj;count;constructor(e,t,i){super(e),this.coord=e,this.obj=t,this.count=i}}class LocAddChange extends ZoneMessage{coord;loc;shape;angle;constructor(e,t,i,n){super(e),this.coord=e,this.loc=t,this.shape=i,this.angle=n}}class LocDel extends ZoneMessage{coord;shape;angle;constructor(e,t,i){super(e),this.coord=e,this.shape=t,this.angle=i}}class MapProjAnim extends ZoneMessage{srcX;srcZ;dstX;dstZ;target;spotanim;srcHeight;dstHeight;startDelay;endDelay;peak;arc;constructor(e,t,i,n,r,a,s,o,c,l,d,p){super(Position.packZoneCoord(e,t)),this.srcX=e,this.srcZ=t,this.dstX=i,this.dstZ=n,this.target=r,this.spotanim=a,this.srcHeight=s,this.dstHeight=o,this.startDelay=c,this.endDelay=l,this.peak=d,this.arc=p}}class MapAnim extends ZoneMessage{coord;spotanim;height;delay;constructor(e,t,i,n){super(e),this.coord=e,this.spotanim=t,this.height=i,this.delay=n}}class ObjDel extends ZoneMessage{coord;obj;constructor(e,t){super(e),this.coord=e,this.obj=t}}class ObjCount extends ZoneMessage{coord;obj;oldCount;newCount;constructor(e,t,i,n){super(e),this.coord=e,this.obj=t,this.oldCount=i,this.newCount=n}}class ObjReveal extends ZoneMessage{coord;obj;count;receiverId;constructor(e,t,i,n){super(e),this.coord=e,this.obj=t,this.count=i,this.receiverId=n}}class LocAnim extends ZoneMessage{coord;shape;angle;seq;constructor(e,t,i,n){super(e),this.coord=e,this.shape=t,this.angle=i,this.seq=n}}class LocMerge extends ZoneMessage{srcX;srcZ;shape;angle;locId;startCycle;endCycle;pid;east;south;west;north;constructor(e,t,i,n,r,a,s,o,c,l,d,p){super(Position.packZoneCoord(e,t)),this.srcX=e,this.srcZ=t,this.shape=i,this.angle=n,this.locId=r,this.startCycle=a,this.endCycle=s,this.pid=o,this.east=c,this.south=l,this.west=d,this.north=p}}class MessageEncoder{test(e){return this.prot.length}}class IfOpenChatModalEncoder extends MessageEncoder{prot=ServerProt.IF_OPENCHATMODAL;encode(e,t){e.p2(t.component)}}class IfOpenChatModal extends OutgoingMessage{component;priority=ServerProtPriority.LOW;constructor(e){super(),this.component=e}}class PlayerInfo extends OutgoingMessage{buildArea;level;x;z2;originX;originZ;uid;mask;tele;jump2;walkDir;runDir;priority=ServerProtPriority.HIGH;accumulator=0;constructor(e,t,i,n,r,a,s,o,c,l,d,p){super(),this.buildArea=e,this.level=t,this.x=i,this.z=n,this.originX=r,this.originZ=a,this.uid=s,this.mask=o,this.tele=c,this.jump=l,this.walkDir=d,this.runDir=p}}class PlayerInfoEncoder extends MessageEncoder{static BITS_NEW=34;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=ServerProt.PLAYER_INFO;encode(e,t){const i=t.buildArea;i.resize(),this.writeLocalPlayer(e,t),this.writePlayers(e,t),this.writeNewPlayers(e,t);const n=i.extendedInfo;if(n.size>0)for(const i of n){const n=World_default.getPlayerByUid(i.id);n&&this.writeUpdate(n,t,e,i.id===t.uid,i.added)}i.reset()}test(e){return PlayerInfoEncoder.BYTES_LIMIT}writeLocalPlayer(e,t){const{buildArea:i,uid:n,level:r,x:a,z:s,mask:o,tele:c,jump:l,walkDir:d,runDir:p}=t,h=World_default.getPlayerByUid(n);h&&(e.bits(),e.pBit(1,c||-1!==d||-1!==p||o>0?1:0),c?(e.pBit(2,3),e.pBit(2,r),e.pBit(7,Position.local(a)),e.pBit(7,Position.local(s)),e.pBit(1,l?1:0),e.pBit(1,o>0?1:0)):-1!==p?(e.pBit(2,2),e.pBit(3,d),e.pBit(3,p),e.pBit(1,o>0?1:0)):-1!==d?(e.pBit(2,1),e.pBit(3,d),e.pBit(1,o>0?1:0)):o>0&&e.pBit(2,0),o>0&&(i.extendedInfo.add({id:n,added:!1}),t.accumulator+=this.calculateUpdateSize(h,t,!0,!0)))}writePlayers(e,t){const i=t.buildArea;e.pBit(8,i.players.size);for(const n of i.players){const r=World_default.getPlayerByUid(n);if(!r||r.tele||r.level!==t.level||!Position.isWithinDistanceSW(t,r,i.viewDistance)||!r.checkLifeCycle(World_default.currentTick)){e.pBit(1,1),e.pBit(2,3),i.players.delete(n);continue}let a=r.mask>0;const{walkDir:s,runDir:o}=r;let c=0;-1!==o?c=PlayerInfoEncoder.BITS_RUN:-1!==s?c=PlayerInfoEncoder.BITS_WALK:a&&(c=PlayerInfoEncoder.BITS_EXTENDED);const l=a?this.calculateUpdateSize(r,t,!1,!1):0;(e.bitPos+c+7+24>>>3)+e.pos+(t.accumulator+=l)>this.test(t)&&(a=!1),e.pBit(1,-1!==s||-1!==o||a?1:0),-1!==o?(e.pBit(2,2),e.pBit(3,s),e.pBit(3,o),e.pBit(1,a?1:0)):-1!==s?(e.pBit(2,1),e.pBit(3,s),e.pBit(1,a?1:0)):a&&e.pBit(2,0),a&&i.extendedInfo.add({id:n,added:!1})}}writeNewPlayers(e,t){const i=t.buildArea;for(const n of i.getNearbyPlayers(t.uid,t.x,t.z,t.originX,t.originZ)){const r=!i.hasAppearance(n.pid,n.appearanceHashCode),a=r?this.calculateUpdateSize(n,t,!1,!0):0;if((e.bitPos+PlayerInfoEncoder.BITS_NEW+7+24>>>3)+e.pos+(t.accumulator+=a)>this.test(t))break;e.pBit(11,n.pid),e.pBit(5,n.x-t.x),e.pBit(5,n.z-t.z),e.pBit(1,n.jump?1:0),e.pBit(1,r?1:0),r&&i.extendedInfo.add({id:n.uid,added:!0}),i.players.add(n.uid)}i.extendedInfo.size>0&&e.pBit(11,2047),e.bytes()}writeUpdate(e,t,i,n=!1,r=!1){let a=e.mask;if(r&&(a|=Player2.APPEARANCE),!r||-1===e.orientation&&-1===e.faceX&&-1===e.faceZ||(a|=Player2.FACE_COORD),r&&-1!==e.faceEntity&&(a|=Player2.FACE_ENTITY),a>255&&(a|=Player2.BIG_UPDATE),n&&a&Player2.CHAT&&(a&=~Player2.CHAT),t.buildArea.hasAppearance(e.pid,e.appearanceHashCode)&&(a&=~Player2.APPEARANCE),i.p1(255&a),a&Player2.BIG_UPDATE&&i.p1(a>>8),a&Player2.APPEARANCE&&(i.p1(e.appearance.length),i.pdata(e.appearance,0,e.appearance.length),t.buildArea.saveAppearance(e.pid,e.appearanceHashCode)),a&Player2.ANIM&&(i.p2(e.animId),i.p1(e.animDelay)),a&Player2.FACE_ENTITY&&(-1!==e.faceEntity&&(e.alreadyFacedEntity=!0),i.p2(e.faceEntity)),a&Player2.SAY&&i.pjstr(e.chat??""),a&Player2.DAMAGE&&(i.p1(e.damageTaken),i.p1(e.damageType),i.p1(e.levels[PlayerStat_default.HITPOINTS]),i.p1(e.baseLevels[PlayerStat_default.HITPOINTS])),a&Player2.FACE_COORD)if(-1!==e.faceX&&(e.alreadyFacedCoord=!0),r&&-1!==e.faceX)i.p2(e.faceX),i.p2(e.faceZ);else if(r&&-1!==e.orientation){const t=Position.moveX(e.x,e.orientation),n=Position.moveZ(e.z,e.orientation);i.p2(2*t+1),i.p2(2*n+1)}else i.p2(e.faceX),i.p2(e.faceZ);a&Player2.CHAT&&(i.p1(e.messageColor),i.p1(e.messageEffect),i.p1(e.messageType),i.p1(e.message.length),i.pdata(e.message,0,e.message.length)),a&Player2.SPOTANIM&&(i.p2(e.graphicId),i.p2(e.graphicHeight),i.p2(e.graphicDelay)),a&Player2.EXACT_MOVE&&(i.p1(e.exactStartX-Position.zoneOrigin(t.originX)),i.p1(e.exactStartZ-Position.zoneOrigin(t.originZ)),i.p1(e.exactEndX-Position.zoneOrigin(t.originX)),i.p1(e.exactEndZ-Position.zoneOrigin(t.originZ)),i.p2(e.exactMoveStart),i.p2(e.exactMoveEnd),i.p1(e.exactMoveDirection))}calculateUpdateSize(e,t,i=!1,n=!1){let r=0,a=e.mask;return n&&(a|=Player2.APPEARANCE),!n||-1===e.orientation&&-1===e.faceX&&-1===e.faceZ||(a|=Player2.FACE_COORD),n&&-1!==e.faceEntity&&(a|=Player2.FACE_ENTITY),a>255&&(a|=Player2.BIG_UPDATE),i&&a&Player2.CHAT&&(a&=~Player2.CHAT),t.buildArea.hasAppearance(e.pid,e.appearanceHashCode)&&(a&=~Player2.APPEARANCE),r+=1,a&Player2.BIG_UPDATE&&(r+=1),a&Player2.APPEARANCE&&(r+=1,r+=e.appearance?.length??0),a&Player2.ANIM&&(r+=3),a&Player2.FACE_ENTITY&&(r+=2),a&Player2.SAY&&(r+=(e.chat?.length??0)+1),a&Player2.DAMAGE&&(r+=4),a&Player2.FACE_COORD&&(r+=4),a&Player2.CHAT&&(r+=4,r+=e.message?.length??0),a&Player2.SPOTANIM&&(r+=6),a&Player2.EXACT_MOVE&&(r+=9),r}}class RebuildNormal extends OutgoingMessage{zoneX;zoneZ;priority=ServerProtPriority.HIGH;constructor(e,t){super(),this.zoneX=e,this.zoneZ=t}get mapsquares(){const e=this.zoneX-6,t=this.zoneX+6,i=this.zoneZ-6,n=this.zoneZ+6,r=new Set;for(let a=e;a<=t;a++){const e=Position.mapsquare(a<<3);for(let t=i;t<=n;t++){const i=Position.mapsquare(t<<3);r.add(e<<8|i)}}return r}}class RebuildNormalEncoder extends MessageEncoder{prot=ServerProt.REBUILD_NORMAL;encode(e,t){e.p2(t.zoneX),e.p2(t.zoneZ);for(const i of t.mapsquares){const t=i>>8,n=255&i;e.p1(t),e.p1(n),e.p4(PRELOADED_CRC.get(`m${t}_${n}`)??0),e.p4(PRELOADED_CRC.get(`l${t}_${n}`)??0)}}test(e){return 4+10*e.mapsquares.size}}class DataLand extends OutgoingMessage{x;z2;offset;length;data;priority=ServerProtPriority.HIGH;constructor(e,t,i,n,r){super(),this.x=e,this.z=t,this.offset=i,this.length=n,this.data=r}}class DataLandEncoder extends MessageEncoder{prot=ServerProt.DATA_LAND;encode(e,t){e.p1(t.x),e.p1(t.z),e.p2(t.offset),e.p2(t.length),e.pdata(t.data,0,t.data.length)}test(e){return 6+e.data.length}}class DataLandDone extends OutgoingMessage{x;z2;priority=ServerProtPriority.HIGH;constructor(e,t){super(),this.x=e,this.z=t}}class DataLandDoneEncoder extends MessageEncoder{prot=ServerProt.DATA_LAND_DONE;encode(e,t){e.p1(t.x),e.p1(t.z)}}class DataLoc extends OutgoingMessage{x;z2;offset;length;data;priority=ServerProtPriority.HIGH;constructor(e,t,i,n,r){super(),this.x=e,this.z=t,this.offset=i,this.length=n,this.data=r}}class DataLocEncoder extends MessageEncoder{prot=ServerProt.DATA_LOC;encode(e,t){e.p1(t.x),e.p1(t.z),e.p2(t.offset),e.p2(t.length),e.pdata(t.data,0,t.data.length)}test(e){return 6+e.data.length}}class DataLocDone extends OutgoingMessage{x;z2;priority=ServerProtPriority.HIGH;constructor(e,t){super(),this.x=e,this.z=t}}class DataLocDoneEncoder extends MessageEncoder{prot=ServerProt.DATA_LOC_DONE;encode(e,t){e.p1(t.x),e.p1(t.z)}}class CamLookAt extends OutgoingMessage{x;z2;height;speed;multiplier;priority=ServerProtPriority.LOW;constructor(e,t,i,n,r){super(),this.x=e,this.z=t,this.height=i,this.speed=n,this.multiplier=r}}class CamLookAtEncoder extends MessageEncoder{prot=ServerProt.CAM_LOOKAT;encode(e,t){e.p1(t.x),e.p1(t.z),e.p2(t.height),e.p1(t.speed),e.p1(t.multiplier)}}class CamMoveTo extends OutgoingMessage{x;z2;height;speed;multiplier;priority=ServerProtPriority.LOW;constructor(e,t,i,n,r){super(),this.x=e,this.z=t,this.height=i,this.speed=n,this.multiplier=r}}class CamMoveToEncoder extends MessageEncoder{prot=ServerProt.CAM_MOVETO;encode(e,t){e.p1(t.x),e.p1(t.z),e.p2(t.height),e.p1(t.speed),e.p1(t.multiplier)}}class CamReset extends OutgoingMessage{priority=ServerProtPriority.LOW}class CamResetEncoder extends MessageEncoder{prot=ServerProt.CAM_RESET;encode(e,t){}}class CamShake extends OutgoingMessage{type;jitter;amplitude;frequency;priority=ServerProtPriority.LOW;constructor(e,t,i,n){super(),this.type=e,this.jitter=t,this.amplitude=i,this.frequency=n}}class CamShakeEncoder extends MessageEncoder{prot=ServerProt.CAM_SHAKE;encode(e,t){e.p1(t.type),e.p1(t.jitter),e.p1(t.amplitude),e.p1(t.frequency)}}class ChatFilterSettings extends OutgoingMessage{publicChat;privateChat;tradeDuel;priority=ServerProtPriority.HIGH;constructor(e,t,i){super(),this.publicChat=e,this.privateChat=t,this.tradeDuel=i}}class ChatFilterSettingsEncoder extends MessageEncoder{prot=ServerProt.CHAT_FILTER_SETTINGS;encode(e,t){e.p1(t.publicChat),e.p1(t.privateChat),e.p1(t.tradeDuel)}}class EnableTracking extends OutgoingMessage{priority=ServerProtPriority.LOW}class EnableTrackingEncoder extends MessageEncoder{prot=ServerProt.ENABLE_TRACKING;encode(e,t){}}class FinishTracking extends OutgoingMessage{priority=ServerProtPriority.LOW}class FinishTrackingEncoder extends MessageEncoder{prot=ServerProt.FINISH_TRACKING;encode(e,t){}}class HintArrowEncoder extends MessageEncoder{prot=ServerProt.HINT_ARROW;encode(e,t){const{type:i,nid:n,pid:r,x:a,z:s,y:o}=t;1===i?(e.p1(i),e.p2(n),e.p2(0),e.p1(0)):i>=2&&i<=6?(e.p1(i),e.p2(a),e.p2(s),e.p1(o)):10===i?(e.p1(i),e.p2(r),e.p2(0),e.p1(0)):-1===i&&(e.p1(-1),e.p2(0),e.p2(0),e.p1(0))}}class IfCloseEncoder extends MessageEncoder{prot=ServerProt.IF_CLOSE;encode(e,t){}}class IfOpenMainModal extends OutgoingMessage{component;priority=ServerProtPriority.LOW;constructor(e){super(),this.component=e}}class IfOpenMainModalEncoder extends MessageEncoder{prot=ServerProt.IF_OPENMAINMODAL;encode(e,t){e.p2(t.component)}}class IfOpenMainSideModal extends OutgoingMessage{main;side;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.main=e,this.side=t}}class IfOpenMainSideModalEncoder extends MessageEncoder{prot=ServerProt.IF_OPENMAINSIDEMODAL;encode(e,t){e.p2(t.main),e.p2(t.side)}}class IfOpenSideModal extends OutgoingMessage{component;priority=ServerProtPriority.LOW;constructor(e){super(),this.component=e}}class IfOpenSideModalEncoder extends MessageEncoder{prot=ServerProt.IF_OPENSIDEMODAL;encode(e,t){e.p2(t.component)}}class IfOpenSideOverlayEncoder extends MessageEncoder{prot=ServerProt.IF_OPENSIDEOVERLAY;encode(e,t){e.p2(t.component),e.p1(t.tab)}}class IfSetAnim extends OutgoingMessage{component;seq;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.seq=t}}class IfSetAnimEncoder extends MessageEncoder{prot=ServerProt.IF_SETANIM;encode(e,t){e.p2(t.component),e.p2(t.seq)}}class IfSetColour extends OutgoingMessage{component;colour;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.colour=t}}class IfSetColourEncoder extends MessageEncoder{prot=ServerProt.IF_SETCOLOUR;encode(e,t){e.p2(t.component),e.p2(t.colour)}}class IfSetHide extends OutgoingMessage{component;hidden;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.hidden=t}}class IfSetHideEncoder extends MessageEncoder{prot=ServerProt.IF_SETHIDE;encode(e,t){e.p2(t.component),e.pbool(t.hidden)}}class IfSetModel extends OutgoingMessage{component;model;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.model=t}}class IfSetModelEncoder extends MessageEncoder{prot=ServerProt.IF_SETMODEL;encode(e,t){e.p2(t.component),e.p2(t.model)}}class IfSetNpcHead extends OutgoingMessage{component;npc;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.npc=t}}class IfSetNpcHeadEncoder extends MessageEncoder{prot=ServerProt.IF_SETNPCHEAD;encode(e,t){e.p2(t.component),e.p2(t.npc)}}class IfSetObject extends OutgoingMessage{component;obj;scale;priority=ServerProtPriority.LOW;constructor(e,t,i){super(),this.component=e,this.obj=t,this.scale=i}}class IfSetObjectEncoder extends MessageEncoder{prot=ServerProt.IF_SETOBJECT;encode(e,t){e.p2(t.component),e.p2(t.obj),e.p2(t.scale)}}class IfSetPlayerHead extends OutgoingMessage{component;priority=ServerProtPriority.LOW;constructor(e){super(),this.component=e}}class IfSetPlayerHeadEncoder extends MessageEncoder{prot=ServerProt.IF_SETPLAYERHEAD;encode(e,t){e.p2(t.component)}}class IfSetPosition extends OutgoingMessage{component;x;y2;priority=ServerProtPriority.LOW;constructor(e,t,i){super(),this.component=e,this.x=t,this.y=i}}class IfSetPositionEncoder extends MessageEncoder{prot=ServerProt.IF_SETPOSITION;encode(e,t){e.p2(t.component),e.p2(t.x),e.p2(t.y)}}class IfSetRecol extends OutgoingMessage{component;src;dst;priority=ServerProtPriority.LOW;constructor(e,t,i){super(),this.component=e,this.src=t,this.dst=i}}class IfSetRecolEncoder extends MessageEncoder{prot=ServerProt.IF_SETRECOL;encode(e,t){e.p2(t.component),e.p2(t.src),e.p2(t.dst)}}class IfSetText extends OutgoingMessage{component;text;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.component=e,this.text=t}}class IfSetTextEncoder extends MessageEncoder{prot=ServerProt.IF_SETTEXT;encode(e,t){e.p2(t.component),e.pjstr(t.text)}test(e){return 3+e.text.length}}class IfShowSide extends OutgoingMessage{tab;priority=ServerProtPriority.LOW;constructor(e){super(),this.tab=e}}class IfShowSideEncoder extends MessageEncoder{prot=ServerProt.IF_SHOWSIDE;encode(e,t){e.p1(t.tab)}}class LastLoginInfoEncoder extends MessageEncoder{prot=ServerProt.LAST_LOGIN_INFO;encode(e,t){e.p4(t.lastLoginIp),e.p2(t.daysSinceLogin),e.p1(t.daysSinceRecoveryChange),e.p2(t.unreadMessageCount)}}class ZoneProt extends ServerProt{static LOC_MERGE=new ZoneProt(23,14);static LOC_ANIM=new ZoneProt(42,4);static OBJ_DEL=new ZoneProt(49,3);static OBJ_REVEAL=new ZoneProt(50,7);static LOC_ADD_CHANGE=new ZoneProt(59,4);static MAP_PROJANIM=new ZoneProt(69,15);static LOC_DEL=new ZoneProt(76,2);static OBJ_COUNT=new ZoneProt(151,7);static MAP_ANIM=new ZoneProt(191,6);static OBJ_ADD=new ZoneProt(223,5)}class ZoneMessageEncoder extends MessageEncoder{enclose(e){const t=new Packet(new Uint8Array(1+this.prot.length));return t.p1(this.prot.id),this.encode(t,e),t.data}}class LocAddChangeEncoder extends ZoneMessageEncoder{prot=ZoneProt.LOC_ADD_CHANGE;encode(e,t){e.p1(t.coord),e.p1(t.shape<<2|3&t.angle),e.p2(t.loc)}}class LocAnimEncoder extends ZoneMessageEncoder{prot=ZoneProt.LOC_ANIM;encode(e,t){e.p1(t.coord),e.p1(t.shape<<2|3&t.angle),e.p2(t.seq)}}class LocDelEncoder extends ZoneMessageEncoder{prot=ZoneProt.LOC_DEL;encode(e,t){e.p1(t.coord),e.p1(t.shape<<2|3&t.angle)}}class LocMergeEncoder extends ZoneMessageEncoder{prot=ZoneProt.LOC_MERGE;encode(e,t){e.p1(t.coord),e.p1(t.shape<<2|3&t.angle),e.p2(t.locId),e.p2(t.startCycle),e.p2(t.endCycle),e.p2(t.pid),e.p1(t.east-t.srcX),e.p1(t.south-t.srcZ),e.p1(t.west-t.srcX),e.p1(t.north-t.srcZ)}}class Logout extends OutgoingMessage{priority=ServerProtPriority.HIGH}class LogoutEncoder extends MessageEncoder{prot=ServerProt.LOGOUT;encode(e,t){}}class MapAnimEncoder extends ZoneMessageEncoder{prot=ZoneProt.MAP_ANIM;encode(e,t){e.p1(t.coord),e.p2(t.spotanim),e.p1(t.height),e.p2(t.delay)}}class MapProjAnimEncoder extends ZoneMessageEncoder{prot=ZoneProt.MAP_PROJANIM;encode(e,t){e.p1(t.coord),e.p1(t.dstX-t.srcX),e.p1(t.dstZ-t.srcZ),e.p2(t.target),e.p2(t.spotanim),e.p1(t.srcHeight),e.p1(t.dstHeight),e.p2(t.startDelay),e.p2(t.endDelay),e.p1(t.peak),e.p1(t.arc)}}class MessageGameEncoder extends MessageEncoder{prot=ServerProt.MESSAGE_GAME;encode(e,t){e.pjstr(t.msg)}test(e){return 1+e.msg.length}}class WordPack{static CHAR_LOOKUP=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","Â£","$","%",'"',"[","]"];static unpack(e,t){const i=[];let n,r=0,a=-1;for(let s=0;s<t&&r<80;s++){const t=e.g1();n=t>>4&15,-1!==a?(i[r++]=this.CHAR_LOOKUP[(a<<4)+n-195],a=-1):n<13?i[r++]=this.CHAR_LOOKUP[n]:a=n,n=15&t,-1!=a?(i[r++]=this.CHAR_LOOKUP[(a<<4)+n-195],a=-1):n<13?i[r++]=this.CHAR_LOOKUP[n]:a=n}return this.toSentenceCase(i.slice(0,r).join(""))}static pack(e,t){t.length>80&&(t=t.substring(0,80)),t=t.toLowerCase();let i=-1;for(let n=0;n<t.length;n++){const r=t.charAt(n);let a=0;for(let e=0;e<this.CHAR_LOOKUP.length;e++)if(r===this.CHAR_LOOKUP[e]){a=e;break}a>12&&(a+=195),-1==i?a<13?i=a:e.p1(a):a<13?(e.p1((i<<4)+a),i=-1):(e.p1((i<<4)+(a>>4)),i=15&a)}-1!=i&&e.p1(i<<4)}static toSentenceCase(e){const t=[...e.toLowerCase()];let i=!0;for(let e=0;e<t.length;e++){const n=t[e];i&&n>="a"&&n<="z"&&(t[e]=n.toUpperCase(),i=!1),"."!==n&&"!"!==n||(i=!0)}return t.join("")}}class MessagePrivateEncoder extends MessageEncoder{prot=ServerProt.MESSAGE_PRIVATE;encode(e,t){e.p8(t.from),e.p4(t.messageId),e.p1(t.staffModLevel),WordPack.pack(e,WordEnc2.filter(t.msg))}test(e){return 14+e.msg.length}}class MessagePrivate extends OutgoingMessage{from;messageId;staffModLevel;msg;priority=ServerProtPriority.HIGH;constructor(e,t,i,n){super(),this.from=e,this.messageId=t,this.staffModLevel=i,this.msg=n}}class MidiJingleEncoder extends MessageEncoder{prot=ServerProt.MIDI_JINGLE;encode(e,t){e.p2(t.delay),e.p4(t.data.length),e.pdata(t.data,0,t.data.length)}test(e){return 6+e.data.length}}class MidiSongEncoder extends MessageEncoder{prot=ServerProt.MIDI_SONG;encode(e,t){e.pjstr(t.name),e.p4(t.crc),e.p4(t.length)}test(e){return 1+e.name.length+4+4}}class ObjAddEncoder extends ZoneMessageEncoder{prot=ZoneProt.OBJ_ADD;encode(e,t){e.p1(t.coord),e.p2(t.obj),e.p2(Math.min(t.count,65535))}}class ObjCountEncoder extends ZoneMessageEncoder{prot=ZoneProt.OBJ_COUNT;encode(e,t){e.p1(t.coord),e.p2(t.obj),e.p2(Math.min(t.oldCount,65535)),e.p2(Math.min(t.newCount,65535))}}class ObjDelEncoder extends ZoneMessageEncoder{prot=ZoneProt.OBJ_DEL;encode(e,t){e.p1(t.coord),e.p2(t.obj)}}class ObjRevealEncoder extends ZoneMessageEncoder{prot=ZoneProt.OBJ_REVEAL;encode(e,t){e.p1(t.coord),e.p2(t.obj),e.p2(Math.min(t.count,65535)),e.p2(t.receiverId)}}class PCountDialog extends OutgoingMessage{priority=ServerProtPriority.LOW}class PCountDialogEncoder extends MessageEncoder{prot=ServerProt.P_COUNTDIALOG;encode(e,t){}}class ResetAnimsEncoder extends MessageEncoder{prot=ServerProt.RESET_ANIMS;encode(e,t){}}class ResetClientVarCacheEncoder extends MessageEncoder{prot=ServerProt.RESET_CLIENT_VARCACHE;encode(e,t){}}class SetMultiway extends OutgoingMessage{hidden;priority=ServerProtPriority.LOW;constructor(e){super(),this.hidden=e}}class SetMultiwayEncoder extends MessageEncoder{prot=ServerProt.SET_MULTIWAY;encode(e,t){e.pbool(t.hidden)}}class SynthSound extends OutgoingMessage{synth;loops;delay;priority=ServerProtPriority.LOW;constructor(e,t,i){super(),this.synth=e,this.loops=t,this.delay=i}}class SynthSoundEncoder extends MessageEncoder{prot=ServerProt.SYNTH_SOUND;encode(e,t){e.p2(t.synth),e.p1(t.loops),e.p2(t.delay)}}class TutorialFlashSide extends OutgoingMessage{tab;priority=ServerProtPriority.LOW;constructor(e){super(),this.tab=e}}class TutorialFlashSideEncoder extends MessageEncoder{prot=ServerProt.TUTORIAL_FLASHSIDE;encode(e,t){e.p1(t.tab)}}class TutorialOpenChatEncoder extends MessageEncoder{prot=ServerProt.TUTORIAL_OPENCHAT;encode(e,t){e.p2(t.component)}}class UnsetMapFlagEncoder extends MessageEncoder{prot=ServerProt.UNSET_MAP_FLAG;encode(e,t){}}class UpdateFriendList extends OutgoingMessage{name;nodeId;priority=ServerProtPriority.LOW;constructor(e,t){super(),this.name=e,this.nodeId=t}}class UpdateFriendListEncoder extends MessageEncoder{prot=ServerProt.UPDATE_FRIENDLIST;encode(e,t){e.p8(t.name),e.p1(t.nodeId)}}class UpdateIgnoreList extends OutgoingMessage{names;priority=ServerProtPriority.LOW;constructor(e){super(),this.names=e}}class UpdateIgnoreListEncoder extends MessageEncoder{prot=ServerProt.UPDATE_IGNORELIST;encode(e,t){for(const i of t.names)e.p8(i)}test(e){return 8*e.names.length}}class UpdateInvFull extends OutgoingMessage{component;inv;priority=ServerProtPriority.HIGH;constructor(e,t){super(),this.component=e,this.inv=t}}class UpdateInvFullEncoder extends MessageEncoder{prot=ServerProt.UPDATE_INV_FULL;encode(e,t){const{component:i,inv:n}=t,r=Component.get(i),a=Math.min(n.capacity,r.width*r.height);e.p2(i),e.p1(a);for(let t=0;t<a;t++){const i=n.get(t);i?(e.p2(i.id+1),i.count>=255?(e.p1(255),e.p4(i.count)):e.p1(i.count)):(e.p2(0),e.p1(0))}}test(e){const{component:t,inv:i}=e,n=Component.get(t),r=Math.min(i.capacity,n.width*n.height);let a=0;a+=3;for(let e=0;e<r;e++){const t=i.get(e);t?(a+=2,t.count>=255?a+=5:a+=1):a+=3}return a}}class UpdateInvPartial extends OutgoingMessage{component;inv;priority=ServerProtPriority.HIGH;slots;constructor(e,t,...i){super(),this.component=e,this.inv=t,this.slots=i}}class UpdateInvPartialEncoder extends MessageEncoder{prot=ServerProt.UPDATE_INV_PARTIAL;encode(e,t){const{component:i,inv:n}=t;e.p2(i);for(const i of t.slots){const t=n.get(i);e.p1(i),t?(e.p2(t.id+1),t.count>=255?(e.p1(255),e.p4(t.count)):e.p1(t.count)):(e.p2(0),e.p1(0))}}test(e){const{inv:t}=e;let i=0;i+=2;for(const n of e.slots){const e=t.get(n);i+=1,e?(i+=2,e.count>=255?i+=5:i+=1):i+=3}return i}}class UpdateInvStopTransmitEncoder extends MessageEncoder{prot=ServerProt.UPDATE_INV_STOP_TRANSMIT;encode(e,t){e.p2(t.component)}}class UpdateRunEnergy extends OutgoingMessage{energy;priority=ServerProtPriority.LOW;constructor(e){super(),this.energy=e}}class UpdateRunEnergyEncoder extends MessageEncoder{prot=ServerProt.UPDATE_RUNENERGY;encode(e,t){e.p1(t.energy/100|0)}}class UpdateRunWeight extends OutgoingMessage{kg;priority=ServerProtPriority.LOW;constructor(e){super(),this.kg=e}}class UpdateRunWeightEncoder extends MessageEncoder{prot=ServerProt.UPDATE_RUNWEIGHT;encode(e,t){e.p2(t.kg)}}class UpdateStat extends OutgoingMessage{stat;exp;level;priority=ServerProtPriority.LOW;constructor(e,t,i){super(),this.stat=e,this.exp=t,this.level=i}}class UpdateStatEncoder extends MessageEncoder{prot=ServerProt.UPDATE_STAT;encode(e,t){e.p1(t.stat),e.p4(t.exp/10|0),e.p1(t.level)}}class UpdateUid192Encoder extends MessageEncoder{prot=ServerProt.UPDATE_UID192;encode(e,t){e.p2(t.uid)}}class UpdateZoneFullFollowsEncoder extends MessageEncoder{prot=ServerProt.UPDATE_ZONE_FULL_FOLLOWS;encode(e,t){e.p1((t.zoneX<<3)-Position.zoneOrigin(t.originX)),e.p1((t.zoneZ<<3)-Position.zoneOrigin(t.originZ))}}class UpdateZonePartialFollowsEncoder extends MessageEncoder{prot=ServerProt.UPDATE_ZONE_PARTIAL_FOLLOWS;encode(e,t){e.p1((t.zoneX<<3)-Position.zoneOrigin(t.originX)),e.p1((t.zoneZ<<3)-Position.zoneOrigin(t.originZ))}}class UpdateZonePartialEnclosedEncoder extends MessageEncoder{prot=ServerProt.UPDATE_ZONE_PARTIAL_ENCLOSED;encode(e,t){e.p1((t.zoneX<<3)-Position.zoneOrigin(t.originX)),e.p1((t.zoneZ<<3)-Position.zoneOrigin(t.originZ)),e.pdata(t.data,0,t.data.length)}test(e){return 2+e.data.length}}class VarpLargeEncoder extends MessageEncoder{prot=ServerProt.VARP_LARGE;encode(e,t){e.p2(t.varp),e.p4(t.value)}}class VarpSmallEncoder extends MessageEncoder{prot=ServerProt.VARP_SMALL;encode(e,t){e.p2(t.varp),e.p1(t.value)}}class NpcInfo extends OutgoingMessage{buildArea;level;x;z2;originX;originZ;priority=ServerProtPriority.HIGH;accumulator=0;constructor(e,t,i,n,r,a){super(),this.buildArea=e,this.level=t,this.x=i,this.z=n,this.originX=r,this.originZ=a}}class NpcInfoEncoder extends MessageEncoder{static BITS_NEW=35;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=ServerProt.NPC_INFO;encode(e,t){const i=t.buildArea;this.writeNpcs(e,t),this.writeNewNpcs(e,t);const n=i.extendedInfo;if(n.size>0)for(const t of n){const i=World_default.getNpc(t.id);i&&this.writeUpdate(i,e,t.added)}i.reset()}test(e){return NpcInfoEncoder.BYTES_LIMIT}writeNpcs(e,t){const i=t.buildArea;e.bits(),e.pBit(8,i.npcs.size);for(const n of i.npcs){const r=World_default.getNpc(n);if(!r||r.tele||r.level!==t.level||!Position.isWithinDistanceSW(t,r,16)||!r.checkLifeCycle(World_default.currentTick)){e.pBit(1,1),e.pBit(2,3),i.npcs.delete(n);continue}let a=r.mask>0;const{walkDir:s,runDir:o}=r;let c=0;-1!==o?c=NpcInfoEncoder.BITS_RUN:-1!==s?c=NpcInfoEncoder.BITS_WALK:a&&(c=NpcInfoEncoder.BITS_EXTENDED);const l=a?this.calculateUpdateSize(r,!1):0;(e.bitPos+c+7+24>>>3)+e.pos+(t.accumulator+=l)>this.test(t)&&(a=!1),e.pBit(1,-1!==o||-1!==s||a?1:0),-1!==o?(e.pBit(2,2),e.pBit(3,s),e.pBit(3,o),e.pBit(1,a?1:0)):-1!==s?(e.pBit(2,1),e.pBit(3,s),e.pBit(1,a?1:0)):a&&e.pBit(2,0),a&&i.extendedInfo.add({id:n,added:!1})}}writeNewNpcs(e,t){const i=t.buildArea;for(const n of i.getNearbyNpcs(t.x,t.z,t.originX,t.originZ)){const r=n.mask>0||-1!==n.orientation||-1!==n.faceX||-1!==n.faceZ||-1!==n.faceEntity,a=r?this.calculateUpdateSize(n,!0):0;if((e.bitPos+NpcInfoEncoder.BITS_NEW+7+24>>>3)+e.pos+(t.accumulator+=a)>this.test(t))break;e.pBit(13,n.nid),e.pBit(11,n.type),e.pBit(5,n.x-t.x),e.pBit(5,n.z-t.z),e.pBit(1,r?1:0),i.npcs.add(n.nid),r&&i.extendedInfo.add({id:n.nid,added:!0})}i.extendedInfo.size>0&&e.pBit(13,8191),e.bytes()}writeUpdate(e,t,i){let n=e.mask;if(!i||-1===e.orientation&&-1===e.faceX&&-1==e.faceZ||(n|=Npc2.FACE_COORD),i&&-1!==e.faceEntity&&(n|=Npc2.FACE_ENTITY),t.p1(n),n&Npc2.ANIM&&(t.p2(e.animId),t.p1(e.animDelay)),n&Npc2.FACE_ENTITY&&(-1!==e.faceEntity&&(e.alreadyFacedEntity=!0),t.p2(e.faceEntity)),n&Npc2.SAY&&t.pjstr(e.chat??""),n&Npc2.DAMAGE&&(t.p1(e.damageTaken),t.p1(e.damageType),t.p1(e.levels[NpcStat_default.HITPOINTS]),t.p1(e.baseLevels[NpcStat_default.HITPOINTS])),n&Npc2.CHANGE_TYPE&&t.p2(e.type),n&Npc2.SPOTANIM&&(t.p2(e.graphicId),t.p2(e.graphicHeight),t.p2(e.graphicDelay)),n&Npc2.FACE_COORD)if(-1!==e.faceX&&(e.alreadyFacedCoord=!0),i&&-1!=e.faceX)t.p2(e.faceX),t.p2(e.faceZ);else if(i&&-1!=e.orientation){const i=Position.moveX(e.x,e.orientation),n=Position.moveZ(e.z,e.orientation);t.p2(2*i+1),t.p2(2*n+1)}else t.p2(e.faceX),t.p2(e.faceZ)}calculateUpdateSize(e,t){let i=0,n=e.mask;return!t||-1===e.orientation&&-1===e.faceX&&-1==e.faceZ||(n|=Npc2.FACE_COORD),t&&-1!==e.faceEntity&&(n|=Npc2.FACE_ENTITY),i+=1,n&Npc2.ANIM&&(i+=3),n&Npc2.FACE_ENTITY&&(i+=2),n&Npc2.SAY&&(i+=(e.chat?.length??0)+1),n&Npc2.DAMAGE&&(i+=4),n&Npc2.CHANGE_TYPE&&(i+=2),n&Npc2.SPOTANIM&&(i+=6),n&Npc2.FACE_COORD&&(i+=4),i}}class ServerProtRepository{encoders=new Map;bind(e,t){if(this.encoders.has(e))throw new Error(`[ServerProtRepository] Already defines a ${e.name}.`);this.encoders.set(e,t)}constructor(){this.bind(CamLookAt,new CamLookAtEncoder),this.bind(CamMoveTo,new CamMoveToEncoder),this.bind(CamReset,new CamResetEncoder),this.bind(CamShake,new CamShakeEncoder),this.bind(ChatFilterSettings,new ChatFilterSettingsEncoder),this.bind(DataLand,new DataLandEncoder),this.bind(DataLandDone,new DataLandDoneEncoder),this.bind(DataLoc,new DataLocEncoder),this.bind(DataLocDone,new DataLocDoneEncoder),this.bind(EnableTracking,new EnableTrackingEncoder),this.bind(FinishTracking,new FinishTrackingEncoder),this.bind(HintArrow,new HintArrowEncoder),this.bind(IfClose,new IfCloseEncoder),this.bind(IfOpenChatModal,new IfOpenChatModalEncoder),this.bind(IfOpenMainModal,new IfOpenMainModalEncoder),this.bind(IfOpenMainSideModal,new IfOpenMainSideModalEncoder),this.bind(IfOpenSideModal,new IfOpenSideModalEncoder),this.bind(IfOpenSideOverlay,new IfOpenSideOverlayEncoder),this.bind(IfSetAnim,new IfSetAnimEncoder),this.bind(IfSetColour,new IfSetColourEncoder),this.bind(IfSetHide,new IfSetHideEncoder),this.bind(IfSetModel,new IfSetModelEncoder),this.bind(IfSetNpcHead,new IfSetNpcHeadEncoder),this.bind(IfSetObject,new IfSetObjectEncoder),this.bind(IfSetPlayerHead,new IfSetPlayerHeadEncoder),this.bind(IfSetPosition,new IfSetPositionEncoder),this.bind(IfSetRecol,new IfSetRecolEncoder),this.bind(IfSetText,new IfSetTextEncoder),this.bind(IfShowSide,new IfShowSideEncoder),this.bind(LastLoginInfo,new LastLoginInfoEncoder),this.bind(LocAddChange,new LocAddChangeEncoder),this.bind(LocAnim,new LocAnimEncoder),this.bind(LocDel,new LocDelEncoder),this.bind(LocMerge,new LocMergeEncoder),this.bind(Logout,new LogoutEncoder),this.bind(MapAnim,new MapAnimEncoder),this.bind(MapProjAnim,new MapProjAnimEncoder),this.bind(MessageGame,new MessageGameEncoder),this.bind(MessagePrivate,new MessagePrivateEncoder),this.bind(MidiJingle,new MidiJingleEncoder),this.bind(MidiSong,new MidiSongEncoder),this.bind(NpcInfo,new NpcInfoEncoder),this.bind(ObjAdd,new ObjAddEncoder),this.bind(ObjCount,new ObjCountEncoder),this.bind(ObjDel,new ObjDelEncoder),this.bind(ObjReveal,new ObjRevealEncoder),this.bind(PCountDialog,new PCountDialogEncoder),this.bind(PlayerInfo,new PlayerInfoEncoder),this.bind(RebuildNormal,new RebuildNormalEncoder),this.bind(ResetAnims,new ResetAnimsEncoder),this.bind(ResetClientVarCache,new ResetClientVarCacheEncoder),this.bind(SetMultiway,new SetMultiwayEncoder),this.bind(SynthSound,new SynthSoundEncoder),this.bind(TutorialFlashSide,new TutorialFlashSideEncoder),this.bind(TutorialOpenChat,new TutorialOpenChatEncoder),this.bind(UnsetMapFlag,new UnsetMapFlagEncoder),this.bind(UpdateFriendList,new UpdateFriendListEncoder),this.bind(UpdateIgnoreList,new UpdateIgnoreListEncoder),this.bind(UpdateInvFull,new UpdateInvFullEncoder),this.bind(UpdateInvPartial,new UpdateInvPartialEncoder),this.bind(UpdateInvStopTransmit,new UpdateInvStopTransmitEncoder),this.bind(UpdateRunEnergy,new UpdateRunEnergyEncoder),this.bind(UpdateRunWeight,new UpdateRunWeightEncoder),this.bind(UpdateStat,new UpdateStatEncoder),this.bind(UpdateUid192,new UpdateUid192Encoder),this.bind(UpdateZoneFullFollows,new UpdateZoneFullFollowsEncoder),this.bind(UpdateZonePartialEnclosed,new UpdateZonePartialEnclosedEncoder),this.bind(UpdateZonePartialFollows,new UpdateZonePartialFollowsEncoder),this.bind(VarpLarge,new VarpLargeEncoder),this.bind(VarpSmall,new VarpSmallEncoder)}getEncoder(e){return this.encoders.get(e.constructor)}getZoneEncoder(e){return this.encoders.get(e.constructor)}}var ServerProtRepository_default=new ServerProtRepository;class Zone{index;x;z;level;players=new Set;npcs=new Set;locs=[];objs=[];events=new Set;shared=null;totalLocs=0;totalObjs=0;constructor(e){this.index=e;const t=ZoneMap2.unpackIndex(e);this.x=t.x>>3,this.z=t.z>>3,this.level=t.level}enter(e){e instanceof Player2?(this.players.add(e.uid),World_default.getZoneGrid(this.level).flag(this.x,this.z)):e instanceof Npc2&&this.npcs.add(e.nid)}leave(e){e instanceof Player2?(this.players.delete(e.uid),0===this.players.size&&World_default.getZoneGrid(this.level).unflag(this.x,this.z)):e instanceof Npc2&&this.npcs.delete(e.nid)}tick(e){let t;do{t=!1;for(const i of this.getAllObjsUnsafe())i.updateLifeCycle(e)&&i.lastLifecycleTick!==e&&(i.lifecycle===EntityLifeCycle_default.DESPAWN?-1!==i.receiverId?World_default.revealObj(i):(World_default.removeObj(i,0),t=!0):i.lifecycle===EntityLifeCycle_default.RESPAWN&&(World_default.addObj(i,-1,0),t=!0));for(const i of this.getAllLocsUnsafe())i.updateLifeCycle(e)&&i.lastLifecycleTick!==e&&(i.lifecycle===EntityLifeCycle_default.DESPAWN?(World_default.removeLoc(i,0),t=!0):i.lifecycle===EntityLifeCycle_default.RESPAWN&&(World_default.addLoc(i,0),t=!0))}while(t)}computeShared(){this.shared=null;let e=0;const t=[];for(const i of this.events.values()){if(i.type!==ZoneEventType_default.ENCLOSED)continue;const n=ServerProtRepository_default.getZoneEncoder(i.message);if(void 0===n)continue;const r=n.enclose(i.message);t.push(r),e+=r.length}if(0===t.length||0===e)return;const i=new Uint8Array(e);let n=0;for(const e of t)i.set(e,n),n+=e.length;this.shared=i}writeFullFollows(e){e.write(new UpdateZoneFullFollows(this.x,this.z,e.originX,e.originZ));for(const t of this.getAllObjsUnsafe(!0))-1!==t.receiverId&&t.receiverId!==e.pid||(e.write(new UpdateZonePartialFollows(this.x,this.z,e.originX,e.originZ)),(t.lifecycle===EntityLifeCycle_default.DESPAWN&&t.checkLifeCycle(World_default.currentTick)||t.lifecycle===EntityLifeCycle_default.RESPAWN&&t.checkLifeCycle(World_default.currentTick))&&e.write(new ObjAdd(Position.packZoneCoord(t.x,t.z),t.type,t.count)));for(const t of this.getAllLocsUnsafe(!0))t.lifecycle===EntityLifeCycle_default.DESPAWN&&t.checkLifeCycle(World_default.currentTick)?e.write(new LocAddChange(Position.packZoneCoord(t.x,t.z),t.type,t.shape,t.angle)):t.lifecycle!==EntityLifeCycle_default.RESPAWN||t.checkLifeCycle(World_default.currentTick)||e.write(new LocDel(Position.packZoneCoord(t.x,t.z),t.shape,t.angle))}writePartialEncloses(e){this.shared&&e.write(new UpdateZonePartialEnclosed(this.x,this.z,e.originX,e.originZ,this.shared))}writePartialFollows(e){if(0!==this.events.size){e.write(new UpdateZonePartialFollows(this.x,this.z,e.originX,e.originZ));for(const t of this.events)t.type===ZoneEventType_default.FOLLOWS&&(-1!==t.receiverId&&t.receiverId!==e.pid||e.write(t.message))}}reset(){this.events.clear()}addStaticLoc(e){const t=Position.packZoneCoord(e.x,e.z);this.locs[t]||(this.locs[t]=[]),this.locs[t]?.push(e),this.totalLocs++,this.sortLocs(t)}addStaticObj(e){const t=Position.packZoneCoord(e.x,e.z);this.objs[t]||(this.objs[t]=[]),this.objs[t]?.push(e),this.totalObjs++,this.sortObjs(t)}addLoc(e){const t=Position.packZoneCoord(e.x,e.z);if(e.lifecycle===EntityLifeCycle_default.DESPAWN){this.locs[t]||(this.locs[t]=[]),this.locs[t]?.push(e),this.totalLocs++}this.sortLocs(t),this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new LocAddChange(t,e.type,e.shape,e.angle)})}removeLoc(e){const t=Position.packZoneCoord(e.x,e.z);if(e.lifecycle===EntityLifeCycle_default.DESPAWN){const i=this.locs[t];if(i)for(let t=0;t<i.length;t++)if(e===i[t]){i.splice(t,1),this.totalLocs--;break}}this.sortLocs(t),this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new LocDel(t,e.shape,e.angle)})}getLoc(e,t,i){for(const n of this.getLocsSafe(Position.packZoneCoord(e,t)))if(n.type===i)return n;return null}mergeLoc(e,t,i,n,r,a,s,o){this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new LocMerge(e.x,e.z,e.shape,e.angle,e.type,i,n,t.pid,a,r,o,s)})}animLoc(e,t){this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new LocAnim(Position.packZoneCoord(e.x,e.z),e.shape,e.angle,t)})}addObj(e,t){const i=Position.packZoneCoord(e.x,e.z);if(e.lifecycle===EntityLifeCycle_default.DESPAWN){this.objs[i]||(this.objs[i]=[]),this.objs[i]?.push(e),this.totalObjs++}this.sortObjs(i),e.lifecycle===EntityLifeCycle_default.DESPAWN?this.events.add({type:ZoneEventType_default.FOLLOWS,receiverId:t,message:new ObjAdd(i,e.type,e.count)}):e.lifecycle===EntityLifeCycle_default.RESPAWN&&this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:t,message:new ObjAdd(i,e.type,e.count)})}revealObj(e,t){const i=Position.packZoneCoord(e.x,e.z);e.receiverId=-1,e.reveal=-1,this.sortObjs(i),this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new ObjReveal(i,e.type,e.count,t)})}changeObj(e,t,i,n){const r=Position.packZoneCoord(e.x,e.z);e.count=n,this.sortObjs(r),this.events.add({type:ZoneEventType_default.FOLLOWS,receiverId:t,message:new ObjCount(r,e.type,i,n)})}removeObj(e){const t=Position.packZoneCoord(e.x,e.z);if(e.lifecycle===EntityLifeCycle_default.DESPAWN){const i=this.objs[t];if(i)for(let t=0;t<i.length;t++)if(e===i[t]){i.splice(t,1),this.totalObjs--;break}}this.sortObjs(t),e.lifecycle===EntityLifeCycle_default.DESPAWN?this.events.add({type:ZoneEventType_default.FOLLOWS,receiverId:-1,message:new ObjDel(t,e.type)}):e.lifecycle===EntityLifeCycle_default.RESPAWN&&this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new ObjDel(t,e.type)})}animMap(e,t,i,n,r){this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new MapAnim(Position.packZoneCoord(e,t),i,n,r)})}mapProjAnim(e,t,i,n,r,a,s,o,c,l,d,p){this.events.add({type:ZoneEventType_default.ENCLOSED,receiverId:-1,message:new MapProjAnim(e,t,i,n,r,a,s,o,c,l,d,p)})}getObj(e,t,i,n){for(const r of this.getObjsSafe(Position.packZoneCoord(e,t)))if((-1===r.receiverId||r.receiverId===n)&&r.type===i)return r;return null}*getAllPlayersSafe(){for(const e of this.players){const t=World_default.getPlayerByUid(e);t&&t.checkLifeCycle(World_default.currentTick)&&(yield t)}}*getAllNpcsSafe(){for(const e of this.npcs){const t=World_default.getNpc(e);t&&t.checkLifeCycle(World_default.currentTick)&&(yield t)}}*getAllObjsSafe(){for(let e=0;e<this.objs.length;e++){const t=this.objs[e];if(t)for(let e=0;e<t.length;e++){const i=t[e];i.checkLifeCycle(World_default.currentTick)&&(yield i)}}}*getObjsSafe(e){const t=this.objs[e];if(t)for(let e=0;e<t.length;e++){const i=t[e];i.checkLifeCycle(World_default.currentTick)&&(yield i)}}*getObjsUnsafe(e){const t=this.objs[e];if(t)for(let e=0;e<t.length;e++)yield t[e]}*getAllObjsUnsafe(e=!1){for(let t=0;t<this.objs.length;t++){const i=this.objs[t];if(i)if(e)for(let e=i.length-1;e>=0;e--)yield i[e];else for(let e=0;e<i.length;e++)yield i[e]}}*getAllLocsSafe(){for(let e=0;e<this.locs.length;e++){const t=this.locs[e];if(t)for(let e=0;e<t.length;e++){const i=t[e];i.checkLifeCycle(World_default.currentTick)&&(yield i)}}}*getLocsSafe(e){const t=this.locs[e];if(t)for(let e=0;e<t.length;e++){const i=t[e];i.checkLifeCycle(World_default.currentTick)&&(yield i)}}*getLocsUnsafe(e){const t=this.locs[e];if(t)for(let e=0;e<t.length;e++)yield t[e]}*getAllLocsUnsafe(e=!1){for(let t=0;t<this.locs.length;t++){const i=this.locs[t];if(i)if(e)for(let e=i.length-1;e>=0;e--)yield i[e];else for(let e=0;e<i.length;e++)yield i[e]}}sortObjs(e){const t=this.objs[e];if(!t)return;let i=-99999999,n=null;for(const e of t){const t=ObjType.get(e.type);let r=t.cost;t.stackable&&(r*=e.count+1),r+=e.lifecycle,r>i&&(i=r,n=e)}n&&t[0]!==n&&(t.splice(t.indexOf(n),1),t.unshift(n))}sortLocs(e){const t=this.locs[e];if(!t)return;let i=-99999999,n=null;for(const e of t){const t=e.lifecycle;t>i&&(i=t,n=e)}n&&t[0]!==n&&(t.splice(t.indexOf(n),1),t.unshift(n))}}class ZoneGrid{static GRID_SIZE=2048;static INT_BITS=5;static INT_BITS_FLAG=(1<<this.INT_BITS)-1;static DEFAULT_GRID_SIZE=this.GRID_SIZE*(this.GRID_SIZE>>this.INT_BITS);grid;constructor(e=ZoneGrid.DEFAULT_GRID_SIZE){this.grid=new Int32Array(e)}index(e,t){return e<<ZoneGrid.INT_BITS|t>>>ZoneGrid.INT_BITS}flag(e,t){this.grid[this.index(e,t)]|=1<<(t&ZoneGrid.INT_BITS_FLAG)}unflag(e,t){this.grid[this.index(e,t)]&=~(1<<(t&ZoneGrid.INT_BITS_FLAG))}isFlagged(e,t,i){const n=Math.max(0,e-i),r=Math.min(ZoneGrid.GRID_SIZE-1,e+i),a=Math.max(0,t-i),s=Math.min(ZoneGrid.GRID_SIZE-1,t+i),o=ZoneGrid.INT_BITS_FLAG,c=a&~o,l=s>>>ZoneGrid.INT_BITS<<ZoneGrid.INT_BITS;for(let e=n;e<=r;e++)for(let t=c;t<=l;t+=32){const i=this.index(e,t),n=this.grid[i];let r=n;t+o>s&&(r=n&(1<<s-t+1)-1);let c=r;if(t<a&&(c=r>>>a-t),0!==c)return!0}return!1}}class ZoneMap2{static zoneIndex(e,t,i){return e>>3&2047|(t>>3&2047)<<11|(3&i)<<22}static unpackIndex(e){return{x:(2047&e)<<3,z:(e>>11&2047)<<3,level:e>>22}}zones;grids;constructor(){this.zones=new Map,this.grids=new Map}zone(e,t,i){const n=ZoneMap2.zoneIndex(e,t,i);let r=this.zones.get(n);return void 0===r&&(r=new Zone(n),this.zones.set(n,r)),r}zoneByIndex(e){let t=this.zones.get(e);return void 0===t&&(t=new Zone(e),this.zones.set(e,t)),t}grid(e){let t=this.grids.get(e);return void 0===t&&(t=new ZoneGrid,this.grids.set(e,t)),t}zoneCount(){return this.zones.size}locCount(){let e=0;for(const t of this.zones.values())e+=t.totalLocs;return e}objCount(){let e=0;for(const t of this.zones.values())e+=t.totalObjs;return e}}class BuildArea{static INTERVAL=10;static PREFERRED_PLAYERS=250;static PREFERRED_NPCS=255;static PREFERRED_VIEW_DISTANCE=16;npcs;players;loadedZones;activeZones;extendedInfo;appearances;forceViewDistance=!1;viewDistance=BuildArea.PREFERRED_VIEW_DISTANCE;lastResize=0;constructor(){this.npcs=new Set,this.players=new Set,this.loadedZones=new Set,this.activeZones=new Set,this.extendedInfo=new Set,this.appearances=new Map}resize(){if(!this.forceViewDistance)return this.players.size>=BuildArea.PREFERRED_PLAYERS?(this.viewDistance>1&&this.viewDistance--,void(this.lastResize=0)):void(++this.lastResize>=BuildArea.INTERVAL&&(this.viewDistance<BuildArea.PREFERRED_VIEW_DISTANCE?this.viewDistance++:this.lastResize=0))}reset(){this.extendedInfo.clear()}*getNearbyPlayers(e,t,i,n,r){e:for(const a of this.proximitySort(t,i,this.activeZones))for(const s of this.getNearby(World_default.getZoneIndex(a).getAllPlayersSafe(),t,i,n,r,this.viewDistance)){if(this.players.size>=BuildArea.PREFERRED_PLAYERS)break e;this.players.has(s.uid)||s.uid!==e&&(yield s)}}*getNearbyNpcs(e,t,i,n){e:for(const r of this.proximitySort(e,t,this.activeZones))for(const a of this.getNearby(World_default.getZoneIndex(r).getAllNpcsSafe(),e,t,i,n,16)){if(this.npcs.size>=BuildArea.PREFERRED_NPCS)break e;this.npcs.has(a.nid)||(yield a)}}hasAppearance(e,t){const i=this.appearances.get(e);return void 0!==i&&i===t}saveAppearance(e,t){this.appearances.set(e,t)}*getNearby(e,t,i,n,r,a){const s=n-48,o=n+48,c=r+48,l=r-48;for(const n of e)n.x<=s||n.x>=o||n.z>=c||n.z<=l||Position.isWithinDistanceSW({x:t,z:i},n,a)&&(yield n)}proximitySort(e,t,i){return Array.from(i.values()).map((i=>this.zoneToDistance(i,e,t))).sort(((e,t)=>e.distance-t.distance)).map((({zoneIndex:e})=>e))}zoneToDistance(e,t,i){const n=ZoneMap2.unpackIndex(e);return{zoneIndex:e,distance:Math.abs(n.x-t)+Math.abs(n.z-i)}}}function getLevelByExp(e){for(let t=98;t>=0;t--)if(e>=levelExperience[t])return Math.min(t+2,99);return 1}function getExpByLevel(e){return levelExperience[e-2]}var levelExperience=new Int32Array(99),acc=0;for(let e=0;e<99;e++){const t=e+1;acc+=Math.floor(t+300*Math.pow(2,t/7)),levelExperience[e]=10*Math.floor(acc/4)}class Player2 extends PathingEntity{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static SKILLS=["attack","defence","strength","hitpoints","ranged","prayer","magic","cooking","woodcutting","fletching","fishing","firemaking","crafting","smithing","mining","herblore","agility","thieving","stat18","stat19","runecraft"];static DESIGN_BODY_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];save(){}username;username37;displayName;body;colors;gender;runenergy=1e4;lastRunEnergy=-1;runweight;playtime;stats=new Int32Array(21);levels=new Uint8Array(21);vars;varsString;invs=new Map;pid=-1;uid=-1;lowMemory=!1;combatLevel=3;headicons=0;appearance=null;appearanceHashCode=0n;baseLevels=new Uint8Array(21);lastStats=new Int32Array(21);lastLevels=new Uint8Array(21);originX=-1;originZ=-1;buildArea=new BuildArea;lastMovement=0;basReadyAnim=-1;basTurnOnSpot=-1;basWalkForward=-1;basWalkBackward=-1;basWalkLeft=-1;basWalkRight=-1;basRunning=-1;animProtect=0;logoutRequested=!1;invListeners=[];allowDesign=!1;afkEventReady=!1;interactWalkTrigger=!1;highPriorityOut=new Stack;lowPriorityOut=new Stack;lastResponse=-1;messageColor=null;messageEffect=null;messageType=null;message=null;delay=0;queue=new LinkList;weakQueue=new LinkList;engineQueue=new LinkList;cameraPackets=new LinkList;timers=new Map;modalState=0;modalTop=-1;lastModalTop=-1;modalBottom=-1;lastModalBottom=-1;modalSidebar=-1;lastModalSidebar=-1;refreshModalClose=!1;refreshModal=!1;modalSticky=-1;overlaySide=new Array(14).fill(-1);receivedFirstClose=!1;protect=!1;activeScript=null;resumeButtons=[];lastItem=-1;lastSlot=-1;lastUseItem=-1;lastUseSlot=-1;lastTargetSlot=-1;lastCom=-1;staffModLevel=0;heroPoints=new Array(16);afkZones=new Int32Array(2);lastAfkZone=0;constructor(e,t){super(0,3094,3106,1,1,EntityLifeCycle_default.FOREVER,MoveRestrict_default.NORMAL,BlockWalk_default.NPC,MoveStrategy_default.SMART,Player2.FACE_COORD,Player2.FACE_ENTITY),this.username=e,this.username37=t,this.displayName=toDisplayName(e),this.vars=new Int32Array(VarPlayerType.count),this.varsString=new Array(VarPlayerType.count),this.body=[0,10,18,26,33,36,42],this.colors=[0,0,0,0,0],this.gender=0,this.runenergy=1e4,this.runweight=0,this.playtime=0,this.lastStats.fill(-1),this.lastLevels.fill(-1)}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(e,t){const i=this.heroPoints.findIndex((t=>t&&t.uid===e));if(-1!==i)return void(this.heroPoints[i].points+=t);const n=this.heroPoints.findIndex((e=>e&&-1===e.uid));-1===n||(this.heroPoints[n]={uid:e,points:t})}findHero(){return this.heroPoints.sort(((e,t)=>t.points-e.points)),this.heroPoints[0]?.uid??-1}resetEntity(e){super.resetPathingEntity(),this.repathed=!1,this.protect=!1,this.messageColor=null,this.messageEffect=null,this.messageType=null,this.message=null}onLogin(){this.playerLog("Logging in"),this.write(new IfClose),this.write(new UpdateUid192(this.pid)),this.unsetMapFlag(),this.write(new ResetAnims),this.resetHeroPoints(),this.write(new ResetClientVarCache);for(let e=0;e<this.vars.length;e++){const t=VarPlayerType.get(e),i=this.vars[e];t.transmit&&this.writeVarp(e,i)}const e=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.LOGIN,-1,-1);e&&this.executeScript(ScriptRunner2.init(e,this),!0);const t=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.MOVE,-1,-1);if(t){const e=ScriptRunner2.init(t,this);this.runScript(e,!0)}this.lastStepX=this.x-1,this.lastStepZ=this.z}calculateRunWeight(){this.runweight=0;const e=this.invs.values();for(let t=0;t<this.invs.size;t++){const t=e.next().value;if(!t)continue;const i=InvType.get(t.type);if(i&&i.runweight)for(let e=0;e<t.capacity;e++){const i=t.get(e);if(!i)continue;const n=ObjType.get(i.id);n&&!n.stackable&&(this.runweight+=n.weight*i.count)}}}playerLog(e,...t){}processEngineQueue(){for(let e=this.engineQueue.head();null!==e;e=this.engineQueue.next()){const t=e.delay--;if(this.canAccess()&&t<=0){const t=ScriptRunner2.init(e.script,this,null,e.args);this.executeScript(t,!0),e.unlink()}}}updateMovement(e=!0){if(this.containsModalInterface())return this.recoverEnergy(!1),!1;if(e&&this.target instanceof PathingEntity&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),this.hasWaypoints()&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const e=ScriptProvider.get(this.walktrigger);if(this.walktrigger=-1,e){const t=ScriptRunner2.init(e,this);this.runScript(t,!0)}}this.runenergy<100&&(this.setVar(VarPlayerType.PLAYER_RUN,0),this.setVar(VarPlayerType.TEMP_RUN,0)),this.moveSpeed!==MoveSpeed_default.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed(),-1===this.basRunning?this.moveSpeed=MoveSpeed_default.WALK:this.getVar(VarPlayerType.TEMP_RUN)&&(this.moveSpeed=MoveSpeed_default.RUN)),super.processMovement()||this.setVar(VarPlayerType.TEMP_RUN,0);const t=this.lastX!==this.x||this.lastZ!==this.z;if(t){const e=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.MOVE,-1,-1);e&&this.runScript(ScriptRunner2.init(e,this),!0)}return this.drainEnergy(t),this.recoverEnergy(t),0===this.runenergy&&(this.setVar(VarPlayerType.PLAYER_RUN,0),this.setVar(VarPlayerType.TEMP_RUN,0)),t}drainEnergy(e){if(e&&0!==this.stepsTaken&&!this.delayed()&&this.moveSpeed===MoveSpeed_default.RUN&&this.stepsTaken>1){const e=Math.floor(this.runweight/1e3),t=67+67*Math.min(Math.max(e,0),64)/64|0;this.runenergy=Math.max(this.runenergy-t,0)}}recoverEnergy(e){if(!this.delayed()&&(!e||this.moveSpeed!==MoveSpeed_default.RUN)&&this.runenergy<1e4){const e=8+(this.baseLevels[PlayerStat_default.AGILITY]/9|0);this.runenergy=Math.min(this.runenergy+e,1e4)}}blockWalkFlag(){return CollisionFlag.PLAYER}defaultMoveSpeed(){return this.getVar(VarPlayerType.PLAYER_RUN)?MoveSpeed_default.RUN:MoveSpeed_default.WALK}closeSticky(){if(-1!==this.modalSticky){const e=ScriptProvider.getByTrigger(ServerTriggerType_default.IF_CLOSE,this.modalSticky);e&&this.enqueueScript(e,1),this.modalSticky=-1,this.write(new TutorialOpenChat(-1))}}closeModal(){if(this.receivedFirstClose){if(this.weakQueue.clear(),this.delayed()||(this.protect=!1),0!==this.modalState){if(-1!==this.modalTop){const e=ScriptProvider.getByTrigger(ServerTriggerType_default.IF_CLOSE,this.modalTop);e&&this.enqueueScript(e,1),this.modalTop=-1}if(-1!==this.modalBottom){const e=ScriptProvider.getByTrigger(ServerTriggerType_default.IF_CLOSE,this.modalBottom);e&&this.enqueueScript(e,1),this.modalBottom=-1}if(-1!==this.modalSidebar){const e=ScriptProvider.getByTrigger(ServerTriggerType_default.IF_CLOSE,this.modalSidebar);e&&this.enqueueScript(e,1),this.modalSidebar=-1}this.modalState=0,this.refreshModalClose=!0}}else this.receivedFirstClose=!0}delayed(){return this.delay>0}containsModalInterface(){return!(1&~this.modalState&&2&~this.modalState&&16&~this.modalState)}busy(){return this.delayed()||this.containsModalInterface()}canAccess(){return!this.protect&&!this.busy()}enqueueScript(e,t=0,i=0,n=[]){const r=new EntityQueueRequest(t,e,n,i);1===t?(r.delay=0,this.engineQueue.addTail(r)):2===t?this.weakQueue.addTail(r):this.queue.addTail(r)}processQueues(){let e=!1;for(let t=this.queue.head();null!==t;t=this.queue.next())if(3===t.type){e=!0;break}e&&this.closeModal(),this.processQueue(),this.processWeakQueue()}processQueue(){for(let e=this.queue.head();null!==e;e=this.queue.next()){3===e.type&&this.closeModal();const t=e.delay--;if(this.canAccess()&&t<=0){const t=ScriptRunner2.init(e.script,this,null,e.args);this.executeScript(t,!0),e.unlink()}}}processWeakQueue(){for(let e=this.weakQueue.head();null!==e;e=this.weakQueue.next()){const t=e.delay--;if(this.canAccess()&&t<=0){const t=ScriptRunner2.init(e.script,this,null,e.args);this.executeScript(t,!0),e.unlink()}}}setTimer(e,t,i=[],n){const r=t.id,a={type:e,script:t,args:i,interval:n,clock:n};this.timers.set(r,a)}clearTimer(e){this.timers.delete(e)}processTimers(e){for(const t of this.timers.values())if(e===t.type&&--t.clock<=0&&(1===t.type||this.canAccess())){t.clock=t.interval;const e=ScriptRunner2.init(t.script,this,null,t.args);this.runScript(e,0===t.type)}}stopAction(){this.clearPendingAction(),this.unsetMapFlag()}clearPendingAction(){this.clearInteraction(),this.closeModal()}hasInteraction(){return null!==this.target}getOpTrigger(){if(!this.target)return null;let e=-1,t=-1;if(this.target instanceof Npc2||this.target instanceof Loc||this.target instanceof Obj){const i=this.target instanceof Npc2?NpcType.get(this.target.type):this.target instanceof Loc?LocType.get(this.target.type):ObjType.get(this.target.type);e=i.id,t=i.category}return-1!==this.targetSubject.type&&(e=this.targetSubject.type),-1!==this.targetSubject.com&&(e=this.targetSubject.com),ScriptProvider.getByTrigger(this.targetOp+7,e,t)??null}getApTrigger(){if(!this.target)return null;let e=-1,t=-1;if(this.target instanceof Npc2||this.target instanceof Loc||this.target instanceof Obj){const i=this.target instanceof Npc2?NpcType.get(this.target.type):this.target instanceof Loc?LocType.get(this.target.type):ObjType.get(this.target.type);e=i.id,t=i.category}return-1!==this.targetSubject.type&&(e=this.targetSubject.type),-1!==this.targetSubject.com&&(e=this.targetSubject.com),ScriptProvider.getByTrigger(this.targetOp,e,t)??null}processInteraction(){if(null===this.target||!this.canAccess())return void this.updateMovement();if(this.target.level!==this.level)return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Npc2&&(null===World_default.getNpc(this.target.nid)||this.target.delayed()))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Npc2&&-1!==this.targetSubject.type&&null===World_default.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Obj&&null===World_default.getObj(this.target.x,this.target.z,this.level,this.target.type,this.pid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Loc&&null===World_default.getLoc(this.target.x,this.target.z,this.level,this.target.type))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Player2&&null===World_default.getPlayerByUid(this.target.uid))return this.clearInteraction(),void this.unsetMapFlag();if(this.targetOp===ServerTriggerType_default.APPLAYER3||this.targetOp===ServerTriggerType_default.OPPLAYER3){return void(this.updateMovement(!1)&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=World_default.currentTick+1))}const e=this.getOpTrigger(),t=this.getApTrigger();if(e&&this.target instanceof PathingEntity&&this.inOperableDistance(this.target)){const t=this.target;this.target=null,this.executeScript(ScriptRunner2.init(e,this,t),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(t&&this.inApproachDistance(this.apRange,this.target)){const e=this.target;this.target=null,this.executeScript(ScriptRunner2.init(t,this,e),!0),this.apRangeCalled?this.target=e:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if(this.target instanceof PathingEntity&&this.inOperableDistance(this.target)){if(Environment_default.LOCAL_DEV&&!e&&!t){let e="_";this.target instanceof Npc2?e=-1!==this.targetSubject.com&&this.targetOp===ServerTriggerType_default.APNPCT||this.targetOp===ServerTriggerType_default.OPNPCT?Component.get(this.targetSubject.com)?.comName??this.targetSubject.toString():NpcType.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof Loc?e=LocType.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof Obj?e=ObjType.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===ServerTriggerType_default.APNPCT||this.targetOp===ServerTriggerType_default.APPLAYERT||this.targetOp===ServerTriggerType_default.APLOCT||this.targetOp===ServerTriggerType_default.APOBJT?e=Component.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(e=ObjType.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${ServerTriggerType_default[this.targetOp+7].toLowerCase()},${e}]`)}this.target=null,this.messageGame("Nothing interesting happens."),this.interacted=!0,this.clearWaypoints()}const i=this.updateMovement();if(i&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=World_default.currentTick+1),this.target&&(!this.interacted||this.apRangeCalled))if(this.interacted=!1,e&&(this.target instanceof PathingEntity||!i)&&this.inOperableDistance(this.target)){const t=this.target;this.target=null,this.executeScript(ScriptRunner2.init(e,this,t),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(t&&this.inApproachDistance(this.apRange,this.target)){this.apRangeCalled=!1;const e=this.target;this.target=null,this.executeScript(ScriptRunner2.init(t,this,e),!0),this.apRangeCalled?this.target=e:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if((this.target instanceof PathingEntity||!i)&&this.inOperableDistance(this.target)){if(Environment_default.LOCAL_DEV&&!e&&!t){let e="_";this.target instanceof Npc2?e=NpcType.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof Loc?e=LocType.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof Obj?e=ObjType.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===ServerTriggerType_default.APNPCT||this.targetOp===ServerTriggerType_default.APPLAYERT||this.targetOp===ServerTriggerType_default.APLOCT||this.targetOp===ServerTriggerType_default.APOBJT?e=Component.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(e=ObjType.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${ServerTriggerType_default[this.targetOp+7].toLowerCase()},${e}]`)}this.target=null,this.messageGame("Nothing interesting happens."),this.interacted=!0,this.clearWaypoints()}if(!this.interactWalkTrigger&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const e=ScriptProvider.get(this.walktrigger);if(this.walktrigger=-1,e){const t=ScriptRunner2.init(e,this);this.interactWalkTrigger=!0,this.unsetMapFlag(),this.runScript(t,!0)}}this.interacted||this.hasWaypoints()||i||(this.messageGame("I can't reach that!"),this.clearInteraction()),this.interacted&&!this.apRangeCalled&&null===this.target&&this.clearInteraction()}getAppearanceInSlot(e){let t=-1;return 8===e?t=this.body[0]:11===e?t=this.body[1]:4===e?t=this.body[2]:6===e?t=this.body[3]:9===e?t=this.body[4]:7===e?t=this.body[5]:10===e&&(t=this.body[6]),-1===t?0:256+t}getCombatLevel(){const e=.25*(this.baseLevels[PlayerStat_default.DEFENCE]+this.baseLevels[PlayerStat_default.HITPOINTS]+Math.floor(this.baseLevels[PlayerStat_default.PRAYER]/2)),t=.325*(this.baseLevels[PlayerStat_default.ATTACK]+this.baseLevels[PlayerStat_default.STRENGTH]),i=.325*(Math.floor(this.baseLevels[PlayerStat_default.RANGED]/2)+this.baseLevels[PlayerStat_default.RANGED]),n=.325*(Math.floor(this.baseLevels[PlayerStat_default.MAGIC]/2)+this.baseLevels[PlayerStat_default.MAGIC]);return Math.floor(e+Math.max(t,i,n))}generateAppearance(e){const t=Packet.alloc(0);t.p1(this.gender),t.p1(this.headicons);const i=[];let n=this.getInventory(e);n||(n=new Inventory(0));for(let e=0;e<n.capacity;e++){const t=n.get(e);if(!t)continue;const r=ObjType.get(t.id);-1!==r.wearpos2&&-1===i.indexOf(r.wearpos2)&&i.push(r.wearpos2),-1!==r.wearpos3&&-1===i.indexOf(r.wearpos3)&&i.push(r.wearpos3)}const r=[];for(let e=0;e<12;e++){if(-1!==i.indexOf(e)){t.p1(0),r[e]=0n;continue}const a=n.get(e);if(a)t.p2(512+a.id),r[e]=BigInt(512+a.id);else{const i=this.getAppearanceInSlot(e);i<1?(t.p1(0),r[e]=0n):(t.p2(i),r[e]=BigInt(i))}}for(let e=0;e<this.colors.length;e++)t.p1(this.colors[e]);t.p2(this.basReadyAnim),t.p2(this.basTurnOnSpot),t.p2(this.basWalkForward),t.p2(this.basWalkBackward),t.p2(this.basWalkLeft),t.p2(this.basWalkRight),t.p2(this.basRunning),t.p8(this.username37),t.p1(this.combatLevel),this.mask|=Player2.APPEARANCE,this.appearance=new Uint8Array(t.pos),t.pos=0,t.gdata(this.appearance,0,this.appearance.length),t.release(),this.appearanceHashCode=0n;for(let e=0;e<12;e++)this.appearanceHashCode<<=0x4n,r[e]>=256&&(this.appearanceHashCode+=r[e]-256n);r[0]>=256&&(this.appearanceHashCode+=r[0]-256n>>4n),r[1]>=256&&(this.appearanceHashCode+=r[1]-256n>>8n);for(let e=0;e<5;e++)this.appearanceHashCode<<=0x3n,this.appearanceHashCode+=BigInt(this.colors[e]);this.appearanceHashCode<<=0x1n,this.appearanceHashCode+=BigInt(this.gender)}getInventoryFromListener(e){if(-1===e.source)return World_default.getInventory(e.type);{const t=World_default.getPlayerByUid(e.source);return t?t.getInventory(e.type):null}}getInventory(e){if(-1===e)return null;const t=InvType.get(e);let i=null;return t?(t.scope===InvType.SCOPE_SHARED?i=World_default.getInventory(e):(i=this.invs.get(e),i||(i=Inventory.fromType(e),this.invs.set(e,i))),i):null}invListenOnCom(e,t,i){if(-1===e)return;if(-1!==this.invListeners.findIndex((i=>i.type===e&&i.com===t)))return;InvType.get(e).scope===InvType.SCOPE_SHARED&&(i=-1),this.invListeners.push({type:e,com:t,source:i,firstSeen:!0})}invStopListenOnCom(e){const t=this.invListeners.findIndex((t=>t.com===e));-1!==t&&(this.invListeners.splice(t,1),this.write(new UpdateInvStopTransmit(e)))}invGetSlot(e,t){const i=this.getInventory(e);if(!i)throw new Error("invGetSlot: Invalid inventory type: "+e);if(!i.validSlot(t))throw new Error("invGetSlot: Invalid slot: "+t);return i.get(t)}invClear(e){const t=this.getInventory(e);if(!t)throw new Error("invClear: Invalid inventory type: "+e);t.removeAll()}invAdd(e,t,i,n=!0){const r=this.getInventory(e);if(!r)throw new Error("invAdd: Invalid inventory type: "+e);return r.add(t,i,-1,n).completed}invSet(e,t,i,n){const r=this.getInventory(e);if(!r)throw new Error("invSet: Invalid inventory type: "+e);if(!r.validSlot(n))throw new Error("invSet: Invalid slot: "+n);r.set(n,{id:t,count:i})}invDel(e,t,i,n=-1){const r=this.getInventory(e);if(!r)throw new Error("invDel: Invalid inventory type: "+e);if(n<-1||n>=this.invSize(e))throw new Error("invDel: Invalid beginSlot: "+n);return r.remove(t,i,n).completed}invDelSlot(e,t){const i=this.getInventory(e);if(!i)throw new Error("invDelSlot: Invalid inventory type: "+e);if(!i.validSlot(t))throw new Error("invDelSlot: Invalid slot: "+t);i.delete(t)}invSize(e){const t=this.getInventory(e);if(!t)throw new Error("invSize: Invalid inventory type: "+e);return t.capacity}invTotal(e,t){const i=this.getInventory(e);if(!i)throw new Error("invTotal: Invalid inventory type: "+e);return i.getItemCount(t)}invFreeSpace(e){const t=this.getInventory(e);if(!t)throw new Error("invFreeSpace: Invalid inventory type: "+e);return t.freeSlotCount}invItemSpace(e,t,i,n){const r=this.getInventory(e);if(!r)throw new Error("invItemSpace: Invalid inventory type: "+e);const a=ObjType.get(t);let s=t;if(a.certtemplate>=0&&a.certlink>=0&&(s=a.certlink),a.stackable||s!=t||r.stackType==Inventory.ALWAYS_STACK){const n=!0===InvType.get(e).stockobj?.includes(t);return 0!=this.invTotal(e,t)||0!=this.invFreeSpace(e)||n?Math.max(0,i-(Inventory.STACK_LIMIT-this.invTotal(e,t))):i}return Math.max(0,i-(this.invFreeSpace(e)-(this.invSize(e)-n)))}invMoveToSlot(e,t,i,n){const r=this.getInventory(e);if(!r)throw new Error("invMoveToSlot: Invalid inventory type: "+e);if(!r.validSlot(i))throw new Error("invMoveToSlot: Invalid from slot: "+i);const a=this.getInventory(t);if(!a)throw new Error("invMoveToSlot: Invalid inventory type: "+t);if(!a.validSlot(n))throw new Error("invMoveToSlot: Invalid to slot: "+n);const s=this.invGetSlot(e,i);if(!s)throw new Error(`invMoveToSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${i}`);const o=this.invGetSlot(t,n);this.invSet(t,s.id,s.count,n),o?this.invSet(e,o.id,o.count,i):this.invDelSlot(e,i)}invMoveFromSlot(e,t,i){const n=this.getInventory(e);if(!n)throw new Error("invMoveFromSlot: Invalid inventory type: "+e);if(!this.getInventory(t))throw new Error("invMoveFromSlot: Invalid inventory type: "+t);if(!n.validSlot(i))throw new Error("invMoveFromSlot: Invalid from slot: "+i);const r=this.invGetSlot(e,i);if(!r)throw new Error(`invMoveFromSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${i}`);return{overflow:r.count-this.invAdd(t,r.id,r.count),fromObj:r.id}}invTotalCat(e,t){const i=this.getInventory(e);if(!i)throw new Error("invTotalCat: Invalid inventory type: "+e);return i.itemsFiltered.filter((e=>ObjType.get(e.id).category==t)).reduce(((e,t)=>e+t.count),0)}_invTotalParam(e,t,i){const n=this.getInventory(e);if(!n)throw new Error("invTotalParam: Invalid inventory type: "+e);const r=ParamType.get(t);let a=0;for(let e=0;e<n.capacity;e++){const t=n.items[e];if(!t||t.id<0||t.id>=ObjType.count)continue;const s=ObjType.get(t.id),o=ParamHelper.getIntParam(r.id,s,r.defaultInt);a+=i?t.count*o:o}return a}invTotalParam(e,t){return this._invTotalParam(e,t,!1)}invTotalParamStack(e,t){return this._invTotalParam(e,t,!0)}getVar(e){const t=VarPlayerType.get(e);return t.type===ScriptVarType.STRING?this.varsString[t.id]:this.vars[t.id]}setVar(e,t){const i=VarPlayerType.get(e);i.type===ScriptVarType.STRING&&"string"==typeof t?this.varsString[i.id]=t:"number"==typeof t&&(this.vars[i.id]=t,i.transmit&&this.writeVarp(e,t))}writeVarp(e,t){t>=-128&&t<=127?this.write(new VarpSmall(e,t)):this.write(new VarpLarge(e,t))}addXp(e,t){if(t<0)throw new Error(`Invalid xp parameter for addXp call: Stat was: ${e}, Exp was: ${t}`);if(0==t)return;const i=Number(Environment_default.XP_MULTIPLIER)||1;this.stats[e]+=t*i,this.stats[e]>2e9&&(this.stats[e]=2e9);const n=this.baseLevels[e];if(this.levels[e]===this.baseLevels[e]&&(this.levels[e]=getLevelByExp(this.stats[e])),this.baseLevels[e]=getLevelByExp(this.stats[e]),this.baseLevels[e]>n){this.levels[e]<n&&(this.levels[e]+=1);const t=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.LEVELUP,e,-1);t&&this.enqueueScript(t,1)}this.combatLevel!=this.getCombatLevel()&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance(InvType.WORN))}setLevel(e,t){t=Math.min(99,Math.max(1,t)),this.baseLevels[e]=t,this.levels[e]=t,this.stats[e]=getExpByLevel(t),this.getCombatLevel()!=this.combatLevel&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance(InvType.WORN))}playAnimation(e,t){e>=SeqType.count||this.animProtect||(-1==e||-1==this.animId||SeqType.get(e).priority>SeqType.get(this.animId).priority||0===SeqType.get(this.animId).priority)&&(this.animId=e,this.animDelay=t,this.mask|=Player2.ANIM)}spotanim(e,t,i){this.graphicId=e,this.graphicHeight=t,this.graphicDelay=i,this.mask|=Player2.SPOTANIM}applyDamage(e,t){this.damageTaken=e,this.damageType=t;const i=this.levels[PlayerStat_default.HITPOINTS];i-e<=0?(this.levels[PlayerStat_default.HITPOINTS]=0,this.damageTaken=i):this.levels[PlayerStat_default.HITPOINTS]=i-e,this.mask|=Player2.DAMAGE}say(e){this.chat=e,this.mask|=Player2.SAY}faceSquare(e,t){this.faceX=2*e+1,this.faceZ=2*t+1,this.orientation=Position.face(this.x,this.z,e,t),this.mask|=Player2.FACE_COORD}playSong(e){if(!(e=e.toLowerCase().replaceAll(" ","_")))return;const t=PRELOADED.get(e+".mid"),i=PRELOADED_CRC.get(e+".mid");if(t&&i){const n=t.length;this.write(new MidiSong(e,i,n))}}playJingle(e,t){if(!(t=t.toLowerCase().replaceAll("_"," ")))return;const i=PRELOADED.get(t+".mid");i&&this.write(new MidiJingle(e,i))}openMainModal(e){4&this.modalState&&(this.write(new IfClose),this.modalState&=-5,this.modalSidebar=-1),this.modalState|=1,this.modalTop=e,this.refreshModal=!0}openChat(e){this.modalState|=2,this.modalBottom=e,this.refreshModal=!0}openSideOverlay(e){this.modalState|=4,this.modalSidebar=e,this.refreshModal=!0}openChatSticky(e){this.write(new TutorialOpenChat(e)),this.modalState|=8,this.modalSticky=e}openMainModalSideOverlay(e,t){this.modalState|=1,this.modalTop=e,this.modalState|=4,this.modalSidebar=t,this.refreshModal=!0}exactMove(e,t,i,n,r,a,s){this.exactStartX=e,this.exactStartZ=t,this.exactEndX=i,this.exactEndZ=n,this.exactMoveStart=r,this.exactMoveEnd=a,this.exactMoveDirection=s,this.mask|=Player2.EXACT_MOVE,this.x=i,this.z=n,this.lastStepX=this.x-1,this.lastStepZ=this.z}setTab(e,t){this.overlaySide[t]=e,this.write(new IfOpenSideOverlay(e,t))}isComponentVisible(e){return this.modalTop===e.rootLayer||this.modalBottom===e.rootLayer||this.modalSidebar===e.rootLayer||-1!==this.overlaySide.findIndex((t=>t===e.rootLayer))||this.modalSticky===e.rootLayer}updateAfkZones(){if(this.lastAfkZone=Math.min(1e3,this.lastAfkZone+1),this.withinAfkZone())return;const e=Position.packCoord(0,this.x-10,this.z-10);this.moveSpeed===MoveSpeed_default.INSTANT&&this.jump?this.afkZones[1]=e:this.afkZones[1]=this.afkZones[0],this.afkZones[0]=e,this.lastAfkZone=0}zonesAfk(){return 1e3===this.lastAfkZone}withinAfkZone(){for(let e=0;e<this.afkZones.length;e++){const t=Position.unpackCoord(this.afkZones[e]);if(Position.intersects(this.x,this.z,this.width,this.length,t.x,t.z,21,21))return!0}return!1}isInWilderness(){return this.x>=2944&&this.x<3392&&this.z>=3520&&this.z<6400||this.x>=2944&&this.x<3392&&this.z>=9920&&this.z<12800}runScript(e,t=!1,i=!1){if(!i&&t&&(this.protect||this.delayed()))return-1;t&&(e.pointerAdd(ScriptPointer_default.ProtectedActivePlayer),this.protect=!0);const n=ScriptRunner2.execute(e);return t&&(this.protect=!1),e.pointerGet(ScriptPointer_default.ProtectedActivePlayer)&&e._activePlayer&&(e.pointerRemove(ScriptPointer_default.ProtectedActivePlayer),e._activePlayer.protect=!1),e.pointerGet(ScriptPointer_default.ProtectedActivePlayer2)&&e._activePlayer2&&(e.pointerRemove(ScriptPointer_default.ProtectedActivePlayer2),e._activePlayer2.protect=!1),n}executeScript(e,t=!1,i=!1){const n=this.runScript(e,t,i);-1!==n&&(n!==ScriptState.FINISHED&&n!==ScriptState.ABORTED?n===ScriptState.WORLD_SUSPENDED?World_default.enqueueScript(e,e.popInt()):n===ScriptState.NPC_SUSPENDED?e.activeNpc.activeScript=e:(e.activePlayer.activeScript=e,e.activePlayer.protect=t):e===this.activeScript&&(this.activeScript=null,1&this.modalState||this.closeModal()))}wrappedMessageGame(e){const t=FontType.get(1).split(e,456);for(const e of t)this.messageGame(e)}write(e){e.priority===ServerProtPriority.HIGH?this.highPriorityOut.push(e):this.lowPriorityOut.push(e)}unsetMapFlag(){this.clearWaypoints(),this.write(new UnsetMapFlag)}hintNpc(e){this.write(new HintArrow(1,e,0,0,0,0))}hintTile(e,t,i,n){this.write(new HintArrow(e,0,0,t,i,n))}hintPlayer(e){this.write(new HintArrow(10,0,e,0,0,0))}stopHint(){this.write(new HintArrow(-1,0,0,0,0,0))}lastLoginInfo(e,t,i,n){this.write(new LastLoginInfo(e,t,i,n)),this.modalState|=16}logout(){}terminate(){}messageGame(e){this.write(new MessageGame(e))}}class ClientProt{index;id;length;static all=[];static byId=[];static REBUILD_GETMAPS=new ClientProt(4,150,-1);static NO_TIMEOUT=new ClientProt(6,108,0);static IDLE_TIMER=new ClientProt(30,70,0);static EVENT_TRACKING=new ClientProt(34,81,-2);static EVENT_CAMERA_POSITION=new ClientProt(35,189,6);static ANTICHEAT_OPLOGIC1=new ClientProt(60,7,4);static ANTICHEAT_OPLOGIC2=new ClientProt(61,88,4);static ANTICHEAT_OPLOGIC3=new ClientProt(62,30,3);static ANTICHEAT_OPLOGIC4=new ClientProt(63,176,2);static ANTICHEAT_OPLOGIC5=new ClientProt(64,220,0);static ANTICHEAT_OPLOGIC6=new ClientProt(65,66,4);static ANTICHEAT_OPLOGIC7=new ClientProt(66,17,4);static ANTICHEAT_OPLOGIC8=new ClientProt(67,2,2);static ANTICHEAT_OPLOGIC9=new ClientProt(68,238,1);static ANTICHEAT_CYCLELOGIC1=new ClientProt(70,233,1);static ANTICHEAT_CYCLELOGIC2=new ClientProt(71,146,-1);static ANTICHEAT_CYCLELOGIC3=new ClientProt(74,215,3);static ANTICHEAT_CYCLELOGIC4=new ClientProt(72,236,4);static ANTICHEAT_CYCLELOGIC5=new ClientProt(75,85,0);static ANTICHEAT_CYCLELOGIC6=new ClientProt(73,219,-1);static OPOBJ1=new ClientProt(80,140,6);static OPOBJ2=new ClientProt(81,40,6);static OPOBJ3=new ClientProt(82,200,6);static OPOBJ4=new ClientProt(83,178,6);static OPOBJ5=new ClientProt(84,247,6);static OPOBJT=new ClientProt(88,138,8);static OPOBJU=new ClientProt(89,239,12);static OPNPC1=new ClientProt(100,194,2);static OPNPC2=new ClientProt(101,8,2);static OPNPC3=new ClientProt(102,27,2);static OPNPC4=new ClientProt(103,113,2);static OPNPC5=new ClientProt(104,100,2);static OPNPCT=new ClientProt(108,134,4);static OPNPCU=new ClientProt(109,202,8);static OPLOC1=new ClientProt(120,245,6);static OPLOC2=new ClientProt(121,172,6);static OPLOC3=new ClientProt(122,96,6);static OPLOC4=new ClientProt(123,97,6);static OPLOC5=new ClientProt(124,116,6);static OPLOCT=new ClientProt(128,9,8);static OPLOCU=new ClientProt(129,75,12);static OPPLAYER1=new ClientProt(140,164,2);static OPPLAYER2=new ClientProt(141,53,2);static OPPLAYER3=new ClientProt(142,185,2);static OPPLAYER4=new ClientProt(143,206,2);static OPPLAYERT=new ClientProt(148,177,4);static OPPLAYERU=new ClientProt(149,248,8);static OPHELD1=new ClientProt(160,195,6);static OPHELD2=new ClientProt(161,71,6);static OPHELD3=new ClientProt(162,133,6);static OPHELD4=new ClientProt(163,157,6);static OPHELD5=new ClientProt(164,211,6);static OPHELDT=new ClientProt(168,48,8);static OPHELDU=new ClientProt(169,130,12);static INV_BUTTON1=new ClientProt(190,31,6);static INV_BUTTON2=new ClientProt(191,59,6);static INV_BUTTON3=new ClientProt(192,212,6);static INV_BUTTON4=new ClientProt(193,38,6);static INV_BUTTON5=new ClientProt(194,6,6);static IF_BUTTON=new ClientProt(200,155,2);static RESUME_PAUSEBUTTON=new ClientProt(201,235,2);static CLOSE_MODAL=new ClientProt(202,231,0);static RESUME_P_COUNTDIALOG=new ClientProt(203,237,4);static TUTORIAL_CLICKSIDE=new ClientProt(204,175,1);static MOVE_OPCLICK=new ClientProt(242,93,-1);static BUG_REPORT=new ClientProt(243,190,10);static MOVE_MINIMAPCLICK=new ClientProt(244,165,-1);static INV_BUTTOND=new ClientProt(245,159,6);static IGNORELIST_DEL=new ClientProt(246,171,8);static IGNORELIST_ADD=new ClientProt(247,79,8);static IF_PLAYERDESIGN=new ClientProt(248,52,13);static CHAT_SETMODE=new ClientProt(249,244,3);static MESSAGE_PRIVATE=new ClientProt(250,148,-1);static FRIENDLIST_DEL=new ClientProt(251,11,8);static FRIENDLIST_ADD=new ClientProt(252,118,8);static CLIENT_CHEAT=new ClientProt(253,4,-1);static MESSAGE_PUBLIC=new ClientProt(254,158,-1);static MOVE_GAMECLICK=new ClientProt(255,181,-1);constructor(e,t,i){this.index=e,this.id=t,this.length=i,ClientProt.all[e]=this,ClientProt.byId[t]=this}}class MessageDecoder{}class IncomingMessage{}class ClientProtCategory{id;limit;static CLIENT_EVENT=new ClientProtCategory(0,20);static USER_EVENT=new ClientProtCategory(1,5);constructor(e,t){this.id=e,this.limit=t}}class ClientCheat extends IncomingMessage{input;category=ClientProtCategory.USER_EVENT;constructor(e){super(),this.input=e}}class ClientCheatDecoder extends MessageDecoder{prot=ClientProt.CLIENT_CHEAT;decode(e){const t=e.gjstr();return new ClientCheat(t)}}class CloseModal extends IncomingMessage{category=ClientProtCategory.USER_EVENT}class CloseModalDecoder extends MessageDecoder{prot=ClientProt.CLOSE_MODAL;decode(){return new CloseModal}}class IdleTimer extends IncomingMessage{category=ClientProtCategory.CLIENT_EVENT}class IdleTimerDecoder extends MessageDecoder{prot=ClientProt.IDLE_TIMER;decode(){return new IdleTimer}}class IfButton extends IncomingMessage{component;category=ClientProtCategory.USER_EVENT;constructor(e){super(),this.component=e}}class IfButtonDecoder extends MessageDecoder{prot=ClientProt.IF_BUTTON;decode(e){const t=e.g2();return new IfButton(t)}}class IfPlayerDesign extends IncomingMessage{gender;idkit;color;category=ClientProtCategory.USER_EVENT;constructor(e,t,i){super(),this.gender=e,this.idkit=t,this.color=i}}class IfPlayerDesignDecoder extends MessageDecoder{prot=ClientProt.IF_PLAYERDESIGN;decode(e){const t=e.g1(),i=[];for(let t=0;t<7;t++)i[t]=e.g1(),255===i[t]&&(i[t]=-1);const n=[];for(let t=0;t<5;t++)n[t]=e.g1();return new IfPlayerDesign(t,i,n)}}class InvButton extends IncomingMessage{op;obj;slot;component;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.op=e,this.obj=t,this.slot=i,this.component=n}}class InvButtonDecoder extends MessageDecoder{prot;op;constructor(e,t){super(),this.prot=e,this.op=t}decode(e){const t=e.g2(),i=e.g2(),n=e.g2();return new InvButton(this.op,t,i,n)}}class InvButtonD extends IncomingMessage{component;slot;targetSlot;category=ClientProtCategory.USER_EVENT;constructor(e,t,i){super(),this.component=e,this.slot=t,this.targetSlot=i}}class InvButtonDDecoder extends MessageDecoder{prot=ClientProt.INV_BUTTOND;decode(e){const t=e.g2(),i=e.g2(),n=e.g2();return new InvButtonD(t,i,n)}}class MessagePrivate3 extends IncomingMessage{username;input;category=ClientProtCategory.USER_EVENT;constructor(e,t){super(),this.username=e,this.input=t}}class MessagePrivateDecoder extends MessageDecoder{prot=ClientProt.MESSAGE_PRIVATE;decode(e){const t=e.g8(),i=WordPack.unpack(e,e.length-8);return new MessagePrivate3(t,i)}}class MessagePublic extends IncomingMessage{input;color;effect;category=ClientProtCategory.USER_EVENT;constructor(e,t,i){super(),this.input=e,this.color=t,this.effect=i}}class MessagePublicDecoder extends MessageDecoder{prot=ClientProt.MESSAGE_PUBLIC;decode(e){const t=e.g1(),i=e.g1(),n=WordPack.unpack(e,e.length-2);return new MessagePublic(n,t,i)}}class OpHeld extends IncomingMessage{op;obj;slot;component;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.op=e,this.obj=t,this.slot=i,this.component=n}}class OpHeldDecoder extends MessageDecoder{prot;op;constructor(e,t){super(),this.prot=e,this.op=t}decode(e){const t=e.g2(),i=e.g2(),n=e.g2();return new OpHeld(this.op,t,i,n)}}class OpHeldT extends IncomingMessage{obj;slot;component;spellComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.obj=e,this.slot=t,this.component=i,this.spellComponent=n}}class OpHeldTDecoder extends MessageDecoder{prot=ClientProt.OPHELDT;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2();return new OpHeldT(t,i,n,r)}}class OpHeldU extends IncomingMessage{obj;slot;component;useObj;useSlot;useComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n,r,a){super(),this.obj=e,this.slot=t,this.component=i,this.useObj=n,this.useSlot=r,this.useComponent=a}}class OpHeldUDecoder extends MessageDecoder{prot=ClientProt.OPHELDU;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2(),a=e.g2(),s=e.g2();return new OpHeldU(t,i,n,r,a,s)}}class OpLoc extends IncomingMessage{op;x;z2;loc;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.op=e,this.x=t,this.z=i,this.loc=n}}class OpLocDecoder extends MessageDecoder{prot;op;constructor(e,t){super(),this.prot=e,this.op=t}decode(e){const t=e.g2(),i=e.g2(),n=e.g2();return new OpLoc(this.op,t,i,n)}}class OpLocT extends IncomingMessage{x;z2;loc;spellComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.x=e,this.z=t,this.loc=i,this.spellComponent=n}}class OpLocTDecoder extends MessageDecoder{prot=ClientProt.OPLOCT;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2();return new OpLocT(t,i,n,r)}}class OpLocU extends IncomingMessage{x;z2;loc;useObj;useSlot;useComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n,r,a){super(),this.x=e,this.z=t,this.loc=i,this.useObj=n,this.useSlot=r,this.useComponent=a}}class OpLocUDecoder extends MessageDecoder{prot=ClientProt.OPLOCU;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2(),a=e.g2(),s=e.g2();return new OpLocU(t,i,n,r,a,s)}}class OpNpc extends IncomingMessage{op;nid;category=ClientProtCategory.USER_EVENT;constructor(e,t){super(),this.op=e,this.nid=t}}class OpNpcDecoder extends MessageDecoder{prot;op;constructor(e,t){super(),this.prot=e,this.op=t}decode(e){const t=e.g2();return new OpNpc(this.op,t)}}class OpNpcT extends IncomingMessage{nid;spellComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t){super(),this.nid=e,this.spellComponent=t}}class OpNpcTDecoder extends MessageDecoder{prot=ClientProt.OPNPCT;decode(e){const t=e.g2(),i=e.g2();return new OpNpcT(t,i)}}class OpNpcU extends IncomingMessage{nid;useObj;useSlot;useComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.nid=e,this.useObj=t,this.useSlot=i,this.useComponent=n}}class OpNpcUDecoder extends MessageDecoder{prot=ClientProt.OPNPCU;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2();return new OpNpcU(t,i,n,r)}}class OpObj extends IncomingMessage{op;x;z2;obj;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.op=e,this.x=t,this.z=i,this.obj=n}}class OpObjDecoder extends MessageDecoder{prot;op;constructor(e,t){super(),this.prot=e,this.op=t}decode(e){const t=e.g2(),i=e.g2(),n=e.g2();return new OpObj(this.op,t,i,n)}}class OpObjT extends IncomingMessage{x;z2;obj;spellComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.x=e,this.z=t,this.obj=i,this.spellComponent=n}}class OpObjTDecoder extends MessageDecoder{prot=ClientProt.OPOBJT;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2();return new OpObjT(t,i,n,r)}}class OpObjU extends IncomingMessage{x;z2;obj;useObj;useSlot;useComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n,r,a){super(),this.x=e,this.z=t,this.obj=i,this.useObj=n,this.useSlot=r,this.useComponent=a}}class OpObjUDecoder extends MessageDecoder{prot=ClientProt.OPOBJU;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2(),a=e.g2(),s=e.g2();return new OpObjU(t,i,n,r,a,s)}}class OpPlayer extends IncomingMessage{op;pid;category=ClientProtCategory.USER_EVENT;constructor(e,t){super(),this.op=e,this.pid=t}}class OpPlayerDecoder extends MessageDecoder{prot;op;constructor(e,t){super(),this.prot=e,this.op=t}decode(e){const t=e.g2();return new OpPlayer(this.op,t)}}class OpPlayerT extends IncomingMessage{pid;spellComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t){super(),this.pid=e,this.spellComponent=t}}class OpPlayerTDecoder extends MessageDecoder{prot=ClientProt.OPPLAYERT;decode(e){const t=e.g2(),i=e.g2();return new OpPlayerT(t,i)}}class OpPlayerU extends IncomingMessage{pid;useObj;useSlot;useComponent;category=ClientProtCategory.USER_EVENT;constructor(e,t,i,n){super(),this.pid=e,this.useObj=t,this.useSlot=i,this.useComponent=n}}class OpPlayerUDecoder extends MessageDecoder{prot=ClientProt.OPPLAYERU;decode(e){const t=e.g2(),i=e.g2(),n=e.g2(),r=e.g2();return new OpPlayerU(t,i,n,r)}}class RebuildGetMaps extends IncomingMessage{maps;category=ClientProtCategory.USER_EVENT;constructor(e){super(),this.maps=e}}class RebuildGetMapsDecoder extends MessageDecoder{prot=ClientProt.REBUILD_GETMAPS;decode(e){const t=[],i=e.length/3;for(let n=0;n<i;n++){const i=e.g1(),n=e.g1(),r=e.g1();t.push({type:i,x:n,z:r})}return new RebuildGetMaps(t)}}class ResumePauseButton extends IncomingMessage{category=ClientProtCategory.USER_EVENT}class ResumePauseButtonDecoder extends MessageDecoder{prot=ClientProt.RESUME_PAUSEBUTTON;decode(){return new ResumePauseButton}}class ResumePCountDialog extends IncomingMessage{input;category=ClientProtCategory.USER_EVENT;constructor(e){super(),this.input=e}}class ResumePCountDialogDecoder extends MessageDecoder{prot=ClientProt.RESUME_P_COUNTDIALOG;decode(e){const t=e.g4();return new ResumePCountDialog(t)}}class TutorialClickSide extends IncomingMessage{tab;category=ClientProtCategory.USER_EVENT;constructor(e){super(),this.tab=e}}class TutorialClickSideDecoder extends MessageDecoder{prot=ClientProt.TUTORIAL_CLICKSIDE;decode(e){const t=e.g1();return new TutorialClickSide(t)}}class MessageHandler{}class InvButtonHandler extends MessageHandler{handle(e,t){const{op:i,obj:n,slot:r,component:a}=e,s=Component.get(a);if(void 0===s||!s.inventoryOptions||!s.inventoryOptions.length||!t.isComponentVisible(s))return!1;if(!s.inventoryOptions[i-1])return!1;const o=t.invListeners.find((e=>e.com===a));if(!o)return!1;const c=t.getInventoryFromListener(o);if(!c||!c.validSlot(r)||!c.hasAt(r,n))return!1;if(t.delayed())return!1;let l;t.lastItem=n,t.lastSlot=r,l=1===i?ServerTriggerType_default.INV_BUTTON1:2===i?ServerTriggerType_default.INV_BUTTON2:3===i?ServerTriggerType_default.INV_BUTTON3:4===i?ServerTriggerType_default.INV_BUTTON4:ServerTriggerType_default.INV_BUTTON5;const d=ScriptProvider.getByTrigger(l,a,-1);if(d){const e=Component.get(s.rootLayer);t.executeScript(ScriptRunner2.init(d,t),0==e.overlay)}else Environment_default.LOCAL_DEV&&t.messageGame(`No trigger for [${ServerTriggerType_default.toString(l)},${s.comName}]`);return!0}}class ClientSocket{state=-1;remoteAddress;totalBytesRead=0;totalBytesWritten=0;uniqueId=0;encryptor=null;decryptor=null;in=new Uint8Array(5e3);inOffset=0;inCount=new Uint8Array(256);out=new Packet(new Uint8Array(5e3));player=null;constructor(e="0",t=-1){this.remoteAddress=e,this.state=t}send(e){this.totalBytesWritten+=e.length,self.postMessage(e)}close(){setTimeout((()=>{self.close()}),100)}terminate(){self.close()}reset(){this.inOffset=0,this.inCount.fill(0)}writeImmediate(e){this.send(e)}flush(){const e=this.out;0!==e.pos&&(this.send(e.data.subarray(0,e.pos)),e.pos=0)}}class NullClientSocket extends ClientSocket{constructor(){super(null,"")}isTCP(){return this.type===ClientSocket.TCP}isWebSocket(){return this.type===ClientSocket.WEBSOCKET}send(e){this.socket}close(){this.socket}terminate(){this.socket}reset(){this.inOffset=0,this.inCount.fill(0)}}function tryParseInt(e,t){if("number"==typeof e)return e;if("string"!=typeof e&&"number"!=typeof e)return t;const i=parseInt(e);return isNaN(i)?t:i}class ClientCheatHandler extends MessageHandler{handle(e,t){if(e.input.length>80)return!1;const{input:i}=e,n=i.toLowerCase().split(" "),r=n.shift();if(void 0===r||r.length<=0)return!1;if(t.playerLog("Cheat ran",i),"advancestat"===r){if(n.length<1)return!1;const e=Player2.SKILLS.indexOf(n[0]),i=Math.min(99,Math.max(1,tryParseInt(n[1],1)));if(-1===e)return!1;t.setLevel(e,t.baseLevels[e]+i)}else if("getcoord"===r)t.messageGame(Position.formatString(t.level,t.x,t.z,"_"));else if("getvar"===r){if(n.length<1)return!1;const e=VarPlayerType.getId(n[0]);if(-1===e)return!1;const i=t.getVar(e);t.messageGame("get "+n[0]+": "+i)}else if("give"===r){if(n.length<1)return!1;const e=ObjType.getId(n[0]),i=Math.max(1,Math.min(tryParseInt(n[1],1),2147483647));if(-1===e)return!1;t.invAdd(InvType.INV,e,i,!1)}else if("givecrap"===r);else if("givemany"===r);else if("setstat"===r){if(n.length<2)return!1;const e=Player2.SKILLS.indexOf(n[0]);if(-1===e)return!1;t.setLevel(e,parseInt(n[1]))}else if("setvar"===r){if(n.length<2)return!1;const e=VarPlayerType.getId(n[0]),i=Math.max(-2147483648,Math.min(tryParseInt(n[1],0),2147483647));if(-1===e)return!1;t.setVar(e,i),t.messageGame("set "+n[0]+": to "+i)}else if("tele"===r){if(n.length<1)return!1;if("up"===n[0])t.teleJump(t.x,t.z,t.level+1),t.messageGame("::tele "+Position.formatString(t.level,t.x,t.z,","));else if("down"===n[0])t.teleJump(t.x,t.z,t.level-1),t.messageGame("::tele "+Position.formatString(t.level,t.x,t.z,","));else if(-1===n[0].indexOf(","))t.teleJump(tryParseInt(n[0],3200),tryParseInt(n[1],3200),tryParseInt(n[2],t.level));else{const e=n[0].split(",");if(5!==e.length)return!1;const i=tryParseInt(e[0],0),r=tryParseInt(e[1],50),a=tryParseInt(e[2],50),s=tryParseInt(e[3],0),o=tryParseInt(e[4],0);if(i<0||i>3||r<0||r>255||a<0||a>255||s<0||s>63||o<0||o>63)return!1;t.teleJump((r<<6)+s,(a<<6)+o,i)}}else if("reload"===r&&Environment_default.LOCAL_DEV){World_default.reload();const e=ScriptProvider.load("data/pack");t.messageGame(`Reloaded ${e} scripts.`)}else if("rebuild"===r&&Environment_default.LOCAL_DEV)World_default.devThread.postMessage({type:"pack"});else if("setxp"===r){if(n.length<2)return t.messageGame("Usage: ::setxp <stat> <xp>"),!1;const e=Player2.SKILLS.indexOf(n[0]);if(-1===e)return t.messageGame(`Unknown stat ${n[0]}`),!1;const i=10*parseInt(n[1]);t.stats[e]=i}else if("minlevel"===r)for(let e=0;e<Player2.SKILLS.length;e++)e===PlayerStat_default.HITPOINTS?t.setLevel(e,10):t.setLevel(e,1);else if("serverdrop"===r)t.terminate();else if("random"===r)t.afkEventReady=!0;else if("bench"===r&&t.staffModLevel>=3){const e=Date.now();for(let e=0;e<1e5;e++)findPath(t.level,t.x,t.z,t.x,t.z+10);const i=Date.now();console.log(`took = ${i-e} ms`)}else if("bots"===r&&t.staffModLevel>=3){t.messageGame("Adding bots");for(let e=0;e<2e3;e++){const t=new NetworkPlayer2(`bot${e}`,toBase37(`bot${e}`),new NullClientSocket);t.onLogin(),World_default.addPlayer(t)}}else if("teleall"===r&&t.staffModLevel>=3){t.messageGame("Teleporting all players");for(const e of World_default.players){e.closeModal();do{const t=Math.floor(64*Math.random())+3200,i=Math.floor(64*Math.random())+3200;e.teleport(t+Math.floor(64*Math.random())-32,i+Math.floor(64*Math.random())-32,0)}while(isFlagged(e.x,e.z,e.level,CollisionFlag.WALK_BLOCKED))}}else if("moveall"===r&&t.staffModLevel>=3){t.messageGame("Moving all players"),console.time("moveall");for(const e of World_default.players)e.closeModal(),e.queueWaypoints(findPath(e.level,e.x,e.z,32+(e.x>>>6<<6),32+(e.z>>>6<<6)));console.timeEnd("moveall")}else if("speed"===r&&t.staffModLevel>=3){if(n.length<1)return t.messageGame("Usage: ::speed <ms>"),!1;const e=tryParseInt(n.shift(),20);if(e<20)return t.messageGame("::speed input was too low."),!1;t.messageGame(`World speed was changed to ${e}ms`),World_default.tickRate=e}else"fly"===r&&t.staffModLevel>=3?(t.moveStrategy===MoveStrategy_default.FLY?t.moveStrategy=MoveStrategy_default.SMART:t.moveStrategy=MoveStrategy_default.FLY,t.messageGame(`Fly is on? ${t.moveStrategy===MoveStrategy_default.FLY}`)):"naive"===r&&t.staffModLevel>=3&&(t.moveStrategy===MoveStrategy_default.NAIVE?t.moveStrategy=MoveStrategy_default.SMART:t.moveStrategy=MoveStrategy_default.NAIVE,t.messageGame(`Naive is on? ${t.moveStrategy===MoveStrategy_default.NAIVE}`));const a=ScriptProvider.getByName(`[debugproc,${r}]`);if(!a)return!1;const s=new Array(a.info.parameterTypes.length).fill(-1);for(let e=0;e<a.info.parameterTypes.length;e++){const t=a.info.parameterTypes[e];try{switch(t){case ScriptVarType.STRING:{const t=n.shift();s[e]=t??"";break}case ScriptVarType.INT:{const t=n.shift();s[e]=0|parseInt(t??"0",10);break}case ScriptVarType.OBJ:case ScriptVarType.NAMEDOBJ:{const t=n.shift();s[e]=ObjType.getId(t??"");break}case ScriptVarType.NPC:{const t=n.shift();s[e]=NpcType.getId(t??"");break}case ScriptVarType.LOC:{const t=n.shift();s[e]=LocType.getId(t??"");break}case ScriptVarType.SEQ:{const t=n.shift();s[e]=SeqType.getId(t??"");break}case ScriptVarType.STAT:{const t=n.shift();s[e]=Player2.SKILLS.indexOf(t??"");break}case ScriptVarType.INV:{const t=n.shift();s[e]=InvType.getId(t??"");break}case ScriptVarType.COORD:{const t=i.split("_"),n=parseInt(t[0].slice(6)),r=parseInt(t[1]),a=parseInt(t[2]),o=parseInt(t[3]),c=parseInt(t[4]);s[e]=Position.packCoord(n,(r<<6)+o,(a<<6)+c);break}case ScriptVarType.INTERFACE:{const t=n.shift();s[e]=Component.getId(t??"");break}case ScriptVarType.SPOTANIM:{const t=n.shift();s[e]=SpotanimType.getId(t??"");break}case ScriptVarType.IDKIT:{const t=n.shift();s[e]=IdkType.getId(t??"");break}}}catch(e){return!1}}return t.executeScript(ScriptRunner2.init(a,t,null,s),!1),!0}}class CloseModalHandler extends MessageHandler{handle(e,t){return t.closeModal(),!0}}class IdleTimerHandler extends MessageHandler{handle(e,t){return Environment_default.LOCAL_DEV||(t.logout(),t.logoutRequested=!0),!0}}class IfButtonHandler extends MessageHandler{handle(e,t){const{component:i}=e,n=Component.get(i);if(void 0===n||!t.isComponentVisible(n))return!1;if(t.lastCom=i,-1!==t.resumeButtons.indexOf(t.lastCom))t.activeScript&&t.executeScript(t.activeScript,!0);else{const e=Component.get(n.rootLayer),r=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.IF_BUTTON,i,-1);r?t.executeScript(ScriptRunner2.init(r,t),0==e.overlay):Environment_default.LOCAL_DEV&&t.messageGame(`No trigger for [if_button,${n.comName}]`)}return!0}}class IfPlayerDesignHandler extends MessageHandler{handle(e,t){const{gender:i,idkit:n,color:r}=e;if(!t.allowDesign)return!1;if(i>1)return!1;let a=!0;for(let e=0;e<7;e++){let t=e;if(1===i&&(t+=7),8==t&&-1===n[e])continue;const r=IdkType.get(n[e]);if(!r||r.disable||r.type!=t){a=!1;break}}if(!a)return!1;for(let e=0;e<5;e++)if(r[e]>=Player2.DESIGN_BODY_COLORS[e].length){a=!1;break}return!!a&&(t.gender=i,t.body=n,t.colors=r,t.generateAppearance(InvType.WORN),!0)}}class InvButtonDHandler extends MessageHandler{handle(e,t){const{component:i,slot:n,targetSlot:r}=e,a=Component.get(i);if(void 0===a||!t.isComponentVisible(a))return!1;const s=t.invListeners.find((e=>e.com===i));if(!s)return!1;const o=t.getInventoryFromListener(s);if(!(o&&o.validSlot(n)&&o.get(n)&&o.validSlot(r)))return!1;if(t.delayed())return t.write(new UpdateInvPartial(i,o,n,r)),!1;t.lastSlot=n,t.lastTargetSlot=r;const c=ScriptProvider.getByTrigger(ServerTriggerType_default.INV_BUTTOND,i);if(c){const e=Component.get(a.rootLayer);t.executeScript(ScriptRunner2.init(c,t),0==e.overlay)}else Environment_default.LOCAL_DEV&&t.messageGame(`No trigger for [inv_buttond,${a.comName}]`);return!0}}class MessagePrivateHandler extends MessageHandler{handle(e,t){return!0}}class MessagePublicHandler extends MessageHandler{handle(e,t){const{color:i,effect:n,input:r}=e;if(i<0||i>11||n<0||n>2||r.length>100)return!1;t.messageColor=i,t.messageEffect=n,t.messageType=0;const a=Packet.alloc(0);return WordPack.pack(a,WordEnc2.filter(r)),t.message=new Uint8Array(a.pos),a.pos=0,a.gdata(t.message,0,t.message.length),a.release(),t.mask|=Player2.CHAT,!0}}class OpHeldHandler extends MessageHandler{handle(e,t){const{obj:i,slot:n,component:r}=e,a=Component.get(r);if(void 0===a||!t.isComponentVisible(a))return!1;const s=ObjType.get(i);if(5!==e.op&&(s.iop&&!s.iop[e.op-1]||!s.iop))return!1;const o=t.invListeners.find((e=>e.com===r));if(!o)return!1;const c=t.getInventoryFromListener(o);if(!c||!c.validSlot(n)||!c.hasAt(n,i))return!1;if(t.delayed())return!1;let l;t.lastItem=i,t.lastSlot=n,t.clearInteraction(),t.closeModal(),l=1===e.op?ServerTriggerType_default.OPHELD1:2===e.op?ServerTriggerType_default.OPHELD2:3===e.op?ServerTriggerType_default.OPHELD3:4===e.op?ServerTriggerType_default.OPHELD4:ServerTriggerType_default.OPHELD5;const d=ScriptProvider.getByTrigger(l,s.id,s.category);return d?t.executeScript(ScriptRunner2.init(d,t),!0):Environment_default.LOCAL_DEV&&t.messageGame(`No trigger for [${ServerTriggerType_default.toString(l)},${s.debugname}]`),!0}}class OpHeldTHandler extends MessageHandler{handle(e,t){const{obj:i,slot:n,component:r,spellComponent:a}=e,s=Component.get(r);if(void 0===s||!t.isComponentVisible(s))return t.unsetMapFlag(),!1;const o=Component.get(r);if(void 0===o||!t.isComponentVisible(o))return t.unsetMapFlag(),!1;const c=t.invListeners.find((e=>e.com===r));if(!c)return t.unsetMapFlag(),!1;const l=t.getInventoryFromListener(c);if(!l||!l.validSlot(n)||!l.hasAt(n,i))return t.unsetMapFlag(),!1;if(t.delayed())return t.unsetMapFlag(),!1;t.lastItem=i,t.lastSlot=n,t.clearInteraction(),t.closeModal();const d=ScriptProvider.getByTrigger(ServerTriggerType_default.OPHELDT,a,-1);return d?t.executeScript(ScriptRunner2.init(d,t),!0):(Environment_default.LOCAL_DEV&&t.messageGame(`No trigger for [opheldt,${o.comName}]`),t.messageGame("Nothing interesting happens.")),!0}}class OpHeldUHandler extends MessageHandler{handle(e,t){const{obj:i,slot:n,component:r,useObj:a,useSlot:s,useComponent:o}=e,c=Component.get(r);if(void 0===c||!t.isComponentVisible(c))return t.unsetMapFlag(),!1;const l=Component.get(r);if(void 0===l||!t.isComponentVisible(l))return t.unsetMapFlag(),!1;{const e=t.invListeners.find((e=>e.com===r));if(!e)return t.unsetMapFlag(),!1;const a=t.getInventoryFromListener(e);if(!a||!a.validSlot(n)||!a.hasAt(n,i))return t.unsetMapFlag(),!1}{const e=t.invListeners.find((e=>e.com===o));if(!e)return t.unsetMapFlag(),!1;const i=t.getInventoryFromListener(e);if(!i||!i.validSlot(s)||!i.hasAt(s,a))return t.unsetMapFlag(),!1}if(t.delayed())return t.unsetMapFlag(),!1;t.lastItem=i,t.lastSlot=n,t.lastUseItem=a,t.lastUseSlot=s;const d=ObjType.get(t.lastItem),p=ObjType.get(t.lastUseItem);if((d.members||p.members)&&!World_default.members)return t.messageGame("To use this item please login to a members' server."),t.unsetMapFlag(),!1;let h=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.OPHELDU,d.id,-1);h||(h=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.OPHELDU,p.id,-1),[t.lastItem,t.lastUseItem]=[t.lastUseItem,t.lastItem],[t.lastSlot,t.lastUseSlot]=[t.lastUseSlot,t.lastSlot]);const u=-1!==d.category?CategoryType.get(d.category):null;!h&&u&&(h=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.OPHELDU,-1,u.id));const _=-1!==p.category?CategoryType.get(p.category):null;return!h&&_&&(h=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.OPHELDU,-1,_.id),[t.lastItem,t.lastUseItem]=[t.lastUseItem,t.lastItem],[t.lastSlot,t.lastUseSlot]=[t.lastUseSlot,t.lastSlot]),t.clearInteraction(),t.closeModal(),h?t.executeScript(ScriptRunner2.init(h,t),!0):(Environment_default.LOCAL_DEV&&t.messageGame(`No trigger for [opheldu,${d.debugname}]`),t.messageGame("Nothing interesting happens.")),!0}}class OpLocHandler extends MessageHandler{handle(e,t){const{x:i,z:n,loc:r}=e;if(t.delayed())return t.unsetMapFlag(),!1;const a=t.originX-52,s=t.originX+52,o=t.originZ+52,c=t.originZ-52;if(i<a||i>s||n<c||n>o)return!1;const l=World_default.getLoc(i,n,t.level,r);if(!l)return t.unsetMapFlag(),!1;const d=LocType.get(l.type);if(!d.op||!d.op[e.op-1])return t.unsetMapFlag(),!1;let p;return p=1===e.op?ServerTriggerType_default.APLOC1:2===e.op?ServerTriggerType_default.APLOC2:3===e.op?ServerTriggerType_default.APLOC3:4===e.op?ServerTriggerType_default.APLOC4:ServerTriggerType_default.APLOC5,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,l,p),t.opcalled=!0,!0}}class OpLocTHandler extends MessageHandler{handle(e,t){const{x:i,z:n,loc:r,spellComponent:a}=e;if(t.delayed())return t.unsetMapFlag(),!1;const s=Component.get(a);if(void 0===s||!t.isComponentVisible(s))return t.unsetMapFlag(),!1;const o=t.originX-52,c=t.originX+52,l=t.originZ+52,d=t.originZ-52;if(i<o||i>c||n<d||n>l)return t.unsetMapFlag(),!1;const p=World_default.getLoc(i,n,t.level,r);return p?(t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,p,ServerTriggerType_default.APLOCT,{type:p.type,com:a}),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpLocUHandler extends MessageHandler{handle(e,t){const{x:i,z:n,loc:r,useObj:a,useSlot:s,useComponent:o}=e;if(t.delayed())return t.unsetMapFlag(),!1;const c=Component.get(o);if(void 0===c||!t.isComponentVisible(c))return t.unsetMapFlag(),!1;const l=t.originX-52,d=t.originX+52,p=t.originZ+52,h=t.originZ-52;if(i<l||i>d||n<h||n>p)return t.unsetMapFlag(),!1;const u=t.invListeners.find((e=>e.com===o));if(!u)return t.unsetMapFlag(),!1;const _=t.getInventoryFromListener(u);if(!_||!_.validSlot(s)||!_.hasAt(s,a))return t.unsetMapFlag(),!1;const g=World_default.getLoc(i,n,t.level,r);return g?ObjType.get(a).members&&!World_default.members?(t.messageGame("To use this item please login to a members' server."),t.unsetMapFlag(),!1):(t.lastUseItem=a,t.lastUseSlot=s,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,g,ServerTriggerType_default.APLOCU),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpNpcHandler extends MessageHandler{handle(e,t){const{nid:i}=e;if(t.delayed())return t.unsetMapFlag(),!1;const n=World_default.getNpc(i);if(!n||n.delayed())return t.unsetMapFlag(),!1;if(!t.buildArea.npcs.has(n.nid))return t.unsetMapFlag(),!1;const r=NpcType.get(n.type);if(!r.op||!r.op[e.op-1])return t.unsetMapFlag(),!1;let a;return a=1===e.op?ServerTriggerType_default.APNPC1:2===e.op?ServerTriggerType_default.APNPC2:3===e.op?ServerTriggerType_default.APNPC3:4===e.op?ServerTriggerType_default.APNPC4:ServerTriggerType_default.APNPC5,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,n,a,{type:n.type,com:-1}),t.opcalled=!0,!0}}class OpNpcTHandler extends MessageHandler{handle(e,t){const{nid:i,spellComponent:n}=e;if(t.delayed())return t.unsetMapFlag(),!1;const r=Component.get(n);if(void 0===r||!t.isComponentVisible(r))return t.unsetMapFlag(),!1;const a=World_default.getNpc(i);return!a||a.delayed()?(t.unsetMapFlag(),!1):t.buildArea.npcs.has(a.nid)?(t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,a,ServerTriggerType_default.APNPCT,{type:a.type,com:n}),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpNpcUHandler extends MessageHandler{handle(e,t){const{nid:i,useObj:n,useSlot:r,useComponent:a}=e;if(t.delayed())return t.unsetMapFlag(),!1;const s=Component.get(a);if(void 0===s||!t.isComponentVisible(s))return t.unsetMapFlag(),!1;const o=t.invListeners.find((e=>e.com===a));if(!o)return t.unsetMapFlag(),!1;const c=t.getInventoryFromListener(o);if(!c||!c.validSlot(r)||!c.hasAt(r,n))return t.unsetMapFlag(),!1;const l=World_default.getNpc(i);return!l||l.delayed()?(t.unsetMapFlag(),!1):t.buildArea.npcs.has(l.nid)?ObjType.get(n).members&&!World_default.members?(t.messageGame("To use this item please login to a members' server."),t.unsetMapFlag(),!1):(t.lastUseItem=n,t.lastUseSlot=r,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,l,ServerTriggerType_default.APNPCU,{type:l.type,com:-1}),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpObjHandler extends MessageHandler{handle(e,t){const{x:i,z:n,obj:r}=e;if(t.delayed())return t.unsetMapFlag(),!1;const a=t.originX-52,s=t.originX+52,o=t.originZ+52,c=t.originZ-52;if(i<a||i>s||n<c||n>o)return t.unsetMapFlag(),!1;const l=World_default.getObj(i,n,t.level,r,t.pid);if(!l)return t.unsetMapFlag(),!1;const d=ObjType.get(l.type);if(1===e.op&&(d.op&&!d.op[0]||!d.op)||4===e.op&&(d.op&&!d.op[3]||!d.op))return t.unsetMapFlag(),!1;let p;return p=1===e.op?ServerTriggerType_default.APOBJ1:2===e.op?ServerTriggerType_default.APOBJ2:3===e.op?ServerTriggerType_default.APOBJ3:4===e.op?ServerTriggerType_default.APOBJ4:ServerTriggerType_default.APOBJ5,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,l,p),t.opcalled=!0,!0}}class OpObjTHandler extends MessageHandler{handle(e,t){const{x:i,z:n,obj:r,spellComponent:a}=e;if(t.delayed())return t.unsetMapFlag(),!1;const s=Component.get(a);if(void 0===s||!t.isComponentVisible(s))return t.unsetMapFlag(),!1;const o=t.originX-52,c=t.originX+52,l=t.originZ+52,d=t.originZ-52;if(i<o||i>c||n<d||n>l)return t.unsetMapFlag(),!1;const p=World_default.getObj(i,n,t.level,r,t.pid);return p?(t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,p,ServerTriggerType_default.APOBJT,{type:p.type,com:a}),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpObjUHandler extends MessageHandler{handle(e,t){const{x:i,z:n,obj:r,useObj:a,useSlot:s,useComponent:o}=e;if(t.delayed())return t.unsetMapFlag(),!1;const c=Component.get(o);if(void 0===c||!t.isComponentVisible(c))return t.unsetMapFlag(),!1;const l=t.originX-52,d=t.originX+52,p=t.originZ+52,h=t.originZ-52;if(i<l||i>d||n<h||n>p)return t.unsetMapFlag(),!1;const u=t.invListeners.find((e=>e.com===o));if(!u)return t.unsetMapFlag(),!1;const _=t.getInventoryFromListener(u);if(!_||!_.validSlot(s)||!_.hasAt(s,a))return t.unsetMapFlag(),!1;const g=World_default.getObj(i,n,t.level,r,t.pid);return g?ObjType.get(a).members&&!World_default.members?(t.messageGame("To use this item please login to a members' server."),t.unsetMapFlag(),!1):(t.lastUseItem=a,t.lastUseSlot=s,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,g,ServerTriggerType_default.APOBJU),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpPlayerHandler extends MessageHandler{handle(e,t){const{pid:i}=e;if(t.delayed())return t.unsetMapFlag(),!1;const n=World_default.getPlayer(i);if(!n)return t.unsetMapFlag(),!1;if(!t.buildArea.players.has(n.uid))return t.unsetMapFlag(),!1;let r;return r=1===e.op?ServerTriggerType_default.APPLAYER1:2===e.op?ServerTriggerType_default.APPLAYER2:3===e.op?ServerTriggerType_default.APPLAYER3:ServerTriggerType_default.APPLAYER4,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,n,r),t.opcalled=!0,!0}}class OpPlayerTHandler extends MessageHandler{handle(e,t){const{pid:i,spellComponent:n}=e;if(t.delayed())return t.unsetMapFlag(),!1;const r=Component.get(n);if(void 0===r||!t.isComponentVisible(r))return t.unsetMapFlag(),!1;const a=World_default.getPlayer(i);return a&&t.buildArea.players.has(a.uid)?(t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,a,ServerTriggerType_default.APPLAYERT,{type:-1,com:n}),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class OpPlayerUHandler extends MessageHandler{handle(e,t){const{pid:i,useObj:n,useSlot:r,useComponent:a}=e;if(t.delayed())return t.unsetMapFlag(),!1;const s=Component.get(a);if(void 0===s||!t.isComponentVisible(s))return t.unsetMapFlag(),!1;const o=t.invListeners.find((e=>e.com===a));if(!o)return t.unsetMapFlag(),!1;const c=t.getInventoryFromListener(o);if(!c||!c.validSlot(r)||!c.hasAt(r,n))return t.unsetMapFlag(),!1;const l=World_default.getPlayer(i);return l&&t.buildArea.players.has(l.uid)?ObjType.get(n).members&&!World_default.members?(t.messageGame("To use this item please login to a members' server."),t.unsetMapFlag(),!1):(t.lastUseSlot=r,t.clearPendingAction(),t.setInteraction(Interaction_default.ENGINE,l,ServerTriggerType_default.APPLAYERU,{type:n,com:-1}),t.opcalled=!0,!0):(t.unsetMapFlag(),!1)}}class RebuildGetMapsHandler extends MessageHandler{handle(e,t){const{maps:i}=e;for(let e=0;e<i.length;e++){const{type:n,x:r,z:a}=i[e],s=991;if(0==n){const e=PRELOADED.get(`m${r}_${a}`);if(!e)continue;for(let i=0;i<e.length;i+=s)t.write(new DataLand(r,a,i,e.length,e.subarray(i,i+s)));t.write(new DataLandDone(r,a))}else if(1==n){const e=PRELOADED.get(`l${r}_${a}`);if(!e)continue;for(let i=0;i<e.length;i+=s)t.write(new DataLoc(r,a,i,e.length,e.subarray(i,i+s)));t.write(new DataLocDone(r,a))}}return!0}}class ResumePauseButtonHandler extends MessageHandler{handle(e,t){return!(!t.activeScript||t.activeScript.execution!==ScriptState.PAUSEBUTTON)&&(t.executeScript(t.activeScript,!0),!0)}}class ResumePCountDialogHandler extends MessageHandler{handle(e,t){const{input:i}=e;return!(!t.activeScript||t.activeScript.execution!==ScriptState.COUNTDIALOG)&&(t.activeScript.lastInt=i,t.executeScript(t.activeScript,!0),!0)}}class TutorialClickSideHandler extends MessageHandler{handle(e,t){const{tab:i}=e;if(i<0||i>13)return!1;const n=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.TUTORIAL_CLICKSIDE,-1,-1);return n&&t.executeScript(ScriptRunner2.init(n,t),!0),!0}}class MoveClick extends IncomingMessage{path;ctrlHeld;opClick;category=ClientProtCategory.USER_EVENT;constructor(e,t,i){super(),this.path=e,this.ctrlHeld=t,this.opClick=i}}class MoveClickDecoder extends MessageDecoder{prot;constructor(e){super(),this.prot=e}decode(e){const t=e.g1(),i=e.g2(),n=e.g2(),r=this.prot===ClientProt.MOVE_MINIMAPCLICK?14:0,a=e.available-r>>1,s=[{x:i,z:n}];for(let t=1;t<=a&&t<25;t++)s.push({x:i+e.g1b(),z:n+e.g1b()});return new MoveClick(s,t,this.prot===ClientProt.MOVE_OPCLICK)}}class MoveClickHandler extends MessageHandler{handle(e,t){const i=e.path[0];if(t.delayed()||e.ctrlHeld<0||e.ctrlHeld>1||Position.distanceToSW(t,{x:i.x,z:i.z})>104)return t.unsetMapFlag(),t.userPath=[],!1;if(Environment_default.CLIENT_PATHFINDER){t.userPath=[];for(let i=0;i<e.path.length;i++)t.userPath[i]=Position.packCoord(t.level,e.path[i].x,e.path[i].z)}else{const i=e.path[e.path.length-1];t.userPath=[Position.packCoord(t.level,i.x,i.z)]}return t.interactWalkTrigger=!1,e.opClick||(t.clearInteraction(),t.closeModal()),t.runenergy<100?t.setVar(VarPlayerType.TEMP_RUN,0):t.setVar(VarPlayerType.TEMP_RUN,e.ctrlHeld),!0}}class ClientProtRepository{decoders=new Map;handlers=new Map;bind(e,t){if(this.decoders.has(e.prot.id))throw new Error(`[ClientProtRepository] Already defines a ${e.prot.id}.`);this.decoders.set(e.prot.id,e),t&&this.handlers.set(e.prot.id,t)}constructor(){this.bind(new ClientCheatDecoder,new ClientCheatHandler),this.bind(new CloseModalDecoder,new CloseModalHandler),this.bind(new IdleTimerDecoder,new IdleTimerHandler),this.bind(new IfButtonDecoder,new IfButtonHandler),this.bind(new IfPlayerDesignDecoder,new IfPlayerDesignHandler),this.bind(new InvButtonDecoder(ClientProt.INV_BUTTON1,1),new InvButtonHandler),this.bind(new InvButtonDecoder(ClientProt.INV_BUTTON2,2),new InvButtonHandler),this.bind(new InvButtonDecoder(ClientProt.INV_BUTTON3,3),new InvButtonHandler),this.bind(new InvButtonDecoder(ClientProt.INV_BUTTON4,4),new InvButtonHandler),this.bind(new InvButtonDecoder(ClientProt.INV_BUTTON5,5),new InvButtonHandler),this.bind(new InvButtonDDecoder,new InvButtonDHandler),this.bind(new MessagePrivateDecoder,new MessagePrivateHandler),this.bind(new MessagePublicDecoder,new MessagePublicHandler),this.bind(new MoveClickDecoder(ClientProt.MOVE_GAMECLICK),new MoveClickHandler),this.bind(new MoveClickDecoder(ClientProt.MOVE_OPCLICK),new MoveClickHandler),this.bind(new MoveClickDecoder(ClientProt.MOVE_MINIMAPCLICK),new MoveClickHandler),this.bind(new OpHeldDecoder(ClientProt.OPHELD1,1),new OpHeldHandler),this.bind(new OpHeldDecoder(ClientProt.OPHELD2,2),new OpHeldHandler),this.bind(new OpHeldDecoder(ClientProt.OPHELD3,3),new OpHeldHandler),this.bind(new OpHeldDecoder(ClientProt.OPHELD4,4),new OpHeldHandler),this.bind(new OpHeldDecoder(ClientProt.OPHELD5,5),new OpHeldHandler),this.bind(new OpHeldTDecoder,new OpHeldTHandler),this.bind(new OpHeldUDecoder,new OpHeldUHandler),this.bind(new OpLocDecoder(ClientProt.OPLOC1,1),new OpLocHandler),this.bind(new OpLocDecoder(ClientProt.OPLOC2,2),new OpLocHandler),this.bind(new OpLocDecoder(ClientProt.OPLOC3,3),new OpLocHandler),this.bind(new OpLocDecoder(ClientProt.OPLOC4,4),new OpLocHandler),this.bind(new OpLocDecoder(ClientProt.OPLOC5,5),new OpLocHandler),this.bind(new OpLocTDecoder,new OpLocTHandler),this.bind(new OpLocUDecoder,new OpLocUHandler),this.bind(new OpNpcDecoder(ClientProt.OPNPC1,1),new OpNpcHandler),this.bind(new OpNpcDecoder(ClientProt.OPNPC2,2),new OpNpcHandler),this.bind(new OpNpcDecoder(ClientProt.OPNPC3,3),new OpNpcHandler),this.bind(new OpNpcDecoder(ClientProt.OPNPC4,4),new OpNpcHandler),this.bind(new OpNpcDecoder(ClientProt.OPNPC5,5),new OpNpcHandler),this.bind(new OpNpcTDecoder,new OpNpcTHandler),this.bind(new OpNpcUDecoder,new OpNpcUHandler),this.bind(new OpObjDecoder(ClientProt.OPOBJ1,1),new OpObjHandler),this.bind(new OpObjDecoder(ClientProt.OPOBJ2,2),new OpObjHandler),this.bind(new OpObjDecoder(ClientProt.OPOBJ3,3),new OpObjHandler),this.bind(new OpObjDecoder(ClientProt.OPOBJ4,4),new OpObjHandler),this.bind(new OpObjDecoder(ClientProt.OPOBJ5,5),new OpObjHandler),this.bind(new OpObjTDecoder,new OpObjTHandler),this.bind(new OpObjUDecoder,new OpObjUHandler),this.bind(new OpPlayerDecoder(ClientProt.OPPLAYER1,1),new OpPlayerHandler),this.bind(new OpPlayerDecoder(ClientProt.OPPLAYER2,2),new OpPlayerHandler),this.bind(new OpPlayerDecoder(ClientProt.OPPLAYER3,3),new OpPlayerHandler),this.bind(new OpPlayerDecoder(ClientProt.OPPLAYER4,4),new OpPlayerHandler),this.bind(new OpPlayerTDecoder,new OpPlayerTHandler),this.bind(new OpPlayerUDecoder,new OpPlayerUHandler),this.bind(new RebuildGetMapsDecoder,new RebuildGetMapsHandler),this.bind(new ResumePauseButtonDecoder,new ResumePauseButtonHandler),this.bind(new ResumePCountDialogDecoder,new ResumePCountDialogHandler),this.bind(new TutorialClickSideDecoder,new TutorialClickSideHandler)}getDecoder(e){return this.decoders.get(e.id)}getHandler(e){return this.handlers.get(e.id)}}var ClientProtRepository_default=new ClientProtRepository;function isNetworkPlayer(e){return null!==e.client&&void 0!==e.client}class NetworkPlayer2 extends Player2{client=null;userPath=[];opcalled=!1;constructor(e,t,i){super(e,t),this.client=i,this.client.player=this}decodeIn(){if(null===this.client||this.client.inOffset<1)return;let e=0;for(this.lastResponse=World_default.currentTick,this.userPath=[],this.opcalled=!1,World_default.lastCycleBandwidth[0]+=this.client.inOffset;this.client.inOffset>e;){const t=ClientProt.byId[this.client.in[e++]];let i=t.length;-1==i?i=this.client.in[e++]:-2==i&&(i=this.client.in[e++]<<8|this.client.in[e++]);const n=new Packet(this.client.in.slice(e,e+i));e+=i;const r=ClientProtRepository_default.getDecoder(t);if(r){const e=r.decode(n),i=ClientProtRepository_default.getHandler(t);i&&i.handle(e,this)}}this.client?.reset()}encodeOut(){if(this.client){(this.modalTop!==this.lastModalTop||this.modalBottom!==this.lastModalBottom||this.modalSidebar!==this.lastModalSidebar||this.refreshModalClose)&&(this.refreshModalClose&&this.write(new IfClose),this.refreshModalClose=!1,this.lastModalTop=this.modalTop,this.lastModalBottom=this.modalBottom,this.lastModalSidebar=this.modalSidebar),this.refreshModal&&(1&~this.modalState||4&~this.modalState?1&~this.modalState?2&~this.modalState?4&~this.modalState||this.write(new IfOpenSideModal(this.modalSidebar)):this.write(new IfOpenChatModal(this.modalBottom)):this.write(new IfOpenMainModal(this.modalTop)):this.write(new IfOpenMainSideModal(this.modalTop,this.modalSidebar)),this.refreshModal=!1);for(let e=this.highPriorityOut.head();e;e=this.highPriorityOut.next())this.writeInner(e),e.uncache();for(let e=this.lowPriorityOut.head();e;e=this.lowPriorityOut.next())this.writeInner(e),e.uncache();this.client.flush()}}writeInner(e){const t=this.client;if(!t)return;const i=ServerProtRepository_default.getEncoder(e);if(!i)return;const n=i.prot,r=t.out,a=(1+n.length===-1?1:-2===n.length?2:0)+i.test(e);r.pos+a>=r.length&&t.flush();const s=r.pos;r.p1(n.id),-1===n.length?r.pos+=1:-2===n.length&&(r.pos+=2);const o=r.pos;i.encode(r,e),-1===n.length?r.psize1(r.pos-o):-2===n.length&&r.psize2(r.pos-o),t.encryptor&&(r.data[s]=r.data[s]+t.encryptor.nextInt()&255),World_default.lastCycleBandwidth[1]+=r.pos-s}logout(){this.writeInner(new Logout),this.client?.flush()}terminate(){this.client?.terminate(),this.client=null}playerLog(e,...t){}updateMap(){const e=this.buildArea.loadedZones,t=this.buildArea.activeZones,i=Position.zone(this.originX)-4<<3,n=Position.zone(this.originX)+5<<3,r=Position.zone(this.originZ)+5<<3,a=Position.zone(this.originZ)-4<<3;(this.x<i||this.z<a||this.x>n-1||this.z>r-1||this.tele&&(Position.zone(this.x)!==Position.zone(this.originX)||Position.zone(this.z)!==Position.zone(this.originZ)))&&(this.write(new RebuildNormal(Position.zone(this.x),Position.zone(this.z))),this.originX=this.x,this.originZ=this.z,e.clear());for(let e=this.cameraPackets.head();null!==e;e=this.cameraPackets.next()){const t=e.camX-Position.zoneOrigin(this.originX),i=e.camZ-Position.zoneOrigin(this.originZ);e.type===ServerProt.CAM_MOVETO?this.write(new CamMoveTo(t,i,e.height,e.rotationSpeed,e.rotationMultiplier)):e.type===ServerProt.CAM_LOOKAT&&this.write(new CamLookAt(t,i,e.height,e.rotationSpeed,e.rotationMultiplier)),e.unlink()}this.moveSpeed===MoveSpeed_default.INSTANT&&this.jump&&e.clear(),t.clear();const s=Position.zone(this.x),o=Position.zone(this.z),c=Position.zone(this.originX)-6,l=Position.zone(this.originX)+6,d=Position.zone(this.originZ)+6,p=Position.zone(this.originZ)-6;for(let e=s-3;e<=s+3;e++)for(let i=o-3;i<=o+3;i++)e<c||e>l||i>d||i<p||t.add(ZoneMap2.zoneIndex(e<<3,i<<3,this.level))}updatePlayers(){this.write(new PlayerInfo(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ,this.uid,this.mask,this.tele,this.jump,this.walkDir,this.runDir))}updateNpcs(){this.write(new NpcInfo(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ))}updateZones(){const e=this.buildArea.loadedZones,t=this.buildArea.activeZones;for(const i of e)t.has(i)||e.delete(i);for(const i of t){const t=World_default.getZoneIndex(i);e.has(t.index)?(t.writePartialEncloses(this),t.writePartialFollows(this)):t.writeFullFollows(this),e.add(t.index)}}updateStats(){for(let e=0;e<this.stats.length;e++)this.stats[e]===this.lastStats[e]&&this.levels[e]===this.lastLevels[e]||(this.write(new UpdateStat(e,this.stats[e],this.levels[e])),this.lastStats[e]=this.stats[e],this.lastLevels[e]=this.levels[e]);Math.floor(this.runenergy)/100!=Math.floor(this.lastRunEnergy)/100&&(this.write(new UpdateRunEnergy(this.runenergy)),this.lastRunEnergy=this.runenergy)}updateInvs(){let e=!1,t=!1;for(let i=0;i<this.invListeners.length;i++){const n=this.invListeners[i];if(n)if(-1===n.source){const e=World_default.getInventory(n.type);if(!e)continue;(e.update||n.firstSeen)&&(this.write(new UpdateInvFull(n.com,e)),n.firstSeen=!1)}else{const i=World_default.getPlayerByUid(n.source);if(!i)continue;const r=i.getInventory(n.type);if(!r)continue;if(r.update||n.firstSeen){this.write(new UpdateInvFull(n.com,r)),n.firstSeen&&(t=!0),n.firstSeen=!1;InvType.get(n.type).runweight&&(e=!0)}}}if(e){const t=this.runweight;this.calculateRunWeight(),e=t!==this.runweight}(e||t)&&this.write(new UpdateRunWeight(Math.ceil(this.runweight/1e3)))}}class CameraInfo extends Linkable{type;camX;camZ;height;rotationSpeed;rotationMultiplier;constructor(e,t,i,n,r,a){super(),this.type=e,this.camX=t,this.camZ=i,this.height=n,this.rotationSpeed=r,this.rotationMultiplier=a}}class ColorConversion{static hsl24to16(e,t,i){return i>243?t>>=4:i>217?t>>=3:i>192?t>>=2:i>179&&(t>>=1),((255&e)>>2<<10)+(t>>5<<7)+(i>>1)}static rgb15to24(e){return((e>>10&31)<<3<<16)+((e>>5&31)<<3<<8)+((31&e)<<3)}static rgb15toHsl16(e){const t=(e>>10&31)/31,i=(e>>5&31)/31,n=(31&e)/31;return ColorConversion.rgbToHsl(t,i,n)}static rgb24to15(e){return((e>>16&255)>>3<<10)+((e>>8&255)>>3<<5)+((255&e)>>3)}static rgb24toHsl16(e){const t=(e>>16&255)/256,i=(e>>8&255)/256,n=(255&e)/256;return ColorConversion.rgbToHsl(t,i,n)}static rgbToHsl(e,t,i){let n=e;t<n&&(n=t),i<n&&(n=i);let r=e;t>r&&(r=t),i>r&&(r=i);let a=0,s=0;const o=(n+r)/2;n!==r&&(o<.5?s=(r-n)/(r+n):o>=.5&&(s=(r-n)/(2-r-n)),e===r?a=(t-i)/(r-n):t===r?a=(i-e)/(r-n)+2:i===r&&(a=(e-t)/(r-n)+4)),a/=6;const c=256*a|0;let l=256*s|0,d=256*o|0;return l<0?l=0:l>255&&(l=255),d<0?d=0:d>255&&(d=255),ColorConversion.hsl24to16(c,l,d)}static RGB15_HSL16=new Int32Array(32768);static{for(let e=0;e<32768;e++)ColorConversion.RGB15_HSL16[e]=ColorConversion.rgb15toHsl16(e)}static reverseHsl(e){const t=[];for(let i=0;i<32768;i++)ColorConversion.RGB15_HSL16[i]===e&&t.push(i);return t}}var popScriptArgs=function(e){const t=e.popString(),i=[];for(let n=t.length-1;n>=0;n--){const r=t.charAt(n);i[n]="s"===r?e.popString():e.popInt()}return i},PlayerOps={[ScriptOpcode_default.FINDUID]:e=>{const t=e.popInt(),i=World_default.getPlayerByUid(t);i?(e.activePlayer=i,e.pointerAdd(ActivePlayer[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.P_FINDUID]:e=>{const t=e.popInt()>>>0,i=World_default.getPlayerByUid(t);e.pointerGet(ProtectedActivePlayer[e.intOperand])&&e.activePlayer.uid===t?e.pushInt(1):i&&i.canAccess()?(e.activePlayer=i,e.pointerAdd(ActivePlayer[e.intOperand]),e.pointerAdd(ProtectedActivePlayer[e.intOperand]),e.pushInt(1)):e.pushInt(0)},[ScriptOpcode_default.STRONGQUEUE]:checkedHandler(ActivePlayer,(e=>{const t=popScriptArgs(e),i=check(e.popInt(),NumberNotNull),n=e.popInt(),r=ScriptProvider.get(n);if(!r)throw new Error(`Unable to find queue script: ${n}`);e.activePlayer.enqueueScript(r,3,i,t)})),[ScriptOpcode_default.WEAKQUEUE]:checkedHandler(ActivePlayer,(e=>{const t=popScriptArgs(e),i=check(e.popInt(),NumberNotNull),n=e.popInt(),r=ScriptProvider.get(n);if(!r)throw new Error(`Unable to find queue script: ${n}`);e.activePlayer.enqueueScript(r,2,i,t)})),[ScriptOpcode_default.QUEUE]:checkedHandler(ActivePlayer,(e=>{const t=popScriptArgs(e),i=check(e.popInt(),NumberNotNull),n=e.popInt(),r=ScriptProvider.get(n);if(!r)throw new Error(`Unable to find queue script: ${n}`);e.activePlayer.enqueueScript(r,0,i,t)})),[ScriptOpcode_default.ANIM]:checkedHandler(ActivePlayer,(e=>{const t=e.popInt(),i=e.popInt();e.activePlayer.playAnimation(i,t)})),[ScriptOpcode_default.BUFFER_FULL]:checkedHandler(ActivePlayer,(e=>{throw new Error("unimplemented")})),[ScriptOpcode_default.BUILDAPPEARANCE]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.generateAppearance(check(e.popInt(),InvTypeValid).id)})),[ScriptOpcode_default.CAM_LOOKAT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,CoordValid);e.activePlayer.cameraPackets.addTail(new CameraInfo(ServerProt.CAM_LOOKAT,a.x,a.z,i,n,r))})),[ScriptOpcode_default.CAM_MOVETO]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(t,CoordValid);e.activePlayer.cameraPackets.addTail(new CameraInfo(ServerProt.CAM_MOVETO,a.x,a.z,i,n,r))})),[ScriptOpcode_default.CAM_SHAKE]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4);e.activePlayer.write(new CamShake(t,i,n,r))})),[ScriptOpcode_default.CAM_RESET]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.write(new CamReset)})),[ScriptOpcode_default.COORD]:checkedHandler(ActivePlayer,(e=>{const t=e.activePlayer;e.pushInt(Position.packCoord(t.level,t.x,t.z))})),[ScriptOpcode_default.DISPLAYNAME]:checkedHandler(ActivePlayer,(e=>{e.pushString(e.activePlayer.displayName)})),[ScriptOpcode_default.FACESQUARE]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),CoordValid);e.activePlayer.faceSquare(t.x,t.z)})),[ScriptOpcode_default.IF_CLOSE]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.closeModal()})),[ScriptOpcode_default.LAST_COM]:e=>{e.pushInt(e.activePlayer.lastCom)},[ScriptOpcode_default.LAST_INT]:e=>{e.pushInt(e.lastInt)},[ScriptOpcode_default.LAST_ITEM]:e=>{if(![ServerTriggerType_default.OPHELD1,ServerTriggerType_default.OPHELD2,ServerTriggerType_default.OPHELD3,ServerTriggerType_default.OPHELD4,ServerTriggerType_default.OPHELD5,ServerTriggerType_default.OPHELDU,ServerTriggerType_default.OPHELDT,ServerTriggerType_default.INV_BUTTON1,ServerTriggerType_default.INV_BUTTON2,ServerTriggerType_default.INV_BUTTON3,ServerTriggerType_default.INV_BUTTON4,ServerTriggerType_default.INV_BUTTON5].includes(e.trigger))throw new Error("is not safe to use in this trigger");e.pushInt(e.activePlayer.lastItem)},[ScriptOpcode_default.LAST_SLOT]:e=>{if(![ServerTriggerType_default.OPHELD1,ServerTriggerType_default.OPHELD2,ServerTriggerType_default.OPHELD3,ServerTriggerType_default.OPHELD4,ServerTriggerType_default.OPHELD5,ServerTriggerType_default.OPHELDU,ServerTriggerType_default.OPHELDT,ServerTriggerType_default.INV_BUTTON1,ServerTriggerType_default.INV_BUTTON2,ServerTriggerType_default.INV_BUTTON3,ServerTriggerType_default.INV_BUTTON4,ServerTriggerType_default.INV_BUTTON5,ServerTriggerType_default.INV_BUTTOND].includes(e.trigger))throw new Error("is not safe to use in this trigger");e.pushInt(e.activePlayer.lastSlot)},[ScriptOpcode_default.LAST_USEITEM]:e=>{if(![ServerTriggerType_default.OPHELDU,ServerTriggerType_default.APOBJU,ServerTriggerType_default.APLOCU,ServerTriggerType_default.APNPCU,ServerTriggerType_default.APPLAYERU,ServerTriggerType_default.OPOBJU,ServerTriggerType_default.OPLOCU,ServerTriggerType_default.OPNPCU,ServerTriggerType_default.OPPLAYERU].includes(e.trigger))throw new Error("is not safe to use in this trigger");e.pushInt(e.activePlayer.lastUseItem)},[ScriptOpcode_default.LAST_USESLOT]:e=>{if(![ServerTriggerType_default.OPHELDU,ServerTriggerType_default.APOBJU,ServerTriggerType_default.APLOCU,ServerTriggerType_default.APNPCU,ServerTriggerType_default.APPLAYERU,ServerTriggerType_default.OPOBJU,ServerTriggerType_default.OPLOCU,ServerTriggerType_default.OPNPCU,ServerTriggerType_default.OPPLAYERU].includes(e.trigger))throw new Error("is not safe to use in this trigger");e.pushInt(e.activePlayer.lastUseSlot)},[ScriptOpcode_default.MES]:checkedHandler(ActivePlayer,(e=>{const t=e.popString();Environment_default.CLIRUNNER&&console.log(t),e.activePlayer.messageGame(t)})),[ScriptOpcode_default.NAME]:checkedHandler(ActivePlayer,(e=>{e.pushString(e.activePlayer.username)})),[ScriptOpcode_default.P_APRANGE]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.apRange=check(e.popInt(),NumberNotNull),e.activePlayer.apRangeCalled=!0})),[ScriptOpcode_default.P_ARRIVEDELAY]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.lastMovement<World_default.currentTick||(e.activePlayer.delay=1,e.execution=ScriptState.SUSPENDED)})),[ScriptOpcode_default.P_COUNTDIALOG]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.write(new PCountDialog),e.execution=ScriptState.COUNTDIALOG})),[ScriptOpcode_default.P_DELAY]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.delay=check(e.popInt(),NumberNotNull)+1,e.execution=ScriptState.SUSPENDED})),[ScriptOpcode_default.P_OPHELD]:checkedHandler(ProtectedActivePlayer,(e=>{throw new Error("unimplemented")})),[ScriptOpcode_default.P_OPLOC]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull)-1;if(t<0||t>=5)throw new Error(`Invalid oploc: ${t+1}`);e.activePlayer.stopAction(),e.activePlayer.setInteraction(Interaction_default.SCRIPT,e.activeLoc,ServerTriggerType_default.APLOC1+t)})),[ScriptOpcode_default.P_OPNPC]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull)-1;if(t<0||t>=5)throw new Error(`Invalid opnpc: ${t+1}`);e.activePlayer.stopAction(),e.activePlayer.setInteraction(Interaction_default.SCRIPT,e.activeNpc,ServerTriggerType_default.APNPC1+t,{type:e.activeNpc.type,com:-1})})),[ScriptOpcode_default.P_OPNPCT]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull);e.activePlayer.stopAction(),e.activePlayer.setInteraction(Interaction_default.SCRIPT,e.activeNpc,ServerTriggerType_default.APNPCT,{type:e.activeNpc.type,com:t})})),[ScriptOpcode_default.P_PAUSEBUTTON]:checkedHandler(ProtectedActivePlayer,(e=>{e.execution=ScriptState.PAUSEBUTTON})),[ScriptOpcode_default.P_STOPACTION]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.stopAction()})),[ScriptOpcode_default.P_CLEARPENDINGACTION]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.clearPendingAction()})),[ScriptOpcode_default.P_TELEJUMP]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),CoordValid);e.activePlayer.teleJump(t.x,t.z,t.level)})),[ScriptOpcode_default.P_TELEPORT]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),CoordValid);e.activePlayer.teleport(t.x,t.z,t.level)})),[ScriptOpcode_default.P_WALK]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),CoordValid),i=e.activePlayer;i.queueWaypoints(findPath(i.level,i.x,i.z,t.x,t.z,i.width,i.width,i.length,i.orientation)),i.updateMovement(!1)})),[ScriptOpcode_default.SAY]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.say(e.popString())})),[ScriptOpcode_default.SOUND_SYNTH]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);e.activePlayer.write(new SynthSound(t,i,n))})),[ScriptOpcode_default.STAFFMODLEVEL]:checkedHandler(ActivePlayer,(e=>{e.pushInt(e.activePlayer.staffModLevel)})),[ScriptOpcode_default.STAT]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),PlayerStatValid);e.pushInt(e.activePlayer.levels[t])})),[ScriptOpcode_default.STAT_BASE]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),PlayerStatValid);e.pushInt(e.activePlayer.baseLevels[t])})),[ScriptOpcode_default.STAT_ADD]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,PlayerStatValid),check(i,NumberNotNull),check(n,NumberNotNull);const r=e.activePlayer,a=r.levels[t],s=a+(i+a*n/100);r.levels[t]=Math.min(s,255),3===t&&r.levels[3]>=r.baseLevels[3]&&r.resetHeroPoints()})),[ScriptOpcode_default.STAT_SUB]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,PlayerStatValid),check(i,NumberNotNull),check(n,NumberNotNull);const r=e.activePlayer,a=r.levels[t],s=a-(i+a*n/100);r.levels[t]=Math.max(s,0)})),[ScriptOpcode_default.SPOTANIM_PL]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull),i=e.popInt(),n=check(e.popInt(),SpotAnimTypeValid);e.activePlayer.spotanim(n.id,i,t)})),[ScriptOpcode_default.STAT_HEAL]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,PlayerStatValid),check(i,NumberNotNull),check(n,NumberNotNull);const r=e.activePlayer,a=r.baseLevels[t],s=r.levels[t],o=s+(i+s*n/100);r.levels[t]=Math.max(Math.min(o,a),s),3===t&&r.levels[3]>=r.baseLevels[3]&&r.resetHeroPoints()})),[ScriptOpcode_default.UID]:checkedHandler(ActivePlayer,(e=>{e.pushInt(e.activePlayer.uid)})),[ScriptOpcode_default.P_LOGOUT]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.logoutRequested=!0})),[ScriptOpcode_default.IF_SETCOLOUR]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),check(i,NumberNotNull),e.activePlayer.write(new IfSetColour(t,ColorConversion.rgb24to15(i)))})),[ScriptOpcode_default.IF_OPENCHAT]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.openChat(check(e.popInt(),NumberNotNull))})),[ScriptOpcode_default.IF_OPENMAINMODALSIDEOVERLAY]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),check(i,NumberNotNull),e.activePlayer.openMainModalSideOverlay(t,i)})),[ScriptOpcode_default.IF_SETHIDE]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),check(i,NumberNotNull),e.activePlayer.write(new IfSetHide(t,1===i))})),[ScriptOpcode_default.IF_SETOBJECT]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,NumberNotNull),check(i,ObjTypeValid),check(n,NumberNotNull),e.activePlayer.write(new IfSetObject(t,i,n))})),[ScriptOpcode_default.IF_SETTABACTIVE]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.write(new IfShowSide(check(e.popInt(),NumberNotNull)))})),[ScriptOpcode_default.IF_SETMODEL]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),check(i,NumberNotNull),e.activePlayer.write(new IfSetModel(t,i))})),[ScriptOpcode_default.IF_SETRECOL]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,NumberNotNull),e.activePlayer.write(new IfSetRecol(t,i,n))})),[ScriptOpcode_default.IF_SETTABFLASH]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.write(new TutorialFlashSide(check(e.popInt(),NumberNotNull)))})),[ScriptOpcode_default.IF_SETANIM]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),-1!==i&&e.activePlayer.write(new IfSetAnim(t,i))})),[ScriptOpcode_default.IF_SETTAB]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(i,NumberNotNull),e.activePlayer.setTab(t,i)})),[ScriptOpcode_default.IF_OPENMAINMODAL]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.openMainModal(check(e.popInt(),NumberNotNull))})),[ScriptOpcode_default.IF_OPENCHATSTICKY]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.openChatSticky(check(e.popInt(),NumberNotNull))})),[ScriptOpcode_default.IF_OPENSIDEOVERLAY]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.openSideOverlay(check(e.popInt(),NumberNotNull))})),[ScriptOpcode_default.IF_SETPLAYERHEAD]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.write(new IfSetPlayerHead(check(e.popInt(),NumberNotNull)))})),[ScriptOpcode_default.IF_SETTEXT]:checkedHandler(ActivePlayer,(e=>{const t=e.popString(),i=check(e.popInt(),NumberNotNull);e.activePlayer.write(new IfSetText(i,t))})),[ScriptOpcode_default.IF_SETNPCHEAD]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),check(i,NpcTypeValid),e.activePlayer.write(new IfSetNpcHead(t,i))})),[ScriptOpcode_default.IF_SETPOSITION]:checkedHandler(ActivePlayer,(e=>{const[t,i,n]=e.popInts(3);check(t,NumberNotNull),e.activePlayer.write(new IfSetPosition(t,i,n))})),[ScriptOpcode_default.IF_MULTIZONE]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.write(new SetMultiway(1===check(e.popInt(),NumberNotNull)))})),[ScriptOpcode_default.GIVEXP]:checkedHandler(ProtectedActivePlayer,(e=>{const[t,i]=e.popInts(2);check(t,NumberNotNull),check(i,NumberNotNull),e.activePlayer.addXp(t,i)})),[ScriptOpcode_default.DAMAGE]:e=>{const t=check(e.popInt(),NumberNotNull),i=check(e.popInt(),HitTypeValid),n=check(e.popInt(),NumberNotNull),r=World_default.getPlayerByUid(n);r&&r.applyDamage(t,i)},[ScriptOpcode_default.IF_SETRESUMEBUTTONS]:checkedHandler(ActivePlayer,(e=>{const[t,i,n,r,a]=e.popInts(5);e.activePlayer.resumeButtons=[t,i,n,r,a]})),[ScriptOpcode_default.TEXT_GENDER]:checkedHandler(ActivePlayer,(e=>{const[t,i]=e.popStrings(2);0==e.activePlayer.gender?e.pushString(t):e.pushString(i)})),[ScriptOpcode_default.MIDI_SONG]:e=>{e.activePlayer.playSong(check(e.popString(),StringNotNull))},[ScriptOpcode_default.MIDI_JINGLE]:e=>{const t=check(e.popInt(),NumberNotNull),i=check(e.popString(),StringNotNull);e.activePlayer.playJingle(t,i)},[ScriptOpcode_default.SOFTTIMER]:checkedHandler(ActivePlayer,(e=>{const t=popScriptArgs(e),i=e.popInt(),n=e.popInt(),r=ScriptProvider.get(n);if(!r)throw new Error(`Unable to find timer script: ${n}`);e.activePlayer.setTimer(1,r,t,i)})),[ScriptOpcode_default.CLEARSOFTTIMER]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.clearTimer(e.popInt())})),[ScriptOpcode_default.SETTIMER]:checkedHandler(ActivePlayer,(e=>{const t=popScriptArgs(e),i=e.popInt(),n=e.popInt(),r=ScriptProvider.get(n);if(!r)throw new Error(`Unable to find timer script: ${n}`);e.activePlayer.setTimer(0,r,t,i)})),[ScriptOpcode_default.CLEARTIMER]:checkedHandler(ActivePlayer,(e=>{e.activePlayer.clearTimer(e.popInt())})),[ScriptOpcode_default.HINT_COORD]:e=>{const[t,i,n]=e.popInts(3),r=check(i,CoordValid);e.activePlayer.hintTile(t,r.x,r.z,n)},[ScriptOpcode_default.HINT_STOP]:e=>{e.activePlayer.stopHint()},[ScriptOpcode_default.IF_CLOSESTICKY]:e=>{e.activePlayer.closeSticky()},[ScriptOpcode_default.P_EXACTMOVE]:checkedHandler(ProtectedActivePlayer,(e=>{const[t,i,n,r,a]=e.popInts(5),s=check(t,CoordValid),o=check(i,CoordValid);e.activePlayer.unsetMapFlag(),e.activePlayer.exactMove(s.x,s.z,o.x,o.z,n,r,a)})),[ScriptOpcode_default.BUSY]:e=>{e.pushInt(e.activePlayer.busy()?1:0)},[ScriptOpcode_default.BUSY2]:e=>{e.pushInt(e.activePlayer.hasInteraction()||e.activePlayer.hasWaypoints()?1:0)},[ScriptOpcode_default.GETQUEUE]:e=>{const t=e.popInt();let i=0;for(let n=e.activePlayer.queue.head();null!==n;n=e.activePlayer.queue.next())n.script.id===t&&i++;for(let n=e.activePlayer.weakQueue.head();null!==n;n=e.activePlayer.weakQueue.next())n.script.id===t&&i++;e.pushInt(i)},[ScriptOpcode_default.P_LOCMERGE]:checkedHandler(ProtectedActivePlayer,(e=>{const[t,i,n,r]=e.popInts(4),a=check(n,CoordValid),s=check(r,CoordValid);World_default.mergeLoc(e.activeLoc,e.activePlayer,t,i,a.z,a.x,s.z,s.x)})),[ScriptOpcode_default.LAST_LOGIN_INFO]:e=>{const t=e.activePlayer;if(!isNetworkPlayer(t)||null===t.client)return;const i=t.client.remoteAddress;if(null==i)return;const n=new Uint32Array(new Uint8Array(i.split(".").map((e=>parseInt(e)))).reverse().buffer)[0];t.lastLoginInfo(n,0,201,0)},[ScriptOpcode_default.BAS_READYANIM]:e=>{e.activePlayer.basReadyAnim=check(e.popInt(),SeqTypeValid).id},[ScriptOpcode_default.BAS_TURNONSPOT]:e=>{e.activePlayer.basTurnOnSpot=check(e.popInt(),SeqTypeValid).id},[ScriptOpcode_default.BAS_WALK_F]:e=>{e.activePlayer.basWalkForward=check(e.popInt(),SeqTypeValid).id},[ScriptOpcode_default.BAS_WALK_B]:e=>{e.activePlayer.basWalkBackward=check(e.popInt(),SeqTypeValid).id},[ScriptOpcode_default.BAS_WALK_L]:e=>{e.activePlayer.basWalkLeft=check(e.popInt(),SeqTypeValid).id},[ScriptOpcode_default.BAS_WALK_R]:e=>{e.activePlayer.basWalkRight=check(e.popInt(),SeqTypeValid).id},[ScriptOpcode_default.BAS_RUNNING]:e=>{const t=e.popInt();e.activePlayer.basRunning=-1!==t?check(t,SeqTypeValid).id:-1},[ScriptOpcode_default.GENDER]:e=>{e.pushInt(e.activePlayer.gender)},[ScriptOpcode_default.HINT_NPC]:e=>{e.activePlayer.hintNpc(check(e.popInt(),NumberNotNull))},[ScriptOpcode_default.HINT_PLAYER]:e=>{e.activePlayer.hintPlayer(check(e.popInt(),NumberNotNull))},[ScriptOpcode_default.HEADICONS_GET]:e=>{e.pushInt(e.activePlayer.headicons)},[ScriptOpcode_default.HEADICONS_SET]:e=>{e.activePlayer.headicons=check(e.popInt(),NumberNotNull)},[ScriptOpcode_default.P_OPOBJ]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull)-1;if(t<0||t>=5)throw new Error(`Invalid opobj: ${t+1}`);e.activePlayer.stopAction(),e.activePlayer.setInteraction(Interaction_default.SCRIPT,e.activeObj,ServerTriggerType_default.APOBJ1+t)})),[ScriptOpcode_default.P_OPPLAYER]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull)-1;if(t<0||t>=5)throw new Error(`Invalid opplayer: ${t+1}`);const i=e._activePlayer2;i&&(e.activePlayer.stopAction(),e.activePlayer.setInteraction(Interaction_default.SCRIPT,i,ServerTriggerType_default.APPLAYER1+t))})),[ScriptOpcode_default.ALLOWDESIGN]:e=>{e.activePlayer.allowDesign=1===check(e.popInt(),NumberNotNull)},[ScriptOpcode_default.LAST_TARGETSLOT]:e=>{if(![ServerTriggerType_default.INV_BUTTOND].includes(e.trigger))throw new Error("is not safe to use in this trigger");e.pushInt(e.activePlayer.lastTargetSlot)},[ScriptOpcode_default.WALKTRIGGER]:e=>{e.activePlayer.walktrigger=e.popInt()},[ScriptOpcode_default.GETWALKTRIGGER]:e=>{e.pushInt(e.activePlayer.walktrigger)},[ScriptOpcode_default.CLEARQUEUE]:e=>{const t=e.popInt();for(let i=e.activePlayer.queue.head();null!==i;i=e.activePlayer.queue.next())i.script.id===t&&i.unlink();for(let i=e.activePlayer.weakQueue.head();null!==i;i=e.activePlayer.weakQueue.next())i.script.id===t&&i.unlink()},[ScriptOpcode_default.HEALENERGY]:e=>{const t=check(e.popInt(),NumberNotNull),i=e.activePlayer;i.runenergy=Math.min(Math.max(i.runenergy+t,0),1e4)},[ScriptOpcode_default.AFK_EVENT]:e=>{e.pushInt(e.activePlayer.afkEventReady?1:0),e.activePlayer.afkEventReady=!1},[ScriptOpcode_default.LOWMEMORY]:e=>{e.pushInt(e.activePlayer.lowMemory?1:0)},[ScriptOpcode_default.SETIDKIT]:e=>{const[t,i]=e.popInts(2),n=check(t,IDKTypeValid);let r=n.type;1===e.activePlayer.gender&&(r-=7),e.activePlayer.body[r]=n.id;let a=n.type;1===e.activePlayer.gender&&(a-=7);let s=-1;0===a||1===a?s=0:2===a||3===a?s=1:4===a||(5===a?s=2:6===a&&(s=3)),-1!==s&&(e.activePlayer.colors[s]=i)},[ScriptOpcode_default.SETGENDER]:e=>{const t=check(e.popInt(),GenderValid);for(let i=0;i<7;i++){e.activePlayer.body[i]=-1;for(let n=0;n<IdkType.count;n++)if(!IdkType.get(n).disable&&IdkType.get(n).type==i+(0===t?0:7)){e.activePlayer.body[i]=n;break}}e.activePlayer.gender=t},[ScriptOpcode_default.SETSKINCOLOUR]:e=>{const t=check(e.popInt(),SkinColourValid);e.activePlayer.colors[4]=t},[ScriptOpcode_default.P_OPPLAYERT]:checkedHandler(ProtectedActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull),i=e._activePlayer2;i&&(e.activePlayer.stopAction(),e.activePlayer.setInteraction(Interaction_default.SCRIPT,i,ServerTriggerType_default.APPLAYERT,{type:-1,com:t}))})),[ScriptOpcode_default.FINDHERO]:checkedHandler(ActivePlayer,(e=>{const t=e.activePlayer.findHero();if(-1===t)return void e.pushInt(0);const i=World_default.getPlayerByUid(t);i?(e._activePlayer2=i,e.pointerAdd(ScriptPointer_default.ActivePlayer2),e.pushInt(1)):e.pushInt(0)})),[ScriptOpcode_default.BOTH_HEROPOINTS]:checkedHandler(ActivePlayer,(e=>{const t=check(e.popInt(),NumberNotNull),i=1===e.intOperand,n=i?e._activePlayer2:e._activePlayer,r=i?e._activePlayer:e._activePlayer2;if(!n||!r)throw new Error("player is null");r.addHero(n.uid,t)})),[ScriptOpcode_default.P_ANIMPROTECT]:checkedHandler(ProtectedActivePlayer,(e=>{e.activePlayer.animProtect=check(e.popInt(),NumberNotNull)}))},PlayerOps_default=PlayerOps,ServerOps={[ScriptOpcode_default.MAP_CLOCK]:e=>{e.pushInt(World_default.currentTick)},[ScriptOpcode_default.MAP_MEMBERS]:e=>{e.pushInt(World_default.members?1:0)},[ScriptOpcode_default.MAP_PLAYERCOUNT]:e=>{const[t,i]=e.popInts(2),n=check(t,CoordValid),r=check(i,CoordValid);let a=0;for(let e=Math.floor(n.x/8);e<=Math.ceil(r.x/8);e++)for(let t=Math.floor(n.z/8);t<=Math.ceil(r.z/8);t++)for(const i of World_default.getZone(e<<3,t<<3,n.level).getAllPlayersSafe())i.x>=n.x&&i.x<=r.x&&i.z>=n.z&&i.z<=r.z&&a++;e.pushInt(a)},[ScriptOpcode_default.HUNTALL]:e=>{const[t,i,n]=e.popInts(3),r=check(t,CoordValid);check(i,NumberNotNull);const a=check(n,HuntVisValid);e.huntIterator=new HuntIterator(World_default.currentTick,r.level,r.x,r.z,i,a,-1,-1,HuntModeType_default.PLAYER)},[ScriptOpcode_default.HUNTNEXT]:e=>{const t=e.huntIterator?.next();if(t&&!t.done){if(!(t.value instanceof Player2))throw new Error("[ServerOps] huntnext command must result instance of Player.");e.activePlayer=t.value,e.pointerAdd(ActivePlayer[e.intOperand]),e.pushInt(1)}else e.pushInt(0)},[ScriptOpcode_default.NPC_HUNTALL]:e=>{const[t,i,n]=e.popInts(3),r=check(t,CoordValid);check(i,NumberNotNull);const a=check(n,HuntVisValid);e.huntIterator=new HuntIterator(World_default.currentTick,r.level,r.x,r.z,i,a,-1,-1,HuntModeType_default.NPC)},[ScriptOpcode_default.NPC_HUNTNEXT]:e=>{const t=e.huntIterator?.next();if(t&&!t.done){if(!(t.value instanceof Npc2))throw new Error("[ServerOps] npc_huntnext command must result instance of Npc.");e.activeNpc=t.value,e.pointerAdd(ActiveNpc[e.intOperand]),e.pushInt(1)}else e.pushInt(0)},[ScriptOpcode_default.INZONE]:e=>{const[t,i,n]=e.popInts(3),r=check(t,CoordValid),a=check(i,CoordValid),s=check(n,CoordValid);s.x<r.x||s.x>a.x||s.level<r.level||s.level>a.level||s.z<r.z||s.z>a.z?e.pushInt(0):e.pushInt(1)},[ScriptOpcode_default.LINEOFWALK]:e=>{const[t,i]=e.popInts(2),n=check(t,CoordValid),r=check(i,CoordValid);n.level===r.level?e.pushInt(hasLineOfWalk(n.level,n.x,n.z,r.x,r.z,1,1,1,1)?1:0):e.pushInt(0)},[ScriptOpcode_default.STAT_RANDOM]:e=>{const[t,i,n]=e.popInts(3),r=Math.floor(i*(99-t)/98)+Math.floor(n*(t-1)/98)+1,a=Math.floor(256*Math.random());e.pushInt(r>a?1:0)},[ScriptOpcode_default.SPOTANIM_MAP]:e=>{const[t,i,n,r]=e.popInts(4),a=check(i,CoordValid),s=check(t,SpotAnimTypeValid);World_default.animMap(a.level,a.x,a.z,s.id,n,r)},[ScriptOpcode_default.DISTANCE]:e=>{const[t,i]=e.popInts(2),n=check(t,CoordValid),r=check(i,CoordValid);e.pushInt(Position.distanceToSW(n,r))},[ScriptOpcode_default.MOVECOORD]:e=>{const[t,i,n,r]=e.popInts(4),a=check(t,CoordValid);e.pushInt(Position.packCoord(a.level+n,a.x+i,a.z+r))},[ScriptOpcode_default.SEQLENGTH]:e=>{e.pushInt(check(e.popInt(),SeqTypeValid).duration)},[ScriptOpcode_default.SPLIT_INIT]:e=>{const[t,i,n]=e.popInts(3);let r=e.popString();const a=check(n,FontTypeValid);if(r.startsWith("<p,")&&-1!==r.indexOf(">")){const t=r.substring(3,r.indexOf(">"));e.splitMesanim=MesanimType.getId(t),r=r.substring(r.indexOf(">")+1)}else e.splitMesanim=-1;e.splitPages=[];const s=a.split(r,t);for(;s.length>0;)e.splitPages.push(s.splice(0,i))},[ScriptOpcode_default.SPLIT_GET]:e=>{const[t,i]=e.popInts(2);e.pushString(e.splitPages[t][i])},[ScriptOpcode_default.SPLIT_PAGECOUNT]:e=>{e.pushInt(e.splitPages.length)},[ScriptOpcode_default.SPLIT_LINECOUNT]:e=>{const t=e.popInt();e.pushInt(e.splitPages[t].length)},[ScriptOpcode_default.SPLIT_GETANIM]:e=>{const t=e.popInt();-1!==e.splitMesanim?e.pushInt(check(e.splitMesanim,MesanimValid).len[e.splitPages[t].length-1]):e.pushInt(-1)},[ScriptOpcode_default.STRUCT_PARAM]:e=>{const[t,i]=e.popInts(2),n=check(i,ParamTypeValid),r=check(t,StructTypeValid);n.isString()?e.pushString(ParamHelper.getStringParam(n.id,r,n.defaultString)):e.pushInt(ParamHelper.getIntParam(n.id,r,n.defaultInt))},[ScriptOpcode_default.COORDX]:e=>{e.pushInt(check(e.popInt(),CoordValid).x)},[ScriptOpcode_default.COORDY]:e=>{e.pushInt(check(e.popInt(),CoordValid).level)},[ScriptOpcode_default.COORDZ]:e=>{e.pushInt(check(e.popInt(),CoordValid).z)},[ScriptOpcode_default.PLAYERCOUNT]:e=>{e.pushInt(World_default.getTotalPlayers())},[ScriptOpcode_default.MAP_BLOCKED]:e=>{const t=check(e.popInt(),CoordValid);e.pushInt(isFlagged(t.x,t.z,t.level,CollisionFlag.WALK_BLOCKED)?1:0)},[ScriptOpcode_default.MAP_INDOORS]:e=>{const t=check(e.popInt(),CoordValid);e.pushInt(isFlagged(t.x,t.z,t.level,CollisionFlag.ROOF)?1:0)},[ScriptOpcode_default.LINEOFSIGHT]:e=>{const[t,i]=e.popInts(2),n=check(t,CoordValid),r=check(i,CoordValid);n.level===r.level?e.pushInt(hasLineOfSight(n.level,n.x,n.z,r.x,r.z,1,1,1,1)?1:0):e.pushInt(0)},[ScriptOpcode_default.WORLD_DELAY]:e=>{e.execution=ScriptState.WORLD_SUSPENDED},[ScriptOpcode_default.PROJANIM_PL]:e=>{const[t,i,n,r,a,s,o,c,l]=e.popInts(9),d=check(t,CoordValid),p=check(n,SpotAnimTypeValid),h=World_default.getPlayerByUid(i);if(!h)throw new Error(`attempted to use invalid player uid: ${i}`);World_default.mapProjAnim(d.level,d.x,d.z,h.x,h.z,-h.pid-1,p.id,r+100,a+100,s,o,c,l)},[ScriptOpcode_default.PROJANIM_NPC]:e=>{const[t,i,n,r,a,s,o,c,l]=e.popInts(9),d=check(t,CoordValid),p=check(n,SpotAnimTypeValid),h=65535&i,u=World_default.getNpc(h);if(!u)throw new Error(`attempted to use invalid npc uid: ${i}`);World_default.mapProjAnim(d.level,d.x,d.z,u.x,u.z,u.nid+1,p.id,r+100,a+100,s,o,c,l)},[ScriptOpcode_default.PROJANIM_MAP]:e=>{const[t,i,n,r,a,s,o,c,l]=e.popInts(9),d=check(n,SpotAnimTypeValid),p=check(t,CoordValid),h=check(i,CoordValid);World_default.mapProjAnim(p.level,p.x,p.z,h.x,h.z,0,d.id,r+100,a,s,o,c,l)},[ScriptOpcode_default.MAP_LOCADDUNSAFE]:e=>{const t=check(e.popInt(),CoordValid);for(const i of World_default.getZone(t.x,t.z,t.level).getAllLocsUnsafe()){if(1!==check(i.type,LocTypeValid).active)continue;const n=locShapeLayer(i.shape);if(i.checkLifeCycle(World_default.currentTick)||n!==LocLayer.WALL)if(n===LocLayer.WALL){if(i.x===t.x&&i.z===t.z)return void e.pushInt(1)}else if(n===LocLayer.GROUND){const n=i.angle===LocAngle.NORTH||i.angle===LocAngle.SOUTH?i.length:i.width,r=i.angle===LocAngle.NORTH||i.angle===LocAngle.SOUTH?i.width:i.length;for(let a=0;a<n*r;a++){const r=i.x+a%n,s=i.z+(a/n|0);if(r===t.x&&s===t.z)return void e.pushInt(1)}}else if(n===LocLayer.GROUND_DECOR&&i.x===t.x&&i.z===t.z)return void e.pushInt(1)}e.pushInt(0)},[ScriptOpcode_default.NPCCOUNT]:e=>{e.pushInt(World_default.getTotalNpcs())},[ScriptOpcode_default.MAP_LASTCLOCK]:e=>{e.pushInt(World_default.lastCycleStats[0])},[ScriptOpcode_default.MAP_LASTWORLD]:e=>{e.pushInt(World_default.lastCycleStats[1])},[ScriptOpcode_default.MAP_LASTCLIENTIN]:e=>{e.pushInt(World_default.lastCycleStats[2])},[ScriptOpcode_default.MAP_LASTNPC]:e=>{e.pushInt(World_default.lastCycleStats[3])},[ScriptOpcode_default.MAP_LASTPLAYER]:e=>{e.pushInt(World_default.lastCycleStats[4])},[ScriptOpcode_default.MAP_LASTLOGOUT]:e=>{e.pushInt(World_default.lastCycleStats[5])},[ScriptOpcode_default.MAP_LASTLOGIN]:e=>{e.pushInt(World_default.lastCycleStats[6])},[ScriptOpcode_default.MAP_LASTZONE]:e=>{e.pushInt(World_default.lastCycleStats[7])},[ScriptOpcode_default.MAP_LASTCLIENTOUT]:e=>{e.pushInt(World_default.lastCycleStats[8])},[ScriptOpcode_default.MAP_LASTCLEANUP]:e=>{e.pushInt(World_default.lastCycleStats[9])},[ScriptOpcode_default.MAP_LASTBANDWIDTHIN]:e=>{e.pushInt(World_default.lastCycleBandwidth[0])},[ScriptOpcode_default.MAP_LASTBANDWIDTHOUT]:e=>{e.pushInt(World_default.lastCycleBandwidth[1])},[ScriptOpcode_default.ZONECOUNT]:e=>{e.pushInt(World_default.zoneMap.zoneCount())},[ScriptOpcode_default.LOCCOUNT]:e=>{e.pushInt(World_default.zoneMap.locCount())},[ScriptOpcode_default.OBJCOUNT]:e=>{e.pushInt(World_default.zoneMap.objCount())}},ServerOps_default=ServerOps,javaStringCompare=function(e,t){const i=e.length,n=t.length,r=Math.min(i,n);let a=0;for(;a<r;){const i=e.charCodeAt(a),n=t.charCodeAt(a);if(i!=n)return i-n;a++}return i-n},StringOps={[ScriptOpcode_default.APPEND_NUM]:e=>{const t=e.popString(),i=e.popInt();e.pushString(t+i)},[ScriptOpcode_default.APPEND]:e=>{const[t,i]=e.popStrings(2);e.pushString(t+i)},[ScriptOpcode_default.APPEND_SIGNNUM]:e=>{const t=e.popString(),i=e.popInt();i>=0?e.pushString(`${t}+${i}`):e.pushString(t+i)},[ScriptOpcode_default.LOWERCASE]:e=>{e.pushString(e.popString().toLowerCase())},[ScriptOpcode_default.TOSTRING]:e=>{e.pushString(e.popInt().toString())},[ScriptOpcode_default.COMPARE]:e=>{const[t,i]=e.popStrings(2);e.pushInt(javaStringCompare(t,i))},[ScriptOpcode_default.TEXT_SWITCH]:e=>{const t=e.popInt(),[i,n]=e.popStrings(2);e.pushString(1===t?i:n)},[ScriptOpcode_default.APPEND_CHAR]:e=>{const t=e.popString(),i=e.popInt();e.pushString(t+String.fromCharCode(i))},[ScriptOpcode_default.STRING_LENGTH]:e=>{e.pushInt(e.popString().length)},[ScriptOpcode_default.SUBSTRING]:e=>{const t=e.popString(),[i,n]=e.popInts(2);e.pushString(t.substring(i,n))},[ScriptOpcode_default.STRING_INDEXOF_CHAR]:e=>{const t=e.popString(),i=String.fromCharCode(e.popInt());e.pushInt(t.indexOf(i))},[ScriptOpcode_default.STRING_INDEXOF_STRING]:e=>{const t=e.popString(),i=e.popString();e.pushInt(t.indexOf(i))}},StringOps_default=StringOps;class ScriptRunner2{static HANDLERS={...CoreOps_default,...ServerOps_default,...PlayerOps_default,...NpcOps_default,...LocOps_default,...ObjOps_default,...NpcConfigOps_default,...LocConfigOps_default,...ObjConfigOps_default,...InvOps_default,...EnumOps_default,...StringOps_default,...NumberOps_default,...DbOps_default,...DebugOps_default};static init(e,t=null,i=null,n=[]){const r=new ScriptState(e,n);return r.self=t,t instanceof Player2?(r._activePlayer=t,r.pointerAdd(ScriptPointer_default.ActivePlayer)):t instanceof Npc2?(r._activeNpc=t,r.pointerAdd(ScriptPointer_default.ActiveNpc)):t instanceof Loc?(r._activeLoc=t,r.pointerAdd(ScriptPointer_default.ActiveLoc)):t instanceof Obj&&(r._activeObj=t,r.pointerAdd(ScriptPointer_default.ActiveObj)),i instanceof Player2?t instanceof Player2?(r._activePlayer2=i,r.pointerAdd(ScriptPointer_default.ActivePlayer2)):(r._activePlayer=i,r.pointerAdd(ScriptPointer_default.ActivePlayer)):i instanceof Npc2?t instanceof Npc2?(r._activeNpc2=i,r.pointerAdd(ScriptPointer_default.ActiveNpc2)):(r._activeNpc=i,r.pointerAdd(ScriptPointer_default.ActiveNpc)):i instanceof Loc?t instanceof Loc?(r._activeLoc2=i,r.pointerAdd(ScriptPointer_default.ActiveLoc2)):(r._activeLoc=i,r.pointerAdd(ScriptPointer_default.ActiveLoc)):i instanceof Obj&&(t instanceof Obj?(r._activeObj2=i,r.pointerAdd(ScriptPointer_default.ActiveObj2)):(r._activeObj=i,r.pointerAdd(ScriptPointer_default.ActiveObj))),r}static execute(e,t=!1,i=!1){if(!e||!e.script||!e.script.info)return ScriptState.ABORTED;try{t&&e.reset(),e.execution!==ScriptState.RUNNING&&e.executionHistory.push(e.execution),e.execution=ScriptState.RUNNING;const n=1e3*performance.now();for(;e.execution===ScriptState.RUNNING;){if(e.pc>=e.script.opcodes.length||e.pc<-1)throw new Error("Invalid program counter: "+e.pc+", max expected: "+e.script.opcodes.length);if(!i&&e.opcount>5e5)throw new Error("Too many instructions");e.opcount++,ScriptRunner2.executeInner(e,e.script.opcodes[++e.pc])}const r=1e3*performance.now()-n|0;if(Environment_default.PROFILE_SCRIPTS&&r>1e3){const t=`Warning [cpu time]: Script: ${e.script.info.scriptName}, time: ${r}us`;e.self instanceof Player2?e.self.wrappedMessageGame(t):console.warn(t)}}catch(t){if(e.pc>=0&&e.pc<e.script.opcodes.length){const i=e.script.opcodes[e.pc];let n=e.intOperand;i===ScriptOpcode_default.POP_VARP||i===ScriptOpcode_default.POP_VARN||i===ScriptOpcode_default.PUSH_VARP||i===ScriptOpcode_default.PUSH_VARN?n=e.intOperand>>16&1:i<=ScriptOpcode_default.POP_ARRAY_INT&&(n=0),t.message=ScriptOpcode_default[i].toLowerCase()+" "+t.message,n&&(t.message="."+t.message)}if(e.self instanceof Player2){e.self.wrappedMessageGame(`script error: ${t.message}`),e.self.wrappedMessageGame(`file: ${q.basename(e.script.info.sourceFilePath)}`),e.self.wrappedMessageGame(""),e.self.wrappedMessageGame("stack backtrace:"),e.self.wrappedMessageGame(`    1: ${e.script.name} - ${e.script.fileName}:${e.script.lineNumber(e.pc)}`);let i=1;for(let t=e.fp;t>0;t--){const n=e.frames[t];n&&(i++,e.self.wrappedMessageGame(`    ${i}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}for(let t=e.debugFp;t>=0;t--){const n=e.debugFrames[t];n&&(i++,e.self.wrappedMessageGame(`    ${i}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}}console.error(`script error: ${t.message}`),console.error(`file: ${q.basename(e.script.info.sourceFilePath)}`),console.error(""),console.error("stack backtrace:"),console.error(`    1: ${e.script.name} - ${e.script.fileName}:${e.script.lineNumber(e.pc)}`);let i=1;for(let t=e.fp;t>0;t--){const n=e.frames[t];n&&(i++,console.error(`    ${i}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}for(let t=e.debugFp;t>=0;t--){const n=e.debugFrames[t];n&&(i++,console.error(`    ${i}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}e.execution=ScriptState.ABORTED}return e.execution}static executeInner(e,t){const i=ScriptRunner2.HANDLERS[t];if(!i)throw new Error(`Unknown opcode ${t}`);i(e)}}class Npc2 extends PathingEntity{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;nid;type;uid;origType;startX;startZ;levels=new Uint8Array(6);baseLevels=new Uint8Array(6);vars;varsString;activeScript=null;delay=0;queue=new LinkList;timerInterval=0;timerClock=0;huntMode=-1;nextHuntTick=-1;huntrange=5;nextPatrolTick=-1;nextPatrolPoint=0;delayedPatrol=!1;heroPoints=new Array(16);constructor(e,t,i,n,r,a,s,o,c,l){super(e,t,i,n,r,a,c,l,MoveStrategy_default.NAIVE,Npc2.FACE_COORD,Npc2.FACE_ENTITY),this.nid=s,this.type=o,this.uid=o<<16|s,this.startX=this.x,this.startZ=this.z,this.origType=o;const d=NpcType.get(o);for(let e=0;e<d.stats.length;e++){const t=d.stats[e];this.levels[e]=t,this.baseLevels[e]=t}-1!==d.timer&&this.setTimer(d.timer),this.vars=new Int32Array(VarNpcType.count),this.varsString=new Array(VarNpcType.count),this.targetOp=d.defaultmode,this.huntMode=d.huntmode,this.huntrange=d.huntrange}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(e,t){const i=this.heroPoints.findIndex((t=>t&&t.uid===e));if(-1!==i)return void(this.heroPoints[i].points+=t);const n=this.heroPoints.findIndex((e=>e&&-1===e.uid));-1===n||(this.heroPoints[n]={uid:e,points:t})}findHero(){return this.heroPoints.sort(((e,t)=>t.points-e.points)),this.heroPoints[0]?.uid??-1}getVar(e){const t=VarNpcType.get(e);return t.type===ScriptVarType.STRING?this.varsString[t.id]:this.vars[t.id]}setVar(e,t){const i=VarNpcType.get(e);i.type===ScriptVarType.STRING&&"string"==typeof t?this.varsString[i.id]=t:"number"==typeof t&&(this.vars[i.id]=t)}resetEntity(e){if(e){this.type=this.origType,this.uid=this.type<<16|this.nid,this.orientation=Direction.SOUTH;for(let e=0;e<this.baseLevels.length;e++)this.levels[e]=this.baseLevels[e];this.resetHeroPoints(),this.defaultMode();const e=NpcType.get(this.type);this.huntrange=e.huntrange}super.resetPathingEntity()}updateMovement(e=!0){const t=NpcType.get(this.type);if(t.moverestrict===MoveRestrict_default.NOMOVE)return!1;if(this.target&&this.targetOp!==NpcMode_default.PLAYERFOLLOW){const e=Position.distanceTo(this,{x:this.startX,z:this.startZ,width:this.width,length:this.length});if(Position.distanceTo(this.target,{x:this.startX,z:this.startZ,width:this.target.width,length:this.target.length})>t.maxrange&&e>t.maxrange)return!1}if(e&&this.target instanceof PathingEntity&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),-1!==this.walktrigger){const e=NpcType.get(this.type),t=ScriptProvider.getByTrigger(ServerTriggerType_default.AI_QUEUE1+this.walktrigger,e.id,e.category);if(this.walktrigger=-1,t){const e=ScriptRunner2.init(t,this,null,[this.walktriggerArg]);ScriptRunner2.execute(e)}}return this.moveSpeed!==MoveSpeed_default.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed()),super.processMovement()}blockWalkFlag(){return this.moveRestrict===MoveRestrict_default.NORMAL?CollisionFlag.NPC:this.moveRestrict===MoveRestrict_default.BLOCKED?CollisionFlag.OPEN:this.moveRestrict===MoveRestrict_default.BLOCKED_NORMAL||this.moveRestrict===MoveRestrict_default.INDOORS||this.moveRestrict===MoveRestrict_default.OUTDOORS?CollisionFlag.NPC:this.moveRestrict===MoveRestrict_default.NOMOVE?CollisionFlag.NULL:this.moveRestrict===MoveRestrict_default.PASSTHRU?CollisionFlag.OPEN:CollisionFlag.NULL}defaultMoveSpeed(){return MoveSpeed_default.WALK}delayed(){return this.delay>0}setTimer(e){this.timerInterval=e}executeScript(e){if(!e)return;const t=ScriptRunner2.execute(e);t!==ScriptState.FINISHED&&t!==ScriptState.ABORTED?t===ScriptState.WORLD_SUSPENDED?World_default.enqueueScript(e,e.popInt()):t===ScriptState.NPC_SUSPENDED?e.activeNpc.activeScript=e:e.activePlayer.activeScript=e:e===this.activeScript&&(this.activeScript=null),e.pointerGet(ScriptPointer_default.ProtectedActivePlayer)&&e._activePlayer&&(e._activePlayer.protect=!1,e.pointerRemove(ScriptPointer_default.ProtectedActivePlayer)),e.pointerGet(ScriptPointer_default.ProtectedActivePlayer2)&&e._activePlayer2&&(e._activePlayer2.protect=!1,e.pointerRemove(ScriptPointer_default.ProtectedActivePlayer2))}processTimers(){if(0!==this.timerInterval&&++this.timerClock>=this.timerInterval){this.timerClock=0;const e=NpcType.get(this.type),t=ScriptProvider.getByTrigger(ServerTriggerType_default.AI_TIMER,e.id,e.category);t&&this.executeScript(ScriptRunner2.init(t,this))}}processQueue(){for(let e=this.queue.head();null!==e;e=this.queue.next())if(this.delayed()||e.delay--,!this.delayed()&&e.delay<=0){const t=ScriptRunner2.init(e.script,this,null,e.args);t.lastInt=e.lastInt,this.executeScript(t),e.unlink()}}enqueueScript(e,t=0,i=0){const n=new EntityQueueRequest(0,e,[],t);n.lastInt=i,this.queue.addTail(n)}randomWalk(e){const t=Math.round(Math.random()*(2*e)-e),i=Math.round(Math.random()*(2*e)-e),n=this.startX+t,r=this.startZ+i;n===this.x&&r===this.z||this.queueWaypoint(n,r)}processNpcModes(){this.targetOp===NpcMode_default.NULL?this.defaultMode():this.targetOp===NpcMode_default.NONE?this.noMode():this.targetOp===NpcMode_default.WANDER?this.wanderMode():this.targetOp===NpcMode_default.PATROL?this.patrolMode():this.targetOp===NpcMode_default.PLAYERESCAPE?this.playerEscapeMode():this.targetOp===NpcMode_default.PLAYERFOLLOW?this.playerFollowMode():this.targetOp===NpcMode_default.PLAYERFACE?this.playerFaceMode():this.targetOp===NpcMode_default.PLAYERFACECLOSE?this.playerFaceCloseMode():this.aiMode()}noMode(){this.clearInteraction(),this.updateMovement(!1),this.targetOp=NpcMode_default.NONE,this.faceEntity=-1,this.mask|=Npc2.FACE_ENTITY}defaultMode(){this.clearInteraction(),this.updateMovement(!1);const e=NpcType.get(this.type);this.targetOp=e.defaultmode,this.faceEntity=-1,this.mask|=Npc2.FACE_ENTITY}wanderMode(){const e=NpcType.get(this.type);e.moverestrict!==MoveRestrict_default.NOMOVE&&Math.random()<.125&&this.randomWalk(e.wanderrange),this.updateMovement(!1)}patrolMode(){const e=NpcType.get(this.type),t=e.patrolCoord,i=e.patrolDelay[this.nextPatrolPoint];let n=Position.unpackCoord(t[this.nextPatrolPoint]);this.updateMovement(!1),this.hasWaypoints()||this.target||this.queueWaypoint(n.x,n.z),(this.x!==n.x||this.z!==n.z)&&World_default.currentTick>=this.nextPatrolTick&&this.teleport(n.x,n.z,n.level),this.x!==n.x||this.z!==n.z||this.delayedPatrol||(this.nextPatrolTick=World_default.currentTick+i,this.delayedPatrol=!0),this.nextPatrolTick>World_default.currentTick||(this.nextPatrolPoint=(this.nextPatrolPoint+1)%t.length,this.nextPatrolTick=World_default.currentTick+30,this.delayedPatrol=!1,n=Position.unpackCoord(t[this.nextPatrolPoint]),this.queueWaypoint(n.x,n.z))}playerEscapeMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof Player2))throw new Error("[Npc] Target must be a Player for playerescape mode.");if(null===World_default.getPlayerByUid(this.target.uid))return void this.defaultMode();if(Position.distanceToSW(this,this.target)>25)return void this.defaultMode();let e,t;this.target.x>=this.x&&this.target.z>=this.z?(e=Direction.SOUTH_WEST,t=CollisionFlag.WALL_SOUTH|CollisionFlag.WALL_WEST):this.target.x>=this.x&&this.target.z<this.z?(e=Direction.NORTH_WEST,t=CollisionFlag.WALL_NORTH|CollisionFlag.WALL_WEST):this.target.x<this.x&&this.target.z>=this.z?(e=Direction.SOUTH_EAST,t=CollisionFlag.WALL_SOUTH|CollisionFlag.WALL_EAST):(e=Direction.NORTH_EAST,t=CollisionFlag.WALL_NORTH|CollisionFlag.WALL_EAST);const i=Position.moveX(this.x,e),n=Position.moveZ(this.z,e);if(isFlagged(i,n,this.level,t))return void this.defaultMode();const r={x:i,z:n,level:this.level};if(Position.distanceToSW(r,{x:this.startX,z:this.startZ})<NpcType.get(this.type).maxrange)return this.queueWaypoint(r.x,r.z),void this.updateMovement(!1);e===Direction.NORTH_EAST||e===Direction.NORTH_WEST?this.queueWaypoint(this.x,r.z):this.queueWaypoint(r.x,this.z),this.updateMovement(!1)}playerFollowMode(){if(this.target){if(!(this.target instanceof Player2))throw new Error("[Npc] Target must be a Player for playerfollow mode.");null!==World_default.getPlayerByUid(this.target.uid)&&this.level===this.target.level?(this.pathToTarget(),this.updateMovement()):this.defaultMode()}else this.defaultMode()}playerFaceMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof Player2))throw new Error("[Npc] Target must be a Player for playerface mode.");if(null===World_default.getPlayerByUid(this.target.uid))return void this.defaultMode();if(this.level!==this.target.level)return void this.defaultMode();const e=NpcType.get(this.type);Position.distanceTo(this,this.target)>e.maxrange?this.defaultMode():this.updateMovement(!1)}playerFaceCloseMode(){if(this.target){if(!(this.target instanceof Player2))throw new Error("[Npc] Target must be a Player for playerfaceclose mode.");null!=World_default.getPlayerByUid(this.target.uid)&&this.level===this.target.level?Position.distanceTo(this,this.target)>1?this.defaultMode():this.updateMovement(!1):this.defaultMode()}else this.defaultMode()}aiMode(){if(this.delayed()||!this.target)return void this.defaultMode();if(this.target.level!==this.level)return void this.defaultMode();if(this.target instanceof Npc2&&(null===World_default.getNpc(this.target.nid)||this.target.delayed()))return void this.defaultMode();if(this.target instanceof Npc2&&-1!==this.targetSubject.type&&null===World_default.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return void this.defaultMode();if(this.target instanceof Obj&&null===World_default.getObj(this.target.x,this.target.z,this.level,this.target.type,-1))return void this.defaultMode();if(this.target instanceof Loc&&null===World_default.getLoc(this.target.x,this.target.z,this.level,this.target.type))return void this.defaultMode();if(this.target instanceof Player2&&null===World_default.getPlayerByUid(this.target.uid))return void this.defaultMode();const e=NpcType.get(this.type);if(Position.distanceTo(this,this.target)>e.attackrange)return void this.defaultMode();const t=this.targetOp>=NpcMode_default.APNPC1&&this.targetOp<=NpcMode_default.APNPC5||this.targetOp>=NpcMode_default.APPLAYER1&&this.targetOp<=NpcMode_default.APPLAYER5||this.targetOp>=NpcMode_default.APLOC1&&this.targetOp<=NpcMode_default.APLOC5||this.targetOp>=NpcMode_default.APOBJ1&&this.targetOp<=NpcMode_default.APOBJ5,i=!t,n=this.getTrigger();n&&i&&this.inOperableDistance(this.target)&&this.target instanceof PathingEntity||n&&t&&this.inApproachDistance(e.attackrange,this.target)?(this.executeScript(ScriptRunner2.init(n,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&this.target instanceof PathingEntity&&(this.target=null,this.interacted=!0,this.clearWaypoints());const r=this.updateMovement();r&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1),this.target&&!this.interacted&&(this.interacted=!1,n&&i&&this.inOperableDistance(this.target)&&(this.target instanceof PathingEntity||!r)||n&&t&&this.inApproachDistance(e.attackrange,this.target)?(this.executeScript(ScriptRunner2.init(n,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&(this.target instanceof PathingEntity||!r)&&(this.target=null,this.interacted=!0,this.clearWaypoints()))}getTrigger(){const e=this.getTriggerForMode(this.targetOp);return e?ScriptProvider.getByTrigger(e,this.type,-1)??null:null}getTriggerForMode(e){return e===NpcMode_default.OPPLAYER1?ServerTriggerType_default.AI_OPPLAYER1:e===NpcMode_default.OPPLAYER2?ServerTriggerType_default.AI_OPPLAYER2:e===NpcMode_default.OPPLAYER3?ServerTriggerType_default.AI_OPPLAYER3:e===NpcMode_default.OPPLAYER4?ServerTriggerType_default.AI_OPPLAYER4:e===NpcMode_default.OPPLAYER5?ServerTriggerType_default.AI_OPPLAYER5:e===NpcMode_default.APPLAYER1?ServerTriggerType_default.AI_APPLAYER1:e===NpcMode_default.APPLAYER2?ServerTriggerType_default.AI_APPLAYER2:e===NpcMode_default.APPLAYER3?ServerTriggerType_default.AI_APPLAYER3:e===NpcMode_default.APPLAYER4?ServerTriggerType_default.AI_APPLAYER4:e===NpcMode_default.APPLAYER5?ServerTriggerType_default.AI_APPLAYER5:e===NpcMode_default.OPLOC1?ServerTriggerType_default.AI_OPLOC1:e===NpcMode_default.OPLOC2?ServerTriggerType_default.AI_OPLOC2:e===NpcMode_default.OPLOC3?ServerTriggerType_default.AI_OPLOC3:e===NpcMode_default.OPLOC4?ServerTriggerType_default.AI_OPLOC4:e===NpcMode_default.OPLOC5?ServerTriggerType_default.AI_OPLOC5:e===NpcMode_default.APLOC1?ServerTriggerType_default.AI_APLOC1:e===NpcMode_default.APLOC2?ServerTriggerType_default.AI_APLOC2:e===NpcMode_default.APLOC3?ServerTriggerType_default.AI_APLOC3:e===NpcMode_default.APLOC4?ServerTriggerType_default.AI_APLOC4:e===NpcMode_default.APLOC5?ServerTriggerType_default.AI_APLOC5:e===NpcMode_default.OPOBJ1?ServerTriggerType_default.AI_OPOBJ1:e===NpcMode_default.OPOBJ2?ServerTriggerType_default.AI_OPOBJ2:e===NpcMode_default.OPOBJ3?ServerTriggerType_default.AI_OPOBJ3:e===NpcMode_default.OPOBJ4?ServerTriggerType_default.AI_OPOBJ4:e===NpcMode_default.OPOBJ5?ServerTriggerType_default.AI_OPOBJ5:e===NpcMode_default.APOBJ1?ServerTriggerType_default.AI_APOBJ1:e===NpcMode_default.APOBJ2?ServerTriggerType_default.AI_APOBJ2:e===NpcMode_default.APOBJ3?ServerTriggerType_default.AI_APOBJ3:e===NpcMode_default.APOBJ4?ServerTriggerType_default.AI_APOBJ4:e===NpcMode_default.APOBJ5?ServerTriggerType_default.AI_APOBJ5:e===NpcMode_default.OPNPC1?ServerTriggerType_default.AI_OPNPC1:e===NpcMode_default.OPNPC2?ServerTriggerType_default.AI_OPNPC2:e===NpcMode_default.OPNPC3?ServerTriggerType_default.AI_OPNPC3:e===NpcMode_default.OPNPC4?ServerTriggerType_default.AI_OPNPC4:e===NpcMode_default.OPNPC5?ServerTriggerType_default.AI_OPNPC5:e===NpcMode_default.APNPC1?ServerTriggerType_default.AI_APNPC1:e===NpcMode_default.APNPC2?ServerTriggerType_default.AI_APNPC2:e===NpcMode_default.APNPC3?ServerTriggerType_default.AI_APNPC3:e===NpcMode_default.APNPC4?ServerTriggerType_default.AI_APNPC4:e===NpcMode_default.APNPC5?ServerTriggerType_default.AI_APNPC5:e===NpcMode_default.QUEUE1?ServerTriggerType_default.AI_QUEUE1:e===NpcMode_default.QUEUE2?ServerTriggerType_default.AI_QUEUE2:e===NpcMode_default.QUEUE3?ServerTriggerType_default.AI_QUEUE3:e===NpcMode_default.QUEUE4?ServerTriggerType_default.AI_QUEUE4:e===NpcMode_default.QUEUE5?ServerTriggerType_default.AI_QUEUE5:e===NpcMode_default.QUEUE6?ServerTriggerType_default.AI_QUEUE6:e===NpcMode_default.QUEUE7?ServerTriggerType_default.AI_QUEUE7:e===NpcMode_default.QUEUE8?ServerTriggerType_default.AI_QUEUE8:e===NpcMode_default.QUEUE9?ServerTriggerType_default.AI_QUEUE9:e===NpcMode_default.QUEUE10?ServerTriggerType_default.AI_QUEUE10:e===NpcMode_default.QUEUE11?ServerTriggerType_default.AI_QUEUE11:e===NpcMode_default.QUEUE12?ServerTriggerType_default.AI_QUEUE12:e===NpcMode_default.QUEUE13?ServerTriggerType_default.AI_QUEUE13:e===NpcMode_default.QUEUE14?ServerTriggerType_default.AI_QUEUE14:e===NpcMode_default.QUEUE15?ServerTriggerType_default.AI_QUEUE15:e===NpcMode_default.QUEUE16?ServerTriggerType_default.AI_QUEUE16:e===NpcMode_default.QUEUE17?ServerTriggerType_default.AI_QUEUE17:e===NpcMode_default.QUEUE18?ServerTriggerType_default.AI_QUEUE18:e===NpcMode_default.QUEUE19?ServerTriggerType_default.AI_QUEUE19:e===NpcMode_default.QUEUE20?ServerTriggerType_default.AI_QUEUE20:null}huntAll(){if(this.nextHuntTick>World_default.currentTick)return;const e=HuntType.get(this.huntMode);if(e.type===HuntModeType_default.OFF)return;if(e.nobodyNear===HuntNobodyNear_default.PAUSEHUNT&&!World_default.getZoneGrid(this.level).isFlagged(Position.zone(this.x),Position.zone(this.z),5))return;if(!e.findKeepHunting&&null!==this.target)return;let t;if(t=e.type===HuntModeType_default.PLAYER?this.huntPlayers(e):e.type===HuntModeType_default.NPC?this.huntNpcs(e):e.type===HuntModeType_default.OBJ?this.huntObjs(e):this.huntLocs(e),t.length>0){const i=t[Math.floor(Math.random()*t.length)];this.setInteraction(Interaction_default.SCRIPT,i,e.findNewMode)}this.nextHuntTick=World_default.currentTick+e.rate}huntPlayers(e){const t=NpcType.get(this.type),i=[],n=new HuntIterator(World_default.currentTick,this.level,this.x,this.z,this.huntrange,e.checkVis,-1,-1,HuntModeType_default.PLAYER);for(const r of n){if(!(r instanceof Player2))throw new Error("[Npc] huntAll must be of type Player here.");if((!e.checkAfk||!r.zonesAfk())&&((e.checkNotTooStrong!==HuntCheckNotTooStrong_default.OUTSIDE_WILDERNESS||r.isInWilderness()||!(r.combatLevel>2*t.vislevel))&&!(-1!==e.checkNotCombat&&r.getVar(e.checkNotCombat)+8>World_default.currentTick||-1!==e.checkNotCombatSelf&&this.getVar(e.checkNotCombatSelf)>=World_default.currentTick))){if(-1!==e.checkInv){let t=0;if(-1!==e.checkObj?t=r.invTotal(e.checkInv,e.checkObj):-1!==e.checkObjParam&&(t=r.invTotalParam(e.checkInv,e.checkObjParam)),t<e.checkInvMinQuantity||t>e.checkInvMaxQuantity)continue}e.checkNotBusy&&r.busy()||i.push(r)}}return i}huntNpcs(e){return Array.from(new HuntIterator(World_default.currentTick,this.level,this.x,this.z,this.huntrange,e.checkVis,e.checkNpc,e.checkCategory,HuntModeType_default.NPC))}huntObjs(e){return Array.from(new HuntIterator(World_default.currentTick,this.level,this.x,this.z,this.huntrange,e.checkVis,e.checkObj,e.checkCategory,HuntModeType_default.OBJ))}huntLocs(e){return Array.from(new HuntIterator(World_default.currentTick,this.level,this.x,this.z,this.huntrange,e.checkVis,e.checkLoc,e.checkCategory,HuntModeType_default.SCENERY))}playAnimation(e,t){this.animId=e,this.animDelay=t,this.mask|=Npc2.ANIM}spotanim(e,t,i){this.graphicId=e,this.graphicHeight=t,this.graphicDelay=i,this.mask|=Npc2.SPOTANIM}applyDamage(e,t){this.damageTaken=e,this.damageType=t;const i=this.levels[NpcStat_default.HITPOINTS];i-e<=0?(this.levels[NpcStat_default.HITPOINTS]=0,this.damageTaken=i):this.levels[NpcStat_default.HITPOINTS]=i-e,this.mask|=Npc2.DAMAGE}say(e){e&&(this.chat=e,this.mask|=Npc2.SAY)}faceSquare(e,t){this.faceX=2*e+1,this.faceZ=2*t+1,this.orientation=Position.face(this.x,this.z,e,t),this.mask|=Npc2.FACE_COORD}changeType(e){this.type=e,this.mask|=Npc2.CHANGE_TYPE,this.uid=e<<16|this.nid}}class GameMap{async init(e){console.time("Loading game map");const t="data/pack/server/maps/",i=["m29_75","m30_75","m31_75","m32_70","m32_71","m32_72","m32_73","m32_74","m32_75","m33_70","m33_71","m33_72","m33_73","m33_74","m33_75","m33_76","m34_70","m34_71","m34_72","m34_73","m34_74","m34_75","m34_76","m35_20","m35_75","m35_76","m36_146","m36_147","m36_148","m36_149","m36_150","m36_153","m36_154","m36_52","m36_53","m36_54","m36_72","m36_73","m36_74","m36_75","m36_76","m37_146","m37_147","m37_148","m37_149","m37_150","m37_151","m37_152","m37_153","m37_154","m37_48","m37_49","m37_50","m37_51","m37_52","m37_53","m37_54","m37_55","m37_72","m37_73","m37_74","m37_75","m38_146","m38_147","m38_148","m38_149","m38_150","m38_151","m38_152","m38_153","m38_154","m38_155","m38_45","m38_46","m38_47","m38_48","m38_49","m38_50","m38_51","m38_52","m38_53","m38_54","m38_55","m38_72","m38_73","m38_74","m39_147","m39_148","m39_149","m39_150","m39_151","m39_152","m39_153","m39_154","m39_155","m39_45","m39_46","m39_47","m39_48","m39_49","m39_50","m39_51","m39_52","m39_53","m39_54","m39_55","m39_72","m39_73","m39_74","m39_75","m39_76","m40_147","m40_148","m40_149","m40_150","m40_151","m40_152","m40_153","m40_154","m40_45","m40_46","m40_47","m40_48","m40_49","m40_50","m40_51","m40_52","m40_53","m40_54","m40_55","m40_72","m40_73","m40_74","m40_75","m40_76","m41_146","m41_149","m41_151","m41_152","m41_153","m41_154","m41_45","m41_46","m41_47","m41_48","m41_49","m41_50","m41_51","m41_52","m41_53","m41_54","m41_55","m41_56","m41_72","m41_73","m41_74","m41_75","m42_144","m42_145","m42_146","m42_151","m42_152","m42_153","m42_49","m42_50","m42_51","m42_52","m42_53","m42_54","m42_55","m42_56","m42_72","m42_73","m42_74","m42_75","m43_144","m43_145","m43_146","m43_153","m43_154","m43_45","m43_46","m43_47","m43_48","m43_49","m43_50","m43_51","m43_52","m43_53","m43_54","m43_55","m43_56","m43_72","m43_73","m43_74","m43_75","m44_144","m44_145","m44_146","m44_148","m44_149","m44_150","m44_151","m44_152","m44_153","m44_154","m44_155","m44_45","m44_46","m44_47","m44_48","m44_49","m44_50","m44_51","m44_52","m44_53","m44_54","m44_55","m44_72","m44_73","m44_74","m44_75","m45_145","m45_146","m45_148","m45_150","m45_151","m45_152","m45_153","m45_154","m45_155","m45_45","m45_46","m45_47","m45_48","m45_49","m45_50","m45_51","m45_52","m45_53","m45_54","m45_55","m45_56","m45_57","m45_58","m45_59","m45_60","m45_61","m45_62","m45_73","m45_74","m45_75","m45_76","m46_149","m46_150","m46_152","m46_153","m46_154","m46_161","m46_45","m46_46","m46_47","m46_48","m46_49","m46_50","m46_51","m46_52","m46_53","m46_54","m46_55","m46_56","m46_57","m46_58","m46_59","m46_60","m46_61","m46_62","m46_75","m47_148","m47_149","m47_150","m47_152","m47_153","m47_160","m47_161","m47_47","m47_48","m47_49","m47_50","m47_51","m47_52","m47_53","m47_54","m47_55","m47_56","m47_57","m47_58","m47_59","m47_60","m47_61","m47_62","m47_75","m48_148","m48_149","m48_152","m48_153","m48_154","m48_155","m48_156","m48_47","m48_48","m48_49","m48_50","m48_51","m48_52","m48_53","m48_54","m48_55","m48_56","m48_57","m48_58","m48_59","m48_60","m48_61","m48_62","m49_148","m49_149","m49_153","m49_154","m49_155","m49_156","m49_46","m49_47","m49_48","m49_49","m49_50","m49_51","m49_52","m49_53","m49_54","m49_55","m49_56","m49_57","m49_58","m49_59","m49_60","m49_61","m49_62","m50_149","m50_150","m50_152","m50_153","m50_154","m50_46","m50_47","m50_48","m50_49","m50_50","m50_51","m50_52","m50_53","m50_54","m50_55","m50_56","m50_57","m50_58","m50_59","m50_60","m50_61","m50_62","m51_147","m51_154","m51_46","m51_47","m51_48","m51_49","m51_50","m51_51","m51_52","m51_53","m51_54","m51_55","m51_56","m51_57","m51_58","m51_59","m51_60","m51_61","m51_62","m52_152","m52_153","m52_154","m52_46","m52_47","m52_48","m52_49","m52_50","m52_51","m52_52","m52_53","m52_54","m52_55","m52_56","m52_57","m52_58","m52_59","m52_60","m52_61","m52_62","m53_49","m53_50","m53_51","m53_52","m53_53"];for(let n=0;n<i.length;n++){const[r,a]=i[n].substring(1).split("_").map(Number),s=r<<6,o=a<<6;this.decodeNpcs(await Packet.load(`${t}n${r}_${a}`),s,o),this.decodeObjs(await Packet.load(`${t}o${r}_${a}`),s,o,e);const c=new Int8Array(16384);this.decodeLands(c,await Packet.load(`${t}m${r}_${a}`),s,o),this.decodeLocs(c,await Packet.load(`${t}l${r}_${a}`),s,o,e)}console.timeEnd("Loading game map")}changeLandCollision(e,t,i,n){changeFloor(e,t,i,n)}changeLocCollision(e,t,i,n,r,a,s,o,c,l){const d=locShapeLayer(e);d===LocLayer.WALL?changeWall(s,o,c,t,e,i,!1,l):d===LocLayer.GROUND?t===LocAngle.NORTH||t===LocAngle.SOUTH?changeLoc(s,o,c,n,r,i,!1,l):changeLoc(s,o,c,r,n,i,!1,l):d===LocLayer.GROUND_DECOR&&1===a&&changeFloor(s,o,c,l)}changeNpcCollision(e,t,i,n,r){changeNpc(t,i,n,e,r)}changePlayerCollision(e,t,i,n,r){changePlayer(t,i,n,e,r)}changeRoofCollision(e,t,i,n){changeRoof(e,t,i,n)}decodeNpcs(e,t,i){for(;e.available>0;){const{x:n,z:r,level:a}=this.unpackCoord(e.g2()),s=t+n,o=i+r,c=e.g1();for(let t=0;t<c;t++){const t=NpcType.get(e.g2()),i=t.size,n=new Npc2(a,s,o,i,i,EntityLifeCycle_default.RESPAWN,World_default.getNextNid(),t.id,t.moverestrict,t.blockwalk);t.members&&World_default.members?World_default.addNpc(n,-1):t.members||World_default.addNpc(n,-1)}}}decodeObjs(e,t,i,n){for(;e.available>0;){const{x:r,z:a,level:s}=this.unpackCoord(e.g2()),o=t+r,c=i+a,l=e.g1();for(let t=0;t<l;t++){const t=ObjType.get(e.g2()),i=new Obj(s,o,c,EntityLifeCycle_default.RESPAWN,t.id,e.g1());t.members&&World_default.members?n.zone(i.x,i.z,i.level).addStaticObj(i):t.members||n.zone(i.x,i.z,i.level).addStaticObj(i)}}}decodeLands(e,t,i,n){for(let i=0;i<4;i++)for(let n=0;n<64;n++)for(let r=0;r<64;r++)for(;;){const a=t.g1();if(0===a)break;if(1===a){t.g1();break}a<=49?t.g1b():a<=81&&(e[this.packCoord(n,r,i)]=a-49)}this.applyLandCollision(i,n,e)}applyLandCollision(e,t,i){for(let n=0;n<4;n++)for(let r=0;r<64;r++){const a=r+e;for(let e=0;e<64;e++){const s=e+t;r%7==0&&e%7==0&&allocateIfAbsent(a,s,n);const o=i[this.packCoord(r,e,n)];if(4&o&&this.changeRoofCollision(a,s,n,!0),1&~o)continue;const c=2==(1===n?2&o:2&i[this.packCoord(r,e,1)])?n-1:n;c<0||this.changeLandCollision(a,s,c,!0)}}}decodeLocs(e,t,i,n,r){let a=-1,s=t.gsmart();for(;0!==s;){a+=s;let o=0,c=t.gsmart();for(;0!==c;){const{x:s,z:l,level:d}=this.unpackCoord(o+=c-1),p=t.g1();c=t.gsmart();const h=2==(1===d?2&e[o]:2&e[this.packCoord(s,l,1)])?d-1:d;if(h<0)continue;const u=LocType.get(a),_=u.width,g=u.length,f=p>>2,O=3&p,T=s+i,m=l+n;r.zone(T,m,h).addStaticLoc(new Loc(h,T,m,_,g,EntityLifeCycle_default.RESPAWN,a,f,O)),u.blockwalk&&this.changeLocCollision(f,O,u.blockrange,g,_,u.active,T,m,h,!0)}s=t.gsmart()}}packCoord(e,t,i){return 63&t|(63&e)<<6|(3&i)<<12}unpackCoord(e){return{x:e>>6&63,z:63&e,level:e>>12&3}}}class Isaac{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(e=[0,0,0,0]){for(let t=0;t<e.length;t++)this.rsl[t]=e[t];this.init()}init(){let e=2654435769,t=2654435769,i=2654435769,n=2654435769,r=2654435769,a=2654435769,s=2654435769,o=2654435769;for(let c=0;c<4;c++)e^=t<<11,n+=e,t+=i,t^=i>>>2,r+=t,i+=n,i^=n<<8,a+=i,n+=r,n^=r>>>16,s+=n,r+=a,r^=a<<10,o+=r,a+=s,a^=s>>>4,e+=a,s+=o,s^=o<<8,t+=s,o+=e,o^=e>>>9,i+=o,e+=t;for(let c=0;c<256;c+=8)e+=this.rsl[c],t+=this.rsl[c+1],i+=this.rsl[c+2],n+=this.rsl[c+3],r+=this.rsl[c+4],a+=this.rsl[c+5],s+=this.rsl[c+6],o+=this.rsl[c+7],e^=t<<11,n+=e,t+=i,t^=i>>>2,r+=t,i+=n,i^=n<<8,a+=i,n+=r,n^=r>>>16,s+=n,r+=a,r^=a<<10,o+=r,a+=s,a^=s>>>4,e+=a,s+=o,s^=o<<8,t+=s,o+=e,o^=e>>>9,i+=o,e+=t,this.mem[c]=e,this.mem[c+1]=t,this.mem[c+2]=i,this.mem[c+3]=n,this.mem[c+4]=r,this.mem[c+5]=a,this.mem[c+6]=s,this.mem[c+7]=o;for(let c=0;c<256;c+=8)e+=this.mem[c],t+=this.mem[c+1],i+=this.mem[c+2],n+=this.mem[c+3],r+=this.mem[c+4],a+=this.mem[c+5],s+=this.mem[c+6],o+=this.mem[c+7],e^=t<<11,n+=e,t+=i,t^=i>>>2,r+=t,i+=n,i^=n<<8,a+=i,n+=r,n^=r>>>16,s+=n,r+=a,r^=a<<10,o+=r,a+=s,a^=s>>>4,e+=a,s+=o,s^=o<<8,t+=s,o+=e,o^=e>>>9,i+=o,e+=t,this.mem[c]=e,this.mem[c+1]=t,this.mem[c+2]=i,this.mem[c+3]=n,this.mem[c+4]=r,this.mem[c+5]=a,this.mem[c+6]=s,this.mem[c+7]=o;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let e=0;e<256;e++){const t=this.mem[e];switch(3&e){case 0:this.a^=this.a<<13;break;case 1:this.a^=this.a>>>6;break;case 2:this.a^=this.a<<2;break;case 3:this.a^=this.a>>>16}let i;this.a+=this.mem[e+128&255],this.mem[e]=i=this.mem[t>>>2&255]+this.a+this.b,this.rsl[e]=this.b=this.mem[i>>>8>>>2&255]+t}}nextInt(){return 0==this.count--&&(this.isaac(),this.count=255),this.rsl[this.count]}}class PlayerLoading{static loadFromFile(e){const t=fromBase37(toBase37(e));let i;return i=fs.existsSync(`data/players/${t}.sav`)?Packet.load(`data/players/${t}.sav`):new Packet(new Uint8Array),PlayerLoading.load(e,i,null)}static load(e,t,i){const n=toBase37(e),r=fromBase37(n),a=i?new NetworkPlayer2(r,n,i):new Player2(r,n);if(t.data.length<2){for(let e=0;e<21;e++)a.stats[e]=0,a.baseLevels[e]=1,a.levels[e]=1;return a.stats[PlayerStat_default.HITPOINTS]=getExpByLevel(10),a.baseLevels[PlayerStat_default.HITPOINTS]=10,a.levels[PlayerStat_default.HITPOINTS]=10,a}if(8196!==t.g2())throw new Error("Invalid player save");const s=t.g2();if(s>3)throw new Error("Unsupported player save format");t.pos=t.data.length-4;if(t.g4()!=Packet.getcrc(t.data,0,t.data.length-4))throw new Error("Player save corrupted");t.pos=4,a.x=t.g2(),a.z=t.g2(),a.level=t.g1();for(let e=0;e<7;e++)a.body[e]=t.g1(),255===a.body[e]&&(a.body[e]=-1);for(let e=0;e<5;e++)a.colors[e]=t.g1();a.gender=t.g1(),a.runenergy=t.g2(),a.playtime=s>=2?t.g4():t.g2();for(let e=0;e<21;e++)a.stats[e]=t.g4(),a.baseLevels[e]=getLevelByExp(a.stats[e]),a.levels[e]=t.g1();const o=t.g2();for(let e=0;e<o;e++)a.vars[e]=t.g4();const c=t.g1();for(let e=0;e<c;e++){const e=t.g2(),i=a.getInventory(e);if(i)for(let e=0;e<i.capacity;e++){const n=t.g2();if(0===n)continue;let r=t.g1();255===r&&(r=t.g4()),i.set(e,{id:n-1,count:r})}}if(s>=3){const e=t.g1();for(let i=0;i<e;i++)a.afkZones[i]=t.g4();a.lastAfkZone=t.g2()}return a.combatLevel=a.getCombatLevel(),a.lastResponse=World_default.currentTick,Environment_default.LOCAL_DEV?a.staffModLevel=3:void 0!==Environment_default.JMODS.find((e=>e===r))&&(a.staffModLevel=2),a}}function createWorker(e){const t=new Blob([e],{type:"application/javascript"}),i=URL.createObjectURL(t);return new Worker(i,{type:"module"})}class NetworkStream{queue=[];available=0;buffer=null;offset=0;waiting=0;received(e){this.queue.push(e),this.available+=e.length}clear(){this.queue=[],this.available=0,this.buffer=null,this.offset=0}async readByte(e){if(null===e)return 0;if(this.available<1)return await new Promise((e=>setTimeout(e,10))),this.readByte(e);null===this.buffer&&(this.buffer=this.queue.shift()??null,this.offset=0);const t=this.buffer?.[this.offset]??0;return this.offset++,this.available--,this.buffer&&this.offset===this.buffer.length&&(this.buffer=null),t}async readBytes(e,t,i,n,r=!0){if(null===e)return 0;if(this.available<n){if(r)return await new Promise((e=>setTimeout(e,10))),this.readBytes(e,t,i,n);n=this.available}t.pos=i;for(let e=0;e<n;e++)null===this.buffer&&(this.buffer=this.queue.shift()??null,this.offset=0),t.data[i+e]=this.buffer?.[this.offset]??0,this.offset++,this.available--,this.buffer&&this.offset===this.buffer.length&&(this.buffer=null);return n}}class LoginResponse{static SUCCESSFUL=Uint8Array.from([2]);static INVALID_USER_OR_PASS=Uint8Array.from([3]);static ACCOUNT_DISABLED=Uint8Array.from([4]);static LOGGED_IN=Uint8Array.from([5]);static SERVER_UPDATED=Uint8Array.from([6]);static WORLD_FULL=Uint8Array.from([7]);static LOGIN_SERVER_OFFLINE=Uint8Array.from([8]);static LOGIN_LIMIT_EXCEEDED=Uint8Array.from([9]);static UNABLE_TO_CONNECT=Uint8Array.from([10]);static LOGIN_REJECTED=Uint8Array.from([11]);static NEED_MEMBERS_ACCOUNT=Uint8Array.from([12]);static COULD_NOT_COMPLETE=Uint8Array.from([13]);static SERVER_UPDATING=Uint8Array.from([14]);static RECONNECTING=Uint8Array.from([15]);static LOGIN_ATTEMPTS_EXCEEDED=Uint8Array.from([16]);static STANDING_IN_MEMBERS=Uint8Array.from([17]);static STAFF_MOD_LEVEL=Uint8Array.from([18])}class LoginClient{socket=null;stream=new NetworkStream;async connect(){if(!this.socket)return new Promise((e=>{this.socket=net.createConnection({port:Environment_default.LOGIN_PORT,host:Environment_default.LOGIN_HOST}),this.socket.setNoDelay(!0),this.socket.setTimeout(1e3),this.socket.on("data",(async e=>{this.stream.received(e)})),this.socket.once("close",(()=>{this.disconnect(),e()})),this.socket.once("error",(()=>{this.disconnect(),e()})),this.socket.once("connect",(()=>{e()}))}))}disconnect(){null!==this.socket&&(this.socket.destroy(),this.socket=null,this.stream.clear())}async write(e,t,i=null,n=!0){if(null===e)return;const r=new Packet(new Uint8Array(3+(null!==i?i?.length:0)));r.p1(t),null!==i?(r.p2(i.length),r.pdata(i,0,i.length)):r.p2(0);!e.write(r.data)&&n&&await new Promise((t=>{const i=setInterval((()=>{(null===e||e.closed)&&(clearInterval(i),t())}),100);e.once("drain",(()=>{clearInterval(i),t()}))}))}async load(e,t,i){if(await this.connect(),null===this.socket)return{reply:-1,data:null};const n=new Packet(new Uint8Array(10+t.length+1+4));n.p2(Environment_default.WORLD_ID),n.p8(e),n.pjstr(t),n.p4(i),await this.write(this.socket,1,n.data);const r=await this.stream.readByte(this.socket);if(1!==r)return this.disconnect(),{reply:r,data:null};const a=new Packet(new Uint8Array(2));await this.stream.readBytes(this.socket,a,0,2);const s=a.g2(),o=new Packet(new Uint8Array(s));return await this.stream.readBytes(this.socket,o,0,s),this.disconnect(),{reply:r,data:o}}async save(e,t){if(await this.connect(),null===this.socket)return-1;const i=new Packet(new Uint8Array(12+t.length));i.p2(Environment_default.WORLD_ID),i.p8(e),i.p2(t.length),i.pdata(t,0,t.length),await this.write(this.socket,2,i.data);const n=await this.stream.readByte(this.socket);return this.disconnect(),n}async reset(){if(await this.connect(),null===this.socket)return-1;const e=new Packet(new Uint8Array(2));e.p2(Environment_default.WORLD_ID),await this.write(this.socket,3,e.data),this.disconnect()}async count(e){if(await this.connect(),null===this.socket)return-1;const t=new Packet(new Uint8Array(2));t.p2(e),await this.write(this.socket,4,t.data);const i=new Packet(new Uint8Array(2));await this.stream.readBytes(this.socket,i,0,2);const n=i.g2();return this.disconnect(),n}async heartbeat(e){if(await this.connect(),null===this.socket)return-1;const t=new Packet(new Uint8Array(4+8*e.length));t.p2(Environment_default.WORLD_ID),t.p2(e.length);for(const i of e)t.p8(i);await this.write(this.socket,5,t.data),this.disconnect()}}async function makeCrc(e){if(!(await fetch(e)).ok)return;const t=await Packet.load(e),i=Packet.getcrc(t.data,0,t.data.length);CrcTable.push(i),CrcBuffer.p4(i)}function makeCrcs(){CrcTable=[],CrcBuffer.pos=0,CrcBuffer.p4(0),makeCrc("data/pack/client/title"),makeCrc("data/pack/client/config"),makeCrc("data/pack/client/interface"),makeCrc("data/pack/client/media"),makeCrc("data/pack/client/models"),makeCrc("data/pack/client/textures"),makeCrc("data/pack/client/wordenc"),makeCrc("data/pack/client/sounds"),CrcBuffer32=Packet.getcrc(CrcBuffer.data,0,CrcBuffer.data.length)}var CrcBuffer=new Packet(new Uint8Array(36)),CrcTable=[],CrcBuffer32=0;makeCrcs();var LoginThreadWorker="\n// src/jagex2/datastruct/Linkable.ts\nclass Linkable {\n  key;\n  next;\n  prev;\n  constructor() {\n    this.key = 0n;\n    this.next = this;\n    this.prev = this;\n  }\n  unlink() {\n    if (!this.prev || !this.next) {\n      return;\n    }\n    this.prev.next = this.next;\n    this.next.prev = this.prev;\n    this.next = null;\n    this.prev = null;\n  }\n}\n\n// src/jagex2/datastruct/LinkList.ts\nclass LinkList {\n  sentinel;\n  cursor = null;\n  constructor() {\n    const head = new Linkable;\n    head.next = head;\n    head.prev = head;\n    this.sentinel = head;\n  }\n  addTail(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel.prev;\n    node.next = this.sentinel;\n    if (node.prev) {\n      node.prev.next = node;\n    }\n    node.next.prev = node;\n  }\n  addHead(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel;\n    node.next = this.sentinel.next;\n    node.prev.next = node;\n    if (node.next) {\n      node.next.prev = node;\n    }\n  }\n  removeHead() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      return null;\n    }\n    node?.unlink();\n    return node;\n  }\n  head() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  tail() {\n    const node = this.sentinel.prev;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  next() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  prev() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  clear() {\n    while (true) {\n      const node = this.sentinel.next;\n      if (node === this.sentinel) {\n        return;\n      }\n      node?.unlink();\n    }\n  }\n}\n\n// src/jagex2/datastruct/Hashable.ts\nclass Hashable extends Linkable {\n  nextHashable;\n  prevHashable;\n  constructor() {\n    super();\n    this.nextHashable = this;\n    this.prevHashable = this;\n  }\n  uncache() {\n    if (!this.prevHashable || !this.nextHashable) {\n      return;\n    }\n    this.prevHashable.nextHashable = this.nextHashable;\n    this.nextHashable.prevHashable = this.prevHashable;\n    this.nextHashable = null;\n    this.prevHashable = null;\n  }\n}\n\n// src/jagex2/io/Packet.ts\nclass Packet extends Hashable {\n  static crctable = new Int32Array(256);\n  static bitmask = new Uint32Array(33);\n  static crc32b = 3988292384;\n  static {\n    for (let i = 0;i < 32; i++) {\n      this.bitmask[i] = (1 << i) - 1;\n    }\n    this.bitmask[32] = 4294967295;\n    for (let b = 0;b < 256; b++) {\n      let remainder = b;\n      for (let bit = 0;bit < 8; bit++) {\n        if ((remainder & 1) == 1) {\n          remainder = remainder >>> 1 ^ this.crc32b;\n        } else {\n          remainder >>>= 1;\n        }\n      }\n      this.crctable[b] = remainder;\n    }\n  }\n  static getcrc(src, offset, length) {\n    let crc = 4294967295;\n    for (let i = offset;i < length; i++) {\n      crc = crc >>> 8 ^ this.crctable[(crc ^ src[i]) & 255];\n    }\n    return ~crc;\n  }\n  static checkcrc(src, offset, length, expected = 0) {\n    const checksum = Packet.getcrc(src, offset, length);\n    return checksum == expected;\n  }\n  static alloc(type) {\n    let packet = null;\n    if (type === 0 && this.cacheMinCount > 0) {\n      packet = this.cacheMin.removeHead();\n      this.cacheMinCount--;\n    } else if (type === 1 && this.cacheMidCount > 0) {\n      packet = this.cacheMid.removeHead();\n      this.cacheMidCount--;\n    } else if (type === 2 && this.cacheMaxCount > 0) {\n      packet = this.cacheMax.removeHead();\n      this.cacheMaxCount--;\n    } else if (type === 3 && this.cacheBigCount > 0) {\n      packet = this.cacheBig.removeHead();\n      this.cacheBigCount--;\n    } else if (type === 4 && this.cacheHugeCount > 0) {\n      packet = this.cacheHuge.removeHead();\n      this.cacheHugeCount--;\n    } else if (type === 5 && this.cacheUnimaginableCount > 0) {\n      packet = this.cacheUnimaginable.removeHead();\n      this.cacheUnimaginableCount--;\n    }\n    if (packet !== null) {\n      packet.pos = 0;\n      packet.bitPos = 0;\n      return packet;\n    }\n    if (type === 0) {\n      return new Packet(new Uint8Array(100));\n    } else if (type === 1) {\n      return new Packet(new Uint8Array(5000));\n    } else if (type === 2) {\n      return new Packet(new Uint8Array(30000));\n    } else if (type === 3) {\n      return new Packet(new Uint8Array(1e5));\n    } else if (type === 4) {\n      return new Packet(new Uint8Array(500000));\n    } else if (type === 5) {\n      return new Packet(new Uint8Array(2000000));\n    } else {\n      return new Packet(new Uint8Array(type));\n    }\n  }\n  static async load(path, seekToEnd = false) {\n    const packet = new Packet(new Uint8Array(await (await fetch(path)).arrayBuffer()));\n    if (seekToEnd) {\n      packet.pos = packet.data.length;\n    }\n    return packet;\n  }\n  static cacheMinCount = 0;\n  static cacheMidCount = 0;\n  static cacheMaxCount = 0;\n  static cacheBigCount = 0;\n  static cacheHugeCount = 0;\n  static cacheUnimaginableCount = 0;\n  static cacheMin = new LinkList;\n  static cacheMid = new LinkList;\n  static cacheMax = new LinkList;\n  static cacheBig = new LinkList;\n  static cacheHuge = new LinkList;\n  static cacheUnimaginable = new LinkList;\n  data;\n  #view;\n  pos;\n  bitPos;\n  constructor(src) {\n    super();\n    this.data = src;\n    this.#view = new DataView(this.data.buffer);\n    this.pos = 0;\n    this.bitPos = 0;\n  }\n  get available() {\n    return this.data.length - this.pos;\n  }\n  get length() {\n    return this.data.length;\n  }\n  release() {\n    this.pos = 0;\n    this.bitPos = 0;\n    if (this.data.length === 100 && Packet.cacheMinCount < 1000) {\n      Packet.cacheMin.addTail(this);\n      Packet.cacheMinCount++;\n    } else if (this.data.length === 5000 && Packet.cacheMidCount < 250) {\n      Packet.cacheMid.addTail(this);\n      Packet.cacheMidCount++;\n    } else if (this.data.length === 30000 && Packet.cacheMaxCount < 50) {\n      Packet.cacheMax.addTail(this);\n      Packet.cacheMaxCount++;\n    } else if (this.data.length === 1e5 && Packet.cacheBigCount < 10) {\n      Packet.cacheBig.addTail(this);\n      Packet.cacheBigCount++;\n    } else if (this.data.length === 500000 && Packet.cacheHugeCount < 5) {\n      Packet.cacheHuge.addTail(this);\n      Packet.cacheHugeCount++;\n    } else if (this.data.length === 2000000 && Packet.cacheUnimaginableCount < 2) {\n      Packet.cacheUnimaginable.addTail(this);\n      Packet.cacheUnimaginableCount++;\n    }\n  }\n  p1(value) {\n    this.#view.setUint8(this.pos++, value);\n  }\n  p2(value) {\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  ip2(value) {\n    this.#view.setUint16(this.pos, value, true);\n    this.pos += 2;\n  }\n  p3(value) {\n    this.#view.setUint8(this.pos++, value >> 16);\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  p4(value) {\n    this.#view.setInt32(this.pos, value);\n    this.pos += 4;\n  }\n  ip4(value) {\n    this.#view.setInt32(this.pos, value, true);\n    this.pos += 4;\n  }\n  p8(value) {\n    this.#view.setBigInt64(this.pos, value);\n    this.pos += 8;\n  }\n  pbool(value) {\n    this.p1(value ? 1 : 0);\n  }\n  pjstr(str, terminator = 10) {\n    const length = str.length;\n    for (let i = 0;i < length; i++) {\n      this.#view.setUint8(this.pos++, str.charCodeAt(i));\n    }\n    this.#view.setUint8(this.pos++, terminator);\n  }\n  pdata(src, offset, length) {\n    this.data.set(src.subarray(offset, offset + length), this.pos);\n    this.pos += length - offset;\n  }\n  psize4(size) {\n    this.#view.setUint32(this.pos - size - 4, size);\n  }\n  psize2(size) {\n    this.#view.setUint16(this.pos - size - 2, size);\n  }\n  psize1(size) {\n    this.#view.setUint8(this.pos - size - 1, size);\n  }\n  psmarts(value) {\n    if (value < 64 && value >= 64) {\n      this.p1(value + 64);\n    } else if (value < 16384 && value >= -16384) {\n      this.p2(value + 49152);\n    } else {\n      throw new Error(\"Error psmarts out of range: \" + value);\n    }\n  }\n  psmart(value) {\n    if (value >= 0 && value < 128) {\n      this.p1(value);\n    } else if (value >= 0 && value < 32768) {\n      this.p2(value + 32768);\n    } else {\n      throw new Error(\"Error psmart out of range: \" + value);\n    }\n  }\n  g1() {\n    return this.#view.getUint8(this.pos++);\n  }\n  g1b() {\n    return this.#view.getInt8(this.pos++);\n  }\n  g2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2);\n  }\n  g2s() {\n    this.pos += 2;\n    return this.#view.getInt16(this.pos - 2);\n  }\n  ig2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2, true);\n  }\n  g3() {\n    const result = this.#view.getUint8(this.pos++) << 16 | this.#view.getUint16(this.pos);\n    this.pos += 2;\n    return result;\n  }\n  g4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4);\n  }\n  ig4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4, true);\n  }\n  g8() {\n    this.pos += 8;\n    return this.#view.getBigInt64(this.pos - 8);\n  }\n  gbool() {\n    return this.g1() === 1;\n  }\n  gjstr(terminator = 10) {\n    const length = this.data.length;\n    let str = \"\";\n    let b;\n    while ((b = this.#view.getUint8(this.pos++)) !== terminator && this.pos < length) {\n      str += String.fromCharCode(b);\n    }\n    return str;\n  }\n  gdata(dest, offset, length) {\n    dest.set(this.data.subarray(this.pos, this.pos + length), offset);\n    this.pos += length;\n  }\n  gsmarts() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() - 64 : this.g2() - 49152;\n  }\n  gsmart() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() : this.g2() - 32768;\n  }\n  bits() {\n    this.bitPos = this.pos << 3;\n  }\n  bytes() {\n    this.pos = this.bitPos + 7 >>> 3;\n  }\n  gBit(n) {\n    let bytePos = this.bitPos >>> 3;\n    let remaining = 8 - (this.bitPos & 7);\n    let value = 0;\n    this.bitPos += n;\n    for (;n > remaining; remaining = 8) {\n      value += (this.#view.getUint8(bytePos++) & Packet.bitmask[remaining]) << n - remaining;\n      n -= remaining;\n    }\n    if (n == remaining) {\n      value += this.#view.getUint8(bytePos) & Packet.bitmask[remaining];\n    } else {\n      value += this.#view.getUint8(bytePos) >>> remaining - n & Packet.bitmask[n];\n    }\n    return value;\n  }\n  pBit(n, value) {\n    const pos = this.bitPos;\n    this.bitPos += n;\n    let bytePos = pos >>> 3;\n    let remaining = 8 - (pos & 7);\n    const view = this.#view;\n    for (;n > remaining; remaining = 8) {\n      const shift2 = (1 << remaining) - 1;\n      const byte2 = view.getUint8(bytePos);\n      view.setUint8(bytePos++, byte2 & ~shift2 | value >>> n - remaining & shift2);\n      n -= remaining;\n    }\n    const r = remaining - n;\n    const shift = (1 << n) - 1;\n    const byte = view.getUint8(bytePos);\n    view.setUint8(bytePos, byte & ~shift << r | (value & shift) << r);\n  }\n}\n\n// src/jagex2/jstring/JString.ts\nfunction toBase37(string) {\n  string = string.trim();\n  let l = 0n;\n  for (let i = 0;i < string.length && i < 12; i++) {\n    const c = string.charCodeAt(i);\n    l *= 37n;\n    if (c >= 65 && c <= 90) {\n      l += BigInt(c + 1 - 65);\n    } else if (c >= 97 && c <= 122) {\n      l += BigInt(c + 1 - 97);\n    } else if (c >= 48 && c <= 57) {\n      l += BigInt(c + 27 - 48);\n    }\n  }\n  return l;\n}\nfunction fromBase37(value) {\n  if (value < 0n || value >= 6582952005840035281n) {\n    return \"invalid_name\";\n  }\n  if (value % 37n === 0n) {\n    return \"invalid_name\";\n  }\n  let len = 0;\n  const chars = Array(12);\n  while (value !== 0n) {\n    const l1 = value;\n    value /= 37n;\n    chars[11 - len++] = BASE37_LOOKUP[Number(l1 - value * 37n)];\n  }\n  return chars.slice(12 - len).join(\"\");\n}\nfunction toSafeName(name) {\n  return fromBase37(toBase37(name));\n}\nvar BASE37_LOOKUP = [\n  \"_\",\n  \"a\",\n  \"b\",\n  \"c\",\n  \"d\",\n  \"e\",\n  \"f\",\n  \"g\",\n  \"h\",\n  \"i\",\n  \"j\",\n  \"k\",\n  \"l\",\n  \"m\",\n  \"n\",\n  \"o\",\n  \"p\",\n  \"q\",\n  \"r\",\n  \"s\",\n  \"t\",\n  \"u\",\n  \"v\",\n  \"w\",\n  \"x\",\n  \"y\",\n  \"z\",\n  \"0\",\n  \"1\",\n  \"2\",\n  \"3\",\n  \"4\",\n  \"5\",\n  \"6\",\n  \"7\",\n  \"8\",\n  \"9\"\n];\n\n// src/lostcity/server/NetworkStream.ts\nclass NetworkStream {\n  queue = [];\n  available = 0;\n  buffer = null;\n  offset = 0;\n  waiting = 0;\n  received(buf) {\n    this.queue.push(buf);\n    this.available += buf.length;\n  }\n  clear() {\n    this.queue = [];\n    this.available = 0;\n    this.buffer = null;\n    this.offset = 0;\n  }\n  async readByte(socket) {\n    if (socket === null) {\n      return 0;\n    }\n    if (this.available < 1) {\n      await new Promise((res) => setTimeout(res, 10));\n      return this.readByte(socket);\n    }\n    if (this.buffer === null) {\n      this.buffer = this.queue.shift() ?? null;\n      this.offset = 0;\n    }\n    const value = this.buffer?.[this.offset] ?? 0;\n    this.offset++;\n    this.available--;\n    if (this.buffer && this.offset === this.buffer.length) {\n      this.buffer = null;\n    }\n    return value;\n  }\n  async readBytes(socket, destination, offset, length, full = true) {\n    if (socket === null) {\n      return 0;\n    }\n    if (this.available < length) {\n      if (full) {\n        await new Promise((res) => setTimeout(res, 10));\n        return this.readBytes(socket, destination, offset, length);\n      } else {\n        length = this.available;\n      }\n    }\n    destination.pos = offset;\n    for (let i = 0;i < length; i++) {\n      if (this.buffer === null) {\n        this.buffer = this.queue.shift() ?? null;\n        this.offset = 0;\n      }\n      destination.data[offset + i] = this.buffer?.[this.offset] ?? 0;\n      this.offset++;\n      this.available--;\n      if (this.buffer && this.offset === this.buffer.length) {\n        this.buffer = null;\n      }\n    }\n    return length;\n  }\n}\n\n// src/lostcity/util/Environment.ts\nvar Environment_default = {\n  PUBLIC_IP: \"localhost\",\n  WEB_PORT: 80,\n  GAME_PORT: 43594,\n  LOGIN_HOST: \"localhost\",\n  LOGIN_PORT: 43500,\n  LOGIN_KEY: \"\",\n  FRIEND_HOST: \"localhost\",\n  FRIEND_PORT: 43501,\n  FRIEND_KEY: \"\",\n  WORLD_ID: 0,\n  LOCAL_DEV: true,\n  MEMBERS_WORLD: true,\n  XP_MULTIPLIER: 1,\n  SHUTDOWN_TIMER: 50,\n  HTTPS_ENABLED: false,\n  ADDRESS_SHOWPORT: true,\n  CLIRUNNER: false,\n  CI_MODE: false,\n  SKIP_CORS: false,\n  DB_HOST: \"\",\n  DB_USER: \"\",\n  DB_PASS: \"\",\n  DB_NAME: \"\",\n  ADMIN_IP: \"localhost\",\n  SKIP_CRC: false,\n  JAVA_PATH: \"java\",\n  DATA_SRC_DIR: \"data/src\",\n  VALIDATE_PACK: true,\n  STRICT_FOLDERS: true,\n  BUILD_ON_STARTUP: true,\n  UPDATE_ON_STARTUP: true,\n  JMODS: [\"pazaz\"],\n  CLIENT_PATHFINDER: true,\n  NO_SOCKET_TIMEOUT: false,\n  PROFILE_SCRIPTS: false\n};\n\n// src/lostcity/server/LoginServer.ts\nclass LoginResponse {\n  static SUCCESSFUL = Uint8Array.from([2]);\n  static INVALID_USER_OR_PASS = Uint8Array.from([3]);\n  static ACCOUNT_DISABLED = Uint8Array.from([4]);\n  static LOGGED_IN = Uint8Array.from([5]);\n  static SERVER_UPDATED = Uint8Array.from([6]);\n  static WORLD_FULL = Uint8Array.from([7]);\n  static LOGIN_SERVER_OFFLINE = Uint8Array.from([8]);\n  static LOGIN_LIMIT_EXCEEDED = Uint8Array.from([9]);\n  static UNABLE_TO_CONNECT = Uint8Array.from([10]);\n  static LOGIN_REJECTED = Uint8Array.from([11]);\n  static NEED_MEMBERS_ACCOUNT = Uint8Array.from([12]);\n  static COULD_NOT_COMPLETE = Uint8Array.from([13]);\n  static SERVER_UPDATING = Uint8Array.from([14]);\n  static RECONNECTING = Uint8Array.from([15]);\n  static LOGIN_ATTEMPTS_EXCEEDED = Uint8Array.from([16]);\n  static STANDING_IN_MEMBERS = Uint8Array.from([17]);\n  static STAFF_MOD_LEVEL = Uint8Array.from([18]);\n}\nclass LoginClient {\n  socket = null;\n  stream = new NetworkStream;\n  async connect() {\n    if (this.socket) {\n      return;\n    }\n    return new Promise((res) => {\n      this.socket = net.createConnection({\n        port: Environment_default.LOGIN_PORT,\n        host: Environment_default.LOGIN_HOST\n      });\n      this.socket.setNoDelay(true);\n      this.socket.setTimeout(1000);\n      this.socket.on(\"data\", async (buf) => {\n        this.stream.received(buf);\n      });\n      this.socket.once(\"close\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"error\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"connect\", () => {\n        res();\n      });\n    });\n  }\n  disconnect() {\n    if (this.socket === null) {\n      return;\n    }\n    this.socket.destroy();\n    this.socket = null;\n    this.stream.clear();\n  }\n  async write(socket, opcode, data = null, full = true) {\n    if (socket === null) {\n      return;\n    }\n    const packet = new Packet(new Uint8Array(1 + 2 + (data !== null ? data?.length : 0)));\n    packet.p1(opcode);\n    if (data !== null) {\n      packet.p2(data.length);\n      packet.pdata(data, 0, data.length);\n    } else {\n      packet.p2(0);\n    }\n    const done = socket.write(packet.data);\n    if (!done && full) {\n      await new Promise((res) => {\n        const interval = setInterval(() => {\n          if (socket === null || socket.closed) {\n            clearInterval(interval);\n            res();\n          }\n        }, 100);\n        socket.once(\"drain\", () => {\n          clearInterval(interval);\n          res();\n        });\n      });\n    }\n  }\n  async load(username37, password, uid) {\n    await this.connect();\n    if (this.socket === null) {\n      return { reply: -1, data: null };\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + password.length + 1 + 4));\n    request.p2(Environment_default.WORLD_ID);\n    request.p8(username37);\n    request.pjstr(password);\n    request.p4(uid);\n    await this.write(this.socket, 1, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    if (reply !== 1) {\n      this.disconnect();\n      return { reply, data: null };\n    }\n    const data = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, data, 0, 2);\n    const length = data.g2();\n    const data2 = new Packet(new Uint8Array(length));\n    await this.stream.readBytes(this.socket, data2, 0, length);\n    this.disconnect();\n    return { reply, data: data2 };\n  }\n  async save(username37, save) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + 2 + save.length));\n    request.p2(Environment_default.WORLD_ID);\n    request.p8(username37);\n    request.p2(save.length);\n    request.pdata(save, 0, save.length);\n    await this.write(this.socket, 2, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    this.disconnect();\n    return reply;\n  }\n  async reset() {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(Environment_default.WORLD_ID);\n    await this.write(this.socket, 3, request.data);\n    this.disconnect();\n  }\n  async count(world) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(world);\n    await this.write(this.socket, 4, request.data);\n    const reply = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, reply, 0, 2);\n    const count = reply.g2();\n    this.disconnect();\n    return count;\n  }\n  async heartbeat(players) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 2 + players.length * 8));\n    request.p2(Environment_default.WORLD_ID);\n    request.p2(players.length);\n    for (const player of players) {\n      request.p8(player);\n    }\n    await this.write(this.socket, 5, request.data);\n    this.disconnect();\n  }\n}\n\n// src/lostcity/server/LoginThread.ts\nself.onmessage = async (msg) => {\n  try {\n    switch (msg.data.type) {\n      case \"reset\": {\n        break;\n      }\n      case \"heartbeat\": {\n        break;\n      }\n      case \"loginreq\": {\n        const { opcode, data, socket } = msg.data;\n        const stream = new Packet(data);\n        const revision = stream.g1();\n        if (revision !== 225) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.SERVER_UPDATED,\n            socket\n          });\n          return;\n        }\n        const info = stream.g1();\n        const crcs = new Uint8Array(9 * 4);\n        stream.gdata(crcs, 0, crcs.length);\n        const enc = new Uint8Array(stream.g1());\n        stream.gdata(enc, 0, enc.length);\n        stream.pos = 0;\n        stream.pdata(enc, 0, enc.length);\n        stream.pos = 0;\n        if (stream.g1() !== 10) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.LOGIN_REJECTED,\n            socket\n          });\n          return;\n        }\n        const seed = [];\n        for (let i = 0;i < 4; i++) {\n          seed[i] = stream.g4();\n        }\n        const uid = stream.g4();\n        const username = stream.gjstr();\n        const password = stream.gjstr();\n        if (username.length < 1 || username.length > 12) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.INVALID_USER_OR_PASS,\n            socket\n          });\n          return;\n        }\n        const save = new Uint8Array;\n        self.postMessage({\n          type: \"loginreply\",\n          status: LoginResponse.SUCCESSFUL,\n          socket,\n          info,\n          seed,\n          username: toSafeName(username),\n          save\n        });\n        break;\n      }\n      case \"logout\": {\n        const { username, save } = msg.data;\n        if (Environment_default.LOGIN_KEY) {\n          const login = new LoginClient;\n          const reply = await login.save(toBase37(username), save);\n          if (reply === 0) {\n            self.postMessage({\n              type: \"logoutreply\",\n              username\n            });\n          }\n        } else {\n          self.postMessage({\n            type: \"logoutreply\",\n            username\n          });\n        }\n        break;\n      }\n      default:\n        console.error(\"Unknown message type: \" + msg.data.type);\n        break;\n    }\n  } catch (err) {\n    console.error(err);\n  }\n};\n";class Login{loginThread=createWorker(LoginThreadWorker);loginRequests=new Map;logoutRequests=new Set;constructor(){this.loginThread.onmessage=e=>{try{this.onMessage(e)}catch(e){console.error("Login Thread:",e)}}}async readIn(e,t){const i=t.g1();if(16===i){const n=t.g1();if(t.available<n)return void e.terminate();const r=new Uint8Array(n);t.gdata(r,0,r.length),t.pos-=r.length;if(225!==t.g1())return void e.writeImmediate(LoginResponse.SERVER_UPDATED);t.pos+=1;const a=new Uint8Array(36);t.gdata(a,0,a.length),Packet.checkcrc(a,0,a.length,CrcBuffer32),this.loginThread.postMessage({type:"loginreq",opcode:i,data:r,socket:e.uniqueId}),this.loginRequests.set(e.uniqueId,e)}else e.terminate()}logout(e){this.logoutRequests.has(e.username37)||this.loginThread.postMessage({type:"logout",username:e.username})}onMessage(e){switch(e.data.type){case"loginreply":{const{status:t,socket:i}=e.data,n=this.loginRequests.get(i);if(!n)return;if(this.loginRequests.delete(i),2!==t[0])return n.writeImmediate(t),void n.close();const{info:r,seed:a,username:s,save:o}=e.data;if(World_default.getTotalPlayers()>=2e3)return n.writeImmediate(LoginResponse.WORLD_FULL),void n.close();if(World_default.shutdownTick>-1&&World_default.currentTick-World_default.shutdownTick>0)return n.writeImmediate(LoginResponse.SERVER_UPDATING),void n.close();if(Environment_default.LOCAL_DEV)for(const e of World_default.players)if(e.username===s)return n.writeImmediate(LoginResponse.LOGGED_IN),void n.close();n.decryptor=new Isaac(a);for(let e=0;e<4;e++)a[e]+=50;n.encryptor=new Isaac(a);const c=PlayerLoading.load(s,new Packet(o),n);c.lowMemory=!!(1&r),World_default.addPlayer(c);break}case"logoutreply":{const{username:t}=e.data,i=World_default.getPlayerByUsername(t);i&&(World_default.getZone(i.x,i.z,i.level).leave(i),World_default.players.remove(i.pid),i.pid=-1,i.terminate(),this.logoutRequests.delete(i.username37));break}default:throw new Error("Unknown message type: "+e.data.type)}}}var Login_default=new Login;class EntityList{entities;free;indexPadding;ids;lastUsedIndex=0;constructor(e,t){this.entities=new Array(e).fill(null),this.ids=new Int32Array(e).fill(-1),this.free=new Set(Array.from({length:e},((e,t)=>t))),this.indexPadding=t}next(e=!1,t=this.lastUsedIndex+1){const i=this.ids.length;for(let e=t;e<i;e++)if(-1===this.ids[e])return e;for(let e=this.indexPadding;e<t;e++)if(-1===this.ids[e])return e;throw new Error("[EntityList] cannot find next id")}*[Symbol.iterator](){for(const e of this.ids){if(-1===e)continue;const t=this.entities[e];t&&(yield t)}}get count(){let e=0;for(const t of this[Symbol.iterator]())e++;return e}get(e){const t=this.ids[e];return-1!==t?this.entities[t]:null}set(e,t){if(!this.free.size)throw new Error("[EntityList] cannot find available entities slot.");const i=this.free.values().next().value;this.free.delete(i),this.ids[e]=i,this.entities[i]=t,this.lastUsedIndex=e}remove(e){const t=this.ids[e];-1!==t&&(this.entities[t]=null,this.ids[e]=-1,this.free.add(t))}reset(){this.entities.fill(null),this.ids.fill(-1),this.free.clear();for(let e=0;e<this.ids.length;e++)this.free.add(e)}}class NpcList extends EntityList{constructor(e){super(e,0)}}class PlayerList extends EntityList{constructor(e){super(e,1)}next(e=!1,t=this.lastUsedIndex+1){if(e){for(let e=0===t?1:0;e<100;e++){const i=t+e;if(-1===this.ids[i])return i}}return super.next()}}class UpdateRebootTimer extends OutgoingMessage{ticks;priority=ServerProtPriority.LOW;constructor(e){super(),this.ticks=e}}class World35{id=Environment_default.WORLD_ID;members=Environment_default.MEMBERS_WORLD;currentTick=0;tickRate=600;shutdownTick=-1;allLastModified=0;datLastModified=new Map;lastCycleStats=[];lastCycleBandwidth=[0,0];gameMap=new GameMap;zoneMap=new ZoneMap2;invs=[];vars=new Int32Array;varsString=[];newPlayers=[];players=new PlayerList(2048);npcs=new NpcList(8192);zonesTracking=new Map;queue=new LinkList;shouldReload(e,t=!1){return!0}async reload(){let e=!1;if(this.shouldReload("varp",!0)&&(VarPlayerType.load("data/pack"),e=!0),this.shouldReload("param")&&ParamType.load("data/pack"),this.shouldReload("obj",!0)&&(ObjType.load("data/pack",this.members),e=!0),this.shouldReload("loc",!0)&&(LocType.load("data/pack"),e=!0),this.shouldReload("npc",!0)&&(NpcType.load("data/pack"),e=!0),this.shouldReload("idk",!0)&&(IdkType.load("data/pack"),e=!0),this.shouldReload("frame_del")&&SeqFrame.load("data/pack"),this.shouldReload("seq",!0)&&(SeqType.load("data/pack"),e=!0),this.shouldReload("spotanim",!0)&&(SpotanimType.load("data/pack"),e=!0),this.shouldReload("category")&&CategoryType.load("data/pack"),this.shouldReload("enum")&&EnumType.load("data/pack"),this.shouldReload("struct")&&StructType.load("data/pack"),this.shouldReload("inv")){InvType.load("data/pack");for(let e=0;e<InvType.count;e++){const t=InvType.get(e);t&&t.scope===InvType.SCOPE_SHARED&&(this.invs[e]=Inventory.fromType(e))}}if(this.shouldReload("mesanim")&&MesanimType.load("data/pack"),this.shouldReload("dbtable")&&DbTableType.load("data/pack"),this.shouldReload("dbrow")&&DbRowType.load("data/pack"),this.shouldReload("hunt")&&HuntType.load("data/pack"),this.shouldReload("varn")&&VarNpcType.load("data/pack"),this.shouldReload("vars")&&(VarSharedType.load("data/pack"),this.vars.length!==VarSharedType.count)){const e=this.vars;this.vars=new Int32Array(VarSharedType.count);for(let t=0;t<VarSharedType.count&&t<e.length;t++)this.vars[t]=e[t];const t=this.varsString;this.varsString=new Array(VarSharedType.count);for(let i=0;i<VarSharedType.count&&i<e.length;i++)this.varsString[i]=t[i]}if(this.shouldReload("interface")&&(Component.load("data/pack"),e=!0),this.shouldReload("script")){const e=await ScriptProvider.load("data/pack");-1===e?this.broadcastMes("There was an issue while reloading scripts."):this.broadcastMes(`Reloaded ${e} scripts.`)}makeCrcs(),preloadClient()}broadcastMes(e){for(const t of this.players)t.messageGame(e)}async start(e=!1,t=!0){console.log("Starting world..."),await Bzip.load(await(await fetch("bz2.wasm")).arrayBuffer()),await FontType.load("data/pack"),await WordEnc2.load("data/pack"),await this.reload(),e||await this.gameMap.init(this.zoneMap),Login_default.loginThread.postMessage({type:"reset"}),80===Environment_default.WEB_PORT?console.log(kleur_default.green().bold("World ready")+kleur_default.white().bold(": http://"+Environment_default.PUBLIC_IP)):console.log(kleur_default.green().bold("World ready")+kleur_default.white().bold(": http://"+Environment_default.PUBLIC_IP+":"+Environment_default.WEB_PORT)),t&&await this.cycle()}rebootTimer(e){this.shutdownTick=this.currentTick+e;for(const e of this.players)e.write(new UpdateRebootTimer(this.shutdownTick-this.currentTick))}async cycle(e=!0){const t=Date.now();let i=Date.now();for(let e=this.queue.head();null!==e;e=this.queue.next()){if(e.delay-- >0)continue;const t=e.script;try{const i=ScriptRunner2.execute(t);e.unlink(),i===ScriptState.SUSPENDED?t.activePlayer.activeScript=t:i===ScriptState.NPC_SUSPENDED?t.activeNpc.activeScript=t:i===ScriptState.WORLD_SUSPENDED&&this.enqueueScript(t,t.popInt())}catch(e){console.error(e)}}if(this.currentTick%500==0)for(const e of this.players)e.afkEventReady=Math.random()<(e.zonesAfk()?.1666:.0833);for(const e of this.npcs)e.updateLifeCycle(this.currentTick)&&(e.lifecycle===EntityLifeCycle_default.RESPAWN?this.addNpc(e,-1):e.lifecycle===EntityLifeCycle_default.DESPAWN&&this.removeNpc(e,-1));for(const e of this.npcs)e.checkLifeCycle(this.currentTick)&&!e.delayed()&&-1!==e.huntMode&&e.huntAll();i=Date.now()-i,this.lastCycleBandwidth[0]=0;let n=Date.now();for(const e of this.players)if(isNetworkPlayer(e))try{e.decodeIn()}catch(t){console.error(t),await this.removePlayer(e)}n=Date.now()-n;for(const e of this.players)if(isNetworkPlayer(e)){if(e.userPath.length>0||e.opcalled){if(e.delayed()){e.unsetMapFlag();continue}if((!e.target||e.target instanceof Loc||e.target instanceof Obj)&&-1!==e.faceEntity&&(e.faceEntity=-1,e.mask|=Player2.FACE_ENTITY),e.opcalled&&(0===e.userPath.length||!Environment_default.CLIENT_PATHFINDER)){e.pathToTarget();continue}e.pathToMoveClick(e.userPath,!Environment_default.CLIENT_PATHFINDER)}e.target instanceof Player2&&(e.targetOp===ServerTriggerType_default.APPLAYER3||e.targetOp===ServerTriggerType_default.OPPLAYER3)&&(Position.distanceToSW(e,e.target)<=25?e.pathToPathingTarget():e.clearWaypoints())}let r=Date.now();for(const e of this.npcs)if(e.checkLifeCycle(this.currentTick))try{if(e.delayed()&&e.delay--,e.delayed())continue;if(e.activeScript&&e.executeScript(e.activeScript),!e.checkLifeCycle(this.currentTick))continue;e.processTimers(),e.processQueue(),e.processNpcModes(),e.validateDistanceWalked()}catch(t){console.error(t),this.removeNpc(e,-1)}r=Date.now()-r;let a=Date.now();for(const e of this.players)try{e.playtime++,e.delayed()&&e.delay--,e.activeScript&&!e.delayed()&&e.activeScript.execution===ScriptState.SUSPENDED&&e.executeScript(e.activeScript,!0),e.processQueues(),e.processTimers(0),e.processTimers(1),e.processEngineQueue(),e.processInteraction(),e.mask&Player2.EXACT_MOVE||e.validateDistanceWalked(),this.shutdownTick<this.currentTick&&!Environment_default.NO_SOCKET_TIMEOUT&&this.currentTick-e.lastResponse>=75&&(e.logoutRequested=!0),e.logoutRequested&&e.closeModal()}catch(t){console.error(t),await this.removePlayer(e)}a=Date.now()-a;let s=Date.now();for(const e of this.players)if(!Environment_default.NO_SOCKET_TIMEOUT&&this.currentTick-e.lastResponse>=100&&(e.queue.clear(),e.weakQueue.clear(),e.engineQueue.clear(),e.clearInteraction(),e.closeModal(),e.unsetMapFlag(),e.logoutRequested=!0,e.setVar(VarPlayerType.LASTCOMBAT,0)),e.logoutRequested)if(null===e.queue.head()){const t=ScriptProvider.getByTriggerSpecific(ServerTriggerType_default.LOGOUT,-1,-1);if(!t){console.error("LOGOUT TRIGGER IS BROKEN!");continue}const i=ScriptRunner2.init(t,e);i.pointerAdd(ScriptPointer_default.ProtectedActivePlayer),ScriptRunner2.execute(i);0===i.popInt()&&(e.logoutRequested=!1),e.logoutRequested&&await this.removePlayer(e)}else e.messageGame("[DEBUG]: Waiting for queue to empty before logging out.");s=Date.now()-s;let o=Date.now();for(let e=0;e<this.newPlayers.length;e++){const t=this.newPlayers[e];let i;this.newPlayers.splice(e--,1);try{i=this.getNextPid(isNetworkPlayer(t)?t.client:null)}catch(e){t instanceof NetworkPlayer2&&t.client&&(t.client.send(LoginResponse.WORLD_FULL),t.client.close());continue}this.players.set(i,t),t.pid=i,t.uid=(Number(0x1fffffn&t.username37)<<11|t.pid)>>>0,t.tele=!0,this.getZone(t.x,t.z,t.level).enter(t),Environment_default.CLIRUNNER||t.onLogin(),this.shutdownTick>-1&&t.write(new UpdateRebootTimer(this.shutdownTick-this.currentTick)),t instanceof NetworkPlayer2&&t.client&&(t.client.state=1,t.staffModLevel>=2?t.client.send(LoginResponse.STAFF_MOD_LEVEL):t.client.send(LoginResponse.SUCCESSFUL))}o=Date.now()-o;let c=Date.now();for(const e of Array.from(this.zonesTracking.get(this.currentTick)??[]))e.tick(this.currentTick);this.computeSharedEvents(),c=Date.now()-c;for(const e of this.players)e.convertMovementDir();for(const e of this.npcs)e.convertMovementDir();this.lastCycleBandwidth[1]=0;let l=Date.now();for(const e of this.players)if(isNetworkPlayer(e))try{e.updateMap(),e.updatePlayers(),e.updateNpcs(),e.updateZones(),e.updateInvs(),e.updateStats(),e.updateAfkZones(),e.encodeOut()}catch(t){console.error(t),await this.removePlayer(e)}l=Date.now()-l;let d=Date.now();for(const e of Array.from(this.zonesTracking.get(this.currentTick)??[]))e.reset();this.zonesTracking.delete(this.currentTick);for(const e of this.players){e.resetEntity(!1);for(const t of e.invs.values())t&&(t.update=!1)}for(const e of this.npcs)e.checkLifeCycle(this.currentTick)&&e.resetEntity(!1);for(let e=0;e<this.invs.length;e++){const t=this.invs[e];if(!t)continue;t.update=!1;const i=InvType.get(t.type);if(i.restock&&i.stockcount&&i.stockrate)for(let e=0;e<t.items.length;e++){const n=t.items[e];n&&(n.count<i.stockcount[e]&&this.currentTick%i.stockrate[e]==0?(t.add(n?.id,1,e,!0,!1,!1),t.update=!0):(n.count>i.stockcount[e]&&this.currentTick%i.stockrate[e]==0||i.allstock&&!i.stockcount[e]&&this.currentTick%100==0)&&(t.remove(n?.id,1,e,!0),t.update=!0))}}if(d=Date.now()-d,this.currentTick%100==0){const e=[];for(const t of this.players)e.push(t.username37);Login_default.loginThread.postMessage({type:"heartbeat",players:e})}if(this.shutdownTick>-1&&this.currentTick>=this.shutdownTick){const e=this.currentTick-this.shutdownTick;if(this.getTotalPlayers()){for(const t of this.players)t.logoutRequested=!0,isNetworkPlayer(t)&&(t.logout(),t.client&&e>2&&t.client.close());if(this.npcs.reset(),e>2&&(this.tickRate>1&&(this.tickRate=1),e>24e3)){for(const e of this.players)await this.removePlayer(e);this.tickRate=600}}else process.exit(0)}this.currentTick%1500==0&&this.currentTick;const p=Date.now();if(this.currentTick++,this.lastCycleStats=[p-t,i,n,r,a,s,o,c,l,d],e){const e=this.tickRate-(p-t);setTimeout(this.cycle.bind(this),e)}}enqueueScript(e,t=0){this.queue.addTail(new EntityQueueState(e,t+1))}getInventory(e){if(-1===e)return null;let t=this.invs.find((t=>t&&t.type==e));return t||(t=Inventory.fromType(e),this.invs.push(t)),t}getZone(e,t,i){return this.zoneMap.zone(e,t,i)}getZoneIndex(e){return this.zoneMap.zoneByIndex(e)}getZoneGrid(e){return this.zoneMap.grid(e)}computeSharedEvents(){const e=new Set;for(const t of this.players)if(isNetworkPlayer(t))for(const i of t.buildArea.loadedZones)e.add(i);for(const t of e)this.getZoneIndex(t).computeShared()}addNpc(e,t){this.npcs.set(e.nid,e),e.x=e.startX,e.z=e.startZ;switch(this.getZone(e.x,e.z,e.level).enter(e),e.blockWalk){case BlockWalk_default.NPC:this.gameMap.changeNpcCollision(e.width,e.x,e.z,e.level,!0);break;case BlockWalk_default.ALL:this.gameMap.changeNpcCollision(e.width,e.x,e.z,e.level,!0),this.gameMap.changePlayerCollision(e.width,e.x,e.z,e.level,!0)}e.resetEntity(!0),e.playAnimation(-1,0),e.setLifeCycle(this.currentTick+t)}removeNpc(e,t){switch(this.getZone(e.x,e.z,e.level).leave(e),e.blockWalk){case BlockWalk_default.NPC:this.gameMap.changeNpcCollision(e.width,e.x,e.z,e.level,!1);break;case BlockWalk_default.ALL:this.gameMap.changeNpcCollision(e.width,e.x,e.z,e.level,!1),this.gameMap.changePlayerCollision(e.width,e.x,e.z,e.level,!1)}e.lifecycle===EntityLifeCycle_default.DESPAWN?this.npcs.remove(e.nid):e.lifecycle===EntityLifeCycle_default.RESPAWN&&e.setLifeCycle(this.currentTick+t)}getLoc(e,t,i,n){return this.getZone(e,t,i).getLoc(e,t,n)}getObj(e,t,i,n,r){return this.getZone(e,t,i).getObj(e,t,n,r)}trackZone(e,t){let i;const n=this.zonesTracking.get(e);i=n||new Set,i.add(t),this.zonesTracking.set(e,i)}addLoc(e,t){const i=LocType.get(e.type);i.blockwalk&&this.gameMap.changeLocCollision(e.shape,e.angle,i.blockrange,i.length,i.width,i.active,e.x,e.z,e.level,!0);const n=this.getZone(e.x,e.z,e.level);n.addLoc(e),e.setLifeCycle(this.currentTick+t),this.trackZone(this.currentTick+t,n),this.trackZone(this.currentTick,n)}mergeLoc(e,t,i,n,r,a,s,o){const c=this.getZone(e.x,e.z,e.level);c.mergeLoc(e,t,i,n,r,a,s,o),this.trackZone(this.currentTick,c)}animLoc(e,t){const i=this.getZone(e.x,e.z,e.level);i.animLoc(e,t),this.trackZone(this.currentTick,i)}removeLoc(e,t){const i=LocType.get(e.type);i.blockwalk&&this.gameMap.changeLocCollision(e.shape,e.angle,i.blockrange,i.length,i.width,i.active,e.x,e.z,e.level,!1);const n=this.getZone(e.x,e.z,e.level);n.removeLoc(e),e.setLifeCycle(this.currentTick+t),this.trackZone(this.currentTick+t,n),this.trackZone(this.currentTick,n)}addObj(e,t,i){const n=ObjType.get(e.type),r=this.getObj(e.x,e.z,e.level,e.type,t);if(r&&r.lifecycle===EntityLifeCycle_default.DESPAWN&&e.lifecycle===EntityLifeCycle_default.DESPAWN){const i=e.count+r.count;if(n.stackable&&i<=Inventory.STACK_LIMIT)return void this.changeObj(r,t,i)}const a=this.getZone(e.x,e.z,e.level);a.addObj(e,t),-1!==t&&n.tradeable?(e.setLifeCycle(this.currentTick+100),this.trackZone(this.currentTick+100,a),this.trackZone(this.currentTick,a),e.receiverId=t,e.reveal=i):(e.setLifeCycle(this.currentTick+i),this.trackZone(this.currentTick+i,a),this.trackZone(this.currentTick,a))}revealObj(e){const t=e.reveal,i=this.getZone(e.x,e.z,e.level);i.revealObj(e,e.receiverId),e.setLifeCycle(this.currentTick+t),this.trackZone(this.currentTick+t,i),this.trackZone(this.currentTick,i)}changeObj(e,t,i){const n=this.getZone(e.x,e.z,e.level);n.changeObj(e,t,e.count,i),this.trackZone(this.currentTick,n)}removeObj(e,t){const i=this.getZone(e.x,e.z,e.level);i.removeObj(e),e.setLifeCycle(this.currentTick+t),this.trackZone(this.currentTick+t,i),this.trackZone(this.currentTick,i)}animMap(e,t,i,n,r,a){const s=this.getZone(t,i,e);s.animMap(t,i,n,r,a),this.trackZone(this.currentTick,s)}mapProjAnim(e,t,i,n,r,a,s,o,c,l,d,p,h){const u=this.getZone(t,i,e);u.mapProjAnim(t,i,n,r,a,s,o,c,l,d,p,h),this.trackZone(this.currentTick,u)}async readIn(e,t){for(;t.available>0;){const i=t.pos;let n=t.g1();if(e.decryptor&&(n=n-e.decryptor.nextInt()&255,t.data[i]=n),void 0===ClientProt.byId[n])return e.state=-1,void e.close();let r=ClientProt.byId[n].length;if(-1===r?r=t.g1():-2===r&&(r=t.g2()),t.available<r)break;if(t.pos+=r,e.inCount[n]++,e.inCount[n]>5)continue;const a=new Uint8Array(t.pos-i),s=t.pos;t.pos=i,t.gdata(a,0,a.length),t.pos=s,e.in.set(a,e.inOffset),e.inOffset+=t.pos-i}}addPlayer(e){this.newPlayers.push(e)}async removePlayer(e){-1!==e.pid&&(e.playerLog("Logging out"),isNetworkPlayer(e)&&(e.logout(),e.client.close(),e.client=null),Login_default.logout(e))}getPlayer(e){return this.players.get(e)}getPlayerByUid(e){const t=2047&e,i=e>>11&2097151,n=this.getPlayer(t);return n?Number(0x1fffffn&n.username37)!==i?null:n:null}getPlayerByUsername(e){const t=toBase37(e);for(const e of this.players)if(e.username37===t)return e;for(const e of this.newPlayers)if(e.username37===t)return e}getTotalPlayers(){return this.players.count}getTotalNpcs(){return this.npcs.count}getNpc(e){return this.npcs.get(e)}getNpcByUid(e){const t=65535&e,i=e>>16&65535,n=this.getNpc(t);return n&&n.type===i?n:null}getNextNid(){return this.npcs.next()}getNextPid(e=null){if(e){const t=e.remoteAddress.split("."),i=parseInt(t[3])%20*100;return this.players.next(!0,i)}return this.players.next()}}var World_default=new World35;class WorkerServer{socket=new ClientSocket;constructor(){}start(){const e=new Packet(new Uint8Array(8));e.p4(Math.floor(4294967295*Math.random())),e.p4(Math.floor(4294967295*Math.random())),this.socket.send(e.data),self.onmessage=async e=>{const t=new Packet(new Uint8Array(e.data));if("message"===e.type)try{1===this.socket.state?await World_default.readIn(this.socket,t):await Login_default.readIn(this.socket,t)}catch(e){this.socket.close()}}}}await(World_default.start());var workerServer=new WorkerServer;workerServer.start();