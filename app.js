t=function(t){if('undefined'!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')},'undefined'!=typeof require?require:'undefined'!=typeof Proxy&&new Proxy(t,{get:(t,e)=>('undefined'!=typeof require?require:t)[e]});var t,e,n,s,i,a=function(t,e){let n,s=0,i='',a='';for(;s<t.length;s++)n=t[s],i+=n.open,a+=n.close,~e.indexOf(n.close)&&(e=e.replace(n.rgx,n.close+n.open));return i+e+a},r=function(t,e){let n={open:`[${t}m`,close:`[${e}m`,rgx:new RegExp(`\\x1b\\[${e}m`,'g')};return function(e){return void 0!==this&&void 0!==this.has?(~this.has.indexOf(t)||(this.has.push(t),this.keys.push(n)),void 0===e?this:c.enabled?a(this.keys,e+''):e+''):void 0===e?function(t,e){let n={has:t,keys:e};return n.reset=c.reset.bind(n),n.bold=c.bold.bind(n),n.dim=c.dim.bind(n),n.italic=c.italic.bind(n),n.underline=c.underline.bind(n),n.inverse=c.inverse.bind(n),n.hidden=c.hidden.bind(n),n.strikethrough=c.strikethrough.bind(n),n.black=c.black.bind(n),n.red=c.red.bind(n),n.green=c.green.bind(n),n.yellow=c.yellow.bind(n),n.blue=c.blue.bind(n),n.magenta=c.magenta.bind(n),n.cyan=c.cyan.bind(n),n.white=c.white.bind(n),n.gray=c.gray.bind(n),n.grey=c.grey.bind(n),n.bgBlack=c.bgBlack.bind(n),n.bgRed=c.bgRed.bind(n),n.bgGreen=c.bgGreen.bind(n),n.bgYellow=c.bgYellow.bind(n),n.bgBlue=c.bgBlue.bind(n),n.bgMagenta=c.bgMagenta.bind(n),n.bgCyan=c.bgCyan.bind(n),n.bgWhite=c.bgWhite.bind(n),n}([t],[n]):c.enabled?a([n],e+''):e+''}},o=!0;'undefined'!=typeof process&&(({FORCE_COLOR:e,NODE_DISABLE_COLORS:n,NO_COLOR:s,TERM:i}=process.env||{}),o=process.stdout&&process.stdout.isTTY);var c={enabled:!n&&null==s&&'dumb'!==i&&(null!=e&&'0'!==e||o),reset:r(0,0),bold:r(1,22),dim:r(2,22),italic:r(3,23),underline:r(4,24),inverse:r(7,27),hidden:r(8,28),strikethrough:r(9,29),black:r(30,39),red:r(31,39),green:r(32,39),yellow:r(33,39),blue:r(34,39),magenta:r(35,39),cyan:r(36,39),white:r(37,39),gray:r(90,39),grey:r(90,39),bgBlack:r(40,49),bgRed:r(41,49),bgGreen:r(42,49),bgYellow:r(43,49),bgBlue:r(44,49),bgMagenta:r(45,49),bgCyan:r(46,49),bgWhite:r(47,49)},l=c;function h(t){t=t.trim();let e=0n;for(let n=0;n<t.length&&n<12;n++){const s=t.charCodeAt(n);e*=37n,s>=65&&s<=90?e+=BigInt(s+1-65):s>=97&&s<=122?e+=BigInt(s+1-97):s>=48&&s<=57&&(e+=BigInt(s+27-48))}return e}function d(t){if(t<0n||t>=6582952005840035281n)return'invalid_name';if(t%37n===0n)return'invalid_name';let e=0;const n=Array(12);for(;0n!==t;){const s=t;t/=37n,n[11-e++]=_[Number(s-37n*t)]}return n.slice(12-e).join('')}function p(t){return e=function(t){return d(h(t))}(t).replaceAll('_',' '),e.replace(/\w\S*/g,(t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()));var e}var _=['_','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','0','1','2','3','4','5','6','7','8','9'];class u{key;next;prev;constructor(){this.key=0n,this.next=this,this.prev=this}unlink(){this.prev&&this.next&&(this.prev.next=this.next,this.next.prev=this.prev,this.next=null,this.prev=null)}}class g{sentinel;cursor=null;constructor(){const t=new u;t.next=t,t.prev=t,this.sentinel=t}addTail(t){t.prev&&t.unlink(),t.prev=this.sentinel.prev,t.next=this.sentinel,t.prev&&(t.prev.next=t),t.next.prev=t}addHead(t){t.prev&&t.unlink(),t.prev=this.sentinel,t.next=this.sentinel.next,t.prev.next=t,t.next&&(t.next.prev=t)}removeHead(){const t=this.sentinel.next;return t===this.sentinel?null:(t?.unlink(),t)}head(){const t=this.sentinel.next;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.next||null,t)}tail(){const t=this.sentinel.prev;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.prev||null,t)}next(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.next||null,t)}prev(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.prev||null,t)}clear(){for(;;){const t=this.sentinel.next;if(t===this.sentinel)return;t?.unlink()}}}class m extends u{nextHashable;prevHashable;constructor(){super(),this.nextHashable=this,this.prevHashable=this}uncache(){this.prevHashable&&this.nextHashable&&(this.prevHashable.nextHashable=this.nextHashable,this.nextHashable.prevHashable=this.prevHashable,this.nextHashable=null,this.prevHashable=null)}}class E extends m{static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static crc32b=3988292384;static{for(let t=0;t<32;t++)this.bitmask[t]=(1<<t)-1;this.bitmask[32]=4294967295;for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1&~e?e>>>=1:e=e>>>1^this.crc32b;this.crctable[t]=e}}static getcrc(t,e,n){let s=4294967295;for(let i=e;i<n;i++)s=s>>>8^this.crctable[255&(s^t[i])];return~s}static checkcrc(t,e,n,s=0){return E.getcrc(t,e,n)==s}static alloc(t){let e=null;return 0===t&&this.cacheMinCount>0?(e=this.cacheMin.removeHead(),this.cacheMinCount--):1===t&&this.cacheMidCount>0?(e=this.cacheMid.removeHead(),this.cacheMidCount--):2===t&&this.cacheMaxCount>0?(e=this.cacheMax.removeHead(),this.cacheMaxCount--):3===t&&this.cacheBigCount>0?(e=this.cacheBig.removeHead(),this.cacheBigCount--):4===t&&this.cacheHugeCount>0?(e=this.cacheHuge.removeHead(),this.cacheHugeCount--):5===t&&this.cacheUnimaginableCount>0&&(e=this.cacheUnimaginable.removeHead(),this.cacheUnimaginableCount--),null!==e?(e.pos=0,e.bitPos=0,e):new E(0===t?new Uint8Array(100):1===t?new Uint8Array(5e3):2===t?new Uint8Array(3e4):3===t?new Uint8Array(1e5):4===t?new Uint8Array(5e5):5===t?new Uint8Array(2e6):new Uint8Array(t))}static async load(t,e=!1){const n=new E(new Uint8Array(await(await fetch(t)).arrayBuffer()));return e&&(n.pos=n.data.length),n}static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static cacheBigCount=0;static cacheHugeCount=0;static cacheUnimaginableCount=0;static cacheMin=new g;static cacheMid=new g;static cacheMax=new g;static cacheBig=new g;static cacheHuge=new g;static cacheUnimaginable=new g;data;#t;pos;bitPos;constructor(t){super(),this.data=t,this.#t=new DataView(this.data.buffer),this.pos=0,this.bitPos=0}get available(){return this.data.length-this.pos}get length(){return this.data.length}release(){this.pos=0,this.bitPos=0,100===this.data.length&&E.cacheMinCount<1e3?(E.cacheMin.addTail(this),E.cacheMinCount++):5e3===this.data.length&&E.cacheMidCount<250?(E.cacheMid.addTail(this),E.cacheMidCount++):3e4===this.data.length&&E.cacheMaxCount<50?(E.cacheMax.addTail(this),E.cacheMaxCount++):1e5===this.data.length&&E.cacheBigCount<10?(E.cacheBig.addTail(this),E.cacheBigCount++):5e5===this.data.length&&E.cacheHugeCount<5?(E.cacheHuge.addTail(this),E.cacheHugeCount++):2e6===this.data.length&&E.cacheUnimaginableCount<2&&(E.cacheUnimaginable.addTail(this),E.cacheUnimaginableCount++)}p1(t){this.#t.setUint8(this.pos++,t)}p2(t){this.#t.setUint16(this.pos,t),this.pos+=2}ip2(t){this.#t.setUint16(this.pos,t,!0),this.pos+=2}p3(t){this.#t.setUint8(this.pos++,t>>16),this.#t.setUint16(this.pos,t),this.pos+=2}p4(t){this.#t.setInt32(this.pos,t),this.pos+=4}ip4(t){this.#t.setInt32(this.pos,t,!0),this.pos+=4}p8(t){this.#t.setBigInt64(this.pos,t),this.pos+=8}pbool(t){this.p1(t?1:0)}pjstr(t,e=10){const n=t.length;for(let e=0;e<n;e++)this.#t.setUint8(this.pos++,t.charCodeAt(e));this.#t.setUint8(this.pos++,e)}pdata(t,e,n){this.data.set(t.subarray(e,e+n),this.pos),this.pos+=n-e}psize4(t){this.#t.setUint32(this.pos-t-4,t)}psize2(t){this.#t.setUint16(this.pos-t-2,t)}psize1(t){this.#t.setUint8(this.pos-t-1,t)}psmarts(t){if(t<64&&t>=64)this.p1(t+64);else{if(!(t<16384&&t>=-16384))throw new Error('Error psmarts out of range: '+t);this.p2(t+49152)}}psmart(t){if(t>=0&&t<128)this.p1(t);else{if(!(t>=0&&t<32768))throw new Error('Error psmart out of range: '+t);this.p2(t+32768)}}g1(){return this.#t.getUint8(this.pos++)}g1b(){return this.#t.getInt8(this.pos++)}g2(){return this.pos+=2,this.#t.getUint16(this.pos-2)}g2s(){return this.pos+=2,this.#t.getInt16(this.pos-2)}ig2(){return this.pos+=2,this.#t.getUint16(this.pos-2,!0)}g3(){const t=this.#t.getUint8(this.pos++)<<16|this.#t.getUint16(this.pos);return this.pos+=2,t}g4(){return this.pos+=4,this.#t.getInt32(this.pos-4)}ig4(){return this.pos+=4,this.#t.getInt32(this.pos-4,!0)}g8(){return this.pos+=8,this.#t.getBigInt64(this.pos-8)}gbool(){return 1===this.g1()}gjstr(t=10){const e=this.data.length;let n,s='';for(;(n=this.#t.getUint8(this.pos++))!==t&&this.pos<e;)s+=String.fromCharCode(n);return s}gdata(t,e,n){t.set(this.data.subarray(this.pos,this.pos+n),e),this.pos+=n}gsmarts(){return this.#t.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmart(){return this.#t.getUint8(this.pos)<128?this.g1():this.g2()-32768}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(t){let e=this.bitPos>>>3,n=8-(7&this.bitPos),s=0;for(this.bitPos+=t;t>n;n=8)s+=(this.#t.getUint8(e++)&E.bitmask[n])<<t-n,t-=n;return s+=t==n?this.#t.getUint8(e)&E.bitmask[n]:this.#t.getUint8(e)>>>n-t&E.bitmask[t],s}pBit(t,e){const n=this.bitPos;this.bitPos+=t;let s=n>>>3,i=8-(7&n);const a=this.#t;for(;t>i;i=8){const n=(1<<i)-1,r=a.getUint8(s);a.setUint8(s++,r&~n|e>>>t-i&n),t-=i}const r=i-t,o=(1<<t)-1,c=a.getUint8(s);a.setUint8(s,c&~o<<r|(e&o)<<r)}}class O{id;debugname=null;constructor(t){this.id=t}decodeType(t){for(;t.available>0;){const e=t.g1();if(0===e)break;this.decode(e,t)}}}class f extends O{static configNames=new Map;static configs=[];static async load(t){if(f.configNames=new Map,f.configs=[],!(await fetch(`${t}/server/category.dat`)).ok)return void console.log('Warning: No category.dat found.');const e=await E.load(`${t}/server/category.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new f(t);n.decodeType(e),f.configs[t]=n,n.debugname&&f.configNames.set(n.debugname,t)}}static get(t){return f.configs[t]}static getId(t){return f.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}decode(t,e){this.debugname=e.gjstr()}toString(){return this.debugname??`category_${this.id}`}}class A{static INT=105;static AUTOINT=255;static STRING=115;static ENUM=103;static OBJ=111;static LOC=108;static COMPONENT=73;static NAMEDOBJ=79;static STRUCT=74;static BOOLEAN=49;static COORD=99;static CATEGORY=121;static SPOTANIM=116;static NPC=110;static INV=118;static SYNTH=80;static SEQ=65;static STAT=83;static VARP=86;static PLAYER_UID=112;static NPC_UID=78;static INTERFACE=97;static NPC_STAT=254;static IDKIT=75;static getType(t){switch(t){case A.INT:return'int';case A.STRING:return'string';case A.ENUM:return'enum';case A.OBJ:return'obj';case A.LOC:return'loc';case A.COMPONENT:return'component';case A.NAMEDOBJ:return'namedobj';case A.STRUCT:return'struct';case A.BOOLEAN:return'boolean';case A.COORD:return'coord';case A.CATEGORY:return'category';case A.SPOTANIM:return'spotanim';case A.NPC:return'npc';case A.INV:return'inv';case A.SYNTH:return'synth';case A.SEQ:return'seq';case A.STAT:return'stat';case A.AUTOINT:return'autoint';case A.VARP:return'varp';case A.PLAYER_UID:return'player_uid';case A.NPC_UID:return'npc_uid';case A.INTERFACE:return'interface';case A.NPC_STAT:return'npc_stat';case A.IDKIT:return'idkit';default:return'unknown'}}static getTypeChar(t){let e='i';switch(t){case'int':e='i';break;case'autoint':e='ÿ';break;case'string':e='s';break;case'enum':e='g';break;case'obj':e='o';break;case'loc':e='l';break;case'component':e='I';break;case'namedobj':e='O';break;case'struct':e='J';break;case'boolean':e='1';break;case'coord':e='c';break;case'category':e='y';break;case'spotanim':e='t';break;case'npc':e='n';break;case'inv':e='v';break;case'synth':e='P';break;case'seq':e='A';break;case'stat':e='S';break;case'varp':e='V';break;case'player_uid':e='p';break;case'npc_uid':e='N';break;case'interface':e='a';break;case'npc_stat':e='þ';break;case'idkit':e='K';break;default:return null}return e.charCodeAt(0)}static getDefault(t){return t===A.STRING?'':t===A.BOOLEAN?0:-1}}class T extends O{static configNames=new Map;static configs=[];static async load(t){if(T.configNames=new Map,T.configs=[],!(await fetch(`${t}/server/dbtable.dat`)).ok)return void console.log('Warning: No dbtable.dat found.');const e=await E.load(`${t}/server/dbtable.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new T(t);n.decodeType(e),T.configs[t]=n,n.debugname&&T.configNames.set(n.debugname,t)}}static get(t){return T.configs[t]}static getId(t){return T.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}types=[];defaultValues=[];columnNames=[];decode(t,e){if(1===t){this.types=new Array(e.g1());for(let t=e.g1();255!=t;t=e.g1()){const n=127&t,s=!!(128&t),i=new Array(e.g1());for(let t=0;t<i.length;t++)i[t]=e.g1();this.types[n]=i,s&&(this.defaultValues||(this.defaultValues=new Array(this.types.length)),this.defaultValues[n]=this.decodeValues(e,n))}}else if(250===t)this.debugname=e.gjstr();else{if(251!==t)throw new Error(`Unrecognized dbtable config code: ${t}`);this.columnNames=new Array(e.g1());for(let t=0;t<this.columnNames.length;t++)this.columnNames[t]=e.gjstr()}}getDefault(t){if(!this.defaultValues[t]){const e=[];for(let n=0;n<this.types[t].length;n++)e[n]=A.getDefault(this.types[t][n]);return e}return this.defaultValues[t]}decodeValues(t,e){const n=this.types[e],s=t.g1(),i=new Array(s*n.length);for(let e=0;e<s;e++)for(let s=0;s<n.length;s++){const a=n[s],r=s+e*n.length;a===A.STRING?i[r]=t.gjstr():i[r]=t.g4()}return i}}class I extends O{static configNames=new Map;static configs=[];static async load(t){if(I.configNames=new Map,I.configs=[],!(await fetch(`${t}/server/dbrow.dat`)).ok)return void console.log('Warning: No dbrow.dat found.');const e=await E.load(`${t}/server/dbrow.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new I(t);n.decodeType(e),I.configs[t]=n,n.debugname&&I.configNames.set(n.debugname,t)}}static get(t){return I.configs[t]}static getId(t){return I.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}static getInTable(t){return I.configs.filter((e=>e.tableId===t))}tableId=0;types=[];columnValues=[];decode(t,e){if(3===t){const t=e.g1();this.types=new Array(t),this.columnValues=new Array(t);for(let t=e.g1();255!=t;t=e.g1()){const n=new Array(e.g1());for(let t=0;t<n.length;t++)n[t]=e.g1();this.types[t]=n,this.columnValues[t]=this.decodeValues(e,t)}}else if(4===t)this.tableId=e.g2();else{if(250!==t)throw new Error(`Unrecognized dbtable config code: ${t}`);this.debugname=e.gjstr()}}getValue(t,e){const n=this.columnValues[t].slice(e*this.types[t].length,(e+1)*this.types[t].length);return n.length?n:T.get(this.tableId).getDefault(t)}decodeValues(t,e){const n=this.types[e],s=t.g1(),i=new Array(s*n.length);for(let e=0;e<s;e++)for(let s=0;s<n.length;s++){const a=n[s],r=s+e*n.length;a===A.STRING?i[r]=t.gjstr():i[r]=t.g4()}return i}}class N extends O{static configNames=new Map;static configs=[];static async load(t){if(N.configNames=new Map,N.configs=[],!(await fetch(`${t}/server/enum.dat`)).ok)return void console.log('Warning: No enum.dat found.');const e=await E.load(`${t}/server/enum.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new N(t);n.decodeType(e),N.configs[t]=n,n.debugname&&N.configNames.set(n.debugname,t)}}static get(t){return N.configs[t]}static getId(t){return N.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}inputtype=A.INT;outputtype=A.INT;defaultInt=0;defaultString='null';values=new Map;decode(t,e){if(1===t)this.inputtype=e.g1();else if(2===t)this.outputtype=e.g1();else if(3===t)this.defaultString=e.gjstr();else if(4===t)this.defaultInt=e.g4();else if(5===t){const t=e.g2();for(let n=0;n<t;n++)this.values.set(e.g4(),e.gjstr())}else if(6===t){const t=e.g2();for(let n=0;n<t;n++)this.values.set(e.g4(),e.g4())}else{if(250!==t)throw new Error(`Unrecognized enum config code: ${t}`);this.debugname=e.gjstr()}}}async function P(t,e={}){const n={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,n,s){t=r(t>>>0),e=r(e>>>0),n>>>=0,s>>>=0,(()=>{throw Error(`${t} in ${e}:${n}:${s}`)})()}})},{exports:s}=await WebAssembly.instantiate(t,n),i=s.memory||e.env.memory,a=Object.setPrototypeOf({read:(t,e,n,a)=>(e=function(t,e,n,a,r){if(null==a)return 0;const o=a.length,c=s.__pin(s.__new(o<<n,e))>>>0;if(r)new r(i.buffer,c,o).set(a);else for(let e=0;e<o;e++)t(c+(e<<n>>>0),a[e]);return s.__unpin(c),c}(c,6,0,e,Int8Array)||function(){throw TypeError('value must not be null')}(),function(t,e,n){if(!n)return null;const s=function(t){try{return o.getUint32(t,!0)}catch{return o=new DataView(i.buffer),o.getUint32(t,!0)}}(n-4)>>>e,a=new Array(s);for(let i=0;i<s;++i)a[i]=t(n+(i<<e>>>0));return a}(l,0,s.read(t,e,n,a)>>>0))},s);function r(t){if(!t)return null;const e=t+new Uint32Array(i.buffer)[t-4>>>2]>>>1,n=new Uint16Array(i.buffer);let s=t>>>1,a='';for(;e-s>1024;)a+=String.fromCharCode(...n.subarray(s,s+=1024));return a+String.fromCharCode(...n.subarray(s,e))}let o=new DataView(i.buffer);function c(t,e){try{o.setUint8(t,e,!0)}catch{o=new DataView(i.buffer),o.setUint8(t,e,!0)}}function l(t){try{return o.getInt8(t,!0)}catch{return o=new DataView(i.buffer),o.getInt8(t,!0)}}return a}class L{static bz2=null;static load=async t=>{this.bz2=await P(new WebAssembly.Module(t),{env:void 0})};static read=(t,e,n,s)=>{if(!this.bz2)throw new Error('bz2 not found!!');return Int8Array.from(this.bz2.read(t,e,n,s))}}function S(t){let e=0;t=t.toUpperCase();for(let n=0;n<t.length;n++)e=61*e+t.charCodeAt(n)-32|0;return e}class C{data=null;fileCount=0;fileHash=[];fileName=[];fileUnpackedSize=[];filePackedSize=[];filePos=[];unpacked=!1;fileQueue=[];fileWrite=[];static async load(t){return new C(await E.load(t))}constructor(t){if(!t)return;const e=t.g3(),n=t.g3();e===n?(this.data=new Uint8Array(t.data),this.unpacked=!1):(this.data=new Uint8Array(L.read(e,t.data,n,6)),t=new E(this.data),this.unpacked=!0),this.fileCount=t.g2();let s=t.pos+10*this.fileCount;for(let e=0;e<this.fileCount;e++){this.fileHash[e]=t.g4();const n=R.findIndex((t=>t===this.fileHash[e]));-1!==n&&(this.fileName[e]=w[n]),this.fileUnpackedSize[e]=t.g3(),this.filePackedSize[e]=t.g3(),this.filePos[e]=s,s+=this.filePackedSize[e]}}get(t){if(t<0||t>=this.fileCount)return null;if(null===this.data)throw new Error('Jagfile data is not loaded');const e=this.data.subarray(this.filePos[t],this.filePos[t]+this.filePackedSize[t]);return this.unpacked?new E(e):new E(Uint8Array.from(L.read(this.fileUnpackedSize[t],this.data,this.filePackedSize[t],this.filePos[t])))}read(t){const e=S(t);for(let t=0;t<this.fileCount;t++)if(this.fileHash[t]===e)return this.get(t);return null}write(t,e){const n=S(t);this.fileQueue.push({hash:n,name:t,write:!0,data:e.data.subarray(0,e.pos)})}delete(t){const e=S(t);this.fileQueue.push({hash:e,name:t,delete:!0})}rename(t,e){const n=S(t),s=S(e);this.fileQueue.push({hash:n,name:t,rename:!0,newName:e,newHash:s})}save(t,e=!1){let n=E.alloc(5);for(let t=0;t<this.fileQueue.length;t++){const e=this.fileQueue[t];let n=this.fileHash.findIndex((t=>t===e.hash));if(e.write){if(-1===n&&(n=this.fileCount++,this.fileHash[n]=e.hash,this.fileName[n]=e.name),!e.data)throw new Error('Cannot write without data');this.fileUnpackedSize[n]=e.data.length,this.filePackedSize[n]=e.data.length,this.filePos[n]=-1,this.fileWrite[n]=e.data}if(e.delete&&-1!==n&&(this.fileHash.splice(n,1),this.fileName.splice(n,1),this.fileUnpackedSize.splice(n,1),this.filePackedSize.splice(n,1),this.filePos.splice(n,1),this.fileCount--),e.rename&&-1!==n){if(!e.newHash)throw new Error('Cannot rename without newHash');if(!e.newName)throw new Error('Cannot rename without newName');this.fileHash[n]=e.newHash,this.fileName[n]=e.newName}this.fileQueue.splice(t,1),t--}let s=1===this.fileCount;e&&s&&(s=!1),n.p2(this.fileCount);for(let t=0;t<this.fileCount;t++)n.p4(this.fileHash[t]),n.p3(this.fileUnpackedSize[t]),this.fileWrite[t]&&!s&&(this.fileWrite[t]=BZip2.compress(this.fileWrite[t],!1,!0),this.filePackedSize[t]=this.fileWrite[t].length),n.p3(this.filePackedSize[t]);for(let t=0;t<this.fileCount;t++){const e=this.fileWrite[t];n.pdata(e,0,e.length)}const i=E.alloc(5);i.p3(n.pos),s&&(n=new E(BZip2.compress(n.data,!1,!0))),s?(i.p3(n.data.length),i.pdata(n.data,0,n.data.length)):(i.p3(n.pos),i.pdata(n.data,0,n.pos)),i.save(t),n.release(),i.release()}deconstruct(t){const e=this.read(t+'.dat'),n=this.read(t+'.idx');if(null===e||null===n)throw new Error('Failed to read dat or idx');const s=n.g2(),i=new Array(s),a=new Array(s);let r=2;for(let t=0;t<s;t++)i[t]=n.g2(),a[t]=r,r+=i[t];const o=new Array(s);for(let t=0;t<s;t++)e.pos=a[t],o[t]=E.getcrc(e.data,r,i[t]);return{count:s,sizes:i,offsets:a,checksums:o}}}var y,v,w=['index.dat','logo.dat','p11.dat','p12.dat','b12.dat','q8.dat','runes.dat','title.dat','titlebox.dat','titlebutton.dat','p11_full.dat','p12_full.dat','b12_full.dat','q8_full.dat','flo.dat','flo.idx','idk.dat','idk.idx','loc.dat','loc.idx','npc.dat','npc.idx','obj.dat','obj.idx','seq.dat','seq.idx','spotanim.dat','spotanim.idx','varp.dat','varp.idx','varbit.dat','varbit.idx','mesanim.dat','mesanim.idx','mes.dat','mes.idx','param.dat','param.idx','hunt.dat','hunt.idx','data','backbase1.dat','backbase2.dat','backhmid1.dat','backhmid2.dat','backleft1.dat','backleft2.dat','backright1.dat','backright2.dat','backtop1.dat','backtop2.dat','backvmid1.dat','backvmid2.dat','backvmid3.dat','chatback.dat','combatboxes.dat','combaticons.dat','combaticons2.dat','combaticons3.dat','compass.dat','cross.dat','gnomeball_buttons.dat','headicons.dat','hitmarks.dat','invback.dat','leftarrow.dat','magicoff.dat','magicoff2.dat','magicon.dat','magicon2.dat','mapback.dat','mapdots.dat','mapflag.dat','mapfunction.dat','mapscene.dat','miscgraphics.dat','miscgraphics2.dat','miscgraphics3.dat','prayerglow.dat','prayeroff.dat','prayeron.dat','redstone1.dat','redstone2.dat','redstone3.dat','rightarrow.dat','scrollbar.dat','sideicons.dat','staticons.dat','staticons2.dat','steelborder.dat','steelborder2.dat','sworddecor.dat','tradebacking.dat','wornicons.dat','mapmarker.dat','mod_icons.dat','mapedge.dat','blackmark.dat','button_brown.dat','button_brown_big.dat','button_red.dat','chest.dat','coins.dat','headicons_hint.dat','headicons_pk.dat','headicons_prayer.dat','key.dat','keys.dat','leftarrow_small.dat','letter.dat','number_button.dat','overlay_duel.dat','overlay_multiway.dat','pen.dat','rightarrow_small.dat','startgame.dat','tex_brown.dat','tex_red.dat','titlescroll.dat','base_head.dat','base_label.dat','base_type.dat','frame_del.dat','frame_head.dat','frame_tran1.dat','frame_tran2.dat','ob_axis.dat','ob_face1.dat','ob_face2.dat','ob_face3.dat','ob_face4.dat','ob_face5.dat','ob_head.dat','ob_point1.dat','ob_point2.dat','ob_point3.dat','ob_point4.dat','ob_point5.dat','ob_vertex1.dat','ob_vertex2.dat','anim_crc','anim_index','anim_version','map_crc','map_index','map_version','midi_crc','midi_index','midi_version','model_crc','model_index','model_version','0.dat','1.dat','2.dat','3.dat','4.dat','5.dat','6.dat','7.dat','8.dat','9.dat','10.dat','11.dat','12.dat','13.dat','14.dat','15.dat','16.dat','17.dat','18.dat','19.dat','20.dat','21.dat','22.dat','23.dat','24.dat','25.dat','26.dat','27.dat','28.dat','29.dat','30.dat','31.dat','32.dat','33.dat','34.dat','35.dat','36.dat','37.dat','38.dat','39.dat','40.dat','41.dat','42.dat','43.dat','44.dat','45.dat','46.dat','47.dat','48.dat','49.dat','badenc.txt','domainenc.txt','fragmentsenc.txt','tldlist.txt','sounds.dat','labels.dat','floorcol.dat','underlay.dat','overlay.dat','size.dat'],R=[];for(let t=0;t<w.length;t++)R[t]=S(w[t]);class b{static CHAR_LOOKUP=[];static instances=[];static{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| ";for(let e=0;e<256;e++){let n=t.indexOf(String.fromCharCode(e));-1==n&&(n=74),b.CHAR_LOOKUP[e]=n}}static async load(t){const e=await C.load(`${t}/client/title`);b.instances[0]=new b(e,'p11'),b.instances[1]=new b(e,'p12'),b.instances[2]=new b(e,'b12'),b.instances[3]=new b(e,'q8')}static get(t){return b.instances[t]}static get count(){return this.instances.length}charMask=new Array(94);charMaskWidth=new Uint8Array(94);charMaskHeight=new Uint8Array(94);charOffsetX=new Uint8Array(94);charOffsetY=new Uint8Array(94);charAdvance=new Uint8Array(95);drawWidth=new Uint8Array(256);height=0;constructor(t,e){const n=t.read(`${e}.dat`),s=t.read('index.dat');if(!n||!s)return;s.pos=n.g2()+4;const i=s.g1();i>0&&(s.pos+=3*(i-1));for(let t=0;t<94;t++){this.charOffsetX[t]=s.g1(),this.charOffsetY[t]=s.g1();const e=this.charMaskWidth[t]=s.g2(),i=this.charMaskHeight[t]=s.g2(),a=s.g1(),r=e*i;if(this.charMask[t]=new Uint8Array(r),0==a)for(let e=0;e<r;e++)this.charMask[t][e]=n.g1();else if(1==a)for(let s=0;s<e;s++)for(let a=0;a<i;a++)this.charMask[t][s+a*e]=n.g1();i>this.height&&(this.height=i),this.charOffsetX[t]=1,this.charAdvance[t]=e+2;let o=0;for(let n=Math.floor(i/7);n<i;n++)o+=this.charMask[t][n*e];o<=Math.floor(i/7)&&(this.charAdvance[t]--,this.charOffsetX[t]=0),o=0;for(let n=Math.floor(i/7);n<i;n++)o+=this.charMask[t][e+n*e-1];o<=Math.floor(i/7)&&this.charAdvance[t]--}this.charAdvance[94]=this.charAdvance[8];for(let t=0;t<256;t++)this.drawWidth[t]=this.charAdvance[b.CHAR_LOOKUP[t]]}stringWidth(t){if(null==t)return 0;let e=0;for(let n=0;n<t.length;n++)'@'==t.charAt(n)&&n+4<t.length&&'@'==t.charAt(n+4)?n+=4:e+=this.drawWidth[t.charCodeAt(n)];return e}split(t,e){if(0===t.length)return[t];const n=[];for(;t.length>0;){if(this.stringWidth(t)<=e&&-1===t.indexOf('|')){n.push(t);break}let s=t.length;for(let n=0;n<t.length;n++)if(' '===t[n]){if(this.stringWidth(t.substring(0,n))>e)break;s=n}else if('|'===t[n]){s=n;break}n.push(t.substring(0,s)),t=t.substring(s+1)}return n}}(v=y||={})[v.OFF=0]='OFF',v[v.OUTSIDE_WILDERNESS=1]='OUTSIDE_WILDERNESS';var U,D,M=y;(D=U||={})[D.OFF=0]='OFF',D[D.PLAYER=1]='PLAYER',D[D.NPC=2]='NPC',D[D.OBJ=3]='OBJ',D[D.SCENERY=4]='SCENERY';var k,x,B=U;(x=k||={})[x.KEEPHUNTING=0]='KEEPHUNTING',x[x.PAUSEHUNT=1]='PAUSEHUNT';var H,F,G=k;(F=H||={})[F.OFF=0]='OFF',F[F.LINEOFSIGHT=1]='LINEOFSIGHT',F[F.LINEOFWALK=2]='LINEOFWALK';var W,z,V=H;(z=W||={})[z.NULL=-1]='NULL',z[z.NONE=0]='NONE',z[z.WANDER=1]='WANDER',z[z.PATROL=2]='PATROL',z[z.PLAYERESCAPE=3]='PLAYERESCAPE',z[z.PLAYERFOLLOW=4]='PLAYERFOLLOW',z[z.PLAYERFACE=5]='PLAYERFACE',z[z.PLAYERFACECLOSE=6]='PLAYERFACECLOSE',z[z.OPPLAYER1=7]='OPPLAYER1',z[z.OPPLAYER2=8]='OPPLAYER2',z[z.OPPLAYER3=9]='OPPLAYER3',z[z.OPPLAYER4=10]='OPPLAYER4',z[z.OPPLAYER5=11]='OPPLAYER5',z[z.APPLAYER1=12]='APPLAYER1',z[z.APPLAYER2=13]='APPLAYER2',z[z.APPLAYER3=14]='APPLAYER3',z[z.APPLAYER4=15]='APPLAYER4',z[z.APPLAYER5=16]='APPLAYER5',z[z.OPLOC1=17]='OPLOC1',z[z.OPLOC2=18]='OPLOC2',z[z.OPLOC3=19]='OPLOC3',z[z.OPLOC4=20]='OPLOC4',z[z.OPLOC5=21]='OPLOC5',z[z.APLOC1=22]='APLOC1',z[z.APLOC2=23]='APLOC2',z[z.APLOC3=24]='APLOC3',z[z.APLOC4=25]='APLOC4',z[z.APLOC5=26]='APLOC5',z[z.OPOBJ1=27]='OPOBJ1',z[z.OPOBJ2=28]='OPOBJ2',z[z.OPOBJ3=29]='OPOBJ3',z[z.OPOBJ4=30]='OPOBJ4',z[z.OPOBJ5=31]='OPOBJ5',z[z.APOBJ1=32]='APOBJ1',z[z.APOBJ2=33]='APOBJ2',z[z.APOBJ3=34]='APOBJ3',z[z.APOBJ4=35]='APOBJ4',z[z.APOBJ5=36]='APOBJ5',z[z.OPNPC1=37]='OPNPC1',z[z.OPNPC2=38]='OPNPC2',z[z.OPNPC3=39]='OPNPC3',z[z.OPNPC4=40]='OPNPC4',z[z.OPNPC5=41]='OPNPC5',z[z.APNPC1=42]='APNPC1',z[z.APNPC2=43]='APNPC2',z[z.APNPC3=44]='APNPC3',z[z.APNPC4=45]='APNPC4',z[z.APNPC5=46]='APNPC5',z[z.QUEUE1=47]='QUEUE1',z[z.QUEUE2=48]='QUEUE2',z[z.QUEUE3=49]='QUEUE3',z[z.QUEUE4=50]='QUEUE4',z[z.QUEUE5=51]='QUEUE5',z[z.QUEUE6=52]='QUEUE6',z[z.QUEUE7=53]='QUEUE7',z[z.QUEUE8=54]='QUEUE8',z[z.QUEUE9=55]='QUEUE9',z[z.QUEUE10=56]='QUEUE10',z[z.QUEUE11=57]='QUEUE11',z[z.QUEUE12=58]='QUEUE12',z[z.QUEUE13=59]='QUEUE13',z[z.QUEUE14=60]='QUEUE14',z[z.QUEUE15=61]='QUEUE15',z[z.QUEUE16=62]='QUEUE16',z[z.QUEUE17=63]='QUEUE17',z[z.QUEUE18=64]='QUEUE18',z[z.QUEUE19=65]='QUEUE19',z[z.QUEUE20=66]='QUEUE20';var Y=W;class K extends O{static configNames=new Map;static configs=[];static async load(t){if(K.configNames=new Map,K.configs=[],!(await fetch(`${t}/server/hunt.dat`)).ok)return void console.log('Warning: No hunt.dat found.');const e=await E.load(`${t}/server/hunt.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new K(t);n.decodeType(e),K.configs[t]=n,n.debugname&&K.configNames.set(n.debugname,t)}}static get(t){return K.configs[t]}static getId(t){return K.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=B.OFF;checkVis=V.OFF;checkNotTooStrong=M.OFF;checkNotBusy=!1;findKeepHunting=!1;findNewMode=Y.NONE;nobodyNear=G.PAUSEHUNT;checkNotCombat=-1;checkNotCombatSelf=-1;checkAfk=!0;rate=1;checkCategory=-1;checkNpc=-1;checkObj=-1;checkLoc=-1;checkInv=-1;checkObjParam=-1;checkInvMinQuantity=-1;checkInvMaxQuantity=-1;decode(t,e){if(1===t)this.type=e.g1();else if(2==t)this.checkVis=e.g1();else if(3==t)this.checkNotTooStrong=e.g1();else if(4==t)this.checkNotBusy=!0;else if(5==t)this.findKeepHunting=!0;else if(6==t)this.findNewMode=e.g1();else if(7==t)this.nobodyNear=e.g1();else if(8===t)this.checkNotCombat=e.g2();else if(9===t)this.checkNotCombatSelf=e.g2();else if(10===t)this.checkAfk=!1;else if(11===t)this.rate=e.g2();else if(12===t)this.checkCategory=e.g2();else if(13===t)this.checkNpc=e.g2();else if(14===t)this.checkObj=e.g2();else if(15===t)this.checkLoc=e.g2();else if(16===t)this.checkInv=e.g2(),this.checkObj=e.g2(),this.checkInvMinQuantity=e.g4(),this.checkInvMaxQuantity=e.g4();else if(17===t)this.checkInv=e.g2(),this.checkObjParam=e.g2(),this.checkInvMinQuantity=e.g4(),this.checkInvMaxQuantity=e.g4();else{if(250!==t)throw new Error(`Unrecognized hunt config code: ${t}`);this.debugname=e.gjstr()}}}class j extends O{static configNames=new Map;static configs=[];static async load(t){if(j.configNames=new Map,j.configs=[],!(await fetch(`${t}/server/idk.dat`)).ok)return void console.log('Warning: No idk.dat found.');const e=await E.load(`${t}/server/idk.dat`),n=e.g2(),s=(await C.load(`${t}/client/config`)).read('idk.dat');s.pos=2;for(let t=0;t<n;t++){const n=new j(t);n.decodeType(e),n.decodeType(s),j.configs[t]=n,n.debugname&&j.configNames.set(n.debugname,t)}}static get(t){return j.configs[t]}static getId(t){return j.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=-1;models=null;heads=new Uint16Array(5).fill(-1);recol_s=new Uint16Array(6).fill(0);recol_d=new Uint16Array(6).fill(0);disable=!1;decode(t,e){if(1===t)this.type=e.g1();else if(2===t){const t=e.g1();this.models=new Uint16Array(t);for(let n=0;n<t;n++)this.models[n]=e.g2()}else if(3===t)this.disable=!0;else if(t>=40&&t<50)this.recol_s[t-40]=e.g2();else if(t>=50&&t<60)this.recol_d[t-50]=e.g2();else if(t>=60&&t<70)this.heads[t-60]=e.g2();else{if(250!==t)throw new Error(`Unrecognized idk config code: ${t}`);this.debugname=e.gjstr()}}}class Z{static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INVENTORY=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_SPRITE=5;static TYPE_MODEL=6;static TYPE_INVENTORY_TEXT=7;static NO_BUTTON=0;static BUTTON=1;static TARGET_BUTTON=2;static CLOSE_BUTTON=3;static TOGGLE_BUTTON=4;static SELECT_BUTTON=5;static PAUSE_BUTTON=6;static componentNames=new Map;static components=[];static async load(t){if(this.componentNames=new Map,this.components=[],!(await fetch(`${t}/server/interface.dat`)).ok)return void console.log('Warning: No interface.dat found.');const e=await E.load(`${t}/server/interface.dat`);e.g2();let n=-1;for(;e.available>0;){let t=e.g2();65535===t&&(n=e.g2(),t=e.g2());const s=new Z;s.id=t,s.rootLayer=n,s.comName=e.gjstr(),s.overlay=e.gbool(),s.type=e.g1(),s.buttonType=e.g1(),s.clientCode=e.g2(),s.width=e.g2(),s.height=e.g2(),s.overLayer=e.g1(),0==s.overLayer?s.overLayer=-1:s.overLayer=(s.overLayer-1<<8)+e.g1();const i=e.g1();if(i>0){s.scriptComparator=new Uint8Array(i).fill(0),s.scriptOperand=new Uint16Array(i).fill(0);for(let t=0;t<i;t++)s.scriptComparator[t]=e.g1(),s.scriptOperand[t]=e.g2()}const a=e.g1();if(a>0){s.scripts=new Array(a).fill(null);for(let t=0;t<a;t++){const n=e.g2();s.scripts[t]=new Uint16Array(n).fill(0);for(let i=0;i<n;i++)s.scripts[t][i]=e.g2()}}switch(s.type){case Z.TYPE_LAYER:{s.scroll=e.g2(),s.hide=e.gbool();const t=e.g1();s.childId=new Uint16Array(t).fill(0),s.childX=new Uint16Array(t).fill(0),s.childY=new Uint16Array(t).fill(0);for(let n=0;n<t;n++)s.childId[n]=e.g2(),s.childX[n]=e.g2s(),s.childY[n]=e.g2s();break}case Z.TYPE_UNUSED:e.pos+=10;break;case Z.TYPE_INVENTORY:s.draggable=e.gbool(),s.interactable=e.gbool(),s.usable=e.gbool(),s.marginX=e.g1(),s.marginY=e.g1(),s.inventorySlotOffsetX=new Uint16Array(20).fill(0),s.inventorySlotOffsetY=new Uint16Array(20).fill(0),s.inventorySlotGraphic=new Array(20).fill(null);for(let t=0;t<20;t++)e.gbool()&&(s.inventorySlotOffsetX[t]=e.g2s(),s.inventorySlotOffsetY[t]=e.g2s(),s.inventorySlotGraphic[t]=e.gjstr());s.inventoryOptions=new Array(5).fill(null);for(let t=0;t<5;t++)s.inventoryOptions[t]=e.gjstr();s.actionVerb=e.gjstr(),s.action=e.gjstr(),s.actionTarget=e.g2();break;case Z.TYPE_RECT:s.fill=e.gbool(),s.colour=e.g4(),s.activeColour=e.g4(),s.overColour=e.g4();break;case Z.TYPE_TEXT:s.center=e.gbool(),s.font=e.g1(),s.shadowed=e.gbool(),s.text=e.gjstr(),s.activeText=e.gjstr(),s.colour=e.g4(),s.activeColour=e.g4(),s.overColour=e.g4();break;case Z.TYPE_SPRITE:s.graphic=e.gjstr(),s.activeGraphic=e.gjstr();break;case Z.TYPE_MODEL:s.model=e.g1(),0!=s.model&&(s.model=(s.model-1<<8)+e.g1()),s.activeModel=e.g1(),0!=s.activeModel&&(s.activeModel=(s.activeModel-1<<8)+e.g1()),s.anim=e.g1(),0==s.anim?s.anim=-1:s.anim=(s.anim-1<<8)+e.g1(),s.activeAnim=e.g1(),0==s.activeAnim?s.activeAnim=-1:s.activeAnim=(s.activeAnim-1<<8)+e.g1(),s.zoom=e.g2(),s.xan=e.g2(),s.yan=e.g2();break;case Z.TYPE_INVENTORY_TEXT:s.center=e.gbool(),s.font=e.g1(),s.shadowed=e.gbool(),s.colour=e.g4(),s.marginX=e.g2s(),s.marginY=e.g2s(),s.interactable=e.gbool(),s.inventoryOptions=new Array(5).fill(null);for(let t=0;t<5;t++)s.inventoryOptions[t]=e.gjstr()}switch(s.buttonType){case Z.NO_BUTTON:break;case Z.TARGET_BUTTON:s.actionVerb=e.gjstr(),s.action=e.gjstr(),s.actionTarget=e.g2();break;case Z.BUTTON:case Z.TOGGLE_BUTTON:case Z.SELECT_BUTTON:case Z.PAUSE_BUTTON:s.option=e.gjstr()}Z.components[t]=s,s.comName&&Z.componentNames.set(s.comName,t)}}static get(t){return Z.components[t]}static getId(t){return Z.componentNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}id=-1;rootLayer=-1;comName=null;overlay=!1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;inventorySlotOffsetX=null;inventorySlotOffsetY=null;inventorySlotGraphic=null;inventoryOptions=null;fill=!1;center=!1;font=0;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=-1;activeModel=-1;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null}class J extends O{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static SCOPE_SHARED=2;static INV=-1;static WORN=-1;static async load(t){if(J.configNames=new Map,J.configs=[],!(await fetch(`${t}/server/inv.dat`)).ok)return void console.log('Warning: No inv.dat found.');const e=await E.load(`${t}/server/inv.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new J(t);n.decodeType(e),J.configs[t]=n,n.debugname&&J.configNames.set(n.debugname,t)}J.INV=J.getId('inv'),J.WORN=J.getId('worn')}static get(t){return J.configs[t]}static getId(t){return J.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}scope=0;size=1;stackall=!1;restock=!1;allstock=!1;stockobj=null;stockcount=null;stockrate=null;protect=!0;runweight=!1;dummyinv=!1;decode(t,e){if(1===t)this.scope=e.g1();else if(2===t)this.size=e.g2();else if(3===t)this.stackall=!0;else if(4===t){const t=e.g1();this.stockobj=new Uint16Array(t),this.stockcount=new Uint16Array(t),this.stockrate=new Int32Array(t);for(let n=0;n<t;n++)this.stockobj[n]=e.g2(),this.stockcount[n]=e.g2(),this.stockrate[n]=e.g4()}else if(5===t)this.restock=!0;else if(6===t)this.allstock=!0;else if(7===t)this.protect=!1;else if(8===t)this.runweight=!0;else if(9===t)this.dummyinv=!0;else{if(250!==t)throw new Error(`Unrecognized inv config code: ${t}`);this.debugname=e.gjstr()}}}var $,X,Q=function(t,e,n){const s=e.params?.get(t);return'string'!=typeof s?n??'null':s},q=function(t,e,n){const s=e.params?.get(t);return'number'!=typeof s?n:s},tt=function(t){const e=t.g1(),n=new Map;for(let s=0;s<e;s++){const e=t.g3();t.gbool()?n.set(e,t.gjstr()):n.set(e,t.g4())}return n};class et extends O{static configNames=new Map;static configs=[];static async load(t){if(et.configNames=new Map,et.configs=[],!(await fetch(`${t}/server/loc.dat`)).ok)return void console.log('Warning: No loc.dat found.');const e=await E.load(`${t}/server/loc.dat`),n=e.g2(),s=(await C.load(`${t}/client/config`)).read('loc.dat');s.pos=2;for(let t=0;t<n;t++){const n=new et(t);n.active=-1,n.decodeType(e),n.decodeType(s),-1===n.active&&n.shapes&&(n.active=n.shapes.length>0&&10===n.shapes[0]?1:0,n.op&&n.op.length>0&&(n.active=1)),et.configs[t]=n,n.debugname&&et.configNames.set(n.debugname,t)}}static get(t){return et.configs[t]}static getId(t){return et.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return void 0===e||-1===e?null:this.get(e)}static get count(){return this.configs.length}models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=0;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;hasalpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;xoff=0;yoff=0;zoff=0;forcedecor=!1;category=-1;params=new Map;decode(t,e){if(1===t){const t=e.g1();this.models=new Uint16Array(t),this.shapes=new Uint8Array(t);for(let n=0;n<t;n++)this.models[n]=e.g2(),this.shapes[n]=e.g1()}else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(14===t)this.width=e.g1();else if(15===t)this.length=e.g1();else if(17===t)this.blockwalk=!1;else if(18===t)this.blockrange=!1;else if(19===t)this.active=e.g1();else if(21===t)this.hillskew=!0;else if(22===t)this.sharelight=!0;else if(23===t)this.occlude=!0;else if(24===t)this.anim=e.g2(),65535==this.anim&&(this.anim=-1);else if(25===t)this.hasalpha=!0;else if(28===t)this.wallwidth=e.g1();else if(29===t)this.ambient=e.g1b();else if(39===t)this.contrast=e.g1b();else if(t>=30&&t<35)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr(),'hidden'===this.op[t-30]&&(this.op[t-30]=null);else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let n=0;n<t;n++)this.recol_s[n]=e.g2(),this.recol_d[n]=e.g2()}else if(60===t)this.mapfunction=e.g2();else if(62===t)this.mirror=!0;else if(64===t)this.shadow=!1;else if(65===t)this.resizex=e.g2();else if(66===t)this.resizey=e.g2();else if(67===t)this.resizez=e.g2();else if(68===t)this.mapscene=e.g2();else if(69===t)this.forceapproach=e.g1();else if(70===t)this.xoff=e.g2s();else if(71===t)this.yoff=e.g2s();else if(72===t)this.zoff=e.g2s();else if(73===t)this.forcedecor=!0;else if(200===t)this.category=e.g2();else if(249===t)this.params=tt(e);else{if(250!==t)throw new Error(`Unrecognized loc config code: ${t}`);this.debugname=e.gjstr()}}}class nt extends O{static configNames=new Map;static configs=[];static async load(t){if(nt.configNames=new Map,nt.configs=[],!(await fetch(`${t}/server/mesanim.dat`)).ok)return void console.log('Warning: No mesanim.dat found.');const e=await E.load(`${t}/server/mesanim.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new nt(t);n.decodeType(e),nt.configs[t]=n,n.debugname&&nt.configNames.set(n.debugname,t)}}static get(t){return nt.configs[t]}static getId(t){return nt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}len=new Array(4).fill(-1);decode(t,e){if(t>=1&&t<5)this.len[t-1]=e.g2();else{if(250!==t)throw new Error(`Unrecognized mesanim config code: ${t}`);this.debugname=e.gjstr()}}}(X=$||={})[X.NONE=0]='NONE',X[X.NPC=1]='NPC',X[X.ALL=2]='ALL';var st,it,at=$;(it=st||={})[it.NORMAL=0]='NORMAL',it[it.BLOCKED=1]='BLOCKED',it[it.BLOCKED_NORMAL=2]='BLOCKED_NORMAL',it[it.INDOORS=3]='INDOORS',it[it.OUTDOORS=4]='OUTDOORS',it[it.NOMOVE=5]='NOMOVE',it[it.PASSTHRU=6]='PASSTHRU';var rt,ot,ct=st;(ot=rt||={})[ot.ATTACK=0]='ATTACK',ot[ot.DEFENCE=1]='DEFENCE',ot[ot.STRENGTH=2]='STRENGTH',ot[ot.HITPOINTS=3]='HITPOINTS',ot[ot.RANGED=4]='RANGED',ot[ot.MAGIC=5]='MAGIC';var lt,ht,dt=rt;class pt extends O{static configNames=new Map;static configs=[];static async load(t){if(pt.configNames=new Map,pt.configs=[],!(await fetch(`${t}/server/npc.dat`)).ok)return void console.log('Warning: No npc.dat found.');const e=await E.load(`${t}/server/npc.dat`),n=e.g2(),s=(await C.load(`${t}/client/config`)).read('npc.dat');s.pos=2;for(let t=0;t<n;t++){const n=new pt(t);n.decodeType(e),n.decodeType(s),pt.configs[t]=n,n.debugname&&pt.configNames.set(n.debugname,t)}}static get(t){return pt.configs[t]}static getId(t){return pt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}name=null;desc=null;size=1;models=null;heads=null;hasanim=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;hasalpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;category=-1;wanderrange=5;maxrange=10;huntrange=5;timer=-1;respawnrate=100;stats=[1,1,1,1,1,1];moverestrict=ct.NORMAL;attackrange=7;huntmode=-1;defaultmode=Y.WANDER;members=!1;blockwalk=at.NPC;params=new Map;patrolCoord=[];patrolDelay=[];givechase=!0;decode(t,e){if(1===t){const t=e.g1();this.models=new Uint16Array(t);for(let n=0;n<t;n++)this.models[n]=e.g2()}else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(12===t)this.size=e.g1();else if(13===t)this.readyanim=e.g2();else if(14===t)this.walkanim=e.g2();else if(16===t)this.hasanim=!0;else if(17===t)this.walkanim=e.g2(),this.walkanim_b=e.g2(),this.walkanim_r=e.g2(),this.walkanim_l=e.g2();else if(18===t)this.category=e.g2();else if(t>=30&&t<40)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr(),'hidden'===this.op[t-30]&&(this.op[t-30]=null);else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let n=0;n<t;n++)this.recol_s[n]=e.g2(),this.recol_d[n]=e.g2()}else if(60===t){const t=e.g1();this.heads=new Uint16Array(t);for(let n=0;n<t;n++)this.heads[n]=e.g2()}else if(74===t)this.stats[dt.ATTACK]=e.g2();else if(75===t)this.stats[dt.DEFENCE]=e.g2();else if(76===t)this.stats[dt.STRENGTH]=e.g2();else if(77===t)this.stats[dt.HITPOINTS]=e.g2();else if(78===t)this.stats[dt.RANGED]=e.g2();else if(79===t)this.stats[dt.MAGIC]=e.g2();else if(90===t)this.resizex=e.g2();else if(91===t)this.resizey=e.g2();else if(92===t)this.resizez=e.g2();else if(93===t)this.minimap=!1;else if(95===t)this.vislevel=e.g2();else if(97===t)this.resizeh=e.g2();else if(98===t)this.resizev=e.g2();else if(200===t)this.wanderrange=e.g1();else if(201===t)this.maxrange=e.g1();else if(202===t)this.huntrange=e.g1();else if(203===t)this.timer=e.g2();else if(204===t)this.respawnrate=e.g2();else if(206===t)this.moverestrict=e.g1();else if(207==t)this.attackrange=e.g1();else if(208===t)this.blockwalk=e.g1();else if(209===t)this.huntmode=e.g1();else if(210===t)this.defaultmode=e.g1();else if(211===t)this.members=!0;else if(212===t){const t=e.g1();this.patrolCoord=new Array(t),this.patrolDelay=new Array(t);for(let n=0;n<t;n++)this.patrolCoord[n]=e.g4(),this.patrolDelay[n]=e.g1()}else 213===t?this.givechase=!1:249===t?this.params=tt(e):250===t?this.debugname=e.gjstr():(console.error('Unrecognized npc config code: '+t),console.error('Try `npm run build` and report an issue if this still happens.'),process.exit(1))}}class _t extends O{static configNames=new Map;static configs=[];static async load(t){_t.configNames=new Map,_t.configs=[],(await fetch(`${t}/server/param.dat`)).ok||console.log('Warning: No param.dat found.');const e=await E.load(`${t}/server/param.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new _t(t);n.decodeType(e),_t.configs[t]=n,n.debugname&&_t.configNames.set(n.debugname,t)}}static get(t){return _t.configs[t]}static getId(t){return _t.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=A.INT;defaultInt=-1;defaultString=null;autodisable=!0;decode(t,e){if(1===t)this.type=e.g1();else if(2===t)this.defaultInt=e.g4();else if(4===t)this.autodisable=!1;else if(5===t)this.defaultString=e.gjstr();else{if(250!==t)throw new Error(`Unrecognized param config code: ${t}`);this.debugname=e.gjstr()}}getType(){switch(this.type){case A.INT:return'int';case A.STRING:return'string';case A.ENUM:return'enum';case A.OBJ:return'obj';case A.LOC:return'loc';case A.COMPONENT:return'component';case A.NAMEDOBJ:return'namedobj';case A.STRUCT:return'struct';case A.BOOLEAN:return'boolean';case A.COORD:return'coord';case A.CATEGORY:return'category';case A.SPOTANIM:return'spotanim';case A.NPC:return'npc';case A.INV:return'inv';case A.SYNTH:return'synth';case A.SEQ:return'seq';case A.STAT:return'stat';case A.INTERFACE:return'interface';default:return'unknown'}}isString(){return this.type===A.STRING}get default(){return this.isString()?this.defaultString:this.defaultInt}}class ut extends O{static configNames=new Map;static configs=[];static async load(t,e){if(ut.configNames=new Map,ut.configs=[],!(await fetch(`${t}/server/obj.dat`)).ok)return void console.log('Warning: No obj.dat found.');const n=await E.load(`${t}/server/obj.dat`),s=n.g2(),i=(await C.load(`${t}/client/config`)).read('obj.dat');i.pos=2;for(let t=0;t<s;t++){const e=new ut(t);e.decodeType(n),e.decodeType(i),ut.configs[t]=e,e.debugname&&ut.configNames.set(e.debugname,t)}for(let t=0;t<s;t++){const n=ut.configs[t];-1!=n.certtemplate&&n.toCertificate(),!e&&n.members&&(n.tradeable=!1,n.op=null,n.iop=null,n.params.forEach(((t,e)=>{_t.get(e)?.autodisable&&n.params.delete(e)})))}}static get(t){return ut.configs[t]}static getId(t){return ut.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}static getWearPosId(t){switch(t){case'hat':return 0;case'back':return 1;case'front':return 2;case'righthand':return 3;case'torso':return 4;case'lefthand':return 5;case'arms':return 6;case'legs':return 7;case'head':return 8;case'hands':return 9;case'feet':return 10;case'jaw':return 11;case'ring':return 12;case'quiver':return 13;default:return-1}}model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;wearpos=-1;wearpos2=-1;wearpos3=-1;weight=0;category=-1;dummyitem=0;tradeable=!1;respawnrate=100;params=new Map;decode(t,e){if(1===t)this.model=e.g2();else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(4===t)this.zoom2d=e.g2();else if(5===t)this.xan2d=e.g2();else if(6===t)this.yan2d=e.g2();else if(7===t)this.xof2d=e.g2s();else if(8===t)this.yof2d=e.g2s();else if(9===t)this.code9=!0;else if(10===t)this.code10=e.g2();else if(11===t)this.stackable=!0;else if(12===t)this.cost=e.g4();else if(13===t)this.wearpos=e.g1();else if(14===t)this.wearpos2=e.g1();else if(16===t)this.members=!0;else if(23===t)this.manwear=e.g2(),this.manwearOffsetY=e.g1b();else if(24===t)this.manwear2=e.g2();else if(25===t)this.womanwear=e.g2(),this.womanwearOffsetY=e.g1b();else if(26===t)this.womanwear2=e.g2();else if(27===t)this.wearpos3=e.g1();else if(t>=30&&t<35)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr();else if(t>=35&&t<40)this.iop||(this.iop=new Array(5).fill(null)),this.iop[t-35]=e.gjstr();else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let n=0;n<t;n++)this.recol_s[n]=e.g2(),this.recol_d[n]=e.g2()}else if(75===t)this.weight=e.g2s();else if(78===t)this.manwear3=e.g2();else if(79===t)this.womanwear3=e.g2();else if(90===t)this.manhead=e.g2();else if(91===t)this.womanhead=e.g2();else if(92===t)this.manhead2=e.g2();else if(93===t)this.womanhead2=e.g2();else if(94===t)this.category=e.g2();else if(95===t)this.zan2d=e.g2();else if(96===t)this.dummyitem=e.g1();else if(97===t)this.certlink=e.g2();else if(98===t)this.certtemplate=e.g2();else if(t>=100&&t<110)this.countobj&&this.countco||(this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10)),this.countobj[t-100]=e.g2(),this.countco[t-100]=e.g2();else if(200===t)this.tradeable=!0;else if(201===t)this.respawnrate=e.g2();else if(249===t)this.params=tt(e);else{if(250!==t)throw new Error(`Unrecognized obj config code: ${t}`);this.debugname=e.gjstr()}}toCertificate(){const t=ut.get(this.certtemplate);this.model=t.model,this.zoom2d=t.zoom2d,this.xan2d=t.xan2d,this.yan2d=t.yan2d,this.zan2d=t.zan2d,this.xof2d=t.xof2d,this.yof2d=t.yof2d,this.recol_s=t.recol_s,this.recol_d=t.recol_d;const e=ut.get(this.certlink);this.name=e.name,this.members=e.members,this.cost=e.cost,this.tradeable=e.tradeable;let n='a';const s=(e.name||'').toLowerCase().charAt(0);'a'!==s&&'e'!==s&&'i'!==s&&'o'!==s&&'u'!==s||(n='an'),this.desc=`Swap this note at any bank for ${n} ${e.name}.`,this.stackable=!0}}class gt{static instances=[];static async load(t){gt.instances=[];const e=await E.load(`${t}/server/frame_del.dat`);for(let t=0;t<e.data.length;t++){const n=new gt;n.delay=e.g1(),gt.instances[t]=n}}delay=0}class mt extends O{static configNames=new Map;static configs=[];static async load(t){if(mt.configNames=new Map,mt.configs=[],!(await fetch(`${t}/server/seq.dat`)).ok)return void console.log('Warning: No seq.dat found.');const e=await E.load(`${t}/server/seq.dat`),n=e.g2(),s=(await C.load(`${t}/client/config`)).read('seq.dat');s.pos=2;for(let t=0;t<n;t++){const n=new mt(t);n.decodeType(e),n.decodeType(s),mt.configs[t]=n,n.debugname&&mt.configNames.set(n.debugname,t)}}static get(t){return mt.configs[t]}static getId(t){return mt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return mt.configs.length}frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;mainhand=-1;offhand=-1;replaycount=99;duration=0;decode(t,e){if(1===t){const t=e.g1();this.frames=new Int32Array(t),this.iframes=new Int32Array(t),this.delay=new Int32Array(t);for(let n=0;n<t;n++)this.frames[n]=e.g2(),this.iframes[n]=e.g2(),65535===this.iframes[n]&&(this.iframes[n]=-1),this.delay[n]=e.g2(),0===this.delay[n]&&(this.delay[n]=gt.instances[this.frames[n]].delay),0===this.delay[n]&&(this.delay[n]=1),this.duration+=this.delay[n]}else if(2===t)this.replayoff=e.g2();else if(3===t){const t=e.g1();this.walkmerge=new Int32Array(t+1);for(let n=0;n<t;n++)this.walkmerge[n]=e.g1();this.walkmerge[t]=9999999}else if(4===t)this.stretches=!0;else if(5===t)this.priority=e.g1();else if(6===t)this.mainhand=e.g2();else if(7===t)this.offhand=e.g2();else if(8===t)this.replaycount=e.g1();else{if(250!==t)throw new Error(`Unrecognized seq config code: ${t}`);this.debugname=e.gjstr()}}}class Et extends O{static configNames=new Map;static configs=[];static async load(t){if(Et.configNames=new Map,Et.configs=[],!(await fetch(`${t}/server/struct.dat`)).ok)return void console.log('Warning: No struct.dat found.');const e=await E.load(`${t}/server/struct.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new Et(t);n.decodeType(e),Et.configs[t]=n,n.debugname&&Et.configNames.set(n.debugname,t)}}static get(t){return Et.configs[t]}static getId(t){return Et.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}params=null;decode(t,e){if(249===t)this.params=tt(e);else{if(250!==t)throw new Error(`Unrecognized struct config code: ${t}`);this.debugname=e.gjstr()}}}class Ot extends O{static configNames=new Map;static configs=[];static async load(t){if(Ot.configNames=new Map,Ot.configs=[],!(await fetch(`${t}/server/varn.dat`)).ok)return void console.log('Warning: No varn.dat found.');const e=await E.load(`${t}/server/varn.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new Ot(t);n.decodeType(e),Ot.configs[t]=n,n.debugname&&Ot.configNames.set(n.debugname,t)}}static get(t){return Ot.configs[t]}static getId(t){return Ot.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=A.INT;decode(t,e){1===t?this.type=e.g1():250===t?this.debugname=e.gjstr():console.error(`Unrecognized varn config code: ${t}`)}}class ft extends O{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static PLAYER_RUN=-1;static TEMP_RUN=-1;static LASTCOMBAT=-1;static async load(t){ft.configNames=new Map,ft.configs=[],(await fetch(`${t}/server/varp.dat`)).ok||console.log('Warning: No varp.dat found.');const e=await E.load(`${t}/server/varp.dat`),n=e.g2(),s=(await C.load(`${t}/client/config`)).read('varp.dat');s.pos=2;for(let t=0;t<n;t++){const n=new ft(t);n.decodeType(e),n.decodeType(s),ft.configs[t]=n,n.debugname&&ft.configNames.set(n.debugname,t)}ft.PLAYER_RUN=ft.getId('player_run'),ft.TEMP_RUN=ft.getId('temp_run'),ft.LASTCOMBAT=ft.getId('lastcombat')}static get(t){return ft.configs[t]}static getId(t){return ft.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}clientcode=0;scope=ft.SCOPE_TEMP;type=A.INT;protect=!0;transmit=!1;decode(t,e){1===t?this.scope=e.g1():2===t?this.type=e.g1():4===t?this.protect=!1:5===t?this.clientcode=e.g2():6===t?this.transmit=!0:250===t?this.debugname=e.gjstr():console.error(`Unrecognized varp config code: ${t}`)}}class At extends O{static configNames=new Map;static configs=[];static async load(t){if(At.configNames=new Map,At.configs=[],!(await fetch(`${t}/server/vars.dat`)).ok)return void console.log('Warning: No vars.dat found.');const e=await E.load(`${t}/server/vars.dat`),n=e.g2();for(let t=0;t<n;t++){const n=new At(t);n.decodeType(e),At.configs[t]=n,n.debugname&&At.configNames.set(n.debugname,t)}}static get(t){return At.configs[t]}static getId(t){return At.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=A.INT;decode(t,e){switch(t){case 1:this.type=e.g1();break;case 250:this.debugname=e.gjstr();break;default:console.error(`Unrecognized vars config code: ${t}`)}}}class Tt{fragments=[];filter(t){for(let e=0;e<t.length;){const n=this.indexOfNumber(t,e);if(-1===n)return;let s=!1;for(let i=e;i>=0&&i<n&&!s;i++)Lt.isSymbol(t[i])||Lt.isNotLowercaseAlpha(t[i])||(s=!0);let i=0;s&&(i=0),0===i&&(i=1,e=n);let a=0;for(let s=n;s<t.length&&s<e;s++)a=10*a+t[s].charCodeAt(0)-48;a<=255&&e-n<=8?i++:i=0,4===i&&(Lt.maskChars(n,e,t),i=0),e=this.indexOfNonNumber(e,t)}}isBadFragment(t){if(Lt.isNumericalChars(t))return!0;const e=this.getInteger(t),n=this.fragments,s=n.length;if(e===n[0]||e===n[s-1])return!0;let i=0,a=s-1;for(;i<=a;){const t=(i+a)/2|0;if(e===n[t])return!0;e<n[t]?a=t-1:i=t+1}return!1}getInteger(t){if(t.length>6)return 0;let e=0;for(let n=0;n<t.length;n++){const s=t[t.length-n-1];if(Lt.isLowercaseAlpha(s))e=38*e+s.charCodeAt(0)+1-'a'.charCodeAt(0);else if("'"==s)e=38*e+27;else if(Lt.isNumerical(s))e=38*e+s.charCodeAt(0)+28-'0'.charCodeAt(0);else if('\0'!=s)return 0}return e}indexOfNumber(t,e){for(let n=e;n<t.length&&n>=0;n++)if(Lt.isNumerical(t[n]))return n;return-1}indexOfNonNumber(t,e){for(let n=t;n<e.length&&n>=0;n++)if(!Lt.isNumerical(e[n]))return n;return e.length}}class It{wordEncFragments;bads=[];badCombinations=[];constructor(t){this.wordEncFragments=t}filter(t){for(let e=0;e<2;e++)for(let e=this.bads.length-1;e>=0;e--)this.filterBadCombinations(this.badCombinations[e],t,this.bads[e])}filterBadCombinations(t,e,n){if(!(n.length>e.length))for(let s=0;s<=e.length-n.length;s++){let i=s;const{currentIndex:a,badIndex:r,hasSymbol:o,hasNumber:c,hasDigit:l}=this.processBadCharacters(e,n,i);i=a;let h=e[i],d=i+1<e.length?e[i+1]:'\0';if(!(r>=n.length)||c&&l)continue;let p,_=!0;if(o){let t=!1,n=!1;if((s-1<0||Lt.isSymbol(e[s-1])&&"'"!=e[s-1])&&(t=!0),(i>=e.length||Lt.isSymbol(e[i])&&"'"!=e[i])&&(n=!0),!t||!n){let n=!1;for(p=s-2,t&&(p=s);!n&&p<i;){if(p>=0&&(!Lt.isSymbol(e[p])||"'"==e[p])){const t=[];let s;for(s=0;s<3&&p+s<e.length&&(!Lt.isSymbol(e[p+s])||"'"==e[p+s]);s++)t[s]=e[p+s];let i=!0;0==s&&(i=!1),s<3&&p-1>=0&&(!Lt.isSymbol(e[p-1])||"'"==e[p-1])&&(i=!1),i&&!this.wordEncFragments.isBadFragment(t)&&(n=!0)}p++}n||(_=!1)}}else{h=' ',s-1>=0&&(h=e[s-1]),d=' ',i<e.length&&(d=e[i]);const n=this.getIndex(h),a=this.getIndex(d);null!=t&&this.comboMatches(n,t,a)&&(_=!1)}if(!_)continue;let u=0,g=0;for(let t=s;t<i;t++)Lt.isNumerical(e[t])?u++:Lt.isAlpha(e[t])&&g++;u<=g&&Lt.maskChars(s,i,e)}}processBadCharacters(t,e,n){let s=n,i=0,a=0,r=!1,o=!1,c=!1;for(;s<t.length&&(!o||!c)&&!(s>=t.length||o&&c);){const l=t[s],h=s+1<t.length?t[s+1]:'\0';let d;if(i<e.length&&(d=this.getEmulatedBadCharLen(h,String.fromCharCode(e[i]),l))>0)1===d&&Lt.isNumerical(l)&&(o=!0),2===d&&(Lt.isNumerical(l)||Lt.isNumerical(h))&&(o=!0),s+=d,i++;else{if(0===i)break;let t;if((t=this.getEmulatedBadCharLen(h,String.fromCharCode(e[i-1]),l))>0)s+=t;else{if(i>=e.length||!Lt.isNotLowercaseAlpha(l))break;if(Lt.isSymbol(l)&&"'"!==l&&(r=!0),Lt.isNumerical(l)&&(c=!0),s++,a++,(100*a/(s-n)|0)>90)break}}}return{currentIndex:s,badIndex:i,hasSymbol:r,hasNumber:o,hasDigit:c}}getEmulatedBadCharLen(t,e,n){if(e==n)return 1;if(e>='a'&&e<='m'){if('a'==e)return'4'!=n&&'@'!=n&&'^'!=n?'/'==n&&'\\'==t?2:0:1;if('b'==e)return'6'!=n&&'8'!=n?'1'==n&&'3'==t?2:0:1;if('c'==e)return'('!=n&&'<'!=n&&'{'!=n&&'['!=n?0:1;if('d'==e)return'['==n&&')'==t?2:0;if('e'==e)return'3'!=n&&'€'!=n?0:1;if('f'==e)return'p'==n&&'h'==t?2:'£'==n?1:0;if('g'==e)return'9'!=n&&'6'!=n?0:1;if('h'==e)return'#'==n?1:0;if('i'==e)return'y'!=n&&'l'!=n&&'j'!=n&&'1'!=n&&'!'!=n&&':'!=n&&';'!=n&&'|'!=n?0:1;if('j'==e)return 0;if('k'==e)return 0;if('l'==e)return'1'!=n&&'|'!=n&&'i'!=n?0:1;if('m'==e)return 0}if(e>='n'&&e<='z'){if('n'==e)return 0;if('o'==e)return'0'!=n&&'*'!=n?'('==n&&')'==t||'['==n&&']'==t||'{'==n&&'}'==t||'<'==n&&'>'==t?2:0:1;if('p'==e)return 0;if('q'==e)return 0;if('r'==e)return 0;if('s'==e)return'5'!=n&&'z'!=n&&'$'!=n&&'2'!=n?0:1;if('t'==e)return'7'!=n&&'+'!=n?0:1;if('u'==e)return'v'==n?1:'\\'==n&&'/'==t||'\\'==n&&'|'==t||'|'==n&&'/'==t?2:0;if('v'==e)return'\\'==n&&'/'==t||'\\'==n&&'|'==t||'|'==n&&'/'==t?2:0;if('w'==e)return'v'==n&&'v'==t?2:0;if('x'==e)return')'==n&&'('==t||'}'==n&&'{'==t||']'==n&&'['==t||'>'==n&&'<'==t?2:0;if('y'==e)return 0;if('z'==e)return 0}return e>='0'&&e<='9'?'0'==e?'o'==n||'O'==n?1:'('==n&&')'==t||'{'==n&&'}'==t||'['==n&&']'==t?2:0:'1'==e&&'l'==n?1:0:','==e?'.'==n?1:0:'.'==e?','==n?1:0:'!'==e&&'i'==n?1:0}comboMatches(t,e,n){let s=0,i=e.length-1;for(;s<=i;){const a=(s+i)/2|0;if(e[a][0]===t&&e[a][1]===n)return!0;t<e[a][0]||t===e[a][0]&&n<e[a][1]?i=a-1:s=a+1}return!1}getIndex(t){return Lt.isLowercaseAlpha(t)?t.charCodeAt(0)+1-'a'.charCodeAt(0):"'"==t?28:Lt.isNumerical(t)?t.charCodeAt(0)+29-'0'.charCodeAt(0):27}}class Nt{wordEncBadWords;domains=[];constructor(t){this.wordEncBadWords=t}filter(t){const e=[...t],n=[...t];this.wordEncBadWords.filterBadCombinations(null,e,Lt.AMPERSAT),this.wordEncBadWords.filterBadCombinations(null,n,Lt.PERIOD);for(let s=this.domains.length-1;s>=0;s--)this.filterDomain(n,e,this.domains[s],t)}getEmulatedDomainCharLen(t,e,n){return e==n||'o'==e&&'0'==n?1:'o'==e&&'('==n&&')'==t?2:'c'!=e||'('!=n&&'<'!=n&&'['!=n?'e'==e&&'€'==n||'s'==e&&'$'==n||'l'==e&&'i'==n?1:0:1}filterDomain(t,e,n,s){const i=n.length,a=s.length;for(let r=0;r<=a-i;r++){const{matched:i,currentIndex:a}=this.findMatchingDomain(r,n,s);if(!i)continue;const o=Lt.prefixSymbolStatus(r,s,3,e,['@']),c=Lt.suffixSymbolStatus(a-1,s,3,t,['.',',']);(o>2||c>2)&&Lt.maskChars(r,a,s)}}findMatchingDomain(t,e,n){const s=e.length;let i=t,a=0;for(;i<n.length&&a<s;){const r=n[i],o=i+1<n.length?n[i+1]:'\0',c=this.getEmulatedDomainCharLen(o,String.fromCharCode(e[a]),r);if(c>0)i+=c,a++;else{if(0===a)break;const n=this.getEmulatedDomainCharLen(o,String.fromCharCode(e[a-1]),r);if(n>0)i+=n,1===a&&t++;else{if(a>=s||!Lt.isSymbol(r))break;i++}}}return{matched:a>=s,currentIndex:i}}}class Pt{wordEncBadWords;wordEncDomains;tlds=[];tldTypes=[];constructor(t,e){this.wordEncBadWords=t,this.wordEncDomains=e}filter(t){const e=[...t],n=[...t];this.wordEncBadWords.filterBadCombinations(null,e,Lt.PERIOD),this.wordEncBadWords.filterBadCombinations(null,n,Lt.SLASH);for(let s=0;s<this.tlds.length;s++)this.filterTld(n,this.tldTypes[s],t,this.tlds[s],e)}filterTld(t,e,n,s,i){if(!(s.length>n.length))for(let a=0;a<=n.length-s.length;a++){const{currentIndex:r,tldIndex:o}=this.processTlds(n,s,a);if(o<s.length)continue;let c=!1;const l=Lt.prefixSymbolStatus(a,n,3,i,[',','.']),h=Lt.suffixSymbolStatus(r-1,n,5,t,['\\','/']);if(1==e&&l>0&&h>0&&(c=!0),2==e&&(l>2&&h>0||l>0&&h>2)&&(c=!0),3==e&&l>0&&h>2&&(c=!0),!c)continue;let d,p=a,_=r-1,u=!1;if(l>2){if(4==l)for(u=!1,d=a-1;d>=0;d--)if(u){if('*'!=i[d])break;p=d}else'*'==i[d]&&(p=d,u=!0);for(u=!1,d=p-1;d>=0;d--)if(u){if(Lt.isSymbol(n[d]))break;p=d}else Lt.isSymbol(n[d])||(u=!0,p=d)}if(h>2){if(4==h)for(u=!1,d=_+1;d<n.length;d++)if(u){if('*'!=t[d])break;_=d}else'*'==t[d]&&(_=d,u=!0);for(u=!1,d=_+1;d<n.length;d++)if(u){if(Lt.isSymbol(n[d]))break;_=d}else Lt.isSymbol(n[d])||(u=!0,_=d)}Lt.maskChars(p,_+1,n)}}processTlds(t,e,n){let s=0;for(;n<t.length&&s<e.length;){const i=t[n],a=n+1<t.length?t[n+1]:'\0';let r;if((r=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(e[s]),i))>0)n+=r,s++;else{if(0===s)break;let t;if((t=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(e[s-1]),i))>0)n+=t;else{if(!Lt.isSymbol(i))break;n++}}}return{currentIndex:n,tldIndex:s}}}class Lt{static PERIOD=new Uint16Array(['d','o','t'].join('').split('').map((t=>t.charCodeAt(0))));static AMPERSAT=new Uint16Array(['(','a',')'].join('').split('').map((t=>t.charCodeAt(0))));static SLASH=new Uint16Array(['s','l','a','s','h'].join('').split('').map((t=>t.charCodeAt(0))));static wordEncFragments=new Tt;static wordEncBadWords=new It(this.wordEncFragments);static wordEncDomains=new Nt(this.wordEncBadWords);static wordEncTlds=new Pt(this.wordEncBadWords,this.wordEncDomains);static whitelist=['cook',"cook's",'cooks','seeks','sheet'];static async load(t){if(!(await fetch(`${t}/client/wordenc`)).ok)return void console.log('Warning: No wordenc found.');const e=await C.load(`${t}/client/wordenc`),n=e.read('fragmentsenc.txt');if(!n)return void console.log('Warning: No fragmentsenc found.');const s=e.read('badenc.txt');if(!s)return void console.log('Warning: No badenc found.');const i=e.read('domainenc.txt');if(!i)return void console.log('Warning: No domainenc found.');const a=e.read('tldlist.txt');a?(this.decodeBadEnc(s),this.decodeDomainEnc(i),this.decodeFragmentsEnc(n),this.decodeTldList(a)):console.log('Warning: No tldlist found.')}static filter(t){const e=[...t];this.format(e);const n=e.join('').trim(),s=n.toLowerCase(),i=[...s];this.wordEncTlds.filter(i),this.wordEncBadWords.filter(i),this.wordEncDomains.filter(i),this.wordEncFragments.filter(i);for(let t=0;t<this.whitelist.length;t++){let e=-1;for(;-1!==(e=s.indexOf(this.whitelist[t],e+1));){const n=[...this.whitelist[t]];for(let t=0;t<n.length;t++)i[t+e]=n[t]}}return this.replaceUppercases(i,[...n]),this.formatUppercases(i),i.join('').trim()}static isSymbol(t){return!this.isAlpha(t)&&!this.isNumerical(t)}static isNotLowercaseAlpha(t){return!this.isLowercaseAlpha(t)||('v'==t||'x'==t||'j'==t||'q'==t||'z'==t)}static isAlpha(t){return this.isLowercaseAlpha(t)||this.isUppercaseAlpha(t)}static isNumerical(t){return t>='0'&&t<='9'}static isLowercaseAlpha(t){return t>='a'&&t<='z'}static isUppercaseAlpha(t){return t>='A'&&t<='Z'}static isNumericalChars(t){for(let e=0;e<t.length;e++)if(!this.isNumerical(t[e])&&'\0'!==t[e])return!1;return!0}static maskChars(t,e,n){for(let s=t;s<e;s++)n[s]='*'}static maskedCountBackwards(t,e){let n=0;for(let s=e-1;s>=0&&Lt.isSymbol(t[s]);s--)'*'===t[s]&&n++;return n}static maskedCountForwards(t,e){let n=0;for(let s=e+1;s<t.length&&this.isSymbol(t[s]);s++)'*'===t[s]&&n++;return n}static maskedCharsStatus(t,e,n,s,i){return(i?this.maskedCountBackwards(e,n):this.maskedCountForwards(e,n))>=s?4:this.isSymbol(i?t[n-1]:t[n+1])?1:0}static prefixSymbolStatus(t,e,n,s,i){if(0===t)return 2;for(let n=t-1;n>=0&&Lt.isSymbol(e[n]);n--)if(i.includes(e[n]))return 3;return Lt.maskedCharsStatus(e,s,t,n,!0)}static suffixSymbolStatus(t,e,n,s,i){if(t+1===e.length)return 2;for(let n=t+1;n<e.length&&Lt.isSymbol(e[n]);n++)if(i.includes(e[n]))return 3;return Lt.maskedCharsStatus(e,s,t,n,!1)}static decodeTldList(t){const e=t.g4();for(let n=0;n<e;n++)this.wordEncTlds.tldTypes[n]=t.g1(),this.wordEncTlds.tlds[n]=new Uint16Array(t.g1()).map((()=>t.g1()))}static decodeBadEnc(t){const e=t.g4();for(let n=0;n<e;n++){this.wordEncBadWords.bads[n]=new Uint16Array(t.g1()).map((()=>t.g1()));const e=new Array(t.g1()).fill([]).map((()=>[t.g1b(),t.g1b()]));e.length>0&&(this.wordEncBadWords.badCombinations[n]=e)}}static decodeDomainEnc(t){const e=t.g4();for(let n=0;n<e;n++)this.wordEncDomains.domains[n]=new Uint16Array(t.g1()).map((()=>t.g1()))}static decodeFragmentsEnc(t){const e=t.g4();for(let n=0;n<e;n++)this.wordEncFragments.fragments[n]=t.g2()}static format(t){let e=0;for(let n=0;n<t.length;n++)this.isCharacterAllowed(t[n])?t[e]=t[n]:t[e]=' ',0!==e&&' '===t[e]&&' '===t[e-1]||e++;for(let n=e;n<t.length;n++)t[n]=' '}static isCharacterAllowed(t){return t>=' '&&t<=''||' '==t||'\n'==t||'\t'==t||'£'==t||'€'==t}static replaceUppercases(t,e){for(let n=0;n<e.length;n++)'*'!==t[n]&&this.isUppercaseAlpha(e[n])&&(t[n]=e[n])}static formatUppercases(t){let e=!0;for(let n=0;n<t.length;n++){const s=t[n];this.isAlpha(s)?e?this.isLowercaseAlpha(s)&&(e=!1):this.isUppercaseAlpha(s)&&(t[n]=String.fromCharCode(s.charCodeAt(0)+'a'.charCodeAt(0)-65)):e=!0}}}class St extends O{static configNames=new Map;static configs=[];static async load(t){if(St.configNames=new Map,St.configs=[],!(await fetch(`${t}/server/spotanim.dat`)).ok)return void console.log('Warning: No spotanim.dat found.');const e=await E.load(`${t}/server/spotanim.dat`),n=e.g2(),s=(await C.load(`${t}/client/config`)).read('spotanim.dat');s.pos=2;for(let t=0;t<n;t++){const n=new St(t);n.decodeType(e),n.decodeType(s),St.configs[t]=n,n.debugname&&St.configNames.set(n.debugname,t)}}static get(t){return St.configs[t]}static getId(t){return St.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}model=0;anim=-1;hasalpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(t,e){if(1===t)this.model=e.g2();else if(2===t)this.anim=e.g2();else if(3===t)this.hasalpha=!0;else if(4===t)this.resizeh=e.g2();else if(5===t)this.resizev=e.g2();else if(6===t)this.orientation=e.g2();else if(7===t)this.ambient=e.g1();else if(8===t)this.contrast=e.g1();else if(t>=40&&t<50)this.recol_s[t-40]=e.g2();else if(t>=50&&t<60)this.recol_d[t-50]=e.g2();else{if(250!==t)throw new Error(`Unrecognized spotanim config code: ${t}`);this.debugname=e.gjstr()}}}function Ct(t,e){return function(n){'number'==typeof t?n.pointerCheck(t):n.pointerCheck(t[n.intOperand]),e(n)}}(ht=lt||={})[ht.ActivePlayer=0]='ActivePlayer',ht[ht.ActivePlayer2=1]='ActivePlayer2',ht[ht.ProtectedActivePlayer=2]='ProtectedActivePlayer',ht[ht.ProtectedActivePlayer2=3]='ProtectedActivePlayer2',ht[ht.ActiveNpc=4]='ActiveNpc',ht[ht.ActiveNpc2=5]='ActiveNpc2',ht[ht.ActiveLoc=6]='ActiveLoc',ht[ht.ActiveLoc2=7]='ActiveLoc2',ht[ht.ActiveObj=8]='ActiveObj',ht[ht.ActiveObj2=9]='ActiveObj2',ht[ht._LAST=10]='_LAST';var yt,vt,wt=[4,5],Rt=[6,7],bt=[8,9],Ut=[0,1],Dt=[2,3],Mt=lt,kt=Object.create,xt=Object.defineProperty,Bt=Object.getOwnPropertyDescriptor,Ht=Object.getOwnPropertyNames,Ft=Object.getPrototypeOf,Gt=Object.prototype.hasOwnProperty,Wt=(t,e,n,s)=>{if(e&&'object'==typeof e||'function'==typeof e)for(let i of Ht(e))!Gt.call(t,i)&&i!==n&&xt(t,i,{get:()=>e[i],enumerable:!(s=Bt(e,i))||s.enumerable});return t},zt=(t,e,n)=>(n=null!=t?kt(Ft(t)):{},Wt(!e&&t&&t.__esModule?n:xt(n,'default',{value:t,enumerable:!0}),t)),Vt=(yt=(t,e)=>{function n(t){if('string'!=typeof t)throw new TypeError('Path must be a string. Received '+JSON.stringify(t))}function s(t,e){for(var n,s='',i=0,a=-1,r=0,o=0;o<=t.length;++o){if(o<t.length)n=t.charCodeAt(o);else{if(47===n)break;n=47}if(47===n){if(a!==o-1&&1!==r)if(a!==o-1&&2===r){if(s.length<2||2!==i||46!==s.charCodeAt(s.length-1)||46!==s.charCodeAt(s.length-2))if(s.length>2){var c=s.lastIndexOf('/');if(c!==s.length-1){-1===c?(s='',i=0):i=(s=s.slice(0,c)).length-1-s.lastIndexOf('/'),a=o,r=0;continue}}else if(2===s.length||1===s.length){s='',i=0,a=o,r=0;continue}e&&(s.length>0?s+='/..':s='..',i=2)}else s.length>0?s+='/'+t.slice(a+1,o):s=t.slice(a+1,o),i=o-a-1;a=o,r=0}else 46===n&&-1!==r?++r:r=-1}return s}var i={resolve:function(){for(var t,e='',i=!1,a=arguments.length-1;a>=-1&&!i;a--){var r;a>=0?r=arguments[a]:(void 0===t&&(t=process.cwd()),r=t),n(r),0!==r.length&&(e=r+'/'+e,i=47===r.charCodeAt(0))}return e=s(e,!i),i?e.length>0?'/'+e:'/':e.length>0?e:'.'},normalize:function(t){if(n(t),0===t.length)return'.';var e=47===t.charCodeAt(0),i=47===t.charCodeAt(t.length-1);return 0===(t=s(t,!e)).length&&!e&&(t='.'),t.length>0&&i&&(t+='/'),e?'/'+t:t},isAbsolute:function(t){return n(t),t.length>0&&47===t.charCodeAt(0)},join:function(){if(0===arguments.length)return'.';for(var t,e=0;e<arguments.length;++e){var s=arguments[e];n(s),s.length>0&&(void 0===t?t=s:t+='/'+s)}return void 0===t?'.':i.normalize(t)},relative:function(t,e){if(n(t),n(e),t===e||(t=i.resolve(t))===(e=i.resolve(e)))return'';for(var s=1;s<t.length&&47===t.charCodeAt(s);++s);for(var a=t.length,r=a-s,o=1;o<e.length&&47===e.charCodeAt(o);++o);for(var c=e.length-o,l=r<c?r:c,h=-1,d=0;d<=l;++d){if(d===l){if(c>l){if(47===e.charCodeAt(o+d))return e.slice(o+d+1);if(0===d)return e.slice(o+d)}else r>l&&(47===t.charCodeAt(s+d)?h=d:0===d&&(h=0));break}var p=t.charCodeAt(s+d);if(p!==e.charCodeAt(o+d))break;47===p&&(h=d)}var _='';for(d=s+h+1;d<=a;++d)(d===a||47===t.charCodeAt(d))&&(0===_.length?_+='..':_+='/..');return _.length>0?_+e.slice(o+h):(o+=h,47===e.charCodeAt(o)&&++o,e.slice(o))},_makeLong:function(t){return t},dirname:function(t){if(n(t),0===t.length)return'.';for(var e=t.charCodeAt(0),s=47===e,i=-1,a=!0,r=t.length-1;r>=1;--r)if(47===(e=t.charCodeAt(r))){if(!a){i=r;break}}else a=!1;return-1===i?s?'/':'.':s&&1===i?'//':t.slice(0,i)},basename:function(t,e){if(void 0!==e&&'string'!=typeof e)throw new TypeError('"ext" argument must be a string');n(t);var s,i=0,a=-1,r=!0;if(void 0!==e&&e.length>0&&e.length<=t.length){if(e.length===t.length&&e===t)return'';var o=e.length-1,c=-1;for(s=t.length-1;s>=0;--s){var l=t.charCodeAt(s);if(47===l){if(!r){i=s+1;break}}else-1===c&&(r=!1,c=s+1),o>=0&&(l===e.charCodeAt(o)?-1==--o&&(a=s):(o=-1,a=c))}return i===a?a=c:-1===a&&(a=t.length),t.slice(i,a)}for(s=t.length-1;s>=0;--s)if(47===t.charCodeAt(s)){if(!r){i=s+1;break}}else-1===a&&(r=!1,a=s+1);return-1===a?'':t.slice(i,a)},extname:function(t){n(t);for(var e=-1,s=0,i=-1,a=!0,r=0,o=t.length-1;o>=0;--o){var c=t.charCodeAt(o);if(47!==c)-1===i&&(a=!1,i=o+1),46===c?-1===e?e=o:1!==r&&(r=1):-1!==e&&(r=-1);else if(!a){s=o+1;break}}return-1===e||-1===i||0===r||1===r&&e===i-1&&e===s+1?'':t.slice(e,i)},format:function(t){if(null===t||'object'!=typeof t)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof t);return function(t,e){var n=e.dir||e.root,s=e.base||(e.name||'')+(e.ext||'');return n?n===e.root?n+s:n+t+s:s}('/',t)},parse:function(t){n(t);var e={root:'',dir:'',base:'',ext:'',name:''};if(0===t.length)return e;var s,i=t.charCodeAt(0),a=47===i;a?(e.root='/',s=1):s=0;for(var r=-1,o=0,c=-1,l=!0,h=t.length-1,d=0;h>=s;--h)if(47!==(i=t.charCodeAt(h)))-1===c&&(l=!1,c=h+1),46===i?-1===r?r=h:1!==d&&(d=1):-1!==r&&(d=-1);else if(!l){o=h+1;break}return-1===r||-1===c||0===d||1===d&&r===c-1&&r===o+1?-1!==c&&(e.base=e.name=0===o&&a?t.slice(1,c):t.slice(o,c)):(0===o&&a?(e.name=t.slice(1,r),e.base=t.slice(1,c)):(e.name=t.slice(o,r),e.base=t.slice(o,c)),e.ext=t.slice(r,c)),o>0?e.dir=t.slice(0,o-1):a&&(e.dir='/'),e},sep:'/',delimiter:':',win32:null,posix:null};i.posix=i,e.exports=i},()=>(vt||yt((vt={exports:{}}).exports,vt),vt.exports)),Yt={};((t,e)=>{for(var n in e)xt(t,n,{get:e[n],enumerable:!0})})(Yt,{default:()=>Zt}),((t,e,n)=>{Wt(t,e,'default'),n&&Wt(n,e,'default')})(Yt,zt(Vt()));var Kt,jt,Zt=zt(Vt());(jt=Kt||={})[jt.PUSH_CONSTANT_INT=0]='PUSH_CONSTANT_INT',jt[jt.PUSH_VARP=1]='PUSH_VARP',jt[jt.POP_VARP=2]='POP_VARP',jt[jt.PUSH_CONSTANT_STRING=3]='PUSH_CONSTANT_STRING',jt[jt.PUSH_VARN=4]='PUSH_VARN',jt[jt.POP_VARN=5]='POP_VARN',jt[jt.BRANCH=6]='BRANCH',jt[jt.BRANCH_NOT=7]='BRANCH_NOT',jt[jt.BRANCH_EQUALS=8]='BRANCH_EQUALS',jt[jt.BRANCH_LESS_THAN=9]='BRANCH_LESS_THAN',jt[jt.BRANCH_GREATER_THAN=10]='BRANCH_GREATER_THAN',jt[jt.PUSH_VARS=11]='PUSH_VARS',jt[jt.POP_VARS=12]='POP_VARS',jt[jt.RETURN=21]='RETURN',jt[jt.GOSUB=22]='GOSUB',jt[jt.JUMP=23]='JUMP',jt[jt.SWITCH=24]='SWITCH',jt[jt.BRANCH_LESS_THAN_OR_EQUALS=31]='BRANCH_LESS_THAN_OR_EQUALS',jt[jt.BRANCH_GREATER_THAN_OR_EQUALS=32]='BRANCH_GREATER_THAN_OR_EQUALS',jt[jt.PUSH_INT_LOCAL=33]='PUSH_INT_LOCAL',jt[jt.POP_INT_LOCAL=34]='POP_INT_LOCAL',jt[jt.PUSH_STRING_LOCAL=35]='PUSH_STRING_LOCAL',jt[jt.POP_STRING_LOCAL=36]='POP_STRING_LOCAL',jt[jt.JOIN_STRING=37]='JOIN_STRING',jt[jt.POP_INT_DISCARD=38]='POP_INT_DISCARD',jt[jt.POP_STRING_DISCARD=39]='POP_STRING_DISCARD',jt[jt.GOSUB_WITH_PARAMS=40]='GOSUB_WITH_PARAMS',jt[jt.JUMP_WITH_PARAMS=41]='JUMP_WITH_PARAMS',jt[jt.DEFINE_ARRAY=44]='DEFINE_ARRAY',jt[jt.PUSH_ARRAY_INT=45]='PUSH_ARRAY_INT',jt[jt.POP_ARRAY_INT=46]='POP_ARRAY_INT',jt[jt.COORDX=1e3]='COORDX',jt[jt.COORDY=1001]='COORDY',jt[jt.COORDZ=1002]='COORDZ',jt[jt.DISTANCE=1003]='DISTANCE',jt[jt.HUNTALL=1004]='HUNTALL',jt[jt.HUNTNEXT=1005]='HUNTNEXT',jt[jt.INZONE=1006]='INZONE',jt[jt.LINEOFSIGHT=1007]='LINEOFSIGHT',jt[jt.LINEOFWALK=1008]='LINEOFWALK',jt[jt.MAP_BLOCKED=1009]='MAP_BLOCKED',jt[jt.MAP_INDOORS=1010]='MAP_INDOORS',jt[jt.MAP_CLOCK=1011]='MAP_CLOCK',jt[jt.MAP_LOCADDUNSAFE=1012]='MAP_LOCADDUNSAFE',jt[jt.MAP_MEMBERS=1013]='MAP_MEMBERS',jt[jt.MAP_PLAYERCOUNT=1014]='MAP_PLAYERCOUNT',jt[jt.MOVECOORD=1015]='MOVECOORD',jt[jt.PLAYERCOUNT=1016]='PLAYERCOUNT',jt[jt.PROJANIM_MAP=1017]='PROJANIM_MAP',jt[jt.PROJANIM_NPC=1018]='PROJANIM_NPC',jt[jt.PROJANIM_PL=1019]='PROJANIM_PL',jt[jt.SEQLENGTH=1020]='SEQLENGTH',jt[jt.SPLIT_GET=1021]='SPLIT_GET',jt[jt.SPLIT_GETANIM=1022]='SPLIT_GETANIM',jt[jt.SPLIT_INIT=1023]='SPLIT_INIT',jt[jt.SPLIT_LINECOUNT=1024]='SPLIT_LINECOUNT',jt[jt.SPLIT_PAGECOUNT=1025]='SPLIT_PAGECOUNT',jt[jt.SPOTANIM_MAP=1026]='SPOTANIM_MAP',jt[jt.STAT_RANDOM=1027]='STAT_RANDOM',jt[jt.STRUCT_PARAM=1028]='STRUCT_PARAM',jt[jt.WORLD_DELAY=1029]='WORLD_DELAY',jt[jt.NPCCOUNT=1030]='NPCCOUNT',jt[jt.ZONECOUNT=1031]='ZONECOUNT',jt[jt.LOCCOUNT=1032]='LOCCOUNT',jt[jt.OBJCOUNT=1033]='OBJCOUNT',jt[jt.ALLOWDESIGN=2e3]='ALLOWDESIGN',jt[jt.ANIM=2001]='ANIM',jt[jt.BAS_READYANIM=2002]='BAS_READYANIM',jt[jt.BAS_RUNNING=2003]='BAS_RUNNING',jt[jt.BAS_TURNONSPOT=2004]='BAS_TURNONSPOT',jt[jt.BAS_WALK_B=2005]='BAS_WALK_B',jt[jt.BAS_WALK_F=2006]='BAS_WALK_F',jt[jt.BAS_WALK_L=2007]='BAS_WALK_L',jt[jt.BAS_WALK_R=2008]='BAS_WALK_R',jt[jt.BUFFER_FULL=2009]='BUFFER_FULL',jt[jt.BUILDAPPEARANCE=2010]='BUILDAPPEARANCE',jt[jt.BUSY=2011]='BUSY',jt[jt.CAM_LOOKAT=2012]='CAM_LOOKAT',jt[jt.CAM_MOVETO=2013]='CAM_MOVETO',jt[jt.CAM_RESET=2014]='CAM_RESET',jt[jt.CAM_SHAKE=2015]='CAM_SHAKE',jt[jt.CLEARQUEUE=2016]='CLEARQUEUE',jt[jt.CLEARSOFTTIMER=2017]='CLEARSOFTTIMER',jt[jt.CLEARTIMER=2018]='CLEARTIMER',jt[jt.COORD=2019]='COORD',jt[jt.DAMAGE=2020]='DAMAGE',jt[jt.DISPLAYNAME=2021]='DISPLAYNAME',jt[jt.FACESQUARE=2022]='FACESQUARE',jt[jt.FINDUID=2023]='FINDUID',jt[jt.GENDER=2024]='GENDER',jt[jt.GETQUEUE=2025]='GETQUEUE',jt[jt.GIVEXP=2026]='GIVEXP',jt[jt.HEADICONS_GET=2027]='HEADICONS_GET',jt[jt.HEADICONS_SET=2028]='HEADICONS_SET',jt[jt.HEALENERGY=2029]='HEALENERGY',jt[jt.HINT_COORD=2030]='HINT_COORD',jt[jt.HINT_NPC=2031]='HINT_NPC',jt[jt.HINT_PLAYER=2032]='HINT_PLAYER',jt[jt.HINT_STOP=2033]='HINT_STOP',jt[jt.IF_CLOSE=2034]='IF_CLOSE',jt[jt.IF_CLOSESTICKY=2035]='IF_CLOSESTICKY',jt[jt.IF_MULTIZONE=2036]='IF_MULTIZONE',jt[jt.IF_OPENCHAT=2037]='IF_OPENCHAT',jt[jt.IF_OPENCHATSTICKY=2038]='IF_OPENCHATSTICKY',jt[jt.IF_OPENMAINMODAL=2039]='IF_OPENMAINMODAL',jt[jt.IF_OPENMAINMODALSIDEOVERLAY=2040]='IF_OPENMAINMODALSIDEOVERLAY',jt[jt.IF_OPENSIDEOVERLAY=2041]='IF_OPENSIDEOVERLAY',jt[jt.IF_SETANIM=2042]='IF_SETANIM',jt[jt.IF_SETCOLOUR=2043]='IF_SETCOLOUR',jt[jt.IF_SETHIDE=2044]='IF_SETHIDE',jt[jt.IF_SETMODEL=2045]='IF_SETMODEL',jt[jt.IF_SETRECOL=2046]='IF_SETRECOL',jt[jt.IF_SETNPCHEAD=2047]='IF_SETNPCHEAD',jt[jt.IF_SETOBJECT=2048]='IF_SETOBJECT',jt[jt.IF_SETPLAYERHEAD=2049]='IF_SETPLAYERHEAD',jt[jt.IF_SETPOSITION=2050]='IF_SETPOSITION',jt[jt.IF_SETRESUMEBUTTONS=2051]='IF_SETRESUMEBUTTONS',jt[jt.IF_SETTAB=2052]='IF_SETTAB',jt[jt.IF_SETTABACTIVE=2053]='IF_SETTABACTIVE',jt[jt.IF_SETTABFLASH=2054]='IF_SETTABFLASH',jt[jt.IF_SETTEXT=2055]='IF_SETTEXT',jt[jt.LAST_LOGIN_INFO=2056]='LAST_LOGIN_INFO',jt[jt.LAST_COM=2057]='LAST_COM',jt[jt.LAST_INT=2058]='LAST_INT',jt[jt.LAST_ITEM=2059]='LAST_ITEM',jt[jt.LAST_SLOT=2060]='LAST_SLOT',jt[jt.LAST_TARGETSLOT=2061]='LAST_TARGETSLOT',jt[jt.LAST_USEITEM=2062]='LAST_USEITEM',jt[jt.LAST_USESLOT=2063]='LAST_USESLOT',jt[jt.LONGQUEUE=2064]='LONGQUEUE',jt[jt.MES=2065]='MES',jt[jt.MIDI_JINGLE=2066]='MIDI_JINGLE',jt[jt.MIDI_SONG=2067]='MIDI_SONG',jt[jt.NAME=2068]='NAME',jt[jt.P_APRANGE=2069]='P_APRANGE',jt[jt.P_ARRIVEDELAY=2070]='P_ARRIVEDELAY',jt[jt.P_COUNTDIALOG=2071]='P_COUNTDIALOG',jt[jt.P_DELAY=2072]='P_DELAY',jt[jt.P_EXACTMOVE=2073]='P_EXACTMOVE',jt[jt.P_FINDUID=2074]='P_FINDUID',jt[jt.P_LOCMERGE=2075]='P_LOCMERGE',jt[jt.P_LOGOUT=2076]='P_LOGOUT',jt[jt.P_OPHELD=2077]='P_OPHELD',jt[jt.P_OPLOC=2078]='P_OPLOC',jt[jt.P_OPNPC=2079]='P_OPNPC',jt[jt.P_OPNPCT=2080]='P_OPNPCT',jt[jt.P_OPOBJ=2081]='P_OPOBJ',jt[jt.P_OPPLAYER=2082]='P_OPPLAYER',jt[jt.P_OPPLAYERT=2083]='P_OPPLAYERT',jt[jt.P_PAUSEBUTTON=2084]='P_PAUSEBUTTON',jt[jt.P_STOPACTION=2085]='P_STOPACTION',jt[jt.P_TELEJUMP=2086]='P_TELEJUMP',jt[jt.P_TELEPORT=2087]='P_TELEPORT',jt[jt.P_WALK=2088]='P_WALK',jt[jt.PLAYER_FINDALLZONE=2089]='PLAYER_FINDALLZONE',jt[jt.PLAYER_FINDNEXT=2090]='PLAYER_FINDNEXT',jt[jt.QUEUE=2091]='QUEUE',jt[jt.SAY=2092]='SAY',jt[jt.WALKTRIGGER=2093]='WALKTRIGGER',jt[jt.SETTIMER=2094]='SETTIMER',jt[jt.SOFTTIMER=2095]='SOFTTIMER',jt[jt.SOUND_SYNTH=2096]='SOUND_SYNTH',jt[jt.SPOTANIM_PL=2097]='SPOTANIM_PL',jt[jt.STAFFMODLEVEL=2098]='STAFFMODLEVEL',jt[jt.STAT=2099]='STAT',jt[jt.STAT_ADD=2100]='STAT_ADD',jt[jt.STAT_BASE=2101]='STAT_BASE',jt[jt.STAT_HEAL=2102]='STAT_HEAL',jt[jt.STAT_SUB=2103]='STAT_SUB',jt[jt.STRONGQUEUE=2104]='STRONGQUEUE',jt[jt.UID=2105]='UID',jt[jt.WEAKQUEUE=2106]='WEAKQUEUE',jt[jt.IF_OPENMAINOVERLAY=2107]='IF_OPENMAINOVERLAY',jt[jt.AFK_EVENT=2108]='AFK_EVENT',jt[jt.LOWMEMORY=2109]='LOWMEMORY',jt[jt.SETIDKIT=2110]='SETIDKIT',jt[jt.P_CLEARPENDINGACTION=2111]='P_CLEARPENDINGACTION',jt[jt.GETWALKTRIGGER=2112]='GETWALKTRIGGER',jt[jt.BUSY2=2113]='BUSY2',jt[jt.FINDHERO=2114]='FINDHERO',jt[jt.BOTH_HEROPOINTS=2115]='BOTH_HEROPOINTS',jt[jt.SETGENDER=2116]='SETGENDER',jt[jt.SETSKINCOLOUR=2117]='SETSKINCOLOUR',jt[jt.P_ANIMPROTECT=2118]='P_ANIMPROTECT',jt[jt.NPC_ADD=2500]='NPC_ADD',jt[jt.NPC_ANIM=2501]='NPC_ANIM',jt[jt.NPC_BASESTAT=2502]='NPC_BASESTAT',jt[jt.NPC_CATEGORY=2503]='NPC_CATEGORY',jt[jt.NPC_CHANGETYPE=2504]='NPC_CHANGETYPE',jt[jt.NPC_COORD=2505]='NPC_COORD',jt[jt.NPC_DAMAGE=2506]='NPC_DAMAGE',jt[jt.NPC_DEL=2507]='NPC_DEL',jt[jt.NPC_DELAY=2508]='NPC_DELAY',jt[jt.NPC_FACESQUARE=2509]='NPC_FACESQUARE',jt[jt.NPC_FIND=2510]='NPC_FIND',jt[jt.NPC_FINDALLANY=2511]='NPC_FINDALLANY',jt[jt.NPC_FINDEXACT=2512]='NPC_FINDEXACT',jt[jt.NPC_FINDHERO=2513]='NPC_FINDHERO',jt[jt.NPC_FINDALLZONE=2514]='NPC_FINDALLZONE',jt[jt.NPC_FINDNEXT=2515]='NPC_FINDNEXT',jt[jt.NPC_FINDUID=2516]='NPC_FINDUID',jt[jt.NPC_GETMODE=2517]='NPC_GETMODE',jt[jt.NPC_HEROPOINTS=2518]='NPC_HEROPOINTS',jt[jt.NPC_NAME=2519]='NPC_NAME',jt[jt.NPC_PARAM=2520]='NPC_PARAM',jt[jt.NPC_QUEUE=2521]='NPC_QUEUE',jt[jt.NPC_RANGE=2522]='NPC_RANGE',jt[jt.NPC_SAY=2523]='NPC_SAY',jt[jt.NPC_HUNTALL=2524]='NPC_HUNTALL',jt[jt.NPC_HUNTNEXT=2525]='NPC_HUNTNEXT',jt[jt.NPC_SETHUNT=2526]='NPC_SETHUNT',jt[jt.NPC_SETHUNTMODE=2527]='NPC_SETHUNTMODE',jt[jt.NPC_SETMODE=2528]='NPC_SETMODE',jt[jt.NPC_WALKTRIGGER=2529]='NPC_WALKTRIGGER',jt[jt.NPC_SETTIMER=2530]='NPC_SETTIMER',jt[jt.NPC_STAT=2531]='NPC_STAT',jt[jt.NPC_STATADD=2532]='NPC_STATADD',jt[jt.NPC_STATHEAL=2533]='NPC_STATHEAL',jt[jt.NPC_STATSUB=2534]='NPC_STATSUB',jt[jt.NPC_TELE=2535]='NPC_TELE',jt[jt.NPC_TYPE=2536]='NPC_TYPE',jt[jt.NPC_UID=2537]='NPC_UID',jt[jt.SPOTANIM_NPC=2538]='SPOTANIM_NPC',jt[jt.NPC_WALK=2539]='NPC_WALK',jt[jt.NPC_ATTACKRANGE=2540]='NPC_ATTACKRANGE',jt[jt.LOC_ADD=3e3]='LOC_ADD',jt[jt.LOC_ANGLE=3001]='LOC_ANGLE',jt[jt.LOC_ANIM=3002]='LOC_ANIM',jt[jt.LOC_CATEGORY=3003]='LOC_CATEGORY',jt[jt.LOC_CHANGE=3004]='LOC_CHANGE',jt[jt.LOC_COORD=3005]='LOC_COORD',jt[jt.LOC_DEL=3006]='LOC_DEL',jt[jt.LOC_FIND=3007]='LOC_FIND',jt[jt.LOC_FINDALLZONE=3008]='LOC_FINDALLZONE',jt[jt.LOC_FINDNEXT=3009]='LOC_FINDNEXT',jt[jt.LOC_NAME=3010]='LOC_NAME',jt[jt.LOC_PARAM=3011]='LOC_PARAM',jt[jt.LOC_SHAPE=3012]='LOC_SHAPE',jt[jt.LOC_TYPE=3013]='LOC_TYPE',jt[jt.OBJ_ADD=3500]='OBJ_ADD',jt[jt.OBJ_ADDALL=3501]='OBJ_ADDALL',jt[jt.OBJ_COORD=3502]='OBJ_COORD',jt[jt.OBJ_COUNT=3503]='OBJ_COUNT',jt[jt.OBJ_DEL=3504]='OBJ_DEL',jt[jt.OBJ_NAME=3505]='OBJ_NAME',jt[jt.OBJ_PARAM=3506]='OBJ_PARAM',jt[jt.OBJ_TAKEITEM=3507]='OBJ_TAKEITEM',jt[jt.OBJ_TYPE=3508]='OBJ_TYPE',jt[jt.NC_CATEGORY=4e3]='NC_CATEGORY',jt[jt.NC_DEBUGNAME=4001]='NC_DEBUGNAME',jt[jt.NC_DESC=4002]='NC_DESC',jt[jt.NC_NAME=4003]='NC_NAME',jt[jt.NC_OP=4004]='NC_OP',jt[jt.NC_PARAM=4005]='NC_PARAM',jt[jt.LC_CATEGORY=4100]='LC_CATEGORY',jt[jt.LC_DEBUGNAME=4101]='LC_DEBUGNAME',jt[jt.LC_DESC=4102]='LC_DESC',jt[jt.LC_NAME=4103]='LC_NAME',jt[jt.LC_OP=4104]='LC_OP',jt[jt.LC_PARAM=4105]='LC_PARAM',jt[jt.LC_WIDTH=4106]='LC_WIDTH',jt[jt.LC_LENGTH=4107]='LC_LENGTH',jt[jt.OC_CATEGORY=4200]='OC_CATEGORY',jt[jt.OC_CERT=4201]='OC_CERT',jt[jt.OC_COST=4202]='OC_COST',jt[jt.OC_DEBUGNAME=4203]='OC_DEBUGNAME',jt[jt.OC_DESC=4204]='OC_DESC',jt[jt.OC_IOP=4205]='OC_IOP',jt[jt.OC_MEMBERS=4206]='OC_MEMBERS',jt[jt.OC_NAME=4207]='OC_NAME',jt[jt.OC_OP=4208]='OC_OP',jt[jt.OC_PARAM=4209]='OC_PARAM',jt[jt.OC_STACKABLE=4210]='OC_STACKABLE',jt[jt.OC_TRADEABLE=4211]='OC_TRADEABLE',jt[jt.OC_UNCERT=4212]='OC_UNCERT',jt[jt.OC_WEARPOS2=4213]='OC_WEARPOS2',jt[jt.OC_WEARPOS3=4214]='OC_WEARPOS3',jt[jt.OC_WEARPOS=4215]='OC_WEARPOS',jt[jt.OC_WEIGHT=4216]='OC_WEIGHT',jt[jt.INV_ALLSTOCK=4300]='INV_ALLSTOCK',jt[jt.INV_SIZE=4301]='INV_SIZE',jt[jt.INV_STOCKBASE=4302]='INV_STOCKBASE',jt[jt.INV_ADD=4303]='INV_ADD',jt[jt.INV_CHANGESLOT=4304]='INV_CHANGESLOT',jt[jt.INV_CLEAR=4305]='INV_CLEAR',jt[jt.INV_DEL=4306]='INV_DEL',jt[jt.INV_DELSLOT=4307]='INV_DELSLOT',jt[jt.INV_DROPITEM=4308]='INV_DROPITEM',jt[jt.INV_DROPSLOT=4309]='INV_DROPSLOT',jt[jt.INV_FREESPACE=4310]='INV_FREESPACE',jt[jt.INV_GETNUM=4311]='INV_GETNUM',jt[jt.INV_GETOBJ=4312]='INV_GETOBJ',jt[jt.INV_ITEMSPACE=4313]='INV_ITEMSPACE',jt[jt.INV_ITEMSPACE2=4314]='INV_ITEMSPACE2',jt[jt.INV_MOVEFROMSLOT=4315]='INV_MOVEFROMSLOT',jt[jt.INV_MOVETOSLOT=4316]='INV_MOVETOSLOT',jt[jt.BOTH_MOVEINV=4317]='BOTH_MOVEINV',jt[jt.INV_MOVEITEM=4318]='INV_MOVEITEM',jt[jt.INV_MOVEITEM_CERT=4319]='INV_MOVEITEM_CERT',jt[jt.INV_MOVEITEM_UNCERT=4320]='INV_MOVEITEM_UNCERT',jt[jt.INV_SETSLOT=4321]='INV_SETSLOT',jt[jt.INV_TOTAL=4322]='INV_TOTAL',jt[jt.INV_TOTALCAT=4323]='INV_TOTALCAT',jt[jt.INV_TRANSMIT=4324]='INV_TRANSMIT',jt[jt.INVOTHER_TRANSMIT=4325]='INVOTHER_TRANSMIT',jt[jt.INV_STOPTRANSMIT=4326]='INV_STOPTRANSMIT',jt[jt.BOTH_DROPSLOT=4327]='BOTH_DROPSLOT',jt[jt.INV_DROPALL=4328]='INV_DROPALL',jt[jt.INV_TOTALPARAM=4329]='INV_TOTALPARAM',jt[jt.INV_TOTALPARAM_STACK=4330]='INV_TOTALPARAM_STACK',jt[jt.ENUM=4400]='ENUM',jt[jt.ENUM_GETOUTPUTCOUNT=4401]='ENUM_GETOUTPUTCOUNT',jt[jt.APPEND_NUM=4500]='APPEND_NUM',jt[jt.APPEND=4501]='APPEND',jt[jt.APPEND_SIGNNUM=4502]='APPEND_SIGNNUM',jt[jt.LOWERCASE=4503]='LOWERCASE',jt[jt.TEXT_GENDER=4504]='TEXT_GENDER',jt[jt.TOSTRING=4505]='TOSTRING',jt[jt.COMPARE=4506]='COMPARE',jt[jt.TEXT_SWITCH=4507]='TEXT_SWITCH',jt[jt.APPEND_CHAR=4508]='APPEND_CHAR',jt[jt.STRING_LENGTH=4509]='STRING_LENGTH',jt[jt.SUBSTRING=4510]='SUBSTRING',jt[jt.STRING_INDEXOF_CHAR=4511]='STRING_INDEXOF_CHAR',jt[jt.STRING_INDEXOF_STRING=4512]='STRING_INDEXOF_STRING',jt[jt.ADD=4600]='ADD',jt[jt.SUB=4601]='SUB',jt[jt.MULTIPLY=4602]='MULTIPLY',jt[jt.DIVIDE=4603]='DIVIDE',jt[jt.RANDOM=4604]='RANDOM',jt[jt.RANDOMINC=4605]='RANDOMINC',jt[jt.INTERPOLATE=4606]='INTERPOLATE',jt[jt.ADDPERCENT=4607]='ADDPERCENT',jt[jt.SETBIT=4608]='SETBIT',jt[jt.CLEARBIT=4609]='CLEARBIT',jt[jt.TESTBIT=4610]='TESTBIT',jt[jt.MODULO=4611]='MODULO',jt[jt.POW=4612]='POW',jt[jt.INVPOW=4613]='INVPOW',jt[jt.AND=4614]='AND',jt[jt.OR=4615]='OR',jt[jt.MIN=4616]='MIN',jt[jt.MAX=4617]='MAX',jt[jt.SCALE=4618]='SCALE',jt[jt.BITCOUNT=4619]='BITCOUNT',jt[jt.TOGGLEBIT=4620]='TOGGLEBIT',jt[jt.SETBIT_RANGE=4621]='SETBIT_RANGE',jt[jt.CLEARBIT_RANGE=4622]='CLEARBIT_RANGE',jt[jt.GETBIT_RANGE=4623]='GETBIT_RANGE',jt[jt.SETBIT_RANGE_TOINT=4624]='SETBIT_RANGE_TOINT',jt[jt.SIN_DEG=4625]='SIN_DEG',jt[jt.COS_DEG=4626]='COS_DEG',jt[jt.ATAN2_DEG=4627]='ATAN2_DEG',jt[jt.ABS=4628]='ABS',jt[jt.DB_FIND_WITH_COUNT=7500]='DB_FIND_WITH_COUNT',jt[jt.DB_FINDNEXT=7501]='DB_FINDNEXT',jt[jt.DB_GETFIELD=7502]='DB_GETFIELD',jt[jt.DB_GETFIELDCOUNT=7503]='DB_GETFIELDCOUNT',jt[jt.DB_LISTALL_WITH_COUNT=7504]='DB_LISTALL_WITH_COUNT',jt[jt.DB_GETROWTABLE=7505]='DB_GETROWTABLE',jt[jt.DB_FINDBYINDEX=7506]='DB_FINDBYINDEX',jt[jt.DB_FIND_REFINE_WITH_COUNT=7507]='DB_FIND_REFINE_WITH_COUNT',jt[jt.DB_FIND=7508]='DB_FIND',jt[jt.DB_FIND_REFINE=7509]='DB_FIND_REFINE',jt[jt.DB_LISTALL=7510]='DB_LISTALL',jt[jt.ERROR=1e4]='ERROR',jt[jt.MAP_LOCALDEV=10001]='MAP_LOCALDEV',jt[jt.MAP_LASTCLOCK=10002]='MAP_LASTCLOCK',jt[jt.MAP_LASTWORLD=10003]='MAP_LASTWORLD',jt[jt.MAP_LASTCLIENTIN=10004]='MAP_LASTCLIENTIN',jt[jt.MAP_LASTNPC=10005]='MAP_LASTNPC',jt[jt.MAP_LASTPLAYER=10006]='MAP_LASTPLAYER',jt[jt.MAP_LASTLOGOUT=10007]='MAP_LASTLOGOUT',jt[jt.MAP_LASTLOGIN=10008]='MAP_LASTLOGIN',jt[jt.MAP_LASTZONE=10009]='MAP_LASTZONE',jt[jt.MAP_LASTCLIENTOUT=10010]='MAP_LASTCLIENTOUT',jt[jt.MAP_LASTCLEANUP=10011]='MAP_LASTCLEANUP',jt[jt.MAP_LASTBANDWIDTHIN=10012]='MAP_LASTBANDWIDTHIN',jt[jt.MAP_LASTBANDWIDTHOUT=10013]='MAP_LASTBANDWIDTHOUT';var Jt=Kt;class $t{info={scriptName:'<unknown>',sourceFilePath:'<unknown>',lookupKey:-1,parameterTypes:[],pcs:[],lines:[]};id;intLocalCount=0;stringLocalCount=0;intArgCount=0;stringArgCount=0;switchTables=[];opcodes=[];intOperands=[];stringOperands=[];static isLargeOperand(t){if(t>100)return!1;switch(t){case Jt.RETURN:case Jt.POP_INT_DISCARD:case Jt.POP_STRING_DISCARD:case Jt.GOSUB:case Jt.JUMP:return!1}return!0}static decode(t,e){const n=e.data.length;if(n<16)throw new Error('Invalid script file (minimum length)');e.pos=n-2;const s=n-e.g2()-12-2;if(s<0||s>=n)throw new Error('Invalid script file (bad trailer pos)');e.pos=s;const i=new $t(t);e.g4();i.intLocalCount=e.g2(),i.stringLocalCount=e.g2(),i.intArgCount=e.g2(),i.stringArgCount=e.g2();const a=e.g1();for(let t=0;t<a;t++){const n=e.g2(),s=[];for(let t=0;t<n;t++){const t=e.g4(),n=e.g4();s[t]=n}i.switchTables[t]=s}e.pos=0,i.info.scriptName=e.gjstr(0),i.info.sourceFilePath=e.gjstr(0),i.info.lookupKey=e.g4();const r=e.g1();for(let t=0;t<r;t++)i.info.parameterTypes.push(e.g1());const o=e.g2();for(let t=0;t<o;t++)i.info.pcs.push(e.g4()),i.info.lines.push(e.g4());let c=0;for(;s>e.pos;){const t=e.g2();t===Jt.PUSH_CONSTANT_STRING?i.stringOperands[c]=e.gjstr(0):$t.isLargeOperand(t)?i.intOperands[c]=e.g4():i.intOperands[c]=e.g1(),i.opcodes[c++]=t}return i}constructor(t){this.id=t}get name(){return this.info.scriptName}get fileName(){return Zt.basename(this.info.sourceFilePath)}lineNumber(t){for(let e=0;e<this.info.pcs.length;e++)if(this.info.pcs[e]>t)return this.info.lines[e-1];return this.info.lines[this.info.lines.length-1]}}class Xt{static COMPILER_VERSION=18;static scripts=[];static scriptLookup=new Map;static scriptNames=new Map;static async load(t){const e=await E.load(`${t}/server/script.dat`),n=await E.load(`${t}/server/script.idx`);e.data.length&&n.data.length||(console.log('\nFatal: No script.dat or script.idx found. Please run the server:build script.'),process.exit(1));const s=e.g2();n.pos+=2;e.g4()!==Xt.COMPILER_VERSION&&(console.error('\nFatal: Scripts were compiled with an older RuneScript compiler. Please update it, try `npm run build` and then restart the server.'),process.exit(1));const i=new Array(s),a=new Map,r=new Map;let o=0;for(let t=0;t<s;t++){const s=n.g2();if(0!==s)try{const n=new Uint8Array(s);e.gdata(n,0,n.length);const c=$t.decode(t,new E(n));i[t]=c,a.set(c.name,t),4294967295!==c.info.lookupKey&&r.set(c.info.lookupKey,c),o++}catch(e){return console.error(e),console.error(`Warning: Failed to load script ${t}, something may have been partially written`),-1}}return Xt.scripts=i,Xt.scriptNames=a,Xt.scriptLookup=r,o}static get(t){return this.scripts[t]}static getByName(t){const e=Xt.scriptNames.get(t);if(void 0!==e)return Xt.scripts[e]}static getByTrigger(t,e=-1,n=-1){let s=Xt.scriptLookup.get(512|t|e<<10);return s||(s=Xt.scriptLookup.get(256|t|n<<10),s||Xt.scriptLookup.get(t))}static getByTriggerSpecific(t,e=-1,n=-1){return-1!==e?Xt.scriptLookup.get(512|t|e<<10):-1!==n?Xt.scriptLookup.get(256|t|n<<10):Xt.scriptLookup.get(t)}}function Qt(t){return 0|t}function qt(t,e,n){return t&~(te[n-e+1]<<e)}var te=function(){const t=[0];let e=2;for(let n=1;n<33;++n)t[n]=Qt(e-1),e+=e;return t}();class ee{static ABORTED=-1;static RUNNING=0;static FINISHED=1;static SUSPENDED=2;static PAUSEBUTTON=3;static COUNTDIALOG=4;static NPC_SUSPENDED=5;static WORLD_SUSPENDED=6;script;trigger;execution=ee.RUNNING;executionHistory=[];pc=-1;opcount=0;frames=[];fp=0;debugFrames=[];debugFp=0;intStack=[];isp=0;stringStack=[];ssp=0;intLocals=[];stringLocals=[];pointers=0;self=null;_activePlayer=null;_activePlayer2=null;_activeNpc=null;_activeNpc2=null;_activeLoc=null;_activeLoc2=null;_activeObj=null;_activeObj2=null;splitPages=[];splitMesanim=-1;dbTable=null;dbColumn=-1;dbRow=-1;dbRowQuery=[];huntIterator=null;npcIterator=null;locIterator=null;lastInt=0;constructor(t,e=[]){if(this.script=t,this.trigger=255&t.info.lookupKey,e)for(let t=0;t<e.length;t++){const n=e[t];'number'==typeof n?this.intLocals.push(n):this.stringLocals.push(n)}}pointerSet(...t){this.pointers=0;for(let e=0;e<t.length;e++)this.pointers|=1<<t[e]}pointerAdd(t){this.pointers|=1<<t}pointerRemove(t){this.pointers&=~(1<<t)}pointerGet(t){return!!(this.pointers&1<<t)}pointerCheck(...t){for(let e=0;e<t.length;e++){const n=1<<t[e];if((this.pointers&n)!=n)throw new Error(`Required pointer: ${ee.pointerPrint(n)}, current: ${ee.pointerPrint(this.pointers)}`)}}static pointerPrint(t){let e='';for(let n=0;n<Mt._LAST;n++)t&1<<n&&(e+=`${Mt[n]}, `);return e.substring(0,e.lastIndexOf(','))}get activePlayer(){const t=0===this.intOperand?this._activePlayer:this._activePlayer2;if(null===t)throw new Error('Attempt to access null active_player');return t}set activePlayer(t){0===this.intOperand?this._activePlayer=t:this._activePlayer2=t}get activeNpc(){const t=0===this.intOperand?this._activeNpc:this._activeNpc2;if(null===t)throw new Error('Attempt to access null active_npc');return t}set activeNpc(t){0===this.intOperand?this._activeNpc=t:this._activeNpc2=t}get activeLoc(){const t=0===this.intOperand?this._activeLoc:this._activeLoc2;if(null===t)throw new Error('Attempt to access null active_loc');return t}set activeLoc(t){0===this.intOperand?this._activeLoc=t:this._activeLoc2=t}get activeObj(){const t=0===this.intOperand?this._activeObj:this._activeObj2;if(null===t)throw new Error('Attempt to access null active_obj');return t}set activeObj(t){0===this.intOperand?this._activeObj=t:this._activeObj2=t}get intOperand(){return this.script.intOperands[this.pc]}get stringOperand(){return this.script.stringOperands[this.pc]}popInt(){const t=this.intStack[--this.isp];return t?Qt(t):0}popInts(t){const e=Array(t);for(let n=t-1;n>=0;n--)e[n]=this.popInt();return e}pushInt(t){this.intStack[this.isp++]=Qt(t)}popString(){return this.stringStack[--this.ssp]??''}popStrings(t){const e=Array(t);for(let n=t-1;n>=0;n--)e[n]=this.popString();return e}pushString(t){this.stringStack[this.ssp++]=t}reset(){this.pc=-1,this.frames=[],this.fp=0,this.intStack=[],this.isp=0,this.stringStack=[],this.ssp=0,this.intLocals=[],this.stringLocals=[],this.pointers=0}}class ne{requested=0;completed=0;items=[];constructor(t,e=0,n=[]){this.requested=t,this.completed=e,this.items=n}getLeftOver(){return this.requested-this.completed}hasSucceeded(){return this.completed==this.requested}hasFailed(){return!this.hasSucceeded()}revert(t){for(let e=0;e<this.items.length;e++){const n=this.items[e].item;t.remove(n.id,n.count,this.items[e].slot)}}}class se{static STACK_LIMIT=2147483647;static NORMAL_STACK=0;static ALWAYS_STACK=1;static NEVER_STACK=2;static fromType(t){if(-1===t)throw new Error('Invalid inventory type');const e=J.get(t);let n=se.NORMAL_STACK;e.stackall&&(n=se.ALWAYS_STACK);const s=new se(e.size,n);if(s.type=t,e.stockobj&&e.stockcount&&e.stockobj.length)for(let t=0;t<e.stockobj.length;t++)s.set(t,{id:e.stockobj[t],count:e.stockcount[t]});return s}stackType=se.NORMAL_STACK;capacity=0;items=[];update=!1;type=-1;constructor(t,e=se.NORMAL_STACK){this.capacity=t,this.stackType=e;for(let e=0;e<t;e++)this.items.push(null)}contains(t){return this.items.some((e=>e&&e.id==t))}hasAt(t,e){const n=this.items[t];return n&&n.id==e}get nextFreeSlot(){return this.items.indexOf(null,0)}get freeSlotCount(){return this.items.filter((t=>null==t)).length}get occupiedSlotCount(){return this.items.filter((t=>null!=t)).length}get isFull(){return this.occupiedSlotCount==this.capacity}get isEmpty(){return 0==this.occupiedSlotCount}get hasAny(){return this.items.some((t=>null!=t))}get hasSpace(){return-1!=this.nextFreeSlot}get itemsFiltered(){return this.items.filter((t=>null!=t))}getItemCount(t){let e=0;for(let n=0;n<this.capacity;n++){const s=this.items[n];s&&s.id==t&&(e+=s.count)}return Math.min(se.STACK_LIMIT,e)}getItemIndex(t){return this.items.findIndex((e=>e&&e.id==t))}removeAll(){this.items.fill(null,0,this.capacity),this.update=!0}add(t,e=1,n=-1,s=!0,i=!1,a=!1){const r=ut.get(t),o=!0===J.get(this.type).stockobj?.includes(t),c=!i&&this.stackType!=se.NEVER_STACK&&(r.stackable||this.stackType==se.ALWAYS_STACK);let l=0;if(c&&(l=this.getItemCount(t)),l==se.STACK_LIMIT)return new ne(e,0,[]);const h=this.freeSlotCount;if(0==h&&(!c||c&&0==l&&!o))return new ne(e,0,[]);if(s){if(c&&l>se.STACK_LIMIT-e)return new ne(e,0,[]);if(!c&&e>h)return new ne(e,0,[])}else{if(c&&l==se.STACK_LIMIT)return new ne(e,0,[]);if(!c&&0==h)return new ne(e,0,[])}let d=0;const p=[];if(c){let s=this.getItemIndex(t);if(-1==s&&(s=-1==n?this.nextFreeSlot:this.items.indexOf(null,n),-1==s))return new ne(e,d,[]);const i=this.get(s)?.count??0,r=Math.min(se.STACK_LIMIT,i+e),o={id:t,count:r};a||this.set(s,o),p.push({slot:s,item:o}),d=r-i}else{for(let s=Math.max(0,n);s<this.capacity;s++){if(null!=this.items[s])continue;const n={id:t,count:1};if(a||this.set(s,n),p.push({slot:s,item:n}),++d>=e)break}}return new ne(e,d,p)}remove(t,e=1,n=-1,s=!1){const i=this.getItemCount(t),a=!0===J.get(this.type).stockobj?.includes(t);if(s&&i<e)return new ne(e,0,[]);if(!s&&i<1)return new ne(e,0,[]);let r=0;const o=[];let c=null;if(-1!=n){c=[];for(let t=0;t<n;t++)c.push(t)}let l=0;-1!=n&&(l=n);for(let n=l;n<this.capacity;n++){const s=this.items[n];if(!s||s.id!=t)continue;const i=Math.min(s.count,e-r);if(r+=i,s.count-=i,0==s.count&&!a){const t=this.items[n];this.items[n]=null,t&&o.push({slot:n,item:t})}if(r>=e)break}if(null!=c&&r<e)for(let n=0;n<c.length;n++){const s=this.items[n];if(!s||s.id!=t)continue;const i=Math.min(s.count,e-r);if(r+=i,s.count-=i,0==s.count&&!a){const t=this.items[n];this.items[n]=null,t&&o.push({slot:n,item:t})}if(r>=e)break}return r>0&&(this.update=!0),new ne(e,r,o)}delete(t){this.items[t]=null,this.update=!0}swap(t,e){const n=this.items[t];this.set(t,this.items[e]),this.set(e,n)}shift(){this.items=this.items.sort(((t,e)=>null===t||null===e?+(null===t)-+(null===e):+(t>e)||-(t<e))),this.update=!0}get(t){return this.items[t]}set(t,e){this.items[t]=e,this.update=!0}validSlot(t){return t>=0&&t<this.capacity}transfer(t,e,n=-1,s=-1,i=!1,a=!1){if(e.count<=0)return null;const r=Math.min(e.count,this.getItemCount(e.id)),o=ut.get(e.id);let c={id:e.id,count:r};(i&&-1!==o.certlink&&-1===o.certtemplate||a&&-1!==o.certlink&&o.certtemplate>=0)&&(c={id:o.certlink,count:r});const l=t.add(c.id,c.count,s,!1);if(0==l.completed)return null;const h=this.remove(e.id,l.completed,n,!1);return 0==h.completed?null:h}}async function ie(t,e={}){const n={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,n,s){t=o(t>>>0),e=o(e>>>0),n>>>=0,s>>>=0,(()=>{throw Error(`${t} in ${e}:${n}:${s}`)})()},seed:()=>Date.now()*Math.random()})},{exports:s}=await WebAssembly.instantiate(t,n),i=s.memory||e.env.memory,a=Object.setPrototypeOf({findPath(t,e,n,i,a,r,o,l,d,p,_,u,g,m){return _=_?1:0,s.__setArgumentsLength(arguments.length),c(h,2,s.findPath(t,e,n,i,a,r,o,l,d,p,_,u,g,m)>>>0)},findNaivePath(t,e,n,i,a,r,o,l,d,p,_){return s.__setArgumentsLength(arguments.length),c(h,2,s.findNaivePath(t,e,n,i,a,r,o,l,d,p,_)>>>0)},changeFloor(t,e,n,i){i=i?1:0,s.changeFloor(t,e,n,i)},changeLoc(t,e,n,i,a,r,o,c){r=r?1:0,o=o?1:0,c=c?1:0,s.changeLoc(t,e,n,i,a,r,o,c)},changeNpc(t,e,n,i,a){a=a?1:0,s.changeNpc(t,e,n,i,a)},changePlayer(t,e,n,i,a){a=a?1:0,s.changePlayer(t,e,n,i,a)},changeRoof(t,e,n,i){i=i?1:0,s.changeRoof(t,e,n,i)},changeWall(t,e,n,i,a,r,o,c){r=r?1:0,o=o?1:0,c=c?1:0,s.changeWall(t,e,n,i,a,r,o,c)},allocateIfAbsent:(t,e,n)=>c(h,2,s.allocateIfAbsent(t,e,n)>>>0),isZoneAllocated:(t,e,n)=>0!=s.isZoneAllocated(t,e,n),isFlagged:(t,e,n,i)=>0!=s.isFlagged(t,e,n,i),canTravel(t,e,n,i,a,r,o,c){return s.__setArgumentsLength(arguments.length),0!=s.canTravel(t,e,n,i,a,r,o,c)},hasLineOfSight(t,e,n,i,a,r,o,c,l,h){return s.__setArgumentsLength(arguments.length),0!=s.hasLineOfSight(t,e,n,i,a,r,o,c,l,h)},hasLineOfWalk(t,e,n,i,a,r,o,c,l,h){return s.__setArgumentsLength(arguments.length),0!=s.hasLineOfWalk(t,e,n,i,a,r,o,c,l,h)},lineOfSight(t,e,n,i,a,r,o,l,d,p){return s.__setArgumentsLength(arguments.length),c(h,2,s.lineOfSight(t,e,n,i,a,r,o,l,d,p)>>>0)},lineOfWalk(t,e,n,i,a,r,o,l,d,p){return s.__setArgumentsLength(arguments.length),c(h,2,s.lineOfWalk(t,e,n,i,a,r,o,l,d,p)>>>0)},reached(t,e,n,i,a,r,o,c,l,h,d){return s.__setArgumentsLength(arguments.length),0!=s.reached(t,e,n,i,a,r,o,c,l,h,d)},__collides:(t,e,n,i,a,r,o,c)=>0!=s.__collides(t,e,n,i,a,r,o,c),__reachRectangle1:(t,e,n,i,a,r,o,c)=>0!=s.__reachRectangle1(t,e,n,i,a,r,o,c),__reachRectangleN:(t,e,n,i,a,r,o,c,l,h)=>0!=s.__reachRectangleN(t,e,n,i,a,r,o,c,l,h),__reachRectangle:(t,e,n,i,a,r,o,c,l,h)=>0!=s.__reachRectangle(t,e,n,i,a,r,o,c,l,h),__reachExclusiveRectangle:(t,e,n,i,a,r,o,c,l,h)=>0!=s.__reachExclusiveRectangle(t,e,n,i,a,r,o,c,l,h),CollisionFlag:(r={},r[r.NULL=s['CollisionFlag.NULL'].valueOf()]='NULL',r[r.OPEN=s['CollisionFlag.OPEN'].valueOf()]='OPEN',r[r.WALL_NORTH_WEST=s['CollisionFlag.WALL_NORTH_WEST'].valueOf()]='WALL_NORTH_WEST',r[r.WALL_NORTH=s['CollisionFlag.WALL_NORTH'].valueOf()]='WALL_NORTH',r[r.WALL_NORTH_EAST=s['CollisionFlag.WALL_NORTH_EAST'].valueOf()]='WALL_NORTH_EAST',r[r.WALL_EAST=s['CollisionFlag.WALL_EAST'].valueOf()]='WALL_EAST',r[r.WALL_SOUTH_EAST=s['CollisionFlag.WALL_SOUTH_EAST'].valueOf()]='WALL_SOUTH_EAST',r[r.WALL_SOUTH=s['CollisionFlag.WALL_SOUTH'].valueOf()]='WALL_SOUTH',r[r.WALL_SOUTH_WEST=s['CollisionFlag.WALL_SOUTH_WEST'].valueOf()]='WALL_SOUTH_WEST',r[r.WALL_WEST=s['CollisionFlag.WALL_WEST'].valueOf()]='WALL_WEST',r[r.LOC=s['CollisionFlag.LOC'].valueOf()]='LOC',r[r.WALL_NORTH_WEST_PROJ_BLOCKER=s['CollisionFlag.WALL_NORTH_WEST_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_WEST_PROJ_BLOCKER',r[r.WALL_NORTH_PROJ_BLOCKER=s['CollisionFlag.WALL_NORTH_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_PROJ_BLOCKER',r[r.WALL_NORTH_EAST_PROJ_BLOCKER=s['CollisionFlag.WALL_NORTH_EAST_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_EAST_PROJ_BLOCKER',r[r.WALL_EAST_PROJ_BLOCKER=s['CollisionFlag.WALL_EAST_PROJ_BLOCKER'].valueOf()]='WALL_EAST_PROJ_BLOCKER',r[r.WALL_SOUTH_EAST_PROJ_BLOCKER=s['CollisionFlag.WALL_SOUTH_EAST_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_EAST_PROJ_BLOCKER',r[r.WALL_SOUTH_PROJ_BLOCKER=s['CollisionFlag.WALL_SOUTH_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_PROJ_BLOCKER',r[r.WALL_SOUTH_WEST_PROJ_BLOCKER=s['CollisionFlag.WALL_SOUTH_WEST_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_WEST_PROJ_BLOCKER',r[r.WALL_WEST_PROJ_BLOCKER=s['CollisionFlag.WALL_WEST_PROJ_BLOCKER'].valueOf()]='WALL_WEST_PROJ_BLOCKER',r[r.LOC_PROJ_BLOCKER=s['CollisionFlag.LOC_PROJ_BLOCKER'].valueOf()]='LOC_PROJ_BLOCKER',r[r.FLOOR_DECORATION=s['CollisionFlag.FLOOR_DECORATION'].valueOf()]='FLOOR_DECORATION',r[r.NPC=s['CollisionFlag.NPC'].valueOf()]='NPC',r[r.PLAYER=s['CollisionFlag.PLAYER'].valueOf()]='PLAYER',r[r.FLOOR=s['CollisionFlag.FLOOR'].valueOf()]='FLOOR',r[r.WALL_NORTH_WEST_ROUTE_BLOCKER=s['CollisionFlag.WALL_NORTH_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_WEST_ROUTE_BLOCKER',r[r.WALL_NORTH_ROUTE_BLOCKER=s['CollisionFlag.WALL_NORTH_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_ROUTE_BLOCKER',r[r.WALL_NORTH_EAST_ROUTE_BLOCKER=s['CollisionFlag.WALL_NORTH_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_EAST_ROUTE_BLOCKER',r[r.WALL_EAST_ROUTE_BLOCKER=s['CollisionFlag.WALL_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_EAST_ROUTE_BLOCKER',r[r.WALL_SOUTH_EAST_ROUTE_BLOCKER=s['CollisionFlag.WALL_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_EAST_ROUTE_BLOCKER',r[r.WALL_SOUTH_ROUTE_BLOCKER=s['CollisionFlag.WALL_SOUTH_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_ROUTE_BLOCKER',r[r.WALL_SOUTH_WEST_ROUTE_BLOCKER=s['CollisionFlag.WALL_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_WEST_ROUTE_BLOCKER',r[r.WALL_WEST_ROUTE_BLOCKER=s['CollisionFlag.WALL_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_WEST_ROUTE_BLOCKER',r[r.LOC_ROUTE_BLOCKER=s['CollisionFlag.LOC_ROUTE_BLOCKER'].valueOf()]='LOC_ROUTE_BLOCKER',r[r.ROOF=s['CollisionFlag.ROOF'].valueOf()]='ROOF',r[r.FLOOR_BLOCKED=s['CollisionFlag.FLOOR_BLOCKED'].valueOf()]='FLOOR_BLOCKED',r[r.WALK_BLOCKED=s['CollisionFlag.WALK_BLOCKED'].valueOf()]='WALK_BLOCKED',r[r.BLOCK_WEST=s['CollisionFlag.BLOCK_WEST'].valueOf()]='BLOCK_WEST',r[r.BLOCK_EAST=s['CollisionFlag.BLOCK_EAST'].valueOf()]='BLOCK_EAST',r[r.BLOCK_SOUTH=s['CollisionFlag.BLOCK_SOUTH'].valueOf()]='BLOCK_SOUTH',r[r.BLOCK_NORTH=s['CollisionFlag.BLOCK_NORTH'].valueOf()]='BLOCK_NORTH',r[r.BLOCK_SOUTH_WEST=s['CollisionFlag.BLOCK_SOUTH_WEST'].valueOf()]='BLOCK_SOUTH_WEST',r[r.BLOCK_SOUTH_EAST=s['CollisionFlag.BLOCK_SOUTH_EAST'].valueOf()]='BLOCK_SOUTH_EAST',r[r.BLOCK_NORTH_WEST=s['CollisionFlag.BLOCK_NORTH_WEST'].valueOf()]='BLOCK_NORTH_WEST',r[r.BLOCK_NORTH_EAST=s['CollisionFlag.BLOCK_NORTH_EAST'].valueOf()]='BLOCK_NORTH_EAST',r[r.BLOCK_NORTH_AND_SOUTH_EAST=s['CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST'].valueOf()]='BLOCK_NORTH_AND_SOUTH_EAST',r[r.BLOCK_NORTH_AND_SOUTH_WEST=s['CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST'].valueOf()]='BLOCK_NORTH_AND_SOUTH_WEST',r[r.BLOCK_NORTH_EAST_AND_WEST=s['CollisionFlag.BLOCK_NORTH_EAST_AND_WEST'].valueOf()]='BLOCK_NORTH_EAST_AND_WEST',r[r.BLOCK_SOUTH_EAST_AND_WEST=s['CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST'].valueOf()]='BLOCK_SOUTH_EAST_AND_WEST',r[r.BLOCK_WEST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_WEST_ROUTE_BLOCKER',r[r.BLOCK_EAST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_EAST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_SOUTH_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_ROUTE_BLOCKER',r[r.BLOCK_NORTH_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_NORTH_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_WEST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_EAST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_WEST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_NORTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_EAST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_NORTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER=s['CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER',r),LocShape:(t=>(t[t.WALL_STRAIGHT=s['LocShape.WALL_STRAIGHT'].valueOf()]='WALL_STRAIGHT',t[t.WALL_DIAGONAL_CORNER=s['LocShape.WALL_DIAGONAL_CORNER'].valueOf()]='WALL_DIAGONAL_CORNER',t[t.WALL_L=s['LocShape.WALL_L'].valueOf()]='WALL_L',t[t.WALL_SQUARE_CORNER=s['LocShape.WALL_SQUARE_CORNER'].valueOf()]='WALL_SQUARE_CORNER',t[t.WALLDECOR_STRAIGHT_NOOFFSET=s['LocShape.WALLDECOR_STRAIGHT_NOOFFSET'].valueOf()]='WALLDECOR_STRAIGHT_NOOFFSET',t[t.WALLDECOR_STRAIGHT_OFFSET=s['LocShape.WALLDECOR_STRAIGHT_OFFSET'].valueOf()]='WALLDECOR_STRAIGHT_OFFSET',t[t.WALLDECOR_DIAGONAL_OFFSET=s['LocShape.WALLDECOR_DIAGONAL_OFFSET'].valueOf()]='WALLDECOR_DIAGONAL_OFFSET',t[t.WALLDECOR_DIAGONAL_NOOFFSET=s['LocShape.WALLDECOR_DIAGONAL_NOOFFSET'].valueOf()]='WALLDECOR_DIAGONAL_NOOFFSET',t[t.WALLDECOR_DIAGONAL_BOTH=s['LocShape.WALLDECOR_DIAGONAL_BOTH'].valueOf()]='WALLDECOR_DIAGONAL_BOTH',t[t.WALL_DIAGONAL=s['LocShape.WALL_DIAGONAL'].valueOf()]='WALL_DIAGONAL',t[t.CENTREPIECE_STRAIGHT=s['LocShape.CENTREPIECE_STRAIGHT'].valueOf()]='CENTREPIECE_STRAIGHT',t[t.CENTREPIECE_DIAGONAL=s['LocShape.CENTREPIECE_DIAGONAL'].valueOf()]='CENTREPIECE_DIAGONAL',t[t.ROOF_STRAIGHT=s['LocShape.ROOF_STRAIGHT'].valueOf()]='ROOF_STRAIGHT',t[t.ROOF_DIAGONAL_WITH_ROOFEDGE=s['LocShape.ROOF_DIAGONAL_WITH_ROOFEDGE'].valueOf()]='ROOF_DIAGONAL_WITH_ROOFEDGE',t[t.ROOF_DIAGONAL=s['LocShape.ROOF_DIAGONAL'].valueOf()]='ROOF_DIAGONAL',t[t.ROOF_L_CONCAVE=s['LocShape.ROOF_L_CONCAVE'].valueOf()]='ROOF_L_CONCAVE',t[t.ROOF_L_CONVEX=s['LocShape.ROOF_L_CONVEX'].valueOf()]='ROOF_L_CONVEX',t[t.ROOF_FLAT=s['LocShape.ROOF_FLAT'].valueOf()]='ROOF_FLAT',t[t.ROOFEDGE_STRAIGHT=s['LocShape.ROOFEDGE_STRAIGHT'].valueOf()]='ROOFEDGE_STRAIGHT',t[t.ROOFEDGE_DIAGONAL_CORNER=s['LocShape.ROOFEDGE_DIAGONAL_CORNER'].valueOf()]='ROOFEDGE_DIAGONAL_CORNER',t[t.ROOFEDGE_L=s['LocShape.ROOFEDGE_L'].valueOf()]='ROOFEDGE_L',t[t.ROOFEDGE_SQUARE_CORNER=s['LocShape.ROOFEDGE_SQUARE_CORNER'].valueOf()]='ROOFEDGE_SQUARE_CORNER',t[t.GROUND_DECOR=s['LocShape.GROUND_DECOR'].valueOf()]='GROUND_DECOR',t))({}),LocAngle:(t=>(t[t.WEST=s['LocAngle.WEST'].valueOf()]='WEST',t[t.NORTH=s['LocAngle.NORTH'].valueOf()]='NORTH',t[t.EAST=s['LocAngle.EAST'].valueOf()]='EAST',t[t.SOUTH=s['LocAngle.SOUTH'].valueOf()]='SOUTH',t))({}),CollisionType:(t=>(t[t.NORMAL=s['CollisionType.NORMAL'].valueOf()]='NORMAL',t[t.BLOCKED=s['CollisionType.BLOCKED'].valueOf()]='BLOCKED',t[t.INDOORS=s['CollisionType.INDOORS'].valueOf()]='INDOORS',t[t.OUTDOORS=s['CollisionType.OUTDOORS'].valueOf()]='OUTDOORS',t[t.LINE_OF_SIGHT=s['CollisionType.LINE_OF_SIGHT'].valueOf()]='LINE_OF_SIGHT',t))({}),LocLayer:(t=>(t[t.WALL=s['LocLayer.WALL'].valueOf()]='WALL',t[t.WALL_DECOR=s['LocLayer.WALL_DECOR'].valueOf()]='WALL_DECOR',t[t.GROUND=s['LocLayer.GROUND'].valueOf()]='GROUND',t[t.GROUND_DECOR=s['LocLayer.GROUND_DECOR'].valueOf()]='GROUND_DECOR',t))({}),BlockAccessFlag:(t=>(t[t.BLOCK_NORTH=s['BlockAccessFlag.BLOCK_NORTH'].valueOf()]='BLOCK_NORTH',t[t.BLOCK_EAST=s['BlockAccessFlag.BLOCK_EAST'].valueOf()]='BLOCK_EAST',t[t.BLOCK_SOUTH=s['BlockAccessFlag.BLOCK_SOUTH'].valueOf()]='BLOCK_SOUTH',t[t.BLOCK_WEST=s['BlockAccessFlag.BLOCK_WEST'].valueOf()]='BLOCK_WEST',t))({})},s);var r;function o(t){if(!t)return null;const e=t+new Uint32Array(i.buffer)[t-4>>>2]>>>1,n=new Uint16Array(i.buffer);let s=t>>>1,a='';for(;e-s>1024;)a+=String.fromCharCode(...n.subarray(s,s+=1024));return a+String.fromCharCode(...n.subarray(s,e))}function c(t,e,n){if(!n)return null;const s=function(t){try{return l.getUint32(t,!0)}catch{return l=new DataView(i.buffer),l.getUint32(t,!0)}}(n-4)>>>e,a=new Array(s);for(let i=0;i<s;++i)a[i]=t(n+(i<<e>>>0));return a}let l=new DataView(i.buffer);function h(t){try{return l.getInt32(t,!0)}catch{return l=new DataView(i.buffer),l.getInt32(t,!0)}}return a}var ae,re,{memory:oe,findPath:ce,findNaivePath:le,changeFloor:he,changeLoc:de,changeNpc:pe,changePlayer:_e,changeRoof:ue,changeWall:ge,allocateIfAbsent:me,deallocateIfPresent:Ee,isZoneAllocated:Oe,isFlagged:fe,canTravel:Ae,hasLineOfSight:Te,hasLineOfWalk:Ie,lineOfSight:Ne,lineOfWalk:Pe,reached:Le,locShapeLayer:Se,__get:Ce,__set:ye,__add:ve,__remove:we,__rotate:Re,__rotateFlags:be,__collides:Ue,__reachRectangle1:De,__reachRectangleN:Me,__alteredRotation:ke,__reachRectangle:xe,__reachExclusiveRectangle:Be,CollisionFlag:He,LocShape:Fe,LocAngle:Ge,CollisionType:We,LocLayer:ze,BlockAccessFlag:Ve}=await(async t=>ie(await(async()=>{try{return await globalThis.WebAssembly.compileStreaming(globalThis.fetch(t))}catch{return globalThis.WebAssembly.compile(await(await import('node:fs/promises')).readFile(t))}})(),{}))(new URL('rsmod-pathfinder.wasm',import.meta.url)),Ye=0,Ke=1,je=2,Ze=3,Je=4,$e=5,Xe=6,Qe=7,qe={zone:t=>t>>3,zoneCenter:t=>qe.zone(t)-6,zoneOrigin:t=>qe.zoneCenter(t)<<3,mapsquare:t=>t>>6,local:t=>t-(qe.zoneCenter(t)<<3),localOrigin:t=>t-(qe.mapsquare(t)<<6),zoneUpdate:t=>t-(t>>3<<3),face:(t,e,n,s)=>t!=n?t>n?e>s?$e:e<s?Ye:Ze:e>s?Qe:e<s?je:Je:e>s?Xe:e<s?Ke:-1,moveX:(t,e)=>t+qe.deltaX(e),moveZ:(t,e)=>t+qe.deltaZ(e),distanceTo(t,e){const n=qe.closest(t,e),s=qe.closest(e,t);return Math.max(Math.abs(n.x-s.x),Math.abs(n.z-s.z))},closest(t,e){const n=t.x+t.width-1,s=t.z+t.length-1;return{x:e.x<=t.x?t.x:e.x>=n?n:e.x,z:e.z<=t.z?t.z:e.z>=s?s:e.z}},distanceToSW(t,e){const n=Math.abs(t.x-e.x),s=Math.abs(t.z-e.z);return Math.max(n,s)},isWithinDistanceSW(t,e,n){const s=Math.abs(t.x-e.x);return Math.abs(t.z-e.z)<n&&s<n},deltaX(t){switch(t){case Qe:case je:case Je:return 1;case $e:case Ye:case Ze:return-1}return 0},deltaZ(t){switch(t){case Ye:case je:case Ke:return 1;case $e:case Qe:case Xe:return-1}return 0},unpackCoord:t=>({level:t>>28&3,x:t>>14&16383,z:16383&t}),packCoord:(t,e,n)=>16383&n|(16383&e)<<14|(3&t)<<28,packZoneCoord:(t,e)=>(7&t)<<4|7&e,intersects:(t,e,n,s,i,a,r,o)=>!(i>=t+n||i+r<=t||a>=e+s||a+o<=e),formatString:(t,e,n,s="_")=>t+s+(e>>6)+s+(n>>6)+s+(63&e)+s+(63&n)};(re=ae||={})[re.BLOCK=0]='BLOCK',re[re.DAMAGE=1]='DAMAGE',re[re.POISON=2]='POISON';var tn,en,nn=ae;(en=tn||={})[en.ATTACK=0]='ATTACK',en[en.DEFENCE=1]='DEFENCE',en[en.STRENGTH=2]='STRENGTH',en[en.HITPOINTS=3]='HITPOINTS',en[en.RANGED=4]='RANGED',en[en.PRAYER=5]='PRAYER',en[en.MAGIC=6]='MAGIC',en[en.COOKING=7]='COOKING',en[en.WOODCUTTING=8]='WOODCUTTING',en[en.FLETCHING=9]='FLETCHING',en[en.FISHING=10]='FISHING',en[en.FIREMAKING=11]='FIREMAKING',en[en.CRAFTING=12]='CRAFTING',en[en.SMITHING=13]='SMITHING',en[en.MINING=14]='MINING',en[en.HERBLORE=15]='HERBLORE',en[en.AGILITY=16]='AGILITY',en[en.THIEVING=17]='THIEVING',en[en.STAT18=18]='STAT18',en[en.STAT19=19]='STAT19',en[en.RUNECRAFT=20]='RUNECRAFT';var sn=tn;function an(t,e){return e.validate(t)}class rn{type;count;name;constructor(t,e,n){this.type=t,this.count=e,this.name=n}validate(t){if(this.count(t))return this.type(t);throw new Error(`An input for a ${this.name} type was not valid to use. Input was ${t}.`)}}class on{min;max;name;constructor(t,e,n){this.min=t,this.max=e,this.name=n}validate(t){if(t>=this.min&&t<=this.max)return t;throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${t}.`)}}var cn,ln,hn=new class{validate(t){if(-1!==t)return t;throw Error('An input number was null(-1).')}},dn=new class{validate(t){if(t.length>0)return t;throw Error('An input string was null(-1).')}},pn=new rn(et.get,(t=>t>=0&&t<et.count),'Loc'),_n=new on(Ge.WEST,Ge.SOUTH,'LocAngle'),un=new on(Fe.WALL_STRAIGHT,Fe.GROUND_DECOR,'LocShape'),gn=new on(1,2147483647,'Duration'),mn=new class extends on{validate(t){if(t>=this.min&&t<=this.max)return qe.unpackCoord(t);throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${t}.`)}}(0,2147483647,'Coord'),En=new rn(_t.get,(t=>t>=0&&t<_t.count),'Param'),On=new rn(pt.get,(t=>t>=0&&t<pt.count),'Npc'),fn=new on(dt.ATTACK,dt.MAGIC,'NpcStat'),An=new on(sn.ATTACK,sn.RUNECRAFT,'PlayerStat'),Tn=new on(0,19,'AIQueue'),In=new rn(K.get,(t=>t>=0&&t<K.count),'Hunt'),Nn=new on(Y.NULL,Y.APNPC5,'NpcMode'),Pn=new on(nn.BLOCK,nn.POISON,'Hit'),Ln=new rn(St.get,(t=>t>=0&&t<St.count),'Spotanim'),Sn=new rn(N.get,(t=>t>=0&&t<N.count),'Enum'),Cn=new rn(ut.get,(t=>t>=0&&t<ut.count),'Obj'),yn=new on(1,se.STACK_LIMIT,'ObjStack'),vn=new rn(J.get,(t=>t>=0&&t<J.count),'Inv'),wn=new rn(f.get,(t=>t>=0&&t<f.count),'Cat'),Rn=new rn(j.get,(t=>t>=0&&t<j.count),'Idk'),bn=new on(V.OFF,V.LINEOFWALK,'HuntVis'),Un=new rn(mt.get,(t=>t>=0&&t<mt.count),'Seq'),Dn=new rn(ft.get,(t=>t>=0&&t<ft.count),'Varp'),Mn=new rn(Ot.get,(t=>t>=0&&t<Ot.count),'Varn'),kn=new rn(At.get,(t=>t>=0&&t<At.count),'Vars'),xn=new rn(b.get,(t=>t>=0&&t<b.count),'Font'),Bn=new rn(nt.get,(t=>t>=0&&t<nt.count),'Mesanim'),Hn=new rn(Et.get,(t=>t>=0&&t<Et.count),'Struct'),Fn=new rn(I.get,(t=>t>=0&&t<I.count),'Dbrow'),Gn=new rn(T.get,(t=>t>=0&&t<T.count),'Dbtable'),Wn=new on(0,1,'Gender'),zn=new on(0,7,'SkinColour'),Vn=function(t,e){if(t.fp>=50)throw new Error('stack overflow');t.frames[t.fp++]={script:t.script,pc:t.pc,intLocals:t.intLocals,stringLocals:t.stringLocals};const n=Xt.get(e);if(!n)throw new Error(`unable to find proc ${n}`);Kn(t,n)},Yn=function(t,e){const n=Xt.get(e);if(!n)throw new Error(`unable to find label ${e}`);t.debugFrames[t.debugFp++]={script:t.script,pc:t.pc},Kn(t,n),t.fp=0,t.frames=[]},Kn=function(t,e){t.script=e,t.pc=-1,t.intLocals=t.popInts(e.intArgCount),t.stringLocals=t.popStrings(e.stringArgCount)},jn={[Jt.PUSH_CONSTANT_INT]:t=>{t.pushInt(t.intOperand)},[Jt.PUSH_CONSTANT_STRING]:t=>{t.pushString(t.stringOperand)},[Jt.PUSH_VARP]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activePlayer2)throw new Error('No secondary active_player.');if(!e&&!t._activePlayer)throw new Error('No active_player.');const n=an(65535&t.intOperand,Dn);n.type===A.STRING?t.pushString(e?t._activePlayer2.getVar(n.id):t._activePlayer.getVar(n.id)):t.pushInt(e?t._activePlayer2.getVar(n.id):t._activePlayer.getVar(n.id))},[Jt.POP_VARP]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activePlayer2)throw new Error('No secondary active_player.');if(!e&&!t._activePlayer)throw new Error('No active_player.');const n=an(65535&t.intOperand,Dn);if(!t.pointerGet(Dt[e])&&n.protect)throw new Error(`%${n.debugname} requires protected access`);if(n.type===A.STRING){const s=t.popString();e?t._activePlayer2.setVar(n.id,s):t._activePlayer.setVar(n.id,s)}else{const s=t.popInt();e?t._activePlayer2.setVar(n.id,s):t._activePlayer.setVar(n.id,s)}},[Jt.PUSH_VARN]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activeNpc2)throw new Error('No secondary active_npc.');if(!e&&!t._activeNpc)throw new Error('No active_npc.');const n=an(65535&t.intOperand,Mn);n.type===A.STRING?t.pushString(e?t._activeNpc2.getVar(n.id):t._activeNpc.getVar(n.id)):t.pushInt(e?t._activeNpc2.getVar(n.id):t._activeNpc.getVar(n.id))},[Jt.POP_VARN]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activeNpc2)throw new Error('No secondary active_npc.');if(!e&&!t._activeNpc)throw new Error('No active_npc.');const n=an(65535&t.intOperand,Mn);if(n.type===A.STRING){const s=t.popInt();e?t._activeNpc2.setVar(n.id,s):t._activeNpc.setVar(n.id,s)}else{const s=t.popInt();e?t._activeNpc2.setVar(n.id,s):t._activeNpc.setVar(n.id,s)}},[Jt.PUSH_INT_LOCAL]:t=>{t.pushInt(t.intLocals[t.intOperand])},[Jt.POP_INT_LOCAL]:t=>{t.intLocals[t.intOperand]=t.popInt()},[Jt.PUSH_STRING_LOCAL]:t=>{t.pushString(t.stringLocals[t.intOperand])},[Jt.POP_STRING_LOCAL]:t=>{t.stringLocals[t.intOperand]=t.popString()},[Jt.BRANCH]:t=>{t.pc+=t.intOperand},[Jt.BRANCH_NOT]:t=>{const e=t.popInt();t.popInt()!==e&&(t.pc+=t.intOperand)},[Jt.BRANCH_EQUALS]:t=>{const e=t.popInt();t.popInt()===e&&(t.pc+=t.intOperand)},[Jt.BRANCH_LESS_THAN]:t=>{const e=t.popInt();t.popInt()<e&&(t.pc+=t.intOperand)},[Jt.BRANCH_GREATER_THAN]:t=>{const e=t.popInt();t.popInt()>e&&(t.pc+=t.intOperand)},[Jt.BRANCH_LESS_THAN_OR_EQUALS]:t=>{const e=t.popInt();t.popInt()<=e&&(t.pc+=t.intOperand)},[Jt.BRANCH_GREATER_THAN_OR_EQUALS]:t=>{const e=t.popInt();t.popInt()>=e&&(t.pc+=t.intOperand)},[Jt.POP_INT_DISCARD]:t=>{t.isp--},[Jt.POP_STRING_DISCARD]:t=>{t.ssp--},[Jt.RETURN]:t=>{if(0===t.fp)return void(t.execution=ee.FINISHED);const e=t.frames[--t.fp];t.pc=e.pc,t.script=e.script,t.intLocals=e.intLocals,t.stringLocals=e.stringLocals},[Jt.JOIN_STRING]:t=>{const e=t.intOperand,n=[];for(let s=0;s<e;s++)n.push(t.popString());t.pushString(n.reverse().join(''))},[Jt.GOSUB]:t=>{Vn(t,t.popInt())},[Jt.GOSUB_WITH_PARAMS]:t=>{Vn(t,t.intOperand)},[Jt.JUMP]:t=>{Yn(t,t.popInt())},[Jt.JUMP_WITH_PARAMS]:t=>{Yn(t,t.intOperand)},[Jt.DEFINE_ARRAY]:t=>{throw new Error('unimplemented')},[Jt.PUSH_ARRAY_INT]:t=>{throw new Error('unimplemented')},[Jt.POP_ARRAY_INT]:t=>{throw new Error('unimplemented')},[Jt.SWITCH]:t=>{const e=t.popInt(),n=t.script.switchTables[t.intOperand];if(void 0===n)return;const s=n[e];s&&(t.pc+=s)},[Jt.PUSH_VARS]:t=>{const e=an(65535&t.intOperand,kn);e.type===A.STRING?t.pushString(tl.varsString[e.id]??''):t.pushInt(tl.vars[e.id])},[Jt.POP_VARS]:t=>{const e=an(65535&t.intOperand,kn);e.type===A.STRING?tl.varsString[e.id]=t.popString():tl.vars[e.id]=t.popInt()}},Zn={[Jt.DB_FIND_WITH_COUNT]:t=>{throw new Error('unimplemented')},[Jt.DB_FINDNEXT]:t=>{if(!t.dbTable)throw new Error('No table selected');t.dbRow+1>=t.dbRowQuery.length?t.pushInt(-1):(t.dbRow++,t.pushInt(an(t.dbRowQuery[t.dbRow],Fn).id))},[Jt.DB_GETFIELD]:t=>{const[e,n,s]=t.popInts(3),i=n>>12&65535,a=n>>4&127,r=an(e,Fn),o=an(i,Gn);let c;c=r.tableId!==i?o.getDefault(a):r.getValue(a,s);const l=o.types[a];for(let e=0;e<c.length;e++)l[e]===A.STRING?t.pushString(c[e]):t.pushInt(c[e])},[Jt.DB_GETFIELDCOUNT]:t=>{const[e,n]=t.popInts(2),s=n>>12&65535,i=n>>4&127,a=an(e,Fn),r=an(s,Gn);a.tableId===s?t.pushInt(a.columnValues[i].length/r.types[i].length):t.pushInt(0)},[Jt.DB_LISTALL_WITH_COUNT]:t=>{throw new Error('unimplemented')},[Jt.DB_GETROWTABLE]:t=>{t.pushInt(an(t.popInt(),Fn).tableId)},[Jt.DB_FINDBYINDEX]:t=>{throw new Error('unimplemented')},[Jt.DB_FIND_REFINE_WITH_COUNT]:t=>{throw new Error('unimplemented')},[Jt.DB_FIND]:t=>{const e=2==t.popInt()?t.popString():t.popInt(),n=t.popInt(),s=n>>12&65535,i=n>>4&127;t.dbTable=an(s,Gn),t.dbRow=-1,t.dbRowQuery=[];const a=I.getInTable(s);for(let n=0;n<a.length;n++){const s=a[n];s.columnValues[i].includes(e)&&t.dbRowQuery.push(s.id)}t.pushInt(t.dbRowQuery.length)},[Jt.DB_FIND_REFINE]:t=>{const e=2==t.popInt()?t.popString():t.popInt(),n=t.popInt(),s=n>>12&65535,i=n>>4&127,a=[],r=I.getInTable(s);for(let t=0;t<r.length;t++){const n=r[t];n.columnValues[i].includes(e)&&a.push(n.id)}const o=t.dbRowQuery;t.dbRow=-1,t.dbRowQuery=[];for(let e=0;e<o.length;e++)a.includes(o[e])&&t.dbRowQuery.push(o[e]);t.pushInt(t.dbRowQuery.length)},[Jt.DB_LISTALL]:t=>{throw new Error('unimplemented')}},Jn={PUBLIC_IP:'localhost',WEB_PORT:80,GAME_PORT:43594,LOGIN_HOST:'localhost',LOGIN_PORT:43500,LOGIN_KEY:'',FRIEND_HOST:'localhost',FRIEND_PORT:43501,FRIEND_KEY:'',WORLD_ID:0,LOCAL_DEV:!0,MEMBERS_WORLD:!0,XP_MULTIPLIER:1,SHUTDOWN_TIMER:50,HTTPS_ENABLED:!1,ADDRESS_SHOWPORT:!0,CLIRUNNER:!1,CI_MODE:!1,SKIP_CORS:!1,DB_HOST:'',DB_USER:'',DB_PASS:'',DB_NAME:'',ADMIN_IP:'localhost',SKIP_CRC:!1,JAVA_PATH:'java',DATA_SRC_DIR:'data/src',VALIDATE_PACK:!0,STRICT_FOLDERS:!0,BUILD_ON_STARTUP:!0,UPDATE_ON_STARTUP:!0,JMODS:['pazaz'],CLIENT_PATHFINDER:!0,NO_SOCKET_TIMEOUT:!1,PROFILE_SCRIPTS:!1},$n={[Jt.ERROR]:t=>{throw new Error(t.popString())},[Jt.MAP_LOCALDEV]:t=>{t.pushInt(Jn.LOCAL_DEV?1:0)}},Xn={[Jt.ENUM]:t=>{const[e,n,s,i]=t.popInts(4),a=an(s,Sn);if(a.inputtype!==e||a.outputtype!==n)throw new Error(`Type validation error: ${a.debugname} key: ${i}. Expected input: ${e} got: ${a.inputtype}. Expected output: ${n} got: ${a.outputtype}`);const r=a.values.get(i);'string'==typeof r?t.pushString(r??a.defaultString):t.pushInt(r??a.defaultInt)},[Jt.ENUM_GETOUTPUTCOUNT]:t=>{t.pushInt(an(t.popInt(),Sn).values.size)}};(ln=cn||={})[ln.FOREVER=0]='FOREVER',ln[ln.RESPAWN=1]='RESPAWN',ln[ln.DESPAWN=2]='DESPAWN';var Qn=cn;class qn{level;x;z;width;length;lifecycle;lifecycleTick=-1;lastLifecycleTick=-1;constructor(t,e,n,s,i,a){this.level=t,this.x=e,this.z=n,this.width=s,this.length=i,this.lifecycle=a}updateLifeCycle(t){return this.lifecycleTick===t&&this.lifecycle!==Qn.FOREVER}checkLifeCycle(t){return this.lifecycle===Qn.FOREVER||(this.lifecycle===Qn.RESPAWN?this.lifecycleTick<t:this.lifecycle===Qn.DESPAWN&&this.lifecycleTick>t)}setLifeCycle(t){this.lifecycleTick=t,this.lastLifecycleTick=tl.currentTick}}class ts extends qn{resetEntity(t){}}class es extends ts{type;count;receiverId=-1;reveal=-1;constructor(t,e,n,s,i,a){super(t,e,n,1,1,s),this.type=i,this.count=a}}var ns,ss,is={[Jt.INV_ALLSTOCK]:t=>{const e=an(t.popInt(),vn);t.pushInt(e.allstock?1:0)},[Jt.INV_SIZE]:t=>{const e=an(t.popInt(),vn);t.pushInt(e.size)},[Jt.INV_STOCKBASE]:t=>{const[e,n]=t.popInts(2),s=an(e,vn),i=an(n,Cn);if(!s.stockobj||!s.stockcount)return void t.pushInt(-1);const a=s.stockobj.indexOf(i.id);t.pushInt(a>=0?s.stockcount[a]:-1)},[Jt.INV_ADD]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3),i=an(e,vn),a=an(n,Cn);if(an(s,yn),!t.pointerGet(Dt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);if(!i.dummyinv&&0!==a.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${a.debugname} -> ${i.debugname}`);const r=t.activePlayer,o=s-r.invAdd(i.id,a.id,s);o>0&&tl.addObj(new es(r.level,r.x,r.z,Qn.DESPAWN,a.id,o),r.pid,200)})),[Jt.INV_CHANGESLOT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4);throw new Error('unimplemented')})),[Jt.INV_CLEAR]:Ct(Ut,(t=>{const e=an(t.popInt(),vn);if(!t.pointerGet(Dt[t.intOperand])&&e.protect&&e.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${e.debugname}`);t.activePlayer.invClear(e.id)})),[Jt.INV_DEL]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3),i=an(e,vn),a=an(n,Cn);if(an(s,yn),!t.pointerGet(Dt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);t.activePlayer.invDel(i.id,a.id,s)})),[Jt.INV_DELSLOT]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn);if(!t.pointerGet(Dt[t.intOperand])&&s.protect&&s.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${s.debugname}`);t.activePlayer.invGetSlot(s.id,n)&&t.activePlayer.invDelSlot(s.id,n)})),[Jt.INV_DROPITEM]:Ct(Ut,(t=>{const[e,n,s,i,a]=t.popInts(5),r=an(e,vn),o=an(n,mn),c=an(s,Cn);if(an(i,yn),an(a,gn),!t.pointerGet(Dt[t.intOperand])&&r.protect&&r.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const l=t.activePlayer,h=l.invDel(r.id,c.id,i);if(0==h)return;l.playerLog('Dropped item from',r.debugname,c.debugname);const d=new es(o.level,o.x,o.z,Qn.DESPAWN,c.id,h);tl.addObj(d,l.pid,a),t.activeObj=d,t.pointerAdd(bt[t.intOperand])})),[Jt.INV_DROPSLOT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn);an(i,gn);const r=an(n,mn);if(!t.pointerGet(Dt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const o=t.activePlayer.invGetSlot(a.id,s);if(!o)throw new Error('$slot is empty');const c=t.activePlayer,l=c.invDel(a.id,o.id,o.count,s);if(0===l)return;const h=ut.get(o.id);c.playerLog('Dropped item from',a.debugname,h.debugname);const d=new es(r.level,r.x,r.z,Qn.DESPAWN,o.id,l);tl.addObj(d,c.pid,i),t.activeObj=d,t.pointerAdd(bt[t.intOperand])})),[Jt.INV_FREESPACE]:Ct(Ut,(t=>{const e=an(t.popInt(),vn);t.pushInt(t.activePlayer.invFreeSpace(e.id))})),[Jt.INV_GETNUM]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn);t.pushInt(t.activePlayer.invGetSlot(s.id,n)?.count??0)})),[Jt.INV_GETOBJ]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn);t.pushInt(t.activePlayer.invGetSlot(s.id,n)?.id??-1)})),[Jt.INV_ITEMSPACE]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(n,Cn);if(an(s,yn),i<0||i>a.size)throw new Error(`$count is out of range: ${s}`);t.pushInt(0===t.activePlayer.invItemSpace(a.id,r.id,s,i)?1:0)})),[Jt.INV_ITEMSPACE2]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(n,Cn);an(s,yn),t.pushInt(t.activePlayer.invItemSpace(a.id,r.id,s,i))})),[Jt.INV_MOVEFROMSLOT]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3),i=an(e,vn),a=an(n,vn);if(!t.pointerGet(Dt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);if(!t.pointerGet(Dt[t.intOperand])&&a.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const r=t.activePlayer,{overflow:o,fromObj:c}=r.invMoveFromSlot(i.id,a.id,s);o>0&&tl.addObj(new es(r.level,r.x,r.z,Qn.DESPAWN,c,o),r.pid,200)})),[Jt.INV_MOVETOSLOT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(n,vn);if(!t.pointerGet(Dt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Dt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);t.activePlayer.invMoveToSlot(a.id,r.id,s,i)})),[Jt.BOTH_MOVEINV]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn),i=an(n,vn),a=1==t.intOperand,r=a?t._activePlayer2:t._activePlayer,o=a?t._activePlayer:t._activePlayer2;if(!r||!o)throw new Error('player is null');if(!t.pointerGet(Dt[a?1:0])&&s.protect&&s.scope!==J.SCOPE_SHARED)throw new Error(`$from_inv requires protected access: ${s.debugname}`);if(!t.pointerGet(Dt[a?0:1])&&i.protect&&s.scope!==J.SCOPE_SHARED)throw new Error(`$to_inv requires protected access: ${i.debugname}`);const c=r.getInventory(e),l=o.getInventory(n);if(!c||!l)throw new Error('inv is null');for(let t=0;t<c.capacity;t++){const e=c.get(t);e&&(c.delete(t),l.add(e.id,e.count),r.playerLog('Gave '+ut.get(e.id).name+' x'+e.count+' during trade with '+o.username),o.playerLog('Received '+ut.get(e.id).name+' x'+e.count+' during trade with '+r.username))}})),[Jt.INV_MOVEITEM]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(n,vn),o=an(s,Cn);if(an(i,yn),!t.pointerGet(Dt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Dt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);if(0==l)return;const h=i-c.invAdd(r.id,o.id,l);h>0&&tl.addObj(new es(c.level,c.x,c.z,Qn.DESPAWN,o.id,h),c.pid,200)})),[Jt.INV_MOVEITEM_CERT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(n,vn),o=an(s,Cn);if(an(i,yn),!t.pointerGet(Dt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Dt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);if(0==l)return;let h=o.id;-1===o.certtemplate&&o.certlink>=0&&(h=o.certlink);const d=i-c.invAdd(r.id,h,l);d>0&&tl.addObj(new es(c.level,c.x,c.z,Qn.DESPAWN,h,d),c.pid,200)})),[Jt.INV_MOVEITEM_UNCERT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(n,vn),o=an(s,Cn);if(an(i,yn),!t.pointerGet(Dt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Dt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);0!=l&&(o.certtemplate>=0&&o.certlink>=0?c.invAdd(r.id,o.certlink,l):c.invAdd(r.id,o.id,l))})),[Jt.INV_SETSLOT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn),r=an(s,Cn);if(an(i,yn),!t.pointerGet(Dt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!a.dummyinv&&0!==r.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${r.debugname} -> ${a.debugname}`);t.activePlayer.invSet(a.id,r.id,i,n)})),[Jt.INV_TOTAL]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn);-1!==n?t.pushInt(t.activePlayer.invTotal(s.id,n)):t.pushInt(0)})),[Jt.INV_TOTALCAT]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn),i=an(n,wn);t.pushInt(t.activePlayer.invTotalCat(s.id,i.id))})),[Jt.INV_TRANSMIT]:Ct(Ut,(t=>{const[e,n]=t.popInts(2),s=an(e,vn);an(n,hn),t.activePlayer.invListenOnCom(s.id,n,t.activePlayer.uid)})),[Jt.INVOTHER_TRANSMIT]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,hn);const i=an(n,vn);an(s,hn),t.activePlayer.invListenOnCom(i.id,s,e)})),[Jt.INV_STOPTRANSMIT]:Ct(Ut,(t=>{const e=an(t.popInt(),hn);t.activePlayer.invStopListenOnCom(e)})),[Jt.BOTH_DROPSLOT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,vn);an(i,gn);const r=an(n,mn),o=1==t.intOperand,c=o?t._activePlayer2:t._activePlayer,l=o?t._activePlayer:t._activePlayer2;if(!c||!l)throw new Error('player is null');if(!t.pointerGet(Dt[o?1:0])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`inv requires protected access: ${a.debugname}`);const h=c.invGetSlot(a.id,s);if(!h)throw new Error('$slot is empty');const d=c.invDel(a.id,h.id,h.count,s);if(0===d)return;const p=ut.get(h.id);c.playerLog('Dropped item from',a.debugname,p.debugname),p.tradeable&&tl.addObj(new es(r.level,r.x,r.z,Qn.DESPAWN,h.id,d),l.pid,i)})),[Jt.INV_DROPALL]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3),i=an(e,vn);an(s,gn);const a=an(n,mn);if(!t.pointerGet(Dt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);const r=t.activePlayer.getInventory(i.id);if(r)for(let t=0;t<r.capacity;t++){const e=r.get(t);if(!e)continue;r.delete(t);ut.get(e.id).tradeable&&tl.addObj(new es(a.level,a.x,a.z,Qn.DESPAWN,e.id,e.count),-1,s)}})),[Jt.INV_TOTALPARAM]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);t.pushInt(t.activePlayer.invTotalParam(e,n))})),[Jt.INV_TOTALPARAM_STACK]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);t.pushInt(t.activePlayer.invTotalParamStack(e,n))}))};(ss=ns||={})[ss.ZONE=0]='ZONE',ss[ss.DISTANCE=1]='DISTANCE';var as=ns;class rs{iterator;tick;constructor(t){this.iterator=this.generator(),this.tick=t}[Symbol.iterator](){return this.iterator}next(){return this.iterator.next()}}class os extends rs{x;z;level;minX;maxX;minZ;maxZ;distance;checkVis;checkType;checkCategory;type;constructor(t,e,n,s,i,a,r,o,c){super(t);const l=qe.zone(n),h=qe.zone(s),d=1+i/8|0;this.x=n,this.z=s,this.level=e,this.maxX=l+d,this.minX=l-d,this.maxZ=h+d,this.minZ=h-d,this.distance=i,this.checkVis=a,this.checkType=r,this.checkCategory=o,this.type=c}*generator(){for(let t=this.maxX;t>=this.minX;t--){const e=t<<3;for(let t=this.maxZ;t>=this.minZ;t--){const n=t<<3;if(this.type===B.PLAYER)for(const t of tl.getZone(e,n,this.level).getAllPlayersSafe()){if(tl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');qe.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Te(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t)}else if(this.type===B.NPC)for(const t of tl.getZone(e,n,this.level).getAllNpcsSafe()){if(tl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=pt.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||e.op&&e.op[1]&&(qe.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Te(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}else if(this.type===B.OBJ)for(const t of tl.getZone(e,n,this.level).getAllObjsSafe()){if(tl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=ut.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||(qe.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Te(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}else if(this.type===B.SCENERY)for(const t of tl.getZone(e,n,this.level).getAllLocsSafe()){if(tl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=et.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||(qe.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Te(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}}}}}class cs extends rs{level;x;z;minX;maxX;minZ;maxZ;distance;checkVis;type;constructor(t,e,n,s,i,a,r){super(t);const o=qe.zone(n),c=qe.zone(s),l=1+i/8|0;this.x=n,this.z=s,this.level=e,this.maxX=o+l,this.minX=o-l,this.maxZ=c+l,this.minZ=c-l,this.distance=i,this.checkVis=a,this.type=r}*generator(){if(this.type===as.ZONE)for(const t of tl.getZone(this.x,this.z,this.level).getAllNpcsSafe()){if(tl.currentTick>this.tick)throw new Error('[NpcIterator] tried to use an old iterator. Create a new iterator instead.');yield t}else if(this.type===as.DISTANCE)for(let t=this.maxX;t>=this.minX;t--){const e=t<<3;for(let t=this.maxZ;t>=this.minZ;t--){const n=t<<3;for(const t of tl.getZone(e,n,this.level).getAllNpcsSafe()){if(tl.currentTick>this.tick)throw new Error('[NpcIterator] tried to use an old iterator. Create a new iterator instead.');qe.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Te(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t)}}}}}class ls extends rs{level;x;z;constructor(t,e,n,s){super(t),this.level=e,this.x=n,this.z=s}*generator(){for(const t of tl.getZone(this.x,this.z,this.level).getAllLocsSafe()){if(tl.currentTick>this.tick)throw new Error('[LocIterator] tried to use an old iterator. Create a new iterator instead.');yield t}}}class hs extends ts{info;constructor(t,e,n,s,i,a,r,o,c){super(t,e,n,s,i,a),this.info=16383&r|(31&o)<<14|(3&c)<<19}get type(){return 16383&this.info}get shape(){return this.info>>14&31}get angle(){return this.info>>19&3}}var ds,ps,_s={[Jt.LOC_ADD]:t=>{const[e,n,s,i,a]=t.popInts(5),r=an(e,mn),o=an(n,pn),c=an(s,_n),l=an(i,un);an(a,gn);const h=new hs(r.level,r.x,r.z,o.width,o.length,Qn.DESPAWN,o.id,l,c),d=tl.getZone(r.x,r.z,r.level).getLocsUnsafe(qe.packZoneCoord(r.x,r.z));for(const t of d)if(t!==h&&t.angle===c&&t.shape===l){tl.removeLoc(t,a);break}tl.addLoc(h,a),t.activeLoc=h,t.pointerAdd(Rt[t.intOperand])},[Jt.LOC_ANGLE]:Ct(Rt,(t=>{t.pushInt(an(t.activeLoc.angle,_n))})),[Jt.LOC_ANIM]:Ct(Rt,(t=>{const e=an(t.popInt(),Un);tl.animLoc(t.activeLoc,e.id)})),[Jt.LOC_CATEGORY]:Ct(Rt,(t=>{t.pushInt(an(t.activeLoc.type,pn).category)})),[Jt.LOC_CHANGE]:Ct(Rt,(t=>{const[e,n]=t.popInts(2),s=an(e,pn);an(n,gn),tl.removeLoc(t.activeLoc,n);const{level:i,x:a,z:r,angle:o,shape:c}=t.activeLoc,l=tl.getZone(a,r,i).getLocsUnsafe(qe.packZoneCoord(a,r));let h=null;for(const t of l)if(t.type===s.id&&t.angle===o&&t.shape===c&&t.lifecycle===Qn.RESPAWN){h=t,tl.addLoc(t,0);break}h||(h=new hs(i,a,r,s.width,s.length,Qn.DESPAWN,s.id,c,o),tl.addLoc(h,n)),t.activeLoc=h,t.pointerAdd(Rt[t.intOperand])})),[Jt.LOC_COORD]:Ct(Rt,(t=>{const e=t.activeLoc;t.pushInt(qe.packCoord(e.level,e.x,e.z))})),[Jt.LOC_DEL]:Ct(Rt,(t=>{const e=an(t.popInt(),gn),{level:n,x:s,z:i,angle:a,shape:r}=t.activeLoc,o=tl.getZone(s,i,n).getLocsUnsafe(qe.packZoneCoord(s,i));for(const n of o)if(n!==t.activeLoc&&n.angle===a&&n.shape===r){tl.removeLoc(n,e);break}tl.removeLoc(t.activeLoc,e)})),[Jt.LOC_FIND]:t=>{const[e,n]=t.popInts(2),s=an(n,pn),i=an(e,mn),a=tl.getLoc(i.x,i.z,i.level,s.id);a?(t.activeLoc=a,t.pointerAdd(Rt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.LOC_FINDALLZONE]:t=>{const e=an(t.popInt(),mn);t.locIterator=new ls(tl.currentTick,e.level,e.x,e.z),t._activeLoc&&(t._activeLoc2=t._activeLoc,t.pointerAdd(Mt.ActiveLoc2))},[Jt.LOC_FINDNEXT]:t=>{const e=t.locIterator?.next();e&&!e.done?(t.activeLoc=e.value,t.pointerAdd(Rt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.LOC_PARAM]:Ct(Rt,(t=>{const e=an(t.popInt(),En),n=an(t.activeLoc.type,pn);e.isString()?t.pushString(Q(e.id,n,e.defaultString)):t.pushInt(q(e.id,n,e.defaultInt))})),[Jt.LOC_TYPE]:Ct(Rt,(t=>{t.pushInt(an(t.activeLoc.type,pn).id)})),[Jt.LOC_NAME]:Ct(Rt,(t=>{t.pushString(an(t.activeLoc.type,pn).name??'null')})),[Jt.LOC_SHAPE]:Ct(Rt,(t=>{t.pushInt(an(t.activeLoc.shape,un))}))},us=_s,gs={[Jt.LC_NAME]:t=>{const e=an(t.popInt(),pn);t.pushString(e.name??e.debugname??'null')},[Jt.LC_PARAM]:t=>{const[e,n]=t.popInts(2),s=an(e,pn),i=an(n,En);i.isString()?t.pushString(Q(i.id,s,i.defaultString)):t.pushInt(q(i.id,s,i.defaultInt))},[Jt.LC_CATEGORY]:t=>{t.pushInt(an(t.popInt(),pn).category)},[Jt.LC_DESC]:t=>{t.pushString(an(t.popInt(),pn).desc??'null')},[Jt.LC_DEBUGNAME]:t=>{t.pushString(an(t.popInt(),pn).debugname??'null')},[Jt.LC_WIDTH]:t=>{t.pushInt(an(t.popInt(),pn).width)},[Jt.LC_LENGTH]:t=>{t.pushInt(an(t.popInt(),pn).length)}};(ps=ds||={})[ps.PROC=0]='PROC',ps[ps.LABEL=1]='LABEL',ps[ps.DEBUGPROC=2]='DEBUGPROC',ps[ps.APNPC1=3]='APNPC1',ps[ps.APNPC2=4]='APNPC2',ps[ps.APNPC3=5]='APNPC3',ps[ps.APNPC4=6]='APNPC4',ps[ps.APNPC5=7]='APNPC5',ps[ps.APNPCU=8]='APNPCU',ps[ps.APNPCT=9]='APNPCT',ps[ps.OPNPC1=10]='OPNPC1',ps[ps.OPNPC2=11]='OPNPC2',ps[ps.OPNPC3=12]='OPNPC3',ps[ps.OPNPC4=13]='OPNPC4',ps[ps.OPNPC5=14]='OPNPC5',ps[ps.OPNPCU=15]='OPNPCU',ps[ps.OPNPCT=16]='OPNPCT',ps[ps.AI_APNPC1=17]='AI_APNPC1',ps[ps.AI_APNPC2=18]='AI_APNPC2',ps[ps.AI_APNPC3=19]='AI_APNPC3',ps[ps.AI_APNPC4=20]='AI_APNPC4',ps[ps.AI_APNPC5=21]='AI_APNPC5',ps[ps.AI_OPNPC1=24]='AI_OPNPC1',ps[ps.AI_OPNPC2=25]='AI_OPNPC2',ps[ps.AI_OPNPC3=26]='AI_OPNPC3',ps[ps.AI_OPNPC4=27]='AI_OPNPC4',ps[ps.AI_OPNPC5=28]='AI_OPNPC5',ps[ps.APOBJ1=31]='APOBJ1',ps[ps.APOBJ2=32]='APOBJ2',ps[ps.APOBJ3=33]='APOBJ3',ps[ps.APOBJ4=34]='APOBJ4',ps[ps.APOBJ5=35]='APOBJ5',ps[ps.APOBJU=36]='APOBJU',ps[ps.APOBJT=37]='APOBJT',ps[ps.OPOBJ1=38]='OPOBJ1',ps[ps.OPOBJ2=39]='OPOBJ2',ps[ps.OPOBJ3=40]='OPOBJ3',ps[ps.OPOBJ4=41]='OPOBJ4',ps[ps.OPOBJ5=42]='OPOBJ5',ps[ps.OPOBJU=43]='OPOBJU',ps[ps.OPOBJT=44]='OPOBJT',ps[ps.AI_APOBJ1=45]='AI_APOBJ1',ps[ps.AI_APOBJ2=46]='AI_APOBJ2',ps[ps.AI_APOBJ3=47]='AI_APOBJ3',ps[ps.AI_APOBJ4=48]='AI_APOBJ4',ps[ps.AI_APOBJ5=49]='AI_APOBJ5',ps[ps.AI_OPOBJ1=52]='AI_OPOBJ1',ps[ps.AI_OPOBJ2=53]='AI_OPOBJ2',ps[ps.AI_OPOBJ3=54]='AI_OPOBJ3',ps[ps.AI_OPOBJ4=55]='AI_OPOBJ4',ps[ps.AI_OPOBJ5=56]='AI_OPOBJ5',ps[ps.APLOC1=59]='APLOC1',ps[ps.APLOC2=60]='APLOC2',ps[ps.APLOC3=61]='APLOC3',ps[ps.APLOC4=62]='APLOC4',ps[ps.APLOC5=63]='APLOC5',ps[ps.APLOCU=64]='APLOCU',ps[ps.APLOCT=65]='APLOCT',ps[ps.OPLOC1=66]='OPLOC1',ps[ps.OPLOC2=67]='OPLOC2',ps[ps.OPLOC3=68]='OPLOC3',ps[ps.OPLOC4=69]='OPLOC4',ps[ps.OPLOC5=70]='OPLOC5',ps[ps.OPLOCU=71]='OPLOCU',ps[ps.OPLOCT=72]='OPLOCT',ps[ps.AI_APLOC1=73]='AI_APLOC1',ps[ps.AI_APLOC2=74]='AI_APLOC2',ps[ps.AI_APLOC3=75]='AI_APLOC3',ps[ps.AI_APLOC4=76]='AI_APLOC4',ps[ps.AI_APLOC5=77]='AI_APLOC5',ps[ps.AI_OPLOC1=80]='AI_OPLOC1',ps[ps.AI_OPLOC2=81]='AI_OPLOC2',ps[ps.AI_OPLOC3=82]='AI_OPLOC3',ps[ps.AI_OPLOC4=83]='AI_OPLOC4',ps[ps.AI_OPLOC5=84]='AI_OPLOC5',ps[ps.APPLAYER1=87]='APPLAYER1',ps[ps.APPLAYER2=88]='APPLAYER2',ps[ps.APPLAYER3=89]='APPLAYER3',ps[ps.APPLAYER4=90]='APPLAYER4',ps[ps.APPLAYER5=91]='APPLAYER5',ps[ps.APPLAYERU=92]='APPLAYERU',ps[ps.APPLAYERT=93]='APPLAYERT',ps[ps.OPPLAYER1=94]='OPPLAYER1',ps[ps.OPPLAYER2=95]='OPPLAYER2',ps[ps.OPPLAYER3=96]='OPPLAYER3',ps[ps.OPPLAYER4=97]='OPPLAYER4',ps[ps.OPPLAYER5=98]='OPPLAYER5',ps[ps.OPPLAYERU=99]='OPPLAYERU',ps[ps.OPPLAYERT=100]='OPPLAYERT',ps[ps.AI_APPLAYER1=101]='AI_APPLAYER1',ps[ps.AI_APPLAYER2=102]='AI_APPLAYER2',ps[ps.AI_APPLAYER3=103]='AI_APPLAYER3',ps[ps.AI_APPLAYER4=104]='AI_APPLAYER4',ps[ps.AI_APPLAYER5=105]='AI_APPLAYER5',ps[ps.AI_OPPLAYER1=108]='AI_OPPLAYER1',ps[ps.AI_OPPLAYER2=109]='AI_OPPLAYER2',ps[ps.AI_OPPLAYER3=110]='AI_OPPLAYER3',ps[ps.AI_OPPLAYER4=111]='AI_OPPLAYER4',ps[ps.AI_OPPLAYER5=112]='AI_OPPLAYER5',ps[ps.QUEUE=116]='QUEUE',ps[ps.AI_QUEUE1=117]='AI_QUEUE1',ps[ps.AI_QUEUE2=118]='AI_QUEUE2',ps[ps.AI_QUEUE3=119]='AI_QUEUE3',ps[ps.AI_QUEUE4=120]='AI_QUEUE4',ps[ps.AI_QUEUE5=121]='AI_QUEUE5',ps[ps.AI_QUEUE6=122]='AI_QUEUE6',ps[ps.AI_QUEUE7=123]='AI_QUEUE7',ps[ps.AI_QUEUE8=124]='AI_QUEUE8',ps[ps.AI_QUEUE9=125]='AI_QUEUE9',ps[ps.AI_QUEUE10=126]='AI_QUEUE10',ps[ps.AI_QUEUE11=127]='AI_QUEUE11',ps[ps.AI_QUEUE12=128]='AI_QUEUE12',ps[ps.AI_QUEUE13=129]='AI_QUEUE13',ps[ps.AI_QUEUE14=130]='AI_QUEUE14',ps[ps.AI_QUEUE15=131]='AI_QUEUE15',ps[ps.AI_QUEUE16=132]='AI_QUEUE16',ps[ps.AI_QUEUE17=133]='AI_QUEUE17',ps[ps.AI_QUEUE18=134]='AI_QUEUE18',ps[ps.AI_QUEUE19=135]='AI_QUEUE19',ps[ps.AI_QUEUE20=136]='AI_QUEUE20',ps[ps.SOFTTIMER=137]='SOFTTIMER',ps[ps.TIMER=138]='TIMER',ps[ps.AI_TIMER=139]='AI_TIMER',ps[ps.OPHELD1=140]='OPHELD1',ps[ps.OPHELD2=141]='OPHELD2',ps[ps.OPHELD3=142]='OPHELD3',ps[ps.OPHELD4=143]='OPHELD4',ps[ps.OPHELD5=144]='OPHELD5',ps[ps.OPHELDU=145]='OPHELDU',ps[ps.OPHELDT=146]='OPHELDT',ps[ps.IF_BUTTON=147]='IF_BUTTON',ps[ps.INV_BUTTON1=148]='INV_BUTTON1',ps[ps.INV_BUTTON2=149]='INV_BUTTON2',ps[ps.INV_BUTTON3=150]='INV_BUTTON3',ps[ps.INV_BUTTON4=151]='INV_BUTTON4',ps[ps.INV_BUTTON5=152]='INV_BUTTON5',ps[ps.INV_BUTTOND=153]='INV_BUTTOND',ps[ps.IF_CLOSE=154]='IF_CLOSE',ps[ps.LOGIN=155]='LOGIN',ps[ps.LOGOUT=156]='LOGOUT',ps[ps.TUTORIAL_CLICKSIDE=157]='TUTORIAL_CLICKSIDE',ps[ps.MOVE=158]='MOVE',ps[ps.WALKTRIGGER=159]='WALKTRIGGER',ps[ps.AI_WALKTRIGGER=160]='AI_WALKTRIGGER',ps[ps.LEVELUP=161]='LEVELUP',(t=>{t.toString=function(e){return t[e].toLowerCase()}})(ds||={});var ms,Es,Os=ds;(Es=ms||={})[Es.SCRIPT=0]='SCRIPT',Es[Es.ENGINE=1]='ENGINE';var As=ms,Ts={[Jt.NPC_FINDUID]:t=>{const e=t.popInt(),n=65535&e,s=e>>16&65535,i=tl.getNpc(n);i&&i.type===s?(t.activeNpc=i,t.pointerAdd(wt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.NPC_ADD]:t=>{const[e,n,s]=t.popInts(3),i=an(e,mn),a=an(n,On);an(s,gn);const r=new Hc(i.level,i.x,i.z,a.size,a.size,Qn.DESPAWN,tl.getNextNid(),a.id,a.moverestrict,a.blockwalk);tl.addNpc(r,s),t.activeNpc=r,t.pointerAdd(wt[t.intOperand])},[Jt.NPC_ANIM]:Ct(wt,(t=>{const e=an(t.popInt(),hn),n=t.popInt();t.activeNpc.playAnimation(n,e)})),[Jt.NPC_BASESTAT]:Ct(wt,(t=>{const e=an(t.popInt(),fn);t.pushInt(t.activeNpc.baseLevels[e])})),[Jt.NPC_CATEGORY]:Ct(wt,(t=>{t.pushInt(an(t.activeNpc.type,On).category)})),[Jt.NPC_COORD]:Ct(wt,(t=>{const e=t.activeNpc;t.pushInt(qe.packCoord(e.level,e.x,e.z))})),[Jt.NPC_DEL]:Ct(wt,(t=>{Jn.CLIRUNNER||tl.removeNpc(t.activeNpc,an(t.activeNpc.type,On).respawnrate)})),[Jt.NPC_DELAY]:Ct(wt,(t=>{Jn.CLIRUNNER||(t.activeNpc.delay=t.popInt()+1,t.execution=ee.NPC_SUSPENDED)})),[Jt.NPC_FACESQUARE]:Ct(wt,(t=>{const e=an(t.popInt(),mn);t.activeNpc.faceSquare(e.x,e.z)})),[Jt.NPC_FINDEXACT]:t=>{const[e,n]=t.popInts(2),s=an(e,mn),i=an(n,On);t.npcIterator=new cs(tl.currentTick,s.level,s.x,s.z,0,0,as.ZONE);for(const e of t.npcIterator)if(e.type===i.id&&e.x===s.x&&e.level===s.level&&e.z===s.z)return t.activeNpc=e,t.pointerAdd(wt[t.intOperand]),void t.pushInt(1);t.pushInt(0)},[Jt.NPC_FINDHERO]:Ct(wt,(t=>{const e=t.activeNpc.findHero();if(-1===e)return void t.pushInt(0);const n=tl.getPlayerByUid(e);n?(t.activePlayer=n,t.pointerAdd(Mt.ActivePlayer),t.pushInt(1)):t.pushInt(0)})),[Jt.NPC_PARAM]:Ct(wt,(t=>{const e=an(t.popInt(),En),n=an(t.activeNpc.type,On);e.isString()?t.pushString(Q(e.id,n,e.defaultString)):t.pushInt(q(e.id,n,e.defaultInt))})),[Jt.NPC_QUEUE]:Ct(wt,(t=>{const e=an(t.popInt(),hn),n=t.popInt(),s=an(t.popInt(),Tn),i=an(t.activeNpc.type,On),a=Xt.getByTrigger(Os.AI_QUEUE1+s-1,i.id,i.category);a&&t.activeNpc.enqueueScript(a,e,n)})),[Jt.NPC_RANGE]:Ct(wt,(t=>{const e=an(t.popInt(),mn),n=t.activeNpc;e.level!==n.level?t.pushInt(-1):t.pushInt(qe.distanceTo(n,{x:e.x,z:e.z,width:1,length:1}))})),[Jt.NPC_SAY]:Ct(wt,(t=>{t.activeNpc.say(t.popString())})),[Jt.NPC_SETHUNT]:Ct(wt,(t=>{t.activeNpc.huntrange=an(t.popInt(),hn)})),[Jt.NPC_SETHUNTMODE]:Ct(wt,(t=>{t.activeNpc.huntMode=an(t.popInt(),In).id})),[Jt.NPC_SETMODE]:Ct(wt,(t=>{const e=an(t.popInt(),Nn);if(t.activeNpc.clearWaypoints(),e===Y.NULL||e===Y.NONE||e===Y.WANDER||e===Y.PATROL)return t.activeNpc.clearInteraction(),void(t.activeNpc.targetOp=e);let n;t.activeNpc.targetOp=e,n=e>=Y.OPNPC1?t._activeNpc2:e>=Y.OPOBJ1?t._activeObj:e>=Y.OPLOC1?t._activeLoc:t._activePlayer,n?n instanceof Hc||n instanceof es||n instanceof hs?t.activeNpc.setInteraction(As.SCRIPT,n,e,{type:n.type,com:-1}):t.activeNpc.setInteraction(As.SCRIPT,n,e):t.activeNpc.noMode()})),[Jt.NPC_STAT]:Ct(wt,(t=>{const e=an(t.popInt(),fn);t.pushInt(t.activeNpc.levels[e])})),[Jt.NPC_STATHEAL]:Ct(wt,(t=>{const[e,n,s]=t.popInts(3);an(e,fn),an(n,hn),an(s,hn);const i=t.activeNpc,a=i.baseLevels[e],r=i.levels[e],o=r+(n+r*s/100);i.levels[e]=Math.min(o,a),0===e&&i.levels[e]===i.baseLevels[e]&&i.resetHeroPoints()})),[Jt.NPC_TYPE]:Ct(wt,(t=>{t.pushInt(an(t.activeNpc.type,On).id)})),[Jt.NPC_DAMAGE]:Ct(wt,(t=>{const e=an(t.popInt(),hn),n=an(t.popInt(),Pn);t.activeNpc.applyDamage(e,n)})),[Jt.NPC_NAME]:Ct(wt,(t=>{t.pushString(an(t.activeNpc.type,On).name??'null')})),[Jt.NPC_UID]:Ct(wt,(t=>{t.pushInt(t.activeNpc.uid)})),[Jt.NPC_SETTIMER]:Ct(wt,(t=>{t.activeNpc.setTimer(an(t.popInt(),hn))})),[Jt.SPOTANIM_NPC]:Ct(wt,(t=>{const e=an(t.popInt(),hn),n=an(t.popInt(),hn),s=an(t.popInt(),Ln);t.activeNpc.spotanim(s.id,n,e)})),[Jt.NPC_FIND]:t=>{const[e,n,s,i]=t.popInts(4),a=an(e,mn),r=an(n,On);an(s,hn);const o=an(i,bn);let c,l=s;const h=new cs(tl.currentTick,a.level,a.x,a.z,s,o,as.DISTANCE);for(const t of h)if(t&&t.type===r.id){const e=qe.distanceToSW(a,t);e<=l&&(c=t,l=e)}c?(t.activeNpc=c,t.pointerAdd(wt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.NPC_FINDALLANY]:t=>{const[e,n,s]=t.popInts(3),i=an(e,mn);an(n,hn);const a=an(s,bn);t.npcIterator=new cs(tl.currentTick,i.level,i.x,i.z,n,a,as.DISTANCE),t._activeNpc&&(t._activeNpc2=t._activeNpc,t.pointerAdd(Mt.ActiveNpc2))},[Jt.NPC_FINDALLZONE]:t=>{const e=an(t.popInt(),mn);t.npcIterator=new cs(tl.currentTick,e.level,e.x,e.z,0,0,as.ZONE),t._activeNpc&&(t._activeNpc2=t._activeNpc,t.pointerAdd(Mt.ActiveNpc2))},[Jt.NPC_FINDNEXT]:t=>{const e=t.npcIterator?.next();e&&!e.done?(t.activeNpc=e.value,t.pointerAdd(wt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.NPC_TELE]:Ct(wt,(t=>{const e=an(t.popInt(),mn);t.activeNpc.teleport(e.x,e.z,e.level)})),[Jt.NPC_WALK]:Ct(wt,(t=>{const e=an(t.popInt(),mn);t.activeNpc.queueWaypoint(e.x,e.z)})),[Jt.NPC_CHANGETYPE]:Ct(wt,(t=>{t.activeNpc.changeType(an(t.popInt(),On).id)})),[Jt.NPC_GETMODE]:Ct(wt,(t=>{t.pushInt(t.activeNpc.targetOp)})),[Jt.NPC_HEROPOINTS]:Ct([Mt.ActivePlayer,...wt],(t=>{t.activeNpc.addHero(t.activePlayer.uid,an(t.popInt(),hn))})),[Jt.NPC_WALKTRIGGER]:Ct(wt,(t=>{const[e,n]=t.popInts(2);an(e,Tn),t.activeNpc.walktrigger=e-1,t.activeNpc.walktriggerArg=n})),[Jt.NPC_STATADD]:Ct(wt,(t=>{const[e,n,s]=t.popInts(3);an(e,fn),an(n,hn),an(s,hn);const i=t.activeNpc,a=i.levels[e],r=a+(n+a*s/100);i.levels[e]=Math.min(r,255),0===e&&i.levels[e]>=i.baseLevels[e]&&i.resetHeroPoints()})),[Jt.NPC_STATSUB]:Ct(wt,(t=>{const[e,n,s]=t.popInts(3);an(e,fn),an(n,hn),an(s,hn);const i=t.activeNpc,a=i.levels[e],r=a-(n+a*s/100);i.levels[e]=Math.max(r,0)})),[Jt.NPC_ATTACKRANGE]:Ct(wt,(t=>{t.pushInt(an(t.activeNpc.type,On).attackrange)}))},Is={[Jt.NC_NAME]:t=>{const e=an(t.popInt(),On);t.pushString(e.name??e.debugname??'null')},[Jt.NC_PARAM]:t=>{const[e,n]=t.popInts(2),s=an(e,On),i=an(n,En);i.isString()?t.pushString(Q(n,s,i.defaultString)):t.pushInt(q(n,s,i.defaultInt))},[Jt.NC_CATEGORY]:t=>{t.pushInt(an(t.popInt(),On).category)},[Jt.NC_DESC]:t=>{t.pushString(an(t.popInt(),On).desc??'null')},[Jt.NC_DEBUGNAME]:t=>{t.pushString(an(t.popInt(),On).debugname??'null')},[Jt.NC_OP]:t=>{const[e,n]=t.popInts(2),s=an(e,On);an(n,hn),s.op?t.pushString(s.op[n-1]??''):t.pushString('')}};class Ns{static _sin=new Int32Array(16384);static _cos=new Int32Array(16384);static{const t=.0003834951969714103;for(let e=0;e<16384;e++)this._sin[e]=16384*Math.sin(e*t)|0,this._cos[e]=16384*Math.cos(e*t)|0}static radians(t){return(16383&t)/16384*6.283185307179586}static atan2(t,e){return 16383&Math.round(2607.5945876176133*Math.atan2(t,e))}static sin(t){return this._sin[16383&t]}static cos(t){return this._cos[16383&t]}}var Ps,Ls,Ss={[Jt.ADD]:t=>{const e=t.popInt(),n=t.popInt();t.pushInt(n+e)},[Jt.SUB]:t=>{const e=t.popInt(),n=t.popInt();t.pushInt(n-e)},[Jt.MULTIPLY]:t=>{const e=t.popInt(),n=t.popInt();t.pushInt(n*e)},[Jt.DIVIDE]:t=>{const e=t.popInt(),n=t.popInt();t.pushInt(n/e)},[Jt.RANDOM]:t=>{const e=t.popInt();t.pushInt(Math.random()*e)},[Jt.RANDOMINC]:t=>{const e=t.popInt();t.pushInt(Math.random()*(e+1))},[Jt.INTERPOLATE]:t=>{const[e,n,s,i,a]=t.popInts(5),r=Math.floor((n-e)/(i-s))*(a-s)+e;t.pushInt(r)},[Jt.ADDPERCENT]:t=>{const[e,n]=t.popInts(2);t.pushInt(e*n/100+e|0)},[Jt.SETBIT]:t=>{const[e,n]=t.popInts(2);t.pushInt(e|1<<n)},[Jt.CLEARBIT]:t=>{const[e,n]=t.popInts(2);t.pushInt(e&~(1<<n))},[Jt.TESTBIT]:t=>{const[e,n]=t.popInts(2);t.pushInt(e&1<<n?1:0)},[Jt.MODULO]:t=>{const[e,n]=t.popInts(2);t.pushInt(e%n)},[Jt.POW]:t=>{const[e,n]=t.popInts(2);t.pushInt(Math.pow(e,n))},[Jt.INVPOW]:t=>{const[e,n]=t.popInts(2);if(0===e||0===n)t.pushInt(0);else switch(n){case 1:return void t.pushInt(e);case 2:return void t.pushInt(Math.sqrt(e));case 3:return void t.pushInt(Math.cbrt(e));case 4:return void t.pushInt(Math.sqrt(Math.sqrt(e)));default:return void t.pushInt(Math.pow(e,1/n))}},[Jt.AND]:t=>{const[e,n]=t.popInts(2);t.pushInt(e&n)},[Jt.OR]:t=>{const[e,n]=t.popInts(2);t.pushInt(e|n)},[Jt.MIN]:t=>{const[e,n]=t.popInts(2);t.pushInt(Math.min(e,n))},[Jt.MAX]:t=>{const[e,n]=t.popInts(2);t.pushInt(Math.max(e,n))},[Jt.SCALE]:t=>{const[e,n,s]=t.popInts(3);t.pushInt(e*s/n)},[Jt.BITCOUNT]:t=>{var e;t.pushInt((e=t.popInt(),16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24))},[Jt.TOGGLEBIT]:t=>{const[e,n]=t.popInts(2);t.pushInt(e^1<<n)},[Jt.SETBIT_RANGE]:t=>{const[e,n,s]=t.popInts(3);t.pushInt(function(t,e,n){return t|te[n-e+1]<<e}(e,n,s))},[Jt.CLEARBIT_RANGE]:t=>{const[e,n,s]=t.popInts(3);t.pushInt(qt(e,n,s))},[Jt.GETBIT_RANGE]:t=>{const[e,n,s]=t.popInts(3),i=31-s;t.pushInt(e<<i>>>n+i)},[Jt.SETBIT_RANGE_TOINT]:t=>{const[e,n,s,i]=t.popInts(4),a=qt(e,s,i),r=te[i-s+1];let o=n;n>r&&(o=r),t.pushInt(a|o<<s)},[Jt.SIN_DEG]:t=>{t.pushInt(Ns.sin(t.popInt()))},[Jt.COS_DEG]:t=>{t.pushInt(Ns.cos(t.popInt()))},[Jt.ATAN2_DEG]:t=>{t.pushInt(Ns.atan2(t.popInt(),t.popInt()))},[Jt.ABS]:t=>{t.pushInt(Math.abs(t.popInt()))}},Cs=Ss,ys={[Jt.OBJ_ADD]:t=>{const[e,n,s,i]=t.popInts(4);if(-1===n||-1===s)return;const a=an(n,Cn);an(i,gn);const r=an(e,mn);if(an(s,yn),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);const o=new es(r.level,r.x,r.z,Qn.DESPAWN,n,s);tl.addObj(o,t.activePlayer.pid,i),t.activeObj=o,t.pointerAdd(bt[t.intOperand]),Jn.CLIRUNNER&&t.activePlayer.invAdd(J.getByName('bank').id,n,s)},[Jt.OBJ_ADDALL]:t=>{const[e,n,s,i]=t.popInts(4);if(-1===n||-1===s)return;const a=an(n,Cn);an(i,gn);const r=an(e,mn);if(an(s,yn),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);const o=new es(r.level,r.x,r.z,Qn.DESPAWN,n,s);tl.addObj(o,-1,i),t.activeObj=o,t.pointerAdd(bt[t.intOperand])},[Jt.OBJ_PARAM]:t=>{const e=an(t.popInt(),En),n=an(t.activeObj.type,Cn);e.isString()?t.pushString(Q(e.id,n,e.defaultString)):t.pushInt(q(e.id,n,e.defaultInt))},[Jt.OBJ_NAME]:t=>{const e=an(t.activeObj.type,Cn);t.pushString(e.name??e.debugname??'null')},[Jt.OBJ_DEL]:t=>{const e=ut.get(t.activeObj.type).respawnrate;t.pointerGet(Ut[t.intOperand]),tl.removeObj(t.activeObj,e)},[Jt.OBJ_COUNT]:t=>{t.pushInt(an(t.activeObj.count,yn))},[Jt.OBJ_TYPE]:t=>{t.pushInt(an(t.activeObj.type,Cn).id)},[Jt.OBJ_TAKEITEM]:t=>{const e=an(t.popInt(),vn),n=t.activeObj,s=ut.get(n.type),i=tl.getZone(n.x,n.z,n.level);for(const a of i.getObjsSafe(qe.packZoneCoord(n.x,n.z)))if(a.type===n.type&&a.count===n.count&&(-1===a.receiverId||a.receiverId===t.activePlayer.pid)){if(t.activePlayer.playerLog('Picked up item',s.debugname),t.activePlayer.invAdd(e.id,n.type,n.count),n.lifecycle===Qn.RESPAWN){tl.removeObj(n,s.respawnrate);break}if(n.lifecycle===Qn.DESPAWN){tl.removeObj(n,0);break}}},[Jt.OBJ_COORD]:t=>{const e=t.activeObj;t.pushInt(qe.packCoord(e.level,e.x,e.z))}},vs={[Jt.OC_NAME]:t=>{const e=an(t.popInt(),Cn);t.pushString(e.name??e.debugname??'null')},[Jt.OC_PARAM]:t=>{const[e,n]=t.popInts(2),s=an(e,Cn),i=an(n,En);i.isString()?t.pushString(Q(i.id,s,i.defaultString)):t.pushInt(q(i.id,s,i.defaultInt))},[Jt.OC_CATEGORY]:t=>{t.pushInt(an(t.popInt(),Cn).category)},[Jt.OC_DESC]:t=>{t.pushString(an(t.popInt(),Cn).desc??'null')},[Jt.OC_MEMBERS]:t=>{t.pushInt(an(t.popInt(),Cn).members?1:0)},[Jt.OC_WEIGHT]:t=>{t.pushInt(an(t.popInt(),Cn).weight)},[Jt.OC_WEARPOS]:t=>{t.pushInt(an(t.popInt(),Cn).wearpos)},[Jt.OC_WEARPOS2]:t=>{t.pushInt(an(t.popInt(),Cn).wearpos2)},[Jt.OC_WEARPOS3]:t=>{t.pushInt(an(t.popInt(),Cn).wearpos3)},[Jt.OC_COST]:t=>{t.pushInt(an(t.popInt(),Cn).cost)},[Jt.OC_TRADEABLE]:t=>{t.pushInt(an(t.popInt(),Cn).tradeable?1:0)},[Jt.OC_DEBUGNAME]:t=>{t.pushString(an(t.popInt(),Cn).debugname??'null')},[Jt.OC_CERT]:t=>{const e=an(t.popInt(),Cn);-1==e.certtemplate&&e.certlink>=0?t.pushInt(e.certlink):t.pushInt(e.id)},[Jt.OC_UNCERT]:t=>{const e=an(t.popInt(),Cn);e.certtemplate>=0&&e.certlink>=0?t.pushInt(e.certlink):t.pushInt(e.id)},[Jt.OC_STACKABLE]:t=>{t.pushInt(an(t.popInt(),Cn).stackable?1:0)}};class ws extends u{type;script;args;delay;lastInt=0;constructor(t,e,n,s){super(),this.type=t,this.script=e,this.args=n,this.delay=s}}class Rs extends u{script;delay;constructor(t,e){super(),this.script=t,this.delay=e}}class bs{id;length;static all=[];static byId=[];static IF_OPENCHATMODAL=new bs(14,2);static IF_OPENMAINSIDEMODAL=new bs(28,4);static IF_CLOSE=new bs(129,0);static IF_OPENSIDEOVERLAY=new bs(167,3);static IF_OPENMAINMODAL=new bs(168,2);static IF_OPENSIDEMODAL=new bs(195,2);static IF_SETCOLOUR=new bs(2,4);static IF_SETHIDE=new bs(26,3);static IF_SETOBJECT=new bs(46,6);static IF_SHOWSIDE=new bs(84,1);static IF_SETMODEL=new bs(87,4);static IF_SETRECOL=new bs(103,6);static IF_SETANIM=new bs(146,4);static IF_SETPLAYERHEAD=new bs(197,2);static IF_SETTEXT=new bs(201,-2);static IF_SETNPCHEAD=new bs(204,4);static IF_SETPOSITION=new bs(209,6);static TUTORIAL_FLASHSIDE=new bs(126,1);static TUTORIAL_OPENCHAT=new bs(185,2);static UPDATE_INV_STOP_TRANSMIT=new bs(15,2);static UPDATE_INV_FULL=new bs(98,-2);static UPDATE_INV_PARTIAL=new bs(213,-2);static CAM_LOOKAT=new bs(74,6);static CAM_SHAKE=new bs(13,4);static CAM_MOVETO=new bs(3,6);static CAM_RESET=new bs(239,0);static NPC_INFO=new bs(1,-2);static PLAYER_INFO=new bs(184,-2);static FINISH_TRACKING=new bs(133,0);static ENABLE_TRACKING=new bs(226,0);static MESSAGE_GAME=new bs(4,-1);static UPDATE_IGNORELIST=new bs(21,-2);static CHAT_FILTER_SETTINGS=new bs(32,3);static MESSAGE_PRIVATE=new bs(41,-1);static UPDATE_FRIENDLIST=new bs(152,9);static UNSET_MAP_FLAG=new bs(19,0);static UPDATE_RUNWEIGHT=new bs(22,2);static HINT_ARROW=new bs(25,6);static UPDATE_REBOOT_TIMER=new bs(43,2);static UPDATE_STAT=new bs(44,6);static UPDATE_RUNENERGY=new bs(68,1);static RESET_ANIMS=new bs(136,0);static UPDATE_UID192=new bs(139,2);static LAST_LOGIN_INFO=new bs(140,9);static LOGOUT=new bs(142,0);static P_COUNTDIALOG=new bs(243,0);static SET_MULTIWAY=new bs(254,1);static DATA_LOC_DONE=new bs(20,2);static DATA_LAND_DONE=new bs(80,2);static DATA_LAND=new bs(132,-2);static DATA_LOC=new bs(220,-2);static REBUILD_NORMAL=new bs(237,-2);static VARP_SMALL=new bs(150,3);static VARP_LARGE=new bs(175,6);static RESET_CLIENT_VARCACHE=new bs(193,0);static SYNTH_SOUND=new bs(12,5);static MIDI_SONG=new bs(54,-1);static MIDI_JINGLE=new bs(212,-2);static UPDATE_ZONE_PARTIAL_FOLLOWS=new bs(7,2);static UPDATE_ZONE_FULL_FOLLOWS=new bs(135,2);static UPDATE_ZONE_PARTIAL_ENCLOSED=new bs(162,-2);constructor(t,e){this.id=t,this.length=e,bs.all.push(this),bs.byId[t]=this}}(Ls=Ps||={})[Ls.STATIONARY=0]='STATIONARY',Ls[Ls.CRAWL=1]='CRAWL',Ls[Ls.WALK=2]='WALK',Ls[Ls.RUN=3]='RUN',Ls[Ls.INSTANT=4]='INSTANT';var Us,Ds,Ms=Ps;(Ds=Us||={})[Ds.SMART=0]='SMART',Ds[Ds.NAIVE=1]='NAIVE',Ds[Ds.FLY=2]='FLY';var ks=Us;class xs extends qn{moveRestrict;blockWalk;moveStrategy;coordmask;entitymask;moveSpeed=Ms.INSTANT;walkDir=-1;runDir=-1;waypointIndex=-1;waypoints=new Int32Array(25);lastX=-1;lastZ=-1;tele=!1;jump=!1;lastStepX=-1;lastStepZ=-1;stepsTaken=0;lastInt=-1;lastCrawl=!1;walktrigger=-1;walktriggerArg=0;orientation=Xe;interacted=!1;repathed=!1;target=null;targetOp=-1;targetSubject={type:-1,com:-1};targetX=-1;targetZ=-1;apRange=10;apRangeCalled=!1;alreadyFacedCoord=!1;alreadyFacedEntity=!1;mask=0;exactStartX=-1;exactStartZ=-1;exactEndX=-1;exactEndZ=-1;exactMoveStart=-1;exactMoveEnd=-1;exactMoveDirection=-1;faceX=-1;faceZ=-1;faceEntity=-1;damageTaken=-1;damageType=-1;animId=-1;animDelay=-1;chat=null;graphicId=-1;graphicHeight=-1;graphicDelay=-1;constructor(t,e,n,s,i,a,r,o,c,l,h){super(t,e,n,s,i,a),this.moveRestrict=r,this.blockWalk=o,this.moveStrategy=c,this.coordmask=l,this.entitymask=h,this.lastStepX=e-1,this.lastStepZ=n}processMovement(){return!(!this.hasWaypoints()||this.moveSpeed===Ms.STATIONARY||this.moveSpeed===Ms.INSTANT)&&(this.moveSpeed===Ms.CRAWL?(this.lastCrawl=!this.lastCrawl,this.lastCrawl&&-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep()),!0):(-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep(),this.moveSpeed===Ms.RUN&&-1!==this.walkDir&&-1===this.runDir&&(this.runDir=this.validateAndAdvanceStep())),!0))}refreshZonePresence(t,e,n){if(this.x!=t||this.z!==e||this.level!==n){switch(this.blockWalk){case at.NPC:tl.gameMap.changeNpcCollision(this.width,t,e,n,!1),tl.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0);break;case at.ALL:tl.gameMap.changeNpcCollision(this.width,t,e,n,!1),tl.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0),tl.gameMap.changePlayerCollision(this.width,t,e,n,!1),tl.gameMap.changePlayerCollision(this.width,this.x,this.z,this.level,!0)}this.lastStepX=t,this.lastStepZ=e}qe.zone(t)===qe.zone(this.x)&&qe.zone(e)===qe.zone(this.z)&&n==this.level||(tl.getZone(t,e,n).leave(this),tl.getZone(this.x,this.z,this.level).enter(this))}validateAndAdvanceStep(){const t=this.takeStep();if(null===t)return-1;if(-1===t)return this.waypointIndex--,-1!=this.waypointIndex?this.validateAndAdvanceStep():-1;const e=this.x,n=this.z;return this.x=qe.moveX(this.x,t),this.z=qe.moveZ(this.z,t),this.orientation=t,this.stepsTaken++,this.refreshZonePresence(e,n,this.level),t}queueWaypoint(t,e){this.waypoints[0]=qe.packCoord(0,t,e),this.waypointIndex=0}queueWaypoints(t){let e=-1;for(let n=t.length-1,s=0;n>=0&&s<this.waypoints.length;n--,s++)this.waypoints[s]=t[n],e++;this.waypointIndex=e}clearWaypoints(){this.waypointIndex=-1}teleJump(t,e,n){this.teleport(t,e,n),this.jump=!0}teleport(t,e,n){isNaN(n)&&(n=0),n=Math.max(0,Math.min(n,3));const s=this.x,i=this.z,a=this.level;this.x=t,this.z=e,this.level=n,this.refreshZonePresence(s,i,a),this.lastStepX=this.x-1,this.lastStepZ=this.z,this.moveSpeed=Ms.INSTANT,a!=n&&(this.jump=!0)}validateDistanceWalked(){qe.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length})>2&&(this.jump=!0)}convertMovementDir(){let t=this.walkDir,e=this.runDir,n=this.moveSpeed===Ms.INSTANT;const s=qe.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length});if(n&&!this.jump&&s<=2){if(2===s){const n=(this.x+this.lastX)/2|0,s=(this.z+this.lastZ)/2|0;t=qe.face(this.lastX,this.lastZ,n,s),e=qe.face(n,s,this.x,this.z)}else t=qe.face(this.lastX,this.lastZ,this.x,this.z),e=-1;n=!1}this.walkDir=t,this.runDir=e,this.tele=n}hasWaypoints(){return-1!==this.waypointIndex}isLastOrNoWaypoint(){return this.waypointIndex<=0}inOperableDistance(t){if(t.level!==this.level)return!1;if(t instanceof xs)return Le(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,t.orientation,-2);if(t instanceof hs){const e=et.get(t.type).forceapproach;return Le(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,t.angle,t.shape,e)}const e=Le(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,0,-2);return fe(t.x,t.z,t.level,He.WALK_BLOCKED)?e:!(this.hasWaypoints()||!e)||Le(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,0,-1)}inApproachDistance(t,e){return e.level===this.level&&(!(e instanceof xs&&qe.intersects(this.x,this.z,this.width,this.length,e.x,e.z,e.width,e.length))&&(qe.distanceTo(this,e)<=t&&Te(this.level,this.x,this.z,e.x,e.z,this.width,this.length,e.width,e.length,He.PLAYER)))}pathToMoveClick(t,e){if(this.moveStrategy===ks.SMART)if(e){const{x:e,z:n}=qe.unpackCoord(t[0]);this.queueWaypoints(ce(this.level,this.x,this.z,e,n))}else this.queueWaypoints(t);else{const{x:e,z:n}=qe.unpackCoord(t[t.length-1]);this.queueWaypoint(e,n)}}pathToPathingTarget(){this.target&&this.target instanceof xs&&this.isLastOrNoWaypoint()&&(this.targetOp!==Os.APPLAYER3&&this.targetOp!==Os.OPPLAYER3?this.pathToTarget():this.queueWaypoint(this.target.lastStepX,this.target.lastStepZ))}pathToTarget(){if(this.target)if(this.targetX=this.target.x,this.targetZ=this.target.z,this.moveStrategy===ks.SMART)if(this.target instanceof xs)this.queueWaypoints(ce(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.orientation,-2));else if(this.target instanceof hs){const t=et.get(this.target.type).forceapproach;this.queueWaypoints(ce(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.angle,this.target.shape,!0,t))}else this.queueWaypoints(ce(this.level,this.x,this.z,this.target.x,this.target.z));else if(this.moveStrategy===ks.NAIVE){const t=this.getCollisionStrategy();if(null===t)return;const e=this.blockWalkFlag();if(e===He.NULL)return;this.target instanceof xs?this.queueWaypoints(le(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.length,this.target.width,this.target.length,e,t)):this.queueWaypoint(this.target.x,this.target.z)}else{if(null===this.getCollisionStrategy())return;if(this.blockWalkFlag()===He.NULL)return;this.queueWaypoint(this.target.x,this.target.z)}}setInteraction(t,e,n,s){if(this.target=e,this.targetOp=n,this.targetSubject=s??{type:-1,com:-1},this.targetX=e.x,this.targetZ=e.z,this.apRange=10,this.apRangeCalled=!1,e instanceof Br){const t=e.pid+32768;this.faceEntity!==t&&(this.faceEntity=t,this.mask|=this.entitymask)}else if(e instanceof Hc){const t=e.nid;this.faceEntity!==t&&(this.faceEntity=t,this.mask|=this.entitymask)}else{const t=2*e.x+e.width,n=2*e.z+e.length;this.faceX===t&&this.faceZ===n||(this.faceX=t,this.faceZ=n,this.mask|=this.coordmask)}t===As.SCRIPT&&this.pathToTarget()}clearInteraction(){this.target=null,this.targetOp=-1,this.targetSubject={type:-1,com:-1},this.targetX=-1,this.targetZ=-1,this.apRange=10,this.apRangeCalled=!1,this.alreadyFacedCoord=!0,this.alreadyFacedEntity=!0}getCollisionStrategy(){return this.moveRestrict===ct.NORMAL?We.NORMAL:this.moveRestrict===ct.BLOCKED?We.BLOCKED:this.moveRestrict===ct.BLOCKED_NORMAL?We.LINE_OF_SIGHT:this.moveRestrict===ct.INDOORS?We.INDOORS:this.moveRestrict===ct.OUTDOORS?We.OUTDOORS:this.moveRestrict===ct.NOMOVE?null:this.moveRestrict===ct.PASSTHRU?We.NORMAL:null}resetPathingEntity(){this.moveSpeed=this.defaultMoveSpeed(),this.walkDir=-1,this.runDir=-1,this.jump=!1,this.tele=!1,this.lastX=this.x,this.lastZ=this.z,this.stepsTaken=0,this.interacted=!1,this.apRangeCalled=!1,this.mask=0,this.exactStartX=-1,this.exactStartZ=-1,this.exactEndX=-1,this.exactEndZ=-1,this.exactMoveStart=-1,this.exactMoveEnd=-1,this.exactMoveDirection=-1,this.animId=-1,this.animDelay=-1,this.animId=-1,this.animDelay=-1,this.chat=null,this.damageTaken=-1,this.damageType=-1,this.graphicId=-1,this.graphicHeight=-1,this.graphicDelay=-1,-1!==this.faceX?this.orientation=qe.face(this.x,this.z,this.faceX,this.faceZ):this.target&&(this.orientation=qe.face(this.x,this.z,this.target.x,this.target.z)),this.alreadyFacedCoord&&-1!==this.faceX&&!this.hasWaypoints()?(this.faceX=-1,this.faceZ=-1,this.alreadyFacedCoord=!1):this.alreadyFacedEntity&&!this.target&&-1!==this.faceEntity&&(this.mask|=this.entitymask,this.faceEntity=-1,this.alreadyFacedEntity=!1)}takeStep(){if(-1===this.waypointIndex)return null;const t=this.x,e=this.z,{x:n,z:s}=qe.unpackCoord(this.waypoints[this.waypointIndex]),i=qe.face(t,e,n,s),a=qe.deltaX(i),r=qe.deltaZ(i);if(0==a&&0==r)return-1;const o=this.getCollisionStrategy();if(null===o)return-1;const c=this.blockWalkFlag();return c===He.NULL?-1:this.moveStrategy===ks.FLY||Ae(this.level,this.x,this.z,a,r,this.width,c,o)?i:0!=a&&Ae(this.level,this.x,this.z,a,0,this.width,c,o)?qe.face(t,e,n,e):0!=r&&Ae(this.level,this.x,this.z,0,r,this.width,c,o)?qe.face(t,e,t,s):null}}class Bs{sentinel;cursor=null;constructor(){const t=new m;t.nextHashable=t,t.prevHashable=t,this.sentinel=t}push(t){t.prevHashable&&t.uncache(),t.prevHashable=this.sentinel.prevHashable,t.nextHashable=this.sentinel,t.prevHashable&&(t.prevHashable.nextHashable=t),t.nextHashable.prevHashable=t}pop(){const t=this.sentinel.nextHashable;return t===this.sentinel?null:(t?.uncache(),t)}head(){const t=this.sentinel.nextHashable;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.nextHashable||null,t)}next(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.nextHashable||null,t)}}var Hs,Fs,Gs=new Map,Ws=new Map;class zs extends m{}class Vs{static LOW=new Vs;static HIGH=new Vs}class Ys extends zs{priority=Vs.LOW}class Ks extends zs{uid;priority=Vs.HIGH;constructor(t){super(),this.uid=t}}class js extends zs{priority=Vs.HIGH}class Zs extends zs{priority=Vs.HIGH}class Js extends zs{component;priority=Vs.LOW;constructor(t){super(),this.component=t}}class $s extends zs{component;priority=Vs.HIGH;constructor(t){super(),this.component=t}}class Xs extends zs{varp;value;priority=Vs.HIGH;constructor(t,e){super(),this.varp=t,this.value=e}}class Qs extends zs{varp;value;priority=Vs.HIGH;constructor(t,e){super(),this.varp=t,this.value=e}}class qs extends zs{name;crc;length;priority=Vs.LOW;constructor(t,e,n){super(),this.name=t,this.crc=e,this.length=n}}class ti extends zs{delay;data;priority=Vs.LOW;constructor(t,e){super(),this.delay=t,this.data=e}}class ei extends zs{component;tab;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.tab=e}}class ni extends zs{priority=Vs.HIGH}class si extends zs{type;nid;pid;x;z2;y2;priority=Vs.LOW;constructor(t,e,n,s,i,a){super(),this.type=t,this.nid=e,this.pid=n,this.x=s,this.z=i,this.y=a}}class ii extends zs{lastLoginIp;daysSinceLogin;daysSinceRecoveryChange;unreadMessageCount;priority=Vs.LOW;constructor(t,e,n,s){super(),this.lastLoginIp=t,this.daysSinceLogin=e,this.daysSinceRecoveryChange=n,this.unreadMessageCount=s}}class ai extends zs{msg;priority=Vs.HIGH;constructor(t){super(),this.msg=t}}(Fs=Hs||={})[Fs.ENCLOSED=0]='ENCLOSED',Fs[Fs.FOLLOWS=1]='FOLLOWS';var ri=Hs;class oi extends zs{zoneX;zoneZ;originX;originZ;data;priority=Vs.HIGH;constructor(t,e,n,s,i){super(),this.zoneX=t,this.zoneZ=e,this.originX=n,this.originZ=s,this.data=i}}class ci extends zs{zoneX;zoneZ;originX;originZ;priority=Vs.HIGH;constructor(t,e,n,s){super(),this.zoneX=t,this.zoneZ=e,this.originX=n,this.originZ=s}}class li extends zs{zoneX;zoneZ;originX;originZ;priority=Vs.HIGH;constructor(t,e,n,s){super(),this.zoneX=t,this.zoneZ=e,this.originX=n,this.originZ=s}}class hi extends zs{coord;priority=Vs.HIGH;constructor(t){super(),this.coord=t}}class di extends hi{coord;obj;count;constructor(t,e,n){super(t),this.coord=t,this.obj=e,this.count=n}}class pi extends hi{coord;loc;shape;angle;constructor(t,e,n,s){super(t),this.coord=t,this.loc=e,this.shape=n,this.angle=s}}class _i extends hi{coord;shape;angle;constructor(t,e,n){super(t),this.coord=t,this.shape=e,this.angle=n}}class ui extends hi{srcX;srcZ;dstX;dstZ;target;spotanim;srcHeight;dstHeight;startDelay;endDelay;peak;arc;constructor(t,e,n,s,i,a,r,o,c,l,h,d){super(qe.packZoneCoord(t,e)),this.srcX=t,this.srcZ=e,this.dstX=n,this.dstZ=s,this.target=i,this.spotanim=a,this.srcHeight=r,this.dstHeight=o,this.startDelay=c,this.endDelay=l,this.peak=h,this.arc=d}}class gi extends hi{coord;spotanim;height;delay;constructor(t,e,n,s){super(t),this.coord=t,this.spotanim=e,this.height=n,this.delay=s}}class mi extends hi{coord;obj;constructor(t,e){super(t),this.coord=t,this.obj=e}}class Ei extends hi{coord;obj;oldCount;newCount;constructor(t,e,n,s){super(t),this.coord=t,this.obj=e,this.oldCount=n,this.newCount=s}}class Oi extends hi{coord;obj;count;receiverId;constructor(t,e,n,s){super(t),this.coord=t,this.obj=e,this.count=n,this.receiverId=s}}class fi extends hi{coord;shape;angle;seq;constructor(t,e,n,s){super(t),this.coord=t,this.shape=e,this.angle=n,this.seq=s}}class Ai extends hi{srcX;srcZ;shape;angle;locId;startCycle;endCycle;pid;east;south;west;north;constructor(t,e,n,s,i,a,r,o,c,l,h,d){super(qe.packZoneCoord(t,e)),this.srcX=t,this.srcZ=e,this.shape=n,this.angle=s,this.locId=i,this.startCycle=a,this.endCycle=r,this.pid=o,this.east=c,this.south=l,this.west=h,this.north=d}}class Ti{test(t){return this.prot.length}}class Ii extends Ti{prot=bs.IF_OPENCHATMODAL;encode(t,e){t.p2(e.component)}}class Ni extends zs{component;priority=Vs.LOW;constructor(t){super(),this.component=t}}class Pi extends zs{buildArea;level;x;z2;originX;originZ;uid;mask;tele;jump2;walkDir;runDir;priority=Vs.HIGH;accumulator=0;constructor(t,e,n,s,i,a,r,o,c,l,h,d){super(),this.buildArea=t,this.level=e,this.x=n,this.z=s,this.originX=i,this.originZ=a,this.uid=r,this.mask=o,this.tele=c,this.jump=l,this.walkDir=h,this.runDir=d}}class Li extends Ti{static BITS_NEW=34;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=bs.PLAYER_INFO;encode(t,e){const n=e.buildArea;n.resize(),this.writeLocalPlayer(t,e),this.writePlayers(t,e),this.writeNewPlayers(t,e);const s=n.extendedInfo;if(s.size>0)for(const n of s){const s=tl.getPlayerByUid(n.id);s&&this.writeUpdate(s,e,t,n.id===e.uid,n.added)}n.reset()}test(t){return Li.BYTES_LIMIT}writeLocalPlayer(t,e){const{buildArea:n,uid:s,level:i,x:a,z:r,mask:o,tele:c,jump:l,walkDir:h,runDir:d}=e,p=tl.getPlayerByUid(s);p&&(t.bits(),t.pBit(1,c||-1!==h||-1!==d||o>0?1:0),c?(t.pBit(2,3),t.pBit(2,i),t.pBit(7,qe.local(a)),t.pBit(7,qe.local(r)),t.pBit(1,l?1:0),t.pBit(1,o>0?1:0)):-1!==d?(t.pBit(2,2),t.pBit(3,h),t.pBit(3,d),t.pBit(1,o>0?1:0)):-1!==h?(t.pBit(2,1),t.pBit(3,h),t.pBit(1,o>0?1:0)):o>0&&t.pBit(2,0),o>0&&(n.extendedInfo.add({id:s,added:!1}),e.accumulator+=this.calculateUpdateSize(p,e,!0,!0)))}writePlayers(t,e){const n=e.buildArea;t.pBit(8,n.players.size);for(const s of n.players){const i=tl.getPlayerByUid(s);if(!i||i.tele||i.level!==e.level||!qe.isWithinDistanceSW(e,i,n.viewDistance)||!i.checkLifeCycle(tl.currentTick)){t.pBit(1,1),t.pBit(2,3),n.players.delete(s);continue}let a=i.mask>0;const{walkDir:r,runDir:o}=i;let c=0;-1!==o?c=Li.BITS_RUN:-1!==r?c=Li.BITS_WALK:a&&(c=Li.BITS_EXTENDED);const l=a?this.calculateUpdateSize(i,e,!1,!1):0;(t.bitPos+c+7+24>>>3)+t.pos+(e.accumulator+=l)>this.test(e)&&(a=!1),t.pBit(1,-1!==r||-1!==o||a?1:0),-1!==o?(t.pBit(2,2),t.pBit(3,r),t.pBit(3,o),t.pBit(1,a?1:0)):-1!==r?(t.pBit(2,1),t.pBit(3,r),t.pBit(1,a?1:0)):a&&t.pBit(2,0),a&&n.extendedInfo.add({id:s,added:!1})}}writeNewPlayers(t,e){const n=e.buildArea;for(const s of n.getNearbyPlayers(e.uid,e.x,e.z,e.originX,e.originZ)){const i=!n.hasAppearance(s.pid,s.appearanceHashCode),a=i?this.calculateUpdateSize(s,e,!1,!0):0;if((t.bitPos+Li.BITS_NEW+7+24>>>3)+t.pos+(e.accumulator+=a)>this.test(e))break;t.pBit(11,s.pid),t.pBit(5,s.x-e.x),t.pBit(5,s.z-e.z),t.pBit(1,s.jump?1:0),t.pBit(1,i?1:0),i&&n.extendedInfo.add({id:s.uid,added:!0}),n.players.add(s.uid)}n.extendedInfo.size>0&&t.pBit(11,2047),t.bytes()}writeUpdate(t,e,n,s=!1,i=!1){let a=t.mask;if(i&&(a|=Br.APPEARANCE),!i||-1===t.orientation&&-1===t.faceX&&-1===t.faceZ||(a|=Br.FACE_COORD),i&&-1!==t.faceEntity&&(a|=Br.FACE_ENTITY),a>255&&(a|=Br.BIG_UPDATE),s&&a&Br.CHAT&&(a&=~Br.CHAT),e.buildArea.hasAppearance(t.pid,t.appearanceHashCode)&&(a&=~Br.APPEARANCE),n.p1(255&a),a&Br.BIG_UPDATE&&n.p1(a>>8),a&Br.APPEARANCE&&(n.p1(t.appearance.length),n.pdata(t.appearance,0,t.appearance.length),e.buildArea.saveAppearance(t.pid,t.appearanceHashCode)),a&Br.ANIM&&(n.p2(t.animId),n.p1(t.animDelay)),a&Br.FACE_ENTITY&&(-1!==t.faceEntity&&(t.alreadyFacedEntity=!0),n.p2(t.faceEntity)),a&Br.SAY&&n.pjstr(t.chat??''),a&Br.DAMAGE&&(n.p1(t.damageTaken),n.p1(t.damageType),n.p1(t.levels[sn.HITPOINTS]),n.p1(t.baseLevels[sn.HITPOINTS])),a&Br.FACE_COORD)if(-1!==t.faceX&&(t.alreadyFacedCoord=!0),i&&-1!==t.faceX)n.p2(t.faceX),n.p2(t.faceZ);else if(i&&-1!==t.orientation){const e=qe.moveX(t.x,t.orientation),s=qe.moveZ(t.z,t.orientation);n.p2(2*e+1),n.p2(2*s+1)}else n.p2(t.faceX),n.p2(t.faceZ);a&Br.CHAT&&(n.p1(t.messageColor),n.p1(t.messageEffect),n.p1(t.messageType),n.p1(t.message.length),n.pdata(t.message,0,t.message.length)),a&Br.SPOTANIM&&(n.p2(t.graphicId),n.p2(t.graphicHeight),n.p2(t.graphicDelay)),a&Br.EXACT_MOVE&&(n.p1(t.exactStartX-qe.zoneOrigin(e.originX)),n.p1(t.exactStartZ-qe.zoneOrigin(e.originZ)),n.p1(t.exactEndX-qe.zoneOrigin(e.originX)),n.p1(t.exactEndZ-qe.zoneOrigin(e.originZ)),n.p2(t.exactMoveStart),n.p2(t.exactMoveEnd),n.p1(t.exactMoveDirection))}calculateUpdateSize(t,e,n=!1,s=!1){let i=0,a=t.mask;return s&&(a|=Br.APPEARANCE),!s||-1===t.orientation&&-1===t.faceX&&-1===t.faceZ||(a|=Br.FACE_COORD),s&&-1!==t.faceEntity&&(a|=Br.FACE_ENTITY),a>255&&(a|=Br.BIG_UPDATE),n&&a&Br.CHAT&&(a&=~Br.CHAT),e.buildArea.hasAppearance(t.pid,t.appearanceHashCode)&&(a&=~Br.APPEARANCE),i+=1,a&Br.BIG_UPDATE&&(i+=1),a&Br.APPEARANCE&&(i+=1,i+=t.appearance?.length??0),a&Br.ANIM&&(i+=3),a&Br.FACE_ENTITY&&(i+=2),a&Br.SAY&&(i+=(t.chat?.length??0)+1),a&Br.DAMAGE&&(i+=4),a&Br.FACE_COORD&&(i+=4),a&Br.CHAT&&(i+=4,i+=t.message?.length??0),a&Br.SPOTANIM&&(i+=6),a&Br.EXACT_MOVE&&(i+=9),i}}class Si extends zs{zoneX;zoneZ;priority=Vs.HIGH;constructor(t,e){super(),this.zoneX=t,this.zoneZ=e}get mapsquares(){const t=this.zoneX-6,e=this.zoneX+6,n=this.zoneZ-6,s=this.zoneZ+6,i=new Set;for(let a=t;a<=e;a++){const t=qe.mapsquare(a<<3);for(let e=n;e<=s;e++){const n=qe.mapsquare(e<<3);i.add(t<<8|n)}}return i}}class Ci extends Ti{prot=bs.REBUILD_NORMAL;encode(t,e){t.p2(e.zoneX),t.p2(e.zoneZ);for(const n of e.mapsquares){const e=n>>8,s=255&n;t.p1(e),t.p1(s),t.p4(Ws.get(`m${e}_${s}`)??0),t.p4(Ws.get(`l${e}_${s}`)??0)}}test(t){return 4+10*t.mapsquares.size}}class yi extends zs{x;z2;offset;length;data;priority=Vs.HIGH;constructor(t,e,n,s,i){super(),this.x=t,this.z=e,this.offset=n,this.length=s,this.data=i}}class vi extends Ti{prot=bs.DATA_LAND;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.offset),t.p2(e.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class wi extends zs{x;z2;priority=Vs.HIGH;constructor(t,e){super(),this.x=t,this.z=e}}class Ri extends Ti{prot=bs.DATA_LAND_DONE;encode(t,e){t.p1(e.x),t.p1(e.z)}}class bi extends zs{x;z2;offset;length;data;priority=Vs.HIGH;constructor(t,e,n,s,i){super(),this.x=t,this.z=e,this.offset=n,this.length=s,this.data=i}}class Ui extends Ti{prot=bs.DATA_LOC;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.offset),t.p2(e.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class Di extends zs{x;z2;priority=Vs.HIGH;constructor(t,e){super(),this.x=t,this.z=e}}class Mi extends Ti{prot=bs.DATA_LOC_DONE;encode(t,e){t.p1(e.x),t.p1(e.z)}}class ki extends zs{x;z2;height;speed;multiplier;priority=Vs.LOW;constructor(t,e,n,s,i){super(),this.x=t,this.z=e,this.height=n,this.speed=s,this.multiplier=i}}class xi extends Ti{prot=bs.CAM_LOOKAT;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.height),t.p1(e.speed),t.p1(e.multiplier)}}class Bi extends zs{x;z2;height;speed;multiplier;priority=Vs.LOW;constructor(t,e,n,s,i){super(),this.x=t,this.z=e,this.height=n,this.speed=s,this.multiplier=i}}class Hi extends Ti{prot=bs.CAM_MOVETO;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.height),t.p1(e.speed),t.p1(e.multiplier)}}class Fi extends zs{priority=Vs.LOW}class Gi extends Ti{prot=bs.CAM_RESET;encode(t,e){}}class Wi extends zs{type;jitter;amplitude;frequency;priority=Vs.LOW;constructor(t,e,n,s){super(),this.type=t,this.jitter=e,this.amplitude=n,this.frequency=s}}class zi extends Ti{prot=bs.CAM_SHAKE;encode(t,e){t.p1(e.type),t.p1(e.jitter),t.p1(e.amplitude),t.p1(e.frequency)}}class Vi extends zs{publicChat;privateChat;tradeDuel;priority=Vs.HIGH;constructor(t,e,n){super(),this.publicChat=t,this.privateChat=e,this.tradeDuel=n}}class Yi extends Ti{prot=bs.CHAT_FILTER_SETTINGS;encode(t,e){t.p1(e.publicChat),t.p1(e.privateChat),t.p1(e.tradeDuel)}}class Ki extends zs{priority=Vs.LOW}class ji extends Ti{prot=bs.ENABLE_TRACKING;encode(t,e){}}class Zi extends zs{priority=Vs.LOW}class Ji extends Ti{prot=bs.FINISH_TRACKING;encode(t,e){}}class $i extends Ti{prot=bs.HINT_ARROW;encode(t,e){const{type:n,nid:s,pid:i,x:a,z:r,y:o}=e;1===n?(t.p1(n),t.p2(s),t.p2(0),t.p1(0)):n>=2&&n<=6?(t.p1(n),t.p2(a),t.p2(r),t.p1(o)):10===n?(t.p1(n),t.p2(i),t.p2(0),t.p1(0)):-1===n&&(t.p1(-1),t.p2(0),t.p2(0),t.p1(0))}}class Xi extends Ti{prot=bs.IF_CLOSE;encode(t,e){}}class Qi extends zs{component;priority=Vs.LOW;constructor(t){super(),this.component=t}}class qi extends Ti{prot=bs.IF_OPENMAINMODAL;encode(t,e){t.p2(e.component)}}class ta extends zs{main;side;priority=Vs.LOW;constructor(t,e){super(),this.main=t,this.side=e}}class ea extends Ti{prot=bs.IF_OPENMAINSIDEMODAL;encode(t,e){t.p2(e.main),t.p2(e.side)}}class na extends zs{component;priority=Vs.LOW;constructor(t){super(),this.component=t}}class sa extends Ti{prot=bs.IF_OPENSIDEMODAL;encode(t,e){t.p2(e.component)}}class ia extends Ti{prot=bs.IF_OPENSIDEOVERLAY;encode(t,e){t.p2(e.component),t.p1(e.tab)}}class aa extends zs{component;seq;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.seq=e}}class ra extends Ti{prot=bs.IF_SETANIM;encode(t,e){t.p2(e.component),t.p2(e.seq)}}class oa extends zs{component;colour;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.colour=e}}class ca extends Ti{prot=bs.IF_SETCOLOUR;encode(t,e){t.p2(e.component),t.p2(e.colour)}}class la extends zs{component;hidden;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.hidden=e}}class ha extends Ti{prot=bs.IF_SETHIDE;encode(t,e){t.p2(e.component),t.pbool(e.hidden)}}class da extends zs{component;model;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.model=e}}class pa extends Ti{prot=bs.IF_SETMODEL;encode(t,e){t.p2(e.component),t.p2(e.model)}}class _a extends zs{component;npc;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.npc=e}}class ua extends Ti{prot=bs.IF_SETNPCHEAD;encode(t,e){t.p2(e.component),t.p2(e.npc)}}class ga extends zs{component;obj;scale;priority=Vs.LOW;constructor(t,e,n){super(),this.component=t,this.obj=e,this.scale=n}}class ma extends Ti{prot=bs.IF_SETOBJECT;encode(t,e){t.p2(e.component),t.p2(e.obj),t.p2(e.scale)}}class Ea extends zs{component;priority=Vs.LOW;constructor(t){super(),this.component=t}}class Oa extends Ti{prot=bs.IF_SETPLAYERHEAD;encode(t,e){t.p2(e.component)}}class fa extends zs{component;x;y2;priority=Vs.LOW;constructor(t,e,n){super(),this.component=t,this.x=e,this.y=n}}class Aa extends Ti{prot=bs.IF_SETPOSITION;encode(t,e){t.p2(e.component),t.p2(e.x),t.p2(e.y)}}class Ta extends zs{component;src;dst;priority=Vs.LOW;constructor(t,e,n){super(),this.component=t,this.src=e,this.dst=n}}class Ia extends Ti{prot=bs.IF_SETRECOL;encode(t,e){t.p2(e.component),t.p2(e.src),t.p2(e.dst)}}class Na extends zs{component;text;priority=Vs.LOW;constructor(t,e){super(),this.component=t,this.text=e}}class Pa extends Ti{prot=bs.IF_SETTEXT;encode(t,e){t.p2(e.component),t.pjstr(e.text)}test(t){return 3+t.text.length}}class La extends zs{tab;priority=Vs.LOW;constructor(t){super(),this.tab=t}}class Sa extends Ti{prot=bs.IF_SHOWSIDE;encode(t,e){t.p1(e.tab)}}class Ca extends Ti{prot=bs.LAST_LOGIN_INFO;encode(t,e){t.p4(e.lastLoginIp),t.p2(e.daysSinceLogin),t.p1(e.daysSinceRecoveryChange),t.p2(e.unreadMessageCount)}}class ya extends bs{static LOC_MERGE=new ya(23,14);static LOC_ANIM=new ya(42,4);static OBJ_DEL=new ya(49,3);static OBJ_REVEAL=new ya(50,7);static LOC_ADD_CHANGE=new ya(59,4);static MAP_PROJANIM=new ya(69,15);static LOC_DEL=new ya(76,2);static OBJ_COUNT=new ya(151,7);static MAP_ANIM=new ya(191,6);static OBJ_ADD=new ya(223,5)}class va extends Ti{enclose(t){const e=new E(new Uint8Array(1+this.prot.length));return e.p1(this.prot.id),this.encode(e,t),e.data}}class wa extends va{prot=ya.LOC_ADD_CHANGE;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.loc)}}class Ra extends va{prot=ya.LOC_ANIM;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.seq)}}class ba extends va{prot=ya.LOC_DEL;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle)}}class Ua extends va{prot=ya.LOC_MERGE;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.locId),t.p2(e.startCycle),t.p2(e.endCycle),t.p2(e.pid),t.p1(e.east-e.srcX),t.p1(e.south-e.srcZ),t.p1(e.west-e.srcX),t.p1(e.north-e.srcZ)}}class Da extends zs{priority=Vs.HIGH}class Ma extends Ti{prot=bs.LOGOUT;encode(t,e){}}class ka extends va{prot=ya.MAP_ANIM;encode(t,e){t.p1(e.coord),t.p2(e.spotanim),t.p1(e.height),t.p2(e.delay)}}class xa extends va{prot=ya.MAP_PROJANIM;encode(t,e){t.p1(e.coord),t.p1(e.dstX-e.srcX),t.p1(e.dstZ-e.srcZ),t.p2(e.target),t.p2(e.spotanim),t.p1(e.srcHeight),t.p1(e.dstHeight),t.p2(e.startDelay),t.p2(e.endDelay),t.p1(e.peak),t.p1(e.arc)}}class Ba extends Ti{prot=bs.MESSAGE_GAME;encode(t,e){t.pjstr(e.msg)}test(t){return 1+t.msg.length}}class Ha{static CHAR_LOOKUP=[' ','e','t','a','o','i','h','n','s','r','d','l','u','m','w','c','y','f','g','p','b','v','k','x','j','q','z','0','1','2','3','4','5','6','7','8','9',' ','!','?','.',',',':',';','(',')','-','&','*','\\',"'",'@','#','+','=','£','$','%','"','[',']'];static unpack(t,e){const n=[];let s,i=0,a=-1;for(let r=0;r<e&&i<80;r++){const e=t.g1();s=e>>4&15,-1!==a?(n[i++]=this.CHAR_LOOKUP[(a<<4)+s-195],a=-1):s<13?n[i++]=this.CHAR_LOOKUP[s]:a=s,s=15&e,-1!=a?(n[i++]=this.CHAR_LOOKUP[(a<<4)+s-195],a=-1):s<13?n[i++]=this.CHAR_LOOKUP[s]:a=s}return this.toSentenceCase(n.slice(0,i).join(''))}static pack(t,e){e.length>80&&(e=e.substring(0,80)),e=e.toLowerCase();let n=-1;for(let s=0;s<e.length;s++){const i=e.charAt(s);let a=0;for(let t=0;t<this.CHAR_LOOKUP.length;t++)if(i===this.CHAR_LOOKUP[t]){a=t;break}a>12&&(a+=195),-1==n?a<13?n=a:t.p1(a):a<13?(t.p1((n<<4)+a),n=-1):(t.p1((n<<4)+(a>>4)),n=15&a)}-1!=n&&t.p1(n<<4)}static toSentenceCase(t){const e=[...t.toLowerCase()];let n=!0;for(let t=0;t<e.length;t++){const s=e[t];n&&s>='a'&&s<='z'&&(e[t]=s.toUpperCase(),n=!1),'.'!==s&&'!'!==s||(n=!0)}return e.join('')}}class Fa extends Ti{prot=bs.MESSAGE_PRIVATE;encode(t,e){t.p8(e.from),t.p4(e.messageId),t.p1(e.staffModLevel),Ha.pack(t,Lt.filter(e.msg))}test(t){return 14+t.msg.length}}class Ga extends zs{from;messageId;staffModLevel;msg;priority=Vs.HIGH;constructor(t,e,n,s){super(),this.from=t,this.messageId=e,this.staffModLevel=n,this.msg=s}}class Wa extends Ti{prot=bs.MIDI_JINGLE;encode(t,e){t.p2(e.delay),t.p4(e.data.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class za extends Ti{prot=bs.MIDI_SONG;encode(t,e){t.pjstr(e.name),t.p4(e.crc),t.p4(e.length)}test(t){return 1+t.name.length+4+4}}class Va extends va{prot=ya.OBJ_ADD;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.count,65535))}}class Ya extends va{prot=ya.OBJ_COUNT;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.oldCount,65535)),t.p2(Math.min(e.newCount,65535))}}class Ka extends va{prot=ya.OBJ_DEL;encode(t,e){t.p1(e.coord),t.p2(e.obj)}}class ja extends va{prot=ya.OBJ_REVEAL;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.count,65535)),t.p2(e.receiverId)}}class Za extends zs{priority=Vs.LOW}class Ja extends Ti{prot=bs.P_COUNTDIALOG;encode(t,e){}}class $a extends Ti{prot=bs.RESET_ANIMS;encode(t,e){}}class Xa extends Ti{prot=bs.RESET_CLIENT_VARCACHE;encode(t,e){}}class Qa extends zs{hidden;priority=Vs.LOW;constructor(t){super(),this.hidden=t}}class qa extends Ti{prot=bs.SET_MULTIWAY;encode(t,e){t.pbool(e.hidden)}}class tr extends zs{synth;loops;delay;priority=Vs.LOW;constructor(t,e,n){super(),this.synth=t,this.loops=e,this.delay=n}}class er extends Ti{prot=bs.SYNTH_SOUND;encode(t,e){t.p2(e.synth),t.p1(e.loops),t.p2(e.delay)}}class nr extends zs{tab;priority=Vs.LOW;constructor(t){super(),this.tab=t}}class sr extends Ti{prot=bs.TUTORIAL_FLASHSIDE;encode(t,e){t.p1(e.tab)}}class ir extends Ti{prot=bs.TUTORIAL_OPENCHAT;encode(t,e){t.p2(e.component)}}class ar extends Ti{prot=bs.UNSET_MAP_FLAG;encode(t,e){}}class rr extends zs{name;nodeId;priority=Vs.LOW;constructor(t,e){super(),this.name=t,this.nodeId=e}}class or extends Ti{prot=bs.UPDATE_FRIENDLIST;encode(t,e){t.p8(e.name),t.p1(e.nodeId)}}class cr extends zs{names;priority=Vs.LOW;constructor(t){super(),this.names=t}}class lr extends Ti{prot=bs.UPDATE_IGNORELIST;encode(t,e){for(const n of e.names)t.p8(n)}test(t){return 8*t.names.length}}class hr extends zs{component;inv;priority=Vs.HIGH;constructor(t,e){super(),this.component=t,this.inv=e}}class dr extends Ti{prot=bs.UPDATE_INV_FULL;encode(t,e){const{component:n,inv:s}=e,i=Z.get(n),a=Math.min(s.capacity,i.width*i.height);t.p2(n),t.p1(a);for(let e=0;e<a;e++){const n=s.get(e);n?(t.p2(n.id+1),n.count>=255?(t.p1(255),t.p4(n.count)):t.p1(n.count)):(t.p2(0),t.p1(0))}}test(t){const{component:e,inv:n}=t,s=Z.get(e),i=Math.min(n.capacity,s.width*s.height);let a=0;a+=3;for(let t=0;t<i;t++){const e=n.get(t);e?(a+=2,e.count>=255?a+=5:a+=1):a+=3}return a}}class pr extends zs{component;inv;priority=Vs.HIGH;slots;constructor(t,e,...n){super(),this.component=t,this.inv=e,this.slots=n}}class _r extends Ti{prot=bs.UPDATE_INV_PARTIAL;encode(t,e){const{component:n,inv:s}=e;t.p2(n);for(const n of e.slots){const e=s.get(n);t.p1(n),e?(t.p2(e.id+1),e.count>=255?(t.p1(255),t.p4(e.count)):t.p1(e.count)):(t.p2(0),t.p1(0))}}test(t){const{inv:e}=t;let n=0;n+=2;for(const s of t.slots){const t=e.get(s);n+=1,t?(n+=2,t.count>=255?n+=5:n+=1):n+=3}return n}}class ur extends Ti{prot=bs.UPDATE_INV_STOP_TRANSMIT;encode(t,e){t.p2(e.component)}}class gr extends zs{energy;priority=Vs.LOW;constructor(t){super(),this.energy=t}}class mr extends Ti{prot=bs.UPDATE_RUNENERGY;encode(t,e){t.p1(e.energy/100|0)}}class Er extends zs{kg;priority=Vs.LOW;constructor(t){super(),this.kg=t}}class Or extends Ti{prot=bs.UPDATE_RUNWEIGHT;encode(t,e){t.p2(e.kg)}}class fr extends zs{stat;exp;level;priority=Vs.LOW;constructor(t,e,n){super(),this.stat=t,this.exp=e,this.level=n}}class Ar extends Ti{prot=bs.UPDATE_STAT;encode(t,e){t.p1(e.stat),t.p4(e.exp/10|0),t.p1(e.level)}}class Tr extends Ti{prot=bs.UPDATE_UID192;encode(t,e){t.p2(e.uid)}}class Ir extends Ti{prot=bs.UPDATE_ZONE_FULL_FOLLOWS;encode(t,e){t.p1((e.zoneX<<3)-qe.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-qe.zoneOrigin(e.originZ))}}class Nr extends Ti{prot=bs.UPDATE_ZONE_PARTIAL_FOLLOWS;encode(t,e){t.p1((e.zoneX<<3)-qe.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-qe.zoneOrigin(e.originZ))}}class Pr extends Ti{prot=bs.UPDATE_ZONE_PARTIAL_ENCLOSED;encode(t,e){t.p1((e.zoneX<<3)-qe.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-qe.zoneOrigin(e.originZ)),t.pdata(e.data,0,e.data.length)}test(t){return 2+t.data.length}}class Lr extends Ti{prot=bs.VARP_LARGE;encode(t,e){t.p2(e.varp),t.p4(e.value)}}class Sr extends Ti{prot=bs.VARP_SMALL;encode(t,e){t.p2(e.varp),t.p1(e.value)}}class Cr extends zs{buildArea;level;x;z2;originX;originZ;priority=Vs.HIGH;accumulator=0;constructor(t,e,n,s,i,a){super(),this.buildArea=t,this.level=e,this.x=n,this.z=s,this.originX=i,this.originZ=a}}class yr extends Ti{static BITS_NEW=35;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=bs.NPC_INFO;encode(t,e){const n=e.buildArea;this.writeNpcs(t,e),this.writeNewNpcs(t,e);const s=n.extendedInfo;if(s.size>0)for(const e of s){const n=tl.getNpc(e.id);n&&this.writeUpdate(n,t,e.added)}n.reset()}test(t){return yr.BYTES_LIMIT}writeNpcs(t,e){const n=e.buildArea;t.bits(),t.pBit(8,n.npcs.size);for(const s of n.npcs){const i=tl.getNpc(s);if(!i||i.tele||i.level!==e.level||!qe.isWithinDistanceSW(e,i,16)||!i.checkLifeCycle(tl.currentTick)){t.pBit(1,1),t.pBit(2,3),n.npcs.delete(s);continue}let a=i.mask>0;const{walkDir:r,runDir:o}=i;let c=0;-1!==o?c=yr.BITS_RUN:-1!==r?c=yr.BITS_WALK:a&&(c=yr.BITS_EXTENDED);const l=a?this.calculateUpdateSize(i,!1):0;(t.bitPos+c+7+24>>>3)+t.pos+(e.accumulator+=l)>this.test(e)&&(a=!1),t.pBit(1,-1!==o||-1!==r||a?1:0),-1!==o?(t.pBit(2,2),t.pBit(3,r),t.pBit(3,o),t.pBit(1,a?1:0)):-1!==r?(t.pBit(2,1),t.pBit(3,r),t.pBit(1,a?1:0)):a&&t.pBit(2,0),a&&n.extendedInfo.add({id:s,added:!1})}}writeNewNpcs(t,e){const n=e.buildArea;for(const s of n.getNearbyNpcs(e.x,e.z,e.originX,e.originZ)){const i=s.mask>0||-1!==s.orientation||-1!==s.faceX||-1!==s.faceZ||-1!==s.faceEntity,a=i?this.calculateUpdateSize(s,!0):0;if((t.bitPos+yr.BITS_NEW+7+24>>>3)+t.pos+(e.accumulator+=a)>this.test(e))break;t.pBit(13,s.nid),t.pBit(11,s.type),t.pBit(5,s.x-e.x),t.pBit(5,s.z-e.z),t.pBit(1,i?1:0),n.npcs.add(s.nid),i&&n.extendedInfo.add({id:s.nid,added:!0})}n.extendedInfo.size>0&&t.pBit(13,8191),t.bytes()}writeUpdate(t,e,n){let s=t.mask;if(!n||-1===t.orientation&&-1===t.faceX&&-1==t.faceZ||(s|=Hc.FACE_COORD),n&&-1!==t.faceEntity&&(s|=Hc.FACE_ENTITY),e.p1(s),s&Hc.ANIM&&(e.p2(t.animId),e.p1(t.animDelay)),s&Hc.FACE_ENTITY&&(-1!==t.faceEntity&&(t.alreadyFacedEntity=!0),e.p2(t.faceEntity)),s&Hc.SAY&&e.pjstr(t.chat??''),s&Hc.DAMAGE&&(e.p1(t.damageTaken),e.p1(t.damageType),e.p1(t.levels[dt.HITPOINTS]),e.p1(t.baseLevels[dt.HITPOINTS])),s&Hc.CHANGE_TYPE&&e.p2(t.type),s&Hc.SPOTANIM&&(e.p2(t.graphicId),e.p2(t.graphicHeight),e.p2(t.graphicDelay)),s&Hc.FACE_COORD)if(-1!==t.faceX&&(t.alreadyFacedCoord=!0),n&&-1!=t.faceX)e.p2(t.faceX),e.p2(t.faceZ);else if(n&&-1!=t.orientation){const n=qe.moveX(t.x,t.orientation),s=qe.moveZ(t.z,t.orientation);e.p2(2*n+1),e.p2(2*s+1)}else e.p2(t.faceX),e.p2(t.faceZ)}calculateUpdateSize(t,e){let n=0,s=t.mask;return!e||-1===t.orientation&&-1===t.faceX&&-1==t.faceZ||(s|=Hc.FACE_COORD),e&&-1!==t.faceEntity&&(s|=Hc.FACE_ENTITY),n+=1,s&Hc.ANIM&&(n+=3),s&Hc.FACE_ENTITY&&(n+=2),s&Hc.SAY&&(n+=(t.chat?.length??0)+1),s&Hc.DAMAGE&&(n+=4),s&Hc.CHANGE_TYPE&&(n+=2),s&Hc.SPOTANIM&&(n+=6),s&Hc.FACE_COORD&&(n+=4),n}}var vr=new class{encoders=new Map;bind(t,e){if(this.encoders.has(t))throw new Error(`[ServerProtRepository] Already defines a ${t.name}.`);this.encoders.set(t,e)}constructor(){this.bind(ki,new xi),this.bind(Bi,new Hi),this.bind(Fi,new Gi),this.bind(Wi,new zi),this.bind(Vi,new Yi),this.bind(yi,new vi),this.bind(wi,new Ri),this.bind(bi,new Ui),this.bind(Di,new Mi),this.bind(Ki,new ji),this.bind(Zi,new Ji),this.bind(si,new $i),this.bind(Ys,new Xi),this.bind(Ni,new Ii),this.bind(Qi,new qi),this.bind(ta,new ea),this.bind(na,new sa),this.bind(ei,new ia),this.bind(aa,new ra),this.bind(oa,new ca),this.bind(la,new ha),this.bind(da,new pa),this.bind(_a,new ua),this.bind(ga,new ma),this.bind(Ea,new Oa),this.bind(fa,new Aa),this.bind(Ta,new Ia),this.bind(Na,new Pa),this.bind(La,new Sa),this.bind(ii,new Ca),this.bind(pi,new wa),this.bind(fi,new Ra),this.bind(_i,new ba),this.bind(Ai,new Ua),this.bind(Da,new Ma),this.bind(gi,new ka),this.bind(ui,new xa),this.bind(ai,new Ba),this.bind(Ga,new Fa),this.bind(ti,new Wa),this.bind(qs,new za),this.bind(Cr,new yr),this.bind(di,new Va),this.bind(Ei,new Ya),this.bind(mi,new Ka),this.bind(Oi,new ja),this.bind(Za,new Ja),this.bind(Pi,new Li),this.bind(Si,new Ci),this.bind(js,new $a),this.bind(Zs,new Xa),this.bind(Qa,new qa),this.bind(tr,new er),this.bind(nr,new sr),this.bind(Js,new ir),this.bind(ni,new ar),this.bind(rr,new or),this.bind(cr,new lr),this.bind(hr,new dr),this.bind(pr,new _r),this.bind($s,new ur),this.bind(gr,new mr),this.bind(Er,new Or),this.bind(fr,new Ar),this.bind(Ks,new Tr),this.bind(ci,new Ir),this.bind(oi,new Pr),this.bind(li,new Nr),this.bind(Qs,new Lr),this.bind(Xs,new Sr)}getEncoder(t){return this.encoders.get(t.constructor)}getZoneEncoder(t){return this.encoders.get(t.constructor)}};class wr{index;x;z;level;players=new Set;npcs=new Set;locs=[];objs=[];events=new Set;shared=null;totalLocs=0;totalObjs=0;constructor(t){this.index=t;const e=br.unpackIndex(t);this.x=e.x>>3,this.z=e.z>>3,this.level=e.level}enter(t){t instanceof Br?(this.players.add(t.uid),tl.getZoneGrid(this.level).flag(this.x,this.z)):t instanceof Hc&&this.npcs.add(t.nid)}leave(t){t instanceof Br?(this.players.delete(t.uid),0===this.players.size&&tl.getZoneGrid(this.level).unflag(this.x,this.z)):t instanceof Hc&&this.npcs.delete(t.nid)}tick(t){let e;do{e=!1;for(const n of this.getAllObjsUnsafe())n.updateLifeCycle(t)&&n.lastLifecycleTick!==t&&(n.lifecycle===Qn.DESPAWN?-1!==n.receiverId?tl.revealObj(n):(tl.removeObj(n,0),e=!0):n.lifecycle===Qn.RESPAWN&&(tl.addObj(n,-1,0),e=!0));for(const n of this.getAllLocsUnsafe())n.updateLifeCycle(t)&&n.lastLifecycleTick!==t&&(n.lifecycle===Qn.DESPAWN?(tl.removeLoc(n,0),e=!0):n.lifecycle===Qn.RESPAWN&&(tl.addLoc(n,0),e=!0))}while(e)}computeShared(){this.shared=null;let t=0;const e=[];for(const n of this.events.values()){if(n.type!==ri.ENCLOSED)continue;const s=vr.getZoneEncoder(n.message);if(void 0===s)continue;const i=s.enclose(n.message);e.push(i),t+=i.length}if(0===e.length||0===t)return;const n=new Uint8Array(t);let s=0;for(const t of e)n.set(t,s),s+=t.length;this.shared=n}writeFullFollows(t){t.write(new ci(this.x,this.z,t.originX,t.originZ));for(const e of this.getAllObjsUnsafe(!0))-1!==e.receiverId&&e.receiverId!==t.pid||(t.write(new li(this.x,this.z,t.originX,t.originZ)),(e.lifecycle===Qn.DESPAWN&&e.checkLifeCycle(tl.currentTick)||e.lifecycle===Qn.RESPAWN&&e.checkLifeCycle(tl.currentTick))&&t.write(new di(qe.packZoneCoord(e.x,e.z),e.type,e.count)));for(const e of this.getAllLocsUnsafe(!0))e.lifecycle===Qn.DESPAWN&&e.checkLifeCycle(tl.currentTick)?t.write(new pi(qe.packZoneCoord(e.x,e.z),e.type,e.shape,e.angle)):e.lifecycle!==Qn.RESPAWN||e.checkLifeCycle(tl.currentTick)||t.write(new _i(qe.packZoneCoord(e.x,e.z),e.shape,e.angle))}writePartialEncloses(t){this.shared&&t.write(new oi(this.x,this.z,t.originX,t.originZ,this.shared))}writePartialFollows(t){if(0!==this.events.size){t.write(new li(this.x,this.z,t.originX,t.originZ));for(const e of this.events)e.type===ri.FOLLOWS&&(-1!==e.receiverId&&e.receiverId!==t.pid||t.write(e.message))}}reset(){this.events.clear()}addStaticLoc(t){const e=qe.packZoneCoord(t.x,t.z);this.locs[e]||(this.locs[e]=[]),this.locs[e]?.push(t),this.totalLocs++,this.sortLocs(e)}addStaticObj(t){const e=qe.packZoneCoord(t.x,t.z);this.objs[e]||(this.objs[e]=[]),this.objs[e]?.push(t),this.totalObjs++,this.sortObjs(e)}addLoc(t){const e=qe.packZoneCoord(t.x,t.z);if(t.lifecycle===Qn.DESPAWN){this.locs[e]||(this.locs[e]=[]),this.locs[e]?.push(t),this.totalLocs++}this.sortLocs(e),this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new pi(e,t.type,t.shape,t.angle)})}removeLoc(t){const e=qe.packZoneCoord(t.x,t.z);if(t.lifecycle===Qn.DESPAWN){const n=this.locs[e];if(n)for(let e=0;e<n.length;e++)if(t===n[e]){n.splice(e,1),this.totalLocs--;break}}this.sortLocs(e),this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new _i(e,t.shape,t.angle)})}getLoc(t,e,n){for(const s of this.getLocsSafe(qe.packZoneCoord(t,e)))if(s.type===n)return s;return null}mergeLoc(t,e,n,s,i,a,r,o){this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new Ai(t.x,t.z,t.shape,t.angle,t.type,n,s,e.pid,a,i,o,r)})}animLoc(t,e){this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new fi(qe.packZoneCoord(t.x,t.z),t.shape,t.angle,e)})}addObj(t,e){const n=qe.packZoneCoord(t.x,t.z);if(t.lifecycle===Qn.DESPAWN){this.objs[n]||(this.objs[n]=[]),this.objs[n]?.push(t),this.totalObjs++}this.sortObjs(n),t.lifecycle===Qn.DESPAWN?this.events.add({type:ri.FOLLOWS,receiverId:e,message:new di(n,t.type,t.count)}):t.lifecycle===Qn.RESPAWN&&this.events.add({type:ri.ENCLOSED,receiverId:e,message:new di(n,t.type,t.count)})}revealObj(t,e){const n=qe.packZoneCoord(t.x,t.z);t.receiverId=-1,t.reveal=-1,this.sortObjs(n),this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new Oi(n,t.type,t.count,e)})}changeObj(t,e,n,s){const i=qe.packZoneCoord(t.x,t.z);t.count=s,this.sortObjs(i),this.events.add({type:ri.FOLLOWS,receiverId:e,message:new Ei(i,t.type,n,s)})}removeObj(t){const e=qe.packZoneCoord(t.x,t.z);if(t.lifecycle===Qn.DESPAWN){const n=this.objs[e];if(n)for(let e=0;e<n.length;e++)if(t===n[e]){n.splice(e,1),this.totalObjs--;break}}this.sortObjs(e),t.lifecycle===Qn.DESPAWN?this.events.add({type:ri.FOLLOWS,receiverId:-1,message:new mi(e,t.type)}):t.lifecycle===Qn.RESPAWN&&this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new mi(e,t.type)})}animMap(t,e,n,s,i){this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new gi(qe.packZoneCoord(t,e),n,s,i)})}mapProjAnim(t,e,n,s,i,a,r,o,c,l,h,d){this.events.add({type:ri.ENCLOSED,receiverId:-1,message:new ui(t,e,n,s,i,a,r,o,c,l,h,d)})}getObj(t,e,n,s){for(const i of this.getObjsSafe(qe.packZoneCoord(t,e)))if((-1===i.receiverId||i.receiverId===s)&&i.type===n)return i;return null}*getAllPlayersSafe(){for(const t of this.players){const e=tl.getPlayerByUid(t);e&&e.checkLifeCycle(tl.currentTick)&&(yield e)}}*getAllNpcsSafe(){for(const t of this.npcs){const e=tl.getNpc(t);e&&e.checkLifeCycle(tl.currentTick)&&(yield e)}}*getAllObjsSafe(){for(let t=0;t<this.objs.length;t++){const e=this.objs[t];if(e)for(let t=0;t<e.length;t++){const n=e[t];n.checkLifeCycle(tl.currentTick)&&(yield n)}}}*getObjsSafe(t){const e=this.objs[t];if(e)for(let t=0;t<e.length;t++){const n=e[t];n.checkLifeCycle(tl.currentTick)&&(yield n)}}*getObjsUnsafe(t){const e=this.objs[t];if(e)for(let t=0;t<e.length;t++)yield e[t]}*getAllObjsUnsafe(t=!1){for(let e=0;e<this.objs.length;e++){const n=this.objs[e];if(n)if(t)for(let t=n.length-1;t>=0;t--)yield n[t];else for(let t=0;t<n.length;t++)yield n[t]}}*getAllLocsSafe(){for(let t=0;t<this.locs.length;t++){const e=this.locs[t];if(e)for(let t=0;t<e.length;t++){const n=e[t];n.checkLifeCycle(tl.currentTick)&&(yield n)}}}*getLocsSafe(t){const e=this.locs[t];if(e)for(let t=0;t<e.length;t++){const n=e[t];n.checkLifeCycle(tl.currentTick)&&(yield n)}}*getLocsUnsafe(t){const e=this.locs[t];if(e)for(let t=0;t<e.length;t++)yield e[t]}*getAllLocsUnsafe(t=!1){for(let e=0;e<this.locs.length;e++){const n=this.locs[e];if(n)if(t)for(let t=n.length-1;t>=0;t--)yield n[t];else for(let t=0;t<n.length;t++)yield n[t]}}sortObjs(t){const e=this.objs[t];if(!e)return;let n=-99999999,s=null;for(const t of e){const e=ut.get(t.type);let i=e.cost;e.stackable&&(i*=t.count+1),i+=t.lifecycle,i>n&&(n=i,s=t)}s&&e[0]!==s&&(e.splice(e.indexOf(s),1),e.unshift(s))}sortLocs(t){const e=this.locs[t];if(!e)return;let n=-99999999,s=null;for(const t of e){const e=t.lifecycle;e>n&&(n=e,s=t)}s&&e[0]!==s&&(e.splice(e.indexOf(s),1),e.unshift(s))}}class Rr{static GRID_SIZE=2048;static INT_BITS=5;static INT_BITS_FLAG=(1<<this.INT_BITS)-1;static DEFAULT_GRID_SIZE=this.GRID_SIZE*(this.GRID_SIZE>>this.INT_BITS);grid;constructor(t=Rr.DEFAULT_GRID_SIZE){this.grid=new Int32Array(t)}index(t,e){return t<<Rr.INT_BITS|e>>>Rr.INT_BITS}flag(t,e){this.grid[this.index(t,e)]|=1<<(e&Rr.INT_BITS_FLAG)}unflag(t,e){this.grid[this.index(t,e)]&=~(1<<(e&Rr.INT_BITS_FLAG))}isFlagged(t,e,n){const s=Math.max(0,t-n),i=Math.min(Rr.GRID_SIZE-1,t+n),a=Math.max(0,e-n),r=Math.min(Rr.GRID_SIZE-1,e+n),o=Rr.INT_BITS_FLAG,c=a&~o,l=r>>>Rr.INT_BITS<<Rr.INT_BITS;for(let t=s;t<=i;t++)for(let e=c;e<=l;e+=32){const n=this.index(t,e),s=this.grid[n];let i=s;e+o>r&&(i=s&(1<<r-e+1)-1);let c=i;if(e<a&&(c=i>>>a-e),0!==c)return!0}return!1}}class br{static zoneIndex(t,e,n){return t>>3&2047|(e>>3&2047)<<11|(3&n)<<22}static unpackIndex(t){return{x:(2047&t)<<3,z:(t>>11&2047)<<3,level:t>>22}}zones;grids;constructor(){this.zones=new Map,this.grids=new Map}zone(t,e,n){const s=br.zoneIndex(t,e,n);let i=this.zones.get(s);return void 0===i&&(i=new wr(s),this.zones.set(s,i)),i}zoneByIndex(t){let e=this.zones.get(t);return void 0===e&&(e=new wr(t),this.zones.set(t,e)),e}grid(t){let e=this.grids.get(t);return void 0===e&&(e=new Rr,this.grids.set(t,e)),e}zoneCount(){return this.zones.size}locCount(){let t=0;for(const e of this.zones.values())t+=e.totalLocs;return t}objCount(){let t=0;for(const e of this.zones.values())t+=e.totalObjs;return t}}class Ur{static INTERVAL=10;static PREFERRED_PLAYERS=250;static PREFERRED_NPCS=255;static PREFERRED_VIEW_DISTANCE=16;npcs;players;loadedZones;activeZones;extendedInfo;appearances;forceViewDistance=!1;viewDistance=Ur.PREFERRED_VIEW_DISTANCE;lastResize=0;constructor(){this.npcs=new Set,this.players=new Set,this.loadedZones=new Set,this.activeZones=new Set,this.extendedInfo=new Set,this.appearances=new Map}resize(){if(!this.forceViewDistance)return this.players.size>=Ur.PREFERRED_PLAYERS?(this.viewDistance>1&&this.viewDistance--,void(this.lastResize=0)):void(++this.lastResize>=Ur.INTERVAL&&(this.viewDistance<Ur.PREFERRED_VIEW_DISTANCE?this.viewDistance++:this.lastResize=0))}reset(){this.extendedInfo.clear()}*getNearbyPlayers(t,e,n,s,i){t:for(const a of this.proximitySort(e,n,this.activeZones))for(const r of this.getNearby(tl.getZoneIndex(a).getAllPlayersSafe(),e,n,s,i,this.viewDistance)){if(this.players.size>=Ur.PREFERRED_PLAYERS)break t;this.players.has(r.uid)||r.uid!==t&&(yield r)}}*getNearbyNpcs(t,e,n,s){t:for(const i of this.proximitySort(t,e,this.activeZones))for(const a of this.getNearby(tl.getZoneIndex(i).getAllNpcsSafe(),t,e,n,s,16)){if(this.npcs.size>=Ur.PREFERRED_NPCS)break t;this.npcs.has(a.nid)||(yield a)}}hasAppearance(t,e){const n=this.appearances.get(t);return void 0!==n&&n===e}saveAppearance(t,e){this.appearances.set(t,e)}*getNearby(t,e,n,s,i,a){const r=s-48,o=s+48,c=i+48,l=i-48;for(const s of t)s.x<=r||s.x>=o||s.z>=c||s.z<=l||qe.isWithinDistanceSW({x:e,z:n},s,a)&&(yield s)}proximitySort(t,e,n){return Array.from(n.values()).map((n=>this.zoneToDistance(n,t,e))).sort(((t,e)=>t.distance-e.distance)).map((({zoneIndex:t})=>t))}zoneToDistance(t,e,n){const s=br.unpackIndex(t);return{zoneIndex:t,distance:Math.abs(s.x-e)+Math.abs(s.z-n)}}}function Dr(t){for(let e=98;e>=0;e--)if(t>=kr[e])return Math.min(e+2,99);return 1}function Mr(t){return kr[t-2]}var kr=new Int32Array(99),xr=0;for(let t=0;t<99;t++){const e=t+1;xr+=Math.floor(e+300*Math.pow(2,e/7)),kr[t]=10*Math.floor(xr/4)}class Br extends xs{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static SKILLS=['attack','defence','strength','hitpoints','ranged','prayer','magic','cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing','mining','herblore','agility','thieving','stat18','stat19','runecraft'];static DESIGN_BODY_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];save(){}username;username37;displayName;body;colors;gender;runenergy=1e4;lastRunEnergy=-1;runweight;playtime;stats=new Int32Array(21);levels=new Uint8Array(21);vars;varsString;invs=new Map;pid=-1;uid=-1;lowMemory=!1;combatLevel=3;headicons=0;appearance=null;appearanceHashCode=0n;baseLevels=new Uint8Array(21);lastStats=new Int32Array(21);lastLevels=new Uint8Array(21);originX=-1;originZ=-1;buildArea=new Ur;lastMovement=0;basReadyAnim=-1;basTurnOnSpot=-1;basWalkForward=-1;basWalkBackward=-1;basWalkLeft=-1;basWalkRight=-1;basRunning=-1;animProtect=0;logoutRequested=!1;invListeners=[];allowDesign=!1;afkEventReady=!1;interactWalkTrigger=!1;highPriorityOut=new Bs;lowPriorityOut=new Bs;lastResponse=-1;messageColor=null;messageEffect=null;messageType=null;message=null;delay=0;queue=new g;weakQueue=new g;engineQueue=new g;cameraPackets=new g;timers=new Map;modalState=0;modalTop=-1;lastModalTop=-1;modalBottom=-1;lastModalBottom=-1;modalSidebar=-1;lastModalSidebar=-1;refreshModalClose=!1;refreshModal=!1;modalSticky=-1;overlaySide=new Array(14).fill(-1);receivedFirstClose=!1;protect=!1;activeScript=null;resumeButtons=[];lastItem=-1;lastSlot=-1;lastUseItem=-1;lastUseSlot=-1;lastTargetSlot=-1;lastCom=-1;staffModLevel=0;heroPoints=new Array(16);afkZones=new Int32Array(2);lastAfkZone=0;constructor(t,e){super(0,3094,3106,1,1,Qn.FOREVER,ct.NORMAL,at.NPC,ks.SMART,Br.FACE_COORD,Br.FACE_ENTITY),this.username=t,this.username37=e,this.displayName=p(t),this.vars=new Int32Array(ft.count),this.varsString=new Array(ft.count),this.body=[0,10,18,26,33,36,42],this.colors=[0,0,0,0,0],this.gender=0,this.runenergy=1e4,this.runweight=0,this.playtime=0,this.lastStats.fill(-1),this.lastLevels.fill(-1)}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(t,e){const n=this.heroPoints.findIndex((e=>e&&e.uid===t));if(-1!==n)return void(this.heroPoints[n].points+=e);const s=this.heroPoints.findIndex((t=>t&&-1===t.uid));-1===s||(this.heroPoints[s]={uid:t,points:e})}findHero(){return this.heroPoints.sort(((t,e)=>e.points-t.points)),this.heroPoints[0]?.uid??-1}resetEntity(t){super.resetPathingEntity(),this.repathed=!1,this.protect=!1,this.messageColor=null,this.messageEffect=null,this.messageType=null,this.message=null}onLogin(){this.playerLog('Logging in'),this.write(new Ys),this.write(new Ks(this.pid)),this.unsetMapFlag(),this.write(new js),this.resetHeroPoints(),this.write(new Zs);for(let t=0;t<this.vars.length;t++){const e=ft.get(t),n=this.vars[t];e.transmit&&this.writeVarp(t,n)}const t=Xt.getByTriggerSpecific(Os.LOGIN,-1,-1);t&&this.executeScript(Bc.init(t,this),!0);const e=Xt.getByTriggerSpecific(Os.MOVE,-1,-1);if(e){const t=Bc.init(e,this);this.runScript(t,!0)}this.lastStepX=this.x-1,this.lastStepZ=this.z}calculateRunWeight(){this.runweight=0;const t=this.invs.values();for(let e=0;e<this.invs.size;e++){const e=t.next().value;if(!e)continue;const n=J.get(e.type);if(n&&n.runweight)for(let t=0;t<e.capacity;t++){const n=e.get(t);if(!n)continue;const s=ut.get(n.id);s&&!s.stackable&&(this.runweight+=s.weight*n.count)}}}playerLog(t,...e){}processEngineQueue(){for(let t=this.engineQueue.head();null!==t;t=this.engineQueue.next()){const e=t.delay--;if(this.canAccess()&&e<=0){const e=Bc.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}updateMovement(t=!0){if(this.containsModalInterface())return this.recoverEnergy(!1),!1;if(t&&this.target instanceof xs&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),this.hasWaypoints()&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const t=Xt.get(this.walktrigger);if(this.walktrigger=-1,t){const e=Bc.init(t,this);this.runScript(e,!0)}}this.runenergy<100&&(this.setVar(ft.PLAYER_RUN,0),this.setVar(ft.TEMP_RUN,0)),this.moveSpeed!==Ms.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed(),-1===this.basRunning?this.moveSpeed=Ms.WALK:this.getVar(ft.TEMP_RUN)&&(this.moveSpeed=Ms.RUN)),super.processMovement()||this.setVar(ft.TEMP_RUN,0);const e=this.lastX!==this.x||this.lastZ!==this.z;if(e){const t=Xt.getByTriggerSpecific(Os.MOVE,-1,-1);t&&this.runScript(Bc.init(t,this),!0)}return this.drainEnergy(e),this.recoverEnergy(e),0===this.runenergy&&(this.setVar(ft.PLAYER_RUN,0),this.setVar(ft.TEMP_RUN,0)),e}drainEnergy(t){if(t&&0!==this.stepsTaken&&!this.delayed()&&this.moveSpeed===Ms.RUN&&this.stepsTaken>1){const t=Math.floor(this.runweight/1e3),e=67+67*Math.min(Math.max(t,0),64)/64|0;this.runenergy=Math.max(this.runenergy-e,0)}}recoverEnergy(t){if(!this.delayed()&&(!t||this.moveSpeed!==Ms.RUN)&&this.runenergy<1e4){const t=8+(this.baseLevels[sn.AGILITY]/9|0);this.runenergy=Math.min(this.runenergy+t,1e4)}}blockWalkFlag(){return He.PLAYER}defaultMoveSpeed(){return this.getVar(ft.PLAYER_RUN)?Ms.RUN:Ms.WALK}closeSticky(){if(-1!==this.modalSticky){const t=Xt.getByTrigger(Os.IF_CLOSE,this.modalSticky);t&&this.enqueueScript(t,1),this.modalSticky=-1,this.write(new Js(-1))}}closeModal(){if(this.receivedFirstClose){if(this.weakQueue.clear(),this.delayed()||(this.protect=!1),0!==this.modalState){if(-1!==this.modalTop){const t=Xt.getByTrigger(Os.IF_CLOSE,this.modalTop);t&&this.enqueueScript(t,1),this.modalTop=-1}if(-1!==this.modalBottom){const t=Xt.getByTrigger(Os.IF_CLOSE,this.modalBottom);t&&this.enqueueScript(t,1),this.modalBottom=-1}if(-1!==this.modalSidebar){const t=Xt.getByTrigger(Os.IF_CLOSE,this.modalSidebar);t&&this.enqueueScript(t,1),this.modalSidebar=-1}this.modalState=0,this.refreshModalClose=!0}}else this.receivedFirstClose=!0}delayed(){return this.delay>0}containsModalInterface(){return!(1&~this.modalState&&2&~this.modalState&&16&~this.modalState)}busy(){return this.delayed()||this.containsModalInterface()}canAccess(){return!this.protect&&!this.busy()}enqueueScript(t,e=0,n=0,s=[]){const i=new ws(e,t,s,n);1===e?(i.delay=0,this.engineQueue.addTail(i)):2===e?this.weakQueue.addTail(i):this.queue.addTail(i)}processQueues(){let t=!1;for(let e=this.queue.head();null!==e;e=this.queue.next())if(3===e.type){t=!0;break}t&&this.closeModal(),this.processQueue(),this.processWeakQueue()}processQueue(){for(let t=this.queue.head();null!==t;t=this.queue.next()){3===t.type&&this.closeModal();const e=t.delay--;if(this.canAccess()&&e<=0){const e=Bc.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}processWeakQueue(){for(let t=this.weakQueue.head();null!==t;t=this.weakQueue.next()){const e=t.delay--;if(this.canAccess()&&e<=0){const e=Bc.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}setTimer(t,e,n=[],s){const i=e.id,a={type:t,script:e,args:n,interval:s,clock:s};this.timers.set(i,a)}clearTimer(t){this.timers.delete(t)}processTimers(t){for(const e of this.timers.values())if(t===e.type&&--e.clock<=0&&(1===e.type||this.canAccess())){e.clock=e.interval;const t=Bc.init(e.script,this,null,e.args);this.runScript(t,0===e.type)}}stopAction(){this.clearPendingAction(),this.unsetMapFlag()}clearPendingAction(){this.clearInteraction(),this.closeModal()}hasInteraction(){return null!==this.target}getOpTrigger(){if(!this.target)return null;let t=-1,e=-1;if(this.target instanceof Hc||this.target instanceof hs||this.target instanceof es){const n=this.target instanceof Hc?pt.get(this.target.type):this.target instanceof hs?et.get(this.target.type):ut.get(this.target.type);t=n.id,e=n.category}return-1!==this.targetSubject.type&&(t=this.targetSubject.type),-1!==this.targetSubject.com&&(t=this.targetSubject.com),Xt.getByTrigger(this.targetOp+7,t,e)??null}getApTrigger(){if(!this.target)return null;let t=-1,e=-1;if(this.target instanceof Hc||this.target instanceof hs||this.target instanceof es){const n=this.target instanceof Hc?pt.get(this.target.type):this.target instanceof hs?et.get(this.target.type):ut.get(this.target.type);t=n.id,e=n.category}return-1!==this.targetSubject.type&&(t=this.targetSubject.type),-1!==this.targetSubject.com&&(t=this.targetSubject.com),Xt.getByTrigger(this.targetOp,t,e)??null}processInteraction(){if(null===this.target||!this.canAccess())return void this.updateMovement();if(this.target.level!==this.level)return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Hc&&(null===tl.getNpc(this.target.nid)||this.target.delayed()))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Hc&&-1!==this.targetSubject.type&&null===tl.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof es&&null===tl.getObj(this.target.x,this.target.z,this.level,this.target.type,this.pid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof hs&&null===tl.getLoc(this.target.x,this.target.z,this.level,this.target.type))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Br&&null===tl.getPlayerByUid(this.target.uid))return this.clearInteraction(),void this.unsetMapFlag();if(this.targetOp===Os.APPLAYER3||this.targetOp===Os.OPPLAYER3){return void(this.updateMovement(!1)&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=tl.currentTick+1))}const t=this.getOpTrigger(),e=this.getApTrigger();if(t&&this.target instanceof xs&&this.inOperableDistance(this.target)){const e=this.target;this.target=null,this.executeScript(Bc.init(t,this,e),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(e&&this.inApproachDistance(this.apRange,this.target)){const t=this.target;this.target=null,this.executeScript(Bc.init(e,this,t),!0),this.apRangeCalled?this.target=t:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if(this.target instanceof xs&&this.inOperableDistance(this.target)){if(Jn.LOCAL_DEV&&!t&&!e){let t='_';this.target instanceof Hc?t=-1!==this.targetSubject.com&&this.targetOp===Os.APNPCT||this.targetOp===Os.OPNPCT?Z.get(this.targetSubject.com)?.comName??this.targetSubject.toString():pt.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof hs?t=et.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof es?t=ut.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===Os.APNPCT||this.targetOp===Os.APPLAYERT||this.targetOp===Os.APLOCT||this.targetOp===Os.APOBJT?t=Z.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(t=ut.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${Os[this.targetOp+7].toLowerCase()},${t}]`)}this.target=null,this.messageGame('Nothing interesting happens.'),this.interacted=!0,this.clearWaypoints()}const n=this.updateMovement();if(n&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=tl.currentTick+1),this.target&&(!this.interacted||this.apRangeCalled))if(this.interacted=!1,t&&(this.target instanceof xs||!n)&&this.inOperableDistance(this.target)){const e=this.target;this.target=null,this.executeScript(Bc.init(t,this,e),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(e&&this.inApproachDistance(this.apRange,this.target)){this.apRangeCalled=!1;const t=this.target;this.target=null,this.executeScript(Bc.init(e,this,t),!0),this.apRangeCalled?this.target=t:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if((this.target instanceof xs||!n)&&this.inOperableDistance(this.target)){if(Jn.LOCAL_DEV&&!t&&!e){let t='_';this.target instanceof Hc?t=pt.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof hs?t=et.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof es?t=ut.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===Os.APNPCT||this.targetOp===Os.APPLAYERT||this.targetOp===Os.APLOCT||this.targetOp===Os.APOBJT?t=Z.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(t=ut.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${Os[this.targetOp+7].toLowerCase()},${t}]`)}this.target=null,this.messageGame('Nothing interesting happens.'),this.interacted=!0,this.clearWaypoints()}if(!this.interactWalkTrigger&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const t=Xt.get(this.walktrigger);if(this.walktrigger=-1,t){const e=Bc.init(t,this);this.interactWalkTrigger=!0,this.unsetMapFlag(),this.runScript(e,!0)}}this.interacted||this.hasWaypoints()||n||(this.messageGame("I can't reach that!"),this.clearInteraction()),this.interacted&&!this.apRangeCalled&&null===this.target&&this.clearInteraction()}getAppearanceInSlot(t){let e=-1;return 8===t?e=this.body[0]:11===t?e=this.body[1]:4===t?e=this.body[2]:6===t?e=this.body[3]:9===t?e=this.body[4]:7===t?e=this.body[5]:10===t&&(e=this.body[6]),-1===e?0:256+e}getCombatLevel(){const t=.25*(this.baseLevels[sn.DEFENCE]+this.baseLevels[sn.HITPOINTS]+Math.floor(this.baseLevels[sn.PRAYER]/2)),e=.325*(this.baseLevels[sn.ATTACK]+this.baseLevels[sn.STRENGTH]),n=.325*(Math.floor(this.baseLevels[sn.RANGED]/2)+this.baseLevels[sn.RANGED]),s=.325*(Math.floor(this.baseLevels[sn.MAGIC]/2)+this.baseLevels[sn.MAGIC]);return Math.floor(t+Math.max(e,n,s))}generateAppearance(t){const e=E.alloc(0);e.p1(this.gender),e.p1(this.headicons);const n=[];let s=this.getInventory(t);s||(s=new se(0));for(let t=0;t<s.capacity;t++){const e=s.get(t);if(!e)continue;const i=ut.get(e.id);-1!==i.wearpos2&&-1===n.indexOf(i.wearpos2)&&n.push(i.wearpos2),-1!==i.wearpos3&&-1===n.indexOf(i.wearpos3)&&n.push(i.wearpos3)}const i=[];for(let t=0;t<12;t++){if(-1!==n.indexOf(t)){e.p1(0),i[t]=0n;continue}const a=s.get(t);if(a)e.p2(512+a.id),i[t]=BigInt(512+a.id);else{const n=this.getAppearanceInSlot(t);n<1?(e.p1(0),i[t]=0n):(e.p2(n),i[t]=BigInt(n))}}for(let t=0;t<this.colors.length;t++)e.p1(this.colors[t]);e.p2(this.basReadyAnim),e.p2(this.basTurnOnSpot),e.p2(this.basWalkForward),e.p2(this.basWalkBackward),e.p2(this.basWalkLeft),e.p2(this.basWalkRight),e.p2(this.basRunning),e.p8(this.username37),e.p1(this.combatLevel),this.mask|=Br.APPEARANCE,this.appearance=new Uint8Array(e.pos),e.pos=0,e.gdata(this.appearance,0,this.appearance.length),e.release(),this.appearanceHashCode=0n;for(let t=0;t<12;t++)this.appearanceHashCode<<=0x4n,i[t]>=256&&(this.appearanceHashCode+=i[t]-256n);i[0]>=256&&(this.appearanceHashCode+=i[0]-256n>>4n),i[1]>=256&&(this.appearanceHashCode+=i[1]-256n>>8n);for(let t=0;t<5;t++)this.appearanceHashCode<<=0x3n,this.appearanceHashCode+=BigInt(this.colors[t]);this.appearanceHashCode<<=0x1n,this.appearanceHashCode+=BigInt(this.gender)}getInventoryFromListener(t){if(-1===t.source)return tl.getInventory(t.type);{const e=tl.getPlayerByUid(t.source);return e?e.getInventory(t.type):null}}getInventory(t){if(-1===t)return null;const e=J.get(t);let n=null;return e?(e.scope===J.SCOPE_SHARED?n=tl.getInventory(t):(n=this.invs.get(t),n||(n=se.fromType(t),this.invs.set(t,n))),n):null}invListenOnCom(t,e,n){if(-1===t)return;if(-1!==this.invListeners.findIndex((n=>n.type===t&&n.com===e)))return;J.get(t).scope===J.SCOPE_SHARED&&(n=-1),this.invListeners.push({type:t,com:e,source:n,firstSeen:!0})}invStopListenOnCom(t){const e=this.invListeners.findIndex((e=>e.com===t));-1!==e&&(this.invListeners.splice(e,1),this.write(new $s(t)))}invGetSlot(t,e){const n=this.getInventory(t);if(!n)throw new Error('invGetSlot: Invalid inventory type: '+t);if(!n.validSlot(e))throw new Error('invGetSlot: Invalid slot: '+e);return n.get(e)}invClear(t){const e=this.getInventory(t);if(!e)throw new Error('invClear: Invalid inventory type: '+t);e.removeAll()}invAdd(t,e,n,s=!0){const i=this.getInventory(t);if(!i)throw new Error('invAdd: Invalid inventory type: '+t);return i.add(e,n,-1,s).completed}invSet(t,e,n,s){const i=this.getInventory(t);if(!i)throw new Error('invSet: Invalid inventory type: '+t);if(!i.validSlot(s))throw new Error('invSet: Invalid slot: '+s);i.set(s,{id:e,count:n})}invDel(t,e,n,s=-1){const i=this.getInventory(t);if(!i)throw new Error('invDel: Invalid inventory type: '+t);if(s<-1||s>=this.invSize(t))throw new Error('invDel: Invalid beginSlot: '+s);return i.remove(e,n,s).completed}invDelSlot(t,e){const n=this.getInventory(t);if(!n)throw new Error('invDelSlot: Invalid inventory type: '+t);if(!n.validSlot(e))throw new Error('invDelSlot: Invalid slot: '+e);n.delete(e)}invSize(t){const e=this.getInventory(t);if(!e)throw new Error('invSize: Invalid inventory type: '+t);return e.capacity}invTotal(t,e){const n=this.getInventory(t);if(!n)throw new Error('invTotal: Invalid inventory type: '+t);return n.getItemCount(e)}invFreeSpace(t){const e=this.getInventory(t);if(!e)throw new Error('invFreeSpace: Invalid inventory type: '+t);return e.freeSlotCount}invItemSpace(t,e,n,s){const i=this.getInventory(t);if(!i)throw new Error('invItemSpace: Invalid inventory type: '+t);const a=ut.get(e);let r=e;if(a.certtemplate>=0&&a.certlink>=0&&(r=a.certlink),a.stackable||r!=e||i.stackType==se.ALWAYS_STACK){const s=!0===J.get(t).stockobj?.includes(e);return 0!=this.invTotal(t,e)||0!=this.invFreeSpace(t)||s?Math.max(0,n-(se.STACK_LIMIT-this.invTotal(t,e))):n}return Math.max(0,n-(this.invFreeSpace(t)-(this.invSize(t)-s)))}invMoveToSlot(t,e,n,s){const i=this.getInventory(t);if(!i)throw new Error('invMoveToSlot: Invalid inventory type: '+t);if(!i.validSlot(n))throw new Error('invMoveToSlot: Invalid from slot: '+n);const a=this.getInventory(e);if(!a)throw new Error('invMoveToSlot: Invalid inventory type: '+e);if(!a.validSlot(s))throw new Error('invMoveToSlot: Invalid to slot: '+s);const r=this.invGetSlot(t,n);if(!r)throw new Error(`invMoveToSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${n}`);const o=this.invGetSlot(e,s);this.invSet(e,r.id,r.count,s),o?this.invSet(t,o.id,o.count,n):this.invDelSlot(t,n)}invMoveFromSlot(t,e,n){const s=this.getInventory(t);if(!s)throw new Error('invMoveFromSlot: Invalid inventory type: '+t);if(!this.getInventory(e))throw new Error('invMoveFromSlot: Invalid inventory type: '+e);if(!s.validSlot(n))throw new Error('invMoveFromSlot: Invalid from slot: '+n);const i=this.invGetSlot(t,n);if(!i)throw new Error(`invMoveFromSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${n}`);return{overflow:i.count-this.invAdd(e,i.id,i.count),fromObj:i.id}}invTotalCat(t,e){const n=this.getInventory(t);if(!n)throw new Error('invTotalCat: Invalid inventory type: '+t);return n.itemsFiltered.filter((t=>ut.get(t.id).category==e)).reduce(((t,e)=>t+e.count),0)}_invTotalParam(t,e,n){const s=this.getInventory(t);if(!s)throw new Error('invTotalParam: Invalid inventory type: '+t);const i=_t.get(e);let a=0;for(let t=0;t<s.capacity;t++){const e=s.items[t];if(!e||e.id<0||e.id>=ut.count)continue;const r=ut.get(e.id),o=q(i.id,r,i.defaultInt);a+=n?e.count*o:o}return a}invTotalParam(t,e){return this._invTotalParam(t,e,!1)}invTotalParamStack(t,e){return this._invTotalParam(t,e,!0)}getVar(t){const e=ft.get(t);return e.type===A.STRING?this.varsString[e.id]:this.vars[e.id]}setVar(t,e){const n=ft.get(t);n.type===A.STRING&&'string'==typeof e?this.varsString[n.id]=e:'number'==typeof e&&(this.vars[n.id]=e,n.transmit&&this.writeVarp(t,e))}writeVarp(t,e){e>=-128&&e<=127?this.write(new Xs(t,e)):this.write(new Qs(t,e))}addXp(t,e){if(e<0)throw new Error(`Invalid xp parameter for addXp call: Stat was: ${t}, Exp was: ${e}`);if(0==e)return;const n=Number(Jn.XP_MULTIPLIER)||1;this.stats[t]+=e*n,this.stats[t]>2e9&&(this.stats[t]=2e9);const s=this.baseLevels[t];if(this.levels[t]===this.baseLevels[t]&&(this.levels[t]=Dr(this.stats[t])),this.baseLevels[t]=Dr(this.stats[t]),this.baseLevels[t]>s){this.levels[t]<s&&(this.levels[t]+=1);const e=Xt.getByTriggerSpecific(Os.LEVELUP,t,-1);e&&this.enqueueScript(e,1)}this.combatLevel!=this.getCombatLevel()&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance(J.WORN))}setLevel(t,e){e=Math.min(99,Math.max(1,e)),this.baseLevels[t]=e,this.levels[t]=e,this.stats[t]=Mr(e),this.getCombatLevel()!=this.combatLevel&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance(J.WORN))}playAnimation(t,e){t>=mt.count||this.animProtect||(-1==t||-1==this.animId||mt.get(t).priority>mt.get(this.animId).priority||0===mt.get(this.animId).priority)&&(this.animId=t,this.animDelay=e,this.mask|=Br.ANIM)}spotanim(t,e,n){this.graphicId=t,this.graphicHeight=e,this.graphicDelay=n,this.mask|=Br.SPOTANIM}applyDamage(t,e){this.damageTaken=t,this.damageType=e;const n=this.levels[sn.HITPOINTS];n-t<=0?(this.levels[sn.HITPOINTS]=0,this.damageTaken=n):this.levels[sn.HITPOINTS]=n-t,this.mask|=Br.DAMAGE}say(t){this.chat=t,this.mask|=Br.SAY}faceSquare(t,e){this.faceX=2*t+1,this.faceZ=2*e+1,this.orientation=qe.face(this.x,this.z,t,e),this.mask|=Br.FACE_COORD}playSong(t){if(!(t=t.toLowerCase().replaceAll(' ','_')))return;const e=Gs.get(t+'.mid'),n=Ws.get(t+'.mid');if(e&&n){const s=e.length;this.write(new qs(t,n,s))}}playJingle(t,e){if(!(e=e.toLowerCase().replaceAll('_',' ')))return;const n=Gs.get(e+'.mid');n&&this.write(new ti(t,n))}openMainModal(t){4&this.modalState&&(this.write(new Ys),this.modalState&=-5,this.modalSidebar=-1),this.modalState|=1,this.modalTop=t,this.refreshModal=!0}openChat(t){this.modalState|=2,this.modalBottom=t,this.refreshModal=!0}openSideOverlay(t){this.modalState|=4,this.modalSidebar=t,this.refreshModal=!0}openChatSticky(t){this.write(new Js(t)),this.modalState|=8,this.modalSticky=t}openMainModalSideOverlay(t,e){this.modalState|=1,this.modalTop=t,this.modalState|=4,this.modalSidebar=e,this.refreshModal=!0}exactMove(t,e,n,s,i,a,r){this.exactStartX=t,this.exactStartZ=e,this.exactEndX=n,this.exactEndZ=s,this.exactMoveStart=i,this.exactMoveEnd=a,this.exactMoveDirection=r,this.mask|=Br.EXACT_MOVE,this.x=n,this.z=s,this.lastStepX=this.x-1,this.lastStepZ=this.z}setTab(t,e){this.overlaySide[e]=t,this.write(new ei(t,e))}isComponentVisible(t){return this.modalTop===t.rootLayer||this.modalBottom===t.rootLayer||this.modalSidebar===t.rootLayer||-1!==this.overlaySide.findIndex((e=>e===t.rootLayer))||this.modalSticky===t.rootLayer}updateAfkZones(){if(this.lastAfkZone=Math.min(1e3,this.lastAfkZone+1),this.withinAfkZone())return;const t=qe.packCoord(0,this.x-10,this.z-10);this.moveSpeed===Ms.INSTANT&&this.jump?this.afkZones[1]=t:this.afkZones[1]=this.afkZones[0],this.afkZones[0]=t,this.lastAfkZone=0}zonesAfk(){return 1e3===this.lastAfkZone}withinAfkZone(){for(let t=0;t<this.afkZones.length;t++){const e=qe.unpackCoord(this.afkZones[t]);if(qe.intersects(this.x,this.z,this.width,this.length,e.x,e.z,21,21))return!0}return!1}isInWilderness(){return this.x>=2944&&this.x<3392&&this.z>=3520&&this.z<6400||this.x>=2944&&this.x<3392&&this.z>=9920&&this.z<12800}runScript(t,e=!1,n=!1){if(!n&&e&&(this.protect||this.delayed()))return-1;e&&(t.pointerAdd(Mt.ProtectedActivePlayer),this.protect=!0);const s=Bc.execute(t);return e&&(this.protect=!1),t.pointerGet(Mt.ProtectedActivePlayer)&&t._activePlayer&&(t.pointerRemove(Mt.ProtectedActivePlayer),t._activePlayer.protect=!1),t.pointerGet(Mt.ProtectedActivePlayer2)&&t._activePlayer2&&(t.pointerRemove(Mt.ProtectedActivePlayer2),t._activePlayer2.protect=!1),s}executeScript(t,e=!1,n=!1){const s=this.runScript(t,e,n);-1!==s&&(s!==ee.FINISHED&&s!==ee.ABORTED?s===ee.WORLD_SUSPENDED?tl.enqueueScript(t,t.popInt()):s===ee.NPC_SUSPENDED?t.activeNpc.activeScript=t:(t.activePlayer.activeScript=t,t.activePlayer.protect=e):t===this.activeScript&&(this.activeScript=null,1&this.modalState||this.closeModal()))}wrappedMessageGame(t){const e=b.get(1).split(t,456);for(const t of e)this.messageGame(t)}write(t){t.priority===Vs.HIGH?this.highPriorityOut.push(t):this.lowPriorityOut.push(t)}unsetMapFlag(){this.clearWaypoints(),this.write(new ni)}hintNpc(t){this.write(new si(1,t,0,0,0,0))}hintTile(t,e,n,s){this.write(new si(t,0,0,e,n,s))}hintPlayer(t){this.write(new si(10,0,t,0,0,0))}stopHint(){this.write(new si(-1,0,0,0,0,0))}lastLoginInfo(t,e,n,s){this.write(new ii(t,e,n,s)),this.modalState|=16}logout(){}terminate(){}messageGame(t){this.write(new ai(t))}}class Hr{index;id;length;static all=[];static byId=[];static REBUILD_GETMAPS=new Hr(4,150,-1);static NO_TIMEOUT=new Hr(6,108,0);static IDLE_TIMER=new Hr(30,70,0);static EVENT_TRACKING=new Hr(34,81,-2);static EVENT_CAMERA_POSITION=new Hr(35,189,6);static ANTICHEAT_OPLOGIC1=new Hr(60,7,4);static ANTICHEAT_OPLOGIC2=new Hr(61,88,4);static ANTICHEAT_OPLOGIC3=new Hr(62,30,3);static ANTICHEAT_OPLOGIC4=new Hr(63,176,2);static ANTICHEAT_OPLOGIC5=new Hr(64,220,0);static ANTICHEAT_OPLOGIC6=new Hr(65,66,4);static ANTICHEAT_OPLOGIC7=new Hr(66,17,4);static ANTICHEAT_OPLOGIC8=new Hr(67,2,2);static ANTICHEAT_OPLOGIC9=new Hr(68,238,1);static ANTICHEAT_CYCLELOGIC1=new Hr(70,233,1);static ANTICHEAT_CYCLELOGIC2=new Hr(71,146,-1);static ANTICHEAT_CYCLELOGIC3=new Hr(74,215,3);static ANTICHEAT_CYCLELOGIC4=new Hr(72,236,4);static ANTICHEAT_CYCLELOGIC5=new Hr(75,85,0);static ANTICHEAT_CYCLELOGIC6=new Hr(73,219,-1);static OPOBJ1=new Hr(80,140,6);static OPOBJ2=new Hr(81,40,6);static OPOBJ3=new Hr(82,200,6);static OPOBJ4=new Hr(83,178,6);static OPOBJ5=new Hr(84,247,6);static OPOBJT=new Hr(88,138,8);static OPOBJU=new Hr(89,239,12);static OPNPC1=new Hr(100,194,2);static OPNPC2=new Hr(101,8,2);static OPNPC3=new Hr(102,27,2);static OPNPC4=new Hr(103,113,2);static OPNPC5=new Hr(104,100,2);static OPNPCT=new Hr(108,134,4);static OPNPCU=new Hr(109,202,8);static OPLOC1=new Hr(120,245,6);static OPLOC2=new Hr(121,172,6);static OPLOC3=new Hr(122,96,6);static OPLOC4=new Hr(123,97,6);static OPLOC5=new Hr(124,116,6);static OPLOCT=new Hr(128,9,8);static OPLOCU=new Hr(129,75,12);static OPPLAYER1=new Hr(140,164,2);static OPPLAYER2=new Hr(141,53,2);static OPPLAYER3=new Hr(142,185,2);static OPPLAYER4=new Hr(143,206,2);static OPPLAYERT=new Hr(148,177,4);static OPPLAYERU=new Hr(149,248,8);static OPHELD1=new Hr(160,195,6);static OPHELD2=new Hr(161,71,6);static OPHELD3=new Hr(162,133,6);static OPHELD4=new Hr(163,157,6);static OPHELD5=new Hr(164,211,6);static OPHELDT=new Hr(168,48,8);static OPHELDU=new Hr(169,130,12);static INV_BUTTON1=new Hr(190,31,6);static INV_BUTTON2=new Hr(191,59,6);static INV_BUTTON3=new Hr(192,212,6);static INV_BUTTON4=new Hr(193,38,6);static INV_BUTTON5=new Hr(194,6,6);static IF_BUTTON=new Hr(200,155,2);static RESUME_PAUSEBUTTON=new Hr(201,235,2);static CLOSE_MODAL=new Hr(202,231,0);static RESUME_P_COUNTDIALOG=new Hr(203,237,4);static TUTORIAL_CLICKSIDE=new Hr(204,175,1);static MOVE_OPCLICK=new Hr(242,93,-1);static BUG_REPORT=new Hr(243,190,10);static MOVE_MINIMAPCLICK=new Hr(244,165,-1);static INV_BUTTOND=new Hr(245,159,6);static IGNORELIST_DEL=new Hr(246,171,8);static IGNORELIST_ADD=new Hr(247,79,8);static IF_PLAYERDESIGN=new Hr(248,52,13);static CHAT_SETMODE=new Hr(249,244,3);static MESSAGE_PRIVATE=new Hr(250,148,-1);static FRIENDLIST_DEL=new Hr(251,11,8);static FRIENDLIST_ADD=new Hr(252,118,8);static CLIENT_CHEAT=new Hr(253,4,-1);static MESSAGE_PUBLIC=new Hr(254,158,-1);static MOVE_GAMECLICK=new Hr(255,181,-1);constructor(t,e,n){this.index=t,this.id=e,this.length=n,Hr.all[t]=this,Hr.byId[e]=this}}class Fr{}class Gr{}class Wr{id;limit;static CLIENT_EVENT=new Wr(0,20);static USER_EVENT=new Wr(1,5);constructor(t,e){this.id=t,this.limit=e}}class zr extends Gr{input;category=Wr.USER_EVENT;constructor(t){super(),this.input=t}}class Vr extends Fr{prot=Hr.CLIENT_CHEAT;decode(t){const e=t.gjstr();return new zr(e)}}class Yr extends Gr{category=Wr.USER_EVENT}class Kr extends Fr{prot=Hr.CLOSE_MODAL;decode(){return new Yr}}class jr extends Gr{category=Wr.CLIENT_EVENT}class Zr extends Fr{prot=Hr.IDLE_TIMER;decode(){return new jr}}class Jr extends Gr{component;category=Wr.USER_EVENT;constructor(t){super(),this.component=t}}class $r extends Fr{prot=Hr.IF_BUTTON;decode(t){const e=t.g2();return new Jr(e)}}class Xr extends Gr{gender;idkit;color;category=Wr.USER_EVENT;constructor(t,e,n){super(),this.gender=t,this.idkit=e,this.color=n}}class Qr extends Fr{prot=Hr.IF_PLAYERDESIGN;decode(t){const e=t.g1(),n=[];for(let e=0;e<7;e++)n[e]=t.g1(),255===n[e]&&(n[e]=-1);const s=[];for(let e=0;e<5;e++)s[e]=t.g1();return new Xr(e,n,s)}}class qr extends Gr{op;obj;slot;component;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.op=t,this.obj=e,this.slot=n,this.component=s}}class to extends Fr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),n=t.g2(),s=t.g2();return new qr(this.op,e,n,s)}}class eo extends Gr{component;slot;targetSlot;category=Wr.USER_EVENT;constructor(t,e,n){super(),this.component=t,this.slot=e,this.targetSlot=n}}class no extends Fr{prot=Hr.INV_BUTTOND;decode(t){const e=t.g2(),n=t.g2(),s=t.g2();return new eo(e,n,s)}}class so extends Gr{username;input;category=Wr.USER_EVENT;constructor(t,e){super(),this.username=t,this.input=e}}class io extends Fr{prot=Hr.MESSAGE_PRIVATE;decode(t){const e=t.g8(),n=Ha.unpack(t,t.length-8);return new so(e,n)}}class ao extends Gr{input;color;effect;category=Wr.USER_EVENT;constructor(t,e,n){super(),this.input=t,this.color=e,this.effect=n}}class ro extends Fr{prot=Hr.MESSAGE_PUBLIC;decode(t){const e=t.g1(),n=t.g1(),s=Ha.unpack(t,t.length-2);return new ao(s,e,n)}}class oo extends Gr{op;obj;slot;component;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.op=t,this.obj=e,this.slot=n,this.component=s}}class co extends Fr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),n=t.g2(),s=t.g2();return new oo(this.op,e,n,s)}}class lo extends Gr{obj;slot;component;spellComponent;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.obj=t,this.slot=e,this.component=n,this.spellComponent=s}}class ho extends Fr{prot=Hr.OPHELDT;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2();return new lo(e,n,s,i)}}class po extends Gr{obj;slot;component;useObj;useSlot;useComponent;category=Wr.USER_EVENT;constructor(t,e,n,s,i,a){super(),this.obj=t,this.slot=e,this.component=n,this.useObj=s,this.useSlot=i,this.useComponent=a}}class _o extends Fr{prot=Hr.OPHELDU;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new po(e,n,s,i,a,r)}}class uo extends Gr{op;x;z2;loc;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.op=t,this.x=e,this.z=n,this.loc=s}}class go extends Fr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),n=t.g2(),s=t.g2();return new uo(this.op,e,n,s)}}class mo extends Gr{x;z2;loc;spellComponent;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.x=t,this.z=e,this.loc=n,this.spellComponent=s}}class Eo extends Fr{prot=Hr.OPLOCT;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2();return new mo(e,n,s,i)}}class Oo extends Gr{x;z2;loc;useObj;useSlot;useComponent;category=Wr.USER_EVENT;constructor(t,e,n,s,i,a){super(),this.x=t,this.z=e,this.loc=n,this.useObj=s,this.useSlot=i,this.useComponent=a}}class fo extends Fr{prot=Hr.OPLOCU;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new Oo(e,n,s,i,a,r)}}class Ao extends Gr{op;nid;category=Wr.USER_EVENT;constructor(t,e){super(),this.op=t,this.nid=e}}class To extends Fr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2();return new Ao(this.op,e)}}class Io extends Gr{nid;spellComponent;category=Wr.USER_EVENT;constructor(t,e){super(),this.nid=t,this.spellComponent=e}}class No extends Fr{prot=Hr.OPNPCT;decode(t){const e=t.g2(),n=t.g2();return new Io(e,n)}}class Po extends Gr{nid;useObj;useSlot;useComponent;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.nid=t,this.useObj=e,this.useSlot=n,this.useComponent=s}}class Lo extends Fr{prot=Hr.OPNPCU;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2();return new Po(e,n,s,i)}}class So extends Gr{op;x;z2;obj;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.op=t,this.x=e,this.z=n,this.obj=s}}class Co extends Fr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),n=t.g2(),s=t.g2();return new So(this.op,e,n,s)}}class yo extends Gr{x;z2;obj;spellComponent;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.x=t,this.z=e,this.obj=n,this.spellComponent=s}}class vo extends Fr{prot=Hr.OPOBJT;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2();return new yo(e,n,s,i)}}class wo extends Gr{x;z2;obj;useObj;useSlot;useComponent;category=Wr.USER_EVENT;constructor(t,e,n,s,i,a){super(),this.x=t,this.z=e,this.obj=n,this.useObj=s,this.useSlot=i,this.useComponent=a}}class Ro extends Fr{prot=Hr.OPOBJU;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new wo(e,n,s,i,a,r)}}class bo extends Gr{op;pid;category=Wr.USER_EVENT;constructor(t,e){super(),this.op=t,this.pid=e}}class Uo extends Fr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2();return new bo(this.op,e)}}class Do extends Gr{pid;spellComponent;category=Wr.USER_EVENT;constructor(t,e){super(),this.pid=t,this.spellComponent=e}}class Mo extends Fr{prot=Hr.OPPLAYERT;decode(t){const e=t.g2(),n=t.g2();return new Do(e,n)}}class ko extends Gr{pid;useObj;useSlot;useComponent;category=Wr.USER_EVENT;constructor(t,e,n,s){super(),this.pid=t,this.useObj=e,this.useSlot=n,this.useComponent=s}}class xo extends Fr{prot=Hr.OPPLAYERU;decode(t){const e=t.g2(),n=t.g2(),s=t.g2(),i=t.g2();return new ko(e,n,s,i)}}class Bo extends Gr{maps;category=Wr.USER_EVENT;constructor(t){super(),this.maps=t}}class Ho extends Fr{prot=Hr.REBUILD_GETMAPS;decode(t){const e=[],n=t.length/3;for(let s=0;s<n;s++){const n=t.g1(),s=t.g1(),i=t.g1();e.push({type:n,x:s,z:i})}return new Bo(e)}}class Fo extends Gr{category=Wr.USER_EVENT}class Go extends Fr{prot=Hr.RESUME_PAUSEBUTTON;decode(){return new Fo}}class Wo extends Gr{input;category=Wr.USER_EVENT;constructor(t){super(),this.input=t}}class zo extends Fr{prot=Hr.RESUME_P_COUNTDIALOG;decode(t){const e=t.g4();return new Wo(e)}}class Vo extends Gr{tab;category=Wr.USER_EVENT;constructor(t){super(),this.tab=t}}class Yo extends Fr{prot=Hr.TUTORIAL_CLICKSIDE;decode(t){const e=t.g1();return new Vo(e)}}class Ko{}class jo extends Ko{handle(t,e){const{op:n,obj:s,slot:i,component:a}=t,r=Z.get(a);if(void 0===r||!r.inventoryOptions||!r.inventoryOptions.length||!e.isComponentVisible(r))return!1;if(!r.inventoryOptions[n-1])return!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,s))return!1;if(e.delayed())return!1;let l;e.lastItem=s,e.lastSlot=i,l=1===n?Os.INV_BUTTON1:2===n?Os.INV_BUTTON2:3===n?Os.INV_BUTTON3:4===n?Os.INV_BUTTON4:Os.INV_BUTTON5;const h=Xt.getByTrigger(l,a,-1);if(h){const t=Z.get(r.rootLayer);e.executeScript(Bc.init(h,e),0==t.overlay)}else Jn.LOCAL_DEV&&e.messageGame(`No trigger for [${Os.toString(l)},${r.comName}]`);return!0}}class Zo{state=-1;remoteAddress;totalBytesRead=0;totalBytesWritten=0;uniqueId=crypto.randomUUID();encryptor=null;decryptor=null;in=new Uint8Array(5e3);inOffset=0;inCount=new Uint8Array(256);out=new E(new Uint8Array(5e3));player=null;constructor(t="0",e=-1){this.remoteAddress=t,this.state=e}send(t){this.totalBytesWritten+=t.length,self.postMessage(t)}close(){setTimeout((()=>{self.close()}),100)}terminate(){self.close()}reset(){this.inOffset=0,this.inCount.fill(0)}writeImmediate(t){this.send(t)}flush(){const t=this.out;0!==t.pos&&(this.send(t.data.subarray(0,t.pos)),t.pos=0)}}class Jo extends Zo{constructor(){super(null,'')}isTCP(){return this.type===Zo.TCP}isWebSocket(){return this.type===Zo.WEBSOCKET}send(t){this.socket}close(){this.socket}terminate(){this.socket}reset(){this.inOffset=0,this.inCount.fill(0)}}function $o(t,e){if('number'==typeof t)return t;if('string'!=typeof t&&'number'!=typeof t)return e;const n=parseInt(t);return isNaN(n)?e:n}class Xo extends Ko{handle(t,e){if(t.input.length>80)return!1;const{input:n}=t,s=n.toLowerCase().split(' '),i=s.shift();if(void 0===i||i.length<=0)return!1;if(e.playerLog('Cheat ran',n),'advancestat'===i){if(s.length<1)return!1;const t=Br.SKILLS.indexOf(s[0]),n=Math.min(99,Math.max(1,$o(s[1],1)));if(-1===t)return!1;e.setLevel(t,e.baseLevels[t]+n)}else if('getcoord'===i)e.messageGame(qe.formatString(e.level,e.x,e.z,'_'));else if('getvar'===i){if(s.length<1)return!1;const t=ft.getId(s[0]);if(-1===t)return!1;const n=e.getVar(t);e.messageGame('get '+s[0]+': '+n)}else if('give'===i){if(s.length<1)return!1;const t=ut.getId(s[0]),n=Math.max(1,Math.min($o(s[1],1),2147483647));if(-1===t)return!1;e.invAdd(J.INV,t,n,!1)}else if('givecrap'===i);else if('givemany'===i);else if('setstat'===i){if(s.length<2)return!1;const t=Br.SKILLS.indexOf(s[0]);if(-1===t)return!1;e.setLevel(t,parseInt(s[1]))}else if('setvar'===i){if(s.length<2)return!1;const t=ft.getId(s[0]),n=Math.max(-2147483648,Math.min($o(s[1],0),2147483647));if(-1===t)return!1;e.setVar(t,n),e.messageGame('set '+s[0]+': to '+n)}else if('tele'===i){if(s.length<1)return!1;if('up'===s[0])e.teleJump(e.x,e.z,e.level+1),e.messageGame('::tele '+qe.formatString(e.level,e.x,e.z,','));else if('down'===s[0])e.teleJump(e.x,e.z,e.level-1),e.messageGame('::tele '+qe.formatString(e.level,e.x,e.z,','));else if(-1===s[0].indexOf(','))e.teleJump($o(s[0],3200),$o(s[1],3200),$o(s[2],e.level));else{const t=s[0].split(',');if(5!==t.length)return!1;const n=$o(t[0],0),i=$o(t[1],50),a=$o(t[2],50),r=$o(t[3],0),o=$o(t[4],0);if(n<0||n>3||i<0||i>255||a<0||a>255||r<0||r>63||o<0||o>63)return!1;e.teleJump((i<<6)+r,(a<<6)+o,n)}}else if('reload'===i&&Jn.LOCAL_DEV){tl.reload();const t=Xt.load('data/pack');e.messageGame(`Reloaded ${t} scripts.`)}else if('rebuild'===i&&Jn.LOCAL_DEV)tl.devThread.postMessage({type:'pack'});else if('setxp'===i){if(s.length<2)return e.messageGame('Usage: ::setxp <stat> <xp>'),!1;const t=Br.SKILLS.indexOf(s[0]);if(-1===t)return e.messageGame(`Unknown stat ${s[0]}`),!1;const n=10*parseInt(s[1]);e.stats[t]=n}else if('minlevel'===i)for(let t=0;t<Br.SKILLS.length;t++)t===sn.HITPOINTS?e.setLevel(t,10):e.setLevel(t,1);else if('serverdrop'===i)e.terminate();else if('random'===i)e.afkEventReady=!0;else if('bench'===i&&e.staffModLevel>=3){const t=Date.now();for(let t=0;t<1e5;t++)ce(e.level,e.x,e.z,e.x,e.z+10);const n=Date.now();console.log(`took = ${n-t} ms`)}else if('bots'===i&&e.staffModLevel>=3){e.messageGame('Adding bots');for(let t=0;t<2e3;t++){const e=new vc(`bot${t}`,h(`bot${t}`),new Jo);e.onLogin(),tl.addPlayer(e)}}else if('teleall'===i&&e.staffModLevel>=3){e.messageGame('Teleporting all players');for(const t of tl.players){t.closeModal();do{const e=Math.floor(64*Math.random())+3200,n=Math.floor(64*Math.random())+3200;t.teleport(e+Math.floor(64*Math.random())-32,n+Math.floor(64*Math.random())-32,0)}while(fe(t.x,t.z,t.level,He.WALK_BLOCKED))}}else if('moveall'===i&&e.staffModLevel>=3){e.messageGame('Moving all players'),console.time('moveall');for(const t of tl.players)t.closeModal(),t.queueWaypoints(ce(t.level,t.x,t.z,32+(t.x>>>6<<6),32+(t.z>>>6<<6)));console.timeEnd('moveall')}else if('speed'===i&&e.staffModLevel>=3){if(s.length<1)return e.messageGame('Usage: ::speed <ms>'),!1;const t=$o(s.shift(),20);if(t<20)return e.messageGame('::speed input was too low.'),!1;e.messageGame(`World speed was changed to ${t}ms`),tl.tickRate=t}else'fly'===i&&e.staffModLevel>=3?(e.moveStrategy===ks.FLY?e.moveStrategy=ks.SMART:e.moveStrategy=ks.FLY,e.messageGame(`Fly is on? ${e.moveStrategy===ks.FLY}`)):'naive'===i&&e.staffModLevel>=3&&(e.moveStrategy===ks.NAIVE?e.moveStrategy=ks.SMART:e.moveStrategy=ks.NAIVE,e.messageGame(`Naive is on? ${e.moveStrategy===ks.NAIVE}`));const a=Xt.getByName(`[debugproc,${i}]`);if(!a)return!1;const r=new Array(a.info.parameterTypes.length).fill(-1);for(let t=0;t<a.info.parameterTypes.length;t++){const e=a.info.parameterTypes[t];try{switch(e){case A.STRING:{const e=s.shift();r[t]=e??'';break}case A.INT:{const e=s.shift();r[t]=0|parseInt(e??'0',10);break}case A.OBJ:case A.NAMEDOBJ:{const e=s.shift();r[t]=ut.getId(e??'');break}case A.NPC:{const e=s.shift();r[t]=pt.getId(e??'');break}case A.LOC:{const e=s.shift();r[t]=et.getId(e??'');break}case A.SEQ:{const e=s.shift();r[t]=mt.getId(e??'');break}case A.STAT:{const e=s.shift();r[t]=Br.SKILLS.indexOf(e??'');break}case A.INV:{const e=s.shift();r[t]=J.getId(e??'');break}case A.COORD:{const e=n.split('_'),s=parseInt(e[0].slice(6)),i=parseInt(e[1]),a=parseInt(e[2]),o=parseInt(e[3]),c=parseInt(e[4]);r[t]=qe.packCoord(s,(i<<6)+o,(a<<6)+c);break}case A.INTERFACE:{const e=s.shift();r[t]=Z.getId(e??'');break}case A.SPOTANIM:{const e=s.shift();r[t]=St.getId(e??'');break}case A.IDKIT:{const e=s.shift();r[t]=j.getId(e??'');break}}}catch(t){return!1}}return e.executeScript(Bc.init(a,e,null,r),!1),!0}}class Qo extends Ko{handle(t,e){return e.closeModal(),!0}}class qo extends Ko{handle(t,e){return Jn.LOCAL_DEV||(e.logout(),e.logoutRequested=!0),!0}}class tc extends Ko{handle(t,e){const{component:n}=t,s=Z.get(n);if(void 0===s||!e.isComponentVisible(s))return!1;if(e.lastCom=n,-1!==e.resumeButtons.indexOf(e.lastCom))e.activeScript&&e.executeScript(e.activeScript,!0);else{const t=Z.get(s.rootLayer),i=Xt.getByTriggerSpecific(Os.IF_BUTTON,n,-1);i?e.executeScript(Bc.init(i,e),0==t.overlay):Jn.LOCAL_DEV&&e.messageGame(`No trigger for [if_button,${s.comName}]`)}return!0}}class ec extends Ko{handle(t,e){const{gender:n,idkit:s,color:i}=t;if(!e.allowDesign)return!1;if(n>1)return!1;let a=!0;for(let t=0;t<7;t++){let e=t;if(1===n&&(e+=7),8==e&&-1===s[t])continue;const i=j.get(s[t]);if(!i||i.disable||i.type!=e){a=!1;break}}if(!a)return!1;for(let t=0;t<5;t++)if(i[t]>=Br.DESIGN_BODY_COLORS[t].length){a=!1;break}return!!a&&(e.gender=n,e.body=s,e.colors=i,e.generateAppearance(J.WORN),!0)}}class nc extends Ko{handle(t,e){const{component:n,slot:s,targetSlot:i}=t,a=Z.get(n);if(void 0===a||!e.isComponentVisible(a))return!1;const r=e.invListeners.find((t=>t.com===n));if(!r)return!1;const o=e.getInventoryFromListener(r);if(!(o&&o.validSlot(s)&&o.get(s)&&o.validSlot(i)))return!1;if(e.delayed())return e.write(new pr(n,o,s,i)),!1;e.lastSlot=s,e.lastTargetSlot=i;const c=Xt.getByTrigger(Os.INV_BUTTOND,n);if(c){const t=Z.get(a.rootLayer);e.executeScript(Bc.init(c,e),0==t.overlay)}else Jn.LOCAL_DEV&&e.messageGame(`No trigger for [inv_buttond,${a.comName}]`);return!0}}class sc extends Ko{handle(t,e){return!0}}class ic extends Ko{handle(t,e){const{color:n,effect:s,input:i}=t;if(n<0||n>11||s<0||s>2||i.length>100)return!1;e.messageColor=n,e.messageEffect=s,e.messageType=0;const a=E.alloc(0);return Ha.pack(a,Lt.filter(i)),e.message=new Uint8Array(a.pos),a.pos=0,a.gdata(e.message,0,e.message.length),a.release(),e.mask|=Br.CHAT,!0}}class ac extends Ko{handle(t,e){const{obj:n,slot:s,component:i}=t,a=Z.get(i);if(void 0===a||!e.isComponentVisible(a))return!1;const r=ut.get(n);if(5!==t.op&&(r.iop&&!r.iop[t.op-1]||!r.iop))return!1;const o=e.invListeners.find((t=>t.com===i));if(!o)return!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(s)||!c.hasAt(s,n))return!1;if(e.delayed())return!1;let l;e.lastItem=n,e.lastSlot=s,e.clearInteraction(),e.closeModal(),l=1===t.op?Os.OPHELD1:2===t.op?Os.OPHELD2:3===t.op?Os.OPHELD3:4===t.op?Os.OPHELD4:Os.OPHELD5;const h=Xt.getByTrigger(l,r.id,r.category);return h?e.executeScript(Bc.init(h,e),!0):Jn.LOCAL_DEV&&e.messageGame(`No trigger for [${Os.toString(l)},${r.debugname}]`),!0}}class rc extends Ko{handle(t,e){const{obj:n,slot:s,component:i,spellComponent:a}=t,r=Z.get(i);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=Z.get(i);if(void 0===o||!e.isComponentVisible(o))return e.unsetMapFlag(),!1;const c=e.invListeners.find((t=>t.com===i));if(!c)return e.unsetMapFlag(),!1;const l=e.getInventoryFromListener(c);if(!l||!l.validSlot(s)||!l.hasAt(s,n))return e.unsetMapFlag(),!1;if(e.delayed())return e.unsetMapFlag(),!1;e.lastItem=n,e.lastSlot=s,e.clearInteraction(),e.closeModal();const h=Xt.getByTrigger(Os.OPHELDT,a,-1);return h?e.executeScript(Bc.init(h,e),!0):(Jn.LOCAL_DEV&&e.messageGame(`No trigger for [opheldt,${o.comName}]`),e.messageGame('Nothing interesting happens.')),!0}}class oc extends Ko{handle(t,e){const{obj:n,slot:s,component:i,useObj:a,useSlot:r,useComponent:o}=t,c=Z.get(i);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=Z.get(i);if(void 0===l||!e.isComponentVisible(l))return e.unsetMapFlag(),!1;{const t=e.invListeners.find((t=>t.com===i));if(!t)return e.unsetMapFlag(),!1;const a=e.getInventoryFromListener(t);if(!a||!a.validSlot(s)||!a.hasAt(s,n))return e.unsetMapFlag(),!1}{const t=e.invListeners.find((t=>t.com===o));if(!t)return e.unsetMapFlag(),!1;const n=e.getInventoryFromListener(t);if(!n||!n.validSlot(r)||!n.hasAt(r,a))return e.unsetMapFlag(),!1}if(e.delayed())return e.unsetMapFlag(),!1;e.lastItem=n,e.lastSlot=s,e.lastUseItem=a,e.lastUseSlot=r;const h=ut.get(e.lastItem),d=ut.get(e.lastUseItem);if((h.members||d.members)&&!tl.members)return e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1;let p=Xt.getByTriggerSpecific(Os.OPHELDU,h.id,-1);p||(p=Xt.getByTriggerSpecific(Os.OPHELDU,d.id,-1),[e.lastItem,e.lastUseItem]=[e.lastUseItem,e.lastItem],[e.lastSlot,e.lastUseSlot]=[e.lastUseSlot,e.lastSlot]);const _=-1!==h.category?f.get(h.category):null;!p&&_&&(p=Xt.getByTriggerSpecific(Os.OPHELDU,-1,_.id));const u=-1!==d.category?f.get(d.category):null;return!p&&u&&(p=Xt.getByTriggerSpecific(Os.OPHELDU,-1,u.id),[e.lastItem,e.lastUseItem]=[e.lastUseItem,e.lastItem],[e.lastSlot,e.lastUseSlot]=[e.lastUseSlot,e.lastSlot]),e.clearInteraction(),e.closeModal(),p?e.executeScript(Bc.init(p,e),!0):(Jn.LOCAL_DEV&&e.messageGame(`No trigger for [opheldu,${h.debugname}]`),e.messageGame('Nothing interesting happens.')),!0}}class cc extends Ko{handle(t,e){const{x:n,z:s,loc:i}=t;if(e.delayed())return e.unsetMapFlag(),!1;const a=e.originX-52,r=e.originX+52,o=e.originZ+52,c=e.originZ-52;if(n<a||n>r||s<c||s>o)return!1;const l=tl.getLoc(n,s,e.level,i);if(!l)return e.unsetMapFlag(),!1;const h=et.get(l.type);if(!h.op||!h.op[t.op-1])return e.unsetMapFlag(),!1;let d;return d=1===t.op?Os.APLOC1:2===t.op?Os.APLOC2:3===t.op?Os.APLOC3:4===t.op?Os.APLOC4:Os.APLOC5,e.clearPendingAction(),e.setInteraction(As.ENGINE,l,d),e.opcalled=!0,!0}}class lc extends Ko{handle(t,e){const{x:n,z:s,loc:i,spellComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.originX-52,c=e.originX+52,l=e.originZ+52,h=e.originZ-52;if(n<o||n>c||s<h||s>l)return e.unsetMapFlag(),!1;const d=tl.getLoc(n,s,e.level,i);return d?(e.clearPendingAction(),e.setInteraction(As.ENGINE,d,Os.APLOCT,{type:d.type,com:a}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class hc extends Ko{handle(t,e){const{x:n,z:s,loc:i,useObj:a,useSlot:r,useComponent:o}=t;if(e.delayed())return e.unsetMapFlag(),!1;const c=Z.get(o);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=e.originX-52,h=e.originX+52,d=e.originZ+52,p=e.originZ-52;if(n<l||n>h||s<p||s>d)return e.unsetMapFlag(),!1;const _=e.invListeners.find((t=>t.com===o));if(!_)return e.unsetMapFlag(),!1;const u=e.getInventoryFromListener(_);if(!u||!u.validSlot(r)||!u.hasAt(r,a))return e.unsetMapFlag(),!1;const g=tl.getLoc(n,s,e.level,i);return g?ut.get(a).members&&!tl.members?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=a,e.lastUseSlot=r,e.clearPendingAction(),e.setInteraction(As.ENGINE,g,Os.APLOCU),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class dc extends Ko{handle(t,e){const{nid:n}=t;if(e.delayed())return e.unsetMapFlag(),!1;const s=tl.getNpc(n);if(!s||s.delayed())return e.unsetMapFlag(),!1;if(!e.buildArea.npcs.has(s.nid))return e.unsetMapFlag(),!1;const i=pt.get(s.type);if(!i.op||!i.op[t.op-1])return e.unsetMapFlag(),!1;let a;return a=1===t.op?Os.APNPC1:2===t.op?Os.APNPC2:3===t.op?Os.APNPC3:4===t.op?Os.APNPC4:Os.APNPC5,e.clearPendingAction(),e.setInteraction(As.ENGINE,s,a,{type:s.type,com:-1}),e.opcalled=!0,!0}}class pc extends Ko{handle(t,e){const{nid:n,spellComponent:s}=t;if(e.delayed())return e.unsetMapFlag(),!1;const i=Z.get(s);if(void 0===i||!e.isComponentVisible(i))return e.unsetMapFlag(),!1;const a=tl.getNpc(n);return!a||a.delayed()?(e.unsetMapFlag(),!1):e.buildArea.npcs.has(a.nid)?(e.clearPendingAction(),e.setInteraction(As.ENGINE,a,Os.APNPCT,{type:a.type,com:s}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class _c extends Ko{handle(t,e){const{nid:n,useObj:s,useSlot:i,useComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return e.unsetMapFlag(),!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,s))return e.unsetMapFlag(),!1;const l=tl.getNpc(n);return!l||l.delayed()?(e.unsetMapFlag(),!1):e.buildArea.npcs.has(l.nid)?ut.get(s).members&&!tl.members?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=s,e.lastUseSlot=i,e.clearPendingAction(),e.setInteraction(As.ENGINE,l,Os.APNPCU,{type:l.type,com:-1}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class uc extends Ko{handle(t,e){const{x:n,z:s,obj:i}=t;if(e.delayed())return e.unsetMapFlag(),!1;const a=e.originX-52,r=e.originX+52,o=e.originZ+52,c=e.originZ-52;if(n<a||n>r||s<c||s>o)return e.unsetMapFlag(),!1;const l=tl.getObj(n,s,e.level,i,e.pid);if(!l)return e.unsetMapFlag(),!1;const h=ut.get(l.type);if(1===t.op&&(h.op&&!h.op[0]||!h.op)||4===t.op&&(h.op&&!h.op[3]||!h.op))return e.unsetMapFlag(),!1;let d;return d=1===t.op?Os.APOBJ1:2===t.op?Os.APOBJ2:3===t.op?Os.APOBJ3:4===t.op?Os.APOBJ4:Os.APOBJ5,e.clearPendingAction(),e.setInteraction(As.ENGINE,l,d),e.opcalled=!0,!0}}class gc extends Ko{handle(t,e){const{x:n,z:s,obj:i,spellComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.originX-52,c=e.originX+52,l=e.originZ+52,h=e.originZ-52;if(n<o||n>c||s<h||s>l)return e.unsetMapFlag(),!1;const d=tl.getObj(n,s,e.level,i,e.pid);return d?(e.clearPendingAction(),e.setInteraction(As.ENGINE,d,Os.APOBJT,{type:d.type,com:a}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class mc extends Ko{handle(t,e){const{x:n,z:s,obj:i,useObj:a,useSlot:r,useComponent:o}=t;if(e.delayed())return e.unsetMapFlag(),!1;const c=Z.get(o);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=e.originX-52,h=e.originX+52,d=e.originZ+52,p=e.originZ-52;if(n<l||n>h||s<p||s>d)return e.unsetMapFlag(),!1;const _=e.invListeners.find((t=>t.com===o));if(!_)return e.unsetMapFlag(),!1;const u=e.getInventoryFromListener(_);if(!u||!u.validSlot(r)||!u.hasAt(r,a))return e.unsetMapFlag(),!1;const g=tl.getObj(n,s,e.level,i,e.pid);return g?ut.get(a).members&&!tl.members?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=a,e.lastUseSlot=r,e.clearPendingAction(),e.setInteraction(As.ENGINE,g,Os.APOBJU),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Ec extends Ko{handle(t,e){const{pid:n}=t;if(e.delayed())return e.unsetMapFlag(),!1;const s=tl.getPlayer(n);if(!s)return e.unsetMapFlag(),!1;if(!e.buildArea.players.has(s.uid))return e.unsetMapFlag(),!1;let i;return i=1===t.op?Os.APPLAYER1:2===t.op?Os.APPLAYER2:3===t.op?Os.APPLAYER3:Os.APPLAYER4,e.clearPendingAction(),e.setInteraction(As.ENGINE,s,i),e.opcalled=!0,!0}}class Oc extends Ko{handle(t,e){const{pid:n,spellComponent:s}=t;if(e.delayed())return e.unsetMapFlag(),!1;const i=Z.get(s);if(void 0===i||!e.isComponentVisible(i))return e.unsetMapFlag(),!1;const a=tl.getPlayer(n);return a&&e.buildArea.players.has(a.uid)?(e.clearPendingAction(),e.setInteraction(As.ENGINE,a,Os.APPLAYERT,{type:-1,com:s}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class fc extends Ko{handle(t,e){const{pid:n,useObj:s,useSlot:i,useComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return e.unsetMapFlag(),!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,s))return e.unsetMapFlag(),!1;const l=tl.getPlayer(n);return l&&e.buildArea.players.has(l.uid)?ut.get(s).members&&!tl.members?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseSlot=i,e.clearPendingAction(),e.setInteraction(As.ENGINE,l,Os.APPLAYERU,{type:s,com:-1}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Ac extends Ko{handle(t,e){const{maps:n}=t;for(let t=0;t<n.length;t++){const{type:s,x:i,z:a}=n[t],r=991;if(0==s){const t=Gs.get(`m${i}_${a}`);if(!t)continue;for(let n=0;n<t.length;n+=r)e.write(new yi(i,a,n,t.length,t.subarray(n,n+r)));e.write(new wi(i,a))}else if(1==s){const t=Gs.get(`l${i}_${a}`);if(!t)continue;for(let n=0;n<t.length;n+=r)e.write(new bi(i,a,n,t.length,t.subarray(n,n+r)));e.write(new Di(i,a))}}return!0}}class Tc extends Ko{handle(t,e){return!(!e.activeScript||e.activeScript.execution!==ee.PAUSEBUTTON)&&(e.executeScript(e.activeScript,!0),!0)}}class Ic extends Ko{handle(t,e){const{input:n}=t;return!(!e.activeScript||e.activeScript.execution!==ee.COUNTDIALOG)&&(e.activeScript.lastInt=n,e.executeScript(e.activeScript,!0),!0)}}class Nc extends Ko{handle(t,e){const{tab:n}=t;if(n<0||n>13)return!1;const s=Xt.getByTriggerSpecific(Os.TUTORIAL_CLICKSIDE,-1,-1);return s&&e.executeScript(Bc.init(s,e),!0),!0}}class Pc extends Gr{path;ctrlHeld;opClick;category=Wr.USER_EVENT;constructor(t,e,n){super(),this.path=t,this.ctrlHeld=e,this.opClick=n}}class Lc extends Fr{prot;constructor(t){super(),this.prot=t}decode(t){const e=t.g1(),n=t.g2(),s=t.g2(),i=this.prot===Hr.MOVE_MINIMAPCLICK?14:0,a=t.available-i>>1,r=[{x:n,z:s}];for(let e=1;e<=a&&e<25;e++)r.push({x:n+t.g1b(),z:s+t.g1b()});return new Pc(r,e,this.prot===Hr.MOVE_OPCLICK)}}class Sc extends Ko{handle(t,e){const n=t.path[0];if(e.delayed()||t.ctrlHeld<0||t.ctrlHeld>1||qe.distanceToSW(e,{x:n.x,z:n.z})>104)return e.unsetMapFlag(),e.userPath=[],!1;if(Jn.CLIENT_PATHFINDER){e.userPath=[];for(let n=0;n<t.path.length;n++)e.userPath[n]=qe.packCoord(e.level,t.path[n].x,t.path[n].z)}else{const n=t.path[t.path.length-1];e.userPath=[qe.packCoord(e.level,n.x,n.z)]}return e.interactWalkTrigger=!1,t.opClick||(e.clearInteraction(),e.closeModal()),e.runenergy<100?e.setVar(ft.TEMP_RUN,0):e.setVar(ft.TEMP_RUN,t.ctrlHeld),!0}}var Cc=new class{decoders=new Map;handlers=new Map;bind(t,e){if(this.decoders.has(t.prot.id))throw new Error(`[ClientProtRepository] Already defines a ${t.prot.id}.`);this.decoders.set(t.prot.id,t),e&&this.handlers.set(t.prot.id,e)}constructor(){this.bind(new Vr,new Xo),this.bind(new Kr,new Qo),this.bind(new Zr,new qo),this.bind(new $r,new tc),this.bind(new Qr,new ec),this.bind(new to(Hr.INV_BUTTON1,1),new jo),this.bind(new to(Hr.INV_BUTTON2,2),new jo),this.bind(new to(Hr.INV_BUTTON3,3),new jo),this.bind(new to(Hr.INV_BUTTON4,4),new jo),this.bind(new to(Hr.INV_BUTTON5,5),new jo),this.bind(new no,new nc),this.bind(new io,new sc),this.bind(new ro,new ic),this.bind(new Lc(Hr.MOVE_GAMECLICK),new Sc),this.bind(new Lc(Hr.MOVE_OPCLICK),new Sc),this.bind(new Lc(Hr.MOVE_MINIMAPCLICK),new Sc),this.bind(new co(Hr.OPHELD1,1),new ac),this.bind(new co(Hr.OPHELD2,2),new ac),this.bind(new co(Hr.OPHELD3,3),new ac),this.bind(new co(Hr.OPHELD4,4),new ac),this.bind(new co(Hr.OPHELD5,5),new ac),this.bind(new ho,new rc),this.bind(new _o,new oc),this.bind(new go(Hr.OPLOC1,1),new cc),this.bind(new go(Hr.OPLOC2,2),new cc),this.bind(new go(Hr.OPLOC3,3),new cc),this.bind(new go(Hr.OPLOC4,4),new cc),this.bind(new go(Hr.OPLOC5,5),new cc),this.bind(new Eo,new lc),this.bind(new fo,new hc),this.bind(new To(Hr.OPNPC1,1),new dc),this.bind(new To(Hr.OPNPC2,2),new dc),this.bind(new To(Hr.OPNPC3,3),new dc),this.bind(new To(Hr.OPNPC4,4),new dc),this.bind(new To(Hr.OPNPC5,5),new dc),this.bind(new No,new pc),this.bind(new Lo,new _c),this.bind(new Co(Hr.OPOBJ1,1),new uc),this.bind(new Co(Hr.OPOBJ2,2),new uc),this.bind(new Co(Hr.OPOBJ3,3),new uc),this.bind(new Co(Hr.OPOBJ4,4),new uc),this.bind(new Co(Hr.OPOBJ5,5),new uc),this.bind(new vo,new gc),this.bind(new Ro,new mc),this.bind(new Uo(Hr.OPPLAYER1,1),new Ec),this.bind(new Uo(Hr.OPPLAYER2,2),new Ec),this.bind(new Uo(Hr.OPPLAYER3,3),new Ec),this.bind(new Uo(Hr.OPPLAYER4,4),new Ec),this.bind(new Mo,new Oc),this.bind(new xo,new fc),this.bind(new Ho,new Ac),this.bind(new Go,new Tc),this.bind(new zo,new Ic),this.bind(new Yo,new Nc)}getDecoder(t){return this.decoders.get(t.id)}getHandler(t){return this.handlers.get(t.id)}};function yc(t){return null!==t.client&&void 0!==t.client}class vc extends Br{client=null;userPath=[];opcalled=!1;constructor(t,e,n){super(t,e),this.client=n,this.client.player=this}decodeIn(){if(null===this.client||this.client.inOffset<1)return;let t=0;for(this.lastResponse=tl.currentTick,this.userPath=[],this.opcalled=!1,tl.lastCycleBandwidth[0]+=this.client.inOffset;this.client.inOffset>t;){const e=Hr.byId[this.client.in[t++]];let n=e.length;-1==n?n=this.client.in[t++]:-2==n&&(n=this.client.in[t++]<<8|this.client.in[t++]);const s=new E(this.client.in.slice(t,t+n));t+=n;const i=Cc.getDecoder(e);if(i){const t=i.decode(s),n=Cc.getHandler(e);n&&n.handle(t,this)}}this.client?.reset()}encodeOut(){if(this.client){(this.modalTop!==this.lastModalTop||this.modalBottom!==this.lastModalBottom||this.modalSidebar!==this.lastModalSidebar||this.refreshModalClose)&&(this.refreshModalClose&&this.write(new Ys),this.refreshModalClose=!1,this.lastModalTop=this.modalTop,this.lastModalBottom=this.modalBottom,this.lastModalSidebar=this.modalSidebar),this.refreshModal&&(1&~this.modalState||4&~this.modalState?1&~this.modalState?2&~this.modalState?4&~this.modalState||this.write(new na(this.modalSidebar)):this.write(new Ni(this.modalBottom)):this.write(new Qi(this.modalTop)):this.write(new ta(this.modalTop,this.modalSidebar)),this.refreshModal=!1);for(let t=this.highPriorityOut.head();t;t=this.highPriorityOut.next())this.writeInner(t),t.uncache();for(let t=this.lowPriorityOut.head();t;t=this.lowPriorityOut.next())this.writeInner(t),t.uncache();this.client.flush()}}writeInner(t){const e=this.client;if(!e)return;const n=vr.getEncoder(t);if(!n)return;const s=n.prot,i=e.out,a=(1+s.length===-1?1:-2===s.length?2:0)+n.test(t);i.pos+a>=i.length&&e.flush();const r=i.pos;i.p1(s.id),-1===s.length?i.pos+=1:-2===s.length&&(i.pos+=2);const o=i.pos;n.encode(i,t),-1===s.length?i.psize1(i.pos-o):-2===s.length&&i.psize2(i.pos-o),e.encryptor&&(i.data[r]=i.data[r]+e.encryptor.nextInt()&255),tl.lastCycleBandwidth[1]+=i.pos-r}logout(){this.writeInner(new Da),this.client?.flush()}terminate(){this.client?.terminate(),this.client=null}playerLog(t,...e){}updateMap(){const t=this.buildArea.loadedZones,e=this.buildArea.activeZones,n=qe.zone(this.originX)-4<<3,s=qe.zone(this.originX)+5<<3,i=qe.zone(this.originZ)+5<<3,a=qe.zone(this.originZ)-4<<3;(this.x<n||this.z<a||this.x>s-1||this.z>i-1||this.tele&&(qe.zone(this.x)!==qe.zone(this.originX)||qe.zone(this.z)!==qe.zone(this.originZ)))&&(this.write(new Si(qe.zone(this.x),qe.zone(this.z))),this.originX=this.x,this.originZ=this.z,t.clear());for(let t=this.cameraPackets.head();null!==t;t=this.cameraPackets.next()){const e=t.camX-qe.zoneOrigin(this.originX),n=t.camZ-qe.zoneOrigin(this.originZ);t.type===bs.CAM_MOVETO?this.write(new Bi(e,n,t.height,t.rotationSpeed,t.rotationMultiplier)):t.type===bs.CAM_LOOKAT&&this.write(new ki(e,n,t.height,t.rotationSpeed,t.rotationMultiplier)),t.unlink()}this.moveSpeed===Ms.INSTANT&&this.jump&&t.clear(),e.clear();const r=qe.zone(this.x),o=qe.zone(this.z),c=qe.zone(this.originX)-6,l=qe.zone(this.originX)+6,h=qe.zone(this.originZ)+6,d=qe.zone(this.originZ)-6;for(let t=r-3;t<=r+3;t++)for(let n=o-3;n<=o+3;n++)t<c||t>l||n>h||n<d||e.add(br.zoneIndex(t<<3,n<<3,this.level))}updatePlayers(){this.write(new Pi(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ,this.uid,this.mask,this.tele,this.jump,this.walkDir,this.runDir))}updateNpcs(){this.write(new Cr(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ))}updateZones(){const t=this.buildArea.loadedZones,e=this.buildArea.activeZones;for(const n of t)e.has(n)||t.delete(n);for(const n of e){const e=tl.getZoneIndex(n);t.has(e.index)?(e.writePartialEncloses(this),e.writePartialFollows(this)):e.writeFullFollows(this),t.add(e.index)}}updateStats(){for(let t=0;t<this.stats.length;t++)this.stats[t]===this.lastStats[t]&&this.levels[t]===this.lastLevels[t]||(this.write(new fr(t,this.stats[t],this.levels[t])),this.lastStats[t]=this.stats[t],this.lastLevels[t]=this.levels[t]);Math.floor(this.runenergy)/100!=Math.floor(this.lastRunEnergy)/100&&(this.write(new gr(this.runenergy)),this.lastRunEnergy=this.runenergy)}updateInvs(){let t=!1,e=!1;for(let n=0;n<this.invListeners.length;n++){const s=this.invListeners[n];if(s)if(-1===s.source){const t=tl.getInventory(s.type);if(!t)continue;(t.update||s.firstSeen)&&(this.write(new hr(s.com,t)),s.firstSeen=!1)}else{const n=tl.getPlayerByUid(s.source);if(!n)continue;const i=n.getInventory(s.type);if(!i)continue;if(i.update||s.firstSeen){this.write(new hr(s.com,i)),s.firstSeen&&(e=!0),s.firstSeen=!1;J.get(s.type).runweight&&(t=!0)}}}if(t){const e=this.runweight;this.calculateRunWeight(),t=e!==this.runweight}(t||e)&&this.write(new Er(Math.ceil(this.runweight/1e3)))}}class wc extends u{type;camX;camZ;height;rotationSpeed;rotationMultiplier;constructor(t,e,n,s,i,a){super(),this.type=t,this.camX=e,this.camZ=n,this.height=s,this.rotationSpeed=i,this.rotationMultiplier=a}}class Rc{static hsl24to16(t,e,n){return n>243?e>>=4:n>217?e>>=3:n>192?e>>=2:n>179&&(e>>=1),((255&t)>>2<<10)+(e>>5<<7)+(n>>1)}static rgb15to24(t){return((t>>10&31)<<3<<16)+((t>>5&31)<<3<<8)+((31&t)<<3)}static rgb15toHsl16(t){const e=(t>>10&31)/31,n=(t>>5&31)/31,s=(31&t)/31;return Rc.rgbToHsl(e,n,s)}static rgb24to15(t){return((t>>16&255)>>3<<10)+((t>>8&255)>>3<<5)+((255&t)>>3)}static rgb24toHsl16(t){const e=(t>>16&255)/256,n=(t>>8&255)/256,s=(255&t)/256;return Rc.rgbToHsl(e,n,s)}static rgbToHsl(t,e,n){let s=t;e<s&&(s=e),n<s&&(s=n);let i=t;e>i&&(i=e),n>i&&(i=n);let a=0,r=0;const o=(s+i)/2;s!==i&&(o<.5?r=(i-s)/(i+s):o>=.5&&(r=(i-s)/(2-i-s)),t===i?a=(e-n)/(i-s):e===i?a=(n-t)/(i-s)+2:n===i&&(a=(t-e)/(i-s)+4)),a/=6;const c=256*a|0;let l=256*r|0,h=256*o|0;return l<0?l=0:l>255&&(l=255),h<0?h=0:h>255&&(h=255),Rc.hsl24to16(c,l,h)}static RGB15_HSL16=new Int32Array(32768);static{for(let t=0;t<32768;t++)Rc.RGB15_HSL16[t]=Rc.rgb15toHsl16(t)}static reverseHsl(t){const e=[];for(let n=0;n<32768;n++)Rc.RGB15_HSL16[n]===t&&e.push(n);return e}}var bc=function(t){const e=t.popString(),n=[];for(let s=e.length-1;s>=0;s--){const i=e.charAt(s);n[s]='s'===i?t.popString():t.popInt()}return n},Uc={[Jt.FINDUID]:t=>{const e=t.popInt(),n=tl.getPlayerByUid(e);n?(t.activePlayer=n,t.pointerAdd(Ut[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.P_FINDUID]:t=>{const e=t.popInt()>>>0,n=tl.getPlayerByUid(e);t.pointerGet(Dt[t.intOperand])&&t.activePlayer.uid===e?t.pushInt(1):n&&n.canAccess()?(t.activePlayer=n,t.pointerAdd(Ut[t.intOperand]),t.pointerAdd(Dt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[Jt.STRONGQUEUE]:Ct(Ut,(t=>{const e=bc(t),n=an(t.popInt(),hn),s=t.popInt(),i=Xt.get(s);if(!i)throw new Error(`Unable to find queue script: ${s}`);t.activePlayer.enqueueScript(i,3,n,e)})),[Jt.WEAKQUEUE]:Ct(Ut,(t=>{const e=bc(t),n=an(t.popInt(),hn),s=t.popInt(),i=Xt.get(s);if(!i)throw new Error(`Unable to find queue script: ${s}`);t.activePlayer.enqueueScript(i,2,n,e)})),[Jt.QUEUE]:Ct(Ut,(t=>{const e=bc(t),n=an(t.popInt(),hn),s=t.popInt(),i=Xt.get(s);if(!i)throw new Error(`Unable to find queue script: ${s}`);t.activePlayer.enqueueScript(i,0,n,e)})),[Jt.ANIM]:Ct(Ut,(t=>{const e=t.popInt(),n=t.popInt();t.activePlayer.playAnimation(n,e)})),[Jt.BUFFER_FULL]:Ct(Ut,(t=>{throw new Error('unimplemented')})),[Jt.BUILDAPPEARANCE]:Ct(Ut,(t=>{t.activePlayer.generateAppearance(an(t.popInt(),vn).id)})),[Jt.CAM_LOOKAT]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,mn);t.activePlayer.cameraPackets.addTail(new wc(bs.CAM_LOOKAT,a.x,a.z,n,s,i))})),[Jt.CAM_MOVETO]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4),a=an(e,mn);t.activePlayer.cameraPackets.addTail(new wc(bs.CAM_MOVETO,a.x,a.z,n,s,i))})),[Jt.CAM_SHAKE]:Ct(Ut,(t=>{const[e,n,s,i]=t.popInts(4);t.activePlayer.write(new Wi(e,n,s,i))})),[Jt.CAM_RESET]:Ct(Ut,(t=>{t.activePlayer.write(new Fi)})),[Jt.COORD]:Ct(Ut,(t=>{const e=t.activePlayer;t.pushInt(qe.packCoord(e.level,e.x,e.z))})),[Jt.DISPLAYNAME]:Ct(Ut,(t=>{t.pushString(t.activePlayer.displayName)})),[Jt.FACESQUARE]:Ct(Ut,(t=>{const e=an(t.popInt(),mn);t.activePlayer.faceSquare(e.x,e.z)})),[Jt.IF_CLOSE]:Ct(Ut,(t=>{t.activePlayer.closeModal()})),[Jt.LAST_COM]:t=>{t.pushInt(t.activePlayer.lastCom)},[Jt.LAST_INT]:t=>{t.pushInt(t.lastInt)},[Jt.LAST_ITEM]:t=>{if(![Os.OPHELD1,Os.OPHELD2,Os.OPHELD3,Os.OPHELD4,Os.OPHELD5,Os.OPHELDU,Os.OPHELDT,Os.INV_BUTTON1,Os.INV_BUTTON2,Os.INV_BUTTON3,Os.INV_BUTTON4,Os.INV_BUTTON5].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastItem)},[Jt.LAST_SLOT]:t=>{if(![Os.OPHELD1,Os.OPHELD2,Os.OPHELD3,Os.OPHELD4,Os.OPHELD5,Os.OPHELDU,Os.OPHELDT,Os.INV_BUTTON1,Os.INV_BUTTON2,Os.INV_BUTTON3,Os.INV_BUTTON4,Os.INV_BUTTON5,Os.INV_BUTTOND].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastSlot)},[Jt.LAST_USEITEM]:t=>{if(![Os.OPHELDU,Os.APOBJU,Os.APLOCU,Os.APNPCU,Os.APPLAYERU,Os.OPOBJU,Os.OPLOCU,Os.OPNPCU,Os.OPPLAYERU].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastUseItem)},[Jt.LAST_USESLOT]:t=>{if(![Os.OPHELDU,Os.APOBJU,Os.APLOCU,Os.APNPCU,Os.APPLAYERU,Os.OPOBJU,Os.OPLOCU,Os.OPNPCU,Os.OPPLAYERU].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastUseSlot)},[Jt.MES]:Ct(Ut,(t=>{const e=t.popString();Jn.CLIRUNNER&&console.log(e),t.activePlayer.messageGame(e)})),[Jt.NAME]:Ct(Ut,(t=>{t.pushString(t.activePlayer.username)})),[Jt.P_APRANGE]:Ct(Dt,(t=>{t.activePlayer.apRange=an(t.popInt(),hn),t.activePlayer.apRangeCalled=!0})),[Jt.P_ARRIVEDELAY]:Ct(Dt,(t=>{t.activePlayer.lastMovement<tl.currentTick||(t.activePlayer.delay=1,t.execution=ee.SUSPENDED)})),[Jt.P_COUNTDIALOG]:Ct(Dt,(t=>{t.activePlayer.write(new Za),t.execution=ee.COUNTDIALOG})),[Jt.P_DELAY]:Ct(Dt,(t=>{t.activePlayer.delay=an(t.popInt(),hn)+1,t.execution=ee.SUSPENDED})),[Jt.P_OPHELD]:Ct(Dt,(t=>{throw new Error('unimplemented')})),[Jt.P_OPLOC]:Ct(Dt,(t=>{const e=an(t.popInt(),hn)-1;if(e<0||e>=5)throw new Error(`Invalid oploc: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(As.SCRIPT,t.activeLoc,Os.APLOC1+e)})),[Jt.P_OPNPC]:Ct(Dt,(t=>{const e=an(t.popInt(),hn)-1;if(e<0||e>=5)throw new Error(`Invalid opnpc: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(As.SCRIPT,t.activeNpc,Os.APNPC1+e,{type:t.activeNpc.type,com:-1})})),[Jt.P_OPNPCT]:Ct(Dt,(t=>{const e=an(t.popInt(),hn);t.activePlayer.stopAction(),t.activePlayer.setInteraction(As.SCRIPT,t.activeNpc,Os.APNPCT,{type:t.activeNpc.type,com:e})})),[Jt.P_PAUSEBUTTON]:Ct(Dt,(t=>{t.execution=ee.PAUSEBUTTON})),[Jt.P_STOPACTION]:Ct(Dt,(t=>{t.activePlayer.stopAction()})),[Jt.P_CLEARPENDINGACTION]:Ct(Dt,(t=>{t.activePlayer.clearPendingAction()})),[Jt.P_TELEJUMP]:Ct(Dt,(t=>{const e=an(t.popInt(),mn);t.activePlayer.teleJump(e.x,e.z,e.level)})),[Jt.P_TELEPORT]:Ct(Dt,(t=>{const e=an(t.popInt(),mn);t.activePlayer.teleport(e.x,e.z,e.level)})),[Jt.P_WALK]:Ct(Dt,(t=>{const e=an(t.popInt(),mn),n=t.activePlayer;n.queueWaypoints(ce(n.level,n.x,n.z,e.x,e.z,n.width,n.width,n.length,n.orientation)),n.updateMovement(!1)})),[Jt.SAY]:Ct(Ut,(t=>{t.activePlayer.say(t.popString())})),[Jt.SOUND_SYNTH]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);t.activePlayer.write(new tr(e,n,s))})),[Jt.STAFFMODLEVEL]:Ct(Ut,(t=>{t.pushInt(t.activePlayer.staffModLevel)})),[Jt.STAT]:Ct(Ut,(t=>{const e=an(t.popInt(),An);t.pushInt(t.activePlayer.levels[e])})),[Jt.STAT_BASE]:Ct(Ut,(t=>{const e=an(t.popInt(),An);t.pushInt(t.activePlayer.baseLevels[e])})),[Jt.STAT_ADD]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,An),an(n,hn),an(s,hn);const i=t.activePlayer,a=i.levels[e],r=a+(n+a*s/100);i.levels[e]=Math.min(r,255),3===e&&i.levels[3]>=i.baseLevels[3]&&i.resetHeroPoints()})),[Jt.STAT_SUB]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,An),an(n,hn),an(s,hn);const i=t.activePlayer,a=i.levels[e],r=a-(n+a*s/100);i.levels[e]=Math.max(r,0)})),[Jt.SPOTANIM_PL]:Ct(Ut,(t=>{const e=an(t.popInt(),hn),n=t.popInt(),s=an(t.popInt(),Ln);t.activePlayer.spotanim(s.id,n,e)})),[Jt.STAT_HEAL]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,An),an(n,hn),an(s,hn);const i=t.activePlayer,a=i.baseLevels[e],r=i.levels[e],o=r+(n+r*s/100);i.levels[e]=Math.max(Math.min(o,a),r),3===e&&i.levels[3]>=i.baseLevels[3]&&i.resetHeroPoints()})),[Jt.UID]:Ct(Ut,(t=>{t.pushInt(t.activePlayer.uid)})),[Jt.P_LOGOUT]:Ct(Dt,(t=>{t.activePlayer.logoutRequested=!0})),[Jt.IF_SETCOLOUR]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(e,hn),an(n,hn),t.activePlayer.write(new oa(e,Rc.rgb24to15(n)))})),[Jt.IF_OPENCHAT]:Ct(Ut,(t=>{t.activePlayer.openChat(an(t.popInt(),hn))})),[Jt.IF_OPENMAINMODALSIDEOVERLAY]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(e,hn),an(n,hn),t.activePlayer.openMainModalSideOverlay(e,n)})),[Jt.IF_SETHIDE]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(e,hn),an(n,hn),t.activePlayer.write(new la(e,1===n))})),[Jt.IF_SETOBJECT]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,hn),an(n,Cn),an(s,hn),t.activePlayer.write(new ga(e,n,s))})),[Jt.IF_SETTABACTIVE]:Ct(Ut,(t=>{t.activePlayer.write(new La(an(t.popInt(),hn)))})),[Jt.IF_SETMODEL]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(e,hn),an(n,hn),t.activePlayer.write(new da(e,n))})),[Jt.IF_SETRECOL]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,hn),t.activePlayer.write(new Ta(e,n,s))})),[Jt.IF_SETTABFLASH]:Ct(Ut,(t=>{t.activePlayer.write(new nr(an(t.popInt(),hn)))})),[Jt.IF_SETANIM]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(e,hn),-1!==n&&t.activePlayer.write(new aa(e,n))})),[Jt.IF_SETTAB]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(n,hn),t.activePlayer.setTab(e,n)})),[Jt.IF_OPENMAINMODAL]:Ct(Ut,(t=>{t.activePlayer.openMainModal(an(t.popInt(),hn))})),[Jt.IF_OPENCHATSTICKY]:Ct(Ut,(t=>{t.activePlayer.openChatSticky(an(t.popInt(),hn))})),[Jt.IF_OPENSIDEOVERLAY]:Ct(Ut,(t=>{t.activePlayer.openSideOverlay(an(t.popInt(),hn))})),[Jt.IF_SETPLAYERHEAD]:Ct(Ut,(t=>{t.activePlayer.write(new Ea(an(t.popInt(),hn)))})),[Jt.IF_SETTEXT]:Ct(Ut,(t=>{const e=t.popString(),n=an(t.popInt(),hn);t.activePlayer.write(new Na(n,e))})),[Jt.IF_SETNPCHEAD]:Ct(Ut,(t=>{const[e,n]=t.popInts(2);an(e,hn),an(n,On),t.activePlayer.write(new _a(e,n))})),[Jt.IF_SETPOSITION]:Ct(Ut,(t=>{const[e,n,s]=t.popInts(3);an(e,hn),t.activePlayer.write(new fa(e,n,s))})),[Jt.IF_MULTIZONE]:Ct(Ut,(t=>{t.activePlayer.write(new Qa(1===an(t.popInt(),hn)))})),[Jt.GIVEXP]:Ct(Dt,(t=>{const[e,n]=t.popInts(2);an(e,hn),an(n,hn),t.activePlayer.addXp(e,n)})),[Jt.DAMAGE]:t=>{const e=an(t.popInt(),hn),n=an(t.popInt(),Pn),s=an(t.popInt(),hn),i=tl.getPlayerByUid(s);i&&i.applyDamage(e,n)},[Jt.IF_SETRESUMEBUTTONS]:Ct(Ut,(t=>{const[e,n,s,i,a]=t.popInts(5);t.activePlayer.resumeButtons=[e,n,s,i,a]})),[Jt.TEXT_GENDER]:Ct(Ut,(t=>{const[e,n]=t.popStrings(2);0==t.activePlayer.gender?t.pushString(e):t.pushString(n)})),[Jt.MIDI_SONG]:t=>{t.activePlayer.playSong(an(t.popString(),dn))},[Jt.MIDI_JINGLE]:t=>{const e=an(t.popInt(),hn),n=an(t.popString(),dn);t.activePlayer.playJingle(e,n)},[Jt.SOFTTIMER]:Ct(Ut,(t=>{const e=bc(t),n=t.popInt(),s=t.popInt(),i=Xt.get(s);if(!i)throw new Error(`Unable to find timer script: ${s}`);t.activePlayer.setTimer(1,i,e,n)})),[Jt.CLEARSOFTTIMER]:Ct(Ut,(t=>{t.activePlayer.clearTimer(t.popInt())})),[Jt.SETTIMER]:Ct(Ut,(t=>{const e=bc(t),n=t.popInt(),s=t.popInt(),i=Xt.get(s);if(!i)throw new Error(`Unable to find timer script: ${s}`);t.activePlayer.setTimer(0,i,e,n)})),[Jt.CLEARTIMER]:Ct(Ut,(t=>{t.activePlayer.clearTimer(t.popInt())})),[Jt.HINT_COORD]:t=>{const[e,n,s]=t.popInts(3),i=an(n,mn);t.activePlayer.hintTile(e,i.x,i.z,s)},[Jt.HINT_STOP]:t=>{t.activePlayer.stopHint()},[Jt.IF_CLOSESTICKY]:t=>{t.activePlayer.closeSticky()},[Jt.P_EXACTMOVE]:Ct(Dt,(t=>{const[e,n,s,i,a]=t.popInts(5),r=an(e,mn),o=an(n,mn);t.activePlayer.unsetMapFlag(),t.activePlayer.exactMove(r.x,r.z,o.x,o.z,s,i,a)})),[Jt.BUSY]:t=>{t.pushInt(t.activePlayer.busy()?1:0)},[Jt.BUSY2]:t=>{t.pushInt(t.activePlayer.hasInteraction()||t.activePlayer.hasWaypoints()?1:0)},[Jt.GETQUEUE]:t=>{const e=t.popInt();let n=0;for(let s=t.activePlayer.queue.head();null!==s;s=t.activePlayer.queue.next())s.script.id===e&&n++;for(let s=t.activePlayer.weakQueue.head();null!==s;s=t.activePlayer.weakQueue.next())s.script.id===e&&n++;t.pushInt(n)},[Jt.P_LOCMERGE]:Ct(Dt,(t=>{const[e,n,s,i]=t.popInts(4),a=an(s,mn),r=an(i,mn);tl.mergeLoc(t.activeLoc,t.activePlayer,e,n,a.z,a.x,r.z,r.x)})),[Jt.LAST_LOGIN_INFO]:t=>{const e=t.activePlayer;if(!yc(e)||null===e.client)return;const n=e.client.remoteAddress;if(null==n)return;const s=new Uint32Array(new Uint8Array(n.split('.').map((t=>parseInt(t)))).reverse().buffer)[0];e.lastLoginInfo(s,0,201,0)},[Jt.BAS_READYANIM]:t=>{t.activePlayer.basReadyAnim=an(t.popInt(),Un).id},[Jt.BAS_TURNONSPOT]:t=>{t.activePlayer.basTurnOnSpot=an(t.popInt(),Un).id},[Jt.BAS_WALK_F]:t=>{t.activePlayer.basWalkForward=an(t.popInt(),Un).id},[Jt.BAS_WALK_B]:t=>{t.activePlayer.basWalkBackward=an(t.popInt(),Un).id},[Jt.BAS_WALK_L]:t=>{t.activePlayer.basWalkLeft=an(t.popInt(),Un).id},[Jt.BAS_WALK_R]:t=>{t.activePlayer.basWalkRight=an(t.popInt(),Un).id},[Jt.BAS_RUNNING]:t=>{const e=t.popInt();t.activePlayer.basRunning=-1!==e?an(e,Un).id:-1},[Jt.GENDER]:t=>{t.pushInt(t.activePlayer.gender)},[Jt.HINT_NPC]:t=>{t.activePlayer.hintNpc(an(t.popInt(),hn))},[Jt.HINT_PLAYER]:t=>{t.activePlayer.hintPlayer(an(t.popInt(),hn))},[Jt.HEADICONS_GET]:t=>{t.pushInt(t.activePlayer.headicons)},[Jt.HEADICONS_SET]:t=>{t.activePlayer.headicons=an(t.popInt(),hn)},[Jt.P_OPOBJ]:Ct(Dt,(t=>{const e=an(t.popInt(),hn)-1;if(e<0||e>=5)throw new Error(`Invalid opobj: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(As.SCRIPT,t.activeObj,Os.APOBJ1+e)})),[Jt.P_OPPLAYER]:Ct(Dt,(t=>{const e=an(t.popInt(),hn)-1;if(e<0||e>=5)throw new Error(`Invalid opplayer: ${e+1}`);const n=t._activePlayer2;n&&(t.activePlayer.stopAction(),t.activePlayer.setInteraction(As.SCRIPT,n,Os.APPLAYER1+e))})),[Jt.ALLOWDESIGN]:t=>{t.activePlayer.allowDesign=1===an(t.popInt(),hn)},[Jt.LAST_TARGETSLOT]:t=>{if(![Os.INV_BUTTOND].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastTargetSlot)},[Jt.WALKTRIGGER]:t=>{t.activePlayer.walktrigger=t.popInt()},[Jt.GETWALKTRIGGER]:t=>{t.pushInt(t.activePlayer.walktrigger)},[Jt.CLEARQUEUE]:t=>{const e=t.popInt();for(let n=t.activePlayer.queue.head();null!==n;n=t.activePlayer.queue.next())n.script.id===e&&n.unlink();for(let n=t.activePlayer.weakQueue.head();null!==n;n=t.activePlayer.weakQueue.next())n.script.id===e&&n.unlink()},[Jt.HEALENERGY]:t=>{const e=an(t.popInt(),hn),n=t.activePlayer;n.runenergy=Math.min(Math.max(n.runenergy+e,0),1e4)},[Jt.AFK_EVENT]:t=>{t.pushInt(t.activePlayer.afkEventReady?1:0),t.activePlayer.afkEventReady=!1},[Jt.LOWMEMORY]:t=>{t.pushInt(t.activePlayer.lowMemory?1:0)},[Jt.SETIDKIT]:t=>{const[e,n]=t.popInts(2),s=an(e,Rn);let i=s.type;1===t.activePlayer.gender&&(i-=7),t.activePlayer.body[i]=s.id;let a=s.type;1===t.activePlayer.gender&&(a-=7);let r=-1;0===a||1===a?r=0:2===a||3===a?r=1:4===a||(5===a?r=2:6===a&&(r=3)),-1!==r&&(t.activePlayer.colors[r]=n)},[Jt.SETGENDER]:t=>{const e=an(t.popInt(),Wn);for(let n=0;n<7;n++){t.activePlayer.body[n]=-1;for(let s=0;s<j.count;s++)if(!j.get(s).disable&&j.get(s).type==n+(0===e?0:7)){t.activePlayer.body[n]=s;break}}t.activePlayer.gender=e},[Jt.SETSKINCOLOUR]:t=>{const e=an(t.popInt(),zn);t.activePlayer.colors[4]=e},[Jt.P_OPPLAYERT]:Ct(Dt,(t=>{const e=an(t.popInt(),hn),n=t._activePlayer2;n&&(t.activePlayer.stopAction(),t.activePlayer.setInteraction(As.SCRIPT,n,Os.APPLAYERT,{type:-1,com:e}))})),[Jt.FINDHERO]:Ct(Ut,(t=>{const e=t.activePlayer.findHero();if(-1===e)return void t.pushInt(0);const n=tl.getPlayerByUid(e);n?(t._activePlayer2=n,t.pointerAdd(Mt.ActivePlayer2),t.pushInt(1)):t.pushInt(0)})),[Jt.BOTH_HEROPOINTS]:Ct(Ut,(t=>{const e=an(t.popInt(),hn),n=1===t.intOperand,s=n?t._activePlayer2:t._activePlayer,i=n?t._activePlayer:t._activePlayer2;if(!s||!i)throw new Error('player is null');i.addHero(s.uid,e)})),[Jt.P_ANIMPROTECT]:Ct(Dt,(t=>{t.activePlayer.animProtect=an(t.popInt(),hn)}))},Dc=Uc,Mc={[Jt.MAP_CLOCK]:t=>{t.pushInt(tl.currentTick)},[Jt.MAP_MEMBERS]:t=>{t.pushInt(tl.members?1:0)},[Jt.MAP_PLAYERCOUNT]:t=>{const[e,n]=t.popInts(2),s=an(e,mn),i=an(n,mn);let a=0;for(let t=Math.floor(s.x/8);t<=Math.ceil(i.x/8);t++)for(let e=Math.floor(s.z/8);e<=Math.ceil(i.z/8);e++)for(const n of tl.getZone(t<<3,e<<3,s.level).getAllPlayersSafe())n.x>=s.x&&n.x<=i.x&&n.z>=s.z&&n.z<=i.z&&a++;t.pushInt(a)},[Jt.HUNTALL]:t=>{const[e,n,s]=t.popInts(3),i=an(e,mn);an(n,hn);const a=an(s,bn);t.huntIterator=new os(tl.currentTick,i.level,i.x,i.z,n,a,-1,-1,B.PLAYER)},[Jt.HUNTNEXT]:t=>{const e=t.huntIterator?.next();if(e&&!e.done){if(!(e.value instanceof Br))throw new Error('[ServerOps] huntnext command must result instance of Player.');t.activePlayer=e.value,t.pointerAdd(Ut[t.intOperand]),t.pushInt(1)}else t.pushInt(0)},[Jt.NPC_HUNTALL]:t=>{const[e,n,s]=t.popInts(3),i=an(e,mn);an(n,hn);const a=an(s,bn);t.huntIterator=new os(tl.currentTick,i.level,i.x,i.z,n,a,-1,-1,B.NPC)},[Jt.NPC_HUNTNEXT]:t=>{const e=t.huntIterator?.next();if(e&&!e.done){if(!(e.value instanceof Hc))throw new Error('[ServerOps] npc_huntnext command must result instance of Npc.');t.activeNpc=e.value,t.pointerAdd(wt[t.intOperand]),t.pushInt(1)}else t.pushInt(0)},[Jt.INZONE]:t=>{const[e,n,s]=t.popInts(3),i=an(e,mn),a=an(n,mn),r=an(s,mn);r.x<i.x||r.x>a.x||r.level<i.level||r.level>a.level||r.z<i.z||r.z>a.z?t.pushInt(0):t.pushInt(1)},[Jt.LINEOFWALK]:t=>{const[e,n]=t.popInts(2),s=an(e,mn),i=an(n,mn);s.level===i.level?t.pushInt(Ie(s.level,s.x,s.z,i.x,i.z,1,1,1,1)?1:0):t.pushInt(0)},[Jt.STAT_RANDOM]:t=>{const[e,n,s]=t.popInts(3),i=Math.floor(n*(99-e)/98)+Math.floor(s*(e-1)/98)+1,a=Math.floor(256*Math.random());t.pushInt(i>a?1:0)},[Jt.SPOTANIM_MAP]:t=>{const[e,n,s,i]=t.popInts(4),a=an(n,mn),r=an(e,Ln);tl.animMap(a.level,a.x,a.z,r.id,s,i)},[Jt.DISTANCE]:t=>{const[e,n]=t.popInts(2),s=an(e,mn),i=an(n,mn);t.pushInt(qe.distanceToSW(s,i))},[Jt.MOVECOORD]:t=>{const[e,n,s,i]=t.popInts(4),a=an(e,mn);t.pushInt(qe.packCoord(a.level+s,a.x+n,a.z+i))},[Jt.SEQLENGTH]:t=>{t.pushInt(an(t.popInt(),Un).duration)},[Jt.SPLIT_INIT]:t=>{const[e,n,s]=t.popInts(3);let i=t.popString();const a=an(s,xn);if(i.startsWith('<p,')&&-1!==i.indexOf('>')){const e=i.substring(3,i.indexOf('>'));t.splitMesanim=nt.getId(e),i=i.substring(i.indexOf('>')+1)}else t.splitMesanim=-1;t.splitPages=[];const r=a.split(i,e);for(;r.length>0;)t.splitPages.push(r.splice(0,n))},[Jt.SPLIT_GET]:t=>{const[e,n]=t.popInts(2);t.pushString(t.splitPages[e][n])},[Jt.SPLIT_PAGECOUNT]:t=>{t.pushInt(t.splitPages.length)},[Jt.SPLIT_LINECOUNT]:t=>{const e=t.popInt();t.pushInt(t.splitPages[e].length)},[Jt.SPLIT_GETANIM]:t=>{const e=t.popInt();-1!==t.splitMesanim?t.pushInt(an(t.splitMesanim,Bn).len[t.splitPages[e].length-1]):t.pushInt(-1)},[Jt.STRUCT_PARAM]:t=>{const[e,n]=t.popInts(2),s=an(n,En),i=an(e,Hn);s.isString()?t.pushString(Q(s.id,i,s.defaultString)):t.pushInt(q(s.id,i,s.defaultInt))},[Jt.COORDX]:t=>{t.pushInt(an(t.popInt(),mn).x)},[Jt.COORDY]:t=>{t.pushInt(an(t.popInt(),mn).level)},[Jt.COORDZ]:t=>{t.pushInt(an(t.popInt(),mn).z)},[Jt.PLAYERCOUNT]:t=>{t.pushInt(tl.getTotalPlayers())},[Jt.MAP_BLOCKED]:t=>{const e=an(t.popInt(),mn);t.pushInt(fe(e.x,e.z,e.level,He.WALK_BLOCKED)?1:0)},[Jt.MAP_INDOORS]:t=>{const e=an(t.popInt(),mn);t.pushInt(fe(e.x,e.z,e.level,He.ROOF)?1:0)},[Jt.LINEOFSIGHT]:t=>{const[e,n]=t.popInts(2),s=an(e,mn),i=an(n,mn);s.level===i.level?t.pushInt(Te(s.level,s.x,s.z,i.x,i.z,1,1,1,1)?1:0):t.pushInt(0)},[Jt.WORLD_DELAY]:t=>{t.execution=ee.WORLD_SUSPENDED},[Jt.PROJANIM_PL]:t=>{const[e,n,s,i,a,r,o,c,l]=t.popInts(9),h=an(e,mn),d=an(s,Ln),p=tl.getPlayerByUid(n);if(!p)throw new Error(`attempted to use invalid player uid: ${n}`);tl.mapProjAnim(h.level,h.x,h.z,p.x,p.z,-p.pid-1,d.id,i+100,a+100,r,o,c,l)},[Jt.PROJANIM_NPC]:t=>{const[e,n,s,i,a,r,o,c,l]=t.popInts(9),h=an(e,mn),d=an(s,Ln),p=65535&n,_=tl.getNpc(p);if(!_)throw new Error(`attempted to use invalid npc uid: ${n}`);tl.mapProjAnim(h.level,h.x,h.z,_.x,_.z,_.nid+1,d.id,i+100,a+100,r,o,c,l)},[Jt.PROJANIM_MAP]:t=>{const[e,n,s,i,a,r,o,c,l]=t.popInts(9),h=an(s,Ln),d=an(e,mn),p=an(n,mn);tl.mapProjAnim(d.level,d.x,d.z,p.x,p.z,0,h.id,i+100,a,r,o,c,l)},[Jt.MAP_LOCADDUNSAFE]:t=>{const e=an(t.popInt(),mn);for(const n of tl.getZone(e.x,e.z,e.level).getAllLocsUnsafe()){if(1!==an(n.type,pn).active)continue;const s=Se(n.shape);if(n.checkLifeCycle(tl.currentTick)||s!==ze.WALL)if(s===ze.WALL){if(n.x===e.x&&n.z===e.z)return void t.pushInt(1)}else if(s===ze.GROUND){const s=n.angle===Ge.NORTH||n.angle===Ge.SOUTH?n.length:n.width,i=n.angle===Ge.NORTH||n.angle===Ge.SOUTH?n.width:n.length;for(let a=0;a<s*i;a++){const i=n.x+a%s,r=n.z+(a/s|0);if(i===e.x&&r===e.z)return void t.pushInt(1)}}else if(s===ze.GROUND_DECOR&&n.x===e.x&&n.z===e.z)return void t.pushInt(1)}t.pushInt(0)},[Jt.NPCCOUNT]:t=>{t.pushInt(tl.getTotalNpcs())},[Jt.MAP_LASTCLOCK]:t=>{t.pushInt(tl.lastCycleStats[0])},[Jt.MAP_LASTWORLD]:t=>{t.pushInt(tl.lastCycleStats[1])},[Jt.MAP_LASTCLIENTIN]:t=>{t.pushInt(tl.lastCycleStats[2])},[Jt.MAP_LASTNPC]:t=>{t.pushInt(tl.lastCycleStats[3])},[Jt.MAP_LASTPLAYER]:t=>{t.pushInt(tl.lastCycleStats[4])},[Jt.MAP_LASTLOGOUT]:t=>{t.pushInt(tl.lastCycleStats[5])},[Jt.MAP_LASTLOGIN]:t=>{t.pushInt(tl.lastCycleStats[6])},[Jt.MAP_LASTZONE]:t=>{t.pushInt(tl.lastCycleStats[7])},[Jt.MAP_LASTCLIENTOUT]:t=>{t.pushInt(tl.lastCycleStats[8])},[Jt.MAP_LASTCLEANUP]:t=>{t.pushInt(tl.lastCycleStats[9])},[Jt.MAP_LASTBANDWIDTHIN]:t=>{t.pushInt(tl.lastCycleBandwidth[0])},[Jt.MAP_LASTBANDWIDTHOUT]:t=>{t.pushInt(tl.lastCycleBandwidth[1])},[Jt.ZONECOUNT]:t=>{t.pushInt(tl.zoneMap.zoneCount())},[Jt.LOCCOUNT]:t=>{t.pushInt(tl.zoneMap.locCount())},[Jt.OBJCOUNT]:t=>{t.pushInt(tl.zoneMap.objCount())}},kc=Mc,xc={[Jt.APPEND_NUM]:t=>{const e=t.popString(),n=t.popInt();t.pushString(e+n)},[Jt.APPEND]:t=>{const[e,n]=t.popStrings(2);t.pushString(e+n)},[Jt.APPEND_SIGNNUM]:t=>{const e=t.popString(),n=t.popInt();n>=0?t.pushString(`${e}+${n}`):t.pushString(e+n)},[Jt.LOWERCASE]:t=>{t.pushString(t.popString().toLowerCase())},[Jt.TOSTRING]:t=>{t.pushString(t.popInt().toString())},[Jt.COMPARE]:t=>{const[e,n]=t.popStrings(2);t.pushInt(function(t,e){const n=t.length,s=e.length,i=Math.min(n,s);let a=0;for(;a<i;){const n=t.charCodeAt(a),s=e.charCodeAt(a);if(n!=s)return n-s;a++}return n-s}(e,n))},[Jt.TEXT_SWITCH]:t=>{const e=t.popInt(),[n,s]=t.popStrings(2);t.pushString(1===e?n:s)},[Jt.APPEND_CHAR]:t=>{const e=t.popString(),n=t.popInt();t.pushString(e+String.fromCharCode(n))},[Jt.STRING_LENGTH]:t=>{t.pushInt(t.popString().length)},[Jt.SUBSTRING]:t=>{const e=t.popString(),[n,s]=t.popInts(2);t.pushString(e.substring(n,s))},[Jt.STRING_INDEXOF_CHAR]:t=>{const e=t.popString(),n=String.fromCharCode(t.popInt());t.pushInt(e.indexOf(n))},[Jt.STRING_INDEXOF_STRING]:t=>{const e=t.popString(),n=t.popString();t.pushInt(e.indexOf(n))}};class Bc{static HANDLERS={...jn,...kc,...Dc,...Ts,...us,...ys,...Is,...gs,...vs,...is,...Xn,...xc,...Cs,...Zn,...$n};static init(t,e=null,n=null,s=[]){const i=new ee(t,s);return i.self=e,e instanceof Br?(i._activePlayer=e,i.pointerAdd(Mt.ActivePlayer)):e instanceof Hc?(i._activeNpc=e,i.pointerAdd(Mt.ActiveNpc)):e instanceof hs?(i._activeLoc=e,i.pointerAdd(Mt.ActiveLoc)):e instanceof es&&(i._activeObj=e,i.pointerAdd(Mt.ActiveObj)),n instanceof Br?e instanceof Br?(i._activePlayer2=n,i.pointerAdd(Mt.ActivePlayer2)):(i._activePlayer=n,i.pointerAdd(Mt.ActivePlayer)):n instanceof Hc?e instanceof Hc?(i._activeNpc2=n,i.pointerAdd(Mt.ActiveNpc2)):(i._activeNpc=n,i.pointerAdd(Mt.ActiveNpc)):n instanceof hs?e instanceof hs?(i._activeLoc2=n,i.pointerAdd(Mt.ActiveLoc2)):(i._activeLoc=n,i.pointerAdd(Mt.ActiveLoc)):n instanceof es&&(e instanceof es?(i._activeObj2=n,i.pointerAdd(Mt.ActiveObj2)):(i._activeObj=n,i.pointerAdd(Mt.ActiveObj))),i}static execute(t,e=!1,n=!1){if(!t||!t.script||!t.script.info)return ee.ABORTED;try{e&&t.reset(),t.execution!==ee.RUNNING&&t.executionHistory.push(t.execution),t.execution=ee.RUNNING;const s=1e3*performance.now();for(;t.execution===ee.RUNNING;){if(t.pc>=t.script.opcodes.length||t.pc<-1)throw new Error('Invalid program counter: '+t.pc+', max expected: '+t.script.opcodes.length);if(!n&&t.opcount>5e5)throw new Error('Too many instructions');t.opcount++,Bc.executeInner(t,t.script.opcodes[++t.pc])}const i=1e3*performance.now()-s|0;if(Jn.PROFILE_SCRIPTS&&i>1e3){const e=`Warning [cpu time]: Script: ${t.script.info.scriptName}, time: ${i}us`;t.self instanceof Br?t.self.wrappedMessageGame(e):console.warn(e)}}catch(e){if(t.pc>=0&&t.pc<t.script.opcodes.length){const n=t.script.opcodes[t.pc];let s=t.intOperand;n===Jt.POP_VARP||n===Jt.POP_VARN||n===Jt.PUSH_VARP||n===Jt.PUSH_VARN?s=t.intOperand>>16&1:n<=Jt.POP_ARRAY_INT&&(s=0),e.message=Jt[n].toLowerCase()+' '+e.message,s&&(e.message='.'+e.message)}if(t.self instanceof Br){t.self.wrappedMessageGame(`script error: ${e.message}`),t.self.wrappedMessageGame(`file: ${Zt.basename(t.script.info.sourceFilePath)}`),t.self.wrappedMessageGame(''),t.self.wrappedMessageGame('stack backtrace:'),t.self.wrappedMessageGame(`    1: ${t.script.name} - ${t.script.fileName}:${t.script.lineNumber(t.pc)}`);let n=1;for(let e=t.fp;e>0;e--){const s=t.frames[e];s&&(n++,t.self.wrappedMessageGame(`    ${n}: ${s.script.name} - ${s.script.fileName}:${s.script.lineNumber(s.pc)}`))}for(let e=t.debugFp;e>=0;e--){const s=t.debugFrames[e];s&&(n++,t.self.wrappedMessageGame(`    ${n}: ${s.script.name} - ${s.script.fileName}:${s.script.lineNumber(s.pc)}`))}}console.error(`script error: ${e.message}`),console.error(`file: ${Zt.basename(t.script.info.sourceFilePath)}`),console.error(''),console.error('stack backtrace:'),console.error(`    1: ${t.script.name} - ${t.script.fileName}:${t.script.lineNumber(t.pc)}`);let n=1;for(let e=t.fp;e>0;e--){const s=t.frames[e];s&&(n++,console.error(`    ${n}: ${s.script.name} - ${s.script.fileName}:${s.script.lineNumber(s.pc)}`))}for(let e=t.debugFp;e>=0;e--){const s=t.debugFrames[e];s&&(n++,console.error(`    ${n}: ${s.script.name} - ${s.script.fileName}:${s.script.lineNumber(s.pc)}`))}t.execution=ee.ABORTED}return t.execution}static executeInner(t,e){const n=Bc.HANDLERS[e];if(!n)throw new Error(`Unknown opcode ${e}`);n(t)}}class Hc extends xs{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;nid;type;uid;origType;startX;startZ;levels=new Uint8Array(6);baseLevels=new Uint8Array(6);vars;varsString;activeScript=null;delay=0;queue=new g;timerInterval=0;timerClock=0;huntMode=-1;nextHuntTick=-1;huntrange=5;nextPatrolTick=-1;nextPatrolPoint=0;delayedPatrol=!1;heroPoints=new Array(16);constructor(t,e,n,s,i,a,r,o,c,l){super(t,e,n,s,i,a,c,l,ks.NAIVE,Hc.FACE_COORD,Hc.FACE_ENTITY),this.nid=r,this.type=o,this.uid=o<<16|r,this.startX=this.x,this.startZ=this.z,this.origType=o;const h=pt.get(o);for(let t=0;t<h.stats.length;t++){const e=h.stats[t];this.levels[t]=e,this.baseLevels[t]=e}-1!==h.timer&&this.setTimer(h.timer),this.vars=new Int32Array(Ot.count),this.varsString=new Array(Ot.count),this.targetOp=h.defaultmode,this.huntMode=h.huntmode,this.huntrange=h.huntrange}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(t,e){const n=this.heroPoints.findIndex((e=>e&&e.uid===t));if(-1!==n)return void(this.heroPoints[n].points+=e);const s=this.heroPoints.findIndex((t=>t&&-1===t.uid));-1===s||(this.heroPoints[s]={uid:t,points:e})}findHero(){return this.heroPoints.sort(((t,e)=>e.points-t.points)),this.heroPoints[0]?.uid??-1}getVar(t){const e=Ot.get(t);return e.type===A.STRING?this.varsString[e.id]:this.vars[e.id]}setVar(t,e){const n=Ot.get(t);n.type===A.STRING&&'string'==typeof e?this.varsString[n.id]=e:'number'==typeof e&&(this.vars[n.id]=e)}resetEntity(t){if(t){this.type=this.origType,this.uid=this.type<<16|this.nid,this.orientation=Xe;for(let t=0;t<this.baseLevels.length;t++)this.levels[t]=this.baseLevels[t];this.resetHeroPoints(),this.defaultMode();const t=pt.get(this.type);this.huntrange=t.huntrange}super.resetPathingEntity()}updateMovement(t=!0){const e=pt.get(this.type);if(e.moverestrict===ct.NOMOVE)return!1;if(this.target&&this.targetOp!==Y.PLAYERFOLLOW){const t=qe.distanceTo(this,{x:this.startX,z:this.startZ,width:this.width,length:this.length});if(qe.distanceTo(this.target,{x:this.startX,z:this.startZ,width:this.target.width,length:this.target.length})>e.maxrange&&t>e.maxrange)return!1}if(t&&this.target instanceof xs&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),-1!==this.walktrigger){const t=pt.get(this.type),e=Xt.getByTrigger(Os.AI_QUEUE1+this.walktrigger,t.id,t.category);if(this.walktrigger=-1,e){const t=Bc.init(e,this,null,[this.walktriggerArg]);Bc.execute(t)}}return this.moveSpeed!==Ms.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed()),super.processMovement()}blockWalkFlag(){return this.moveRestrict===ct.NORMAL?He.NPC:this.moveRestrict===ct.BLOCKED?He.OPEN:this.moveRestrict===ct.BLOCKED_NORMAL||this.moveRestrict===ct.INDOORS||this.moveRestrict===ct.OUTDOORS?He.NPC:this.moveRestrict===ct.NOMOVE?He.NULL:this.moveRestrict===ct.PASSTHRU?He.OPEN:He.NULL}defaultMoveSpeed(){return Ms.WALK}delayed(){return this.delay>0}setTimer(t){this.timerInterval=t}executeScript(t){if(!t)return;const e=Bc.execute(t);e!==ee.FINISHED&&e!==ee.ABORTED?e===ee.WORLD_SUSPENDED?tl.enqueueScript(t,t.popInt()):e===ee.NPC_SUSPENDED?t.activeNpc.activeScript=t:t.activePlayer.activeScript=t:t===this.activeScript&&(this.activeScript=null),t.pointerGet(Mt.ProtectedActivePlayer)&&t._activePlayer&&(t._activePlayer.protect=!1,t.pointerRemove(Mt.ProtectedActivePlayer)),t.pointerGet(Mt.ProtectedActivePlayer2)&&t._activePlayer2&&(t._activePlayer2.protect=!1,t.pointerRemove(Mt.ProtectedActivePlayer2))}processTimers(){if(0!==this.timerInterval&&++this.timerClock>=this.timerInterval){this.timerClock=0;const t=pt.get(this.type),e=Xt.getByTrigger(Os.AI_TIMER,t.id,t.category);e&&this.executeScript(Bc.init(e,this))}}processQueue(){for(let t=this.queue.head();null!==t;t=this.queue.next())if(this.delayed()||t.delay--,!this.delayed()&&t.delay<=0){const e=Bc.init(t.script,this,null,t.args);e.lastInt=t.lastInt,this.executeScript(e),t.unlink()}}enqueueScript(t,e=0,n=0){const s=new ws(0,t,[],e);s.lastInt=n,this.queue.addTail(s)}randomWalk(t){const e=Math.round(Math.random()*(2*t)-t),n=Math.round(Math.random()*(2*t)-t),s=this.startX+e,i=this.startZ+n;s===this.x&&i===this.z||this.queueWaypoint(s,i)}processNpcModes(){this.targetOp===Y.NULL?this.defaultMode():this.targetOp===Y.NONE?this.noMode():this.targetOp===Y.WANDER?this.wanderMode():this.targetOp===Y.PATROL?this.patrolMode():this.targetOp===Y.PLAYERESCAPE?this.playerEscapeMode():this.targetOp===Y.PLAYERFOLLOW?this.playerFollowMode():this.targetOp===Y.PLAYERFACE?this.playerFaceMode():this.targetOp===Y.PLAYERFACECLOSE?this.playerFaceCloseMode():this.aiMode()}noMode(){this.clearInteraction(),this.updateMovement(!1),this.targetOp=Y.NONE,this.faceEntity=-1,this.mask|=Hc.FACE_ENTITY}defaultMode(){this.clearInteraction(),this.updateMovement(!1);const t=pt.get(this.type);this.targetOp=t.defaultmode,this.faceEntity=-1,this.mask|=Hc.FACE_ENTITY}wanderMode(){const t=pt.get(this.type);t.moverestrict!==ct.NOMOVE&&Math.random()<.125&&this.randomWalk(t.wanderrange),this.updateMovement(!1)}patrolMode(){const t=pt.get(this.type),e=t.patrolCoord,n=t.patrolDelay[this.nextPatrolPoint];let s=qe.unpackCoord(e[this.nextPatrolPoint]);this.updateMovement(!1),this.hasWaypoints()||this.target||this.queueWaypoint(s.x,s.z),(this.x!==s.x||this.z!==s.z)&&tl.currentTick>=this.nextPatrolTick&&this.teleport(s.x,s.z,s.level),this.x!==s.x||this.z!==s.z||this.delayedPatrol||(this.nextPatrolTick=tl.currentTick+n,this.delayedPatrol=!0),this.nextPatrolTick>tl.currentTick||(this.nextPatrolPoint=(this.nextPatrolPoint+1)%e.length,this.nextPatrolTick=tl.currentTick+30,this.delayedPatrol=!1,s=qe.unpackCoord(e[this.nextPatrolPoint]),this.queueWaypoint(s.x,s.z))}playerEscapeMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof Br))throw new Error('[Npc] Target must be a Player for playerescape mode.');if(null===tl.getPlayerByUid(this.target.uid))return void this.defaultMode();if(qe.distanceToSW(this,this.target)>25)return void this.defaultMode();let t,e;this.target.x>=this.x&&this.target.z>=this.z?(t=$e,e=He.WALL_SOUTH|He.WALL_WEST):this.target.x>=this.x&&this.target.z<this.z?(t=Ye,e=He.WALL_NORTH|He.WALL_WEST):this.target.x<this.x&&this.target.z>=this.z?(t=Qe,e=He.WALL_SOUTH|He.WALL_EAST):(t=je,e=He.WALL_NORTH|He.WALL_EAST);const n=qe.moveX(this.x,t),s=qe.moveZ(this.z,t);if(fe(n,s,this.level,e))return void this.defaultMode();const i={x:n,z:s,level:this.level};if(qe.distanceToSW(i,{x:this.startX,z:this.startZ})<pt.get(this.type).maxrange)return this.queueWaypoint(i.x,i.z),void this.updateMovement(!1);t===je||t===Ye?this.queueWaypoint(this.x,i.z):this.queueWaypoint(i.x,this.z),this.updateMovement(!1)}playerFollowMode(){if(this.target){if(!(this.target instanceof Br))throw new Error('[Npc] Target must be a Player for playerfollow mode.');null!==tl.getPlayerByUid(this.target.uid)&&this.level===this.target.level?(this.pathToTarget(),this.updateMovement()):this.defaultMode()}else this.defaultMode()}playerFaceMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof Br))throw new Error('[Npc] Target must be a Player for playerface mode.');if(null===tl.getPlayerByUid(this.target.uid))return void this.defaultMode();if(this.level!==this.target.level)return void this.defaultMode();const t=pt.get(this.type);qe.distanceTo(this,this.target)>t.maxrange?this.defaultMode():this.updateMovement(!1)}playerFaceCloseMode(){if(this.target){if(!(this.target instanceof Br))throw new Error('[Npc] Target must be a Player for playerfaceclose mode.');null!=tl.getPlayerByUid(this.target.uid)&&this.level===this.target.level?qe.distanceTo(this,this.target)>1?this.defaultMode():this.updateMovement(!1):this.defaultMode()}else this.defaultMode()}aiMode(){if(this.delayed()||!this.target)return void this.defaultMode();if(this.target.level!==this.level)return void this.defaultMode();if(this.target instanceof Hc&&(null===tl.getNpc(this.target.nid)||this.target.delayed()))return void this.defaultMode();if(this.target instanceof Hc&&-1!==this.targetSubject.type&&null===tl.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return void this.defaultMode();if(this.target instanceof es&&null===tl.getObj(this.target.x,this.target.z,this.level,this.target.type,-1))return void this.defaultMode();if(this.target instanceof hs&&null===tl.getLoc(this.target.x,this.target.z,this.level,this.target.type))return void this.defaultMode();if(this.target instanceof Br&&null===tl.getPlayerByUid(this.target.uid))return void this.defaultMode();const t=pt.get(this.type);if(qe.distanceTo(this,this.target)>t.attackrange)return void this.defaultMode();const e=this.targetOp>=Y.APNPC1&&this.targetOp<=Y.APNPC5||this.targetOp>=Y.APPLAYER1&&this.targetOp<=Y.APPLAYER5||this.targetOp>=Y.APLOC1&&this.targetOp<=Y.APLOC5||this.targetOp>=Y.APOBJ1&&this.targetOp<=Y.APOBJ5,n=!e,s=this.getTrigger();s&&n&&this.inOperableDistance(this.target)&&this.target instanceof xs||s&&e&&this.inApproachDistance(t.attackrange,this.target)?(this.executeScript(Bc.init(s,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&this.target instanceof xs&&(this.target=null,this.interacted=!0,this.clearWaypoints());const i=this.updateMovement();i&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1),this.target&&!this.interacted&&(this.interacted=!1,s&&n&&this.inOperableDistance(this.target)&&(this.target instanceof xs||!i)||s&&e&&this.inApproachDistance(t.attackrange,this.target)?(this.executeScript(Bc.init(s,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&(this.target instanceof xs||!i)&&(this.target=null,this.interacted=!0,this.clearWaypoints()))}getTrigger(){const t=this.getTriggerForMode(this.targetOp);return t?Xt.getByTrigger(t,this.type,-1)??null:null}getTriggerForMode(t){return t===Y.OPPLAYER1?Os.AI_OPPLAYER1:t===Y.OPPLAYER2?Os.AI_OPPLAYER2:t===Y.OPPLAYER3?Os.AI_OPPLAYER3:t===Y.OPPLAYER4?Os.AI_OPPLAYER4:t===Y.OPPLAYER5?Os.AI_OPPLAYER5:t===Y.APPLAYER1?Os.AI_APPLAYER1:t===Y.APPLAYER2?Os.AI_APPLAYER2:t===Y.APPLAYER3?Os.AI_APPLAYER3:t===Y.APPLAYER4?Os.AI_APPLAYER4:t===Y.APPLAYER5?Os.AI_APPLAYER5:t===Y.OPLOC1?Os.AI_OPLOC1:t===Y.OPLOC2?Os.AI_OPLOC2:t===Y.OPLOC3?Os.AI_OPLOC3:t===Y.OPLOC4?Os.AI_OPLOC4:t===Y.OPLOC5?Os.AI_OPLOC5:t===Y.APLOC1?Os.AI_APLOC1:t===Y.APLOC2?Os.AI_APLOC2:t===Y.APLOC3?Os.AI_APLOC3:t===Y.APLOC4?Os.AI_APLOC4:t===Y.APLOC5?Os.AI_APLOC5:t===Y.OPOBJ1?Os.AI_OPOBJ1:t===Y.OPOBJ2?Os.AI_OPOBJ2:t===Y.OPOBJ3?Os.AI_OPOBJ3:t===Y.OPOBJ4?Os.AI_OPOBJ4:t===Y.OPOBJ5?Os.AI_OPOBJ5:t===Y.APOBJ1?Os.AI_APOBJ1:t===Y.APOBJ2?Os.AI_APOBJ2:t===Y.APOBJ3?Os.AI_APOBJ3:t===Y.APOBJ4?Os.AI_APOBJ4:t===Y.APOBJ5?Os.AI_APOBJ5:t===Y.OPNPC1?Os.AI_OPNPC1:t===Y.OPNPC2?Os.AI_OPNPC2:t===Y.OPNPC3?Os.AI_OPNPC3:t===Y.OPNPC4?Os.AI_OPNPC4:t===Y.OPNPC5?Os.AI_OPNPC5:t===Y.APNPC1?Os.AI_APNPC1:t===Y.APNPC2?Os.AI_APNPC2:t===Y.APNPC3?Os.AI_APNPC3:t===Y.APNPC4?Os.AI_APNPC4:t===Y.APNPC5?Os.AI_APNPC5:t===Y.QUEUE1?Os.AI_QUEUE1:t===Y.QUEUE2?Os.AI_QUEUE2:t===Y.QUEUE3?Os.AI_QUEUE3:t===Y.QUEUE4?Os.AI_QUEUE4:t===Y.QUEUE5?Os.AI_QUEUE5:t===Y.QUEUE6?Os.AI_QUEUE6:t===Y.QUEUE7?Os.AI_QUEUE7:t===Y.QUEUE8?Os.AI_QUEUE8:t===Y.QUEUE9?Os.AI_QUEUE9:t===Y.QUEUE10?Os.AI_QUEUE10:t===Y.QUEUE11?Os.AI_QUEUE11:t===Y.QUEUE12?Os.AI_QUEUE12:t===Y.QUEUE13?Os.AI_QUEUE13:t===Y.QUEUE14?Os.AI_QUEUE14:t===Y.QUEUE15?Os.AI_QUEUE15:t===Y.QUEUE16?Os.AI_QUEUE16:t===Y.QUEUE17?Os.AI_QUEUE17:t===Y.QUEUE18?Os.AI_QUEUE18:t===Y.QUEUE19?Os.AI_QUEUE19:t===Y.QUEUE20?Os.AI_QUEUE20:null}huntAll(){if(this.nextHuntTick>tl.currentTick)return;const t=K.get(this.huntMode);if(t.type===B.OFF)return;if(t.nobodyNear===G.PAUSEHUNT&&!tl.getZoneGrid(this.level).isFlagged(qe.zone(this.x),qe.zone(this.z),5))return;if(!t.findKeepHunting&&null!==this.target)return;let e;if(e=t.type===B.PLAYER?this.huntPlayers(t):t.type===B.NPC?this.huntNpcs(t):t.type===B.OBJ?this.huntObjs(t):this.huntLocs(t),e.length>0){const n=e[Math.floor(Math.random()*e.length)];this.setInteraction(As.SCRIPT,n,t.findNewMode)}this.nextHuntTick=tl.currentTick+t.rate}huntPlayers(t){const e=pt.get(this.type),n=[],s=new os(tl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,-1,-1,B.PLAYER);for(const i of s){if(!(i instanceof Br))throw new Error('[Npc] huntAll must be of type Player here.');if((!t.checkAfk||!i.zonesAfk())&&((t.checkNotTooStrong!==M.OUTSIDE_WILDERNESS||i.isInWilderness()||!(i.combatLevel>2*e.vislevel))&&!(-1!==t.checkNotCombat&&i.getVar(t.checkNotCombat)+8>tl.currentTick||-1!==t.checkNotCombatSelf&&this.getVar(t.checkNotCombatSelf)>=tl.currentTick))){if(-1!==t.checkInv){let e=0;if(-1!==t.checkObj?e=i.invTotal(t.checkInv,t.checkObj):-1!==t.checkObjParam&&(e=i.invTotalParam(t.checkInv,t.checkObjParam)),e<t.checkInvMinQuantity||e>t.checkInvMaxQuantity)continue}t.checkNotBusy&&i.busy()||n.push(i)}}return n}huntNpcs(t){return Array.from(new os(tl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkNpc,t.checkCategory,B.NPC))}huntObjs(t){return Array.from(new os(tl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkObj,t.checkCategory,B.OBJ))}huntLocs(t){return Array.from(new os(tl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkLoc,t.checkCategory,B.SCENERY))}playAnimation(t,e){this.animId=t,this.animDelay=e,this.mask|=Hc.ANIM}spotanim(t,e,n){this.graphicId=t,this.graphicHeight=e,this.graphicDelay=n,this.mask|=Hc.SPOTANIM}applyDamage(t,e){this.damageTaken=t,this.damageType=e;const n=this.levels[dt.HITPOINTS];n-t<=0?(this.levels[dt.HITPOINTS]=0,this.damageTaken=n):this.levels[dt.HITPOINTS]=n-t,this.mask|=Hc.DAMAGE}say(t){t&&(this.chat=t,this.mask|=Hc.SAY)}faceSquare(t,e){this.faceX=2*t+1,this.faceZ=2*e+1,this.orientation=qe.face(this.x,this.z,t,e),this.mask|=Hc.FACE_COORD}changeType(t){this.type=t,this.mask|=Hc.CHANGE_TYPE,this.uid=t<<16|this.nid}}class Fc{async init(t){console.time('Loading game map');const e='data/pack/server/maps/',n=['m29_75','m30_75','m31_75','m32_70','m32_71','m32_72','m32_73','m32_74','m32_75','m33_70','m33_71','m33_72','m33_73','m33_74','m33_75','m33_76','m34_70','m34_71','m34_72','m34_73','m34_74','m34_75','m34_76','m35_20','m35_75','m35_76','m36_146','m36_147','m36_148','m36_149','m36_150','m36_153','m36_154','m36_52','m36_53','m36_54','m36_72','m36_73','m36_74','m36_75','m36_76','m37_146','m37_147','m37_148','m37_149','m37_150','m37_151','m37_152','m37_153','m37_154','m37_48','m37_49','m37_50','m37_51','m37_52','m37_53','m37_54','m37_55','m37_72','m37_73','m37_74','m37_75','m38_146','m38_147','m38_148','m38_149','m38_150','m38_151','m38_152','m38_153','m38_154','m38_155','m38_45','m38_46','m38_47','m38_48','m38_49','m38_50','m38_51','m38_52','m38_53','m38_54','m38_55','m38_72','m38_73','m38_74','m39_147','m39_148','m39_149','m39_150','m39_151','m39_152','m39_153','m39_154','m39_155','m39_45','m39_46','m39_47','m39_48','m39_49','m39_50','m39_51','m39_52','m39_53','m39_54','m39_55','m39_72','m39_73','m39_74','m39_75','m39_76','m40_147','m40_148','m40_149','m40_150','m40_151','m40_152','m40_153','m40_154','m40_45','m40_46','m40_47','m40_48','m40_49','m40_50','m40_51','m40_52','m40_53','m40_54','m40_55','m40_72','m40_73','m40_74','m40_75','m40_76','m41_146','m41_149','m41_151','m41_152','m41_153','m41_154','m41_45','m41_46','m41_47','m41_48','m41_49','m41_50','m41_51','m41_52','m41_53','m41_54','m41_55','m41_56','m41_72','m41_73','m41_74','m41_75','m42_144','m42_145','m42_146','m42_151','m42_152','m42_153','m42_49','m42_50','m42_51','m42_52','m42_53','m42_54','m42_55','m42_56','m42_72','m42_73','m42_74','m42_75','m43_144','m43_145','m43_146','m43_153','m43_154','m43_45','m43_46','m43_47','m43_48','m43_49','m43_50','m43_51','m43_52','m43_53','m43_54','m43_55','m43_56','m43_72','m43_73','m43_74','m43_75','m44_144','m44_145','m44_146','m44_148','m44_149','m44_150','m44_151','m44_152','m44_153','m44_154','m44_155','m44_45','m44_46','m44_47','m44_48','m44_49','m44_50','m44_51','m44_52','m44_53','m44_54','m44_55','m44_72','m44_73','m44_74','m44_75','m45_145','m45_146','m45_148','m45_150','m45_151','m45_152','m45_153','m45_154','m45_155','m45_45','m45_46','m45_47','m45_48','m45_49','m45_50','m45_51','m45_52','m45_53','m45_54','m45_55','m45_56','m45_57','m45_58','m45_59','m45_60','m45_61','m45_62','m45_73','m45_74','m45_75','m45_76','m46_149','m46_150','m46_152','m46_153','m46_154','m46_161','m46_45','m46_46','m46_47','m46_48','m46_49','m46_50','m46_51','m46_52','m46_53','m46_54','m46_55','m46_56','m46_57','m46_58','m46_59','m46_60','m46_61','m46_62','m46_75','m47_148','m47_149','m47_150','m47_152','m47_153','m47_160','m47_161','m47_47','m47_48','m47_49','m47_50','m47_51','m47_52','m47_53','m47_54','m47_55','m47_56','m47_57','m47_58','m47_59','m47_60','m47_61','m47_62','m47_75','m48_148','m48_149','m48_152','m48_153','m48_154','m48_155','m48_156','m48_47','m48_48','m48_49','m48_50','m48_51','m48_52','m48_53','m48_54','m48_55','m48_56','m48_57','m48_58','m48_59','m48_60','m48_61','m48_62','m49_148','m49_149','m49_153','m49_154','m49_155','m49_156','m49_46','m49_47','m49_48','m49_49','m49_50','m49_51','m49_52','m49_53','m49_54','m49_55','m49_56','m49_57','m49_58','m49_59','m49_60','m49_61','m49_62','m50_149','m50_150','m50_152','m50_153','m50_154','m50_46','m50_47','m50_48','m50_49','m50_50','m50_51','m50_52','m50_53','m50_54','m50_55','m50_56','m50_57','m50_58','m50_59','m50_60','m50_61','m50_62','m51_147','m51_154','m51_46','m51_47','m51_48','m51_49','m51_50','m51_51','m51_52','m51_53','m51_54','m51_55','m51_56','m51_57','m51_58','m51_59','m51_60','m51_61','m51_62','m52_152','m52_153','m52_154','m52_46','m52_47','m52_48','m52_49','m52_50','m52_51','m52_52','m52_53','m52_54','m52_55','m52_56','m52_57','m52_58','m52_59','m52_60','m52_61','m52_62','m53_49','m53_50','m53_51','m53_52','m53_53'];for(let s=0;s<n.length;s++){const[i,a]=n[s].substring(1).split('_').map(Number),r=i<<6,o=a<<6;this.decodeNpcs(await E.load(`${e}n${i}_${a}`),r,o),this.decodeObjs(await E.load(`${e}o${i}_${a}`),r,o,t);const c=new Int8Array(16384);this.decodeLands(c,await E.load(`${e}m${i}_${a}`),r,o),this.decodeLocs(c,await E.load(`${e}l${i}_${a}`),r,o,t)}console.timeEnd('Loading game map')}changeLandCollision(t,e,n,s){he(t,e,n,s)}changeLocCollision(t,e,n,s,i,a,r,o,c,l){const h=Se(t);h===ze.WALL?ge(r,o,c,e,t,n,!1,l):h===ze.GROUND?e===Ge.NORTH||e===Ge.SOUTH?de(r,o,c,s,i,n,!1,l):de(r,o,c,i,s,n,!1,l):h===ze.GROUND_DECOR&&1===a&&he(r,o,c,l)}changeNpcCollision(t,e,n,s,i){pe(e,n,s,t,i)}changePlayerCollision(t,e,n,s,i){_e(e,n,s,t,i)}changeRoofCollision(t,e,n,s){ue(t,e,n,s)}decodeNpcs(t,e,n){for(;t.available>0;){const{x:s,z:i,level:a}=this.unpackCoord(t.g2()),r=e+s,o=n+i,c=t.g1();for(let e=0;e<c;e++){const e=pt.get(t.g2()),n=e.size,s=new Hc(a,r,o,n,n,Qn.RESPAWN,tl.getNextNid(),e.id,e.moverestrict,e.blockwalk);e.members&&tl.members?tl.addNpc(s,-1):e.members||tl.addNpc(s,-1)}}}decodeObjs(t,e,n,s){for(;t.available>0;){const{x:i,z:a,level:r}=this.unpackCoord(t.g2()),o=e+i,c=n+a,l=t.g1();for(let e=0;e<l;e++){const e=ut.get(t.g2()),n=new es(r,o,c,Qn.RESPAWN,e.id,t.g1());e.members&&tl.members?s.zone(n.x,n.z,n.level).addStaticObj(n):e.members||s.zone(n.x,n.z,n.level).addStaticObj(n)}}}decodeLands(t,e,n,s){for(let n=0;n<4;n++)for(let s=0;s<64;s++)for(let i=0;i<64;i++)for(;;){const a=e.g1();if(0===a)break;if(1===a){e.g1();break}a<=49?e.g1b():a<=81&&(t[this.packCoord(s,i,n)]=a-49)}this.applyLandCollision(n,s,t)}applyLandCollision(t,e,n){for(let s=0;s<4;s++)for(let i=0;i<64;i++){const a=i+t;for(let t=0;t<64;t++){const r=t+e;i%7==0&&t%7==0&&me(a,r,s);const o=n[this.packCoord(i,t,s)];if(4&o&&this.changeRoofCollision(a,r,s,!0),1&~o)continue;const c=2==(1===s?2&o:2&n[this.packCoord(i,t,1)])?s-1:s;c<0||this.changeLandCollision(a,r,c,!0)}}}decodeLocs(t,e,n,s,i){let a=-1,r=e.gsmart();for(;0!==r;){a+=r;let o=0,c=e.gsmart();for(;0!==c;){const{x:r,z:l,level:h}=this.unpackCoord(o+=c-1),d=e.g1();c=e.gsmart();const p=2==(1===h?2&t[o]:2&t[this.packCoord(r,l,1)])?h-1:h;if(p<0)continue;const _=et.get(a),u=_.width,g=_.length,m=d>>2,E=3&d,O=r+n,f=l+s;i.zone(O,f,p).addStaticLoc(new hs(p,O,f,u,g,Qn.RESPAWN,a,m,E)),_.blockwalk&&this.changeLocCollision(m,E,_.blockrange,g,u,_.active,O,f,p,!0)}r=e.gsmart()}}packCoord(t,e,n){return 63&e|(63&t)<<6|(3&n)<<12}unpackCoord(t){return{x:t>>6&63,z:63&t,level:t>>12&3}}}class Gc{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(t=[0,0,0,0]){for(let e=0;e<t.length;e++)this.rsl[e]=t[e];this.init()}init(){let t=2654435769,e=2654435769,n=2654435769,s=2654435769,i=2654435769,a=2654435769,r=2654435769,o=2654435769;for(let c=0;c<4;c++)t^=e<<11,s+=t,e+=n,e^=n>>>2,i+=e,n+=s,n^=s<<8,a+=n,s+=i,s^=i>>>16,r+=s,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,n+=o,t+=e;for(let c=0;c<256;c+=8)t+=this.rsl[c],e+=this.rsl[c+1],n+=this.rsl[c+2],s+=this.rsl[c+3],i+=this.rsl[c+4],a+=this.rsl[c+5],r+=this.rsl[c+6],o+=this.rsl[c+7],t^=e<<11,s+=t,e+=n,e^=n>>>2,i+=e,n+=s,n^=s<<8,a+=n,s+=i,s^=i>>>16,r+=s,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,n+=o,t+=e,this.mem[c]=t,this.mem[c+1]=e,this.mem[c+2]=n,this.mem[c+3]=s,this.mem[c+4]=i,this.mem[c+5]=a,this.mem[c+6]=r,this.mem[c+7]=o;for(let c=0;c<256;c+=8)t+=this.mem[c],e+=this.mem[c+1],n+=this.mem[c+2],s+=this.mem[c+3],i+=this.mem[c+4],a+=this.mem[c+5],r+=this.mem[c+6],o+=this.mem[c+7],t^=e<<11,s+=t,e+=n,e^=n>>>2,i+=e,n+=s,n^=s<<8,a+=n,s+=i,s^=i>>>16,r+=s,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,n+=o,t+=e,this.mem[c]=t,this.mem[c+1]=e,this.mem[c+2]=n,this.mem[c+3]=s,this.mem[c+4]=i,this.mem[c+5]=a,this.mem[c+6]=r,this.mem[c+7]=o;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let t=0;t<256;t++){const e=this.mem[t];switch(3&t){case 0:this.a^=this.a<<13;break;case 1:this.a^=this.a>>>6;break;case 2:this.a^=this.a<<2;break;case 3:this.a^=this.a>>>16}let n;this.a+=this.mem[t+128&255],this.mem[t]=n=this.mem[e>>>2&255]+this.a+this.b,this.rsl[t]=this.b=this.mem[n>>>8>>>2&255]+e}}nextInt(){return 0==this.count--&&(this.isaac(),this.count=255),this.rsl[this.count]}}class Wc{static loadFromFile(t){const e=d(h(t));let n;return n=fs.existsSync(`data/players/${e}.sav`)?E.load(`data/players/${e}.sav`):new E(new Uint8Array),Wc.load(t,n,null)}static load(t,e,n){const s=h(t),i=d(s),a=n?new vc(i,s,n):new Br(i,s);if(e.data.length<2){for(let t=0;t<21;t++)a.stats[t]=0,a.baseLevels[t]=1,a.levels[t]=1;return a.stats[sn.HITPOINTS]=Mr(10),a.baseLevels[sn.HITPOINTS]=10,a.levels[sn.HITPOINTS]=10,a}if(8196!==e.g2())throw new Error('Invalid player save');const r=e.g2();if(r>3)throw new Error('Unsupported player save format');e.pos=e.data.length-4;if(e.g4()!=E.getcrc(e.data,0,e.data.length-4))throw new Error('Player save corrupted');e.pos=4,a.x=e.g2(),a.z=e.g2(),a.level=e.g1();for(let t=0;t<7;t++)a.body[t]=e.g1(),255===a.body[t]&&(a.body[t]=-1);for(let t=0;t<5;t++)a.colors[t]=e.g1();a.gender=e.g1(),a.runenergy=e.g2(),a.playtime=r>=2?e.g4():e.g2();for(let t=0;t<21;t++)a.stats[t]=e.g4(),a.baseLevels[t]=Dr(a.stats[t]),a.levels[t]=e.g1();const o=e.g2();for(let t=0;t<o;t++)a.vars[t]=e.g4();const c=e.g1();for(let t=0;t<c;t++){const t=e.g2(),n=a.getInventory(t);if(n)for(let t=0;t<n.capacity;t++){const s=e.g2();if(0===s)continue;let i=e.g1();255===i&&(i=e.g4()),n.set(t,{id:s-1,count:i})}}if(r>=3){const t=e.g1();for(let n=0;n<t;n++)a.afkZones[n]=e.g4();a.lastAfkZone=e.g2()}return a.combatLevel=a.getCombatLevel(),a.lastResponse=tl.currentTick,Jn.LOCAL_DEV?a.staffModLevel=3:void 0!==Jn.JMODS.find((t=>t===i))&&(a.staffModLevel=2),a}}class zc{static SUCCESSFUL=Uint8Array.from([2]);static INVALID_USER_OR_PASS=Uint8Array.from([3]);static ACCOUNT_DISABLED=Uint8Array.from([4]);static LOGGED_IN=Uint8Array.from([5]);static SERVER_UPDATED=Uint8Array.from([6]);static WORLD_FULL=Uint8Array.from([7]);static LOGIN_SERVER_OFFLINE=Uint8Array.from([8]);static LOGIN_LIMIT_EXCEEDED=Uint8Array.from([9]);static UNABLE_TO_CONNECT=Uint8Array.from([10]);static LOGIN_REJECTED=Uint8Array.from([11]);static NEED_MEMBERS_ACCOUNT=Uint8Array.from([12]);static COULD_NOT_COMPLETE=Uint8Array.from([13]);static SERVER_UPDATING=Uint8Array.from([14]);static RECONNECTING=Uint8Array.from([15]);static LOGIN_ATTEMPTS_EXCEEDED=Uint8Array.from([16]);static STANDING_IN_MEMBERS=Uint8Array.from([17]);static STAFF_MOD_LEVEL=Uint8Array.from([18])}async function Vc(t){if(!(await fetch(t)).ok)return;const e=await E.load(t),n=E.getcrc(e.data,0,e.data.length);jc.push(n),Kc.p4(n)}function Yc(){jc=[],Kc.pos=0,Kc.p4(0),Vc('data/pack/client/title'),Vc('data/pack/client/config'),Vc('data/pack/client/interface'),Vc('data/pack/client/media'),Vc('data/pack/client/models'),Vc('data/pack/client/textures'),Vc('data/pack/client/wordenc'),Vc('data/pack/client/sounds'),Zc=E.getcrc(Kc.data,0,Kc.data.length)}var Kc=new E(new Uint8Array(36)),jc=[],Zc=0;(await fetch('data/pack/client/')).ok&&Yc();var Jc=new class{loginThread=function(t){const e=new Blob([t],{type:'application/javascript'}),n=URL.createObjectURL(e);return new Worker(n,{type:'module'})}("\n// src/jagex2/datastruct/Linkable.ts\nclass Linkable {\n  key;\n  next;\n  prev;\n  constructor() {\n    this.key = 0n;\n    this.next = this;\n    this.prev = this;\n  }\n  unlink() {\n    if (!this.prev || !this.next) {\n      return;\n    }\n    this.prev.next = this.next;\n    this.next.prev = this.prev;\n    this.next = null;\n    this.prev = null;\n  }\n}\n\n// src/jagex2/datastruct/LinkList.ts\nclass LinkList {\n  sentinel;\n  cursor = null;\n  constructor() {\n    const head = new Linkable;\n    head.next = head;\n    head.prev = head;\n    this.sentinel = head;\n  }\n  addTail(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel.prev;\n    node.next = this.sentinel;\n    if (node.prev) {\n      node.prev.next = node;\n    }\n    node.next.prev = node;\n  }\n  addHead(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel;\n    node.next = this.sentinel.next;\n    node.prev.next = node;\n    if (node.next) {\n      node.next.prev = node;\n    }\n  }\n  removeHead() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      return null;\n    }\n    node?.unlink();\n    return node;\n  }\n  head() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  tail() {\n    const node = this.sentinel.prev;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  next() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  prev() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  clear() {\n    while (true) {\n      const node = this.sentinel.next;\n      if (node === this.sentinel) {\n        return;\n      }\n      node?.unlink();\n    }\n  }\n}\n\n// src/jagex2/datastruct/Hashable.ts\nclass Hashable extends Linkable {\n  nextHashable;\n  prevHashable;\n  constructor() {\n    super();\n    this.nextHashable = this;\n    this.prevHashable = this;\n  }\n  uncache() {\n    if (!this.prevHashable || !this.nextHashable) {\n      return;\n    }\n    this.prevHashable.nextHashable = this.nextHashable;\n    this.nextHashable.prevHashable = this.prevHashable;\n    this.nextHashable = null;\n    this.prevHashable = null;\n  }\n}\n\n// src/jagex2/io/Packet.ts\nclass Packet extends Hashable {\n  static crctable = new Int32Array(256);\n  static bitmask = new Uint32Array(33);\n  static crc32b = 3988292384;\n  static {\n    for (let i = 0;i < 32; i++) {\n      this.bitmask[i] = (1 << i) - 1;\n    }\n    this.bitmask[32] = 4294967295;\n    for (let b = 0;b < 256; b++) {\n      let remainder = b;\n      for (let bit = 0;bit < 8; bit++) {\n        if ((remainder & 1) == 1) {\n          remainder = remainder >>> 1 ^ this.crc32b;\n        } else {\n          remainder >>>= 1;\n        }\n      }\n      this.crctable[b] = remainder;\n    }\n  }\n  static getcrc(src, offset, length) {\n    let crc = 4294967295;\n    for (let i = offset;i < length; i++) {\n      crc = crc >>> 8 ^ this.crctable[(crc ^ src[i]) & 255];\n    }\n    return ~crc;\n  }\n  static checkcrc(src, offset, length, expected = 0) {\n    const checksum = Packet.getcrc(src, offset, length);\n    return checksum == expected;\n  }\n  static alloc(type) {\n    let packet = null;\n    if (type === 0 && this.cacheMinCount > 0) {\n      packet = this.cacheMin.removeHead();\n      this.cacheMinCount--;\n    } else if (type === 1 && this.cacheMidCount > 0) {\n      packet = this.cacheMid.removeHead();\n      this.cacheMidCount--;\n    } else if (type === 2 && this.cacheMaxCount > 0) {\n      packet = this.cacheMax.removeHead();\n      this.cacheMaxCount--;\n    } else if (type === 3 && this.cacheBigCount > 0) {\n      packet = this.cacheBig.removeHead();\n      this.cacheBigCount--;\n    } else if (type === 4 && this.cacheHugeCount > 0) {\n      packet = this.cacheHuge.removeHead();\n      this.cacheHugeCount--;\n    } else if (type === 5 && this.cacheUnimaginableCount > 0) {\n      packet = this.cacheUnimaginable.removeHead();\n      this.cacheUnimaginableCount--;\n    }\n    if (packet !== null) {\n      packet.pos = 0;\n      packet.bitPos = 0;\n      return packet;\n    }\n    if (type === 0) {\n      return new Packet(new Uint8Array(100));\n    } else if (type === 1) {\n      return new Packet(new Uint8Array(5000));\n    } else if (type === 2) {\n      return new Packet(new Uint8Array(30000));\n    } else if (type === 3) {\n      return new Packet(new Uint8Array(1e5));\n    } else if (type === 4) {\n      return new Packet(new Uint8Array(500000));\n    } else if (type === 5) {\n      return new Packet(new Uint8Array(2000000));\n    } else {\n      return new Packet(new Uint8Array(type));\n    }\n  }\n  static async load(path, seekToEnd = false) {\n    const packet = new Packet(new Uint8Array(await (await fetch(path)).arrayBuffer()));\n    if (seekToEnd) {\n      packet.pos = packet.data.length;\n    }\n    return packet;\n  }\n  static cacheMinCount = 0;\n  static cacheMidCount = 0;\n  static cacheMaxCount = 0;\n  static cacheBigCount = 0;\n  static cacheHugeCount = 0;\n  static cacheUnimaginableCount = 0;\n  static cacheMin = new LinkList;\n  static cacheMid = new LinkList;\n  static cacheMax = new LinkList;\n  static cacheBig = new LinkList;\n  static cacheHuge = new LinkList;\n  static cacheUnimaginable = new LinkList;\n  data;\n  #view;\n  pos;\n  bitPos;\n  constructor(src) {\n    super();\n    this.data = src;\n    this.#view = new DataView(this.data.buffer);\n    this.pos = 0;\n    this.bitPos = 0;\n  }\n  get available() {\n    return this.data.length - this.pos;\n  }\n  get length() {\n    return this.data.length;\n  }\n  release() {\n    this.pos = 0;\n    this.bitPos = 0;\n    if (this.data.length === 100 && Packet.cacheMinCount < 1000) {\n      Packet.cacheMin.addTail(this);\n      Packet.cacheMinCount++;\n    } else if (this.data.length === 5000 && Packet.cacheMidCount < 250) {\n      Packet.cacheMid.addTail(this);\n      Packet.cacheMidCount++;\n    } else if (this.data.length === 30000 && Packet.cacheMaxCount < 50) {\n      Packet.cacheMax.addTail(this);\n      Packet.cacheMaxCount++;\n    } else if (this.data.length === 1e5 && Packet.cacheBigCount < 10) {\n      Packet.cacheBig.addTail(this);\n      Packet.cacheBigCount++;\n    } else if (this.data.length === 500000 && Packet.cacheHugeCount < 5) {\n      Packet.cacheHuge.addTail(this);\n      Packet.cacheHugeCount++;\n    } else if (this.data.length === 2000000 && Packet.cacheUnimaginableCount < 2) {\n      Packet.cacheUnimaginable.addTail(this);\n      Packet.cacheUnimaginableCount++;\n    }\n  }\n  p1(value) {\n    this.#view.setUint8(this.pos++, value);\n  }\n  p2(value) {\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  ip2(value) {\n    this.#view.setUint16(this.pos, value, true);\n    this.pos += 2;\n  }\n  p3(value) {\n    this.#view.setUint8(this.pos++, value >> 16);\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  p4(value) {\n    this.#view.setInt32(this.pos, value);\n    this.pos += 4;\n  }\n  ip4(value) {\n    this.#view.setInt32(this.pos, value, true);\n    this.pos += 4;\n  }\n  p8(value) {\n    this.#view.setBigInt64(this.pos, value);\n    this.pos += 8;\n  }\n  pbool(value) {\n    this.p1(value ? 1 : 0);\n  }\n  pjstr(str, terminator = 10) {\n    const length = str.length;\n    for (let i = 0;i < length; i++) {\n      this.#view.setUint8(this.pos++, str.charCodeAt(i));\n    }\n    this.#view.setUint8(this.pos++, terminator);\n  }\n  pdata(src, offset, length) {\n    this.data.set(src.subarray(offset, offset + length), this.pos);\n    this.pos += length - offset;\n  }\n  psize4(size) {\n    this.#view.setUint32(this.pos - size - 4, size);\n  }\n  psize2(size) {\n    this.#view.setUint16(this.pos - size - 2, size);\n  }\n  psize1(size) {\n    this.#view.setUint8(this.pos - size - 1, size);\n  }\n  psmarts(value) {\n    if (value < 64 && value >= 64) {\n      this.p1(value + 64);\n    } else if (value < 16384 && value >= -16384) {\n      this.p2(value + 49152);\n    } else {\n      throw new Error(\"Error psmarts out of range: \" + value);\n    }\n  }\n  psmart(value) {\n    if (value >= 0 && value < 128) {\n      this.p1(value);\n    } else if (value >= 0 && value < 32768) {\n      this.p2(value + 32768);\n    } else {\n      throw new Error(\"Error psmart out of range: \" + value);\n    }\n  }\n  g1() {\n    return this.#view.getUint8(this.pos++);\n  }\n  g1b() {\n    return this.#view.getInt8(this.pos++);\n  }\n  g2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2);\n  }\n  g2s() {\n    this.pos += 2;\n    return this.#view.getInt16(this.pos - 2);\n  }\n  ig2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2, true);\n  }\n  g3() {\n    const result = this.#view.getUint8(this.pos++) << 16 | this.#view.getUint16(this.pos);\n    this.pos += 2;\n    return result;\n  }\n  g4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4);\n  }\n  ig4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4, true);\n  }\n  g8() {\n    this.pos += 8;\n    return this.#view.getBigInt64(this.pos - 8);\n  }\n  gbool() {\n    return this.g1() === 1;\n  }\n  gjstr(terminator = 10) {\n    const length = this.data.length;\n    let str = \"\";\n    let b;\n    while ((b = this.#view.getUint8(this.pos++)) !== terminator && this.pos < length) {\n      str += String.fromCharCode(b);\n    }\n    return str;\n  }\n  gdata(dest, offset, length) {\n    dest.set(this.data.subarray(this.pos, this.pos + length), offset);\n    this.pos += length;\n  }\n  gsmarts() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() - 64 : this.g2() - 49152;\n  }\n  gsmart() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() : this.g2() - 32768;\n  }\n  bits() {\n    this.bitPos = this.pos << 3;\n  }\n  bytes() {\n    this.pos = this.bitPos + 7 >>> 3;\n  }\n  gBit(n) {\n    let bytePos = this.bitPos >>> 3;\n    let remaining = 8 - (this.bitPos & 7);\n    let value = 0;\n    this.bitPos += n;\n    for (;n > remaining; remaining = 8) {\n      value += (this.#view.getUint8(bytePos++) & Packet.bitmask[remaining]) << n - remaining;\n      n -= remaining;\n    }\n    if (n == remaining) {\n      value += this.#view.getUint8(bytePos) & Packet.bitmask[remaining];\n    } else {\n      value += this.#view.getUint8(bytePos) >>> remaining - n & Packet.bitmask[n];\n    }\n    return value;\n  }\n  pBit(n, value) {\n    const pos = this.bitPos;\n    this.bitPos += n;\n    let bytePos = pos >>> 3;\n    let remaining = 8 - (pos & 7);\n    const view = this.#view;\n    for (;n > remaining; remaining = 8) {\n      const shift2 = (1 << remaining) - 1;\n      const byte2 = view.getUint8(bytePos);\n      view.setUint8(bytePos++, byte2 & ~shift2 | value >>> n - remaining & shift2);\n      n -= remaining;\n    }\n    const r = remaining - n;\n    const shift = (1 << n) - 1;\n    const byte = view.getUint8(bytePos);\n    view.setUint8(bytePos, byte & ~shift << r | (value & shift) << r);\n  }\n}\n\n// src/jagex2/jstring/JString.ts\nfunction toBase37(string) {\n  string = string.trim();\n  let l = 0n;\n  for (let i = 0;i < string.length && i < 12; i++) {\n    const c = string.charCodeAt(i);\n    l *= 37n;\n    if (c >= 65 && c <= 90) {\n      l += BigInt(c + 1 - 65);\n    } else if (c >= 97 && c <= 122) {\n      l += BigInt(c + 1 - 97);\n    } else if (c >= 48 && c <= 57) {\n      l += BigInt(c + 27 - 48);\n    }\n  }\n  return l;\n}\nfunction fromBase37(value) {\n  if (value < 0n || value >= 6582952005840035281n) {\n    return \"invalid_name\";\n  }\n  if (value % 37n === 0n) {\n    return \"invalid_name\";\n  }\n  let len = 0;\n  const chars = Array(12);\n  while (value !== 0n) {\n    const l1 = value;\n    value /= 37n;\n    chars[11 - len++] = BASE37_LOOKUP[Number(l1 - value * 37n)];\n  }\n  return chars.slice(12 - len).join(\"\");\n}\nfunction toSafeName(name) {\n  return fromBase37(toBase37(name));\n}\nvar BASE37_LOOKUP = [\n  \"_\",\n  \"a\",\n  \"b\",\n  \"c\",\n  \"d\",\n  \"e\",\n  \"f\",\n  \"g\",\n  \"h\",\n  \"i\",\n  \"j\",\n  \"k\",\n  \"l\",\n  \"m\",\n  \"n\",\n  \"o\",\n  \"p\",\n  \"q\",\n  \"r\",\n  \"s\",\n  \"t\",\n  \"u\",\n  \"v\",\n  \"w\",\n  \"x\",\n  \"y\",\n  \"z\",\n  \"0\",\n  \"1\",\n  \"2\",\n  \"3\",\n  \"4\",\n  \"5\",\n  \"6\",\n  \"7\",\n  \"8\",\n  \"9\"\n];\n\n// src/lostcity/server/NetworkStream.ts\nclass NetworkStream {\n  queue = [];\n  available = 0;\n  buffer = null;\n  offset = 0;\n  waiting = 0;\n  received(buf) {\n    this.queue.push(buf);\n    this.available += buf.length;\n  }\n  clear() {\n    this.queue = [];\n    this.available = 0;\n    this.buffer = null;\n    this.offset = 0;\n  }\n  async readByte(socket) {\n    if (socket === null) {\n      return 0;\n    }\n    if (this.available < 1) {\n      await new Promise((res) => setTimeout(res, 10));\n      return this.readByte(socket);\n    }\n    if (this.buffer === null) {\n      this.buffer = this.queue.shift() ?? null;\n      this.offset = 0;\n    }\n    const value = this.buffer?.[this.offset] ?? 0;\n    this.offset++;\n    this.available--;\n    if (this.buffer && this.offset === this.buffer.length) {\n      this.buffer = null;\n    }\n    return value;\n  }\n  async readBytes(socket, destination, offset, length, full = true) {\n    if (socket === null) {\n      return 0;\n    }\n    if (this.available < length) {\n      if (full) {\n        await new Promise((res) => setTimeout(res, 10));\n        return this.readBytes(socket, destination, offset, length);\n      } else {\n        length = this.available;\n      }\n    }\n    destination.pos = offset;\n    for (let i = 0;i < length; i++) {\n      if (this.buffer === null) {\n        this.buffer = this.queue.shift() ?? null;\n        this.offset = 0;\n      }\n      destination.data[offset + i] = this.buffer?.[this.offset] ?? 0;\n      this.offset++;\n      this.available--;\n      if (this.buffer && this.offset === this.buffer.length) {\n        this.buffer = null;\n      }\n    }\n    return length;\n  }\n}\n\n// src/lostcity/util/Environment.ts\nvar Environment_default = {\n  PUBLIC_IP: \"localhost\",\n  WEB_PORT: 80,\n  GAME_PORT: 43594,\n  LOGIN_HOST: \"localhost\",\n  LOGIN_PORT: 43500,\n  LOGIN_KEY: \"\",\n  FRIEND_HOST: \"localhost\",\n  FRIEND_PORT: 43501,\n  FRIEND_KEY: \"\",\n  WORLD_ID: 0,\n  LOCAL_DEV: true,\n  MEMBERS_WORLD: true,\n  XP_MULTIPLIER: 1,\n  SHUTDOWN_TIMER: 50,\n  HTTPS_ENABLED: false,\n  ADDRESS_SHOWPORT: true,\n  CLIRUNNER: false,\n  CI_MODE: false,\n  SKIP_CORS: false,\n  DB_HOST: \"\",\n  DB_USER: \"\",\n  DB_PASS: \"\",\n  DB_NAME: \"\",\n  ADMIN_IP: \"localhost\",\n  SKIP_CRC: false,\n  JAVA_PATH: \"java\",\n  DATA_SRC_DIR: \"data/src\",\n  VALIDATE_PACK: true,\n  STRICT_FOLDERS: true,\n  BUILD_ON_STARTUP: true,\n  UPDATE_ON_STARTUP: true,\n  JMODS: [\"pazaz\"],\n  CLIENT_PATHFINDER: true,\n  NO_SOCKET_TIMEOUT: false,\n  PROFILE_SCRIPTS: false\n};\n\n// src/lostcity/server/LoginServer.ts\nclass LoginResponse {\n  static SUCCESSFUL = Uint8Array.from([2]);\n  static INVALID_USER_OR_PASS = Uint8Array.from([3]);\n  static ACCOUNT_DISABLED = Uint8Array.from([4]);\n  static LOGGED_IN = Uint8Array.from([5]);\n  static SERVER_UPDATED = Uint8Array.from([6]);\n  static WORLD_FULL = Uint8Array.from([7]);\n  static LOGIN_SERVER_OFFLINE = Uint8Array.from([8]);\n  static LOGIN_LIMIT_EXCEEDED = Uint8Array.from([9]);\n  static UNABLE_TO_CONNECT = Uint8Array.from([10]);\n  static LOGIN_REJECTED = Uint8Array.from([11]);\n  static NEED_MEMBERS_ACCOUNT = Uint8Array.from([12]);\n  static COULD_NOT_COMPLETE = Uint8Array.from([13]);\n  static SERVER_UPDATING = Uint8Array.from([14]);\n  static RECONNECTING = Uint8Array.from([15]);\n  static LOGIN_ATTEMPTS_EXCEEDED = Uint8Array.from([16]);\n  static STANDING_IN_MEMBERS = Uint8Array.from([17]);\n  static STAFF_MOD_LEVEL = Uint8Array.from([18]);\n}\nclass LoginClient {\n  socket = null;\n  stream = new NetworkStream;\n  async connect() {\n    if (this.socket) {\n      return;\n    }\n    return new Promise((res) => {\n      this.socket = net.createConnection({\n        port: Environment_default.LOGIN_PORT,\n        host: Environment_default.LOGIN_HOST\n      });\n      this.socket.setNoDelay(true);\n      this.socket.setTimeout(1000);\n      this.socket.on(\"data\", async (buf) => {\n        this.stream.received(buf);\n      });\n      this.socket.once(\"close\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"error\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"connect\", () => {\n        res();\n      });\n    });\n  }\n  disconnect() {\n    if (this.socket === null) {\n      return;\n    }\n    this.socket.destroy();\n    this.socket = null;\n    this.stream.clear();\n  }\n  async write(socket, opcode, data = null, full = true) {\n    if (socket === null) {\n      return;\n    }\n    const packet = new Packet(new Uint8Array(1 + 2 + (data !== null ? data?.length : 0)));\n    packet.p1(opcode);\n    if (data !== null) {\n      packet.p2(data.length);\n      packet.pdata(data, 0, data.length);\n    } else {\n      packet.p2(0);\n    }\n    const done = socket.write(packet.data);\n    if (!done && full) {\n      await new Promise((res) => {\n        const interval = setInterval(() => {\n          if (socket === null || socket.closed) {\n            clearInterval(interval);\n            res();\n          }\n        }, 100);\n        socket.once(\"drain\", () => {\n          clearInterval(interval);\n          res();\n        });\n      });\n    }\n  }\n  async load(username37, password, uid) {\n    await this.connect();\n    if (this.socket === null) {\n      return { reply: -1, data: null };\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + password.length + 1 + 4));\n    request.p2(Environment_default.WORLD_ID);\n    request.p8(username37);\n    request.pjstr(password);\n    request.p4(uid);\n    await this.write(this.socket, 1, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    if (reply !== 1) {\n      this.disconnect();\n      return { reply, data: null };\n    }\n    const data = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, data, 0, 2);\n    const length = data.g2();\n    const data2 = new Packet(new Uint8Array(length));\n    await this.stream.readBytes(this.socket, data2, 0, length);\n    this.disconnect();\n    return { reply, data: data2 };\n  }\n  async save(username37, save) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + 2 + save.length));\n    request.p2(Environment_default.WORLD_ID);\n    request.p8(username37);\n    request.p2(save.length);\n    request.pdata(save, 0, save.length);\n    await this.write(this.socket, 2, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    this.disconnect();\n    return reply;\n  }\n  async reset() {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(Environment_default.WORLD_ID);\n    await this.write(this.socket, 3, request.data);\n    this.disconnect();\n  }\n  async count(world) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(world);\n    await this.write(this.socket, 4, request.data);\n    const reply = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, reply, 0, 2);\n    const count = reply.g2();\n    this.disconnect();\n    return count;\n  }\n  async heartbeat(players) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 2 + players.length * 8));\n    request.p2(Environment_default.WORLD_ID);\n    request.p2(players.length);\n    for (const player of players) {\n      request.p8(player);\n    }\n    await this.write(this.socket, 5, request.data);\n    this.disconnect();\n  }\n}\n\n// src/lostcity/server/LoginThread.ts\nself.onmessage = async (msg) => {\n  try {\n    switch (msg.data.type) {\n      case \"reset\": {\n        break;\n      }\n      case \"heartbeat\": {\n        break;\n      }\n      case \"loginreq\": {\n        const { opcode, data, socket } = msg.data;\n        const stream = new Packet(data);\n        const revision = stream.g1();\n        if (revision !== 225) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.SERVER_UPDATED,\n            socket\n          });\n          return;\n        }\n        const info = stream.g1();\n        const crcs = new Uint8Array(9 * 4);\n        stream.gdata(crcs, 0, crcs.length);\n        const enc = new Uint8Array(stream.g1());\n        stream.gdata(enc, 0, enc.length);\n        stream.pos = 0;\n        stream.pdata(enc, 0, enc.length);\n        stream.pos = 0;\n        if (stream.g1() !== 10) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.LOGIN_REJECTED,\n            socket\n          });\n          return;\n        }\n        const seed = [];\n        for (let i = 0;i < 4; i++) {\n          seed[i] = stream.g4();\n        }\n        const uid = stream.g4();\n        const username = stream.gjstr();\n        const password = stream.gjstr();\n        if (username.length < 1 || username.length > 12) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.INVALID_USER_OR_PASS,\n            socket\n          });\n          return;\n        }\n        const save = new Uint8Array;\n        self.postMessage({\n          type: \"loginreply\",\n          status: LoginResponse.SUCCESSFUL,\n          socket,\n          info,\n          seed,\n          username: toSafeName(username),\n          save\n        });\n        break;\n      }\n      case \"logout\": {\n        const { username, save } = msg.data;\n        if (Environment_default.LOGIN_KEY) {\n          const login = new LoginClient;\n          const reply = await login.save(toBase37(username), save);\n          if (reply === 0) {\n            self.postMessage({\n              type: \"logoutreply\",\n              username\n            });\n          }\n        } else {\n          self.postMessage({\n            type: \"logoutreply\",\n            username\n          });\n        }\n        break;\n      }\n      default:\n        console.error(\"Unknown message type: \" + msg.data.type);\n        break;\n    }\n  } catch (err) {\n    console.error(err);\n  }\n};\n");loginRequests=new Map;logoutRequests=new Set;constructor(){this.loginThread.onmessage=t=>{try{this.onMessage(t)}catch(t){console.error('Login Thread:',t)}}}async readIn(t,e){const n=e.g1();if(16===n){const s=e.g1();if(e.available<s)return void t.terminate();const i=new Uint8Array(s);e.gdata(i,0,i.length),e.pos-=i.length;if(225!==e.g1())return void t.writeImmediate(zc.SERVER_UPDATED);e.pos+=1;const a=new Uint8Array(36);if(e.gdata(a,0,a.length),!E.checkcrc(a,0,a.length,Zc))return void t.writeImmediate(zc.SERVER_UPDATED);this.loginThread.postMessage({type:'loginreq',opcode:n,data:i,socket:t.uniqueId}),this.loginRequests.set(t.uniqueId,t)}else t.terminate()}logout(t){this.logoutRequests.has(t.username37)||this.loginThread.postMessage({type:'logout',username:t.username})}onMessage(t){switch(t.data.type){case'loginreply':{const{status:e,socket:n}=t.data,s=this.loginRequests.get(n);if(!s)return;if(this.loginRequests.delete(n),2!==e[0])return s.writeImmediate(e),void s.close();const{info:i,seed:a,username:r,save:o}=t.data;if(tl.getTotalPlayers()>=2e3)return s.writeImmediate(zc.WORLD_FULL),void s.close();if(tl.shutdownTick>-1&&tl.currentTick-tl.shutdownTick>0)return s.writeImmediate(zc.SERVER_UPDATING),void s.close();if(Jn.LOCAL_DEV)for(const t of tl.players)if(t.username===r)return s.writeImmediate(zc.LOGGED_IN),void s.close();s.decryptor=new Gc(a);for(let t=0;t<4;t++)a[t]+=50;s.encryptor=new Gc(a);const c=Wc.load(r,new E(o),s);c.lowMemory=!!(1&i),tl.addPlayer(c);break}case'logoutreply':{const{username:e}=t.data,n=tl.getPlayerByUsername(e);n&&(tl.getZone(n.x,n.z,n.level).leave(n),tl.players.remove(n.pid),n.pid=-1,n.terminate(),this.logoutRequests.delete(n.username37));break}default:throw new Error('Unknown message type: '+t.data.type)}}};class $c{entities;free;indexPadding;ids;lastUsedIndex=0;constructor(t,e){this.entities=new Array(t).fill(null),this.ids=new Int32Array(t).fill(-1),this.free=new Set(Array.from({length:t},((t,e)=>e))),this.indexPadding=e}next(t=!1,e=this.lastUsedIndex+1){const n=this.ids.length;for(let t=e;t<n;t++)if(-1===this.ids[t])return t;for(let t=this.indexPadding;t<e;t++)if(-1===this.ids[t])return t;throw new Error('[EntityList] cannot find next id')}*[Symbol.iterator](){for(const t of this.ids){if(-1===t)continue;const e=this.entities[t];e&&(yield e)}}get count(){let t=0;for(const e of this[Symbol.iterator]())t++;return t}get(t){const e=this.ids[t];return-1!==e?this.entities[e]:null}set(t,e){if(!this.free.size)throw new Error('[EntityList] cannot find available entities slot.');const n=this.free.values().next().value;this.free.delete(n),this.ids[t]=n,this.entities[n]=e,this.lastUsedIndex=t}remove(t){const e=this.ids[t];-1!==e&&(this.entities[e]=null,this.ids[t]=-1,this.free.add(e))}reset(){this.entities.fill(null),this.ids.fill(-1),this.free.clear();for(let t=0;t<this.ids.length;t++)this.free.add(t)}}class Xc extends $c{constructor(t){super(t,0)}}class Qc extends $c{constructor(t){super(t,1)}next(t=!1,e=this.lastUsedIndex+1){if(t){for(let t=0===e?1:0;t<100;t++){const n=e+t;if(-1===this.ids[n])return n}}return super.next()}}class qc extends zs{ticks;priority=Vs.LOW;constructor(t){super(),this.ticks=t}}var tl=new class{id=Jn.WORLD_ID;members=Jn.MEMBERS_WORLD;currentTick=0;tickRate=600;shutdownTick=-1;allLastModified=0;datLastModified=new Map;lastCycleStats=[];lastCycleBandwidth=[0,0];gameMap=new Fc;zoneMap=new br;invs=[];vars=new Int32Array;varsString=[];newPlayers=[];players=new Qc(2048);npcs=new Xc(8192);zonesTracking=new Map;queue=new g;shouldReload(t,e=!1){return!0}async reload(){let t=!1;if(this.shouldReload('varp',!0)&&(ft.load('data/pack'),t=!0),this.shouldReload('param')&&_t.load('data/pack'),this.shouldReload('obj',!0)&&(ut.load('data/pack',this.members),t=!0),this.shouldReload('loc',!0)&&(et.load('data/pack'),t=!0),this.shouldReload('npc',!0)&&(pt.load('data/pack'),t=!0),this.shouldReload('idk',!0)&&(j.load('data/pack'),t=!0),this.shouldReload('frame_del')&&gt.load('data/pack'),this.shouldReload('seq',!0)&&(mt.load('data/pack'),t=!0),this.shouldReload('spotanim',!0)&&(St.load('data/pack'),t=!0),this.shouldReload('category')&&f.load('data/pack'),this.shouldReload('enum')&&N.load('data/pack'),this.shouldReload('struct')&&Et.load('data/pack'),this.shouldReload('inv')){J.load('data/pack');for(let t=0;t<J.count;t++){const e=J.get(t);e&&e.scope===J.SCOPE_SHARED&&(this.invs[t]=se.fromType(t))}}if(this.shouldReload('mesanim')&&nt.load('data/pack'),this.shouldReload('dbtable')&&T.load('data/pack'),this.shouldReload('dbrow')&&I.load('data/pack'),this.shouldReload('hunt')&&K.load('data/pack'),this.shouldReload('varn')&&Ot.load('data/pack'),this.shouldReload('vars')&&(At.load('data/pack'),this.vars.length!==At.count)){const t=this.vars;this.vars=new Int32Array(At.count);for(let e=0;e<At.count&&e<t.length;e++)this.vars[e]=t[e];const e=this.varsString;this.varsString=new Array(At.count);for(let n=0;n<At.count&&n<t.length;n++)this.varsString[n]=e[n]}if(this.shouldReload('interface')&&(Z.load('data/pack'),t=!0),this.shouldReload('script')){const t=await Xt.load('data/pack');-1===t?this.broadcastMes('There was an issue while reloading scripts.'):this.broadcastMes(`Reloaded ${t} scripts.`)}Yc(),async function(){const t=['l29_75','l30_75','l31_75','l32_70','l32_71','l32_72','l32_73','l32_74','l32_75','l33_70','l33_71','l33_72','l33_73','l33_74','l33_75','l33_76','l34_70','l34_71','l34_72','l34_73','l34_74','l34_75','l34_76','l35_20','l35_75','l35_76','l36_146','l36_147','l36_148','l36_149','l36_150','l36_153','l36_154','l36_52','l36_53','l36_54','l36_72','l36_73','l36_74','l36_75','l36_76','l37_146','l37_147','l37_148','l37_149','l37_150','l37_151','l37_152','l37_153','l37_154','l37_48','l37_49','l37_50','l37_51','l37_52','l37_53','l37_54','l37_55','l37_72','l37_73','l37_74','l37_75','l38_146','l38_147','l38_148','l38_149','l38_150','l38_151','l38_152','l38_153','l38_154','l38_155','l38_45','l38_46','l38_47','l38_48','l38_49','l38_50','l38_51','l38_52','l38_53','l38_54','l38_55','l38_72','l38_73','l38_74','l39_147','l39_148','l39_149','l39_150','l39_151','l39_152','l39_153','l39_154','l39_155','l39_45','l39_46','l39_47','l39_48','l39_49','l39_50','l39_51','l39_52','l39_53','l39_54','l39_55','l39_72','l39_73','l39_74','l39_75','l39_76','l40_147','l40_148','l40_149','l40_150','l40_151','l40_152','l40_153','l40_154','l40_45','l40_46','l40_47','l40_48','l40_49','l40_50','l40_51','l40_52','l40_53','l40_54','l40_55','l40_72','l40_73','l40_74','l40_75','l40_76','l41_146','l41_149','l41_151','l41_152','l41_153','l41_154','l41_45','l41_46','l41_47','l41_48','l41_49','l41_50','l41_51','l41_52','l41_53','l41_54','l41_55','l41_56','l41_72','l41_73','l41_74','l41_75','l42_144','l42_145','l42_146','l42_151','l42_152','l42_153','l42_49','l42_50','l42_51','l42_52','l42_53','l42_54','l42_55','l42_56','l42_72','l42_73','l42_74','l42_75','l43_144','l43_145','l43_146','l43_153','l43_154','l43_45','l43_46','l43_47','l43_48','l43_49','l43_50','l43_51','l43_52','l43_53','l43_54','l43_55','l43_56','l43_72','l43_73','l43_74','l43_75','l44_144','l44_145','l44_146','l44_148','l44_149','l44_150','l44_151','l44_152','l44_153','l44_154','l44_155','l44_45','l44_46','l44_47','l44_48','l44_49','l44_50','l44_51','l44_52','l44_53','l44_54','l44_55','l44_72','l44_73','l44_74','l44_75','l45_145','l45_146','l45_148','l45_150','l45_151','l45_152','l45_153','l45_154','l45_155','l45_45','l45_46','l45_47','l45_48','l45_49','l45_50','l45_51','l45_52','l45_53','l45_54','l45_55','l45_56','l45_57','l45_58','l45_59','l45_60','l45_61','l45_62','l45_73','l45_74','l45_75','l45_76','l46_149','l46_150','l46_152','l46_153','l46_154','l46_161','l46_45','l46_46','l46_47','l46_48','l46_49','l46_50','l46_51','l46_52','l46_53','l46_54','l46_55','l46_56','l46_57','l46_58','l46_59','l46_60','l46_61','l46_62','l46_75','l47_148','l47_149','l47_150','l47_152','l47_153','l47_160','l47_161','l47_47','l47_48','l47_49','l47_50','l47_51','l47_52','l47_53','l47_54','l47_55','l47_56','l47_57','l47_58','l47_59','l47_60','l47_61','l47_62','l47_75','l48_148','l48_149','l48_152','l48_153','l48_154','l48_155','l48_156','l48_47','l48_48','l48_49','l48_50','l48_51','l48_52','l48_53','l48_54','l48_55','l48_56','l48_57','l48_58','l48_59','l48_60','l48_61','l48_62','l49_148','l49_149','l49_153','l49_154','l49_155','l49_156','l49_46','l49_47','l49_48','l49_49','l49_50','l49_51','l49_52','l49_53','l49_54','l49_55','l49_56','l49_57','l49_58','l49_59','l49_60','l49_61','l49_62','l50_149','l50_150','l50_152','l50_153','l50_154','l50_46','l50_47','l50_48','l50_49','l50_50','l50_51','l50_52','l50_53','l50_54','l50_55','l50_56','l50_57','l50_58','l50_59','l50_60','l50_61','l50_62','l51_147','l51_154','l51_46','l51_47','l51_48','l51_49','l51_50','l51_51','l51_52','l51_53','l51_54','l51_55','l51_56','l51_57','l51_58','l51_59','l51_60','l51_61','l51_62','l52_152','l52_153','l52_154','l52_46','l52_47','l52_48','l52_49','l52_50','l52_51','l52_52','l52_53','l52_54','l52_55','l52_56','l52_57','l52_58','l52_59','l52_60','l52_61','l52_62','l53_49','l53_50','l53_51','l53_52','l53_53','m29_75','m30_75','m31_75','m32_70','m32_71','m32_72','m32_73','m32_74','m32_75','m33_70','m33_71','m33_72','m33_73','m33_74','m33_75','m33_76','m34_70','m34_71','m34_72','m34_73','m34_74','m34_75','m34_76','m35_20','m35_75','m35_76','m36_146','m36_147','m36_148','m36_149','m36_150','m36_153','m36_154','m36_52','m36_53','m36_54','m36_72','m36_73','m36_74','m36_75','m36_76','m37_146','m37_147','m37_148','m37_149','m37_150','m37_151','m37_152','m37_153','m37_154','m37_48','m37_49','m37_50','m37_51','m37_52','m37_53','m37_54','m37_55','m37_72','m37_73','m37_74','m37_75','m38_146','m38_147','m38_148','m38_149','m38_150','m38_151','m38_152','m38_153','m38_154','m38_155','m38_45','m38_46','m38_47','m38_48','m38_49','m38_50','m38_51','m38_52','m38_53','m38_54','m38_55','m38_72','m38_73','m38_74','m39_147','m39_148','m39_149','m39_150','m39_151','m39_152','m39_153','m39_154','m39_155','m39_45','m39_46','m39_47','m39_48','m39_49','m39_50','m39_51','m39_52','m39_53','m39_54','m39_55','m39_72','m39_73','m39_74','m39_75','m39_76','m40_147','m40_148','m40_149','m40_150','m40_151','m40_152','m40_153','m40_154','m40_45','m40_46','m40_47','m40_48','m40_49','m40_50','m40_51','m40_52','m40_53','m40_54','m40_55','m40_72','m40_73','m40_74','m40_75','m40_76','m41_146','m41_149','m41_151','m41_152','m41_153','m41_154','m41_45','m41_46','m41_47','m41_48','m41_49','m41_50','m41_51','m41_52','m41_53','m41_54','m41_55','m41_56','m41_72','m41_73','m41_74','m41_75','m42_144','m42_145','m42_146','m42_151','m42_152','m42_153','m42_49','m42_50','m42_51','m42_52','m42_53','m42_54','m42_55','m42_56','m42_72','m42_73','m42_74','m42_75','m43_144','m43_145','m43_146','m43_153','m43_154','m43_45','m43_46','m43_47','m43_48','m43_49','m43_50','m43_51','m43_52','m43_53','m43_54','m43_55','m43_56','m43_72','m43_73','m43_74','m43_75','m44_144','m44_145','m44_146','m44_148','m44_149','m44_150','m44_151','m44_152','m44_153','m44_154','m44_155','m44_45','m44_46','m44_47','m44_48','m44_49','m44_50','m44_51','m44_52','m44_53','m44_54','m44_55','m44_72','m44_73','m44_74','m44_75','m45_145','m45_146','m45_148','m45_150','m45_151','m45_152','m45_153','m45_154','m45_155','m45_45','m45_46','m45_47','m45_48','m45_49','m45_50','m45_51','m45_52','m45_53','m45_54','m45_55','m45_56','m45_57','m45_58','m45_59','m45_60','m45_61','m45_62','m45_73','m45_74','m45_75','m45_76','m46_149','m46_150','m46_152','m46_153','m46_154','m46_161','m46_45','m46_46','m46_47','m46_48','m46_49','m46_50','m46_51','m46_52','m46_53','m46_54','m46_55','m46_56','m46_57','m46_58','m46_59','m46_60','m46_61','m46_62','m46_75','m47_148','m47_149','m47_150','m47_152','m47_153','m47_160','m47_161','m47_47','m47_48','m47_49','m47_50','m47_51','m47_52','m47_53','m47_54','m47_55','m47_56','m47_57','m47_58','m47_59','m47_60','m47_61','m47_62','m47_75','m48_148','m48_149','m48_152','m48_153','m48_154','m48_155','m48_156','m48_47','m48_48','m48_49','m48_50','m48_51','m48_52','m48_53','m48_54','m48_55','m48_56','m48_57','m48_58','m48_59','m48_60','m48_61','m48_62','m49_148','m49_149','m49_153','m49_154','m49_155','m49_156','m49_46','m49_47','m49_48','m49_49','m49_50','m49_51','m49_52','m49_53','m49_54','m49_55','m49_56','m49_57','m49_58','m49_59','m49_60','m49_61','m49_62','m50_149','m50_150','m50_152','m50_153','m50_154','m50_46','m50_47','m50_48','m50_49','m50_50','m50_51','m50_52','m50_53','m50_54','m50_55','m50_56','m50_57','m50_58','m50_59','m50_60','m50_61','m50_62','m51_147','m51_154','m51_46','m51_47','m51_48','m51_49','m51_50','m51_51','m51_52','m51_53','m51_54','m51_55','m51_56','m51_57','m51_58','m51_59','m51_60','m51_61','m51_62','m52_152','m52_153','m52_154','m52_46','m52_47','m52_48','m52_49','m52_50','m52_51','m52_52','m52_53','m52_54','m52_55','m52_56','m52_57','m52_58','m52_59','m52_60','m52_61','m52_62','m53_49','m53_50','m53_51','m53_52','m53_53','n29_75','n30_75','n31_75','n32_70','n32_71','n32_72','n32_73','n32_74','n32_75','n33_70','n33_71','n33_72','n33_73','n33_74','n33_75','n33_76','n34_70','n34_71','n34_72','n34_73','n34_74','n34_75','n34_76','n35_20','n35_75','n35_76','n36_146','n36_147','n36_148','n36_149','n36_150','n36_153','n36_154','n36_52','n36_53','n36_54','n36_72','n36_73','n36_74','n36_75','n36_76','n37_146','n37_147','n37_148','n37_149','n37_150','n37_151','n37_152','n37_153','n37_154','n37_48','n37_49','n37_50','n37_51','n37_52','n37_53','n37_54','n37_55','n37_72','n37_73','n37_74','n37_75','n38_146','n38_147','n38_148','n38_149','n38_150','n38_151','n38_152','n38_153','n38_154','n38_155','n38_45','n38_46','n38_47','n38_48','n38_49','n38_50','n38_51','n38_52','n38_53','n38_54','n38_55','n38_72','n38_73','n38_74','n39_147','n39_148','n39_149','n39_150','n39_151','n39_152','n39_153','n39_154','n39_155','n39_45','n39_46','n39_47','n39_48','n39_49','n39_50','n39_51','n39_52','n39_53','n39_54','n39_55','n39_72','n39_73','n39_74','n39_75','n39_76','n40_147','n40_148','n40_149','n40_150','n40_151','n40_152','n40_153','n40_154','n40_45','n40_46','n40_47','n40_48','n40_49','n40_50','n40_51','n40_52','n40_53','n40_54','n40_55','n40_72','n40_73','n40_74','n40_75','n40_76','n41_146','n41_149','n41_151','n41_152','n41_153','n41_154','n41_45','n41_46','n41_47','n41_48','n41_49','n41_50','n41_51','n41_52','n41_53','n41_54','n41_55','n41_56','n41_72','n41_73','n41_74','n41_75','n42_144','n42_145','n42_146','n42_151','n42_152','n42_153','n42_49','n42_50','n42_51','n42_52','n42_53','n42_54','n42_55','n42_56','n42_72','n42_73','n42_74','n42_75','n43_144','n43_145','n43_146','n43_153','n43_154','n43_45','n43_46','n43_47','n43_48','n43_49','n43_50','n43_51','n43_52','n43_53','n43_54','n43_55','n43_56','n43_72','n43_73','n43_74','n43_75','n44_144','n44_145','n44_146','n44_148','n44_149','n44_150','n44_151','n44_152','n44_153','n44_154','n44_155','n44_45','n44_46','n44_47','n44_48','n44_49','n44_50','n44_51','n44_52','n44_53','n44_54','n44_55','n44_72','n44_73','n44_74','n44_75','n45_145','n45_146','n45_148','n45_150','n45_151','n45_152','n45_153','n45_154','n45_155','n45_45','n45_46','n45_47','n45_48','n45_49','n45_50','n45_51','n45_52','n45_53','n45_54','n45_55','n45_56','n45_57','n45_58','n45_59','n45_60','n45_61','n45_62','n45_73','n45_74','n45_75','n45_76','n46_149','n46_150','n46_152','n46_153','n46_154','n46_161','n46_45','n46_46','n46_47','n46_48','n46_49','n46_50','n46_51','n46_52','n46_53','n46_54','n46_55','n46_56','n46_57','n46_58','n46_59','n46_60','n46_61','n46_62','n46_75','n47_148','n47_149','n47_150','n47_152','n47_153','n47_160','n47_161','n47_47','n47_48','n47_49','n47_50','n47_51','n47_52','n47_53','n47_54','n47_55','n47_56','n47_57','n47_58','n47_59','n47_60','n47_61','n47_62','n47_75','n48_148','n48_149','n48_152','n48_153','n48_154','n48_155','n48_156','n48_47','n48_48','n48_49','n48_50','n48_51','n48_52','n48_53','n48_54','n48_55','n48_56','n48_57','n48_58','n48_59','n48_60','n48_61','n48_62','n49_148','n49_149','n49_153','n49_154','n49_155','n49_156','n49_46','n49_47','n49_48','n49_49','n49_50','n49_51','n49_52','n49_53','n49_54','n49_55','n49_56','n49_57','n49_58','n49_59','n49_60','n49_61','n49_62','n50_149','n50_150','n50_152','n50_153','n50_154','n50_46','n50_47','n50_48','n50_49','n50_50','n50_51','n50_52','n50_53','n50_54','n50_55','n50_56','n50_57','n50_58','n50_59','n50_60','n50_61','n50_62','n51_147','n51_154','n51_46','n51_47','n51_48','n51_49','n51_50','n51_51','n51_52','n51_53','n51_54','n51_55','n51_56','n51_57','n51_58','n51_59','n51_60','n51_61','n51_62','n52_152','n52_153','n52_154','n52_46','n52_47','n52_48','n52_49','n52_50','n52_51','n52_52','n52_53','n52_54','n52_55','n52_56','n52_57','n52_58','n52_59','n52_60','n52_61','n52_62','n53_49','n53_50','n53_51','n53_52','n53_53','o29_75','o30_75','o31_75','o32_70','o32_71','o32_72','o32_73','o32_74','o32_75','o33_70','o33_71','o33_72','o33_73','o33_74','o33_75','o33_76','o34_70','o34_71','o34_72','o34_73','o34_74','o34_75','o34_76','o35_20','o35_75','o35_76','o36_146','o36_147','o36_148','o36_149','o36_150','o36_153','o36_154','o36_52','o36_53','o36_54','o36_72','o36_73','o36_74','o36_75','o36_76','o37_146','o37_147','o37_148','o37_149','o37_150','o37_151','o37_152','o37_153','o37_154','o37_48','o37_49','o37_50','o37_51','o37_52','o37_53','o37_54','o37_55','o37_72','o37_73','o37_74','o37_75','o38_146','o38_147','o38_148','o38_149','o38_150','o38_151','o38_152','o38_153','o38_154','o38_155','o38_45','o38_46','o38_47','o38_48','o38_49','o38_50','o38_51','o38_52','o38_53','o38_54','o38_55','o38_72','o38_73','o38_74','o39_147','o39_148','o39_149','o39_150','o39_151','o39_152','o39_153','o39_154','o39_155','o39_45','o39_46','o39_47','o39_48','o39_49','o39_50','o39_51','o39_52','o39_53','o39_54','o39_55','o39_72','o39_73','o39_74','o39_75','o39_76','o40_147','o40_148','o40_149','o40_150','o40_151','o40_152','o40_153','o40_154','o40_45','o40_46','o40_47','o40_48','o40_49','o40_50','o40_51','o40_52','o40_53','o40_54','o40_55','o40_72','o40_73','o40_74','o40_75','o40_76','o41_146','o41_149','o41_151','o41_152','o41_153','o41_154','o41_45','o41_46','o41_47','o41_48','o41_49','o41_50','o41_51','o41_52','o41_53','o41_54','o41_55','o41_56','o41_72','o41_73','o41_74','o41_75','o42_144','o42_145','o42_146','o42_151','o42_152','o42_153','o42_49','o42_50','o42_51','o42_52','o42_53','o42_54','o42_55','o42_56','o42_72','o42_73','o42_74','o42_75','o43_144','o43_145','o43_146','o43_153','o43_154','o43_45','o43_46','o43_47','o43_48','o43_49','o43_50','o43_51','o43_52','o43_53','o43_54','o43_55','o43_56','o43_72','o43_73','o43_74','o43_75','o44_144','o44_145','o44_146','o44_148','o44_149','o44_150','o44_151','o44_152','o44_153','o44_154','o44_155','o44_45','o44_46','o44_47','o44_48','o44_49','o44_50','o44_51','o44_52','o44_53','o44_54','o44_55','o44_72','o44_73','o44_74','o44_75','o45_145','o45_146','o45_148','o45_150','o45_151','o45_152','o45_153','o45_154','o45_155','o45_45','o45_46','o45_47','o45_48','o45_49','o45_50','o45_51','o45_52','o45_53','o45_54','o45_55','o45_56','o45_57','o45_58','o45_59','o45_60','o45_61','o45_62','o45_73','o45_74','o45_75','o45_76','o46_149','o46_150','o46_152','o46_153','o46_154','o46_161','o46_45','o46_46','o46_47','o46_48','o46_49','o46_50','o46_51','o46_52','o46_53','o46_54','o46_55','o46_56','o46_57','o46_58','o46_59','o46_60','o46_61','o46_62','o46_75','o47_148','o47_149','o47_150','o47_152','o47_153','o47_160','o47_161','o47_47','o47_48','o47_49','o47_50','o47_51','o47_52','o47_53','o47_54','o47_55','o47_56','o47_57','o47_58','o47_59','o47_60','o47_61','o47_62','o47_75','o48_148','o48_149','o48_152','o48_153','o48_154','o48_155','o48_156','o48_47','o48_48','o48_49','o48_50','o48_51','o48_52','o48_53','o48_54','o48_55','o48_56','o48_57','o48_58','o48_59','o48_60','o48_61','o48_62','o49_148','o49_149','o49_153','o49_154','o49_155','o49_156','o49_46','o49_47','o49_48','o49_49','o49_50','o49_51','o49_52','o49_53','o49_54','o49_55','o49_56','o49_57','o49_58','o49_59','o49_60','o49_61','o49_62','o50_149','o50_150','o50_152','o50_153','o50_154','o50_46','o50_47','o50_48','o50_49','o50_50','o50_51','o50_52','o50_53','o50_54','o50_55','o50_56','o50_57','o50_58','o50_59','o50_60','o50_61','o50_62','o51_147','o51_154','o51_46','o51_47','o51_48','o51_49','o51_50','o51_51','o51_52','o51_53','o51_54','o51_55','o51_56','o51_57','o51_58','o51_59','o51_60','o51_61','o51_62','o52_152','o52_153','o52_154','o52_46','o52_47','o52_48','o52_49','o52_50','o52_51','o52_52','o52_53','o52_54','o52_55','o52_56','o52_57','o52_58','o52_59','o52_60','o52_61','o52_62','o53_49','o53_50','o53_51','o53_52','o53_53'];for(let e=0;e<t.length;e++){const n=t[e],s=new Uint8Array(await(await fetch(`data/pack/client/maps/${n}`)).arrayBuffer()),i=E.getcrc(s,0,s.length);Gs.set(n,s),Ws.set(n,i)}const e=['adventure.mid','al_kharid.mid','alone.mid','ambience_2.mid','ambience_3.mid','ambience_4.mid','ambient_jungle.mid','arabian.mid','arabian2.mid','arabian3.mid','arabique.mid','army_of_darkness.mid','arrival.mid','attack1.mid','attack2.mid','attack3.mid','attack4.mid','attack5.mid','attack6.mid','attention.mid','autumn_voyage.mid','background2.mid','ballad_of_enchantment.mid','baroque.mid','beyond.mid','big_chords.mid','book_of_spells.mid','camelot.mid','cave_background1.mid','cavern.mid','cellar_song1.mid','chain_of_command.mid','chompy_hunt.mid','close_quarters.mid','crystal_cave.mid','crystal_sword.mid','cursed.mid','dangerous.mid','dark2.mid','deep_wildy.mid','desert_voyage.mid','doorways.mid','dream1.mid','duel_arena.mid','dunjun.mid','egypt.mid','emotion.mid','emperor.mid','escape.mid','expanse.mid','expecting.mid','expedition.mid','fade_test.mid','faerie.mid','fanfare.mid','fanfare2.mid','fanfare3.mid','fishing.mid','flute_salad.mid','forbidden.mid','forever.mid','game_intro_1.mid','gaol.mid','garden.mid','gnome.mid','gnome_king.mid','gnome_theme.mid','gnome_village.mid','gnome_village2.mid','gnomeball.mid','greatness.mid','grumpy.mid','harmony.mid','harmony2.mid','heart_and_mind.mid','high_seas.mid','horizon.mid','iban.mid','ice_melody.mid','in_the_manor.mid','inspiration.mid','intrepid.mid','jolly-r.mid','jungle_island.mid','jungly1.mid','jungly2.mid','jungly3.mid','knightly.mid','landlubber.mid','lasting.mid','legion.mid','lightness.mid','lightwalk.mid','lonesome.mid','long_ago.mid','long_way_home.mid','lullaby.mid','mage_arena.mid','magic_dance.mid','magical_journey.mid','march2.mid','medieval.mid','mellow.mid','miles_away.mid','miracle_dance.mid','monarch_waltz.mid','moody.mid','neverland.mid','newbie_melody.mid','nightfall.mid','nomad.mid','null.mid','organ_music_1.mid','organ_music_2.mid','oriental.mid','overture.mid','parade.mid','quest.mid','regal2.mid','reggae.mid','reggae2.mid','riverside.mid','royale.mid','rune_essence.mid','sad_meadow.mid','scape_cave.mid','scape_main.mid','scape_sad1.mid','scape_soft.mid','scape_wild1.mid','sea_shanty.mid','sea_shanty2.mid','serenade.mid','serene.mid','shine.mid','shining.mid','silence.mid','soundscape.mid','spirit.mid','splendour.mid','spooky2.mid','spooky_jungle.mid','starlight.mid','start.mid','still_night.mid','talking_forest.mid','the_desert.mid','the_shadow.mid','the_tower.mid','theme.mid','tomorrow.mid','trawler.mid','trawler_minor.mid','tree_spirits.mid','tribal.mid','tribal2.mid','tribal_background.mid','trinity.mid','troubled.mid','undercurrent.mid','underground.mid','understanding.mid','unknown_land.mid','upass1.mid','upcoming.mid','venture.mid','venture2.mid','vision.mid','voodoo_cult.mid','voyage.mid','wander.mid','waterfall.mid','wilderness2.mid','wilderness3.mid','wilderness4.mid','witching.mid','wolf_mountain.mid','wonder.mid','wonderous.mid','workshop.mid','yesteryear.mid','zealot.mid'];for(let t=0;t<e.length;t++){const n=e[t],s=new Uint8Array(await(await fetch(`data/pack/client/songs/${n}`)).arrayBuffer()),i=E.getcrc(s,0,s.length);Gs.set(n,s),Ws.set(n,i)}const n=['advance agility.mid','advance attack.mid','advance attack2.mid','advance cooking.mid','advance cooking2.mid','advance crafting.mid','advance crafting2.mid','advance defense.mid','advance defense2.mid','advance firemarking.mid','advance firemarking2.mid','advance fishing.mid','advance fishing2.mid','advance fletching.mid','advance fletching2.mid','advance herblaw.mid','advance herblaw2.mid','advance hitpoints.mid','advance hitpoints2.mid','advance magic.mid','advance magic2.mid','advance mining.mid','advance mining2.mid','advance prayer.mid','advance prayer2.mid','advance ranged.mid','advance ranged2.mid','advance runecraft.mid','advance runecraft2.mid','advance smithing.mid','advance smithing2.mid','advance strength.mid','advance strength2.mid','advance thieving.mid','advance thieving2.mid','advance woodcutting.mid','advance woodcutting2.mid','death.mid','death2.mid','dice lose.mid','dice win.mid','duel start.mid','duel win2.mid','quest complete 1.mid','quest complete 2.mid','quest complete 3.mid','sailing journey.mid','treasure hunt win.mid'];for(let t=0;t<n.length;t++){const e=n[t],s=new Uint8Array(await(await fetch(`data/pack/client/jingles/${e}`)).arrayBuffer()).subarray(4),i=E.getcrc(s,0,s.length);Gs.set(e,s),Ws.set(e,i)}}()}broadcastMes(t){for(const e of this.players)e.messageGame(t)}async start(t=!1,e=!0){console.log('Starting world...'),await L.load(await(await fetch('bz2.wasm')).arrayBuffer()),await b.load('data/pack'),await Lt.load('data/pack'),await this.reload(),t||await this.gameMap.init(this.zoneMap),Jc.loginThread.postMessage({type:'reset'}),80===Jn.WEB_PORT?console.log(l.green().bold('World ready')+l.white().bold(': http://'+Jn.PUBLIC_IP)):console.log(l.green().bold('World ready')+l.white().bold(': http://'+Jn.PUBLIC_IP+':'+Jn.WEB_PORT)),e&&await this.cycle()}rebootTimer(t){this.shutdownTick=this.currentTick+t;for(const t of this.players)t.write(new qc(this.shutdownTick-this.currentTick))}async cycle(t=!0){const e=Date.now();let n=Date.now();for(let t=this.queue.head();null!==t;t=this.queue.next()){if(t.delay-- >0)continue;const e=t.script;try{const n=Bc.execute(e);t.unlink(),n===ee.SUSPENDED?e.activePlayer.activeScript=e:n===ee.NPC_SUSPENDED?e.activeNpc.activeScript=e:n===ee.WORLD_SUSPENDED&&this.enqueueScript(e,e.popInt())}catch(t){console.error(t)}}if(this.currentTick%500==0)for(const t of this.players)t.afkEventReady=Math.random()<(t.zonesAfk()?.1666:.0833);for(const t of this.npcs)t.updateLifeCycle(this.currentTick)&&(t.lifecycle===Qn.RESPAWN?this.addNpc(t,-1):t.lifecycle===Qn.DESPAWN&&this.removeNpc(t,-1));for(const t of this.npcs)t.checkLifeCycle(this.currentTick)&&!t.delayed()&&-1!==t.huntMode&&t.huntAll();n=Date.now()-n,this.lastCycleBandwidth[0]=0;let s=Date.now();for(const t of this.players)if(yc(t))try{t.decodeIn()}catch(e){console.error(e),await this.removePlayer(t)}s=Date.now()-s;for(const t of this.players)if(yc(t)){if(t.userPath.length>0||t.opcalled){if(t.delayed()){t.unsetMapFlag();continue}if((!t.target||t.target instanceof hs||t.target instanceof es)&&-1!==t.faceEntity&&(t.faceEntity=-1,t.mask|=Br.FACE_ENTITY),t.opcalled&&(0===t.userPath.length||!Jn.CLIENT_PATHFINDER)){t.pathToTarget();continue}t.pathToMoveClick(t.userPath,!Jn.CLIENT_PATHFINDER)}t.target instanceof Br&&(t.targetOp===Os.APPLAYER3||t.targetOp===Os.OPPLAYER3)&&(qe.distanceToSW(t,t.target)<=25?t.pathToPathingTarget():t.clearWaypoints())}let i=Date.now();for(const t of this.npcs)if(t.checkLifeCycle(this.currentTick))try{if(t.delayed()&&t.delay--,t.delayed())continue;if(t.activeScript&&t.executeScript(t.activeScript),!t.checkLifeCycle(this.currentTick))continue;t.processTimers(),t.processQueue(),t.processNpcModes(),t.validateDistanceWalked()}catch(e){console.error(e),this.removeNpc(t,-1)}i=Date.now()-i;let a=Date.now();for(const t of this.players)try{t.playtime++,t.delayed()&&t.delay--,t.activeScript&&!t.delayed()&&t.activeScript.execution===ee.SUSPENDED&&t.executeScript(t.activeScript,!0),t.processQueues(),t.processTimers(0),t.processTimers(1),t.processEngineQueue(),t.processInteraction(),t.mask&Br.EXACT_MOVE||t.validateDistanceWalked(),this.shutdownTick<this.currentTick&&!Jn.NO_SOCKET_TIMEOUT&&this.currentTick-t.lastResponse>=75&&(t.logoutRequested=!0),t.logoutRequested&&t.closeModal()}catch(e){console.error(e),await this.removePlayer(t)}a=Date.now()-a;let r=Date.now();for(const t of this.players)if(!Jn.NO_SOCKET_TIMEOUT&&this.currentTick-t.lastResponse>=100&&(t.queue.clear(),t.weakQueue.clear(),t.engineQueue.clear(),t.clearInteraction(),t.closeModal(),t.unsetMapFlag(),t.logoutRequested=!0,t.setVar(ft.LASTCOMBAT,0)),t.logoutRequested)if(null===t.queue.head()){const e=Xt.getByTriggerSpecific(Os.LOGOUT,-1,-1);if(!e){console.error('LOGOUT TRIGGER IS BROKEN!');continue}const n=Bc.init(e,t);n.pointerAdd(Mt.ProtectedActivePlayer),Bc.execute(n);0===n.popInt()&&(t.logoutRequested=!1),t.logoutRequested&&await this.removePlayer(t)}else t.messageGame('[DEBUG]: Waiting for queue to empty before logging out.');r=Date.now()-r;let o=Date.now();for(let t=0;t<this.newPlayers.length;t++){const e=this.newPlayers[t];let n;this.newPlayers.splice(t--,1);try{n=this.getNextPid(yc(e)?e.client:null)}catch(t){e instanceof vc&&e.client&&(e.client.send(zc.WORLD_FULL),e.client.close());continue}this.players.set(n,e),e.pid=n,e.uid=(Number(0x1fffffn&e.username37)<<11|e.pid)>>>0,e.tele=!0,this.getZone(e.x,e.z,e.level).enter(e),Jn.CLIRUNNER||e.onLogin(),this.shutdownTick>-1&&e.write(new qc(this.shutdownTick-this.currentTick)),e instanceof vc&&e.client&&(e.client.state=1,e.staffModLevel>=2?e.client.send(zc.STAFF_MOD_LEVEL):e.client.send(zc.SUCCESSFUL))}o=Date.now()-o;let c=Date.now();for(const t of Array.from(this.zonesTracking.get(this.currentTick)??[]))t.tick(this.currentTick);this.computeSharedEvents(),c=Date.now()-c;for(const t of this.players)t.convertMovementDir();for(const t of this.npcs)t.convertMovementDir();this.lastCycleBandwidth[1]=0;let l=Date.now();for(const t of this.players)if(yc(t))try{t.updateMap(),t.updatePlayers(),t.updateNpcs(),t.updateZones(),t.updateInvs(),t.updateStats(),t.updateAfkZones(),t.encodeOut()}catch(e){console.error(e),await this.removePlayer(t)}l=Date.now()-l;let h=Date.now();for(const t of Array.from(this.zonesTracking.get(this.currentTick)??[]))t.reset();this.zonesTracking.delete(this.currentTick);for(const t of this.players){t.resetEntity(!1);for(const e of t.invs.values())e&&(e.update=!1)}for(const t of this.npcs)t.checkLifeCycle(this.currentTick)&&t.resetEntity(!1);for(let t=0;t<this.invs.length;t++){const e=this.invs[t];if(!e)continue;e.update=!1;const n=J.get(e.type);if(n.restock&&n.stockcount&&n.stockrate)for(let t=0;t<e.items.length;t++){const s=e.items[t];s&&(s.count<n.stockcount[t]&&this.currentTick%n.stockrate[t]==0?(e.add(s?.id,1,t,!0,!1,!1),e.update=!0):(s.count>n.stockcount[t]&&this.currentTick%n.stockrate[t]==0||n.allstock&&!n.stockcount[t]&&this.currentTick%100==0)&&(e.remove(s?.id,1,t,!0),e.update=!0))}}if(h=Date.now()-h,this.currentTick%100==0){const t=[];for(const e of this.players)t.push(e.username37);Jc.loginThread.postMessage({type:'heartbeat',players:t})}if(this.shutdownTick>-1&&this.currentTick>=this.shutdownTick){const t=this.currentTick-this.shutdownTick;if(this.getTotalPlayers()){for(const e of this.players)e.logoutRequested=!0,yc(e)&&(e.logout(),e.client&&t>2&&e.client.close());if(this.npcs.reset(),t>2&&(this.tickRate>1&&(this.tickRate=1),t>24e3)){for(const t of this.players)await this.removePlayer(t);this.tickRate=600}}else process.exit(0)}this.currentTick%1500==0&&this.currentTick;const d=Date.now();if(this.currentTick++,this.lastCycleStats=[d-e,n,s,i,a,r,o,c,l,h],t){const t=this.tickRate-(d-e);setTimeout(this.cycle.bind(this),t)}}enqueueScript(t,e=0){this.queue.addTail(new Rs(t,e+1))}getInventory(t){if(-1===t)return null;let e=this.invs.find((e=>e&&e.type==t));return e||(e=se.fromType(t),this.invs.push(e)),e}getZone(t,e,n){return this.zoneMap.zone(t,e,n)}getZoneIndex(t){return this.zoneMap.zoneByIndex(t)}getZoneGrid(t){return this.zoneMap.grid(t)}computeSharedEvents(){const t=new Set;for(const e of this.players)if(yc(e))for(const n of e.buildArea.loadedZones)t.add(n);for(const e of t)this.getZoneIndex(e).computeShared()}addNpc(t,e){this.npcs.set(t.nid,t),t.x=t.startX,t.z=t.startZ;switch(this.getZone(t.x,t.z,t.level).enter(t),t.blockWalk){case at.NPC:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!0);break;case at.ALL:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!0),this.gameMap.changePlayerCollision(t.width,t.x,t.z,t.level,!0)}t.resetEntity(!0),t.playAnimation(-1,0),t.setLifeCycle(this.currentTick+e)}removeNpc(t,e){switch(this.getZone(t.x,t.z,t.level).leave(t),t.blockWalk){case at.NPC:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!1);break;case at.ALL:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!1),this.gameMap.changePlayerCollision(t.width,t.x,t.z,t.level,!1)}t.lifecycle===Qn.DESPAWN?this.npcs.remove(t.nid):t.lifecycle===Qn.RESPAWN&&t.setLifeCycle(this.currentTick+e)}getLoc(t,e,n,s){return this.getZone(t,e,n).getLoc(t,e,s)}getObj(t,e,n,s,i){return this.getZone(t,e,n).getObj(t,e,s,i)}trackZone(t,e){let n;const s=this.zonesTracking.get(t);n=s||new Set,n.add(e),this.zonesTracking.set(t,n)}addLoc(t,e){const n=et.get(t.type);n.blockwalk&&this.gameMap.changeLocCollision(t.shape,t.angle,n.blockrange,n.length,n.width,n.active,t.x,t.z,t.level,!0);const s=this.getZone(t.x,t.z,t.level);s.addLoc(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,s),this.trackZone(this.currentTick,s)}mergeLoc(t,e,n,s,i,a,r,o){const c=this.getZone(t.x,t.z,t.level);c.mergeLoc(t,e,n,s,i,a,r,o),this.trackZone(this.currentTick,c)}animLoc(t,e){const n=this.getZone(t.x,t.z,t.level);n.animLoc(t,e),this.trackZone(this.currentTick,n)}removeLoc(t,e){const n=et.get(t.type);n.blockwalk&&this.gameMap.changeLocCollision(t.shape,t.angle,n.blockrange,n.length,n.width,n.active,t.x,t.z,t.level,!1);const s=this.getZone(t.x,t.z,t.level);s.removeLoc(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,s),this.trackZone(this.currentTick,s)}addObj(t,e,n){const s=ut.get(t.type),i=this.getObj(t.x,t.z,t.level,t.type,e);if(i&&i.lifecycle===Qn.DESPAWN&&t.lifecycle===Qn.DESPAWN){const n=t.count+i.count;if(s.stackable&&n<=se.STACK_LIMIT)return void this.changeObj(i,e,n)}const a=this.getZone(t.x,t.z,t.level);a.addObj(t,e),-1!==e&&s.tradeable?(t.setLifeCycle(this.currentTick+100),this.trackZone(this.currentTick+100,a),this.trackZone(this.currentTick,a),t.receiverId=e,t.reveal=n):(t.setLifeCycle(this.currentTick+n),this.trackZone(this.currentTick+n,a),this.trackZone(this.currentTick,a))}revealObj(t){const e=t.reveal,n=this.getZone(t.x,t.z,t.level);n.revealObj(t,t.receiverId),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,n),this.trackZone(this.currentTick,n)}changeObj(t,e,n){const s=this.getZone(t.x,t.z,t.level);s.changeObj(t,e,t.count,n),this.trackZone(this.currentTick,s)}removeObj(t,e){const n=this.getZone(t.x,t.z,t.level);n.removeObj(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,n),this.trackZone(this.currentTick,n)}animMap(t,e,n,s,i,a){const r=this.getZone(e,n,t);r.animMap(e,n,s,i,a),this.trackZone(this.currentTick,r)}mapProjAnim(t,e,n,s,i,a,r,o,c,l,h,d,p){const _=this.getZone(e,n,t);_.mapProjAnim(e,n,s,i,a,r,o,c,l,h,d,p),this.trackZone(this.currentTick,_)}async readIn(t,e){for(;e.available>0;){const n=e.pos;let s=e.g1();if(t.decryptor&&(s=s-t.decryptor.nextInt()&255,e.data[n]=s),void 0===Hr.byId[s])return t.state=-1,void t.close();let i=Hr.byId[s].length;if(-1===i?i=e.g1():-2===i&&(i=e.g2()),e.available<i)break;if(e.pos+=i,t.inCount[s]++,t.inCount[s]>5)continue;const a=new Uint8Array(e.pos-n),r=e.pos;e.pos=n,e.gdata(a,0,a.length),e.pos=r,t.in.set(a,t.inOffset),t.inOffset+=e.pos-n}}addPlayer(t){this.newPlayers.push(t)}async removePlayer(t){-1!==t.pid&&(t.playerLog('Logging out'),yc(t)&&(t.logout(),t.client.close(),t.client=null),Jc.logout(t))}getPlayer(t){return this.players.get(t)}getPlayerByUid(t){const e=2047&t,n=t>>11&2097151,s=this.getPlayer(e);return s?Number(0x1fffffn&s.username37)!==n?null:s:null}getPlayerByUsername(t){const e=h(t);for(const t of this.players)if(t.username37===e)return t;for(const t of this.newPlayers)if(t.username37===e)return t}getTotalPlayers(){return this.players.count}getTotalNpcs(){return this.npcs.count}getNpc(t){return this.npcs.get(t)}getNpcByUid(t){const e=65535&t,n=t>>16&65535,s=this.getNpc(e);return s&&s.type===n?s:null}getNextNid(){return this.npcs.next()}getNextPid(t=null){if(t){const e=t.remoteAddress.split('.'),n=parseInt(e[3])%20*100;return this.players.next(!0,n)}return this.players.next()}};await tl.start();var el=new class{socket=new Zo;constructor(){}start(){const t=new E(new Uint8Array(8));t.p4(Math.floor(4294967295*Math.random())),t.p4(Math.floor(4294967295*Math.random())),this.socket.send(t.data),self.onmessage=async t=>{const e=new E(new Uint8Array(t.data));if('message'===t.type)try{1===this.socket.state?await tl.readIn(this.socket,e):await Jc.readIn(this.socket,e)}catch(t){this.socket.close()}else console.log('default',t.type)}}};el.start();