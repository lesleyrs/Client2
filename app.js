t=function(t){if('undefined'!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')},'undefined'!=typeof require?require:'undefined'!=typeof Proxy&&new Proxy(t,{get:(t,e)=>('undefined'!=typeof require?require:t)[e]});var t,e,s,n,i,a=function(t,e){let s,n=0,i='',a='';for(;n<t.length;n++)s=t[n],i+=s.open,a+=s.close,~e.indexOf(s.close)&&(e=e.replace(s.rgx,s.close+s.open));return i+e+a},r=function(t,e){let s={open:`[${t}m`,close:`[${e}m`,rgx:new RegExp(`\\x1b\\[${e}m`,'g')};return function(e){return void 0!==this&&void 0!==this.has?(~this.has.indexOf(t)||(this.has.push(t),this.keys.push(s)),void 0===e?this:c.enabled?a(this.keys,e+''):e+''):void 0===e?function(t,e){let s={has:t,keys:e};return s.reset=c.reset.bind(s),s.bold=c.bold.bind(s),s.dim=c.dim.bind(s),s.italic=c.italic.bind(s),s.underline=c.underline.bind(s),s.inverse=c.inverse.bind(s),s.hidden=c.hidden.bind(s),s.strikethrough=c.strikethrough.bind(s),s.black=c.black.bind(s),s.red=c.red.bind(s),s.green=c.green.bind(s),s.yellow=c.yellow.bind(s),s.blue=c.blue.bind(s),s.magenta=c.magenta.bind(s),s.cyan=c.cyan.bind(s),s.white=c.white.bind(s),s.gray=c.gray.bind(s),s.grey=c.grey.bind(s),s.bgBlack=c.bgBlack.bind(s),s.bgRed=c.bgRed.bind(s),s.bgGreen=c.bgGreen.bind(s),s.bgYellow=c.bgYellow.bind(s),s.bgBlue=c.bgBlue.bind(s),s.bgMagenta=c.bgMagenta.bind(s),s.bgCyan=c.bgCyan.bind(s),s.bgWhite=c.bgWhite.bind(s),s}([t],[s]):c.enabled?a([s],e+''):e+''}},o=!0;'undefined'!=typeof process&&(({FORCE_COLOR:e,NODE_DISABLE_COLORS:s,NO_COLOR:n,TERM:i}=process.env||{}),o=process.stdout&&process.stdout.isTTY);var c={enabled:!s&&null==n&&'dumb'!==i&&(null!=e&&'0'!==e||o),reset:r(0,0),bold:r(1,22),dim:r(2,22),italic:r(3,23),underline:r(4,24),inverse:r(7,27),hidden:r(8,28),strikethrough:r(9,29),black:r(30,39),red:r(31,39),green:r(32,39),yellow:r(33,39),blue:r(34,39),magenta:r(35,39),cyan:r(36,39),white:r(37,39),gray:r(90,39),grey:r(90,39),bgBlack:r(40,49),bgRed:r(41,49),bgGreen:r(42,49),bgYellow:r(43,49),bgBlue:r(44,49),bgMagenta:r(45,49),bgCyan:r(46,49),bgWhite:r(47,49)},l=c;async function h(t,e={}){const s={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,s,n){t=r(t>>>0),e=r(e>>>0),s>>>=0,n>>>=0,(()=>{throw Error(`${t} in ${e}:${s}:${n}`)})()}})},{exports:n}=await WebAssembly.instantiate(t,s),i=n.memory||e.env.memory,a=Object.setPrototypeOf({read:(t,e,s,a)=>(e=function(t,e,s,a,r){if(null==a)return 0;const o=a.length,c=n.__pin(n.__new(o<<s,e))>>>0;if(r)new r(i.buffer,c,o).set(a);else for(let e=0;e<o;e++)t(c+(e<<s>>>0),a[e]);return n.__unpin(c),c}(c,6,0,e,Int8Array)||function(){throw TypeError('value must not be null')}(),function(t,e,s){if(!s)return null;const n=function(t){try{return o.getUint32(t,!0)}catch{return o=new DataView(i.buffer),o.getUint32(t,!0)}}(s-4)>>>e,a=new Array(n);for(let i=0;i<n;++i)a[i]=t(s+(i<<e>>>0));return a}(l,0,n.read(t,e,s,a)>>>0))},n);function r(t){if(!t)return null;const e=t+new Uint32Array(i.buffer)[t-4>>>2]>>>1,s=new Uint16Array(i.buffer);let n=t>>>1,a='';for(;e-n>1024;)a+=String.fromCharCode(...s.subarray(n,n+=1024));return a+String.fromCharCode(...s.subarray(n,e))}let o=new DataView(i.buffer);function c(t,e){try{o.setUint8(t,e,!0)}catch{o=new DataView(i.buffer),o.setUint8(t,e,!0)}}function l(t){try{return o.getInt8(t,!0)}catch{return o=new DataView(i.buffer),o.getInt8(t,!0)}}return a}class d{static bz2=null;static load=async t=>{this.bz2=await h(new WebAssembly.Module(t),{env:void 0})};static read=(t,e,s,n)=>{if(!this.bz2)throw new Error('bz2 not found!!');return Int8Array.from(this.bz2.read(t,e,s,n))}}function p(t){t=t.trim();let e=0n;for(let s=0;s<t.length&&s<12;s++){const n=t.charCodeAt(s);e*=37n,n>=65&&n<=90?e+=BigInt(n+1-65):n>=97&&n<=122?e+=BigInt(n+1-97):n>=48&&n<=57&&(e+=BigInt(n+27-48))}return e}function u(t){if(t<0n||t>=6582952005840035281n)return'invalid_name';if(t%37n===0n)return'invalid_name';let e=0;const s=Array(12);for(;0n!==t;){const n=t;t/=37n,s[11-e++]=g[Number(n-37n*t)]}return s.slice(12-e).join('')}function _(t){return e=function(t){return u(p(t))}(t).replaceAll('_',' '),e.replace(/\w\S*/g,(t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()));var e}var g=['_','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','0','1','2','3','4','5','6','7','8','9'];class m{key;next;prev;constructor(){this.key=0n,this.next=this,this.prev=this}unlink(){this.prev&&this.next&&(this.prev.next=this.next,this.next.prev=this.prev,this.next=null,this.prev=null)}}class E{sentinel;cursor=null;constructor(){const t=new m;t.next=t,t.prev=t,this.sentinel=t}addTail(t){t.prev&&t.unlink(),t.prev=this.sentinel.prev,t.next=this.sentinel,t.prev&&(t.prev.next=t),t.next.prev=t}addHead(t){t.prev&&t.unlink(),t.prev=this.sentinel,t.next=this.sentinel.next,t.prev.next=t,t.next&&(t.next.prev=t)}removeHead(){const t=this.sentinel.next;return t===this.sentinel?null:(t?.unlink(),t)}head(){const t=this.sentinel.next;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.next||null,t)}tail(){const t=this.sentinel.prev;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.prev||null,t)}next(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.next||null,t)}prev(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.prev||null,t)}clear(){for(;;){const t=this.sentinel.next;if(t===this.sentinel)return;t?.unlink()}}}class O extends m{nextHashable;prevHashable;constructor(){super(),this.nextHashable=this,this.prevHashable=this}uncache(){this.prevHashable&&this.nextHashable&&(this.prevHashable.nextHashable=this.nextHashable,this.nextHashable.prevHashable=this.prevHashable,this.nextHashable=null,this.prevHashable=null)}}class f extends O{static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static crc32b=3988292384;static{for(let t=0;t<32;t++)this.bitmask[t]=(1<<t)-1;this.bitmask[32]=4294967295;for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1&~e?e>>>=1:e=e>>>1^this.crc32b;this.crctable[t]=e}}static getcrc(t,e,s){let n=4294967295;for(let i=e;i<s;i++)n=n>>>8^this.crctable[255&(n^t[i])];return~n}static checkcrc(t,e,s,n=0){const i=f.getcrc(t,e,s);return console.log(i,n),i==n}static alloc(t){let e=null;return 0===t&&this.cacheMinCount>0?(e=this.cacheMin.removeHead(),this.cacheMinCount--):1===t&&this.cacheMidCount>0?(e=this.cacheMid.removeHead(),this.cacheMidCount--):2===t&&this.cacheMaxCount>0?(e=this.cacheMax.removeHead(),this.cacheMaxCount--):3===t&&this.cacheBigCount>0?(e=this.cacheBig.removeHead(),this.cacheBigCount--):4===t&&this.cacheHugeCount>0?(e=this.cacheHuge.removeHead(),this.cacheHugeCount--):5===t&&this.cacheUnimaginableCount>0&&(e=this.cacheUnimaginable.removeHead(),this.cacheUnimaginableCount--),null!==e?(e.pos=0,e.bitPos=0,e):new f(0===t?new Uint8Array(100):1===t?new Uint8Array(5e3):2===t?new Uint8Array(3e4):3===t?new Uint8Array(1e5):4===t?new Uint8Array(5e5):5===t?new Uint8Array(2e6):new Uint8Array(t))}static async load(t,e=!1){const s=new f(new Uint8Array(await(await fetch(t)).arrayBuffer()));return e&&(s.pos=s.data.length),s}static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static cacheBigCount=0;static cacheHugeCount=0;static cacheUnimaginableCount=0;static cacheMin=new E;static cacheMid=new E;static cacheMax=new E;static cacheBig=new E;static cacheHuge=new E;static cacheUnimaginable=new E;data;#t;pos;bitPos;constructor(t){super(),this.data=t,this.#t=new DataView(this.data.buffer),this.pos=0,this.bitPos=0}get available(){return this.data.length-this.pos}get length(){return this.data.length}release(){this.pos=0,this.bitPos=0,100===this.data.length&&f.cacheMinCount<1e3?(f.cacheMin.addTail(this),f.cacheMinCount++):5e3===this.data.length&&f.cacheMidCount<250?(f.cacheMid.addTail(this),f.cacheMidCount++):3e4===this.data.length&&f.cacheMaxCount<50?(f.cacheMax.addTail(this),f.cacheMaxCount++):1e5===this.data.length&&f.cacheBigCount<10?(f.cacheBig.addTail(this),f.cacheBigCount++):5e5===this.data.length&&f.cacheHugeCount<5?(f.cacheHuge.addTail(this),f.cacheHugeCount++):2e6===this.data.length&&f.cacheUnimaginableCount<2&&(f.cacheUnimaginable.addTail(this),f.cacheUnimaginableCount++)}p1(t){this.#t.setUint8(this.pos++,t)}p2(t){this.#t.setUint16(this.pos,t),this.pos+=2}ip2(t){this.#t.setUint16(this.pos,t,!0),this.pos+=2}p3(t){this.#t.setUint8(this.pos++,t>>16),this.#t.setUint16(this.pos,t),this.pos+=2}p4(t){this.#t.setInt32(this.pos,t),this.pos+=4}ip4(t){this.#t.setInt32(this.pos,t,!0),this.pos+=4}p8(t){this.#t.setBigInt64(this.pos,t),this.pos+=8}pbool(t){this.p1(t?1:0)}pjstr(t,e=10){const s=t.length;for(let e=0;e<s;e++)this.#t.setUint8(this.pos++,t.charCodeAt(e));this.#t.setUint8(this.pos++,e)}pdata(t,e,s){this.data.set(t.subarray(e,e+s),this.pos),this.pos+=s-e}psize4(t){this.#t.setUint32(this.pos-t-4,t)}psize2(t){this.#t.setUint16(this.pos-t-2,t)}psize1(t){this.#t.setUint8(this.pos-t-1,t)}psmarts(t){if(t<64&&t>=64)this.p1(t+64);else{if(!(t<16384&&t>=-16384))throw new Error('Error psmarts out of range: '+t);this.p2(t+49152)}}psmart(t){if(t>=0&&t<128)this.p1(t);else{if(!(t>=0&&t<32768))throw new Error('Error psmart out of range: '+t);this.p2(t+32768)}}g1(){return this.#t.getUint8(this.pos++)}g1b(){return this.#t.getInt8(this.pos++)}g2(){return this.pos+=2,this.#t.getUint16(this.pos-2)}g2s(){return this.pos+=2,this.#t.getInt16(this.pos-2)}ig2(){return this.pos+=2,this.#t.getUint16(this.pos-2,!0)}g3(){const t=this.#t.getUint8(this.pos++)<<16|this.#t.getUint16(this.pos);return this.pos+=2,t}g4(){return this.pos+=4,this.#t.getInt32(this.pos-4)}ig4(){return this.pos+=4,this.#t.getInt32(this.pos-4,!0)}g8(){return this.pos+=8,this.#t.getBigInt64(this.pos-8)}gbool(){return 1===this.g1()}gjstr(t=10){const e=this.data.length;let s,n='';for(;(s=this.#t.getUint8(this.pos++))!==t&&this.pos<e;)n+=String.fromCharCode(s);return n}gdata(t,e,s){t.set(this.data.subarray(this.pos,this.pos+s),e),this.pos+=s}gsmarts(){return this.#t.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmart(){return this.#t.getUint8(this.pos)<128?this.g1():this.g2()-32768}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(t){let e=this.bitPos>>>3,s=8-(7&this.bitPos),n=0;for(this.bitPos+=t;t>s;s=8)n+=(this.#t.getUint8(e++)&f.bitmask[s])<<t-s,t-=s;return n+=t==s?this.#t.getUint8(e)&f.bitmask[s]:this.#t.getUint8(e)>>>s-t&f.bitmask[t],n}pBit(t,e){const s=this.bitPos;this.bitPos+=t;let n=s>>>3,i=8-(7&s);const a=this.#t;for(;t>i;i=8){const s=(1<<i)-1,r=a.getUint8(n);a.setUint8(n++,r&~s|e>>>t-i&s),t-=i}const r=i-t,o=(1<<t)-1,c=a.getUint8(n);a.setUint8(n,c&~o<<r|(e&o)<<r)}}class A{id;debugname=null;constructor(t){this.id=t}decodeType(t){for(;t.available>0;){const e=t.g1();if(0===e)break;this.decode(e,t)}}}class T extends A{static configNames=new Map;static configs=[];static async load(t){if(T.configNames=new Map,T.configs=[],!(await fetch(`${t}/server/category.dat`)).ok)return void console.log('Warning: No category.dat found.');const e=await f.load(`${t}/server/category.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new T(t);s.decodeType(e),T.configs[t]=s,s.debugname&&T.configNames.set(s.debugname,t)}}static get(t){return T.configs[t]}static getId(t){return T.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}decode(t,e){this.debugname=e.gjstr()}toString(){return this.debugname??`category_${this.id}`}}class I{static INT=105;static AUTOINT=255;static STRING=115;static ENUM=103;static OBJ=111;static LOC=108;static COMPONENT=73;static NAMEDOBJ=79;static STRUCT=74;static BOOLEAN=49;static COORD=99;static CATEGORY=121;static SPOTANIM=116;static NPC=110;static INV=118;static SYNTH=80;static SEQ=65;static STAT=83;static VARP=86;static PLAYER_UID=112;static NPC_UID=78;static INTERFACE=97;static NPC_STAT=254;static IDKIT=75;static getType(t){switch(t){case I.INT:return'int';case I.STRING:return'string';case I.ENUM:return'enum';case I.OBJ:return'obj';case I.LOC:return'loc';case I.COMPONENT:return'component';case I.NAMEDOBJ:return'namedobj';case I.STRUCT:return'struct';case I.BOOLEAN:return'boolean';case I.COORD:return'coord';case I.CATEGORY:return'category';case I.SPOTANIM:return'spotanim';case I.NPC:return'npc';case I.INV:return'inv';case I.SYNTH:return'synth';case I.SEQ:return'seq';case I.STAT:return'stat';case I.AUTOINT:return'autoint';case I.VARP:return'varp';case I.PLAYER_UID:return'player_uid';case I.NPC_UID:return'npc_uid';case I.INTERFACE:return'interface';case I.NPC_STAT:return'npc_stat';case I.IDKIT:return'idkit';default:return'unknown'}}static getTypeChar(t){let e='i';switch(t){case'int':e='i';break;case'autoint':e='Ã¿';break;case'string':e='s';break;case'enum':e='g';break;case'obj':e='o';break;case'loc':e='l';break;case'component':e='I';break;case'namedobj':e='O';break;case'struct':e='J';break;case'boolean':e='1';break;case'coord':e='c';break;case'category':e='y';break;case'spotanim':e='t';break;case'npc':e='n';break;case'inv':e='v';break;case'synth':e='P';break;case'seq':e='A';break;case'stat':e='S';break;case'varp':e='V';break;case'player_uid':e='p';break;case'npc_uid':e='N';break;case'interface':e='a';break;case'npc_stat':e='Ã¾';break;case'idkit':e='K';break;default:return null}return e.charCodeAt(0)}static getDefault(t){return t===I.STRING?'':t===I.BOOLEAN?0:-1}}class N extends A{static configNames=new Map;static configs=[];static async load(t){if(N.configNames=new Map,N.configs=[],!(await fetch(`${t}/server/dbtable.dat`)).ok)return void console.log('Warning: No dbtable.dat found.');const e=await f.load(`${t}/server/dbtable.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new N(t);s.decodeType(e),N.configs[t]=s,s.debugname&&N.configNames.set(s.debugname,t)}}static get(t){return N.configs[t]}static getId(t){return N.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}types=[];defaultValues=[];columnNames=[];decode(t,e){if(1===t){this.types=new Array(e.g1());for(let t=e.g1();255!=t;t=e.g1()){const s=127&t,n=!!(128&t),i=new Array(e.g1());for(let t=0;t<i.length;t++)i[t]=e.g1();this.types[s]=i,n&&(this.defaultValues||(this.defaultValues=new Array(this.types.length)),this.defaultValues[s]=this.decodeValues(e,s))}}else if(250===t)this.debugname=e.gjstr();else{if(251!==t)throw new Error(`Unrecognized dbtable config code: ${t}`);this.columnNames=new Array(e.g1());for(let t=0;t<this.columnNames.length;t++)this.columnNames[t]=e.gjstr()}}getDefault(t){if(!this.defaultValues[t]){const e=[];for(let s=0;s<this.types[t].length;s++)e[s]=I.getDefault(this.types[t][s]);return e}return this.defaultValues[t]}decodeValues(t,e){const s=this.types[e],n=t.g1(),i=new Array(n*s.length);for(let e=0;e<n;e++)for(let n=0;n<s.length;n++){const a=s[n],r=n+e*s.length;a===I.STRING?i[r]=t.gjstr():i[r]=t.g4()}return i}}class P extends A{static configNames=new Map;static configs=[];static async load(t){if(P.configNames=new Map,P.configs=[],!(await fetch(`${t}/server/dbrow.dat`)).ok)return void console.log('Warning: No dbrow.dat found.');const e=await f.load(`${t}/server/dbrow.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new P(t);s.decodeType(e),P.configs[t]=s,s.debugname&&P.configNames.set(s.debugname,t)}}static get(t){return P.configs[t]}static getId(t){return P.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}static getInTable(t){return P.configs.filter((e=>e.tableId===t))}tableId=0;types=[];columnValues=[];decode(t,e){if(3===t){const t=e.g1();this.types=new Array(t),this.columnValues=new Array(t);for(let t=e.g1();255!=t;t=e.g1()){const s=new Array(e.g1());for(let t=0;t<s.length;t++)s[t]=e.g1();this.types[t]=s,this.columnValues[t]=this.decodeValues(e,t)}}else if(4===t)this.tableId=e.g2();else{if(250!==t)throw new Error(`Unrecognized dbtable config code: ${t}`);this.debugname=e.gjstr()}}getValue(t,e){const s=this.columnValues[t].slice(e*this.types[t].length,(e+1)*this.types[t].length);return s.length?s:N.get(this.tableId).getDefault(t)}decodeValues(t,e){const s=this.types[e],n=t.g1(),i=new Array(n*s.length);for(let e=0;e<n;e++)for(let n=0;n<s.length;n++){const a=s[n],r=n+e*s.length;a===I.STRING?i[r]=t.gjstr():i[r]=t.g4()}return i}}class L extends A{static configNames=new Map;static configs=[];static async load(t){if(L.configNames=new Map,L.configs=[],!(await fetch(`${t}/server/enum.dat`)).ok)return void console.log('Warning: No enum.dat found.');const e=await f.load(`${t}/server/enum.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new L(t);s.decodeType(e),L.configs[t]=s,s.debugname&&L.configNames.set(s.debugname,t)}}static get(t){return L.configs[t]}static getId(t){return L.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}inputtype=I.INT;outputtype=I.INT;defaultInt=0;defaultString='null';values=new Map;decode(t,e){if(1===t)this.inputtype=e.g1();else if(2===t)this.outputtype=e.g1();else if(3===t)this.defaultString=e.gjstr();else if(4===t)this.defaultInt=e.g4();else if(5===t){const t=e.g2();for(let s=0;s<t;s++)this.values.set(e.g4(),e.gjstr())}else if(6===t){const t=e.g2();for(let s=0;s<t;s++)this.values.set(e.g4(),e.g4())}else{if(250!==t)throw new Error(`Unrecognized enum config code: ${t}`);this.debugname=e.gjstr()}}}function S(t){let e=0;t=t.toUpperCase();for(let s=0;s<t.length;s++)e=61*e+t.charCodeAt(s)-32|0;return e}class C{data=null;fileCount=0;fileHash=[];fileName=[];fileUnpackedSize=[];filePackedSize=[];filePos=[];unpacked=!1;fileQueue=[];fileWrite=[];static async load(t){return new C(await f.load(t))}constructor(t){if(!t)return;const e=t.g3(),s=t.g3();e===s?(this.data=new Uint8Array(t.data),this.unpacked=!1):(this.data=new Uint8Array(d.read(e,t.data,s,6)),t=new f(this.data),this.unpacked=!0),this.fileCount=t.g2();let n=t.pos+10*this.fileCount;for(let e=0;e<this.fileCount;e++){this.fileHash[e]=t.g4();const s=R.findIndex((t=>t===this.fileHash[e]));-1!==s&&(this.fileName[e]=w[s]),this.fileUnpackedSize[e]=t.g3(),this.filePackedSize[e]=t.g3(),this.filePos[e]=n,n+=this.filePackedSize[e]}}get(t){if(t<0||t>=this.fileCount)return null;if(null===this.data)throw new Error('Jagfile data is not loaded');const e=this.data.subarray(this.filePos[t],this.filePos[t]+this.filePackedSize[t]);return this.unpacked?new f(e):new f(Uint8Array.from(d.read(this.fileUnpackedSize[t],this.data,this.filePackedSize[t],this.filePos[t])))}read(t){const e=S(t);for(let t=0;t<this.fileCount;t++)if(this.fileHash[t]===e)return this.get(t);return null}write(t,e){const s=S(t);this.fileQueue.push({hash:s,name:t,write:!0,data:e.data.subarray(0,e.pos)})}delete(t){const e=S(t);this.fileQueue.push({hash:e,name:t,delete:!0})}rename(t,e){const s=S(t),n=S(e);this.fileQueue.push({hash:s,name:t,rename:!0,newName:e,newHash:n})}save(t,e=!1){let s=f.alloc(5);for(let t=0;t<this.fileQueue.length;t++){const e=this.fileQueue[t];let s=this.fileHash.findIndex((t=>t===e.hash));if(e.write){if(-1===s&&(s=this.fileCount++,this.fileHash[s]=e.hash,this.fileName[s]=e.name),!e.data)throw new Error('Cannot write without data');this.fileUnpackedSize[s]=e.data.length,this.filePackedSize[s]=e.data.length,this.filePos[s]=-1,this.fileWrite[s]=e.data}if(e.delete&&-1!==s&&(this.fileHash.splice(s,1),this.fileName.splice(s,1),this.fileUnpackedSize.splice(s,1),this.filePackedSize.splice(s,1),this.filePos.splice(s,1),this.fileCount--),e.rename&&-1!==s){if(!e.newHash)throw new Error('Cannot rename without newHash');if(!e.newName)throw new Error('Cannot rename without newName');this.fileHash[s]=e.newHash,this.fileName[s]=e.newName}this.fileQueue.splice(t,1),t--}let n=1===this.fileCount;e&&n&&(n=!1),s.p2(this.fileCount);for(let t=0;t<this.fileCount;t++)s.p4(this.fileHash[t]),s.p3(this.fileUnpackedSize[t]),this.fileWrite[t]&&!n&&(this.fileWrite[t]=BZip2.compress(this.fileWrite[t],!1,!0),this.filePackedSize[t]=this.fileWrite[t].length),s.p3(this.filePackedSize[t]);for(let t=0;t<this.fileCount;t++){const e=this.fileWrite[t];s.pdata(e,0,e.length)}const i=f.alloc(5);i.p3(s.pos),n&&(s=new f(BZip2.compress(s.data,!1,!0))),n?(i.p3(s.data.length),i.pdata(s.data,0,s.data.length)):(i.p3(s.pos),i.pdata(s.data,0,s.pos)),i.save(t),s.release(),i.release()}deconstruct(t){const e=this.read(t+'.dat'),s=this.read(t+'.idx');if(null===e||null===s)throw new Error('Failed to read dat or idx');const n=s.g2(),i=new Array(n),a=new Array(n);let r=2;for(let t=0;t<n;t++)i[t]=s.g2(),a[t]=r,r+=i[t];const o=new Array(n);for(let t=0;t<n;t++)e.pos=a[t],o[t]=f.getcrc(e.data,r,i[t]);return{count:n,sizes:i,offsets:a,checksums:o}}}var y,v,w=['index.dat','logo.dat','p11.dat','p12.dat','b12.dat','q8.dat','runes.dat','title.dat','titlebox.dat','titlebutton.dat','p11_full.dat','p12_full.dat','b12_full.dat','q8_full.dat','flo.dat','flo.idx','idk.dat','idk.idx','loc.dat','loc.idx','npc.dat','npc.idx','obj.dat','obj.idx','seq.dat','seq.idx','spotanim.dat','spotanim.idx','varp.dat','varp.idx','varbit.dat','varbit.idx','mesanim.dat','mesanim.idx','mes.dat','mes.idx','param.dat','param.idx','hunt.dat','hunt.idx','data','backbase1.dat','backbase2.dat','backhmid1.dat','backhmid2.dat','backleft1.dat','backleft2.dat','backright1.dat','backright2.dat','backtop1.dat','backtop2.dat','backvmid1.dat','backvmid2.dat','backvmid3.dat','chatback.dat','combatboxes.dat','combaticons.dat','combaticons2.dat','combaticons3.dat','compass.dat','cross.dat','gnomeball_buttons.dat','headicons.dat','hitmarks.dat','invback.dat','leftarrow.dat','magicoff.dat','magicoff2.dat','magicon.dat','magicon2.dat','mapback.dat','mapdots.dat','mapflag.dat','mapfunction.dat','mapscene.dat','miscgraphics.dat','miscgraphics2.dat','miscgraphics3.dat','prayerglow.dat','prayeroff.dat','prayeron.dat','redstone1.dat','redstone2.dat','redstone3.dat','rightarrow.dat','scrollbar.dat','sideicons.dat','staticons.dat','staticons2.dat','steelborder.dat','steelborder2.dat','sworddecor.dat','tradebacking.dat','wornicons.dat','mapmarker.dat','mod_icons.dat','mapedge.dat','blackmark.dat','button_brown.dat','button_brown_big.dat','button_red.dat','chest.dat','coins.dat','headicons_hint.dat','headicons_pk.dat','headicons_prayer.dat','key.dat','keys.dat','leftarrow_small.dat','letter.dat','number_button.dat','overlay_duel.dat','overlay_multiway.dat','pen.dat','rightarrow_small.dat','startgame.dat','tex_brown.dat','tex_red.dat','titlescroll.dat','base_head.dat','base_label.dat','base_type.dat','frame_del.dat','frame_head.dat','frame_tran1.dat','frame_tran2.dat','ob_axis.dat','ob_face1.dat','ob_face2.dat','ob_face3.dat','ob_face4.dat','ob_face5.dat','ob_head.dat','ob_point1.dat','ob_point2.dat','ob_point3.dat','ob_point4.dat','ob_point5.dat','ob_vertex1.dat','ob_vertex2.dat','anim_crc','anim_index','anim_version','map_crc','map_index','map_version','midi_crc','midi_index','midi_version','model_crc','model_index','model_version','0.dat','1.dat','2.dat','3.dat','4.dat','5.dat','6.dat','7.dat','8.dat','9.dat','10.dat','11.dat','12.dat','13.dat','14.dat','15.dat','16.dat','17.dat','18.dat','19.dat','20.dat','21.dat','22.dat','23.dat','24.dat','25.dat','26.dat','27.dat','28.dat','29.dat','30.dat','31.dat','32.dat','33.dat','34.dat','35.dat','36.dat','37.dat','38.dat','39.dat','40.dat','41.dat','42.dat','43.dat','44.dat','45.dat','46.dat','47.dat','48.dat','49.dat','badenc.txt','domainenc.txt','fragmentsenc.txt','tldlist.txt','sounds.dat','labels.dat','floorcol.dat','underlay.dat','overlay.dat','size.dat'],R=[];for(let t=0;t<w.length;t++)R[t]=S(w[t]);class b{static CHAR_LOOKUP=[];static instances=[];static{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"Â£$%^&*()-_=+[{]};:'@#~,<.>/?\\| ";for(let e=0;e<256;e++){let s=t.indexOf(String.fromCharCode(e));-1==s&&(s=74),b.CHAR_LOOKUP[e]=s}}static async load(t){const e=await C.load(`${t}/client/title`);b.instances[0]=new b(e,'p11'),b.instances[1]=new b(e,'p12'),b.instances[2]=new b(e,'b12'),b.instances[3]=new b(e,'q8')}static get(t){return b.instances[t]}static get count(){return this.instances.length}charMask=new Array(94);charMaskWidth=new Uint8Array(94);charMaskHeight=new Uint8Array(94);charOffsetX=new Uint8Array(94);charOffsetY=new Uint8Array(94);charAdvance=new Uint8Array(95);drawWidth=new Uint8Array(256);height=0;constructor(t,e){const s=t.read(`${e}.dat`),n=t.read('index.dat');if(!s||!n)return;n.pos=s.g2()+4;const i=n.g1();i>0&&(n.pos+=3*(i-1));for(let t=0;t<94;t++){this.charOffsetX[t]=n.g1(),this.charOffsetY[t]=n.g1();const e=this.charMaskWidth[t]=n.g2(),i=this.charMaskHeight[t]=n.g2(),a=n.g1(),r=e*i;if(this.charMask[t]=new Uint8Array(r),0==a)for(let e=0;e<r;e++)this.charMask[t][e]=s.g1();else if(1==a)for(let n=0;n<e;n++)for(let a=0;a<i;a++)this.charMask[t][n+a*e]=s.g1();i>this.height&&(this.height=i),this.charOffsetX[t]=1,this.charAdvance[t]=e+2;let o=0;for(let s=Math.floor(i/7);s<i;s++)o+=this.charMask[t][s*e];o<=Math.floor(i/7)&&(this.charAdvance[t]--,this.charOffsetX[t]=0),o=0;for(let s=Math.floor(i/7);s<i;s++)o+=this.charMask[t][e+s*e-1];o<=Math.floor(i/7)&&this.charAdvance[t]--}this.charAdvance[94]=this.charAdvance[8];for(let t=0;t<256;t++)this.drawWidth[t]=this.charAdvance[b.CHAR_LOOKUP[t]]}stringWidth(t){if(null==t)return 0;let e=0;for(let s=0;s<t.length;s++)'@'==t.charAt(s)&&s+4<t.length&&'@'==t.charAt(s+4)?s+=4:e+=this.drawWidth[t.charCodeAt(s)];return e}split(t,e){if(0===t.length)return[t];const s=[];for(;t.length>0;){if(this.stringWidth(t)<=e&&-1===t.indexOf('|')){s.push(t);break}let n=t.length;for(let s=0;s<t.length;s++)if(' '===t[s]){if(this.stringWidth(t.substring(0,s))>e)break;n=s}else if('|'===t[s]){n=s;break}s.push(t.substring(0,n)),t=t.substring(n+1)}return s}}(v=y||={})[v.OFF=0]='OFF',v[v.OUTSIDE_WILDERNESS=1]='OUTSIDE_WILDERNESS';var U,D,M=y;(D=U||={})[D.OFF=0]='OFF',D[D.PLAYER=1]='PLAYER',D[D.NPC=2]='NPC',D[D.OBJ=3]='OBJ',D[D.SCENERY=4]='SCENERY';var k,x,B=U;(x=k||={})[x.KEEPHUNTING=0]='KEEPHUNTING',x[x.PAUSEHUNT=1]='PAUSEHUNT';var H,F,G=k;(F=H||={})[F.OFF=0]='OFF',F[F.LINEOFSIGHT=1]='LINEOFSIGHT',F[F.LINEOFWALK=2]='LINEOFWALK';var W,z,V=H;(z=W||={})[z.NULL=-1]='NULL',z[z.NONE=0]='NONE',z[z.WANDER=1]='WANDER',z[z.PATROL=2]='PATROL',z[z.PLAYERESCAPE=3]='PLAYERESCAPE',z[z.PLAYERFOLLOW=4]='PLAYERFOLLOW',z[z.PLAYERFACE=5]='PLAYERFACE',z[z.PLAYERFACECLOSE=6]='PLAYERFACECLOSE',z[z.OPPLAYER1=7]='OPPLAYER1',z[z.OPPLAYER2=8]='OPPLAYER2',z[z.OPPLAYER3=9]='OPPLAYER3',z[z.OPPLAYER4=10]='OPPLAYER4',z[z.OPPLAYER5=11]='OPPLAYER5',z[z.APPLAYER1=12]='APPLAYER1',z[z.APPLAYER2=13]='APPLAYER2',z[z.APPLAYER3=14]='APPLAYER3',z[z.APPLAYER4=15]='APPLAYER4',z[z.APPLAYER5=16]='APPLAYER5',z[z.OPLOC1=17]='OPLOC1',z[z.OPLOC2=18]='OPLOC2',z[z.OPLOC3=19]='OPLOC3',z[z.OPLOC4=20]='OPLOC4',z[z.OPLOC5=21]='OPLOC5',z[z.APLOC1=22]='APLOC1',z[z.APLOC2=23]='APLOC2',z[z.APLOC3=24]='APLOC3',z[z.APLOC4=25]='APLOC4',z[z.APLOC5=26]='APLOC5',z[z.OPOBJ1=27]='OPOBJ1',z[z.OPOBJ2=28]='OPOBJ2',z[z.OPOBJ3=29]='OPOBJ3',z[z.OPOBJ4=30]='OPOBJ4',z[z.OPOBJ5=31]='OPOBJ5',z[z.APOBJ1=32]='APOBJ1',z[z.APOBJ2=33]='APOBJ2',z[z.APOBJ3=34]='APOBJ3',z[z.APOBJ4=35]='APOBJ4',z[z.APOBJ5=36]='APOBJ5',z[z.OPNPC1=37]='OPNPC1',z[z.OPNPC2=38]='OPNPC2',z[z.OPNPC3=39]='OPNPC3',z[z.OPNPC4=40]='OPNPC4',z[z.OPNPC5=41]='OPNPC5',z[z.APNPC1=42]='APNPC1',z[z.APNPC2=43]='APNPC2',z[z.APNPC3=44]='APNPC3',z[z.APNPC4=45]='APNPC4',z[z.APNPC5=46]='APNPC5',z[z.QUEUE1=47]='QUEUE1',z[z.QUEUE2=48]='QUEUE2',z[z.QUEUE3=49]='QUEUE3',z[z.QUEUE4=50]='QUEUE4',z[z.QUEUE5=51]='QUEUE5',z[z.QUEUE6=52]='QUEUE6',z[z.QUEUE7=53]='QUEUE7',z[z.QUEUE8=54]='QUEUE8',z[z.QUEUE9=55]='QUEUE9',z[z.QUEUE10=56]='QUEUE10',z[z.QUEUE11=57]='QUEUE11',z[z.QUEUE12=58]='QUEUE12',z[z.QUEUE13=59]='QUEUE13',z[z.QUEUE14=60]='QUEUE14',z[z.QUEUE15=61]='QUEUE15',z[z.QUEUE16=62]='QUEUE16',z[z.QUEUE17=63]='QUEUE17',z[z.QUEUE18=64]='QUEUE18',z[z.QUEUE19=65]='QUEUE19',z[z.QUEUE20=66]='QUEUE20';var Y=W;class K extends A{static configNames=new Map;static configs=[];static async load(t){if(K.configNames=new Map,K.configs=[],!(await fetch(`${t}/server/hunt.dat`)).ok)return void console.log('Warning: No hunt.dat found.');const e=await f.load(`${t}/server/hunt.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new K(t);s.decodeType(e),K.configs[t]=s,s.debugname&&K.configNames.set(s.debugname,t)}}static get(t){return K.configs[t]}static getId(t){return K.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=B.OFF;checkVis=V.OFF;checkNotTooStrong=M.OFF;checkNotBusy=!1;findKeepHunting=!1;findNewMode=Y.NONE;nobodyNear=G.PAUSEHUNT;checkNotCombat=-1;checkNotCombatSelf=-1;checkAfk=!0;rate=1;checkCategory=-1;checkNpc=-1;checkObj=-1;checkLoc=-1;checkInv=-1;checkObjParam=-1;checkInvMinQuantity=-1;checkInvMaxQuantity=-1;decode(t,e){if(1===t)this.type=e.g1();else if(2==t)this.checkVis=e.g1();else if(3==t)this.checkNotTooStrong=e.g1();else if(4==t)this.checkNotBusy=!0;else if(5==t)this.findKeepHunting=!0;else if(6==t)this.findNewMode=e.g1();else if(7==t)this.nobodyNear=e.g1();else if(8===t)this.checkNotCombat=e.g2();else if(9===t)this.checkNotCombatSelf=e.g2();else if(10===t)this.checkAfk=!1;else if(11===t)this.rate=e.g2();else if(12===t)this.checkCategory=e.g2();else if(13===t)this.checkNpc=e.g2();else if(14===t)this.checkObj=e.g2();else if(15===t)this.checkLoc=e.g2();else if(16===t)this.checkInv=e.g2(),this.checkObj=e.g2(),this.checkInvMinQuantity=e.g4(),this.checkInvMaxQuantity=e.g4();else if(17===t)this.checkInv=e.g2(),this.checkObjParam=e.g2(),this.checkInvMinQuantity=e.g4(),this.checkInvMaxQuantity=e.g4();else{if(250!==t)throw new Error(`Unrecognized hunt config code: ${t}`);this.debugname=e.gjstr()}}}class j extends A{static configNames=new Map;static configs=[];static async load(t){if(j.configNames=new Map,j.configs=[],!(await fetch(`${t}/server/idk.dat`)).ok)return void console.log('Warning: No idk.dat found.');const e=await f.load(`${t}/server/idk.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('idk.dat');n.pos=2;for(let t=0;t<s;t++){const s=new j(t);s.decodeType(e),s.decodeType(n),j.configs[t]=s,s.debugname&&j.configNames.set(s.debugname,t)}}static get(t){return j.configs[t]}static getId(t){return j.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=-1;models=null;heads=new Uint16Array(5).fill(-1);recol_s=new Uint16Array(6).fill(0);recol_d=new Uint16Array(6).fill(0);disable=!1;decode(t,e){if(1===t)this.type=e.g1();else if(2===t){const t=e.g1();this.models=new Uint16Array(t);for(let s=0;s<t;s++)this.models[s]=e.g2()}else if(3===t)this.disable=!0;else if(t>=40&&t<50)this.recol_s[t-40]=e.g2();else if(t>=50&&t<60)this.recol_d[t-50]=e.g2();else if(t>=60&&t<70)this.heads[t-60]=e.g2();else{if(250!==t)throw new Error(`Unrecognized idk config code: ${t}`);this.debugname=e.gjstr()}}}class Z{static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INVENTORY=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_SPRITE=5;static TYPE_MODEL=6;static TYPE_INVENTORY_TEXT=7;static NO_BUTTON=0;static BUTTON=1;static TARGET_BUTTON=2;static CLOSE_BUTTON=3;static TOGGLE_BUTTON=4;static SELECT_BUTTON=5;static PAUSE_BUTTON=6;static componentNames=new Map;static components=[];static async load(t){if(this.componentNames=new Map,this.components=[],!(await fetch(`${t}/server/interface.dat`)).ok)return void console.log('Warning: No interface.dat found.');const e=await f.load(`${t}/server/interface.dat`);e.g2();let s=-1;for(;e.available>0;){let t=e.g2();65535===t&&(s=e.g2(),t=e.g2());const n=new Z;n.id=t,n.rootLayer=s,n.comName=e.gjstr(),n.overlay=e.gbool(),n.type=e.g1(),n.buttonType=e.g1(),n.clientCode=e.g2(),n.width=e.g2(),n.height=e.g2(),n.overLayer=e.g1(),0==n.overLayer?n.overLayer=-1:n.overLayer=(n.overLayer-1<<8)+e.g1();const i=e.g1();if(i>0){n.scriptComparator=new Uint8Array(i).fill(0),n.scriptOperand=new Uint16Array(i).fill(0);for(let t=0;t<i;t++)n.scriptComparator[t]=e.g1(),n.scriptOperand[t]=e.g2()}const a=e.g1();if(a>0){n.scripts=new Array(a).fill(null);for(let t=0;t<a;t++){const s=e.g2();n.scripts[t]=new Uint16Array(s).fill(0);for(let i=0;i<s;i++)n.scripts[t][i]=e.g2()}}switch(n.type){case Z.TYPE_LAYER:{n.scroll=e.g2(),n.hide=e.gbool();const t=e.g1();n.childId=new Uint16Array(t).fill(0),n.childX=new Uint16Array(t).fill(0),n.childY=new Uint16Array(t).fill(0);for(let s=0;s<t;s++)n.childId[s]=e.g2(),n.childX[s]=e.g2s(),n.childY[s]=e.g2s();break}case Z.TYPE_UNUSED:e.pos+=10;break;case Z.TYPE_INVENTORY:n.draggable=e.gbool(),n.interactable=e.gbool(),n.usable=e.gbool(),n.marginX=e.g1(),n.marginY=e.g1(),n.inventorySlotOffsetX=new Uint16Array(20).fill(0),n.inventorySlotOffsetY=new Uint16Array(20).fill(0),n.inventorySlotGraphic=new Array(20).fill(null);for(let t=0;t<20;t++)e.gbool()&&(n.inventorySlotOffsetX[t]=e.g2s(),n.inventorySlotOffsetY[t]=e.g2s(),n.inventorySlotGraphic[t]=e.gjstr());n.inventoryOptions=new Array(5).fill(null);for(let t=0;t<5;t++)n.inventoryOptions[t]=e.gjstr();n.actionVerb=e.gjstr(),n.action=e.gjstr(),n.actionTarget=e.g2();break;case Z.TYPE_RECT:n.fill=e.gbool(),n.colour=e.g4(),n.activeColour=e.g4(),n.overColour=e.g4();break;case Z.TYPE_TEXT:n.center=e.gbool(),n.font=e.g1(),n.shadowed=e.gbool(),n.text=e.gjstr(),n.activeText=e.gjstr(),n.colour=e.g4(),n.activeColour=e.g4(),n.overColour=e.g4();break;case Z.TYPE_SPRITE:n.graphic=e.gjstr(),n.activeGraphic=e.gjstr();break;case Z.TYPE_MODEL:n.model=e.g1(),0!=n.model&&(n.model=(n.model-1<<8)+e.g1()),n.activeModel=e.g1(),0!=n.activeModel&&(n.activeModel=(n.activeModel-1<<8)+e.g1()),n.anim=e.g1(),0==n.anim?n.anim=-1:n.anim=(n.anim-1<<8)+e.g1(),n.activeAnim=e.g1(),0==n.activeAnim?n.activeAnim=-1:n.activeAnim=(n.activeAnim-1<<8)+e.g1(),n.zoom=e.g2(),n.xan=e.g2(),n.yan=e.g2();break;case Z.TYPE_INVENTORY_TEXT:n.center=e.gbool(),n.font=e.g1(),n.shadowed=e.gbool(),n.colour=e.g4(),n.marginX=e.g2s(),n.marginY=e.g2s(),n.interactable=e.gbool(),n.inventoryOptions=new Array(5).fill(null);for(let t=0;t<5;t++)n.inventoryOptions[t]=e.gjstr()}switch(n.buttonType){case Z.NO_BUTTON:break;case Z.TARGET_BUTTON:n.actionVerb=e.gjstr(),n.action=e.gjstr(),n.actionTarget=e.g2();break;case Z.BUTTON:case Z.TOGGLE_BUTTON:case Z.SELECT_BUTTON:case Z.PAUSE_BUTTON:n.option=e.gjstr()}Z.components[t]=n,n.comName&&Z.componentNames.set(n.comName,t)}}static get(t){return Z.components[t]}static getId(t){return Z.componentNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}id=-1;rootLayer=-1;comName=null;overlay=!1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;inventorySlotOffsetX=null;inventorySlotOffsetY=null;inventorySlotGraphic=null;inventoryOptions=null;fill=!1;center=!1;font=0;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=-1;activeModel=-1;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null}class J extends A{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static SCOPE_SHARED=2;static INV=-1;static WORN=-1;static async load(t){if(J.configNames=new Map,J.configs=[],!(await fetch(`${t}/server/inv.dat`)).ok)return void console.log('Warning: No inv.dat found.');const e=await f.load(`${t}/server/inv.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new J(t);s.decodeType(e),J.configs[t]=s,s.debugname&&J.configNames.set(s.debugname,t)}J.INV=J.getId('inv'),J.WORN=J.getId('worn')}static get(t){return J.configs[t]}static getId(t){return J.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}scope=0;size=1;stackall=!1;restock=!1;allstock=!1;stockobj=null;stockcount=null;stockrate=null;protect=!0;runweight=!1;dummyinv=!1;decode(t,e){if(1===t)this.scope=e.g1();else if(2===t)this.size=e.g2();else if(3===t)this.stackall=!0;else if(4===t){const t=e.g1();this.stockobj=new Uint16Array(t),this.stockcount=new Uint16Array(t),this.stockrate=new Int32Array(t);for(let s=0;s<t;s++)this.stockobj[s]=e.g2(),this.stockcount[s]=e.g2(),this.stockrate[s]=e.g4()}else if(5===t)this.restock=!0;else if(6===t)this.allstock=!0;else if(7===t)this.protect=!1;else if(8===t)this.runweight=!0;else if(9===t)this.dummyinv=!0;else{if(250!==t)throw new Error(`Unrecognized inv config code: ${t}`);this.debugname=e.gjstr()}}}var $,X,Q=function(t,e,s){const n=e.params?.get(t);return'string'!=typeof n?s??'null':n},q=function(t,e,s){const n=e.params?.get(t);return'number'!=typeof n?s:n},tt=function(t){const e=t.g1(),s=new Map;for(let n=0;n<e;n++){const e=t.g3();t.gbool()?s.set(e,t.gjstr()):s.set(e,t.g4())}return s};class et extends A{static configNames=new Map;static configs=[];static async load(t){if(et.configNames=new Map,et.configs=[],!(await fetch(`${t}/server/loc.dat`)).ok)return void console.log('Warning: No loc.dat found.');const e=await f.load(`${t}/server/loc.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('loc.dat');n.pos=2;for(let t=0;t<s;t++){const s=new et(t);s.active=-1,s.decodeType(e),s.decodeType(n),-1===s.active&&s.shapes&&(s.active=s.shapes.length>0&&10===s.shapes[0]?1:0,s.op&&s.op.length>0&&(s.active=1)),et.configs[t]=s,s.debugname&&et.configNames.set(s.debugname,t)}}static get(t){return et.configs[t]}static getId(t){return et.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return void 0===e||-1===e?null:this.get(e)}static get count(){return this.configs.length}models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=0;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;hasalpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;xoff=0;yoff=0;zoff=0;forcedecor=!1;category=-1;params=new Map;decode(t,e){if(1===t){const t=e.g1();this.models=new Uint16Array(t),this.shapes=new Uint8Array(t);for(let s=0;s<t;s++)this.models[s]=e.g2(),this.shapes[s]=e.g1()}else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(14===t)this.width=e.g1();else if(15===t)this.length=e.g1();else if(17===t)this.blockwalk=!1;else if(18===t)this.blockrange=!1;else if(19===t)this.active=e.g1();else if(21===t)this.hillskew=!0;else if(22===t)this.sharelight=!0;else if(23===t)this.occlude=!0;else if(24===t)this.anim=e.g2(),65535==this.anim&&(this.anim=-1);else if(25===t)this.hasalpha=!0;else if(28===t)this.wallwidth=e.g1();else if(29===t)this.ambient=e.g1b();else if(39===t)this.contrast=e.g1b();else if(t>=30&&t<35)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr(),'hidden'===this.op[t-30]&&(this.op[t-30]=null);else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let s=0;s<t;s++)this.recol_s[s]=e.g2(),this.recol_d[s]=e.g2()}else if(60===t)this.mapfunction=e.g2();else if(62===t)this.mirror=!0;else if(64===t)this.shadow=!1;else if(65===t)this.resizex=e.g2();else if(66===t)this.resizey=e.g2();else if(67===t)this.resizez=e.g2();else if(68===t)this.mapscene=e.g2();else if(69===t)this.forceapproach=e.g1();else if(70===t)this.xoff=e.g2s();else if(71===t)this.yoff=e.g2s();else if(72===t)this.zoff=e.g2s();else if(73===t)this.forcedecor=!0;else if(200===t)this.category=e.g2();else if(249===t)this.params=tt(e);else{if(250!==t)throw new Error(`Unrecognized loc config code: ${t}`);this.debugname=e.gjstr()}}}class st extends A{static configNames=new Map;static configs=[];static async load(t){if(st.configNames=new Map,st.configs=[],!(await fetch(`${t}/server/mesanim.dat`)).ok)return void console.log('Warning: No mesanim.dat found.');const e=await f.load(`${t}/server/mesanim.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new st(t);s.decodeType(e),st.configs[t]=s,s.debugname&&st.configNames.set(s.debugname,t)}}static get(t){return st.configs[t]}static getId(t){return st.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}len=new Array(4).fill(-1);decode(t,e){if(t>=1&&t<5)this.len[t-1]=e.g2();else{if(250!==t)throw new Error(`Unrecognized mesanim config code: ${t}`);this.debugname=e.gjstr()}}}(X=$||={})[X.NONE=0]='NONE',X[X.NPC=1]='NPC',X[X.ALL=2]='ALL';var nt,it,at=$;(it=nt||={})[it.NORMAL=0]='NORMAL',it[it.BLOCKED=1]='BLOCKED',it[it.BLOCKED_NORMAL=2]='BLOCKED_NORMAL',it[it.INDOORS=3]='INDOORS',it[it.OUTDOORS=4]='OUTDOORS',it[it.NOMOVE=5]='NOMOVE',it[it.PASSTHRU=6]='PASSTHRU';var rt,ot,ct=nt;(ot=rt||={})[ot.ATTACK=0]='ATTACK',ot[ot.DEFENCE=1]='DEFENCE',ot[ot.STRENGTH=2]='STRENGTH',ot[ot.HITPOINTS=3]='HITPOINTS',ot[ot.RANGED=4]='RANGED',ot[ot.MAGIC=5]='MAGIC';var lt=rt;class ht extends A{static configNames=new Map;static configs=[];static async load(t){if(ht.configNames=new Map,ht.configs=[],!(await fetch(`${t}/server/npc.dat`)).ok)return void console.log('Warning: No npc.dat found.');const e=await f.load(`${t}/server/npc.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('npc.dat');n.pos=2;for(let t=0;t<s;t++){const s=new ht(t);s.decodeType(e),s.decodeType(n),ht.configs[t]=s,s.debugname&&ht.configNames.set(s.debugname,t)}}static get(t){return ht.configs[t]}static getId(t){return ht.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}name=null;desc=null;size=1;models=null;heads=null;hasanim=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;hasalpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;category=-1;wanderrange=5;maxrange=10;huntrange=5;timer=-1;respawnrate=100;stats=[1,1,1,1,1,1];moverestrict=ct.NORMAL;attackrange=7;huntmode=-1;defaultmode=Y.WANDER;members=!1;blockwalk=at.NPC;params=new Map;patrolCoord=[];patrolDelay=[];givechase=!0;decode(t,e){if(1===t){const t=e.g1();this.models=new Uint16Array(t);for(let s=0;s<t;s++)this.models[s]=e.g2()}else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(12===t)this.size=e.g1();else if(13===t)this.readyanim=e.g2();else if(14===t)this.walkanim=e.g2();else if(16===t)this.hasanim=!0;else if(17===t)this.walkanim=e.g2(),this.walkanim_b=e.g2(),this.walkanim_r=e.g2(),this.walkanim_l=e.g2();else if(18===t)this.category=e.g2();else if(t>=30&&t<40)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr(),'hidden'===this.op[t-30]&&(this.op[t-30]=null);else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let s=0;s<t;s++)this.recol_s[s]=e.g2(),this.recol_d[s]=e.g2()}else if(60===t){const t=e.g1();this.heads=new Uint16Array(t);for(let s=0;s<t;s++)this.heads[s]=e.g2()}else if(74===t)this.stats[lt.ATTACK]=e.g2();else if(75===t)this.stats[lt.DEFENCE]=e.g2();else if(76===t)this.stats[lt.STRENGTH]=e.g2();else if(77===t)this.stats[lt.HITPOINTS]=e.g2();else if(78===t)this.stats[lt.RANGED]=e.g2();else if(79===t)this.stats[lt.MAGIC]=e.g2();else if(90===t)this.resizex=e.g2();else if(91===t)this.resizey=e.g2();else if(92===t)this.resizez=e.g2();else if(93===t)this.minimap=!1;else if(95===t)this.vislevel=e.g2();else if(97===t)this.resizeh=e.g2();else if(98===t)this.resizev=e.g2();else if(200===t)this.wanderrange=e.g1();else if(201===t)this.maxrange=e.g1();else if(202===t)this.huntrange=e.g1();else if(203===t)this.timer=e.g2();else if(204===t)this.respawnrate=e.g2();else if(206===t)this.moverestrict=e.g1();else if(207==t)this.attackrange=e.g1();else if(208===t)this.blockwalk=e.g1();else if(209===t)this.huntmode=e.g1();else if(210===t)this.defaultmode=e.g1();else if(211===t)this.members=!0;else if(212===t){const t=e.g1();this.patrolCoord=new Array(t),this.patrolDelay=new Array(t);for(let s=0;s<t;s++)this.patrolCoord[s]=e.g4(),this.patrolDelay[s]=e.g1()}else 213===t?this.givechase=!1:249===t?this.params=tt(e):250===t?this.debugname=e.gjstr():(console.error('Unrecognized npc config code: '+t),console.error('Try `npm run build` and report an issue if this still happens.'),process.exit(1))}}class dt extends A{static configNames=new Map;static configs=[];static async load(t){dt.configNames=new Map,dt.configs=[],(await fetch(`${t}/server/param.dat`)).ok||console.log('Warning: No param.dat found.');const e=await f.load(`${t}/server/param.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new dt(t);s.decodeType(e),dt.configs[t]=s,s.debugname&&dt.configNames.set(s.debugname,t)}}static get(t){return dt.configs[t]}static getId(t){return dt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=I.INT;defaultInt=-1;defaultString=null;autodisable=!0;decode(t,e){if(1===t)this.type=e.g1();else if(2===t)this.defaultInt=e.g4();else if(4===t)this.autodisable=!1;else if(5===t)this.defaultString=e.gjstr();else{if(250!==t)throw new Error(`Unrecognized param config code: ${t}`);this.debugname=e.gjstr()}}getType(){switch(this.type){case I.INT:return'int';case I.STRING:return'string';case I.ENUM:return'enum';case I.OBJ:return'obj';case I.LOC:return'loc';case I.COMPONENT:return'component';case I.NAMEDOBJ:return'namedobj';case I.STRUCT:return'struct';case I.BOOLEAN:return'boolean';case I.COORD:return'coord';case I.CATEGORY:return'category';case I.SPOTANIM:return'spotanim';case I.NPC:return'npc';case I.INV:return'inv';case I.SYNTH:return'synth';case I.SEQ:return'seq';case I.STAT:return'stat';case I.INTERFACE:return'interface';default:return'unknown'}}isString(){return this.type===I.STRING}get default(){return this.isString()?this.defaultString:this.defaultInt}}var pt,ut,_t={WEB_PORT:80,WEB_CORS:!0,NODE_ID:10,NODE_PORT:43594,NODE_MEMBERS:!0,NODE_XPRATE:1,NODE_PRODUCTION:!1,NODE_KILLTIMER:50,NODE_ALLOW_CHEATS:!0,NODE_DEBUG:!0,NODE_DEBUG_PROFILE:!1,NODE_STAFF:['pazaz'],NODE_CLIENT_ROUTEFINDER:!0,NODE_SOCKET_TIMEOUT:!0,LOGIN_HOST:'localhost',LOGIN_PORT:43500,LOGIN_KEY:'',DB_HOST:'localhost',DB_USER:'root',DB_PASS:'password',DB_NAME:'lostcity',BUILD_JAVA_PATH:'java',BUILD_STARTUP:!0,BUILD_STARTUP_UPDATE:!0,BUILD_VERIFY:!0,BUILD_VERIFY_FOLDER:!0,BUILD_VERIFY_PACK:!0,BUILD_SRC_DIR:'data/src'};class gt extends A{static configNames=new Map;static configs=[];static async load(t){if(gt.configNames=new Map,gt.configs=[],!(await fetch(`${t}/server/obj.dat`)).ok)return void console.log('Warning: No obj.dat found.');const e=await f.load(`${t}/server/obj.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('obj.dat');n.pos=2;for(let t=0;t<s;t++){const s=new gt(t);s.decodeType(e),s.decodeType(n),gt.configs[t]=s,s.debugname&&gt.configNames.set(s.debugname,t)}for(let t=0;t<s;t++){const e=gt.configs[t];-1!=e.certtemplate&&e.toCertificate(),!_t.NODE_MEMBERS&&e.members&&(e.tradeable=!1,e.op=null,e.iop=null,e.params.forEach(((t,s)=>{dt.get(s)?.autodisable&&e.params.delete(s)})))}}static get(t){return gt.configs[t]}static getId(t){return gt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}static getWearPosId(t){switch(t){case'hat':return 0;case'back':return 1;case'front':return 2;case'righthand':return 3;case'torso':return 4;case'lefthand':return 5;case'arms':return 6;case'legs':return 7;case'head':return 8;case'hands':return 9;case'feet':return 10;case'jaw':return 11;case'ring':return 12;case'quiver':return 13;default:return-1}}model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;wearpos=-1;wearpos2=-1;wearpos3=-1;weight=0;category=-1;dummyitem=0;tradeable=!1;respawnrate=100;params=new Map;decode(t,e){if(1===t)this.model=e.g2();else if(2===t)this.name=e.gjstr();else if(3===t)this.desc=e.gjstr();else if(4===t)this.zoom2d=e.g2();else if(5===t)this.xan2d=e.g2();else if(6===t)this.yan2d=e.g2();else if(7===t)this.xof2d=e.g2s();else if(8===t)this.yof2d=e.g2s();else if(9===t)this.code9=!0;else if(10===t)this.code10=e.g2();else if(11===t)this.stackable=!0;else if(12===t)this.cost=e.g4();else if(13===t)this.wearpos=e.g1();else if(14===t)this.wearpos2=e.g1();else if(16===t)this.members=!0;else if(23===t)this.manwear=e.g2(),this.manwearOffsetY=e.g1b();else if(24===t)this.manwear2=e.g2();else if(25===t)this.womanwear=e.g2(),this.womanwearOffsetY=e.g1b();else if(26===t)this.womanwear2=e.g2();else if(27===t)this.wearpos3=e.g1();else if(t>=30&&t<35)this.op||(this.op=new Array(5).fill(null)),this.op[t-30]=e.gjstr();else if(t>=35&&t<40)this.iop||(this.iop=new Array(5).fill(null)),this.iop[t-35]=e.gjstr();else if(40===t){const t=e.g1();this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let s=0;s<t;s++)this.recol_s[s]=e.g2(),this.recol_d[s]=e.g2()}else if(75===t)this.weight=e.g2s();else if(78===t)this.manwear3=e.g2();else if(79===t)this.womanwear3=e.g2();else if(90===t)this.manhead=e.g2();else if(91===t)this.womanhead=e.g2();else if(92===t)this.manhead2=e.g2();else if(93===t)this.womanhead2=e.g2();else if(94===t)this.category=e.g2();else if(95===t)this.zan2d=e.g2();else if(96===t)this.dummyitem=e.g1();else if(97===t)this.certlink=e.g2();else if(98===t)this.certtemplate=e.g2();else if(t>=100&&t<110)this.countobj&&this.countco||(this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10)),this.countobj[t-100]=e.g2(),this.countco[t-100]=e.g2();else if(200===t)this.tradeable=!0;else if(201===t)this.respawnrate=e.g2();else if(249===t)this.params=tt(e);else{if(250!==t)throw new Error(`Unrecognized obj config code: ${t}`);this.debugname=e.gjstr()}}toCertificate(){const t=gt.get(this.certtemplate);this.model=t.model,this.zoom2d=t.zoom2d,this.xan2d=t.xan2d,this.yan2d=t.yan2d,this.zan2d=t.zan2d,this.xof2d=t.xof2d,this.yof2d=t.yof2d,this.recol_s=t.recol_s,this.recol_d=t.recol_d;const e=gt.get(this.certlink);this.name=e.name,this.members=e.members,this.cost=e.cost,this.tradeable=e.tradeable;let s='a';const n=(e.name||'').toLowerCase().charAt(0);'a'!==n&&'e'!==n&&'i'!==n&&'o'!==n&&'u'!==n||(s='an'),this.desc=`Swap this note at any bank for ${s} ${e.name}.`,this.stackable=!0}}class mt{static instances=[];static async load(t){if(mt.instances=[],!(await fetch(`${t}/server/frame_del.dat`)).ok)return void console.log('Warning: No frame_del.dat found.');const e=await f.load(`${t}/server/frame_del.dat`);for(let t=0;t<e.data.length;t++){const s=new mt;s.delay=e.g1(),mt.instances[t]=s}}delay=0}class Et extends A{static configNames=new Map;static configs=[];static async load(t){if(Et.configNames=new Map,Et.configs=[],!(await fetch(`${t}/server/seq.dat`)).ok)return void console.log('Warning: No seq.dat found.');const e=await f.load(`${t}/server/seq.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('seq.dat');n.pos=2;for(let t=0;t<s;t++){const s=new Et(t);s.decodeType(e),s.decodeType(n),Et.configs[t]=s,s.debugname&&Et.configNames.set(s.debugname,t)}}static get(t){return Et.configs[t]}static getId(t){return Et.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return Et.configs.length}frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;mainhand=-1;offhand=-1;replaycount=99;duration=0;decode(t,e){if(1===t){const t=e.g1();this.frames=new Int32Array(t),this.iframes=new Int32Array(t),this.delay=new Int32Array(t);for(let s=0;s<t;s++)this.frames[s]=e.g2(),this.iframes[s]=e.g2(),65535===this.iframes[s]&&(this.iframes[s]=-1),this.delay[s]=e.g2(),0===this.delay[s]&&(this.delay[s]=mt.instances[this.frames[s]].delay),0===this.delay[s]&&(this.delay[s]=1),this.duration+=this.delay[s]}else if(2===t)this.replayoff=e.g2();else if(3===t){const t=e.g1();this.walkmerge=new Int32Array(t+1);for(let s=0;s<t;s++)this.walkmerge[s]=e.g1();this.walkmerge[t]=9999999}else if(4===t)this.stretches=!0;else if(5===t)this.priority=e.g1();else if(6===t)this.mainhand=e.g2();else if(7===t)this.offhand=e.g2();else if(8===t)this.replaycount=e.g1();else{if(250!==t)throw new Error(`Unrecognized seq config code: ${t}`);this.debugname=e.gjstr()}}}class Ot extends A{static configNames=new Map;static configs=[];static async load(t){if(Ot.configNames=new Map,Ot.configs=[],!(await fetch(`${t}/server/struct.dat`)).ok)return void console.log('Warning: No struct.dat found.');const e=await f.load(`${t}/server/struct.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Ot(t);s.decodeType(e),Ot.configs[t]=s,s.debugname&&Ot.configNames.set(s.debugname,t)}}static get(t){return Ot.configs[t]}static getId(t){return Ot.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}params=null;decode(t,e){if(249===t)this.params=tt(e);else{if(250!==t)throw new Error(`Unrecognized struct config code: ${t}`);this.debugname=e.gjstr()}}}class ft extends A{static configNames=new Map;static configs=[];static async load(t){if(ft.configNames=new Map,ft.configs=[],!(await fetch(`${t}/server/varn.dat`)).ok)return void console.log('Warning: No varn.dat found.');const e=await f.load(`${t}/server/varn.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new ft(t);s.decodeType(e),ft.configs[t]=s,s.debugname&&ft.configNames.set(s.debugname,t)}}static get(t){return ft.configs[t]}static getId(t){return ft.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=I.INT;decode(t,e){1===t?this.type=e.g1():250===t?this.debugname=e.gjstr():console.error(`Unrecognized varn config code: ${t}`)}}class At extends A{static configNames=new Map;static configs=[];static SCOPE_TEMP=0;static SCOPE_PERM=1;static PLAYER_RUN=-1;static TEMP_RUN=-1;static LASTCOMBAT=-1;static async load(t){At.configNames=new Map,At.configs=[],(await fetch(`${t}/server/varp.dat`)).ok||console.log('Warning: No varp.dat found.');const e=await f.load(`${t}/server/varp.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('varp.dat');n.pos=2;for(let t=0;t<s;t++){const s=new At(t);s.decodeType(e),s.decodeType(n),At.configs[t]=s,s.debugname&&At.configNames.set(s.debugname,t)}At.PLAYER_RUN=At.getId('player_run'),At.TEMP_RUN=At.getId('temp_run'),At.LASTCOMBAT=At.getId('lastcombat')}static get(t){return At.configs[t]}static getId(t){return At.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}clientcode=0;scope=At.SCOPE_TEMP;type=I.INT;protect=!0;transmit=!1;decode(t,e){1===t?this.scope=e.g1():2===t?this.type=e.g1():4===t?this.protect=!1:5===t?this.clientcode=e.g2():6===t?this.transmit=!0:250===t?this.debugname=e.gjstr():console.error(`Unrecognized varp config code: ${t}`)}}class Tt extends A{static configNames=new Map;static configs=[];static async load(t){if(Tt.configNames=new Map,Tt.configs=[],!(await fetch(`${t}/server/vars.dat`)).ok)return void console.log('Warning: No vars.dat found.');const e=await f.load(`${t}/server/vars.dat`),s=e.g2();for(let t=0;t<s;t++){const s=new Tt(t);s.decodeType(e),Tt.configs[t]=s,s.debugname&&Tt.configNames.set(s.debugname,t)}}static get(t){return Tt.configs[t]}static getId(t){return Tt.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}type=I.INT;decode(t,e){switch(t){case 1:this.type=e.g1();break;case 250:this.debugname=e.gjstr();break;default:console.error(`Unrecognized vars config code: ${t}`)}}}class It{fragments=[];filter(t){for(let e=0;e<t.length;){const s=this.indexOfNumber(t,e);if(-1===s)return;let n=!1;for(let i=e;i>=0&&i<s&&!n;i++)St.isSymbol(t[i])||St.isNotLowercaseAlpha(t[i])||(n=!0);let i=0;n&&(i=0),0===i&&(i=1,e=s);let a=0;for(let n=s;n<t.length&&n<e;n++)a=10*a+t[n].charCodeAt(0)-48;a<=255&&e-s<=8?i++:i=0,4===i&&(St.maskChars(s,e,t),i=0),e=this.indexOfNonNumber(e,t)}}isBadFragment(t){if(St.isNumericalChars(t))return!0;const e=this.getInteger(t),s=this.fragments,n=s.length;if(e===s[0]||e===s[n-1])return!0;let i=0,a=n-1;for(;i<=a;){const t=(i+a)/2|0;if(e===s[t])return!0;e<s[t]?a=t-1:i=t+1}return!1}getInteger(t){if(t.length>6)return 0;let e=0;for(let s=0;s<t.length;s++){const n=t[t.length-s-1];if(St.isLowercaseAlpha(n))e=38*e+n.charCodeAt(0)+1-'a'.charCodeAt(0);else if("'"==n)e=38*e+27;else if(St.isNumerical(n))e=38*e+n.charCodeAt(0)+28-'0'.charCodeAt(0);else if('\0'!=n)return 0}return e}indexOfNumber(t,e){for(let s=e;s<t.length&&s>=0;s++)if(St.isNumerical(t[s]))return s;return-1}indexOfNonNumber(t,e){for(let s=t;s<e.length&&s>=0;s++)if(!St.isNumerical(e[s]))return s;return e.length}}class Nt{wordEncFragments;bads=[];badCombinations=[];constructor(t){this.wordEncFragments=t}filter(t){for(let e=0;e<2;e++)for(let e=this.bads.length-1;e>=0;e--)this.filterBadCombinations(this.badCombinations[e],t,this.bads[e])}filterBadCombinations(t,e,s){if(!(s.length>e.length))for(let n=0;n<=e.length-s.length;n++){let i=n;const{currentIndex:a,badIndex:r,hasSymbol:o,hasNumber:c,hasDigit:l}=this.processBadCharacters(e,s,i);i=a;let h=e[i],d=i+1<e.length?e[i+1]:'\0';if(!(r>=s.length)||c&&l)continue;let p,u=!0;if(o){let t=!1,s=!1;if((n-1<0||St.isSymbol(e[n-1])&&"'"!=e[n-1])&&(t=!0),(i>=e.length||St.isSymbol(e[i])&&"'"!=e[i])&&(s=!0),!t||!s){let s=!1;for(p=n-2,t&&(p=n);!s&&p<i;){if(p>=0&&(!St.isSymbol(e[p])||"'"==e[p])){const t=[];let n;for(n=0;n<3&&p+n<e.length&&(!St.isSymbol(e[p+n])||"'"==e[p+n]);n++)t[n]=e[p+n];let i=!0;0==n&&(i=!1),n<3&&p-1>=0&&(!St.isSymbol(e[p-1])||"'"==e[p-1])&&(i=!1),i&&!this.wordEncFragments.isBadFragment(t)&&(s=!0)}p++}s||(u=!1)}}else{h=' ',n-1>=0&&(h=e[n-1]),d=' ',i<e.length&&(d=e[i]);const s=this.getIndex(h),a=this.getIndex(d);null!=t&&this.comboMatches(s,t,a)&&(u=!1)}if(!u)continue;let _=0,g=0;for(let t=n;t<i;t++)St.isNumerical(e[t])?_++:St.isAlpha(e[t])&&g++;_<=g&&St.maskChars(n,i,e)}}processBadCharacters(t,e,s){let n=s,i=0,a=0,r=!1,o=!1,c=!1;for(;n<t.length&&(!o||!c)&&!(n>=t.length||o&&c);){const l=t[n],h=n+1<t.length?t[n+1]:'\0';let d;if(i<e.length&&(d=this.getEmulatedBadCharLen(h,String.fromCharCode(e[i]),l))>0)1===d&&St.isNumerical(l)&&(o=!0),2===d&&(St.isNumerical(l)||St.isNumerical(h))&&(o=!0),n+=d,i++;else{if(0===i)break;let t;if((t=this.getEmulatedBadCharLen(h,String.fromCharCode(e[i-1]),l))>0)n+=t;else{if(i>=e.length||!St.isNotLowercaseAlpha(l))break;if(St.isSymbol(l)&&"'"!==l&&(r=!0),St.isNumerical(l)&&(c=!0),n++,a++,(100*a/(n-s)|0)>90)break}}}return{currentIndex:n,badIndex:i,hasSymbol:r,hasNumber:o,hasDigit:c}}getEmulatedBadCharLen(t,e,s){if(e==s)return 1;if(e>='a'&&e<='m'){if('a'==e)return'4'!=s&&'@'!=s&&'^'!=s?'/'==s&&'\\'==t?2:0:1;if('b'==e)return'6'!=s&&'8'!=s?'1'==s&&'3'==t?2:0:1;if('c'==e)return'('!=s&&'<'!=s&&'{'!=s&&'['!=s?0:1;if('d'==e)return'['==s&&')'==t?2:0;if('e'==e)return'3'!=s&&'â¬'!=s?0:1;if('f'==e)return'p'==s&&'h'==t?2:'Â£'==s?1:0;if('g'==e)return'9'!=s&&'6'!=s?0:1;if('h'==e)return'#'==s?1:0;if('i'==e)return'y'!=s&&'l'!=s&&'j'!=s&&'1'!=s&&'!'!=s&&':'!=s&&';'!=s&&'|'!=s?0:1;if('j'==e)return 0;if('k'==e)return 0;if('l'==e)return'1'!=s&&'|'!=s&&'i'!=s?0:1;if('m'==e)return 0}if(e>='n'&&e<='z'){if('n'==e)return 0;if('o'==e)return'0'!=s&&'*'!=s?'('==s&&')'==t||'['==s&&']'==t||'{'==s&&'}'==t||'<'==s&&'>'==t?2:0:1;if('p'==e)return 0;if('q'==e)return 0;if('r'==e)return 0;if('s'==e)return'5'!=s&&'z'!=s&&'$'!=s&&'2'!=s?0:1;if('t'==e)return'7'!=s&&'+'!=s?0:1;if('u'==e)return'v'==s?1:'\\'==s&&'/'==t||'\\'==s&&'|'==t||'|'==s&&'/'==t?2:0;if('v'==e)return'\\'==s&&'/'==t||'\\'==s&&'|'==t||'|'==s&&'/'==t?2:0;if('w'==e)return'v'==s&&'v'==t?2:0;if('x'==e)return')'==s&&'('==t||'}'==s&&'{'==t||']'==s&&'['==t||'>'==s&&'<'==t?2:0;if('y'==e)return 0;if('z'==e)return 0}return e>='0'&&e<='9'?'0'==e?'o'==s||'O'==s?1:'('==s&&')'==t||'{'==s&&'}'==t||'['==s&&']'==t?2:0:'1'==e&&'l'==s?1:0:','==e?'.'==s?1:0:'.'==e?','==s?1:0:'!'==e&&'i'==s?1:0}comboMatches(t,e,s){let n=0,i=e.length-1;for(;n<=i;){const a=(n+i)/2|0;if(e[a][0]===t&&e[a][1]===s)return!0;t<e[a][0]||t===e[a][0]&&s<e[a][1]?i=a-1:n=a+1}return!1}getIndex(t){return St.isLowercaseAlpha(t)?t.charCodeAt(0)+1-'a'.charCodeAt(0):"'"==t?28:St.isNumerical(t)?t.charCodeAt(0)+29-'0'.charCodeAt(0):27}}class Pt{wordEncBadWords;domains=[];constructor(t){this.wordEncBadWords=t}filter(t){const e=[...t],s=[...t];this.wordEncBadWords.filterBadCombinations(null,e,St.AMPERSAT),this.wordEncBadWords.filterBadCombinations(null,s,St.PERIOD);for(let n=this.domains.length-1;n>=0;n--)this.filterDomain(s,e,this.domains[n],t)}getEmulatedDomainCharLen(t,e,s){return e==s||'o'==e&&'0'==s?1:'o'==e&&'('==s&&')'==t?2:'c'!=e||'('!=s&&'<'!=s&&'['!=s?'e'==e&&'â¬'==s||'s'==e&&'$'==s||'l'==e&&'i'==s?1:0:1}filterDomain(t,e,s,n){const i=s.length,a=n.length;for(let r=0;r<=a-i;r++){const{matched:i,currentIndex:a}=this.findMatchingDomain(r,s,n);if(!i)continue;const o=St.prefixSymbolStatus(r,n,3,e,['@']),c=St.suffixSymbolStatus(a-1,n,3,t,['.',',']);(o>2||c>2)&&St.maskChars(r,a,n)}}findMatchingDomain(t,e,s){const n=e.length;let i=t,a=0;for(;i<s.length&&a<n;){const r=s[i],o=i+1<s.length?s[i+1]:'\0',c=this.getEmulatedDomainCharLen(o,String.fromCharCode(e[a]),r);if(c>0)i+=c,a++;else{if(0===a)break;const s=this.getEmulatedDomainCharLen(o,String.fromCharCode(e[a-1]),r);if(s>0)i+=s,1===a&&t++;else{if(a>=n||!St.isSymbol(r))break;i++}}}return{matched:a>=n,currentIndex:i}}}class Lt{wordEncBadWords;wordEncDomains;tlds=[];tldTypes=[];constructor(t,e){this.wordEncBadWords=t,this.wordEncDomains=e}filter(t){const e=[...t],s=[...t];this.wordEncBadWords.filterBadCombinations(null,e,St.PERIOD),this.wordEncBadWords.filterBadCombinations(null,s,St.SLASH);for(let n=0;n<this.tlds.length;n++)this.filterTld(s,this.tldTypes[n],t,this.tlds[n],e)}filterTld(t,e,s,n,i){if(!(n.length>s.length))for(let a=0;a<=s.length-n.length;a++){const{currentIndex:r,tldIndex:o}=this.processTlds(s,n,a);if(o<n.length)continue;let c=!1;const l=St.prefixSymbolStatus(a,s,3,i,[',','.']),h=St.suffixSymbolStatus(r-1,s,5,t,['\\','/']);if(1==e&&l>0&&h>0&&(c=!0),2==e&&(l>2&&h>0||l>0&&h>2)&&(c=!0),3==e&&l>0&&h>2&&(c=!0),!c)continue;let d,p=a,u=r-1,_=!1;if(l>2){if(4==l)for(_=!1,d=a-1;d>=0;d--)if(_){if('*'!=i[d])break;p=d}else'*'==i[d]&&(p=d,_=!0);for(_=!1,d=p-1;d>=0;d--)if(_){if(St.isSymbol(s[d]))break;p=d}else St.isSymbol(s[d])||(_=!0,p=d)}if(h>2){if(4==h)for(_=!1,d=u+1;d<s.length;d++)if(_){if('*'!=t[d])break;u=d}else'*'==t[d]&&(u=d,_=!0);for(_=!1,d=u+1;d<s.length;d++)if(_){if(St.isSymbol(s[d]))break;u=d}else St.isSymbol(s[d])||(_=!0,u=d)}St.maskChars(p,u+1,s)}}processTlds(t,e,s){let n=0;for(;s<t.length&&n<e.length;){const i=t[s],a=s+1<t.length?t[s+1]:'\0';let r;if((r=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(e[n]),i))>0)s+=r,n++;else{if(0===n)break;let t;if((t=this.wordEncDomains.getEmulatedDomainCharLen(a,String.fromCharCode(e[n-1]),i))>0)s+=t;else{if(!St.isSymbol(i))break;s++}}}return{currentIndex:s,tldIndex:n}}}class St{static PERIOD=new Uint16Array(['d','o','t'].join('').split('').map((t=>t.charCodeAt(0))));static AMPERSAT=new Uint16Array(['(','a',')'].join('').split('').map((t=>t.charCodeAt(0))));static SLASH=new Uint16Array(['s','l','a','s','h'].join('').split('').map((t=>t.charCodeAt(0))));static wordEncFragments=new It;static wordEncBadWords=new Nt(this.wordEncFragments);static wordEncDomains=new Pt(this.wordEncBadWords);static wordEncTlds=new Lt(this.wordEncBadWords,this.wordEncDomains);static whitelist=['cook',"cook's",'cooks','seeks','sheet'];static async load(t){if(!(await fetch(`${t}/client/wordenc`)).ok)return void console.log('Warning: No wordenc found.');const e=await C.load(`${t}/client/wordenc`),s=e.read('fragmentsenc.txt');if(!s)return void console.log('Warning: No fragmentsenc found.');const n=e.read('badenc.txt');if(!n)return void console.log('Warning: No badenc found.');const i=e.read('domainenc.txt');if(!i)return void console.log('Warning: No domainenc found.');const a=e.read('tldlist.txt');a?(this.decodeBadEnc(n),this.decodeDomainEnc(i),this.decodeFragmentsEnc(s),this.decodeTldList(a)):console.log('Warning: No tldlist found.')}static filter(t){const e=[...t];this.format(e);const s=e.join('').trim(),n=s.toLowerCase(),i=[...n];this.wordEncTlds.filter(i),this.wordEncBadWords.filter(i),this.wordEncDomains.filter(i),this.wordEncFragments.filter(i);for(let t=0;t<this.whitelist.length;t++){let e=-1;for(;-1!==(e=n.indexOf(this.whitelist[t],e+1));){const s=[...this.whitelist[t]];for(let t=0;t<s.length;t++)i[t+e]=s[t]}}return this.replaceUppercases(i,[...s]),this.formatUppercases(i),i.join('').trim()}static isSymbol(t){return!this.isAlpha(t)&&!this.isNumerical(t)}static isNotLowercaseAlpha(t){return!this.isLowercaseAlpha(t)||('v'==t||'x'==t||'j'==t||'q'==t||'z'==t)}static isAlpha(t){return this.isLowercaseAlpha(t)||this.isUppercaseAlpha(t)}static isNumerical(t){return t>='0'&&t<='9'}static isLowercaseAlpha(t){return t>='a'&&t<='z'}static isUppercaseAlpha(t){return t>='A'&&t<='Z'}static isNumericalChars(t){for(let e=0;e<t.length;e++)if(!this.isNumerical(t[e])&&'\0'!==t[e])return!1;return!0}static maskChars(t,e,s){for(let n=t;n<e;n++)s[n]='*'}static maskedCountBackwards(t,e){let s=0;for(let n=e-1;n>=0&&St.isSymbol(t[n]);n--)'*'===t[n]&&s++;return s}static maskedCountForwards(t,e){let s=0;for(let n=e+1;n<t.length&&this.isSymbol(t[n]);n++)'*'===t[n]&&s++;return s}static maskedCharsStatus(t,e,s,n,i){return(i?this.maskedCountBackwards(e,s):this.maskedCountForwards(e,s))>=n?4:this.isSymbol(i?t[s-1]:t[s+1])?1:0}static prefixSymbolStatus(t,e,s,n,i){if(0===t)return 2;for(let s=t-1;s>=0&&St.isSymbol(e[s]);s--)if(i.includes(e[s]))return 3;return St.maskedCharsStatus(e,n,t,s,!0)}static suffixSymbolStatus(t,e,s,n,i){if(t+1===e.length)return 2;for(let s=t+1;s<e.length&&St.isSymbol(e[s]);s++)if(i.includes(e[s]))return 3;return St.maskedCharsStatus(e,n,t,s,!1)}static decodeTldList(t){const e=t.g4();for(let s=0;s<e;s++)this.wordEncTlds.tldTypes[s]=t.g1(),this.wordEncTlds.tlds[s]=new Uint16Array(t.g1()).map((()=>t.g1()))}static decodeBadEnc(t){const e=t.g4();for(let s=0;s<e;s++){this.wordEncBadWords.bads[s]=new Uint16Array(t.g1()).map((()=>t.g1()));const e=new Array(t.g1()).fill([]).map((()=>[t.g1b(),t.g1b()]));e.length>0&&(this.wordEncBadWords.badCombinations[s]=e)}}static decodeDomainEnc(t){const e=t.g4();for(let s=0;s<e;s++)this.wordEncDomains.domains[s]=new Uint16Array(t.g1()).map((()=>t.g1()))}static decodeFragmentsEnc(t){const e=t.g4();for(let s=0;s<e;s++)this.wordEncFragments.fragments[s]=t.g2()}static format(t){let e=0;for(let s=0;s<t.length;s++)this.isCharacterAllowed(t[s])?t[e]=t[s]:t[e]=' ',0!==e&&' '===t[e]&&' '===t[e-1]||e++;for(let s=e;s<t.length;s++)t[s]=' '}static isCharacterAllowed(t){return t>=' '&&t<=''||' '==t||'\n'==t||'\t'==t||'Â£'==t||'â¬'==t}static replaceUppercases(t,e){for(let s=0;s<e.length;s++)'*'!==t[s]&&this.isUppercaseAlpha(e[s])&&(t[s]=e[s])}static formatUppercases(t){let e=!0;for(let s=0;s<t.length;s++){const n=t[s];this.isAlpha(n)?e?this.isLowercaseAlpha(n)&&(e=!1):this.isUppercaseAlpha(n)&&(t[s]=String.fromCharCode(n.charCodeAt(0)+'a'.charCodeAt(0)-65)):e=!0}}}class Ct extends A{static configNames=new Map;static configs=[];static async load(t){if(Ct.configNames=new Map,Ct.configs=[],!(await fetch(`${t}/server/spotanim.dat`)).ok)return void console.log('Warning: No spotanim.dat found.');const e=await f.load(`${t}/server/spotanim.dat`),s=e.g2(),n=(await C.load(`${t}/client/config`)).read('spotanim.dat');n.pos=2;for(let t=0;t<s;t++){const s=new Ct(t);s.decodeType(e),s.decodeType(n),Ct.configs[t]=s,s.debugname&&Ct.configNames.set(s.debugname,t)}}static get(t){return Ct.configs[t]}static getId(t){return Ct.configNames.get(t)??-1}static getByName(t){const e=this.getId(t);return-1===e?null:this.get(e)}static get count(){return this.configs.length}model=0;anim=-1;hasalpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode(t,e){if(1===t)this.model=e.g2();else if(2===t)this.anim=e.g2();else if(3===t)this.hasalpha=!0;else if(4===t)this.resizeh=e.g2();else if(5===t)this.resizev=e.g2();else if(6===t)this.orientation=e.g2();else if(7===t)this.ambient=e.g1();else if(8===t)this.contrast=e.g1();else if(t>=40&&t<50)this.recol_s[t-40]=e.g2();else if(t>=50&&t<60)this.recol_d[t-50]=e.g2();else{if(250!==t)throw new Error(`Unrecognized spotanim config code: ${t}`);this.debugname=e.gjstr()}}}function yt(t,e){return function(s){'number'==typeof t?s.pointerCheck(t):s.pointerCheck(t[s.intOperand]),e(s)}}(ut=pt||={})[ut.ActivePlayer=0]='ActivePlayer',ut[ut.ActivePlayer2=1]='ActivePlayer2',ut[ut.ProtectedActivePlayer=2]='ProtectedActivePlayer',ut[ut.ProtectedActivePlayer2=3]='ProtectedActivePlayer2',ut[ut.ActiveNpc=4]='ActiveNpc',ut[ut.ActiveNpc2=5]='ActiveNpc2',ut[ut.ActiveLoc=6]='ActiveLoc',ut[ut.ActiveLoc2=7]='ActiveLoc2',ut[ut.ActiveObj=8]='ActiveObj',ut[ut.ActiveObj2=9]='ActiveObj2',ut[ut._LAST=10]='_LAST';var vt,wt,Rt=[4,5],bt=[6,7],Ut=[8,9],Dt=[0,1],Mt=[2,3],kt=pt,xt=Object.create,Bt=Object.defineProperty,Ht=Object.getOwnPropertyDescriptor,Ft=Object.getOwnPropertyNames,Gt=Object.getPrototypeOf,Wt=Object.prototype.hasOwnProperty,zt=(t,e,s,n)=>{if(e&&'object'==typeof e||'function'==typeof e)for(let i of Ft(e))!Wt.call(t,i)&&i!==s&&Bt(t,i,{get:()=>e[i],enumerable:!(n=Ht(e,i))||n.enumerable});return t},Vt=(t,e,s)=>(s=null!=t?xt(Gt(t)):{},zt(!e&&t&&t.__esModule?s:Bt(s,'default',{value:t,enumerable:!0}),t)),Yt=(vt=(t,e)=>{function s(t){if('string'!=typeof t)throw new TypeError('Path must be a string. Received '+JSON.stringify(t))}function n(t,e){for(var s,n='',i=0,a=-1,r=0,o=0;o<=t.length;++o){if(o<t.length)s=t.charCodeAt(o);else{if(47===s)break;s=47}if(47===s){if(a!==o-1&&1!==r)if(a!==o-1&&2===r){if(n.length<2||2!==i||46!==n.charCodeAt(n.length-1)||46!==n.charCodeAt(n.length-2))if(n.length>2){var c=n.lastIndexOf('/');if(c!==n.length-1){-1===c?(n='',i=0):i=(n=n.slice(0,c)).length-1-n.lastIndexOf('/'),a=o,r=0;continue}}else if(2===n.length||1===n.length){n='',i=0,a=o,r=0;continue}e&&(n.length>0?n+='/..':n='..',i=2)}else n.length>0?n+='/'+t.slice(a+1,o):n=t.slice(a+1,o),i=o-a-1;a=o,r=0}else 46===s&&-1!==r?++r:r=-1}return n}var i={resolve:function(){for(var t,e='',i=!1,a=arguments.length-1;a>=-1&&!i;a--){var r;a>=0?r=arguments[a]:(void 0===t&&(t=process.cwd()),r=t),s(r),0!==r.length&&(e=r+'/'+e,i=47===r.charCodeAt(0))}return e=n(e,!i),i?e.length>0?'/'+e:'/':e.length>0?e:'.'},normalize:function(t){if(s(t),0===t.length)return'.';var e=47===t.charCodeAt(0),i=47===t.charCodeAt(t.length-1);return 0===(t=n(t,!e)).length&&!e&&(t='.'),t.length>0&&i&&(t+='/'),e?'/'+t:t},isAbsolute:function(t){return s(t),t.length>0&&47===t.charCodeAt(0)},join:function(){if(0===arguments.length)return'.';for(var t,e=0;e<arguments.length;++e){var n=arguments[e];s(n),n.length>0&&(void 0===t?t=n:t+='/'+n)}return void 0===t?'.':i.normalize(t)},relative:function(t,e){if(s(t),s(e),t===e||(t=i.resolve(t))===(e=i.resolve(e)))return'';for(var n=1;n<t.length&&47===t.charCodeAt(n);++n);for(var a=t.length,r=a-n,o=1;o<e.length&&47===e.charCodeAt(o);++o);for(var c=e.length-o,l=r<c?r:c,h=-1,d=0;d<=l;++d){if(d===l){if(c>l){if(47===e.charCodeAt(o+d))return e.slice(o+d+1);if(0===d)return e.slice(o+d)}else r>l&&(47===t.charCodeAt(n+d)?h=d:0===d&&(h=0));break}var p=t.charCodeAt(n+d);if(p!==e.charCodeAt(o+d))break;47===p&&(h=d)}var u='';for(d=n+h+1;d<=a;++d)(d===a||47===t.charCodeAt(d))&&(0===u.length?u+='..':u+='/..');return u.length>0?u+e.slice(o+h):(o+=h,47===e.charCodeAt(o)&&++o,e.slice(o))},_makeLong:function(t){return t},dirname:function(t){if(s(t),0===t.length)return'.';for(var e=t.charCodeAt(0),n=47===e,i=-1,a=!0,r=t.length-1;r>=1;--r)if(47===(e=t.charCodeAt(r))){if(!a){i=r;break}}else a=!1;return-1===i?n?'/':'.':n&&1===i?'//':t.slice(0,i)},basename:function(t,e){if(void 0!==e&&'string'!=typeof e)throw new TypeError('"ext" argument must be a string');s(t);var n,i=0,a=-1,r=!0;if(void 0!==e&&e.length>0&&e.length<=t.length){if(e.length===t.length&&e===t)return'';var o=e.length-1,c=-1;for(n=t.length-1;n>=0;--n){var l=t.charCodeAt(n);if(47===l){if(!r){i=n+1;break}}else-1===c&&(r=!1,c=n+1),o>=0&&(l===e.charCodeAt(o)?-1==--o&&(a=n):(o=-1,a=c))}return i===a?a=c:-1===a&&(a=t.length),t.slice(i,a)}for(n=t.length-1;n>=0;--n)if(47===t.charCodeAt(n)){if(!r){i=n+1;break}}else-1===a&&(r=!1,a=n+1);return-1===a?'':t.slice(i,a)},extname:function(t){s(t);for(var e=-1,n=0,i=-1,a=!0,r=0,o=t.length-1;o>=0;--o){var c=t.charCodeAt(o);if(47!==c)-1===i&&(a=!1,i=o+1),46===c?-1===e?e=o:1!==r&&(r=1):-1!==e&&(r=-1);else if(!a){n=o+1;break}}return-1===e||-1===i||0===r||1===r&&e===i-1&&e===n+1?'':t.slice(e,i)},format:function(t){if(null===t||'object'!=typeof t)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof t);return function(t,e){var s=e.dir||e.root,n=e.base||(e.name||'')+(e.ext||'');return s?s===e.root?s+n:s+t+n:n}('/',t)},parse:function(t){s(t);var e={root:'',dir:'',base:'',ext:'',name:''};if(0===t.length)return e;var n,i=t.charCodeAt(0),a=47===i;a?(e.root='/',n=1):n=0;for(var r=-1,o=0,c=-1,l=!0,h=t.length-1,d=0;h>=n;--h)if(47!==(i=t.charCodeAt(h)))-1===c&&(l=!1,c=h+1),46===i?-1===r?r=h:1!==d&&(d=1):-1!==r&&(d=-1);else if(!l){o=h+1;break}return-1===r||-1===c||0===d||1===d&&r===c-1&&r===o+1?-1!==c&&(e.base=e.name=0===o&&a?t.slice(1,c):t.slice(o,c)):(0===o&&a?(e.name=t.slice(1,r),e.base=t.slice(1,c)):(e.name=t.slice(o,r),e.base=t.slice(o,c)),e.ext=t.slice(r,c)),o>0?e.dir=t.slice(0,o-1):a&&(e.dir='/'),e},sep:'/',delimiter:':',win32:null,posix:null};i.posix=i,e.exports=i},()=>(wt||vt((wt={exports:{}}).exports,wt),wt.exports)),Kt={};((t,e)=>{for(var s in e)Bt(t,s,{get:e[s],enumerable:!0})})(Kt,{default:()=>Jt}),((t,e,s)=>{zt(t,e,'default'),s&&zt(s,e,'default')})(Kt,Vt(Yt()));var jt,Zt,Jt=Vt(Yt());(Zt=jt||={})[Zt.PUSH_CONSTANT_INT=0]='PUSH_CONSTANT_INT',Zt[Zt.PUSH_VARP=1]='PUSH_VARP',Zt[Zt.POP_VARP=2]='POP_VARP',Zt[Zt.PUSH_CONSTANT_STRING=3]='PUSH_CONSTANT_STRING',Zt[Zt.PUSH_VARN=4]='PUSH_VARN',Zt[Zt.POP_VARN=5]='POP_VARN',Zt[Zt.BRANCH=6]='BRANCH',Zt[Zt.BRANCH_NOT=7]='BRANCH_NOT',Zt[Zt.BRANCH_EQUALS=8]='BRANCH_EQUALS',Zt[Zt.BRANCH_LESS_THAN=9]='BRANCH_LESS_THAN',Zt[Zt.BRANCH_GREATER_THAN=10]='BRANCH_GREATER_THAN',Zt[Zt.PUSH_VARS=11]='PUSH_VARS',Zt[Zt.POP_VARS=12]='POP_VARS',Zt[Zt.RETURN=21]='RETURN',Zt[Zt.GOSUB=22]='GOSUB',Zt[Zt.JUMP=23]='JUMP',Zt[Zt.SWITCH=24]='SWITCH',Zt[Zt.BRANCH_LESS_THAN_OR_EQUALS=31]='BRANCH_LESS_THAN_OR_EQUALS',Zt[Zt.BRANCH_GREATER_THAN_OR_EQUALS=32]='BRANCH_GREATER_THAN_OR_EQUALS',Zt[Zt.PUSH_INT_LOCAL=33]='PUSH_INT_LOCAL',Zt[Zt.POP_INT_LOCAL=34]='POP_INT_LOCAL',Zt[Zt.PUSH_STRING_LOCAL=35]='PUSH_STRING_LOCAL',Zt[Zt.POP_STRING_LOCAL=36]='POP_STRING_LOCAL',Zt[Zt.JOIN_STRING=37]='JOIN_STRING',Zt[Zt.POP_INT_DISCARD=38]='POP_INT_DISCARD',Zt[Zt.POP_STRING_DISCARD=39]='POP_STRING_DISCARD',Zt[Zt.GOSUB_WITH_PARAMS=40]='GOSUB_WITH_PARAMS',Zt[Zt.JUMP_WITH_PARAMS=41]='JUMP_WITH_PARAMS',Zt[Zt.DEFINE_ARRAY=44]='DEFINE_ARRAY',Zt[Zt.PUSH_ARRAY_INT=45]='PUSH_ARRAY_INT',Zt[Zt.POP_ARRAY_INT=46]='POP_ARRAY_INT',Zt[Zt.COORDX=1e3]='COORDX',Zt[Zt.COORDY=1001]='COORDY',Zt[Zt.COORDZ=1002]='COORDZ',Zt[Zt.DISTANCE=1003]='DISTANCE',Zt[Zt.HUNTALL=1004]='HUNTALL',Zt[Zt.HUNTNEXT=1005]='HUNTNEXT',Zt[Zt.INZONE=1006]='INZONE',Zt[Zt.LINEOFSIGHT=1007]='LINEOFSIGHT',Zt[Zt.LINEOFWALK=1008]='LINEOFWALK',Zt[Zt.MAP_BLOCKED=1009]='MAP_BLOCKED',Zt[Zt.MAP_INDOORS=1010]='MAP_INDOORS',Zt[Zt.MAP_CLOCK=1011]='MAP_CLOCK',Zt[Zt.MAP_LOCADDUNSAFE=1012]='MAP_LOCADDUNSAFE',Zt[Zt.MAP_MEMBERS=1013]='MAP_MEMBERS',Zt[Zt.MAP_PLAYERCOUNT=1014]='MAP_PLAYERCOUNT',Zt[Zt.MOVECOORD=1015]='MOVECOORD',Zt[Zt.PLAYERCOUNT=1016]='PLAYERCOUNT',Zt[Zt.PROJANIM_MAP=1017]='PROJANIM_MAP',Zt[Zt.PROJANIM_NPC=1018]='PROJANIM_NPC',Zt[Zt.PROJANIM_PL=1019]='PROJANIM_PL',Zt[Zt.SEQLENGTH=1020]='SEQLENGTH',Zt[Zt.SPLIT_GET=1021]='SPLIT_GET',Zt[Zt.SPLIT_GETANIM=1022]='SPLIT_GETANIM',Zt[Zt.SPLIT_INIT=1023]='SPLIT_INIT',Zt[Zt.SPLIT_LINECOUNT=1024]='SPLIT_LINECOUNT',Zt[Zt.SPLIT_PAGECOUNT=1025]='SPLIT_PAGECOUNT',Zt[Zt.SPOTANIM_MAP=1026]='SPOTANIM_MAP',Zt[Zt.STAT_RANDOM=1027]='STAT_RANDOM',Zt[Zt.STRUCT_PARAM=1028]='STRUCT_PARAM',Zt[Zt.WORLD_DELAY=1029]='WORLD_DELAY',Zt[Zt.NPCCOUNT=1030]='NPCCOUNT',Zt[Zt.ZONECOUNT=1031]='ZONECOUNT',Zt[Zt.LOCCOUNT=1032]='LOCCOUNT',Zt[Zt.OBJCOUNT=1033]='OBJCOUNT',Zt[Zt.ALLOWDESIGN=2e3]='ALLOWDESIGN',Zt[Zt.ANIM=2001]='ANIM',Zt[Zt.BAS_READYANIM=2002]='BAS_READYANIM',Zt[Zt.BAS_RUNNING=2003]='BAS_RUNNING',Zt[Zt.BAS_TURNONSPOT=2004]='BAS_TURNONSPOT',Zt[Zt.BAS_WALK_B=2005]='BAS_WALK_B',Zt[Zt.BAS_WALK_F=2006]='BAS_WALK_F',Zt[Zt.BAS_WALK_L=2007]='BAS_WALK_L',Zt[Zt.BAS_WALK_R=2008]='BAS_WALK_R',Zt[Zt.BUFFER_FULL=2009]='BUFFER_FULL',Zt[Zt.BUILDAPPEARANCE=2010]='BUILDAPPEARANCE',Zt[Zt.BUSY=2011]='BUSY',Zt[Zt.CAM_LOOKAT=2012]='CAM_LOOKAT',Zt[Zt.CAM_MOVETO=2013]='CAM_MOVETO',Zt[Zt.CAM_RESET=2014]='CAM_RESET',Zt[Zt.CAM_SHAKE=2015]='CAM_SHAKE',Zt[Zt.CLEARQUEUE=2016]='CLEARQUEUE',Zt[Zt.CLEARSOFTTIMER=2017]='CLEARSOFTTIMER',Zt[Zt.CLEARTIMER=2018]='CLEARTIMER',Zt[Zt.COORD=2019]='COORD',Zt[Zt.DAMAGE=2020]='DAMAGE',Zt[Zt.DISPLAYNAME=2021]='DISPLAYNAME',Zt[Zt.FACESQUARE=2022]='FACESQUARE',Zt[Zt.FINDUID=2023]='FINDUID',Zt[Zt.GENDER=2024]='GENDER',Zt[Zt.GETQUEUE=2025]='GETQUEUE',Zt[Zt.GIVEXP=2026]='GIVEXP',Zt[Zt.HEADICONS_GET=2027]='HEADICONS_GET',Zt[Zt.HEADICONS_SET=2028]='HEADICONS_SET',Zt[Zt.HEALENERGY=2029]='HEALENERGY',Zt[Zt.HINT_COORD=2030]='HINT_COORD',Zt[Zt.HINT_NPC=2031]='HINT_NPC',Zt[Zt.HINT_PLAYER=2032]='HINT_PLAYER',Zt[Zt.HINT_STOP=2033]='HINT_STOP',Zt[Zt.IF_CLOSE=2034]='IF_CLOSE',Zt[Zt.IF_CLOSESTICKY=2035]='IF_CLOSESTICKY',Zt[Zt.IF_MULTIZONE=2036]='IF_MULTIZONE',Zt[Zt.IF_OPENCHAT=2037]='IF_OPENCHAT',Zt[Zt.IF_OPENCHATSTICKY=2038]='IF_OPENCHATSTICKY',Zt[Zt.IF_OPENMAINMODAL=2039]='IF_OPENMAINMODAL',Zt[Zt.IF_OPENMAINMODALSIDEOVERLAY=2040]='IF_OPENMAINMODALSIDEOVERLAY',Zt[Zt.IF_OPENSIDEOVERLAY=2041]='IF_OPENSIDEOVERLAY',Zt[Zt.IF_SETANIM=2042]='IF_SETANIM',Zt[Zt.IF_SETCOLOUR=2043]='IF_SETCOLOUR',Zt[Zt.IF_SETHIDE=2044]='IF_SETHIDE',Zt[Zt.IF_SETMODEL=2045]='IF_SETMODEL',Zt[Zt.IF_SETRECOL=2046]='IF_SETRECOL',Zt[Zt.IF_SETNPCHEAD=2047]='IF_SETNPCHEAD',Zt[Zt.IF_SETOBJECT=2048]='IF_SETOBJECT',Zt[Zt.IF_SETPLAYERHEAD=2049]='IF_SETPLAYERHEAD',Zt[Zt.IF_SETPOSITION=2050]='IF_SETPOSITION',Zt[Zt.IF_SETRESUMEBUTTONS=2051]='IF_SETRESUMEBUTTONS',Zt[Zt.IF_SETTAB=2052]='IF_SETTAB',Zt[Zt.IF_SETTABACTIVE=2053]='IF_SETTABACTIVE',Zt[Zt.IF_SETTABFLASH=2054]='IF_SETTABFLASH',Zt[Zt.IF_SETTEXT=2055]='IF_SETTEXT',Zt[Zt.LAST_LOGIN_INFO=2056]='LAST_LOGIN_INFO',Zt[Zt.LAST_COM=2057]='LAST_COM',Zt[Zt.LAST_INT=2058]='LAST_INT',Zt[Zt.LAST_ITEM=2059]='LAST_ITEM',Zt[Zt.LAST_SLOT=2060]='LAST_SLOT',Zt[Zt.LAST_TARGETSLOT=2061]='LAST_TARGETSLOT',Zt[Zt.LAST_USEITEM=2062]='LAST_USEITEM',Zt[Zt.LAST_USESLOT=2063]='LAST_USESLOT',Zt[Zt.LONGQUEUE=2064]='LONGQUEUE',Zt[Zt.MES=2065]='MES',Zt[Zt.MIDI_JINGLE=2066]='MIDI_JINGLE',Zt[Zt.MIDI_SONG=2067]='MIDI_SONG',Zt[Zt.NAME=2068]='NAME',Zt[Zt.P_APRANGE=2069]='P_APRANGE',Zt[Zt.P_ARRIVEDELAY=2070]='P_ARRIVEDELAY',Zt[Zt.P_COUNTDIALOG=2071]='P_COUNTDIALOG',Zt[Zt.P_DELAY=2072]='P_DELAY',Zt[Zt.P_EXACTMOVE=2073]='P_EXACTMOVE',Zt[Zt.P_FINDUID=2074]='P_FINDUID',Zt[Zt.P_LOCMERGE=2075]='P_LOCMERGE',Zt[Zt.P_LOGOUT=2076]='P_LOGOUT',Zt[Zt.P_OPHELD=2077]='P_OPHELD',Zt[Zt.P_OPLOC=2078]='P_OPLOC',Zt[Zt.P_OPNPC=2079]='P_OPNPC',Zt[Zt.P_OPNPCT=2080]='P_OPNPCT',Zt[Zt.P_OPOBJ=2081]='P_OPOBJ',Zt[Zt.P_OPPLAYER=2082]='P_OPPLAYER',Zt[Zt.P_OPPLAYERT=2083]='P_OPPLAYERT',Zt[Zt.P_PAUSEBUTTON=2084]='P_PAUSEBUTTON',Zt[Zt.P_STOPACTION=2085]='P_STOPACTION',Zt[Zt.P_TELEJUMP=2086]='P_TELEJUMP',Zt[Zt.P_TELEPORT=2087]='P_TELEPORT',Zt[Zt.P_WALK=2088]='P_WALK',Zt[Zt.PLAYER_FINDALLZONE=2089]='PLAYER_FINDALLZONE',Zt[Zt.PLAYER_FINDNEXT=2090]='PLAYER_FINDNEXT',Zt[Zt.QUEUE=2091]='QUEUE',Zt[Zt.SAY=2092]='SAY',Zt[Zt.WALKTRIGGER=2093]='WALKTRIGGER',Zt[Zt.SETTIMER=2094]='SETTIMER',Zt[Zt.SOFTTIMER=2095]='SOFTTIMER',Zt[Zt.SOUND_SYNTH=2096]='SOUND_SYNTH',Zt[Zt.SPOTANIM_PL=2097]='SPOTANIM_PL',Zt[Zt.STAFFMODLEVEL=2098]='STAFFMODLEVEL',Zt[Zt.STAT=2099]='STAT',Zt[Zt.STAT_ADD=2100]='STAT_ADD',Zt[Zt.STAT_BASE=2101]='STAT_BASE',Zt[Zt.STAT_HEAL=2102]='STAT_HEAL',Zt[Zt.STAT_SUB=2103]='STAT_SUB',Zt[Zt.STRONGQUEUE=2104]='STRONGQUEUE',Zt[Zt.UID=2105]='UID',Zt[Zt.WEAKQUEUE=2106]='WEAKQUEUE',Zt[Zt.IF_OPENMAINOVERLAY=2107]='IF_OPENMAINOVERLAY',Zt[Zt.AFK_EVENT=2108]='AFK_EVENT',Zt[Zt.LOWMEMORY=2109]='LOWMEMORY',Zt[Zt.SETIDKIT=2110]='SETIDKIT',Zt[Zt.P_CLEARPENDINGACTION=2111]='P_CLEARPENDINGACTION',Zt[Zt.GETWALKTRIGGER=2112]='GETWALKTRIGGER',Zt[Zt.BUSY2=2113]='BUSY2',Zt[Zt.FINDHERO=2114]='FINDHERO',Zt[Zt.BOTH_HEROPOINTS=2115]='BOTH_HEROPOINTS',Zt[Zt.SETGENDER=2116]='SETGENDER',Zt[Zt.SETSKINCOLOUR=2117]='SETSKINCOLOUR',Zt[Zt.P_ANIMPROTECT=2118]='P_ANIMPROTECT',Zt[Zt.RUNENERGY=2119]='RUNENERGY',Zt[Zt.NPC_ADD=2500]='NPC_ADD',Zt[Zt.NPC_ANIM=2501]='NPC_ANIM',Zt[Zt.NPC_BASESTAT=2502]='NPC_BASESTAT',Zt[Zt.NPC_CATEGORY=2503]='NPC_CATEGORY',Zt[Zt.NPC_CHANGETYPE=2504]='NPC_CHANGETYPE',Zt[Zt.NPC_COORD=2505]='NPC_COORD',Zt[Zt.NPC_DAMAGE=2506]='NPC_DAMAGE',Zt[Zt.NPC_DEL=2507]='NPC_DEL',Zt[Zt.NPC_DELAY=2508]='NPC_DELAY',Zt[Zt.NPC_FACESQUARE=2509]='NPC_FACESQUARE',Zt[Zt.NPC_FIND=2510]='NPC_FIND',Zt[Zt.NPC_FINDALLANY=2511]='NPC_FINDALLANY',Zt[Zt.NPC_FINDEXACT=2512]='NPC_FINDEXACT',Zt[Zt.NPC_FINDHERO=2513]='NPC_FINDHERO',Zt[Zt.NPC_FINDALLZONE=2514]='NPC_FINDALLZONE',Zt[Zt.NPC_FINDNEXT=2515]='NPC_FINDNEXT',Zt[Zt.NPC_FINDUID=2516]='NPC_FINDUID',Zt[Zt.NPC_GETMODE=2517]='NPC_GETMODE',Zt[Zt.NPC_HEROPOINTS=2518]='NPC_HEROPOINTS',Zt[Zt.NPC_NAME=2519]='NPC_NAME',Zt[Zt.NPC_PARAM=2520]='NPC_PARAM',Zt[Zt.NPC_QUEUE=2521]='NPC_QUEUE',Zt[Zt.NPC_RANGE=2522]='NPC_RANGE',Zt[Zt.NPC_SAY=2523]='NPC_SAY',Zt[Zt.NPC_HUNTALL=2524]='NPC_HUNTALL',Zt[Zt.NPC_HUNTNEXT=2525]='NPC_HUNTNEXT',Zt[Zt.NPC_SETHUNT=2526]='NPC_SETHUNT',Zt[Zt.NPC_SETHUNTMODE=2527]='NPC_SETHUNTMODE',Zt[Zt.NPC_SETMODE=2528]='NPC_SETMODE',Zt[Zt.NPC_WALKTRIGGER=2529]='NPC_WALKTRIGGER',Zt[Zt.NPC_SETTIMER=2530]='NPC_SETTIMER',Zt[Zt.NPC_STAT=2531]='NPC_STAT',Zt[Zt.NPC_STATADD=2532]='NPC_STATADD',Zt[Zt.NPC_STATHEAL=2533]='NPC_STATHEAL',Zt[Zt.NPC_STATSUB=2534]='NPC_STATSUB',Zt[Zt.NPC_TELE=2535]='NPC_TELE',Zt[Zt.NPC_TYPE=2536]='NPC_TYPE',Zt[Zt.NPC_UID=2537]='NPC_UID',Zt[Zt.SPOTANIM_NPC=2538]='SPOTANIM_NPC',Zt[Zt.NPC_WALK=2539]='NPC_WALK',Zt[Zt.NPC_ATTACKRANGE=2540]='NPC_ATTACKRANGE',Zt[Zt.LOC_ADD=3e3]='LOC_ADD',Zt[Zt.LOC_ANGLE=3001]='LOC_ANGLE',Zt[Zt.LOC_ANIM=3002]='LOC_ANIM',Zt[Zt.LOC_CATEGORY=3003]='LOC_CATEGORY',Zt[Zt.LOC_CHANGE=3004]='LOC_CHANGE',Zt[Zt.LOC_COORD=3005]='LOC_COORD',Zt[Zt.LOC_DEL=3006]='LOC_DEL',Zt[Zt.LOC_FIND=3007]='LOC_FIND',Zt[Zt.LOC_FINDALLZONE=3008]='LOC_FINDALLZONE',Zt[Zt.LOC_FINDNEXT=3009]='LOC_FINDNEXT',Zt[Zt.LOC_NAME=3010]='LOC_NAME',Zt[Zt.LOC_PARAM=3011]='LOC_PARAM',Zt[Zt.LOC_SHAPE=3012]='LOC_SHAPE',Zt[Zt.LOC_TYPE=3013]='LOC_TYPE',Zt[Zt.OBJ_ADD=3500]='OBJ_ADD',Zt[Zt.OBJ_ADDALL=3501]='OBJ_ADDALL',Zt[Zt.OBJ_COORD=3502]='OBJ_COORD',Zt[Zt.OBJ_COUNT=3503]='OBJ_COUNT',Zt[Zt.OBJ_DEL=3504]='OBJ_DEL',Zt[Zt.OBJ_NAME=3505]='OBJ_NAME',Zt[Zt.OBJ_PARAM=3506]='OBJ_PARAM',Zt[Zt.OBJ_TAKEITEM=3507]='OBJ_TAKEITEM',Zt[Zt.OBJ_TYPE=3508]='OBJ_TYPE',Zt[Zt.NC_CATEGORY=4e3]='NC_CATEGORY',Zt[Zt.NC_DEBUGNAME=4001]='NC_DEBUGNAME',Zt[Zt.NC_DESC=4002]='NC_DESC',Zt[Zt.NC_NAME=4003]='NC_NAME',Zt[Zt.NC_OP=4004]='NC_OP',Zt[Zt.NC_PARAM=4005]='NC_PARAM',Zt[Zt.LC_CATEGORY=4100]='LC_CATEGORY',Zt[Zt.LC_DEBUGNAME=4101]='LC_DEBUGNAME',Zt[Zt.LC_DESC=4102]='LC_DESC',Zt[Zt.LC_NAME=4103]='LC_NAME',Zt[Zt.LC_OP=4104]='LC_OP',Zt[Zt.LC_PARAM=4105]='LC_PARAM',Zt[Zt.LC_WIDTH=4106]='LC_WIDTH',Zt[Zt.LC_LENGTH=4107]='LC_LENGTH',Zt[Zt.OC_CATEGORY=4200]='OC_CATEGORY',Zt[Zt.OC_CERT=4201]='OC_CERT',Zt[Zt.OC_COST=4202]='OC_COST',Zt[Zt.OC_DEBUGNAME=4203]='OC_DEBUGNAME',Zt[Zt.OC_DESC=4204]='OC_DESC',Zt[Zt.OC_IOP=4205]='OC_IOP',Zt[Zt.OC_MEMBERS=4206]='OC_MEMBERS',Zt[Zt.OC_NAME=4207]='OC_NAME',Zt[Zt.OC_OP=4208]='OC_OP',Zt[Zt.OC_PARAM=4209]='OC_PARAM',Zt[Zt.OC_STACKABLE=4210]='OC_STACKABLE',Zt[Zt.OC_TRADEABLE=4211]='OC_TRADEABLE',Zt[Zt.OC_UNCERT=4212]='OC_UNCERT',Zt[Zt.OC_WEARPOS2=4213]='OC_WEARPOS2',Zt[Zt.OC_WEARPOS3=4214]='OC_WEARPOS3',Zt[Zt.OC_WEARPOS=4215]='OC_WEARPOS',Zt[Zt.OC_WEIGHT=4216]='OC_WEIGHT',Zt[Zt.INV_ALLSTOCK=4300]='INV_ALLSTOCK',Zt[Zt.INV_SIZE=4301]='INV_SIZE',Zt[Zt.INV_STOCKBASE=4302]='INV_STOCKBASE',Zt[Zt.INV_ADD=4303]='INV_ADD',Zt[Zt.INV_CHANGESLOT=4304]='INV_CHANGESLOT',Zt[Zt.INV_CLEAR=4305]='INV_CLEAR',Zt[Zt.INV_DEL=4306]='INV_DEL',Zt[Zt.INV_DELSLOT=4307]='INV_DELSLOT',Zt[Zt.INV_DROPITEM=4308]='INV_DROPITEM',Zt[Zt.INV_DROPSLOT=4309]='INV_DROPSLOT',Zt[Zt.INV_FREESPACE=4310]='INV_FREESPACE',Zt[Zt.INV_GETNUM=4311]='INV_GETNUM',Zt[Zt.INV_GETOBJ=4312]='INV_GETOBJ',Zt[Zt.INV_ITEMSPACE=4313]='INV_ITEMSPACE',Zt[Zt.INV_ITEMSPACE2=4314]='INV_ITEMSPACE2',Zt[Zt.INV_MOVEFROMSLOT=4315]='INV_MOVEFROMSLOT',Zt[Zt.INV_MOVETOSLOT=4316]='INV_MOVETOSLOT',Zt[Zt.BOTH_MOVEINV=4317]='BOTH_MOVEINV',Zt[Zt.INV_MOVEITEM=4318]='INV_MOVEITEM',Zt[Zt.INV_MOVEITEM_CERT=4319]='INV_MOVEITEM_CERT',Zt[Zt.INV_MOVEITEM_UNCERT=4320]='INV_MOVEITEM_UNCERT',Zt[Zt.INV_SETSLOT=4321]='INV_SETSLOT',Zt[Zt.INV_TOTAL=4322]='INV_TOTAL',Zt[Zt.INV_TOTALCAT=4323]='INV_TOTALCAT',Zt[Zt.INV_TRANSMIT=4324]='INV_TRANSMIT',Zt[Zt.INVOTHER_TRANSMIT=4325]='INVOTHER_TRANSMIT',Zt[Zt.INV_STOPTRANSMIT=4326]='INV_STOPTRANSMIT',Zt[Zt.BOTH_DROPSLOT=4327]='BOTH_DROPSLOT',Zt[Zt.INV_DROPALL=4328]='INV_DROPALL',Zt[Zt.INV_TOTALPARAM=4329]='INV_TOTALPARAM',Zt[Zt.INV_TOTALPARAM_STACK=4330]='INV_TOTALPARAM_STACK',Zt[Zt.ENUM=4400]='ENUM',Zt[Zt.ENUM_GETOUTPUTCOUNT=4401]='ENUM_GETOUTPUTCOUNT',Zt[Zt.APPEND_NUM=4500]='APPEND_NUM',Zt[Zt.APPEND=4501]='APPEND',Zt[Zt.APPEND_SIGNNUM=4502]='APPEND_SIGNNUM',Zt[Zt.LOWERCASE=4503]='LOWERCASE',Zt[Zt.TEXT_GENDER=4504]='TEXT_GENDER',Zt[Zt.TOSTRING=4505]='TOSTRING',Zt[Zt.COMPARE=4506]='COMPARE',Zt[Zt.TEXT_SWITCH=4507]='TEXT_SWITCH',Zt[Zt.APPEND_CHAR=4508]='APPEND_CHAR',Zt[Zt.STRING_LENGTH=4509]='STRING_LENGTH',Zt[Zt.SUBSTRING=4510]='SUBSTRING',Zt[Zt.STRING_INDEXOF_CHAR=4511]='STRING_INDEXOF_CHAR',Zt[Zt.STRING_INDEXOF_STRING=4512]='STRING_INDEXOF_STRING',Zt[Zt.ADD=4600]='ADD',Zt[Zt.SUB=4601]='SUB',Zt[Zt.MULTIPLY=4602]='MULTIPLY',Zt[Zt.DIVIDE=4603]='DIVIDE',Zt[Zt.RANDOM=4604]='RANDOM',Zt[Zt.RANDOMINC=4605]='RANDOMINC',Zt[Zt.INTERPOLATE=4606]='INTERPOLATE',Zt[Zt.ADDPERCENT=4607]='ADDPERCENT',Zt[Zt.SETBIT=4608]='SETBIT',Zt[Zt.CLEARBIT=4609]='CLEARBIT',Zt[Zt.TESTBIT=4610]='TESTBIT',Zt[Zt.MODULO=4611]='MODULO',Zt[Zt.POW=4612]='POW',Zt[Zt.INVPOW=4613]='INVPOW',Zt[Zt.AND=4614]='AND',Zt[Zt.OR=4615]='OR',Zt[Zt.MIN=4616]='MIN',Zt[Zt.MAX=4617]='MAX',Zt[Zt.SCALE=4618]='SCALE',Zt[Zt.BITCOUNT=4619]='BITCOUNT',Zt[Zt.TOGGLEBIT=4620]='TOGGLEBIT',Zt[Zt.SETBIT_RANGE=4621]='SETBIT_RANGE',Zt[Zt.CLEARBIT_RANGE=4622]='CLEARBIT_RANGE',Zt[Zt.GETBIT_RANGE=4623]='GETBIT_RANGE',Zt[Zt.SETBIT_RANGE_TOINT=4624]='SETBIT_RANGE_TOINT',Zt[Zt.SIN_DEG=4625]='SIN_DEG',Zt[Zt.COS_DEG=4626]='COS_DEG',Zt[Zt.ATAN2_DEG=4627]='ATAN2_DEG',Zt[Zt.ABS=4628]='ABS',Zt[Zt.DB_FIND_WITH_COUNT=7500]='DB_FIND_WITH_COUNT',Zt[Zt.DB_FINDNEXT=7501]='DB_FINDNEXT',Zt[Zt.DB_GETFIELD=7502]='DB_GETFIELD',Zt[Zt.DB_GETFIELDCOUNT=7503]='DB_GETFIELDCOUNT',Zt[Zt.DB_LISTALL_WITH_COUNT=7504]='DB_LISTALL_WITH_COUNT',Zt[Zt.DB_GETROWTABLE=7505]='DB_GETROWTABLE',Zt[Zt.DB_FINDBYINDEX=7506]='DB_FINDBYINDEX',Zt[Zt.DB_FIND_REFINE_WITH_COUNT=7507]='DB_FIND_REFINE_WITH_COUNT',Zt[Zt.DB_FIND=7508]='DB_FIND',Zt[Zt.DB_FIND_REFINE=7509]='DB_FIND_REFINE',Zt[Zt.DB_LISTALL=7510]='DB_LISTALL',Zt[Zt.ERROR=1e4]='ERROR',Zt[Zt.MAP_PRODUCTION=10001]='MAP_PRODUCTION',Zt[Zt.MAP_LASTCLOCK=10002]='MAP_LASTCLOCK',Zt[Zt.MAP_LASTWORLD=10003]='MAP_LASTWORLD',Zt[Zt.MAP_LASTCLIENTIN=10004]='MAP_LASTCLIENTIN',Zt[Zt.MAP_LASTNPC=10005]='MAP_LASTNPC',Zt[Zt.MAP_LASTPLAYER=10006]='MAP_LASTPLAYER',Zt[Zt.MAP_LASTLOGOUT=10007]='MAP_LASTLOGOUT',Zt[Zt.MAP_LASTLOGIN=10008]='MAP_LASTLOGIN',Zt[Zt.MAP_LASTZONE=10009]='MAP_LASTZONE',Zt[Zt.MAP_LASTCLIENTOUT=10010]='MAP_LASTCLIENTOUT',Zt[Zt.MAP_LASTCLEANUP=10011]='MAP_LASTCLEANUP',Zt[Zt.MAP_LASTBANDWIDTHIN=10012]='MAP_LASTBANDWIDTHIN',Zt[Zt.MAP_LASTBANDWIDTHOUT=10013]='MAP_LASTBANDWIDTHOUT';var $t=jt;class Xt{info={scriptName:'<unknown>',sourceFilePath:'<unknown>',lookupKey:-1,parameterTypes:[],pcs:[],lines:[]};id;intLocalCount=0;stringLocalCount=0;intArgCount=0;stringArgCount=0;switchTables=[];opcodes=[];intOperands=[];stringOperands=[];static isLargeOperand(t){if(t>100)return!1;switch(t){case $t.RETURN:case $t.POP_INT_DISCARD:case $t.POP_STRING_DISCARD:case $t.GOSUB:case $t.JUMP:return!1}return!0}static decode(t,e){const s=e.data.length;if(s<16)throw new Error('Invalid script file (minimum length)');e.pos=s-2;const n=s-e.g2()-12-2;if(n<0||n>=s)throw new Error('Invalid script file (bad trailer pos)');e.pos=n;const i=new Xt(t);e.g4();i.intLocalCount=e.g2(),i.stringLocalCount=e.g2(),i.intArgCount=e.g2(),i.stringArgCount=e.g2();const a=e.g1();for(let t=0;t<a;t++){const s=e.g2(),n=[];for(let t=0;t<s;t++){const t=e.g4(),s=e.g4();n[t]=s}i.switchTables[t]=n}e.pos=0,i.info.scriptName=e.gjstr(0),i.info.sourceFilePath=e.gjstr(0),i.info.lookupKey=e.g4();const r=e.g1();for(let t=0;t<r;t++)i.info.parameterTypes.push(e.g1());const o=e.g2();for(let t=0;t<o;t++)i.info.pcs.push(e.g4()),i.info.lines.push(e.g4());let c=0;for(;n>e.pos;){const t=e.g2();t===$t.PUSH_CONSTANT_STRING?i.stringOperands[c]=e.gjstr(0):Xt.isLargeOperand(t)?i.intOperands[c]=e.g4():i.intOperands[c]=e.g1(),i.opcodes[c++]=t}return i}constructor(t){this.id=t}get name(){return this.info.scriptName}get fileName(){return Jt.basename(this.info.sourceFilePath)}lineNumber(t){for(let e=0;e<this.info.pcs.length;e++)if(this.info.pcs[e]>t)return this.info.lines[e-1];return this.info.lines[this.info.lines.length-1]}}class Qt{static COMPILER_VERSION=18;static scripts=[];static scriptLookup=new Map;static scriptNames=new Map;static async load(t){const e=await f.load(`${t}/server/script.dat`),s=await f.load(`${t}/server/script.idx`);e.data.length&&s.data.length||(console.log('\nFatal: No script.dat or script.idx found. Please run the server:build script.'),process.exit(1));const n=e.g2();s.pos+=2;e.g4()!==Qt.COMPILER_VERSION&&(console.error('\nFatal: Scripts were compiled with an older RuneScript compiler. Please update it, try `npm run build` and then restart the server.'),process.exit(1));const i=new Array(n),a=new Map,r=new Map;let o=0;for(let t=0;t<n;t++){const n=s.g2();if(0!==n)try{const s=new Uint8Array(n);e.gdata(s,0,s.length);const c=Xt.decode(t,new f(s));i[t]=c,a.set(c.name,t),4294967295!==c.info.lookupKey&&r.set(c.info.lookupKey,c),o++}catch(e){return console.error(e),console.error(`Warning: Failed to load script ${t}, something may have been partially written`),-1}}return Qt.scripts=i,Qt.scriptNames=a,Qt.scriptLookup=r,o}static get(t){return this.scripts[t]}static getByName(t){const e=Qt.scriptNames.get(t);if(void 0!==e)return Qt.scripts[e]}static getByTrigger(t,e=-1,s=-1){let n=Qt.scriptLookup.get(512|t|e<<10);return n||(n=Qt.scriptLookup.get(256|t|s<<10),n||Qt.scriptLookup.get(t))}static getByTriggerSpecific(t,e=-1,s=-1){return-1!==e?Qt.scriptLookup.get(512|t|e<<10):-1!==s?Qt.scriptLookup.get(256|t|s<<10):Qt.scriptLookup.get(t)}}function qt(t){return 0|t}function te(t,e,s){return t&~(ee[s-e+1]<<e)}var ee=function(){const t=[0];let e=2;for(let s=1;s<33;++s)t[s]=qt(e-1),e+=e;return t}();class se{static ABORTED=-1;static RUNNING=0;static FINISHED=1;static SUSPENDED=2;static PAUSEBUTTON=3;static COUNTDIALOG=4;static NPC_SUSPENDED=5;static WORLD_SUSPENDED=6;script;trigger;execution=se.RUNNING;executionHistory=[];pc=-1;opcount=0;frames=[];fp=0;debugFrames=[];debugFp=0;intStack=[];isp=0;stringStack=[];ssp=0;intLocals=[];stringLocals=[];pointers=0;self=null;_activePlayer=null;_activePlayer2=null;_activeNpc=null;_activeNpc2=null;_activeLoc=null;_activeLoc2=null;_activeObj=null;_activeObj2=null;splitPages=[];splitMesanim=-1;dbTable=null;dbColumn=-1;dbRow=-1;dbRowQuery=[];huntIterator=null;npcIterator=null;locIterator=null;lastInt=0;constructor(t,e=[]){if(this.script=t,this.trigger=255&t.info.lookupKey,e)for(let t=0;t<e.length;t++){const s=e[t];'number'==typeof s?this.intLocals.push(s):this.stringLocals.push(s)}}pointerSet(...t){this.pointers=0;for(let e=0;e<t.length;e++)this.pointers|=1<<t[e]}pointerAdd(t){this.pointers|=1<<t}pointerRemove(t){this.pointers&=~(1<<t)}pointerGet(t){return!!(this.pointers&1<<t)}pointerCheck(...t){for(let e=0;e<t.length;e++){const s=1<<t[e];if((this.pointers&s)!=s)throw new Error(`Required pointer: ${se.pointerPrint(s)}, current: ${se.pointerPrint(this.pointers)}`)}}static pointerPrint(t){let e='';for(let s=0;s<kt._LAST;s++)t&1<<s&&(e+=`${kt[s]}, `);return e.substring(0,e.lastIndexOf(','))}get activePlayer(){const t=0===this.intOperand?this._activePlayer:this._activePlayer2;if(null===t)throw new Error('Attempt to access null active_player');return t}set activePlayer(t){0===this.intOperand?this._activePlayer=t:this._activePlayer2=t}get activeNpc(){const t=0===this.intOperand?this._activeNpc:this._activeNpc2;if(null===t)throw new Error('Attempt to access null active_npc');return t}set activeNpc(t){0===this.intOperand?this._activeNpc=t:this._activeNpc2=t}get activeLoc(){const t=0===this.intOperand?this._activeLoc:this._activeLoc2;if(null===t)throw new Error('Attempt to access null active_loc');return t}set activeLoc(t){0===this.intOperand?this._activeLoc=t:this._activeLoc2=t}get activeObj(){const t=0===this.intOperand?this._activeObj:this._activeObj2;if(null===t)throw new Error('Attempt to access null active_obj');return t}set activeObj(t){0===this.intOperand?this._activeObj=t:this._activeObj2=t}get intOperand(){return this.script.intOperands[this.pc]}get stringOperand(){return this.script.stringOperands[this.pc]}popInt(){const t=this.intStack[--this.isp];return t?qt(t):0}popInts(t){const e=Array(t);for(let s=t-1;s>=0;s--)e[s]=this.popInt();return e}pushInt(t){this.intStack[this.isp++]=qt(t)}popString(){return this.stringStack[--this.ssp]??''}popStrings(t){const e=Array(t);for(let s=t-1;s>=0;s--)e[s]=this.popString();return e}pushString(t){this.stringStack[this.ssp++]=t}reset(){this.pc=-1,this.frames=[],this.fp=0,this.intStack=[],this.isp=0,this.stringStack=[],this.ssp=0,this.intLocals=[],this.stringLocals=[],this.pointers=0}}class ne{requested=0;completed=0;items=[];constructor(t,e=0,s=[]){this.requested=t,this.completed=e,this.items=s}getLeftOver(){return this.requested-this.completed}hasSucceeded(){return this.completed==this.requested}hasFailed(){return!this.hasSucceeded()}revert(t){for(let e=0;e<this.items.length;e++){const s=this.items[e].item;t.remove(s.id,s.count,this.items[e].slot)}}}class ie{static STACK_LIMIT=2147483647;static NORMAL_STACK=0;static ALWAYS_STACK=1;static NEVER_STACK=2;static fromType(t){if(-1===t)throw new Error('Invalid inventory type');const e=J.get(t);let s=ie.NORMAL_STACK;e.stackall&&(s=ie.ALWAYS_STACK);const n=new ie(t,e.size,s);if(e.stockobj&&e.stockcount&&e.stockobj.length)for(let t=0;t<e.stockobj.length;t++)n.set(t,{id:e.stockobj[t],count:e.stockcount[t]});return n}stackType;capacity;type;items;update=!1;constructor(t,e,s=ie.NORMAL_STACK){this.type=t,this.capacity=e,this.stackType=s,this.items=new Array(e).fill(null)}contains(t){return this.items.some((e=>e&&e.id==t))}hasAt(t,e){const s=this.items[t];return s&&s.id==e}get nextFreeSlot(){return this.items.indexOf(null,0)}get freeSlotCount(){return this.items.filter((t=>null==t)).length}get occupiedSlotCount(){return this.items.filter((t=>null!=t)).length}get isFull(){return this.occupiedSlotCount==this.capacity}get isEmpty(){return 0==this.occupiedSlotCount}get hasAny(){return this.items.some((t=>null!=t))}get hasSpace(){return-1!=this.nextFreeSlot}get itemsFiltered(){return this.items.filter((t=>null!=t))}getItemCount(t){let e=0;for(let s=0;s<this.capacity;s++){const n=this.items[s];n&&n.id==t&&(e+=n.count)}return Math.min(ie.STACK_LIMIT,e)}getItemIndex(t){return this.items.findIndex((e=>e&&e.id==t))}removeAll(){this.items.fill(null,0,this.capacity),this.update=!0}add(t,e=1,s=-1,n=!0,i=!1,a=!1){const r=gt.get(t),o=!0===J.get(this.type).stockobj?.includes(t),c=!i&&this.stackType!=ie.NEVER_STACK&&(r.stackable||this.stackType==ie.ALWAYS_STACK);let l=0;if(c&&(l=this.getItemCount(t)),l==ie.STACK_LIMIT)return new ne(e,0,[]);const h=this.freeSlotCount;if(0==h&&(!c||c&&0==l&&!o))return new ne(e,0,[]);if(n){if(c&&l>ie.STACK_LIMIT-e)return new ne(e,0,[]);if(!c&&e>h)return new ne(e,0,[])}else{if(c&&l==ie.STACK_LIMIT)return new ne(e,0,[]);if(!c&&0==h)return new ne(e,0,[])}let d=0;const p=[];if(c){let n=this.getItemIndex(t);if(-1==n&&(n=-1==s?this.nextFreeSlot:this.items.indexOf(null,s),-1==n))return new ne(e,d,[]);const i=this.get(n)?.count??0,r=Math.min(ie.STACK_LIMIT,i+e),o={id:t,count:r};a||this.set(n,o),p.push({slot:n,item:o}),d=r-i}else{for(let n=Math.max(0,s);n<this.capacity;n++){if(null!=this.items[n])continue;const s={id:t,count:1};if(a||this.set(n,s),p.push({slot:n,item:s}),++d>=e)break}}return new ne(e,d,p)}remove(t,e=1,s=-1,n=!1){const i=this.getItemCount(t),a=!0===J.get(this.type).stockobj?.includes(t);if(n&&i<e)return new ne(e,0,[]);if(!n&&i<1)return new ne(e,0,[]);let r=0;const o=[];let c=null;if(-1!=s){c=[];for(let t=0;t<s;t++)c.push(t)}let l=0;-1!=s&&(l=s);for(let s=l;s<this.capacity;s++){const n=this.items[s];if(!n||n.id!=t)continue;const i=Math.min(n.count,e-r);if(r+=i,n.count-=i,0==n.count&&!a){const t=this.items[s];this.items[s]=null,t&&o.push({slot:s,item:t})}if(r>=e)break}if(null!=c&&r<e)for(let s=0;s<c.length;s++){const n=this.items[s];if(!n||n.id!=t)continue;const i=Math.min(n.count,e-r);if(r+=i,n.count-=i,0==n.count&&!a){const t=this.items[s];this.items[s]=null,t&&o.push({slot:s,item:t})}if(r>=e)break}return r>0&&(this.update=!0),new ne(e,r,o)}delete(t){this.items[t]=null,this.update=!0}swap(t,e){const s=this.items[t];this.set(t,this.items[e]),this.set(e,s)}shift(){this.items.sort(((t,e)=>null===t||null===e?+(null===t)-+(null===e):+(t>e)||-(t<e))),this.update=!0}get(t){return this.items[t]}set(t,e){this.items[t]=e,this.update=!0}validSlot(t){return t>=0&&t<this.capacity}transfer(t,e,s=-1,n=-1,i=!1,a=!1){if(e.count<=0)return null;const r=Math.min(e.count,this.getItemCount(e.id)),o=gt.get(e.id);let c={id:e.id,count:r};(i&&-1!==o.certlink&&-1===o.certtemplate||a&&-1!==o.certlink&&o.certtemplate>=0)&&(c={id:o.certlink,count:r});const l=t.add(c.id,c.count,n,!1);if(0==l.completed)return null;const h=this.remove(e.id,l.completed,s,!1);return 0==h.completed?null:h}}async function ae(t,e={}){const s={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,s,n){t=o(t>>>0),e=o(e>>>0),s>>>=0,n>>>=0,(()=>{throw Error(`${t} in ${e}:${s}:${n}`)})()},seed:()=>Date.now()*Math.random()})},{exports:n}=await WebAssembly.instantiate(t,s),i=n.memory||e.env.memory,a=Object.setPrototypeOf({findPath(t,e,s,i,a,r,o,l,d,p,u,_,g,m){return u=u?1:0,n.__setArgumentsLength(arguments.length),c(h,2,n.findPath(t,e,s,i,a,r,o,l,d,p,u,_,g,m)>>>0)},findNaivePath(t,e,s,i,a,r,o,l,d,p,u){return n.__setArgumentsLength(arguments.length),c(h,2,n.findNaivePath(t,e,s,i,a,r,o,l,d,p,u)>>>0)},changeFloor(t,e,s,i){i=i?1:0,n.changeFloor(t,e,s,i)},changeLoc(t,e,s,i,a,r,o,c){r=r?1:0,o=o?1:0,c=c?1:0,n.changeLoc(t,e,s,i,a,r,o,c)},changeNpc(t,e,s,i,a){a=a?1:0,n.changeNpc(t,e,s,i,a)},changePlayer(t,e,s,i,a){a=a?1:0,n.changePlayer(t,e,s,i,a)},changeRoof(t,e,s,i){i=i?1:0,n.changeRoof(t,e,s,i)},changeWall(t,e,s,i,a,r,o,c){r=r?1:0,o=o?1:0,c=c?1:0,n.changeWall(t,e,s,i,a,r,o,c)},allocateIfAbsent:(t,e,s)=>c(h,2,n.allocateIfAbsent(t,e,s)>>>0),isZoneAllocated:(t,e,s)=>0!=n.isZoneAllocated(t,e,s),isFlagged:(t,e,s,i)=>0!=n.isFlagged(t,e,s,i),canTravel(t,e,s,i,a,r,o,c){return n.__setArgumentsLength(arguments.length),0!=n.canTravel(t,e,s,i,a,r,o,c)},hasLineOfSight(t,e,s,i,a,r,o,c,l,h){return n.__setArgumentsLength(arguments.length),0!=n.hasLineOfSight(t,e,s,i,a,r,o,c,l,h)},hasLineOfWalk(t,e,s,i,a,r,o,c,l,h){return n.__setArgumentsLength(arguments.length),0!=n.hasLineOfWalk(t,e,s,i,a,r,o,c,l,h)},lineOfSight(t,e,s,i,a,r,o,l,d,p){return n.__setArgumentsLength(arguments.length),c(h,2,n.lineOfSight(t,e,s,i,a,r,o,l,d,p)>>>0)},lineOfWalk(t,e,s,i,a,r,o,l,d,p){return n.__setArgumentsLength(arguments.length),c(h,2,n.lineOfWalk(t,e,s,i,a,r,o,l,d,p)>>>0)},reached(t,e,s,i,a,r,o,c,l,h,d){return n.__setArgumentsLength(arguments.length),0!=n.reached(t,e,s,i,a,r,o,c,l,h,d)},__collides:(t,e,s,i,a,r,o,c)=>0!=n.__collides(t,e,s,i,a,r,o,c),__reachRectangle1:(t,e,s,i,a,r,o,c)=>0!=n.__reachRectangle1(t,e,s,i,a,r,o,c),__reachRectangleN:(t,e,s,i,a,r,o,c,l,h)=>0!=n.__reachRectangleN(t,e,s,i,a,r,o,c,l,h),__reachRectangle:(t,e,s,i,a,r,o,c,l,h)=>0!=n.__reachRectangle(t,e,s,i,a,r,o,c,l,h),__reachExclusiveRectangle:(t,e,s,i,a,r,o,c,l,h)=>0!=n.__reachExclusiveRectangle(t,e,s,i,a,r,o,c,l,h),CollisionFlag:(r={},r[r.NULL=n['CollisionFlag.NULL'].valueOf()]='NULL',r[r.OPEN=n['CollisionFlag.OPEN'].valueOf()]='OPEN',r[r.WALL_NORTH_WEST=n['CollisionFlag.WALL_NORTH_WEST'].valueOf()]='WALL_NORTH_WEST',r[r.WALL_NORTH=n['CollisionFlag.WALL_NORTH'].valueOf()]='WALL_NORTH',r[r.WALL_NORTH_EAST=n['CollisionFlag.WALL_NORTH_EAST'].valueOf()]='WALL_NORTH_EAST',r[r.WALL_EAST=n['CollisionFlag.WALL_EAST'].valueOf()]='WALL_EAST',r[r.WALL_SOUTH_EAST=n['CollisionFlag.WALL_SOUTH_EAST'].valueOf()]='WALL_SOUTH_EAST',r[r.WALL_SOUTH=n['CollisionFlag.WALL_SOUTH'].valueOf()]='WALL_SOUTH',r[r.WALL_SOUTH_WEST=n['CollisionFlag.WALL_SOUTH_WEST'].valueOf()]='WALL_SOUTH_WEST',r[r.WALL_WEST=n['CollisionFlag.WALL_WEST'].valueOf()]='WALL_WEST',r[r.LOC=n['CollisionFlag.LOC'].valueOf()]='LOC',r[r.WALL_NORTH_WEST_PROJ_BLOCKER=n['CollisionFlag.WALL_NORTH_WEST_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_WEST_PROJ_BLOCKER',r[r.WALL_NORTH_PROJ_BLOCKER=n['CollisionFlag.WALL_NORTH_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_PROJ_BLOCKER',r[r.WALL_NORTH_EAST_PROJ_BLOCKER=n['CollisionFlag.WALL_NORTH_EAST_PROJ_BLOCKER'].valueOf()]='WALL_NORTH_EAST_PROJ_BLOCKER',r[r.WALL_EAST_PROJ_BLOCKER=n['CollisionFlag.WALL_EAST_PROJ_BLOCKER'].valueOf()]='WALL_EAST_PROJ_BLOCKER',r[r.WALL_SOUTH_EAST_PROJ_BLOCKER=n['CollisionFlag.WALL_SOUTH_EAST_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_EAST_PROJ_BLOCKER',r[r.WALL_SOUTH_PROJ_BLOCKER=n['CollisionFlag.WALL_SOUTH_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_PROJ_BLOCKER',r[r.WALL_SOUTH_WEST_PROJ_BLOCKER=n['CollisionFlag.WALL_SOUTH_WEST_PROJ_BLOCKER'].valueOf()]='WALL_SOUTH_WEST_PROJ_BLOCKER',r[r.WALL_WEST_PROJ_BLOCKER=n['CollisionFlag.WALL_WEST_PROJ_BLOCKER'].valueOf()]='WALL_WEST_PROJ_BLOCKER',r[r.LOC_PROJ_BLOCKER=n['CollisionFlag.LOC_PROJ_BLOCKER'].valueOf()]='LOC_PROJ_BLOCKER',r[r.FLOOR_DECORATION=n['CollisionFlag.FLOOR_DECORATION'].valueOf()]='FLOOR_DECORATION',r[r.NPC=n['CollisionFlag.NPC'].valueOf()]='NPC',r[r.PLAYER=n['CollisionFlag.PLAYER'].valueOf()]='PLAYER',r[r.FLOOR=n['CollisionFlag.FLOOR'].valueOf()]='FLOOR',r[r.WALL_NORTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.WALL_NORTH_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_WEST_ROUTE_BLOCKER',r[r.WALL_NORTH_ROUTE_BLOCKER=n['CollisionFlag.WALL_NORTH_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_ROUTE_BLOCKER',r[r.WALL_NORTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.WALL_NORTH_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_NORTH_EAST_ROUTE_BLOCKER',r[r.WALL_EAST_ROUTE_BLOCKER=n['CollisionFlag.WALL_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_EAST_ROUTE_BLOCKER',r[r.WALL_SOUTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.WALL_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_EAST_ROUTE_BLOCKER',r[r.WALL_SOUTH_ROUTE_BLOCKER=n['CollisionFlag.WALL_SOUTH_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_ROUTE_BLOCKER',r[r.WALL_SOUTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.WALL_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_SOUTH_WEST_ROUTE_BLOCKER',r[r.WALL_WEST_ROUTE_BLOCKER=n['CollisionFlag.WALL_WEST_ROUTE_BLOCKER'].valueOf()]='WALL_WEST_ROUTE_BLOCKER',r[r.LOC_ROUTE_BLOCKER=n['CollisionFlag.LOC_ROUTE_BLOCKER'].valueOf()]='LOC_ROUTE_BLOCKER',r[r.ROOF=n['CollisionFlag.ROOF'].valueOf()]='ROOF',r[r.FLOOR_BLOCKED=n['CollisionFlag.FLOOR_BLOCKED'].valueOf()]='FLOOR_BLOCKED',r[r.WALK_BLOCKED=n['CollisionFlag.WALK_BLOCKED'].valueOf()]='WALK_BLOCKED',r[r.BLOCK_WEST=n['CollisionFlag.BLOCK_WEST'].valueOf()]='BLOCK_WEST',r[r.BLOCK_EAST=n['CollisionFlag.BLOCK_EAST'].valueOf()]='BLOCK_EAST',r[r.BLOCK_SOUTH=n['CollisionFlag.BLOCK_SOUTH'].valueOf()]='BLOCK_SOUTH',r[r.BLOCK_NORTH=n['CollisionFlag.BLOCK_NORTH'].valueOf()]='BLOCK_NORTH',r[r.BLOCK_SOUTH_WEST=n['CollisionFlag.BLOCK_SOUTH_WEST'].valueOf()]='BLOCK_SOUTH_WEST',r[r.BLOCK_SOUTH_EAST=n['CollisionFlag.BLOCK_SOUTH_EAST'].valueOf()]='BLOCK_SOUTH_EAST',r[r.BLOCK_NORTH_WEST=n['CollisionFlag.BLOCK_NORTH_WEST'].valueOf()]='BLOCK_NORTH_WEST',r[r.BLOCK_NORTH_EAST=n['CollisionFlag.BLOCK_NORTH_EAST'].valueOf()]='BLOCK_NORTH_EAST',r[r.BLOCK_NORTH_AND_SOUTH_EAST=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST'].valueOf()]='BLOCK_NORTH_AND_SOUTH_EAST',r[r.BLOCK_NORTH_AND_SOUTH_WEST=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST'].valueOf()]='BLOCK_NORTH_AND_SOUTH_WEST',r[r.BLOCK_NORTH_EAST_AND_WEST=n['CollisionFlag.BLOCK_NORTH_EAST_AND_WEST'].valueOf()]='BLOCK_NORTH_EAST_AND_WEST',r[r.BLOCK_SOUTH_EAST_AND_WEST=n['CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST'].valueOf()]='BLOCK_SOUTH_EAST_AND_WEST',r[r.BLOCK_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_WEST_ROUTE_BLOCKER',r[r.BLOCK_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_EAST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_ROUTE_BLOCKER',r[r.BLOCK_NORTH_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_AND_SOUTH_EAST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_AND_SOUTH_WEST_ROUTE_BLOCKER',r[r.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_NORTH_EAST_AND_WEST_ROUTE_BLOCKER',r[r.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER=n['CollisionFlag.BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER'].valueOf()]='BLOCK_SOUTH_EAST_AND_WEST_ROUTE_BLOCKER',r),LocShape:(t=>(t[t.WALL_STRAIGHT=n['LocShape.WALL_STRAIGHT'].valueOf()]='WALL_STRAIGHT',t[t.WALL_DIAGONAL_CORNER=n['LocShape.WALL_DIAGONAL_CORNER'].valueOf()]='WALL_DIAGONAL_CORNER',t[t.WALL_L=n['LocShape.WALL_L'].valueOf()]='WALL_L',t[t.WALL_SQUARE_CORNER=n['LocShape.WALL_SQUARE_CORNER'].valueOf()]='WALL_SQUARE_CORNER',t[t.WALLDECOR_STRAIGHT_NOOFFSET=n['LocShape.WALLDECOR_STRAIGHT_NOOFFSET'].valueOf()]='WALLDECOR_STRAIGHT_NOOFFSET',t[t.WALLDECOR_STRAIGHT_OFFSET=n['LocShape.WALLDECOR_STRAIGHT_OFFSET'].valueOf()]='WALLDECOR_STRAIGHT_OFFSET',t[t.WALLDECOR_DIAGONAL_OFFSET=n['LocShape.WALLDECOR_DIAGONAL_OFFSET'].valueOf()]='WALLDECOR_DIAGONAL_OFFSET',t[t.WALLDECOR_DIAGONAL_NOOFFSET=n['LocShape.WALLDECOR_DIAGONAL_NOOFFSET'].valueOf()]='WALLDECOR_DIAGONAL_NOOFFSET',t[t.WALLDECOR_DIAGONAL_BOTH=n['LocShape.WALLDECOR_DIAGONAL_BOTH'].valueOf()]='WALLDECOR_DIAGONAL_BOTH',t[t.WALL_DIAGONAL=n['LocShape.WALL_DIAGONAL'].valueOf()]='WALL_DIAGONAL',t[t.CENTREPIECE_STRAIGHT=n['LocShape.CENTREPIECE_STRAIGHT'].valueOf()]='CENTREPIECE_STRAIGHT',t[t.CENTREPIECE_DIAGONAL=n['LocShape.CENTREPIECE_DIAGONAL'].valueOf()]='CENTREPIECE_DIAGONAL',t[t.ROOF_STRAIGHT=n['LocShape.ROOF_STRAIGHT'].valueOf()]='ROOF_STRAIGHT',t[t.ROOF_DIAGONAL_WITH_ROOFEDGE=n['LocShape.ROOF_DIAGONAL_WITH_ROOFEDGE'].valueOf()]='ROOF_DIAGONAL_WITH_ROOFEDGE',t[t.ROOF_DIAGONAL=n['LocShape.ROOF_DIAGONAL'].valueOf()]='ROOF_DIAGONAL',t[t.ROOF_L_CONCAVE=n['LocShape.ROOF_L_CONCAVE'].valueOf()]='ROOF_L_CONCAVE',t[t.ROOF_L_CONVEX=n['LocShape.ROOF_L_CONVEX'].valueOf()]='ROOF_L_CONVEX',t[t.ROOF_FLAT=n['LocShape.ROOF_FLAT'].valueOf()]='ROOF_FLAT',t[t.ROOFEDGE_STRAIGHT=n['LocShape.ROOFEDGE_STRAIGHT'].valueOf()]='ROOFEDGE_STRAIGHT',t[t.ROOFEDGE_DIAGONAL_CORNER=n['LocShape.ROOFEDGE_DIAGONAL_CORNER'].valueOf()]='ROOFEDGE_DIAGONAL_CORNER',t[t.ROOFEDGE_L=n['LocShape.ROOFEDGE_L'].valueOf()]='ROOFEDGE_L',t[t.ROOFEDGE_SQUARE_CORNER=n['LocShape.ROOFEDGE_SQUARE_CORNER'].valueOf()]='ROOFEDGE_SQUARE_CORNER',t[t.GROUND_DECOR=n['LocShape.GROUND_DECOR'].valueOf()]='GROUND_DECOR',t))({}),LocAngle:(t=>(t[t.WEST=n['LocAngle.WEST'].valueOf()]='WEST',t[t.NORTH=n['LocAngle.NORTH'].valueOf()]='NORTH',t[t.EAST=n['LocAngle.EAST'].valueOf()]='EAST',t[t.SOUTH=n['LocAngle.SOUTH'].valueOf()]='SOUTH',t))({}),CollisionType:(t=>(t[t.NORMAL=n['CollisionType.NORMAL'].valueOf()]='NORMAL',t[t.BLOCKED=n['CollisionType.BLOCKED'].valueOf()]='BLOCKED',t[t.INDOORS=n['CollisionType.INDOORS'].valueOf()]='INDOORS',t[t.OUTDOORS=n['CollisionType.OUTDOORS'].valueOf()]='OUTDOORS',t[t.LINE_OF_SIGHT=n['CollisionType.LINE_OF_SIGHT'].valueOf()]='LINE_OF_SIGHT',t))({}),LocLayer:(t=>(t[t.WALL=n['LocLayer.WALL'].valueOf()]='WALL',t[t.WALL_DECOR=n['LocLayer.WALL_DECOR'].valueOf()]='WALL_DECOR',t[t.GROUND=n['LocLayer.GROUND'].valueOf()]='GROUND',t[t.GROUND_DECOR=n['LocLayer.GROUND_DECOR'].valueOf()]='GROUND_DECOR',t))({}),BlockAccessFlag:(t=>(t[t.BLOCK_NORTH=n['BlockAccessFlag.BLOCK_NORTH'].valueOf()]='BLOCK_NORTH',t[t.BLOCK_EAST=n['BlockAccessFlag.BLOCK_EAST'].valueOf()]='BLOCK_EAST',t[t.BLOCK_SOUTH=n['BlockAccessFlag.BLOCK_SOUTH'].valueOf()]='BLOCK_SOUTH',t[t.BLOCK_WEST=n['BlockAccessFlag.BLOCK_WEST'].valueOf()]='BLOCK_WEST',t))({})},n);var r;function o(t){if(!t)return null;const e=t+new Uint32Array(i.buffer)[t-4>>>2]>>>1,s=new Uint16Array(i.buffer);let n=t>>>1,a='';for(;e-n>1024;)a+=String.fromCharCode(...s.subarray(n,n+=1024));return a+String.fromCharCode(...s.subarray(n,e))}function c(t,e,s){if(!s)return null;const n=function(t){try{return l.getUint32(t,!0)}catch{return l=new DataView(i.buffer),l.getUint32(t,!0)}}(s-4)>>>e,a=new Array(n);for(let i=0;i<n;++i)a[i]=t(s+(i<<e>>>0));return a}let l=new DataView(i.buffer);function h(t){try{return l.getInt32(t,!0)}catch{return l=new DataView(i.buffer),l.getInt32(t,!0)}}return a}var re,oe,{memory:ce,findPath:le,findNaivePath:he,changeFloor:de,changeLoc:pe,changeNpc:ue,changePlayer:_e,changeRoof:ge,changeWall:me,allocateIfAbsent:Ee,deallocateIfPresent:Oe,isZoneAllocated:fe,isFlagged:Ae,canTravel:Te,hasLineOfSight:Ie,hasLineOfWalk:Ne,lineOfSight:Pe,lineOfWalk:Le,reached:Se,locShapeLayer:Ce,__get:ye,__set:ve,__add:we,__remove:Re,__rotate:be,__rotateFlags:Ue,__collides:De,__reachRectangle1:Me,__reachRectangleN:ke,__alteredRotation:xe,__reachRectangle:Be,__reachExclusiveRectangle:He,CollisionFlag:Fe,LocShape:Ge,LocAngle:We,CollisionType:ze,LocLayer:Ve,BlockAccessFlag:Ye}=await(async t=>ae(await(async()=>{try{return await globalThis.WebAssembly.compileStreaming(globalThis.fetch(t))}catch{return globalThis.WebAssembly.compile(await(await import('node:fs/promises')).readFile(t))}})(),{}))(new URL('rsmod-pathfinder.wasm',import.meta.url)),Ke=0,je=1,Ze=2,Je=3,$e=4,Xe=5,Qe=6,qe=7,ts={zone:t=>t>>3,zoneCenter:t=>ts.zone(t)-6,zoneOrigin:t=>ts.zoneCenter(t)<<3,mapsquare:t=>t>>6,local:t=>t-(ts.zoneCenter(t)<<3),localOrigin:t=>t-(ts.mapsquare(t)<<6),zoneUpdate:t=>t-(t>>3<<3),face:(t,e,s,n)=>t!=s?t>s?e>n?Xe:e<n?Ke:Je:e>n?qe:e<n?Ze:$e:e>n?Qe:e<n?je:-1,moveX:(t,e)=>t+ts.deltaX(e),moveZ:(t,e)=>t+ts.deltaZ(e),distanceTo(t,e){const s=ts.closest(t,e),n=ts.closest(e,t);return Math.max(Math.abs(s.x-n.x),Math.abs(s.z-n.z))},closest(t,e){const s=t.x+t.width-1,n=t.z+t.length-1;return{x:e.x<=t.x?t.x:e.x>=s?s:e.x,z:e.z<=t.z?t.z:e.z>=n?n:e.z}},distanceToSW(t,e){const s=Math.abs(t.x-e.x),n=Math.abs(t.z-e.z);return Math.max(s,n)},isWithinDistanceSW(t,e,s){const n=Math.abs(t.x-e.x);return Math.abs(t.z-e.z)<s&&n<s},deltaX(t){switch(t){case qe:case Ze:case $e:return 1;case Xe:case Ke:case Je:return-1}return 0},deltaZ(t){switch(t){case Ke:case Ze:case je:return 1;case Xe:case qe:case Qe:return-1}return 0},unpackCoord:t=>({level:t>>28&3,x:t>>14&16383,z:16383&t}),packCoord:(t,e,s)=>16383&s|(16383&e)<<14|(3&t)<<28,packZoneCoord:(t,e)=>(7&t)<<4|7&e,intersects:(t,e,s,n,i,a,r,o)=>!(i>=t+s||i+r<=t||a>=e+n||a+o<=e),formatString:(t,e,s,n="_")=>t+n+(e>>6)+n+(s>>6)+n+(63&e)+n+(63&s)};(oe=re||={})[oe.BLOCK=0]='BLOCK',oe[oe.DAMAGE=1]='DAMAGE',oe[oe.POISON=2]='POISON';var es,ss,ns=re;(ss=es||={})[ss.ATTACK=0]='ATTACK',ss[ss.DEFENCE=1]='DEFENCE',ss[ss.STRENGTH=2]='STRENGTH',ss[ss.HITPOINTS=3]='HITPOINTS',ss[ss.RANGED=4]='RANGED',ss[ss.PRAYER=5]='PRAYER',ss[ss.MAGIC=6]='MAGIC',ss[ss.COOKING=7]='COOKING',ss[ss.WOODCUTTING=8]='WOODCUTTING',ss[ss.FLETCHING=9]='FLETCHING',ss[ss.FISHING=10]='FISHING',ss[ss.FIREMAKING=11]='FIREMAKING',ss[ss.CRAFTING=12]='CRAFTING',ss[ss.SMITHING=13]='SMITHING',ss[ss.MINING=14]='MINING',ss[ss.HERBLORE=15]='HERBLORE',ss[ss.AGILITY=16]='AGILITY',ss[ss.THIEVING=17]='THIEVING',ss[ss.STAT18=18]='STAT18',ss[ss.STAT19=19]='STAT19',ss[ss.RUNECRAFT=20]='RUNECRAFT';var is=es;function as(t,e){return e.validate(t)}class rs{type;count;name;constructor(t,e,s){this.type=t,this.count=e,this.name=s}validate(t){if(this.count(t))return this.type(t);throw new Error(`An input for a ${this.name} type was not valid to use. Input was ${t}.`)}}class os{min;max;name;constructor(t,e,s){this.min=t,this.max=e,this.name=s}validate(t){if(t>=this.min&&t<=this.max)return t;throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${t}.`)}}var cs,ls,hs=new class{validate(t){if(-1!==t)return t;throw Error('An input number was null(-1).')}},ds=new class{validate(t){if(t.length>0)return t;throw Error('An input string was null(-1).')}},ps=new rs(et.get,(t=>t>=0&&t<et.count),'Loc'),us=new os(We.WEST,We.SOUTH,'LocAngle'),_s=new os(Ge.WALL_STRAIGHT,Ge.GROUND_DECOR,'LocShape'),gs=new os(1,2147483647,'Duration'),ms=new class extends os{validate(t){if(t>=this.min&&t<=this.max)return ts.unpackCoord(t);throw new Error(`An input for a ${this.name} was out of range. Range should be: ${this.min} to ${this.max}. Input was ${t}.`)}}(0,2147483647,'Coord'),Es=new rs(dt.get,(t=>t>=0&&t<dt.count),'Param'),Os=new rs(ht.get,(t=>t>=0&&t<ht.count),'Npc'),As=new os(lt.ATTACK,lt.MAGIC,'NpcStat'),Ts=new os(is.ATTACK,is.RUNECRAFT,'PlayerStat'),Is=new os(0,19,'AIQueue'),Ns=new rs(K.get,(t=>t>=0&&t<K.count),'Hunt'),Ps=new os(Y.NULL,Y.APNPC5,'NpcMode'),Ls=new os(ns.BLOCK,ns.POISON,'Hit'),Ss=new rs(Ct.get,(t=>t>=0&&t<Ct.count),'Spotanim'),Cs=new rs(L.get,(t=>t>=0&&t<L.count),'Enum'),ys=new rs(gt.get,(t=>t>=0&&t<gt.count),'Obj'),vs=new os(1,ie.STACK_LIMIT,'ObjStack'),ws=new rs(J.get,(t=>t>=0&&t<J.count),'Inv'),Rs=new rs(T.get,(t=>t>=0&&t<T.count),'Cat'),bs=new rs(j.get,(t=>t>=0&&t<j.count),'Idk'),Us=new os(V.OFF,V.LINEOFWALK,'HuntVis'),Ds=new rs(Et.get,(t=>t>=0&&t<Et.count),'Seq'),Ms=new rs(At.get,(t=>t>=0&&t<At.count),'Varp'),ks=new rs(ft.get,(t=>t>=0&&t<ft.count),'Varn'),xs=new rs(Tt.get,(t=>t>=0&&t<Tt.count),'Vars'),Bs=new rs(b.get,(t=>t>=0&&t<b.count),'Font'),Hs=new rs(st.get,(t=>t>=0&&t<st.count),'Mesanim'),Fs=new rs(Ot.get,(t=>t>=0&&t<Ot.count),'Struct'),Gs=new rs(P.get,(t=>t>=0&&t<P.count),'Dbrow'),Ws=new rs(N.get,(t=>t>=0&&t<N.count),'Dbtable'),zs=new os(0,1,'Gender'),Vs=new os(0,7,'SkinColour'),Ys=function(t,e){if(t.fp>=50)throw new Error('stack overflow');t.frames[t.fp++]={script:t.script,pc:t.pc,intLocals:t.intLocals,stringLocals:t.stringLocals};const s=Qt.get(e);if(!s)throw new Error(`unable to find proc ${s}`);js(t,s)},Ks=function(t,e){const s=Qt.get(e);if(!s)throw new Error(`unable to find label ${e}`);t.debugFrames[t.debugFp++]={script:t.script,pc:t.pc},js(t,s),t.fp=0,t.frames=[]},js=function(t,e){t.script=e,t.pc=-1,t.intLocals=t.popInts(e.intArgCount),t.stringLocals=t.popStrings(e.stringArgCount)},Zs={[$t.PUSH_CONSTANT_INT]:t=>{t.pushInt(t.intOperand)},[$t.PUSH_CONSTANT_STRING]:t=>{t.pushString(t.stringOperand)},[$t.PUSH_VARP]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activePlayer2)throw new Error('No secondary active_player.');if(!e&&!t._activePlayer)throw new Error('No active_player.');const s=as(65535&t.intOperand,Ms);s.type===I.STRING?t.pushString(e?t._activePlayer2.getVar(s.id):t._activePlayer.getVar(s.id)):t.pushInt(e?t._activePlayer2.getVar(s.id):t._activePlayer.getVar(s.id))},[$t.POP_VARP]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activePlayer2)throw new Error('No secondary active_player.');if(!e&&!t._activePlayer)throw new Error('No active_player.');const s=as(65535&t.intOperand,Ms);if(!t.pointerGet(Mt[e])&&s.protect)throw new Error(`%${s.debugname} requires protected access`);if(s.type===I.STRING){const n=t.popString();e?t._activePlayer2.setVar(s.id,n):t._activePlayer.setVar(s.id,n)}else{const n=t.popInt();e?t._activePlayer2.setVar(s.id,n):t._activePlayer.setVar(s.id,n)}},[$t.PUSH_VARN]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activeNpc2)throw new Error('No secondary active_npc.');if(!e&&!t._activeNpc)throw new Error('No active_npc.');const s=as(65535&t.intOperand,ks);s.type===I.STRING?t.pushString(e?t._activeNpc2.getVar(s.id):t._activeNpc.getVar(s.id)):t.pushInt(e?t._activeNpc2.getVar(s.id):t._activeNpc.getVar(s.id))},[$t.POP_VARN]:t=>{const e=t.intOperand>>16&1;if(e&&!t._activeNpc2)throw new Error('No secondary active_npc.');if(!e&&!t._activeNpc)throw new Error('No active_npc.');const s=as(65535&t.intOperand,ks);if(s.type===I.STRING){const n=t.popInt();e?t._activeNpc2.setVar(s.id,n):t._activeNpc.setVar(s.id,n)}else{const n=t.popInt();e?t._activeNpc2.setVar(s.id,n):t._activeNpc.setVar(s.id,n)}},[$t.PUSH_INT_LOCAL]:t=>{t.pushInt(t.intLocals[t.intOperand])},[$t.POP_INT_LOCAL]:t=>{t.intLocals[t.intOperand]=t.popInt()},[$t.PUSH_STRING_LOCAL]:t=>{t.pushString(t.stringLocals[t.intOperand])},[$t.POP_STRING_LOCAL]:t=>{t.stringLocals[t.intOperand]=t.popString()},[$t.BRANCH]:t=>{t.pc+=t.intOperand},[$t.BRANCH_NOT]:t=>{const e=t.popInt();t.popInt()!==e&&(t.pc+=t.intOperand)},[$t.BRANCH_EQUALS]:t=>{const e=t.popInt();t.popInt()===e&&(t.pc+=t.intOperand)},[$t.BRANCH_LESS_THAN]:t=>{const e=t.popInt();t.popInt()<e&&(t.pc+=t.intOperand)},[$t.BRANCH_GREATER_THAN]:t=>{const e=t.popInt();t.popInt()>e&&(t.pc+=t.intOperand)},[$t.BRANCH_LESS_THAN_OR_EQUALS]:t=>{const e=t.popInt();t.popInt()<=e&&(t.pc+=t.intOperand)},[$t.BRANCH_GREATER_THAN_OR_EQUALS]:t=>{const e=t.popInt();t.popInt()>=e&&(t.pc+=t.intOperand)},[$t.POP_INT_DISCARD]:t=>{t.isp--},[$t.POP_STRING_DISCARD]:t=>{t.ssp--},[$t.RETURN]:t=>{if(0===t.fp)return void(t.execution=se.FINISHED);const e=t.frames[--t.fp];t.pc=e.pc,t.script=e.script,t.intLocals=e.intLocals,t.stringLocals=e.stringLocals},[$t.JOIN_STRING]:t=>{const e=t.intOperand,s=[];for(let n=0;n<e;n++)s.push(t.popString());t.pushString(s.reverse().join(''))},[$t.GOSUB]:t=>{Ys(t,t.popInt())},[$t.GOSUB_WITH_PARAMS]:t=>{Ys(t,t.intOperand)},[$t.JUMP]:t=>{Ks(t,t.popInt())},[$t.JUMP_WITH_PARAMS]:t=>{Ks(t,t.intOperand)},[$t.DEFINE_ARRAY]:t=>{throw new Error('unimplemented')},[$t.PUSH_ARRAY_INT]:t=>{throw new Error('unimplemented')},[$t.POP_ARRAY_INT]:t=>{throw new Error('unimplemented')},[$t.SWITCH]:t=>{const e=t.popInt(),s=t.script.switchTables[t.intOperand];if(void 0===s)return;const n=s[e];n&&(t.pc+=n)},[$t.PUSH_VARS]:t=>{const e=as(65535&t.intOperand,xs);e.type===I.STRING?t.pushString(rl.varsString[e.id]??''):t.pushInt(rl.vars[e.id])},[$t.POP_VARS]:t=>{const e=as(65535&t.intOperand,xs);e.type===I.STRING?rl.varsString[e.id]=t.popString():rl.vars[e.id]=t.popInt()}},Js={[$t.DB_FIND_WITH_COUNT]:t=>{throw new Error('unimplemented')},[$t.DB_FINDNEXT]:t=>{if(!t.dbTable)throw new Error('No table selected');t.dbRow+1>=t.dbRowQuery.length?t.pushInt(-1):(t.dbRow++,t.pushInt(as(t.dbRowQuery[t.dbRow],Gs).id))},[$t.DB_GETFIELD]:t=>{const[e,s,n]=t.popInts(3),i=s>>12&65535,a=s>>4&127,r=as(e,Gs),o=as(i,Ws);let c;c=r.tableId!==i?o.getDefault(a):r.getValue(a,n);const l=o.types[a];for(let e=0;e<c.length;e++)l[e]===I.STRING?t.pushString(c[e]):t.pushInt(c[e])},[$t.DB_GETFIELDCOUNT]:t=>{const[e,s]=t.popInts(2),n=s>>12&65535,i=s>>4&127,a=as(e,Gs),r=as(n,Ws);a.tableId===n?t.pushInt(a.columnValues[i].length/r.types[i].length):t.pushInt(0)},[$t.DB_LISTALL_WITH_COUNT]:t=>{throw new Error('unimplemented')},[$t.DB_GETROWTABLE]:t=>{t.pushInt(as(t.popInt(),Gs).tableId)},[$t.DB_FINDBYINDEX]:t=>{throw new Error('unimplemented')},[$t.DB_FIND_REFINE_WITH_COUNT]:t=>{throw new Error('unimplemented')},[$t.DB_FIND]:t=>{const e=2==t.popInt()?t.popString():t.popInt(),s=t.popInt(),n=s>>12&65535,i=s>>4&127;t.dbTable=as(n,Ws),t.dbRow=-1,t.dbRowQuery=[];const a=P.getInTable(n);for(let s=0;s<a.length;s++){const n=a[s];n.columnValues[i].includes(e)&&t.dbRowQuery.push(n.id)}t.pushInt(t.dbRowQuery.length)},[$t.DB_FIND_REFINE]:t=>{const e=2==t.popInt()?t.popString():t.popInt(),s=t.popInt(),n=s>>12&65535,i=s>>4&127,a=[],r=P.getInTable(n);for(let t=0;t<r.length;t++){const s=r[t];s.columnValues[i].includes(e)&&a.push(s.id)}const o=t.dbRowQuery;t.dbRow=-1,t.dbRowQuery=[];for(let e=0;e<o.length;e++)a.includes(o[e])&&t.dbRowQuery.push(o[e]);t.pushInt(t.dbRowQuery.length)},[$t.DB_LISTALL]:t=>{throw new Error('unimplemented')}};(ls=cs||={})[ls.CYCLE=0]='CYCLE',ls[ls.WORLD=1]='WORLD',ls[ls.CLIENT_IN=2]='CLIENT_IN',ls[ls.NPC=3]='NPC',ls[ls.PLAYER=4]='PLAYER',ls[ls.LOGOUT=5]='LOGOUT',ls[ls.LOGIN=6]='LOGIN',ls[ls.ZONE=7]='ZONE',ls[ls.CLIENT_OUT=8]='CLIENT_OUT',ls[ls.CLEANUP=9]='CLEANUP',ls[ls.BANDWIDTH_IN=10]='BANDWIDTH_IN',ls[ls.BANDWIDTH_OUT=11]='BANDWIDTH_OUT';var $s,Xs,Qs=cs,qs={[$t.ERROR]:t=>{throw new Error(t.popString())},[$t.MAP_PRODUCTION]:t=>{t.pushInt(_t.NODE_PRODUCTION?1:0)},[$t.MAP_LASTCLOCK]:t=>{t.pushInt(rl.lastCycleStats[Qs.CYCLE])},[$t.MAP_LASTWORLD]:t=>{t.pushInt(rl.lastCycleStats[Qs.WORLD])},[$t.MAP_LASTCLIENTIN]:t=>{t.pushInt(rl.lastCycleStats[Qs.CLIENT_IN])},[$t.MAP_LASTNPC]:t=>{t.pushInt(rl.lastCycleStats[Qs.NPC])},[$t.MAP_LASTPLAYER]:t=>{t.pushInt(rl.lastCycleStats[Qs.PLAYER])},[$t.MAP_LASTLOGOUT]:t=>{t.pushInt(rl.lastCycleStats[Qs.LOGOUT])},[$t.MAP_LASTLOGIN]:t=>{t.pushInt(rl.lastCycleStats[Qs.LOGIN])},[$t.MAP_LASTZONE]:t=>{t.pushInt(rl.lastCycleStats[Qs.ZONE])},[$t.MAP_LASTCLIENTOUT]:t=>{t.pushInt(rl.lastCycleStats[Qs.CLIENT_OUT])},[$t.MAP_LASTCLEANUP]:t=>{t.pushInt(rl.lastCycleStats[Qs.CLEANUP])},[$t.MAP_LASTBANDWIDTHIN]:t=>{t.pushInt(rl.lastCycleStats[Qs.BANDWIDTH_IN])},[$t.MAP_LASTBANDWIDTHOUT]:t=>{t.pushInt(rl.lastCycleStats[Qs.BANDWIDTH_OUT])}},tn={[$t.ENUM]:t=>{const[e,s,n,i]=t.popInts(4),a=as(n,Cs);if(a.inputtype!==e||a.outputtype!==s)throw new Error(`Type validation error: ${a.debugname} key: ${i}. Expected input: ${e} got: ${a.inputtype}. Expected output: ${s} got: ${a.outputtype}`);const r=a.values.get(i);'string'==typeof r?t.pushString(r??a.defaultString):t.pushInt(r??a.defaultInt)},[$t.ENUM_GETOUTPUTCOUNT]:t=>{t.pushInt(as(t.popInt(),Cs).values.size)}};(Xs=$s||={})[Xs.FOREVER=0]='FOREVER',Xs[Xs.RESPAWN=1]='RESPAWN',Xs[Xs.DESPAWN=2]='DESPAWN';var en=$s;class sn{level;x;z;width;length;lifecycle;lifecycleTick=-1;lastLifecycleTick=-1;constructor(t,e,s,n,i,a){this.level=t,this.x=e,this.z=s,this.width=n,this.length=i,this.lifecycle=a}updateLifeCycle(t){return this.lifecycleTick===t&&this.lifecycle!==en.FOREVER}checkLifeCycle(t){return this.lifecycle===en.FOREVER||(this.lifecycle===en.RESPAWN?this.lifecycleTick<t:this.lifecycle===en.DESPAWN&&this.lifecycleTick>t)}setLifeCycle(t){this.lifecycleTick=t,this.lastLifecycleTick=rl.currentTick}}class nn extends sn{resetEntity(t){}}class an extends nn{type;count;receiverId=-1;reveal=-1;constructor(t,e,s,n,i,a){super(t,e,s,1,1,n),this.type=i,this.count=a}}var rn,on,cn={[$t.INV_ALLSTOCK]:t=>{const e=as(t.popInt(),ws);t.pushInt(e.allstock?1:0)},[$t.INV_SIZE]:t=>{const e=as(t.popInt(),ws);t.pushInt(e.size)},[$t.INV_STOCKBASE]:t=>{const[e,s]=t.popInts(2),n=as(e,ws),i=as(s,ys);if(!n.stockobj||!n.stockcount)return void t.pushInt(-1);const a=n.stockobj.indexOf(i.id);t.pushInt(a>=0?n.stockcount[a]:-1)},[$t.INV_ADD]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3),i=as(e,ws),a=as(s,ys);if(as(n,vs),!t.pointerGet(Mt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);if(!i.dummyinv&&0!==a.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${a.debugname} -> ${i.debugname}`);const r=t.activePlayer,o=n-r.invAdd(i.id,a.id,n);o>0&&rl.addObj(new an(r.level,r.x,r.z,en.DESPAWN,a.id,o),r.pid,200)})),[$t.INV_CHANGESLOT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4);throw new Error('unimplemented')})),[$t.INV_CLEAR]:yt(Dt,(t=>{const e=as(t.popInt(),ws);if(!t.pointerGet(Mt[t.intOperand])&&e.protect&&e.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${e.debugname}`);t.activePlayer.invClear(e.id)})),[$t.INV_DEL]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3),i=as(e,ws),a=as(s,ys);if(as(n,vs),!t.pointerGet(Mt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);t.activePlayer.invDel(i.id,a.id,n)})),[$t.INV_DELSLOT]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws);if(!t.pointerGet(Mt[t.intOperand])&&n.protect&&n.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${n.debugname}`);t.activePlayer.invGetSlot(n.id,s)&&t.activePlayer.invDelSlot(n.id,s)})),[$t.INV_DROPITEM]:yt(Dt,(t=>{const[e,s,n,i,a]=t.popInts(5),r=as(e,ws),o=as(s,ms),c=as(n,ys);if(as(i,vs),as(a,gs),!t.pointerGet(Mt[t.intOperand])&&r.protect&&r.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const l=t.activePlayer,h=l.invDel(r.id,c.id,i);if(0==h)return;l.playerLog('Dropped item from',r.debugname,c.debugname);const d=new an(o.level,o.x,o.z,en.DESPAWN,c.id,h);rl.addObj(d,l.pid,a),t.activeObj=d,t.pointerAdd(Ut[t.intOperand])})),[$t.INV_DROPSLOT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws);as(i,gs);const r=as(s,ms);if(!t.pointerGet(Mt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const o=t.activePlayer.invGetSlot(a.id,n);if(!o)throw new Error('$slot is empty');const c=t.activePlayer,l=c.invDel(a.id,o.id,o.count,n);if(0===l)return;const h=gt.get(o.id);c.playerLog('Dropped item from',a.debugname,h.debugname);const d=new an(r.level,r.x,r.z,en.DESPAWN,o.id,l);rl.addObj(d,c.pid,i),t.activeObj=d,t.pointerAdd(Ut[t.intOperand])})),[$t.INV_FREESPACE]:yt(Dt,(t=>{const e=as(t.popInt(),ws);t.pushInt(t.activePlayer.invFreeSpace(e.id))})),[$t.INV_GETNUM]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws);t.pushInt(t.activePlayer.invGetSlot(n.id,s)?.count??0)})),[$t.INV_GETOBJ]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws);t.pushInt(t.activePlayer.invGetSlot(n.id,s)?.id??-1)})),[$t.INV_ITEMSPACE]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(s,ys);if(as(n,vs),i<0||i>a.size)throw new Error(`$count is out of range: ${n}`);t.pushInt(0===t.activePlayer.invItemSpace(a.id,r.id,n,i)?1:0)})),[$t.INV_ITEMSPACE2]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(s,ys);as(n,vs),t.pushInt(t.activePlayer.invItemSpace(a.id,r.id,n,i))})),[$t.INV_MOVEFROMSLOT]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3),i=as(e,ws),a=as(s,ws);if(!t.pointerGet(Mt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);if(!t.pointerGet(Mt[t.intOperand])&&a.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);const r=t.activePlayer,{overflow:o,fromObj:c}=r.invMoveFromSlot(i.id,a.id,n);o>0&&rl.addObj(new an(r.level,r.x,r.z,en.DESPAWN,c,o),r.pid,200)})),[$t.INV_MOVETOSLOT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(s,ws);if(!t.pointerGet(Mt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Mt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);t.activePlayer.invMoveToSlot(a.id,r.id,n,i)})),[$t.BOTH_MOVEINV]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws),i=as(s,ws),a=1==t.intOperand,r=a?t._activePlayer2:t._activePlayer,o=a?t._activePlayer:t._activePlayer2;if(!r||!o)throw new Error('player is null');if(!t.pointerGet(Mt[a?1:0])&&n.protect&&n.scope!==J.SCOPE_SHARED)throw new Error(`$from_inv requires protected access: ${n.debugname}`);if(!t.pointerGet(Mt[a?0:1])&&i.protect&&n.scope!==J.SCOPE_SHARED)throw new Error(`$to_inv requires protected access: ${i.debugname}`);const c=r.getInventory(e),l=o.getInventory(s);if(!c||!l)throw new Error('inv is null');for(let t=0;t<c.capacity;t++){const e=c.get(t);e&&(c.delete(t),l.add(e.id,e.count),r.playerLog('Gave '+gt.get(e.id).name+' x'+e.count+' during trade with '+o.username),o.playerLog('Received '+gt.get(e.id).name+' x'+e.count+' during trade with '+r.username))}})),[$t.INV_MOVEITEM]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(s,ws),o=as(n,ys);if(as(i,vs),!t.pointerGet(Mt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Mt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);if(0==l)return;const h=i-c.invAdd(r.id,o.id,l);h>0&&rl.addObj(new an(c.level,c.x,c.z,en.DESPAWN,o.id,h),c.pid,200)})),[$t.INV_MOVEITEM_CERT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(s,ws),o=as(n,ys);if(as(i,vs),!t.pointerGet(Mt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Mt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);if(0==l)return;let h=o.id;-1===o.certtemplate&&o.certlink>=0&&(h=o.certlink);const d=i-c.invAdd(r.id,h,l);d>0&&rl.addObj(new an(c.level,c.x,c.z,en.DESPAWN,h,d),c.pid,200)})),[$t.INV_MOVEITEM_UNCERT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(s,ws),o=as(n,ys);if(as(i,vs),!t.pointerGet(Mt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!t.pointerGet(Mt[t.intOperand])&&r.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${r.debugname}`);const c=t.activePlayer,l=c.invDel(a.id,o.id,i);0!=l&&(o.certtemplate>=0&&o.certlink>=0?c.invAdd(r.id,o.certlink,l):c.invAdd(r.id,o.id,l))})),[$t.INV_SETSLOT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws),r=as(n,ys);if(as(i,vs),!t.pointerGet(Mt[t.intOperand])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${a.debugname}`);if(!a.dummyinv&&0!==r.dummyitem)throw new Error(`dummyitem in non-dummyinv: ${r.debugname} -> ${a.debugname}`);t.activePlayer.invSet(a.id,r.id,i,s)})),[$t.INV_TOTAL]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws);-1!==s?t.pushInt(t.activePlayer.invTotal(n.id,s)):t.pushInt(0)})),[$t.INV_TOTALCAT]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws),i=as(s,Rs);t.pushInt(t.activePlayer.invTotalCat(n.id,i.id))})),[$t.INV_TRANSMIT]:yt(Dt,(t=>{const[e,s]=t.popInts(2),n=as(e,ws);as(s,hs),t.activePlayer.invListenOnCom(n.id,s,t.activePlayer.uid)})),[$t.INVOTHER_TRANSMIT]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,hs);const i=as(s,ws);as(n,hs),t.activePlayer.invListenOnCom(i.id,n,e)})),[$t.INV_STOPTRANSMIT]:yt(Dt,(t=>{const e=as(t.popInt(),hs);t.activePlayer.invStopListenOnCom(e)})),[$t.BOTH_DROPSLOT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ws);as(i,gs);const r=as(s,ms),o=1==t.intOperand,c=o?t._activePlayer2:t._activePlayer,l=o?t._activePlayer:t._activePlayer2;if(!c||!l)throw new Error('player is null');if(!t.pointerGet(Mt[o?1:0])&&a.protect&&a.scope!==J.SCOPE_SHARED)throw new Error(`inv requires protected access: ${a.debugname}`);const h=c.invGetSlot(a.id,n);if(!h)throw new Error('$slot is empty');const d=c.invDel(a.id,h.id,h.count,n);if(0===d)return;const p=gt.get(h.id);c.playerLog('Dropped item from',a.debugname,p.debugname),p.tradeable&&rl.addObj(new an(r.level,r.x,r.z,en.DESPAWN,h.id,d),l.pid,i)})),[$t.INV_DROPALL]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3),i=as(e,ws);as(n,gs);const a=as(s,ms);if(!t.pointerGet(Mt[t.intOperand])&&i.protect&&i.scope!==J.SCOPE_SHARED)throw new Error(`$inv requires protected access: ${i.debugname}`);const r=t.activePlayer.getInventory(i.id);if(r)for(let t=0;t<r.capacity;t++){const e=r.get(t);if(!e)continue;r.delete(t);gt.get(e.id).tradeable&&rl.addObj(new an(a.level,a.x,a.z,en.DESPAWN,e.id,e.count),-1,n)}})),[$t.INV_TOTALPARAM]:yt(Dt,(t=>{const[e,s]=t.popInts(2);t.pushInt(t.activePlayer.invTotalParam(e,s))})),[$t.INV_TOTALPARAM_STACK]:yt(Dt,(t=>{const[e,s]=t.popInts(2);t.pushInt(t.activePlayer.invTotalParamStack(e,s))}))};(on=rn||={})[on.ZONE=0]='ZONE',on[on.DISTANCE=1]='DISTANCE';var ln=rn;class hn{iterator;tick;constructor(t){this.iterator=this.generator(),this.tick=t}[Symbol.iterator](){return this.iterator}next(){return this.iterator.next()}}class dn extends hn{x;z;level;minX;maxX;minZ;maxZ;distance;checkVis;checkType;checkCategory;type;constructor(t,e,s,n,i,a,r,o,c){super(t);const l=ts.zone(s),h=ts.zone(n),d=1+i/8|0;this.x=s,this.z=n,this.level=e,this.maxX=l+d,this.minX=l-d,this.maxZ=h+d,this.minZ=h-d,this.distance=i,this.checkVis=a,this.checkType=r,this.checkCategory=o,this.type=c}*generator(){for(let t=this.maxX;t>=this.minX;t--){const e=t<<3;for(let t=this.maxZ;t>=this.minZ;t--){const s=t<<3;if(this.type===B.PLAYER)for(const t of rl.getZone(e,s,this.level).getAllPlayersSafe()){if(rl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');ts.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ne(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t)}else if(this.type===B.NPC)for(const t of rl.getZone(e,s,this.level).getAllNpcsSafe()){if(rl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=ht.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||e.op&&e.op[1]&&(ts.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ne(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}else if(this.type===B.OBJ)for(const t of rl.getZone(e,s,this.level).getAllObjsSafe()){if(rl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=gt.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||(ts.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ne(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}else if(this.type===B.SCENERY)for(const t of rl.getZone(e,s,this.level).getAllLocsSafe()){if(rl.currentTick>this.tick)throw new Error('[HuntIterator] tried to use an old iterator. Create a new iterator instead.');if(-1!==this.checkType&&t.type!==this.checkType)continue;const e=et.get(t.type);-1!==this.checkCategory&&e.category!==this.checkCategory||(ts.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ne(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t))}}}}}class pn extends hn{level;x;z;minX;maxX;minZ;maxZ;distance;checkVis;type;constructor(t,e,s,n,i,a,r){super(t);const o=ts.zone(s),c=ts.zone(n),l=1+i/8|0;this.x=s,this.z=n,this.level=e,this.maxX=o+l,this.minX=o-l,this.maxZ=c+l,this.minZ=c-l,this.distance=i,this.checkVis=a,this.type=r}*generator(){if(this.type===ln.ZONE)for(const t of rl.getZone(this.x,this.z,this.level).getAllNpcsSafe()){if(rl.currentTick>this.tick)throw new Error('[NpcIterator] tried to use an old iterator. Create a new iterator instead.');yield t}else if(this.type===ln.DISTANCE)for(let t=this.maxX;t>=this.minX;t--){const e=t<<3;for(let t=this.maxZ;t>=this.minZ;t--){const s=t<<3;for(const t of rl.getZone(e,s,this.level).getAllNpcsSafe()){if(rl.currentTick>this.tick)throw new Error('[NpcIterator] tried to use an old iterator. Create a new iterator instead.');ts.distanceToSW({x:this.x,z:this.z},t)>this.distance||(this.checkVis!==V.LINEOFSIGHT||Ie(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(this.checkVis!==V.LINEOFWALK||Ne(this.level,this.x,this.z,t.x,t.z,1,1,1,1))&&(yield t)}}}}}class un extends hn{level;x;z;constructor(t,e,s,n){super(t),this.level=e,this.x=s,this.z=n}*generator(){for(const t of rl.getZone(this.x,this.z,this.level).getAllLocsSafe()){if(rl.currentTick>this.tick)throw new Error('[LocIterator] tried to use an old iterator. Create a new iterator instead.');yield t}}}class _n extends nn{info;constructor(t,e,s,n,i,a,r,o,c){super(t,e,s,n,i,a),this.info=16383&r|(31&o)<<14|(3&c)<<19}get type(){return 16383&this.info}get shape(){return this.info>>14&31}get angle(){return this.info>>19&3}}var gn,mn,En={[$t.LOC_ADD]:t=>{const[e,s,n,i,a]=t.popInts(5),r=as(e,ms),o=as(s,ps),c=as(n,us),l=as(i,_s);as(a,gs);const h=new _n(r.level,r.x,r.z,o.width,o.length,en.DESPAWN,o.id,l,c),d=rl.getZone(r.x,r.z,r.level).getLocsUnsafe(ts.packZoneCoord(r.x,r.z));for(const t of d)if(t!==h&&t.angle===c&&t.shape===l){rl.removeLoc(t,a);break}rl.addLoc(h,a),t.activeLoc=h,t.pointerAdd(bt[t.intOperand])},[$t.LOC_ANGLE]:yt(bt,(t=>{t.pushInt(as(t.activeLoc.angle,us))})),[$t.LOC_ANIM]:yt(bt,(t=>{const e=as(t.popInt(),Ds);rl.animLoc(t.activeLoc,e.id)})),[$t.LOC_CATEGORY]:yt(bt,(t=>{t.pushInt(as(t.activeLoc.type,ps).category)})),[$t.LOC_CHANGE]:yt(bt,(t=>{const[e,s]=t.popInts(2),n=as(e,ps);as(s,gs),rl.removeLoc(t.activeLoc,s);const{level:i,x:a,z:r,angle:o,shape:c}=t.activeLoc,l=new _n(i,a,r,n.width,n.length,en.DESPAWN,n.id,c,o),h=rl.getZone(a,r,i).getLocsUnsafe(ts.packZoneCoord(a,r));for(const t of h)if(t!==l&&t.angle===o&&t.shape===c){rl.removeLoc(t,s);break}rl.addLoc(l,s),t.activeLoc=l,t.pointerAdd(bt[t.intOperand])})),[$t.LOC_COORD]:yt(bt,(t=>{const e=t.activeLoc;t.pushInt(ts.packCoord(e.level,e.x,e.z))})),[$t.LOC_DEL]:yt(bt,(t=>{const e=as(t.popInt(),gs),{level:s,x:n,z:i,angle:a,shape:r}=t.activeLoc,o=rl.getZone(n,i,s).getLocsUnsafe(ts.packZoneCoord(n,i));for(const s of o)if(s!==t.activeLoc&&s.angle===a&&s.shape===r){rl.removeLoc(s,e);break}rl.removeLoc(t.activeLoc,e)})),[$t.LOC_FIND]:t=>{const[e,s]=t.popInts(2),n=as(s,ps),i=as(e,ms),a=rl.getLoc(i.x,i.z,i.level,n.id);a?(t.activeLoc=a,t.pointerAdd(bt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.LOC_FINDALLZONE]:t=>{const e=as(t.popInt(),ms);t.locIterator=new un(rl.currentTick,e.level,e.x,e.z),t._activeLoc&&(t._activeLoc2=t._activeLoc,t.pointerAdd(kt.ActiveLoc2))},[$t.LOC_FINDNEXT]:t=>{const e=t.locIterator?.next();e&&!e.done?(t.activeLoc=e.value,t.pointerAdd(bt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.LOC_PARAM]:yt(bt,(t=>{const e=as(t.popInt(),Es),s=as(t.activeLoc.type,ps);e.isString()?t.pushString(Q(e.id,s,e.defaultString)):t.pushInt(q(e.id,s,e.defaultInt))})),[$t.LOC_TYPE]:yt(bt,(t=>{t.pushInt(as(t.activeLoc.type,ps).id)})),[$t.LOC_NAME]:yt(bt,(t=>{t.pushString(as(t.activeLoc.type,ps).name??'null')})),[$t.LOC_SHAPE]:yt(bt,(t=>{t.pushInt(as(t.activeLoc.shape,_s))}))},On=En,fn={[$t.LC_NAME]:t=>{const e=as(t.popInt(),ps);t.pushString(e.name??e.debugname??'null')},[$t.LC_PARAM]:t=>{const[e,s]=t.popInts(2),n=as(e,ps),i=as(s,Es);i.isString()?t.pushString(Q(i.id,n,i.defaultString)):t.pushInt(q(i.id,n,i.defaultInt))},[$t.LC_CATEGORY]:t=>{t.pushInt(as(t.popInt(),ps).category)},[$t.LC_DESC]:t=>{t.pushString(as(t.popInt(),ps).desc??'null')},[$t.LC_DEBUGNAME]:t=>{t.pushString(as(t.popInt(),ps).debugname??'null')},[$t.LC_WIDTH]:t=>{t.pushInt(as(t.popInt(),ps).width)},[$t.LC_LENGTH]:t=>{t.pushInt(as(t.popInt(),ps).length)}};(mn=gn||={})[mn.PROC=0]='PROC',mn[mn.LABEL=1]='LABEL',mn[mn.DEBUGPROC=2]='DEBUGPROC',mn[mn.APNPC1=3]='APNPC1',mn[mn.APNPC2=4]='APNPC2',mn[mn.APNPC3=5]='APNPC3',mn[mn.APNPC4=6]='APNPC4',mn[mn.APNPC5=7]='APNPC5',mn[mn.APNPCU=8]='APNPCU',mn[mn.APNPCT=9]='APNPCT',mn[mn.OPNPC1=10]='OPNPC1',mn[mn.OPNPC2=11]='OPNPC2',mn[mn.OPNPC3=12]='OPNPC3',mn[mn.OPNPC4=13]='OPNPC4',mn[mn.OPNPC5=14]='OPNPC5',mn[mn.OPNPCU=15]='OPNPCU',mn[mn.OPNPCT=16]='OPNPCT',mn[mn.AI_APNPC1=17]='AI_APNPC1',mn[mn.AI_APNPC2=18]='AI_APNPC2',mn[mn.AI_APNPC3=19]='AI_APNPC3',mn[mn.AI_APNPC4=20]='AI_APNPC4',mn[mn.AI_APNPC5=21]='AI_APNPC5',mn[mn.AI_OPNPC1=24]='AI_OPNPC1',mn[mn.AI_OPNPC2=25]='AI_OPNPC2',mn[mn.AI_OPNPC3=26]='AI_OPNPC3',mn[mn.AI_OPNPC4=27]='AI_OPNPC4',mn[mn.AI_OPNPC5=28]='AI_OPNPC5',mn[mn.APOBJ1=31]='APOBJ1',mn[mn.APOBJ2=32]='APOBJ2',mn[mn.APOBJ3=33]='APOBJ3',mn[mn.APOBJ4=34]='APOBJ4',mn[mn.APOBJ5=35]='APOBJ5',mn[mn.APOBJU=36]='APOBJU',mn[mn.APOBJT=37]='APOBJT',mn[mn.OPOBJ1=38]='OPOBJ1',mn[mn.OPOBJ2=39]='OPOBJ2',mn[mn.OPOBJ3=40]='OPOBJ3',mn[mn.OPOBJ4=41]='OPOBJ4',mn[mn.OPOBJ5=42]='OPOBJ5',mn[mn.OPOBJU=43]='OPOBJU',mn[mn.OPOBJT=44]='OPOBJT',mn[mn.AI_APOBJ1=45]='AI_APOBJ1',mn[mn.AI_APOBJ2=46]='AI_APOBJ2',mn[mn.AI_APOBJ3=47]='AI_APOBJ3',mn[mn.AI_APOBJ4=48]='AI_APOBJ4',mn[mn.AI_APOBJ5=49]='AI_APOBJ5',mn[mn.AI_OPOBJ1=52]='AI_OPOBJ1',mn[mn.AI_OPOBJ2=53]='AI_OPOBJ2',mn[mn.AI_OPOBJ3=54]='AI_OPOBJ3',mn[mn.AI_OPOBJ4=55]='AI_OPOBJ4',mn[mn.AI_OPOBJ5=56]='AI_OPOBJ5',mn[mn.APLOC1=59]='APLOC1',mn[mn.APLOC2=60]='APLOC2',mn[mn.APLOC3=61]='APLOC3',mn[mn.APLOC4=62]='APLOC4',mn[mn.APLOC5=63]='APLOC5',mn[mn.APLOCU=64]='APLOCU',mn[mn.APLOCT=65]='APLOCT',mn[mn.OPLOC1=66]='OPLOC1',mn[mn.OPLOC2=67]='OPLOC2',mn[mn.OPLOC3=68]='OPLOC3',mn[mn.OPLOC4=69]='OPLOC4',mn[mn.OPLOC5=70]='OPLOC5',mn[mn.OPLOCU=71]='OPLOCU',mn[mn.OPLOCT=72]='OPLOCT',mn[mn.AI_APLOC1=73]='AI_APLOC1',mn[mn.AI_APLOC2=74]='AI_APLOC2',mn[mn.AI_APLOC3=75]='AI_APLOC3',mn[mn.AI_APLOC4=76]='AI_APLOC4',mn[mn.AI_APLOC5=77]='AI_APLOC5',mn[mn.AI_OPLOC1=80]='AI_OPLOC1',mn[mn.AI_OPLOC2=81]='AI_OPLOC2',mn[mn.AI_OPLOC3=82]='AI_OPLOC3',mn[mn.AI_OPLOC4=83]='AI_OPLOC4',mn[mn.AI_OPLOC5=84]='AI_OPLOC5',mn[mn.APPLAYER1=87]='APPLAYER1',mn[mn.APPLAYER2=88]='APPLAYER2',mn[mn.APPLAYER3=89]='APPLAYER3',mn[mn.APPLAYER4=90]='APPLAYER4',mn[mn.APPLAYER5=91]='APPLAYER5',mn[mn.APPLAYERU=92]='APPLAYERU',mn[mn.APPLAYERT=93]='APPLAYERT',mn[mn.OPPLAYER1=94]='OPPLAYER1',mn[mn.OPPLAYER2=95]='OPPLAYER2',mn[mn.OPPLAYER3=96]='OPPLAYER3',mn[mn.OPPLAYER4=97]='OPPLAYER4',mn[mn.OPPLAYER5=98]='OPPLAYER5',mn[mn.OPPLAYERU=99]='OPPLAYERU',mn[mn.OPPLAYERT=100]='OPPLAYERT',mn[mn.AI_APPLAYER1=101]='AI_APPLAYER1',mn[mn.AI_APPLAYER2=102]='AI_APPLAYER2',mn[mn.AI_APPLAYER3=103]='AI_APPLAYER3',mn[mn.AI_APPLAYER4=104]='AI_APPLAYER4',mn[mn.AI_APPLAYER5=105]='AI_APPLAYER5',mn[mn.AI_OPPLAYER1=108]='AI_OPPLAYER1',mn[mn.AI_OPPLAYER2=109]='AI_OPPLAYER2',mn[mn.AI_OPPLAYER3=110]='AI_OPPLAYER3',mn[mn.AI_OPPLAYER4=111]='AI_OPPLAYER4',mn[mn.AI_OPPLAYER5=112]='AI_OPPLAYER5',mn[mn.QUEUE=116]='QUEUE',mn[mn.AI_QUEUE1=117]='AI_QUEUE1',mn[mn.AI_QUEUE2=118]='AI_QUEUE2',mn[mn.AI_QUEUE3=119]='AI_QUEUE3',mn[mn.AI_QUEUE4=120]='AI_QUEUE4',mn[mn.AI_QUEUE5=121]='AI_QUEUE5',mn[mn.AI_QUEUE6=122]='AI_QUEUE6',mn[mn.AI_QUEUE7=123]='AI_QUEUE7',mn[mn.AI_QUEUE8=124]='AI_QUEUE8',mn[mn.AI_QUEUE9=125]='AI_QUEUE9',mn[mn.AI_QUEUE10=126]='AI_QUEUE10',mn[mn.AI_QUEUE11=127]='AI_QUEUE11',mn[mn.AI_QUEUE12=128]='AI_QUEUE12',mn[mn.AI_QUEUE13=129]='AI_QUEUE13',mn[mn.AI_QUEUE14=130]='AI_QUEUE14',mn[mn.AI_QUEUE15=131]='AI_QUEUE15',mn[mn.AI_QUEUE16=132]='AI_QUEUE16',mn[mn.AI_QUEUE17=133]='AI_QUEUE17',mn[mn.AI_QUEUE18=134]='AI_QUEUE18',mn[mn.AI_QUEUE19=135]='AI_QUEUE19',mn[mn.AI_QUEUE20=136]='AI_QUEUE20',mn[mn.SOFTTIMER=137]='SOFTTIMER',mn[mn.TIMER=138]='TIMER',mn[mn.AI_TIMER=139]='AI_TIMER',mn[mn.OPHELD1=140]='OPHELD1',mn[mn.OPHELD2=141]='OPHELD2',mn[mn.OPHELD3=142]='OPHELD3',mn[mn.OPHELD4=143]='OPHELD4',mn[mn.OPHELD5=144]='OPHELD5',mn[mn.OPHELDU=145]='OPHELDU',mn[mn.OPHELDT=146]='OPHELDT',mn[mn.IF_BUTTON=147]='IF_BUTTON',mn[mn.INV_BUTTON1=148]='INV_BUTTON1',mn[mn.INV_BUTTON2=149]='INV_BUTTON2',mn[mn.INV_BUTTON3=150]='INV_BUTTON3',mn[mn.INV_BUTTON4=151]='INV_BUTTON4',mn[mn.INV_BUTTON5=152]='INV_BUTTON5',mn[mn.INV_BUTTOND=153]='INV_BUTTOND',mn[mn.IF_CLOSE=154]='IF_CLOSE',mn[mn.LOGIN=155]='LOGIN',mn[mn.LOGOUT=156]='LOGOUT',mn[mn.TUTORIAL_CLICKSIDE=157]='TUTORIAL_CLICKSIDE',mn[mn.MOVE=158]='MOVE',mn[mn.WALKTRIGGER=159]='WALKTRIGGER',mn[mn.AI_WALKTRIGGER=160]='AI_WALKTRIGGER',mn[mn.LEVELUP=161]='LEVELUP',(t=>{t.toString=function(e){return t[e].toLowerCase()}})(gn||={});var An,Tn,In=gn;(Tn=An||={})[Tn.SCRIPT=0]='SCRIPT',Tn[Tn.ENGINE=1]='ENGINE';var Nn=An,Pn={[$t.NPC_FINDUID]:t=>{const e=t.popInt(),s=65535&e,n=e>>16&65535,i=rl.getNpc(s);i&&i.type===n?(t.activeNpc=i,t.pointerAdd(Rt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.NPC_ADD]:t=>{const[e,s,n]=t.popInts(3),i=as(e,ms),a=as(s,Os);as(n,gs);const r=new Yc(i.level,i.x,i.z,a.size,a.size,en.DESPAWN,rl.getNextNid(),a.id,a.moverestrict,a.blockwalk);rl.addNpc(r,n),t.activeNpc=r,t.pointerAdd(Rt[t.intOperand])},[$t.NPC_ANIM]:yt(Rt,(t=>{const e=as(t.popInt(),hs),s=t.popInt();t.activeNpc.playAnimation(s,e)})),[$t.NPC_BASESTAT]:yt(Rt,(t=>{const e=as(t.popInt(),As);t.pushInt(t.activeNpc.baseLevels[e])})),[$t.NPC_CATEGORY]:yt(Rt,(t=>{t.pushInt(as(t.activeNpc.type,Os).category)})),[$t.NPC_COORD]:yt(Rt,(t=>{const e=t.activeNpc;t.pushInt(ts.packCoord(e.level,e.x,e.z))})),[$t.NPC_DEL]:yt(Rt,(t=>{rl.removeNpc(t.activeNpc,as(t.activeNpc.type,Os).respawnrate)})),[$t.NPC_DELAY]:yt(Rt,(t=>{t.activeNpc.delay=t.popInt()+1,t.execution=se.NPC_SUSPENDED})),[$t.NPC_FACESQUARE]:yt(Rt,(t=>{const e=as(t.popInt(),ms);t.activeNpc.faceSquare(e.x,e.z)})),[$t.NPC_FINDEXACT]:t=>{const[e,s]=t.popInts(2),n=as(e,ms),i=as(s,Os);t.npcIterator=new pn(rl.currentTick,n.level,n.x,n.z,0,0,ln.ZONE);for(const e of t.npcIterator)if(e.type===i.id&&e.x===n.x&&e.level===n.level&&e.z===n.z)return t.activeNpc=e,t.pointerAdd(Rt[t.intOperand]),void t.pushInt(1);t.pushInt(0)},[$t.NPC_FINDHERO]:yt(Rt,(t=>{const e=t.activeNpc.findHero();if(-1===e)return void t.pushInt(0);const s=rl.getPlayerByUid(e);s?(t.activePlayer=s,t.pointerAdd(kt.ActivePlayer),t.pushInt(1)):t.pushInt(0)})),[$t.NPC_PARAM]:yt(Rt,(t=>{const e=as(t.popInt(),Es),s=as(t.activeNpc.type,Os);e.isString()?t.pushString(Q(e.id,s,e.defaultString)):t.pushInt(q(e.id,s,e.defaultInt))})),[$t.NPC_QUEUE]:yt(Rt,(t=>{const e=as(t.popInt(),hs),s=t.popInt(),n=as(t.popInt(),Is),i=as(t.activeNpc.type,Os),a=Qt.getByTrigger(In.AI_QUEUE1+n-1,i.id,i.category);a&&t.activeNpc.enqueueScript(a,e,s)})),[$t.NPC_RANGE]:yt(Rt,(t=>{const e=as(t.popInt(),ms),s=t.activeNpc;e.level!==s.level?t.pushInt(-1):t.pushInt(ts.distanceTo(s,{x:e.x,z:e.z,width:1,length:1}))})),[$t.NPC_SAY]:yt(Rt,(t=>{t.activeNpc.say(t.popString())})),[$t.NPC_SETHUNT]:yt(Rt,(t=>{t.activeNpc.huntrange=as(t.popInt(),hs)})),[$t.NPC_SETHUNTMODE]:yt(Rt,(t=>{t.activeNpc.huntMode=as(t.popInt(),Ns).id})),[$t.NPC_SETMODE]:yt(Rt,(t=>{const e=as(t.popInt(),Ps);if(t.activeNpc.clearWaypoints(),e===Y.NULL||e===Y.NONE||e===Y.WANDER||e===Y.PATROL)return t.activeNpc.clearInteraction(),void(t.activeNpc.targetOp=e);let s;t.activeNpc.targetOp=e,s=e>=Y.OPNPC1?t._activeNpc2:e>=Y.OPOBJ1?t._activeObj:e>=Y.OPLOC1?t._activeLoc:t._activePlayer,s?s instanceof Yc||s instanceof an||s instanceof _n?t.activeNpc.setInteraction(Nn.SCRIPT,s,e,{type:s.type,com:-1}):t.activeNpc.setInteraction(Nn.SCRIPT,s,e):t.activeNpc.noMode()})),[$t.NPC_STAT]:yt(Rt,(t=>{const e=as(t.popInt(),As);t.pushInt(t.activeNpc.levels[e])})),[$t.NPC_STATHEAL]:yt(Rt,(t=>{const[e,s,n]=t.popInts(3);as(e,As),as(s,hs),as(n,hs);const i=t.activeNpc,a=i.baseLevels[e],r=i.levels[e],o=r+(s+r*n/100);i.levels[e]=Math.min(o,a),0===e&&i.levels[e]===i.baseLevels[e]&&i.resetHeroPoints()})),[$t.NPC_TYPE]:yt(Rt,(t=>{t.pushInt(as(t.activeNpc.type,Os).id)})),[$t.NPC_DAMAGE]:yt(Rt,(t=>{const e=as(t.popInt(),hs),s=as(t.popInt(),Ls);t.activeNpc.applyDamage(e,s)})),[$t.NPC_NAME]:yt(Rt,(t=>{t.pushString(as(t.activeNpc.type,Os).name??'null')})),[$t.NPC_UID]:yt(Rt,(t=>{t.pushInt(t.activeNpc.uid)})),[$t.NPC_SETTIMER]:yt(Rt,(t=>{t.activeNpc.setTimer(as(t.popInt(),hs))})),[$t.SPOTANIM_NPC]:yt(Rt,(t=>{const e=as(t.popInt(),hs),s=as(t.popInt(),hs),n=as(t.popInt(),Ss);t.activeNpc.spotanim(n.id,s,e)})),[$t.NPC_FIND]:t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ms),r=as(s,Os);as(n,hs);const o=as(i,Us);let c,l=n;const h=new pn(rl.currentTick,a.level,a.x,a.z,n,o,ln.DISTANCE);for(const t of h)if(t&&t.type===r.id){const e=ts.distanceToSW(a,t);e<=l&&(c=t,l=e)}c?(t.activeNpc=c,t.pointerAdd(Rt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.NPC_FINDALLANY]:t=>{const[e,s,n]=t.popInts(3),i=as(e,ms);as(s,hs);const a=as(n,Us);t.npcIterator=new pn(rl.currentTick,i.level,i.x,i.z,s,a,ln.DISTANCE),t._activeNpc&&(t._activeNpc2=t._activeNpc,t.pointerAdd(kt.ActiveNpc2))},[$t.NPC_FINDALLZONE]:t=>{const e=as(t.popInt(),ms);t.npcIterator=new pn(rl.currentTick,e.level,e.x,e.z,0,0,ln.ZONE),t._activeNpc&&(t._activeNpc2=t._activeNpc,t.pointerAdd(kt.ActiveNpc2))},[$t.NPC_FINDNEXT]:t=>{const e=t.npcIterator?.next();e&&!e.done?(t.activeNpc=e.value,t.pointerAdd(Rt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.NPC_TELE]:yt(Rt,(t=>{const e=as(t.popInt(),ms);t.activeNpc.teleport(e.x,e.z,e.level)})),[$t.NPC_WALK]:yt(Rt,(t=>{const e=as(t.popInt(),ms);t.activeNpc.queueWaypoint(e.x,e.z)})),[$t.NPC_CHANGETYPE]:yt(Rt,(t=>{t.activeNpc.changeType(as(t.popInt(),Os).id)})),[$t.NPC_GETMODE]:yt(Rt,(t=>{t.pushInt(t.activeNpc.targetOp)})),[$t.NPC_HEROPOINTS]:yt([kt.ActivePlayer,...Rt],(t=>{t.activeNpc.addHero(t.activePlayer.uid,as(t.popInt(),hs))})),[$t.NPC_WALKTRIGGER]:yt(Rt,(t=>{const[e,s]=t.popInts(2);as(e,Is),t.activeNpc.walktrigger=e-1,t.activeNpc.walktriggerArg=s})),[$t.NPC_STATADD]:yt(Rt,(t=>{const[e,s,n]=t.popInts(3);as(e,As),as(s,hs),as(n,hs);const i=t.activeNpc,a=i.levels[e],r=a+(s+a*n/100);i.levels[e]=Math.min(r,255),0===e&&i.levels[e]>=i.baseLevels[e]&&i.resetHeroPoints()})),[$t.NPC_STATSUB]:yt(Rt,(t=>{const[e,s,n]=t.popInts(3);as(e,As),as(s,hs),as(n,hs);const i=t.activeNpc,a=i.levels[e],r=a-(s+a*n/100);i.levels[e]=Math.max(r,0)})),[$t.NPC_ATTACKRANGE]:yt(Rt,(t=>{t.pushInt(as(t.activeNpc.type,Os).attackrange)}))},Ln={[$t.NC_NAME]:t=>{const e=as(t.popInt(),Os);t.pushString(e.name??e.debugname??'null')},[$t.NC_PARAM]:t=>{const[e,s]=t.popInts(2),n=as(e,Os),i=as(s,Es);i.isString()?t.pushString(Q(s,n,i.defaultString)):t.pushInt(q(s,n,i.defaultInt))},[$t.NC_CATEGORY]:t=>{t.pushInt(as(t.popInt(),Os).category)},[$t.NC_DESC]:t=>{t.pushString(as(t.popInt(),Os).desc??'null')},[$t.NC_DEBUGNAME]:t=>{t.pushString(as(t.popInt(),Os).debugname??'null')},[$t.NC_OP]:t=>{const[e,s]=t.popInts(2),n=as(e,Os);as(s,hs),n.op?t.pushString(n.op[s-1]??''):t.pushString('')}};class Sn{static _sin=new Int32Array(16384);static _cos=new Int32Array(16384);static{const t=.0003834951969714103;for(let e=0;e<16384;e++)this._sin[e]=16384*Math.sin(e*t)|0,this._cos[e]=16384*Math.cos(e*t)|0}static radians(t){return(16383&t)/16384*6.283185307179586}static atan2(t,e){return 16383&Math.round(2607.5945876176133*Math.atan2(t,e))}static sin(t){return this._sin[16383&t]}static cos(t){return this._cos[16383&t]}}var Cn,yn,vn={[$t.ADD]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s+e)},[$t.SUB]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s-e)},[$t.MULTIPLY]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s*e)},[$t.DIVIDE]:t=>{const e=t.popInt(),s=t.popInt();t.pushInt(s/e)},[$t.RANDOM]:t=>{const e=t.popInt();t.pushInt(Math.random()*e)},[$t.RANDOMINC]:t=>{const e=t.popInt();t.pushInt(Math.random()*(e+1))},[$t.INTERPOLATE]:t=>{const[e,s,n,i,a]=t.popInts(5),r=Math.floor((s-e)/(i-n))*(a-n)+e;t.pushInt(r)},[$t.ADDPERCENT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e*s/100+e|0)},[$t.SETBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e|1<<s)},[$t.CLEARBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e&~(1<<s))},[$t.TESTBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e&1<<s?1:0)},[$t.MODULO]:t=>{const[e,s]=t.popInts(2);t.pushInt(e%s)},[$t.POW]:t=>{const[e,s]=t.popInts(2);t.pushInt(Math.pow(e,s))},[$t.INVPOW]:t=>{const[e,s]=t.popInts(2);if(0===e||0===s)t.pushInt(0);else switch(s){case 1:return void t.pushInt(e);case 2:return void t.pushInt(Math.sqrt(e));case 3:return void t.pushInt(Math.cbrt(e));case 4:return void t.pushInt(Math.sqrt(Math.sqrt(e)));default:return void t.pushInt(Math.pow(e,1/s))}},[$t.AND]:t=>{const[e,s]=t.popInts(2);t.pushInt(e&s)},[$t.OR]:t=>{const[e,s]=t.popInts(2);t.pushInt(e|s)},[$t.MIN]:t=>{const[e,s]=t.popInts(2);t.pushInt(Math.min(e,s))},[$t.MAX]:t=>{const[e,s]=t.popInts(2);t.pushInt(Math.max(e,s))},[$t.SCALE]:t=>{const[e,s,n]=t.popInts(3);t.pushInt(e*n/s)},[$t.BITCOUNT]:t=>{var e;t.pushInt((e=t.popInt(),16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24))},[$t.TOGGLEBIT]:t=>{const[e,s]=t.popInts(2);t.pushInt(e^1<<s)},[$t.SETBIT_RANGE]:t=>{const[e,s,n]=t.popInts(3);t.pushInt(function(t,e,s){return t|ee[s-e+1]<<e}(e,s,n))},[$t.CLEARBIT_RANGE]:t=>{const[e,s,n]=t.popInts(3);t.pushInt(te(e,s,n))},[$t.GETBIT_RANGE]:t=>{const[e,s,n]=t.popInts(3),i=31-n;t.pushInt(e<<i>>>s+i)},[$t.SETBIT_RANGE_TOINT]:t=>{const[e,s,n,i]=t.popInts(4),a=te(e,n,i),r=ee[i-n+1];let o=s;s>r&&(o=r),t.pushInt(a|o<<n)},[$t.SIN_DEG]:t=>{t.pushInt(Sn.sin(t.popInt()))},[$t.COS_DEG]:t=>{t.pushInt(Sn.cos(t.popInt()))},[$t.ATAN2_DEG]:t=>{t.pushInt(Sn.atan2(t.popInt(),t.popInt()))},[$t.ABS]:t=>{t.pushInt(Math.abs(t.popInt()))}},wn=vn,Rn={[$t.OBJ_ADD]:t=>{const[e,s,n,i]=t.popInts(4);if(-1===s||-1===n)return;const a=as(s,ys);as(i,gs);const r=as(e,ms);if(as(n,vs),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);if(!a.members||_t.NODE_MEMBERS)if(a.stackable&&1!==n){const e=new an(r.level,r.x,r.z,en.DESPAWN,s,n);rl.addObj(e,t.activePlayer.pid,i),t.activeObj=e,t.pointerAdd(Ut[t.intOperand])}else for(let e=0;e<n;e++){const e=new an(r.level,r.x,r.z,en.DESPAWN,s,1);rl.addObj(e,t.activePlayer.pid,i),t.activeObj=e,t.pointerAdd(Ut[t.intOperand])}},[$t.OBJ_ADDALL]:t=>{const[e,s,n,i]=t.popInts(4);if(-1===s||-1===n)return;const a=as(s,ys);as(i,gs);const r=as(e,ms);if(as(n,vs),0!==a.dummyitem)throw new Error(`attempted to add dummy item: ${a.debugname}`);if(!a.members||_t.NODE_MEMBERS)if(a.stackable&&1!==n){const e=new an(r.level,r.x,r.z,en.DESPAWN,s,n);rl.addObj(e,-1,i),t.activeObj=e,t.pointerAdd(Ut[t.intOperand])}else for(let e=0;e<n;e++){const e=new an(r.level,r.x,r.z,en.DESPAWN,s,1);rl.addObj(e,-1,i),t.activeObj=e,t.pointerAdd(Ut[t.intOperand])}},[$t.OBJ_PARAM]:t=>{const e=as(t.popInt(),Es),s=as(t.activeObj.type,ys);e.isString()?t.pushString(Q(e.id,s,e.defaultString)):t.pushInt(q(e.id,s,e.defaultInt))},[$t.OBJ_NAME]:t=>{const e=as(t.activeObj.type,ys);t.pushString(e.name??e.debugname??'null')},[$t.OBJ_DEL]:t=>{const e=gt.get(t.activeObj.type).respawnrate;t.pointerGet(Dt[t.intOperand]),rl.removeObj(t.activeObj,e)},[$t.OBJ_COUNT]:t=>{t.pushInt(as(t.activeObj.count,vs))},[$t.OBJ_TYPE]:t=>{t.pushInt(as(t.activeObj.type,ys).id)},[$t.OBJ_TAKEITEM]:t=>{const e=as(t.popInt(),ws),s=t.activeObj,n=gt.get(s.type),i=rl.getZone(s.x,s.z,s.level);for(const a of i.getObjsSafe(ts.packZoneCoord(s.x,s.z)))if(a.type===s.type&&a.count===s.count&&(-1===a.receiverId||a.receiverId===t.activePlayer.pid)){if(t.activePlayer.playerLog('Picked up item',n.debugname),t.activePlayer.invAdd(e.id,s.type,s.count),s.lifecycle===en.RESPAWN){rl.removeObj(s,n.respawnrate);break}if(s.lifecycle===en.DESPAWN){rl.removeObj(s,0);break}}},[$t.OBJ_COORD]:t=>{const e=t.activeObj;t.pushInt(ts.packCoord(e.level,e.x,e.z))}},bn={[$t.OC_NAME]:t=>{const e=as(t.popInt(),ys);t.pushString(e.name??e.debugname??'null')},[$t.OC_PARAM]:t=>{const[e,s]=t.popInts(2),n=as(e,ys),i=as(s,Es);i.isString()?t.pushString(Q(i.id,n,i.defaultString)):t.pushInt(q(i.id,n,i.defaultInt))},[$t.OC_CATEGORY]:t=>{t.pushInt(as(t.popInt(),ys).category)},[$t.OC_DESC]:t=>{t.pushString(as(t.popInt(),ys).desc??'null')},[$t.OC_MEMBERS]:t=>{t.pushInt(as(t.popInt(),ys).members?1:0)},[$t.OC_WEIGHT]:t=>{t.pushInt(as(t.popInt(),ys).weight)},[$t.OC_WEARPOS]:t=>{t.pushInt(as(t.popInt(),ys).wearpos)},[$t.OC_WEARPOS2]:t=>{t.pushInt(as(t.popInt(),ys).wearpos2)},[$t.OC_WEARPOS3]:t=>{t.pushInt(as(t.popInt(),ys).wearpos3)},[$t.OC_COST]:t=>{t.pushInt(as(t.popInt(),ys).cost)},[$t.OC_TRADEABLE]:t=>{t.pushInt(as(t.popInt(),ys).tradeable?1:0)},[$t.OC_DEBUGNAME]:t=>{t.pushString(as(t.popInt(),ys).debugname??'null')},[$t.OC_CERT]:t=>{const e=as(t.popInt(),ys);-1==e.certtemplate&&e.certlink>=0?t.pushInt(e.certlink):t.pushInt(e.id)},[$t.OC_UNCERT]:t=>{const e=as(t.popInt(),ys);e.certtemplate>=0&&e.certlink>=0?t.pushInt(e.certlink):t.pushInt(e.id)},[$t.OC_STACKABLE]:t=>{t.pushInt(as(t.popInt(),ys).stackable?1:0)}};class Un extends m{type;script;args;delay;lastInt=0;constructor(t,e,s,n){super(),this.type=t,this.script=e,this.args=s,this.delay=n}}class Dn extends m{script;delay;constructor(t,e){super(),this.script=t,this.delay=e}}class Mn{id;length;static all=[];static byId=[];static IF_OPENCHATMODAL=new Mn(14,2);static IF_OPENMAINSIDEMODAL=new Mn(28,4);static IF_CLOSE=new Mn(129,0);static IF_OPENSIDEOVERLAY=new Mn(167,3);static IF_OPENMAINMODAL=new Mn(168,2);static IF_OPENSIDEMODAL=new Mn(195,2);static IF_SETCOLOUR=new Mn(2,4);static IF_SETHIDE=new Mn(26,3);static IF_SETOBJECT=new Mn(46,6);static IF_SHOWSIDE=new Mn(84,1);static IF_SETMODEL=new Mn(87,4);static IF_SETRECOL=new Mn(103,6);static IF_SETANIM=new Mn(146,4);static IF_SETPLAYERHEAD=new Mn(197,2);static IF_SETTEXT=new Mn(201,-2);static IF_SETNPCHEAD=new Mn(204,4);static IF_SETPOSITION=new Mn(209,6);static TUTORIAL_FLASHSIDE=new Mn(126,1);static TUTORIAL_OPENCHAT=new Mn(185,2);static UPDATE_INV_STOP_TRANSMIT=new Mn(15,2);static UPDATE_INV_FULL=new Mn(98,-2);static UPDATE_INV_PARTIAL=new Mn(213,-2);static CAM_LOOKAT=new Mn(74,6);static CAM_SHAKE=new Mn(13,4);static CAM_MOVETO=new Mn(3,6);static CAM_RESET=new Mn(239,0);static NPC_INFO=new Mn(1,-2);static PLAYER_INFO=new Mn(184,-2);static FINISH_TRACKING=new Mn(133,0);static ENABLE_TRACKING=new Mn(226,0);static MESSAGE_GAME=new Mn(4,-1);static UPDATE_IGNORELIST=new Mn(21,-2);static CHAT_FILTER_SETTINGS=new Mn(32,3);static MESSAGE_PRIVATE=new Mn(41,-1);static UPDATE_FRIENDLIST=new Mn(152,9);static UNSET_MAP_FLAG=new Mn(19,0);static UPDATE_RUNWEIGHT=new Mn(22,2);static HINT_ARROW=new Mn(25,6);static UPDATE_REBOOT_TIMER=new Mn(43,2);static UPDATE_STAT=new Mn(44,6);static UPDATE_RUNENERGY=new Mn(68,1);static RESET_ANIMS=new Mn(136,0);static UPDATE_UID192=new Mn(139,2);static LAST_LOGIN_INFO=new Mn(140,9);static LOGOUT=new Mn(142,0);static P_COUNTDIALOG=new Mn(243,0);static SET_MULTIWAY=new Mn(254,1);static DATA_LOC_DONE=new Mn(20,2);static DATA_LAND_DONE=new Mn(80,2);static DATA_LAND=new Mn(132,-2);static DATA_LOC=new Mn(220,-2);static REBUILD_NORMAL=new Mn(237,-2);static VARP_SMALL=new Mn(150,3);static VARP_LARGE=new Mn(175,6);static RESET_CLIENT_VARCACHE=new Mn(193,0);static SYNTH_SOUND=new Mn(12,5);static MIDI_SONG=new Mn(54,-1);static MIDI_JINGLE=new Mn(212,-2);static UPDATE_ZONE_PARTIAL_FOLLOWS=new Mn(7,2);static UPDATE_ZONE_FULL_FOLLOWS=new Mn(135,2);static UPDATE_ZONE_PARTIAL_ENCLOSED=new Mn(162,-2);constructor(t,e){this.id=t,this.length=e,Mn.all.push(this),Mn.byId[t]=this}}(yn=Cn||={})[yn.STATIONARY=0]='STATIONARY',yn[yn.CRAWL=1]='CRAWL',yn[yn.WALK=2]='WALK',yn[yn.RUN=3]='RUN',yn[yn.INSTANT=4]='INSTANT';var kn,xn,Bn=Cn;(xn=kn||={})[xn.SMART=0]='SMART',xn[xn.NAIVE=1]='NAIVE',xn[xn.FLY=2]='FLY';var Hn=kn;class Fn extends sn{moveRestrict;blockWalk;moveStrategy;coordmask;entitymask;moveSpeed=Bn.INSTANT;walkDir=-1;runDir=-1;waypointIndex=-1;waypoints=new Int32Array(25);lastX=-1;lastZ=-1;tele=!1;jump=!1;lastStepX=-1;lastStepZ=-1;stepsTaken=0;lastInt=-1;lastCrawl=!1;walktrigger=-1;walktriggerArg=0;orientation=Qe;interacted=!1;repathed=!1;target=null;targetOp=-1;targetSubject={type:-1,com:-1};targetX=-1;targetZ=-1;apRange=10;apRangeCalled=!1;alreadyFacedCoord=!1;alreadyFacedEntity=!1;mask=0;exactStartX=-1;exactStartZ=-1;exactEndX=-1;exactEndZ=-1;exactMoveStart=-1;exactMoveEnd=-1;exactMoveDirection=-1;faceX=-1;faceZ=-1;faceEntity=-1;damageTaken=-1;damageType=-1;animId=-1;animDelay=-1;chat=null;graphicId=-1;graphicHeight=-1;graphicDelay=-1;constructor(t,e,s,n,i,a,r,o,c,l,h){super(t,e,s,n,i,a),this.moveRestrict=r,this.blockWalk=o,this.moveStrategy=c,this.coordmask=l,this.entitymask=h,this.lastStepX=e-1,this.lastStepZ=s}processMovement(){return!(!this.hasWaypoints()||this.moveSpeed===Bn.STATIONARY||this.moveSpeed===Bn.INSTANT)&&(this.moveSpeed===Bn.CRAWL?(this.lastCrawl=!this.lastCrawl,this.lastCrawl&&-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep()),!0):(-1===this.walkDir&&(this.walkDir=this.validateAndAdvanceStep(),this.moveSpeed===Bn.RUN&&-1!==this.walkDir&&-1===this.runDir&&(this.runDir=this.validateAndAdvanceStep())),!0))}refreshZonePresence(t,e,s){if(this.x!=t||this.z!==e||this.level!==s){switch(this.blockWalk){case at.NPC:rl.gameMap.changeNpcCollision(this.width,t,e,s,!1),rl.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0);break;case at.ALL:rl.gameMap.changeNpcCollision(this.width,t,e,s,!1),rl.gameMap.changeNpcCollision(this.width,this.x,this.z,this.level,!0),rl.gameMap.changePlayerCollision(this.width,t,e,s,!1),rl.gameMap.changePlayerCollision(this.width,this.x,this.z,this.level,!0)}this.lastStepX=t,this.lastStepZ=e}ts.zone(t)===ts.zone(this.x)&&ts.zone(e)===ts.zone(this.z)&&s==this.level||(rl.getZone(t,e,s).leave(this),rl.getZone(this.x,this.z,this.level).enter(this))}validateAndAdvanceStep(){const t=this.takeStep();if(null===t)return-1;if(-1===t)return this.waypointIndex--,-1!=this.waypointIndex?this.validateAndAdvanceStep():-1;const e=this.x,s=this.z;return this.x=ts.moveX(this.x,t),this.z=ts.moveZ(this.z,t),this.orientation=t,this.stepsTaken++,this.refreshZonePresence(e,s,this.level),t}queueWaypoint(t,e){this.waypoints[0]=ts.packCoord(0,t,e),this.waypointIndex=0}queueWaypoints(t){let e=-1;for(let s=t.length-1,n=0;s>=0&&n<this.waypoints.length;s--,n++)this.waypoints[n]=t[s],e++;this.waypointIndex=e}clearWaypoints(){this.waypointIndex=-1}teleJump(t,e,s){this.teleport(t,e,s),this.jump=!0}teleport(t,e,s){isNaN(s)&&(s=0),s=Math.max(0,Math.min(s,3));const n=this.x,i=this.z,a=this.level;this.x=t,this.z=e,this.level=s,this.refreshZonePresence(n,i,a),this.lastStepX=this.x-1,this.lastStepZ=this.z,this.moveSpeed=Bn.INSTANT,a!=s&&(this.jump=!0)}validateDistanceWalked(){ts.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length})>2&&(this.jump=!0)}convertMovementDir(){let t=this.walkDir,e=this.runDir,s=this.moveSpeed===Bn.INSTANT;const n=ts.distanceTo(this,{x:this.lastX,z:this.lastZ,width:this.width,length:this.length});if(s&&!this.jump&&n<=2){if(2===n){const s=(this.x+this.lastX)/2|0,n=(this.z+this.lastZ)/2|0;t=ts.face(this.lastX,this.lastZ,s,n),e=ts.face(s,n,this.x,this.z)}else t=ts.face(this.lastX,this.lastZ,this.x,this.z),e=-1;s=!1}this.walkDir=t,this.runDir=e,this.tele=s}hasWaypoints(){return-1!==this.waypointIndex}isLastOrNoWaypoint(){return this.waypointIndex<=0}inOperableDistance(t){if(t.level!==this.level)return!1;if(t instanceof Fn)return Se(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,t.orientation,-2);if(t instanceof _n){const e=et.get(t.type).forceapproach;return Se(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,t.angle,t.shape,e)}const e=Se(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,0,-2);return Ae(t.x,t.z,t.level,Fe.WALK_BLOCKED)?e:!(this.hasWaypoints()||!e)||Se(this.level,this.x,this.z,t.x,t.z,t.width,t.length,this.width,0,-1)}inApproachDistance(t,e){return e.level===this.level&&(!(e instanceof Fn&&ts.intersects(this.x,this.z,this.width,this.length,e.x,e.z,e.width,e.length))&&(ts.distanceTo(this,e)<=t&&Ie(this.level,this.x,this.z,e.x,e.z,this.width,this.length,e.width,e.length,Fe.PLAYER)))}pathToMoveClick(t,e){if(this.moveStrategy===Hn.SMART)if(e){const{x:e,z:s}=ts.unpackCoord(t[0]);this.queueWaypoints(le(this.level,this.x,this.z,e,s))}else this.queueWaypoints(t);else{const{x:e,z:s}=ts.unpackCoord(t[t.length-1]);this.queueWaypoint(e,s)}}pathToPathingTarget(){this.target&&this.target instanceof Fn&&this.isLastOrNoWaypoint()&&(this.targetOp!==In.APPLAYER3&&this.targetOp!==In.OPPLAYER3?this.pathToTarget():this.queueWaypoint(this.target.lastStepX,this.target.lastStepZ))}pathToTarget(){if(this.target)if(this.targetX=this.target.x,this.targetZ=this.target.z,this.moveStrategy===Hn.SMART)if(this.target instanceof Fn)this.queueWaypoints(le(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.orientation,-2));else if(this.target instanceof _n){const t=et.get(this.target.type).forceapproach;this.queueWaypoints(le(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.target.width,this.target.length,this.target.angle,this.target.shape,!0,t))}else this.queueWaypoints(le(this.level,this.x,this.z,this.target.x,this.target.z));else if(this.moveStrategy===Hn.NAIVE){const t=this.getCollisionStrategy();if(null===t)return;const e=this.blockWalkFlag();if(e===Fe.NULL)return;this.target instanceof Fn?this.queueWaypoints(he(this.level,this.x,this.z,this.target.x,this.target.z,this.width,this.length,this.target.width,this.target.length,e,t)):this.queueWaypoint(this.target.x,this.target.z)}else{if(null===this.getCollisionStrategy())return;if(this.blockWalkFlag()===Fe.NULL)return;this.queueWaypoint(this.target.x,this.target.z)}}setInteraction(t,e,s,n){if(this.target=e,this.targetOp=s,this.targetSubject=n??{type:-1,com:-1},this.targetX=e.x,this.targetZ=e.z,this.apRange=10,this.apRangeCalled=!1,e instanceof Vr){const t=e.pid+32768;this.faceEntity!==t&&(this.faceEntity=t,this.mask|=this.entitymask)}else if(e instanceof Yc){const t=e.nid;this.faceEntity!==t&&(this.faceEntity=t,this.mask|=this.entitymask)}else{const t=2*e.x+e.width,s=2*e.z+e.length;this.faceX===t&&this.faceZ===s||(this.faceX=t,this.faceZ=s,this.mask|=this.coordmask)}t===Nn.SCRIPT&&this.pathToTarget()}clearInteraction(){this.target=null,this.targetOp=-1,this.targetSubject={type:-1,com:-1},this.targetX=-1,this.targetZ=-1,this.apRange=10,this.apRangeCalled=!1,this.alreadyFacedCoord=!0,this.alreadyFacedEntity=!0}getCollisionStrategy(){return this.moveRestrict===ct.NORMAL?ze.NORMAL:this.moveRestrict===ct.BLOCKED?ze.BLOCKED:this.moveRestrict===ct.BLOCKED_NORMAL?ze.LINE_OF_SIGHT:this.moveRestrict===ct.INDOORS?ze.INDOORS:this.moveRestrict===ct.OUTDOORS?ze.OUTDOORS:this.moveRestrict===ct.NOMOVE?null:this.moveRestrict===ct.PASSTHRU?ze.NORMAL:null}resetPathingEntity(){this.moveSpeed=this.defaultMoveSpeed(),this.walkDir=-1,this.runDir=-1,this.jump=!1,this.tele=!1,this.lastX=this.x,this.lastZ=this.z,this.stepsTaken=0,this.interacted=!1,this.apRangeCalled=!1,this.mask=0,this.exactStartX=-1,this.exactStartZ=-1,this.exactEndX=-1,this.exactEndZ=-1,this.exactMoveStart=-1,this.exactMoveEnd=-1,this.exactMoveDirection=-1,this.animId=-1,this.animDelay=-1,this.animId=-1,this.animDelay=-1,this.chat=null,this.damageTaken=-1,this.damageType=-1,this.graphicId=-1,this.graphicHeight=-1,this.graphicDelay=-1,-1!==this.faceX?this.orientation=ts.face(this.x,this.z,this.faceX,this.faceZ):this.target&&(this.orientation=ts.face(this.x,this.z,this.target.x,this.target.z)),this.alreadyFacedCoord&&-1!==this.faceX&&!this.hasWaypoints()?(this.faceX=-1,this.faceZ=-1,this.alreadyFacedCoord=!1):this.alreadyFacedEntity&&!this.target&&-1!==this.faceEntity&&(this.mask|=this.entitymask,this.faceEntity=-1,this.alreadyFacedEntity=!1)}takeStep(){if(-1===this.waypointIndex)return null;const t=this.x,e=this.z,{x:s,z:n}=ts.unpackCoord(this.waypoints[this.waypointIndex]),i=ts.face(t,e,s,n),a=ts.deltaX(i),r=ts.deltaZ(i);if(0==a&&0==r)return-1;const o=this.getCollisionStrategy();if(null===o)return-1;const c=this.blockWalkFlag();return c===Fe.NULL?-1:this.moveStrategy===Hn.FLY||Te(this.level,this.x,this.z,a,r,this.width,c,o)?i:0!=a&&Te(this.level,this.x,this.z,a,0,this.width,c,o)?ts.face(t,e,s,e):0!=r&&Te(this.level,this.x,this.z,0,r,this.width,c,o)?ts.face(t,e,t,n):null}}class Gn{sentinel;cursor=null;constructor(){const t=new O;t.nextHashable=t,t.prevHashable=t,this.sentinel=t}push(t){t.prevHashable&&t.uncache(),t.prevHashable=this.sentinel.prevHashable,t.nextHashable=this.sentinel,t.prevHashable&&(t.prevHashable.nextHashable=t),t.nextHashable.prevHashable=t}pop(){const t=this.sentinel.nextHashable;return t===this.sentinel?null:(t?.uncache(),t)}head(){const t=this.sentinel.nextHashable;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.nextHashable||null,t)}next(){const t=this.cursor;return t===this.sentinel?(this.cursor=null,null):(this.cursor=t?.nextHashable||null,t)}}var Wn,zn,Vn=new Map,Yn=new Map;class Kn extends O{}class jn{static LOW=new jn;static HIGH=new jn}class Zn extends Kn{priority=jn.LOW}class Jn extends Kn{uid;priority=jn.HIGH;constructor(t){super(),this.uid=t}}class $n extends Kn{priority=jn.HIGH}class Xn extends Kn{priority=jn.HIGH}class Qn extends Kn{component;priority=jn.LOW;constructor(t){super(),this.component=t}}class qn extends Kn{component;priority=jn.HIGH;constructor(t){super(),this.component=t}}class ti extends Kn{varp;value;priority=jn.HIGH;constructor(t,e){super(),this.varp=t,this.value=e}}class ei extends Kn{varp;value;priority=jn.HIGH;constructor(t,e){super(),this.varp=t,this.value=e}}class si extends Kn{name;crc;length;priority=jn.LOW;constructor(t,e,s){super(),this.name=t,this.crc=e,this.length=s}}class ni extends Kn{delay;data;priority=jn.LOW;constructor(t,e){super(),this.delay=t,this.data=e}}class ii extends Kn{component;tab;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.tab=e}}class ai extends Kn{priority=jn.HIGH}class ri extends Kn{type;nid;pid;x;z2;y2;priority=jn.LOW;constructor(t,e,s,n,i,a){super(),this.type=t,this.nid=e,this.pid=s,this.x=n,this.z=i,this.y=a}}class oi extends Kn{lastLoginIp;daysSinceLogin;daysSinceRecoveryChange;unreadMessageCount;priority=jn.LOW;constructor(t,e,s,n){super(),this.lastLoginIp=t,this.daysSinceLogin=e,this.daysSinceRecoveryChange=s,this.unreadMessageCount=n}}class ci extends Kn{msg;priority=jn.HIGH;constructor(t){super(),this.msg=t}}(zn=Wn||={})[zn.ENCLOSED=0]='ENCLOSED',zn[zn.FOLLOWS=1]='FOLLOWS';var li=Wn;class hi extends Kn{zoneX;zoneZ;originX;originZ;data;priority=jn.HIGH;constructor(t,e,s,n,i){super(),this.zoneX=t,this.zoneZ=e,this.originX=s,this.originZ=n,this.data=i}}class di extends Kn{zoneX;zoneZ;originX;originZ;priority=jn.HIGH;constructor(t,e,s,n){super(),this.zoneX=t,this.zoneZ=e,this.originX=s,this.originZ=n}}class pi extends Kn{zoneX;zoneZ;originX;originZ;priority=jn.HIGH;constructor(t,e,s,n){super(),this.zoneX=t,this.zoneZ=e,this.originX=s,this.originZ=n}}class ui extends Kn{coord;priority=jn.HIGH;constructor(t){super(),this.coord=t}}class _i extends ui{coord;obj;count;constructor(t,e,s){super(t),this.coord=t,this.obj=e,this.count=s}}class gi extends ui{coord;loc;shape;angle;constructor(t,e,s,n){super(t),this.coord=t,this.loc=e,this.shape=s,this.angle=n}}class mi extends ui{coord;shape;angle;constructor(t,e,s){super(t),this.coord=t,this.shape=e,this.angle=s}}class Ei extends ui{srcX;srcZ;dstX;dstZ;target;spotanim;srcHeight;dstHeight;startDelay;endDelay;peak;arc;constructor(t,e,s,n,i,a,r,o,c,l,h,d){super(ts.packZoneCoord(t,e)),this.srcX=t,this.srcZ=e,this.dstX=s,this.dstZ=n,this.target=i,this.spotanim=a,this.srcHeight=r,this.dstHeight=o,this.startDelay=c,this.endDelay=l,this.peak=h,this.arc=d}}class Oi extends ui{coord;spotanim;height;delay;constructor(t,e,s,n){super(t),this.coord=t,this.spotanim=e,this.height=s,this.delay=n}}class fi extends ui{coord;obj;constructor(t,e){super(t),this.coord=t,this.obj=e}}class Ai extends ui{coord;obj;oldCount;newCount;constructor(t,e,s,n){super(t),this.coord=t,this.obj=e,this.oldCount=s,this.newCount=n}}class Ti extends ui{coord;obj;count;receiverId;constructor(t,e,s,n){super(t),this.coord=t,this.obj=e,this.count=s,this.receiverId=n}}class Ii extends ui{coord;shape;angle;seq;constructor(t,e,s,n){super(t),this.coord=t,this.shape=e,this.angle=s,this.seq=n}}class Ni extends ui{srcX;srcZ;shape;angle;locId;startCycle;endCycle;pid;east;south;west;north;constructor(t,e,s,n,i,a,r,o,c,l,h,d){super(ts.packZoneCoord(t,e)),this.srcX=t,this.srcZ=e,this.shape=s,this.angle=n,this.locId=i,this.startCycle=a,this.endCycle=r,this.pid=o,this.east=c,this.south=l,this.west=h,this.north=d}}class Pi{test(t){return this.prot.length}}class Li extends Pi{prot=Mn.IF_OPENCHATMODAL;encode(t,e){t.p2(e.component)}}class Si extends Kn{component;priority=jn.LOW;constructor(t){super(),this.component=t}}class Ci extends Kn{buildArea;level;x;z2;originX;originZ;uid;mask;tele;jump2;walkDir;runDir;priority=jn.HIGH;accumulator=0;constructor(t,e,s,n,i,a,r,o,c,l,h,d){super(),this.buildArea=t,this.level=e,this.x=s,this.z=n,this.originX=i,this.originZ=a,this.uid=r,this.mask=o,this.tele=c,this.jump=l,this.walkDir=h,this.runDir=d}}class yi extends Pi{static BITS_NEW=34;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=Mn.PLAYER_INFO;encode(t,e){const s=e.buildArea;s.resize(),this.writeLocalPlayer(t,e),this.writePlayers(t,e),this.writeNewPlayers(t,e);const n=s.extendedInfo;if(n.size>0)for(const s of n){const n=rl.getPlayerByUid(s.id);n&&this.writeUpdate(n,e,t,s.id===e.uid,s.added)}s.reset()}test(t){return yi.BYTES_LIMIT}writeLocalPlayer(t,e){const{buildArea:s,uid:n,level:i,x:a,z:r,mask:o,tele:c,jump:l,walkDir:h,runDir:d}=e,p=rl.getPlayerByUid(n);p&&(t.bits(),t.pBit(1,c||-1!==h||-1!==d||o>0?1:0),c?(t.pBit(2,3),t.pBit(2,i),t.pBit(7,ts.local(a)),t.pBit(7,ts.local(r)),t.pBit(1,l?1:0),t.pBit(1,o>0?1:0)):-1!==d?(t.pBit(2,2),t.pBit(3,h),t.pBit(3,d),t.pBit(1,o>0?1:0)):-1!==h?(t.pBit(2,1),t.pBit(3,h),t.pBit(1,o>0?1:0)):o>0&&t.pBit(2,0),o>0&&(s.extendedInfo.add({id:n,added:!1}),e.accumulator+=this.calculateUpdateSize(p,e,!0,!0)))}writePlayers(t,e){const s=e.buildArea;t.pBit(8,s.players.size);for(const n of s.players){const i=rl.getPlayerByUid(n);if(!i||i.tele||i.level!==e.level||!ts.isWithinDistanceSW(e,i,s.viewDistance)||!i.checkLifeCycle(rl.currentTick)){t.pBit(1,1),t.pBit(2,3),s.players.delete(n);continue}let a=i.mask>0;const{walkDir:r,runDir:o}=i;let c=0;-1!==o?c=yi.BITS_RUN:-1!==r?c=yi.BITS_WALK:a&&(c=yi.BITS_EXTENDED);const l=a?this.calculateUpdateSize(i,e,!1,!1):0;(t.bitPos+c+7+24>>>3)+t.pos+(e.accumulator+=l)>this.test(e)&&(a=!1),t.pBit(1,-1!==r||-1!==o||a?1:0),-1!==o?(t.pBit(2,2),t.pBit(3,r),t.pBit(3,o),t.pBit(1,a?1:0)):-1!==r?(t.pBit(2,1),t.pBit(3,r),t.pBit(1,a?1:0)):a&&t.pBit(2,0),a&&s.extendedInfo.add({id:n,added:!1})}}writeNewPlayers(t,e){const s=e.buildArea;for(const n of s.getNearbyPlayers(e.uid,e.x,e.z,e.originX,e.originZ)){const i=!s.hasAppearance(n.pid,n.lastAppearance),a=i?this.calculateUpdateSize(n,e,!1,!0):0;if((t.bitPos+yi.BITS_NEW+7+24>>>3)+t.pos+(e.accumulator+=a)>this.test(e))break;t.pBit(11,n.pid),t.pBit(5,n.x-e.x),t.pBit(5,n.z-e.z),t.pBit(1,n.jump?1:0),t.pBit(1,i?1:0),i&&s.extendedInfo.add({id:n.uid,added:!0}),s.players.add(n.uid)}s.extendedInfo.size>0&&t.pBit(11,2047),t.bytes()}writeUpdate(t,e,s,n=!1,i=!1){let a=t.mask;if(i&&(a|=Vr.APPEARANCE),!i||-1===t.orientation&&-1===t.faceX&&-1===t.faceZ||(a|=Vr.FACE_COORD),i&&-1!==t.faceEntity&&(a|=Vr.FACE_ENTITY),a>255&&(a|=Vr.BIG_UPDATE),n&&a&Vr.CHAT&&(a&=~Vr.CHAT),e.buildArea.hasAppearance(t.pid,t.lastAppearance)&&(a&=~Vr.APPEARANCE),s.p1(255&a),a&Vr.BIG_UPDATE&&s.p1(a>>8),a&Vr.APPEARANCE&&(s.p1(t.appearance.length),s.pdata(t.appearance,0,t.appearance.length),e.buildArea.saveAppearance(t.pid,t.lastAppearance)),a&Vr.ANIM&&(s.p2(t.animId),s.p1(t.animDelay)),a&Vr.FACE_ENTITY&&(-1!==t.faceEntity&&(t.alreadyFacedEntity=!0),s.p2(t.faceEntity)),a&Vr.SAY&&s.pjstr(t.chat??''),a&Vr.DAMAGE&&(s.p1(t.damageTaken),s.p1(t.damageType),s.p1(t.levels[is.HITPOINTS]),s.p1(t.baseLevels[is.HITPOINTS])),a&Vr.FACE_COORD)if(-1!==t.faceX&&(t.alreadyFacedCoord=!0),i&&-1!==t.faceX)s.p2(t.faceX),s.p2(t.faceZ);else if(i&&-1!==t.orientation){const e=ts.moveX(t.x,t.orientation),n=ts.moveZ(t.z,t.orientation);s.p2(2*e+1),s.p2(2*n+1)}else s.p2(t.faceX),s.p2(t.faceZ);a&Vr.CHAT&&(s.p1(t.messageColor),s.p1(t.messageEffect),s.p1(t.messageType),s.p1(t.message.length),s.pdata(t.message,0,t.message.length)),a&Vr.SPOTANIM&&(s.p2(t.graphicId),s.p2(t.graphicHeight),s.p2(t.graphicDelay)),a&Vr.EXACT_MOVE&&(s.p1(t.exactStartX-ts.zoneOrigin(e.originX)),s.p1(t.exactStartZ-ts.zoneOrigin(e.originZ)),s.p1(t.exactEndX-ts.zoneOrigin(e.originX)),s.p1(t.exactEndZ-ts.zoneOrigin(e.originZ)),s.p2(t.exactMoveStart),s.p2(t.exactMoveEnd),s.p1(t.exactMoveDirection))}calculateUpdateSize(t,e,s=!1,n=!1){let i=0,a=t.mask;return n&&(a|=Vr.APPEARANCE),!n||-1===t.orientation&&-1===t.faceX&&-1===t.faceZ||(a|=Vr.FACE_COORD),n&&-1!==t.faceEntity&&(a|=Vr.FACE_ENTITY),a>255&&(a|=Vr.BIG_UPDATE),s&&a&Vr.CHAT&&(a&=~Vr.CHAT),e.buildArea.hasAppearance(t.pid,t.lastAppearance)&&(a&=~Vr.APPEARANCE),i+=1,a&Vr.BIG_UPDATE&&(i+=1),a&Vr.APPEARANCE&&(i+=1,i+=t.appearance?.length??0),a&Vr.ANIM&&(i+=3),a&Vr.FACE_ENTITY&&(i+=2),a&Vr.SAY&&(i+=(t.chat?.length??0)+1),a&Vr.DAMAGE&&(i+=4),a&Vr.FACE_COORD&&(i+=4),a&Vr.CHAT&&(i+=4,i+=t.message?.length??0),a&Vr.SPOTANIM&&(i+=6),a&Vr.EXACT_MOVE&&(i+=9),i}}class vi extends Kn{zoneX;zoneZ;priority=jn.HIGH;constructor(t,e){super(),this.zoneX=t,this.zoneZ=e}get mapsquares(){const t=this.zoneX-6,e=this.zoneX+6,s=this.zoneZ-6,n=this.zoneZ+6,i=new Set;for(let a=t;a<=e;a++){const t=ts.mapsquare(a<<3);for(let e=s;e<=n;e++){const s=ts.mapsquare(e<<3);i.add(t<<8|s)}}return i}}class wi extends Pi{prot=Mn.REBUILD_NORMAL;encode(t,e){t.p2(e.zoneX),t.p2(e.zoneZ);for(const s of e.mapsquares){const e=s>>8,n=255&s;t.p1(e),t.p1(n),t.p4(Yn.get(`m${e}_${n}`)??0),t.p4(Yn.get(`l${e}_${n}`)??0)}}test(t){return 4+10*t.mapsquares.size}}class Ri extends Kn{x;z2;offset;length;data;priority=jn.HIGH;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.offset=s,this.length=n,this.data=i}}class bi extends Pi{prot=Mn.DATA_LAND;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.offset),t.p2(e.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class Ui extends Kn{x;z2;priority=jn.HIGH;constructor(t,e){super(),this.x=t,this.z=e}}class Di extends Pi{prot=Mn.DATA_LAND_DONE;encode(t,e){t.p1(e.x),t.p1(e.z)}}class Mi extends Kn{x;z2;offset;length;data;priority=jn.HIGH;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.offset=s,this.length=n,this.data=i}}class ki extends Pi{prot=Mn.DATA_LOC;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.offset),t.p2(e.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class xi extends Kn{x;z2;priority=jn.HIGH;constructor(t,e){super(),this.x=t,this.z=e}}class Bi extends Pi{prot=Mn.DATA_LOC_DONE;encode(t,e){t.p1(e.x),t.p1(e.z)}}class Hi extends Kn{x;z2;height;speed;multiplier;priority=jn.LOW;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.height=s,this.speed=n,this.multiplier=i}}class Fi extends Pi{prot=Mn.CAM_LOOKAT;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.height),t.p1(e.speed),t.p1(e.multiplier)}}class Gi extends Kn{x;z2;height;speed;multiplier;priority=jn.LOW;constructor(t,e,s,n,i){super(),this.x=t,this.z=e,this.height=s,this.speed=n,this.multiplier=i}}class Wi extends Pi{prot=Mn.CAM_MOVETO;encode(t,e){t.p1(e.x),t.p1(e.z),t.p2(e.height),t.p1(e.speed),t.p1(e.multiplier)}}class zi extends Kn{priority=jn.LOW}class Vi extends Pi{prot=Mn.CAM_RESET;encode(t,e){}}class Yi extends Kn{type;jitter;amplitude;frequency;priority=jn.LOW;constructor(t,e,s,n){super(),this.type=t,this.jitter=e,this.amplitude=s,this.frequency=n}}class Ki extends Pi{prot=Mn.CAM_SHAKE;encode(t,e){t.p1(e.type),t.p1(e.jitter),t.p1(e.amplitude),t.p1(e.frequency)}}class ji extends Kn{publicChat;privateChat;tradeDuel;priority=jn.HIGH;constructor(t,e,s){super(),this.publicChat=t,this.privateChat=e,this.tradeDuel=s}}class Zi extends Pi{prot=Mn.CHAT_FILTER_SETTINGS;encode(t,e){t.p1(e.publicChat),t.p1(e.privateChat),t.p1(e.tradeDuel)}}class Ji extends Kn{priority=jn.LOW}class $i extends Pi{prot=Mn.ENABLE_TRACKING;encode(t,e){}}class Xi extends Kn{priority=jn.LOW}class Qi extends Pi{prot=Mn.FINISH_TRACKING;encode(t,e){}}class qi extends Pi{prot=Mn.HINT_ARROW;encode(t,e){const{type:s,nid:n,pid:i,x:a,z:r,y:o}=e;1===s?(t.p1(s),t.p2(n),t.p2(0),t.p1(0)):s>=2&&s<=6?(t.p1(s),t.p2(a),t.p2(r),t.p1(o)):10===s?(t.p1(s),t.p2(i),t.p2(0),t.p1(0)):-1===s&&(t.p1(-1),t.p2(0),t.p2(0),t.p1(0))}}class ta extends Pi{prot=Mn.IF_CLOSE;encode(t,e){}}class ea extends Kn{component;priority=jn.LOW;constructor(t){super(),this.component=t}}class sa extends Pi{prot=Mn.IF_OPENMAINMODAL;encode(t,e){t.p2(e.component)}}class na extends Kn{main;side;priority=jn.LOW;constructor(t,e){super(),this.main=t,this.side=e}}class ia extends Pi{prot=Mn.IF_OPENMAINSIDEMODAL;encode(t,e){t.p2(e.main),t.p2(e.side)}}class aa extends Kn{component;priority=jn.LOW;constructor(t){super(),this.component=t}}class ra extends Pi{prot=Mn.IF_OPENSIDEMODAL;encode(t,e){t.p2(e.component)}}class oa extends Pi{prot=Mn.IF_OPENSIDEOVERLAY;encode(t,e){t.p2(e.component),t.p1(e.tab)}}class ca extends Kn{component;seq;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.seq=e}}class la extends Pi{prot=Mn.IF_SETANIM;encode(t,e){t.p2(e.component),t.p2(e.seq)}}class ha extends Kn{component;colour;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.colour=e}}class da extends Pi{prot=Mn.IF_SETCOLOUR;encode(t,e){t.p2(e.component),t.p2(e.colour)}}class pa extends Kn{component;hidden;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.hidden=e}}class ua extends Pi{prot=Mn.IF_SETHIDE;encode(t,e){t.p2(e.component),t.pbool(e.hidden)}}class _a extends Kn{component;model;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.model=e}}class ga extends Pi{prot=Mn.IF_SETMODEL;encode(t,e){t.p2(e.component),t.p2(e.model)}}class ma extends Kn{component;npc;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.npc=e}}class Ea extends Pi{prot=Mn.IF_SETNPCHEAD;encode(t,e){t.p2(e.component),t.p2(e.npc)}}class Oa extends Kn{component;obj;scale;priority=jn.LOW;constructor(t,e,s){super(),this.component=t,this.obj=e,this.scale=s}}class fa extends Pi{prot=Mn.IF_SETOBJECT;encode(t,e){t.p2(e.component),t.p2(e.obj),t.p2(e.scale)}}class Aa extends Kn{component;priority=jn.LOW;constructor(t){super(),this.component=t}}class Ta extends Pi{prot=Mn.IF_SETPLAYERHEAD;encode(t,e){t.p2(e.component)}}class Ia extends Kn{component;x;y2;priority=jn.LOW;constructor(t,e,s){super(),this.component=t,this.x=e,this.y=s}}class Na extends Pi{prot=Mn.IF_SETPOSITION;encode(t,e){t.p2(e.component),t.p2(e.x),t.p2(e.y)}}class Pa extends Kn{component;src;dst;priority=jn.LOW;constructor(t,e,s){super(),this.component=t,this.src=e,this.dst=s}}class La extends Pi{prot=Mn.IF_SETRECOL;encode(t,e){t.p2(e.component),t.p2(e.src),t.p2(e.dst)}}class Sa extends Kn{component;text;priority=jn.LOW;constructor(t,e){super(),this.component=t,this.text=e}}class Ca extends Pi{prot=Mn.IF_SETTEXT;encode(t,e){t.p2(e.component),t.pjstr(e.text)}test(t){return 3+t.text.length}}class ya extends Kn{tab;priority=jn.LOW;constructor(t){super(),this.tab=t}}class va extends Pi{prot=Mn.IF_SHOWSIDE;encode(t,e){t.p1(e.tab)}}class wa extends Pi{prot=Mn.LAST_LOGIN_INFO;encode(t,e){t.p4(e.lastLoginIp),t.p2(e.daysSinceLogin),t.p1(e.daysSinceRecoveryChange),t.p2(e.unreadMessageCount)}}class Ra extends Mn{static LOC_MERGE=new Ra(23,14);static LOC_ANIM=new Ra(42,4);static OBJ_DEL=new Ra(49,3);static OBJ_REVEAL=new Ra(50,7);static LOC_ADD_CHANGE=new Ra(59,4);static MAP_PROJANIM=new Ra(69,15);static LOC_DEL=new Ra(76,2);static OBJ_COUNT=new Ra(151,7);static MAP_ANIM=new Ra(191,6);static OBJ_ADD=new Ra(223,5)}class ba extends Pi{enclose(t){const e=new f(new Uint8Array(1+this.prot.length));return e.p1(this.prot.id),this.encode(e,t),e.data}}class Ua extends ba{prot=Ra.LOC_ADD_CHANGE;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.loc)}}class Da extends ba{prot=Ra.LOC_ANIM;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.seq)}}class Ma extends ba{prot=Ra.LOC_DEL;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle)}}class ka extends ba{prot=Ra.LOC_MERGE;encode(t,e){t.p1(e.coord),t.p1(e.shape<<2|3&e.angle),t.p2(e.locId),t.p2(e.startCycle),t.p2(e.endCycle),t.p2(e.pid),t.p1(e.east-e.srcX),t.p1(e.south-e.srcZ),t.p1(e.west-e.srcX),t.p1(e.north-e.srcZ)}}class xa extends Kn{priority=jn.HIGH}class Ba extends Pi{prot=Mn.LOGOUT;encode(t,e){}}class Ha extends ba{prot=Ra.MAP_ANIM;encode(t,e){t.p1(e.coord),t.p2(e.spotanim),t.p1(e.height),t.p2(e.delay)}}class Fa extends ba{prot=Ra.MAP_PROJANIM;encode(t,e){t.p1(e.coord),t.p1(e.dstX-e.srcX),t.p1(e.dstZ-e.srcZ),t.p2(e.target),t.p2(e.spotanim),t.p1(e.srcHeight),t.p1(e.dstHeight),t.p2(e.startDelay),t.p2(e.endDelay),t.p1(e.peak),t.p1(e.arc)}}class Ga extends Pi{prot=Mn.MESSAGE_GAME;encode(t,e){t.pjstr(e.msg)}test(t){return 1+t.msg.length}}class Wa{static CHAR_LOOKUP=[' ','e','t','a','o','i','h','n','s','r','d','l','u','m','w','c','y','f','g','p','b','v','k','x','j','q','z','0','1','2','3','4','5','6','7','8','9',' ','!','?','.',',',':',';','(',')','-','&','*','\\',"'",'@','#','+','=','Â£','$','%','"','[',']'];static unpack(t,e){const s=[];let n,i=0,a=-1;for(let r=0;r<e&&i<80;r++){const e=t.g1();n=e>>4&15,-1!==a?(s[i++]=this.CHAR_LOOKUP[(a<<4)+n-195],a=-1):n<13?s[i++]=this.CHAR_LOOKUP[n]:a=n,n=15&e,-1!=a?(s[i++]=this.CHAR_LOOKUP[(a<<4)+n-195],a=-1):n<13?s[i++]=this.CHAR_LOOKUP[n]:a=n}return this.toSentenceCase(s.slice(0,i).join(''))}static pack(t,e){e.length>80&&(e=e.substring(0,80)),e=e.toLowerCase();let s=-1;for(let n=0;n<e.length;n++){const i=e.charAt(n);let a=0;for(let t=0;t<this.CHAR_LOOKUP.length;t++)if(i===this.CHAR_LOOKUP[t]){a=t;break}a>12&&(a+=195),-1==s?a<13?s=a:t.p1(a):a<13?(t.p1((s<<4)+a),s=-1):(t.p1((s<<4)+(a>>4)),s=15&a)}-1!=s&&t.p1(s<<4)}static toSentenceCase(t){const e=[...t.toLowerCase()];let s=!0;for(let t=0;t<e.length;t++){const n=e[t];s&&n>='a'&&n<='z'&&(e[t]=n.toUpperCase(),s=!1),'.'!==n&&'!'!==n||(s=!0)}return e.join('')}}class za extends Pi{prot=Mn.MESSAGE_PRIVATE;encode(t,e){t.p8(e.from),t.p4(e.messageId),t.p1(e.staffModLevel),Wa.pack(t,St.filter(e.msg))}test(t){return 14+t.msg.length}}class Va extends Kn{from;messageId;staffModLevel;msg;priority=jn.HIGH;constructor(t,e,s,n){super(),this.from=t,this.messageId=e,this.staffModLevel=s,this.msg=n}}class Ya extends Pi{prot=Mn.MIDI_JINGLE;encode(t,e){t.p2(e.delay),t.p4(e.data.length),t.pdata(e.data,0,e.data.length)}test(t){return 6+t.data.length}}class Ka extends Pi{prot=Mn.MIDI_SONG;encode(t,e){t.pjstr(e.name),t.p4(e.crc),t.p4(e.length)}test(t){return 1+t.name.length+4+4}}class ja extends ba{prot=Ra.OBJ_ADD;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.count,65535))}}class Za extends ba{prot=Ra.OBJ_COUNT;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.oldCount,65535)),t.p2(Math.min(e.newCount,65535))}}class Ja extends ba{prot=Ra.OBJ_DEL;encode(t,e){t.p1(e.coord),t.p2(e.obj)}}class $a extends ba{prot=Ra.OBJ_REVEAL;encode(t,e){t.p1(e.coord),t.p2(e.obj),t.p2(Math.min(e.count,65535)),t.p2(e.receiverId)}}class Xa extends Kn{priority=jn.LOW}class Qa extends Pi{prot=Mn.P_COUNTDIALOG;encode(t,e){}}class qa extends Pi{prot=Mn.RESET_ANIMS;encode(t,e){}}class tr extends Pi{prot=Mn.RESET_CLIENT_VARCACHE;encode(t,e){}}class er extends Kn{hidden;priority=jn.LOW;constructor(t){super(),this.hidden=t}}class sr extends Pi{prot=Mn.SET_MULTIWAY;encode(t,e){t.pbool(e.hidden)}}class nr extends Kn{synth;loops;delay;priority=jn.LOW;constructor(t,e,s){super(),this.synth=t,this.loops=e,this.delay=s}}class ir extends Pi{prot=Mn.SYNTH_SOUND;encode(t,e){t.p2(e.synth),t.p1(e.loops),t.p2(e.delay)}}class ar extends Kn{tab;priority=jn.LOW;constructor(t){super(),this.tab=t}}class rr extends Pi{prot=Mn.TUTORIAL_FLASHSIDE;encode(t,e){t.p1(e.tab)}}class or extends Pi{prot=Mn.TUTORIAL_OPENCHAT;encode(t,e){t.p2(e.component)}}class cr extends Pi{prot=Mn.UNSET_MAP_FLAG;encode(t,e){}}class lr extends Kn{name;nodeId;priority=jn.LOW;constructor(t,e){super(),this.name=t,this.nodeId=e}}class hr extends Pi{prot=Mn.UPDATE_FRIENDLIST;encode(t,e){t.p8(e.name),t.p1(e.nodeId)}}class dr extends Kn{names;priority=jn.LOW;constructor(t){super(),this.names=t}}class pr extends Pi{prot=Mn.UPDATE_IGNORELIST;encode(t,e){for(const s of e.names)t.p8(s)}test(t){return 8*t.names.length}}class ur extends Kn{component;inv;priority=jn.HIGH;constructor(t,e){super(),this.component=t,this.inv=e}}class _r extends Pi{prot=Mn.UPDATE_INV_FULL;encode(t,e){const{component:s,inv:n}=e,i=Z.get(s),a=Math.min(n.capacity,i.width*i.height);t.p2(s),t.p1(a);for(let e=0;e<a;e++){const s=n.get(e);s?(t.p2(s.id+1),s.count>=255?(t.p1(255),t.p4(s.count)):t.p1(s.count)):(t.p2(0),t.p1(0))}}test(t){const{component:e,inv:s}=t,n=Z.get(e),i=Math.min(s.capacity,n.width*n.height);let a=0;a+=3;for(let t=0;t<i;t++){const e=s.get(t);e?(a+=2,e.count>=255?a+=5:a+=1):a+=3}return a}}class gr extends Kn{component;inv;priority=jn.HIGH;slots;constructor(t,e,...s){super(),this.component=t,this.inv=e,this.slots=s}}class mr extends Pi{prot=Mn.UPDATE_INV_PARTIAL;encode(t,e){const{component:s,inv:n}=e;t.p2(s);for(const s of e.slots){const e=n.get(s);t.p1(s),e?(t.p2(e.id+1),e.count>=255?(t.p1(255),t.p4(e.count)):t.p1(e.count)):(t.p2(0),t.p1(0))}}test(t){const{inv:e}=t;let s=0;s+=2;for(const n of t.slots){const t=e.get(n);s+=1,t?(s+=2,t.count>=255?s+=5:s+=1):s+=3}return s}}class Er extends Pi{prot=Mn.UPDATE_INV_STOP_TRANSMIT;encode(t,e){t.p2(e.component)}}class Or extends Kn{energy;priority=jn.LOW;constructor(t){super(),this.energy=t}}class fr extends Pi{prot=Mn.UPDATE_RUNENERGY;encode(t,e){t.p1(e.energy/100|0)}}class Ar extends Kn{kg;priority=jn.LOW;constructor(t){super(),this.kg=t}}class Tr extends Pi{prot=Mn.UPDATE_RUNWEIGHT;encode(t,e){t.p2(e.kg)}}class Ir extends Kn{stat;exp;level;priority=jn.LOW;constructor(t,e,s){super(),this.stat=t,this.exp=e,this.level=s}}class Nr extends Pi{prot=Mn.UPDATE_STAT;encode(t,e){t.p1(e.stat),t.p4(e.exp/10|0),t.p1(e.level)}}class Pr extends Pi{prot=Mn.UPDATE_UID192;encode(t,e){t.p2(e.uid)}}class Lr extends Pi{prot=Mn.UPDATE_ZONE_FULL_FOLLOWS;encode(t,e){t.p1((e.zoneX<<3)-ts.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-ts.zoneOrigin(e.originZ))}}class Sr extends Pi{prot=Mn.UPDATE_ZONE_PARTIAL_FOLLOWS;encode(t,e){t.p1((e.zoneX<<3)-ts.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-ts.zoneOrigin(e.originZ))}}class Cr extends Pi{prot=Mn.UPDATE_ZONE_PARTIAL_ENCLOSED;encode(t,e){t.p1((e.zoneX<<3)-ts.zoneOrigin(e.originX)),t.p1((e.zoneZ<<3)-ts.zoneOrigin(e.originZ)),t.pdata(e.data,0,e.data.length)}test(t){return 2+t.data.length}}class yr extends Pi{prot=Mn.VARP_LARGE;encode(t,e){t.p2(e.varp),t.p4(e.value)}}class vr extends Pi{prot=Mn.VARP_SMALL;encode(t,e){t.p2(e.varp),t.p1(e.value)}}class wr extends Kn{buildArea;level;x;z2;originX;originZ;priority=jn.HIGH;accumulator=0;constructor(t,e,s,n,i,a){super(),this.buildArea=t,this.level=e,this.x=s,this.z=n,this.originX=i,this.originZ=a}}class Rr extends Pi{static BITS_NEW=35;static BITS_RUN=10;static BITS_WALK=7;static BITS_EXTENDED=3;static BYTES_LIMIT=4997;prot=Mn.NPC_INFO;encode(t,e){const s=e.buildArea;this.writeNpcs(t,e),this.writeNewNpcs(t,e);const n=s.extendedInfo;if(n.size>0)for(const e of n){const s=rl.getNpc(e.id);s&&this.writeUpdate(s,t,e.added)}s.reset()}test(t){return Rr.BYTES_LIMIT}writeNpcs(t,e){const s=e.buildArea;t.bits(),t.pBit(8,s.npcs.size);for(const n of s.npcs){const i=rl.getNpc(n);if(!i||i.tele||i.level!==e.level||!ts.isWithinDistanceSW(e,i,16)||!i.checkLifeCycle(rl.currentTick)){t.pBit(1,1),t.pBit(2,3),s.npcs.delete(n);continue}let a=i.mask>0;const{walkDir:r,runDir:o}=i;let c=0;-1!==o?c=Rr.BITS_RUN:-1!==r?c=Rr.BITS_WALK:a&&(c=Rr.BITS_EXTENDED);const l=a?this.calculateUpdateSize(i,!1):0;(t.bitPos+c+7+24>>>3)+t.pos+(e.accumulator+=l)>this.test(e)&&(a=!1),t.pBit(1,-1!==o||-1!==r||a?1:0),-1!==o?(t.pBit(2,2),t.pBit(3,r),t.pBit(3,o),t.pBit(1,a?1:0)):-1!==r?(t.pBit(2,1),t.pBit(3,r),t.pBit(1,a?1:0)):a&&t.pBit(2,0),a&&s.extendedInfo.add({id:n,added:!1})}}writeNewNpcs(t,e){const s=e.buildArea;for(const n of s.getNearbyNpcs(e.x,e.z,e.originX,e.originZ)){const i=n.mask>0||-1!==n.orientation||-1!==n.faceX||-1!==n.faceZ||-1!==n.faceEntity,a=i?this.calculateUpdateSize(n,!0):0;if((t.bitPos+Rr.BITS_NEW+7+24>>>3)+t.pos+(e.accumulator+=a)>this.test(e))break;t.pBit(13,n.nid),t.pBit(11,n.type),t.pBit(5,n.x-e.x),t.pBit(5,n.z-e.z),t.pBit(1,i?1:0),s.npcs.add(n.nid),i&&s.extendedInfo.add({id:n.nid,added:!0})}s.extendedInfo.size>0&&t.pBit(13,8191),t.bytes()}writeUpdate(t,e,s){let n=t.mask;if(!s||-1===t.orientation&&-1===t.faceX&&-1==t.faceZ||(n|=Yc.FACE_COORD),s&&-1!==t.faceEntity&&(n|=Yc.FACE_ENTITY),e.p1(n),n&Yc.ANIM&&(e.p2(t.animId),e.p1(t.animDelay)),n&Yc.FACE_ENTITY&&(-1!==t.faceEntity&&(t.alreadyFacedEntity=!0),e.p2(t.faceEntity)),n&Yc.SAY&&e.pjstr(t.chat??''),n&Yc.DAMAGE&&(e.p1(t.damageTaken),e.p1(t.damageType),e.p1(t.levels[lt.HITPOINTS]),e.p1(t.baseLevels[lt.HITPOINTS])),n&Yc.CHANGE_TYPE&&e.p2(t.type),n&Yc.SPOTANIM&&(e.p2(t.graphicId),e.p2(t.graphicHeight),e.p2(t.graphicDelay)),n&Yc.FACE_COORD)if(-1!==t.faceX&&(t.alreadyFacedCoord=!0),s&&-1!=t.faceX)e.p2(t.faceX),e.p2(t.faceZ);else if(s&&-1!=t.orientation){const s=ts.moveX(t.x,t.orientation),n=ts.moveZ(t.z,t.orientation);e.p2(2*s+1),e.p2(2*n+1)}else e.p2(t.faceX),e.p2(t.faceZ)}calculateUpdateSize(t,e){let s=0,n=t.mask;return!e||-1===t.orientation&&-1===t.faceX&&-1==t.faceZ||(n|=Yc.FACE_COORD),e&&-1!==t.faceEntity&&(n|=Yc.FACE_ENTITY),s+=1,n&Yc.ANIM&&(s+=3),n&Yc.FACE_ENTITY&&(s+=2),n&Yc.SAY&&(s+=(t.chat?.length??0)+1),n&Yc.DAMAGE&&(s+=4),n&Yc.CHANGE_TYPE&&(s+=2),n&Yc.SPOTANIM&&(s+=6),n&Yc.FACE_COORD&&(s+=4),s}}var br=new class{encoders=new Map;bind(t,e){if(this.encoders.has(t))throw new Error(`[ServerProtRepository] Already defines a ${t.name}.`);this.encoders.set(t,e)}constructor(){this.bind(Hi,new Fi),this.bind(Gi,new Wi),this.bind(zi,new Vi),this.bind(Yi,new Ki),this.bind(ji,new Zi),this.bind(Ri,new bi),this.bind(Ui,new Di),this.bind(Mi,new ki),this.bind(xi,new Bi),this.bind(Ji,new $i),this.bind(Xi,new Qi),this.bind(ri,new qi),this.bind(Zn,new ta),this.bind(Si,new Li),this.bind(ea,new sa),this.bind(na,new ia),this.bind(aa,new ra),this.bind(ii,new oa),this.bind(ca,new la),this.bind(ha,new da),this.bind(pa,new ua),this.bind(_a,new ga),this.bind(ma,new Ea),this.bind(Oa,new fa),this.bind(Aa,new Ta),this.bind(Ia,new Na),this.bind(Pa,new La),this.bind(Sa,new Ca),this.bind(ya,new va),this.bind(oi,new wa),this.bind(gi,new Ua),this.bind(Ii,new Da),this.bind(mi,new Ma),this.bind(Ni,new ka),this.bind(xa,new Ba),this.bind(Oi,new Ha),this.bind(Ei,new Fa),this.bind(ci,new Ga),this.bind(Va,new za),this.bind(ni,new Ya),this.bind(si,new Ka),this.bind(wr,new Rr),this.bind(_i,new ja),this.bind(Ai,new Za),this.bind(fi,new Ja),this.bind(Ti,new $a),this.bind(Xa,new Qa),this.bind(Ci,new yi),this.bind(vi,new wi),this.bind($n,new qa),this.bind(Xn,new tr),this.bind(er,new sr),this.bind(nr,new ir),this.bind(ar,new rr),this.bind(Qn,new or),this.bind(ai,new cr),this.bind(lr,new hr),this.bind(dr,new pr),this.bind(ur,new _r),this.bind(gr,new mr),this.bind(qn,new Er),this.bind(Or,new fr),this.bind(Ar,new Tr),this.bind(Ir,new Nr),this.bind(Jn,new Pr),this.bind(di,new Lr),this.bind(hi,new Cr),this.bind(pi,new Sr),this.bind(ei,new yr),this.bind(ti,new vr)}getEncoder(t){return this.encoders.get(t.constructor)}getZoneEncoder(t){return this.encoders.get(t.constructor)}};class Ur extends Array{capacity;onFilled;constructor(t,e){super(),this.capacity=t,this.onFilled=e}*stack(t){const e=this[t];if(void 0!==e)for(let t=0;t<e.length;t++)yield e[t]}*all(t=!1){for(let e=0;e<this.length;e++){const s=this[e];if(void 0!==s)if(t)for(let t=0;t<s.length;t++)yield s[t];else for(let t=0;t<s.length;t++)yield s[t]}}addLast(t,e,s=!1){this.check(t,s),this[t]?.push(e)}addFirst(t,e,s=!1){this.check(t,s),this[t]?.unshift(e)}sortStack(t,e=!1){const s=this.nextTopStack(t);if(void 0===s)return;const n=this[t];void 0!==n&&n[0]!==s&&(this.remove(t,s),this.addFirst(t,s,e))}remove(t,e){const s=this[t];if(void 0===s)return;const n=s.indexOf(e);-1!==n&&s.splice(n,1)}contains(t,e){const s=this[t];return void 0!==s&&-1!==s.indexOf(e)}check(t,e){if(void 0===this[t]&&(this[t]=[]),!e&&this.total===this.capacity){const t=this.nextBottomAll();void 0!==t&&this.onFilled(t)}}get total(){let t=0;for(let e=0;e<this.length;e++){const s=this[e];void 0!==s&&(t+=s.length)}return t}}class Dr extends Ur{nextTopStack(t){const e=this[t];if(void 0===e)return;let s,n=-99999999;for(const t of e){const e=t.lifecycle;e>n&&(n=e,s=t)}return s}nextBottomAll(){let t,e=Number.POSITIVE_INFINITY;for(let s=0;s<this.length;s++){const n=this[s];if(void 0!==n)for(const s of n){if(0===e)break;if(s.lifecycle!==en.DESPAWN)continue;const n=s.lifecycle;n<e&&(e=n,t=s)}}return t}}class Mr extends Ur{nextTopStack(t){const e=this[t];if(void 0===e)return;let s,n=-99999999;for(const t of e){const e=gt.get(t.type);let i=e.cost;e.stackable&&(i*=t.count+1),i+=t.lifecycle,i>n&&(n=i,s=t)}return s}nextBottomAll(){let t,e=Number.POSITIVE_INFINITY;for(let s=0;s<this.length;s++){const n=this[s];if(void 0!==n)for(const s of n){if(0===e)break;if(s.lifecycle!==en.DESPAWN)continue;const n=gt.get(s.type);let i=n.cost;n.stackable&&(i*=s.count+1),i+=s.lifecycle,i<e&&(e=i,t=s)}}return t}}class kr{static SIZE=64;static LOCS=this.SIZE<<2;static OBJS=1+(this.SIZE<<1);index;x;z;level;players;npcs;locs;objs;events;shared=null;totalLocs=0;totalObjs=0;constructor(t){this.index=t;const e=Br.unpackIndex(t);this.x=e.x>>3,this.z=e.z>>3,this.level=e.level,this.events=new Set,this.players=new Set,this.npcs=new Set,this.locs=new Dr(kr.LOCS,(t=>rl.removeLoc(t,100))),this.objs=new Mr(kr.OBJS,(t=>rl.removeObj(t,100)))}enter(t){t instanceof Vr?(this.players.add(t.uid),rl.getZoneGrid(this.level).flag(this.x,this.z)):t instanceof Yc&&this.npcs.add(t.nid)}leave(t){t instanceof Vr?(this.players.delete(t.uid),0===this.players.size&&rl.getZoneGrid(this.level).unflag(this.x,this.z)):t instanceof Yc&&this.npcs.delete(t.nid)}tick(t){let e;do{e=!1;for(const s of this.getAllObjsUnsafe())s.updateLifeCycle(t)&&s.lastLifecycleTick!==t&&(s.lifecycle===en.DESPAWN?-1!==s.receiverId?rl.revealObj(s):(rl.removeObj(s,0),e=!0):s.lifecycle===en.RESPAWN&&(rl.addObj(s,-1,0),e=!0));for(const s of this.getAllLocsUnsafe())s.updateLifeCycle(t)&&s.lastLifecycleTick!==t&&(s.lifecycle===en.DESPAWN?(rl.removeLoc(s,0),e=!0):s.lifecycle===en.RESPAWN&&(rl.addLoc(s,0),e=!0))}while(e)}computeShared(){this.shared=null;let t=0;const e=[];for(const s of this.events.values()){if(s.type!==li.ENCLOSED)continue;const n=br.getZoneEncoder(s.message);if(void 0===n)continue;const i=n.enclose(s.message);e.push(i),t+=i.length}if(0===e.length||0===t)return;const s=new Uint8Array(t);let n=0;for(const t of e)s.set(t,n),n+=t.length;this.shared=s}writeFullFollows(t){t.write(new di(this.x,this.z,t.originX,t.originZ));for(const e of this.getAllObjsUnsafe(!0))-1!==e.receiverId&&e.receiverId!==t.pid||(t.write(new pi(this.x,this.z,t.originX,t.originZ)),(e.lifecycle===en.DESPAWN&&e.checkLifeCycle(rl.currentTick)||e.lifecycle===en.RESPAWN&&e.checkLifeCycle(rl.currentTick))&&t.write(new _i(ts.packZoneCoord(e.x,e.z),e.type,e.count)));for(const e of this.getAllLocsUnsafe(!0))e.lifecycle===en.DESPAWN&&e.checkLifeCycle(rl.currentTick)?t.write(new gi(ts.packZoneCoord(e.x,e.z),e.type,e.shape,e.angle)):e.lifecycle!==en.RESPAWN||e.checkLifeCycle(rl.currentTick)||t.write(new mi(ts.packZoneCoord(e.x,e.z),e.shape,e.angle))}writePartialEncloses(t){this.shared&&t.write(new hi(this.x,this.z,t.originX,t.originZ,this.shared))}writePartialFollows(t){if(0!==this.events.size){t.write(new pi(this.x,this.z,t.originX,t.originZ));for(const e of this.events)e.type===li.FOLLOWS&&(-1!==e.receiverId&&e.receiverId!==t.pid||t.write(e.message))}}reset(){this.events.clear()}addStaticLoc(t){const e=ts.packZoneCoord(t.x,t.z);this.locs.addLast(e,t,!0),this.totalLocs++,this.locs.sortStack(e,!0)}addStaticObj(t){const e=ts.packZoneCoord(t.x,t.z);this.objs.addLast(e,t,!0),this.totalObjs++,this.objs.sortStack(e,!0)}addLoc(t){const e=ts.packZoneCoord(t.x,t.z);t.lifecycle===en.DESPAWN&&(this.locs.addLast(e,t),this.totalLocs++),this.locs.sortStack(e),this.events.add({type:li.ENCLOSED,receiverId:-1,message:new gi(e,t.type,t.shape,t.angle)})}removeLoc(t){const e=ts.packZoneCoord(t.x,t.z);t.lifecycle===en.DESPAWN&&(this.locs.remove(e,t),this.totalLocs--),this.locs.sortStack(e),this.events.add({type:li.ENCLOSED,receiverId:-1,message:new mi(e,t.shape,t.angle)})}getLoc(t,e,s){for(const n of this.getLocsSafe(ts.packZoneCoord(t,e)))if(n.type===s)return n;return null}mergeLoc(t,e,s,n,i,a,r,o){this.events.add({type:li.ENCLOSED,receiverId:-1,message:new Ni(t.x,t.z,t.shape,t.angle,t.type,s,n,e.pid,a,i,o,r)})}animLoc(t,e){this.events.add({type:li.ENCLOSED,receiverId:-1,message:new Ii(ts.packZoneCoord(t.x,t.z),t.shape,t.angle,e)})}addObj(t,e){const s=ts.packZoneCoord(t.x,t.z);t.lifecycle===en.DESPAWN&&(this.objs.addLast(s,t),this.totalObjs++),this.objs.sortStack(s),t.lifecycle===en.RESPAWN||-1===t.receiverId?this.events.add({type:li.ENCLOSED,receiverId:e,message:new _i(s,t.type,t.count)}):t.lifecycle===en.DESPAWN&&this.events.add({type:li.FOLLOWS,receiverId:e,message:new _i(s,t.type,t.count)})}revealObj(t,e){t.receiverId=-1,t.reveal=-1;const s=ts.packZoneCoord(t.x,t.z);this.objs.sortStack(s),this.events.add({type:li.ENCLOSED,receiverId:-1,message:new Ti(s,t.type,t.count,e)})}changeObj(t,e,s,n){t.count=n;const i=ts.packZoneCoord(t.x,t.z);this.objs.sortStack(i),this.events.add({type:li.FOLLOWS,receiverId:e,message:new Ai(i,t.type,s,n)})}removeObj(t){const e=ts.packZoneCoord(t.x,t.z);t.lifecycle===en.DESPAWN&&(this.objs.remove(e,t),this.totalObjs--),this.objs.sortStack(e),t.lifecycle===en.RESPAWN||-1===t.receiverId?this.events.add({type:li.ENCLOSED,receiverId:-1,message:new fi(e,t.type)}):t.lifecycle===en.DESPAWN&&this.events.add({type:li.FOLLOWS,receiverId:-1,message:new fi(e,t.type)})}animMap(t,e,s,n,i){this.events.add({type:li.ENCLOSED,receiverId:-1,message:new Oi(ts.packZoneCoord(t,e),s,n,i)})}mapProjAnim(t,e,s,n,i,a,r,o,c,l,h,d){this.events.add({type:li.ENCLOSED,receiverId:-1,message:new Ei(t,e,s,n,i,a,r,o,c,l,h,d)})}getObj(t,e,s,n){for(const i of this.getObjsSafe(ts.packZoneCoord(t,e)))if((-1===i.receiverId||i.receiverId===n)&&i.type===s)return i;return null}*getAllPlayersSafe(){for(const t of this.players){const e=rl.getPlayerByUid(t);e&&e.checkLifeCycle(rl.currentTick)&&(yield e)}}*getAllNpcsSafe(){for(const t of this.npcs){const e=rl.getNpc(t);e&&e.checkLifeCycle(rl.currentTick)&&(yield e)}}*getAllObjsSafe(){for(const t of this.objs.all())t.checkLifeCycle(rl.currentTick)&&(yield t)}*getObjsSafe(t){for(const e of this.objs.stack(t))e.checkLifeCycle(rl.currentTick)&&(yield e)}*getObjsUnsafe(t){yield*this.objs.stack(t)}*getAllObjsUnsafe(t=!1){yield*this.objs.all(t)}*getAllLocsSafe(){for(const t of this.locs.all())t.checkLifeCycle(rl.currentTick)&&(yield t)}*getLocsSafe(t){for(const e of this.locs.stack(t))e.checkLifeCycle(rl.currentTick)&&(yield e)}*getLocsUnsafe(t){yield*this.locs.stack(t)}*getAllLocsUnsafe(t=!1){yield*this.locs.all(t)}}class xr{static GRID_SIZE=2048;static INT_BITS=5;static INT_BITS_FLAG=(1<<this.INT_BITS)-1;static DEFAULT_GRID_SIZE=this.GRID_SIZE*(this.GRID_SIZE>>this.INT_BITS);grid;constructor(t=xr.DEFAULT_GRID_SIZE){this.grid=new Int32Array(t)}index(t,e){return t<<xr.INT_BITS|e>>>xr.INT_BITS}flag(t,e){this.grid[this.index(t,e)]|=1<<(e&xr.INT_BITS_FLAG)}unflag(t,e){this.grid[this.index(t,e)]&=~(1<<(e&xr.INT_BITS_FLAG))}isFlagged(t,e,s){const n=Math.max(0,t-s),i=Math.min(xr.GRID_SIZE-1,t+s),a=Math.max(0,e-s),r=Math.min(xr.GRID_SIZE-1,e+s),o=xr.INT_BITS_FLAG,c=a&~o,l=r>>>xr.INT_BITS<<xr.INT_BITS;for(let t=n;t<=i;t++)for(let e=c;e<=l;e+=32){const s=this.index(t,e),n=this.grid[s];let i=n;e+o>r&&(i=n&(1<<r-e+1)-1);let c=i;if(e<a&&(c=i>>>a-e),0!==c)return!0}return!1}}class Br{static zoneIndex(t,e,s){return t>>3&2047|(e>>3&2047)<<11|(3&s)<<22}static unpackIndex(t){return{x:(2047&t)<<3,z:(t>>11&2047)<<3,level:t>>22}}zones;grids;constructor(){this.zones=new Map,this.grids=new Map}zone(t,e,s){const n=Br.zoneIndex(t,e,s);let i=this.zones.get(n);return void 0===i&&(i=new kr(n),this.zones.set(n,i)),i}zoneByIndex(t){let e=this.zones.get(t);return void 0===e&&(e=new kr(t),this.zones.set(t,e)),e}grid(t){let e=this.grids.get(t);return void 0===e&&(e=new xr,this.grids.set(t,e)),e}zoneCount(){return this.zones.size}locCount(){let t=0;for(const e of this.zones.values())t+=e.totalLocs;return t}objCount(){let t=0;for(const e of this.zones.values())t+=e.totalObjs;return t}}class Hr{static INTERVAL=10;static PREFERRED_PLAYERS=250;static PREFERRED_NPCS=255;static PREFERRED_VIEW_DISTANCE=16;npcs;players;loadedZones;activeZones;extendedInfo;appearances;forceViewDistance=!1;viewDistance=Hr.PREFERRED_VIEW_DISTANCE;lastResize=0;constructor(){this.npcs=new Set,this.players=new Set,this.loadedZones=new Set,this.activeZones=new Set,this.extendedInfo=new Set,this.appearances=new Map}resize(){if(!this.forceViewDistance)return this.players.size>=Hr.PREFERRED_PLAYERS?(this.viewDistance>1&&this.viewDistance--,void(this.lastResize=0)):void(++this.lastResize>=Hr.INTERVAL&&(this.viewDistance<Hr.PREFERRED_VIEW_DISTANCE?this.viewDistance++:this.lastResize=0))}reset(){this.extendedInfo.clear()}hasAppearance(t,e){const s=this.appearances.get(t);return void 0!==s&&s===e}saveAppearance(t,e){this.appearances.set(t,e)}*getNearbyPlayers(t,e,s,n,i){t:for(const a of this.proximitySort(e,s,this.activeZones))for(const r of this.getNearby(rl.getZoneIndex(a).getAllPlayersSafe(),e,s,n,i,this.viewDistance)){if(this.players.size>=Hr.PREFERRED_PLAYERS)break t;this.players.has(r.uid)||r.uid!==t&&(yield r)}}*getNearbyNpcs(t,e,s,n){t:for(const i of this.proximitySort(t,e,this.activeZones))for(const a of this.getNearby(rl.getZoneIndex(i).getAllNpcsSafe(),t,e,s,n,16)){if(this.npcs.size>=Hr.PREFERRED_NPCS)break t;this.npcs.has(a.nid)||(yield a)}}*getNearby(t,e,s,n,i,a){const r=n-48,o=n+48,c=i+48,l=i-48;for(const n of t)n.x<=r||n.x>=o||n.z>=c||n.z<=l||ts.isWithinDistanceSW({x:e,z:s},n,a)&&(yield n)}proximitySort(t,e,s){return Array.from(s.values()).map((s=>this.zoneToDistance(s,t,e))).sort(((t,e)=>t.distance-e.distance)).map((({zoneIndex:t})=>t))}zoneToDistance(t,e,s){const n=Br.unpackIndex(t);return{zoneIndex:t,distance:Math.abs(n.x-e)+Math.abs(n.z-s)}}}function Fr(t){for(let e=98;e>=0;e--)if(t>=Wr[e])return Math.min(e+2,99);return 1}function Gr(t){return Wr[t-2]}var Wr=new Int32Array(99),zr=0;for(let t=0;t<99;t++){const e=t+1;zr+=Math.floor(e+300*Math.pow(2,e/7)),Wr[t]=10*Math.floor(zr/4)}class Vr extends Fn{static APPEARANCE=1;static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static FACE_COORD=32;static CHAT=64;static BIG_UPDATE=128;static SPOTANIM=256;static EXACT_MOVE=512;static SKILLS=['attack','defence','strength','hitpoints','ranged','prayer','magic','cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing','mining','herblore','agility','thieving','stat18','stat19','runecraft'];static DESIGN_BODY_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];save(){}username;username37;displayName;body;colors;gender;runenergy=1e4;lastRunEnergy=-1;runweight;playtime;stats=new Int32Array(21);levels=new Uint8Array(21);vars;varsString;invs=new Map;pid=-1;uid=-1;lowMemory=!1;combatLevel=3;headicons=0;appearance=null;lastAppearance=0;baseLevels=new Uint8Array(21);lastStats=new Int32Array(21);lastLevels=new Uint8Array(21);originX=-1;originZ=-1;buildArea=new Hr;lastMovement=0;basReadyAnim=-1;basTurnOnSpot=-1;basWalkForward=-1;basWalkBackward=-1;basWalkLeft=-1;basWalkRight=-1;basRunning=-1;animProtect=0;logoutRequested=!1;invListeners=[];allowDesign=!1;afkEventReady=!1;interactWalkTrigger=!1;highPriorityOut=new Gn;lowPriorityOut=new Gn;lastResponse=-1;messageColor=null;messageEffect=null;messageType=null;message=null;delay=0;queue=new E;weakQueue=new E;engineQueue=new E;cameraPackets=new E;timers=new Map;modalState=0;modalTop=-1;lastModalTop=-1;modalBottom=-1;lastModalBottom=-1;modalSidebar=-1;lastModalSidebar=-1;refreshModalClose=!1;refreshModal=!1;modalSticky=-1;overlaySide=new Array(14).fill(-1);receivedFirstClose=!1;protect=!1;activeScript=null;resumeButtons=[];lastItem=-1;lastSlot=-1;lastUseItem=-1;lastUseSlot=-1;lastTargetSlot=-1;lastCom=-1;staffModLevel=0;heroPoints=new Array(16);afkZones=new Int32Array(2);lastAfkZone=0;constructor(t,e){super(0,3094,3106,1,1,en.FOREVER,ct.NORMAL,at.NPC,Hn.SMART,Vr.FACE_COORD,Vr.FACE_ENTITY),this.username=t,this.username37=e,this.displayName=_(t),this.vars=new Int32Array(At.count),this.varsString=new Array(At.count),this.body=[0,10,18,26,33,36,42],this.colors=[0,0,0,0,0],this.gender=0,this.runenergy=1e4,this.runweight=0,this.playtime=0,this.lastStats.fill(-1),this.lastLevels.fill(-1)}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(t,e){const s=this.heroPoints.findIndex((e=>e&&e.uid===t));if(-1!==s)return void(this.heroPoints[s].points+=e);const n=this.heroPoints.findIndex((t=>t&&-1===t.uid));-1===n||(this.heroPoints[n]={uid:t,points:e})}findHero(){return this.heroPoints.sort(((t,e)=>e.points-t.points)),this.heroPoints[0]?.uid??-1}resetEntity(t){super.resetPathingEntity(),this.repathed=!1,this.protect=!1,this.messageColor=null,this.messageEffect=null,this.messageType=null,this.message=null}onLogin(){this.playerLog('Logging in'),this.write(new Zn),this.write(new Jn(this.pid)),this.unsetMapFlag(),this.write(new $n),this.resetHeroPoints(),this.write(new Xn);for(let t=0;t<this.vars.length;t++){const e=At.get(t),s=this.vars[t];e.transmit&&this.writeVarp(t,s)}const t=Qt.getByTriggerSpecific(In.LOGIN,-1,-1);t&&this.executeScript(Vc.init(t,this),!0);const e=Qt.getByTriggerSpecific(In.MOVE,-1,-1);if(e){const t=Vc.init(e,this);this.runScript(t,!0)}this.lastStepX=this.x-1,this.lastStepZ=this.z}calculateRunWeight(){this.runweight=0;const t=this.invs.values();for(let e=0;e<this.invs.size;e++){const e=t.next().value;if(!e)continue;const s=J.get(e.type);if(s&&s.runweight)for(let t=0;t<e.capacity;t++){const s=e.get(t);if(!s)continue;const n=gt.get(s.id);n&&!n.stackable&&(this.runweight+=n.weight*s.count)}}}playerLog(t,...e){}processEngineQueue(){for(let t=this.engineQueue.head();null!==t;t=this.engineQueue.next()){const e=t.delay--;if(this.canAccess()&&e<=0){const e=Vc.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}updateMovement(t=!0){if(this.containsModalInterface())return this.recoverEnergy(!1),!1;if(t&&this.target instanceof Fn&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),this.hasWaypoints()&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const t=Qt.get(this.walktrigger);if(this.walktrigger=-1,t){const e=Vc.init(t,this);this.runScript(e,!0)}}this.moveSpeed!==Bn.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed(),-1===this.basRunning?this.moveSpeed=Bn.WALK:this.getVar(At.TEMP_RUN)&&(this.moveSpeed=Bn.RUN)),super.processMovement()||this.setVar(At.TEMP_RUN,0);const e=this.lastX!==this.x||this.lastZ!==this.z;if(e){const t=Qt.getByTriggerSpecific(In.MOVE,-1,-1);t&&this.runScript(Vc.init(t,this),!0)}return this.drainEnergy(e),this.recoverEnergy(e),0===this.runenergy&&(this.setVar(At.PLAYER_RUN,0),this.setVar(At.TEMP_RUN,0)),e}drainEnergy(t){if(t&&0!==this.stepsTaken&&!this.delayed()&&this.moveSpeed===Bn.RUN&&this.stepsTaken>1){const t=Math.floor(this.runweight/1e3),e=67+67*Math.min(Math.max(t,0),64)/64|0;this.runenergy=Math.max(this.runenergy-e,0)}}recoverEnergy(t){if(!this.delayed()&&(!t||this.moveSpeed!==Bn.RUN)&&this.runenergy<1e4){const t=8+(this.baseLevels[is.AGILITY]/9|0);this.runenergy=Math.min(this.runenergy+t,1e4)}}blockWalkFlag(){return Fe.PLAYER}defaultMoveSpeed(){return this.getVar(At.PLAYER_RUN)?Bn.RUN:Bn.WALK}closeSticky(){if(-1!==this.modalSticky){const t=Qt.getByTrigger(In.IF_CLOSE,this.modalSticky);t&&this.enqueueScript(t,1),this.modalSticky=-1,this.write(new Qn(-1))}}closeModal(){if(this.receivedFirstClose){if(this.weakQueue.clear(),this.delayed()||(this.protect=!1),0!==this.modalState){if(-1!==this.modalTop){const t=Qt.getByTrigger(In.IF_CLOSE,this.modalTop);t&&this.enqueueScript(t,1),this.modalTop=-1}if(-1!==this.modalBottom){const t=Qt.getByTrigger(In.IF_CLOSE,this.modalBottom);t&&this.enqueueScript(t,1),this.modalBottom=-1}if(-1!==this.modalSidebar){const t=Qt.getByTrigger(In.IF_CLOSE,this.modalSidebar);t&&this.enqueueScript(t,1),this.modalSidebar=-1}this.modalState=0,this.refreshModalClose=!0}}else this.receivedFirstClose=!0}delayed(){return this.delay>0}containsModalInterface(){return!(1&~this.modalState&&2&~this.modalState&&16&~this.modalState)}busy(){return this.delayed()||this.containsModalInterface()}canAccess(){return!this.protect&&!this.busy()}enqueueScript(t,e=0,s=0,n=[]){const i=new Un(e,t,n,s);1===e?(i.delay=0,this.engineQueue.addTail(i)):2===e?this.weakQueue.addTail(i):this.queue.addTail(i)}processQueues(){let t=!1;for(let e=this.queue.head();null!==e;e=this.queue.next())if(3===e.type){t=!0;break}t&&this.closeModal(),this.processQueue(),this.processWeakQueue()}processQueue(){for(let t=this.queue.head();null!==t;t=this.queue.next()){3===t.type&&this.closeModal();const e=t.delay--;if(this.canAccess()&&e<=0){const e=Vc.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}processWeakQueue(){for(let t=this.weakQueue.head();null!==t;t=this.weakQueue.next()){const e=t.delay--;if(this.canAccess()&&e<=0){const e=Vc.init(t.script,this,null,t.args);this.executeScript(e,!0),t.unlink()}}}setTimer(t,e,s=[],n){const i=e.id,a={type:t,script:e,args:s,interval:n,clock:n};this.timers.set(i,a)}clearTimer(t){this.timers.delete(t)}processTimers(t){for(const e of this.timers.values())if(t===e.type&&--e.clock<=0&&(1===e.type||this.canAccess())){e.clock=e.interval;const t=Vc.init(e.script,this,null,e.args);this.runScript(t,0===e.type)}}stopAction(){this.clearPendingAction(),this.unsetMapFlag()}clearPendingAction(){this.clearInteraction(),this.closeModal()}hasInteraction(){return null!==this.target}getOpTrigger(){if(!this.target)return null;let t=-1,e=-1;if(this.target instanceof Yc||this.target instanceof _n||this.target instanceof an){const s=this.target instanceof Yc?ht.get(this.target.type):this.target instanceof _n?et.get(this.target.type):gt.get(this.target.type);t=s.id,e=s.category}return-1!==this.targetSubject.type&&(t=this.targetSubject.type),-1!==this.targetSubject.com&&(t=this.targetSubject.com),Qt.getByTrigger(this.targetOp+7,t,e)??null}getApTrigger(){if(!this.target)return null;let t=-1,e=-1;if(this.target instanceof Yc||this.target instanceof _n||this.target instanceof an){const s=this.target instanceof Yc?ht.get(this.target.type):this.target instanceof _n?et.get(this.target.type):gt.get(this.target.type);t=s.id,e=s.category}return-1!==this.targetSubject.type&&(t=this.targetSubject.type),-1!==this.targetSubject.com&&(t=this.targetSubject.com),Qt.getByTrigger(this.targetOp,t,e)??null}processInteraction(){if(null===this.target||!this.canAccess())return void this.updateMovement();if(this.target.level!==this.level)return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Yc&&(void 0===rl.getNpc(this.target.nid)||this.target.delayed()))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Yc&&-1!==this.targetSubject.type&&null===rl.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof an&&null===rl.getObj(this.target.x,this.target.z,this.level,this.target.type,this.pid))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof _n&&null===rl.getLoc(this.target.x,this.target.z,this.level,this.target.type))return this.clearInteraction(),void this.unsetMapFlag();if(this.target instanceof Vr&&null===rl.getPlayerByUid(this.target.uid))return this.clearInteraction(),void this.unsetMapFlag();if(this.targetOp===In.APPLAYER3||this.targetOp===In.OPPLAYER3){return void(this.updateMovement(!1)&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=rl.currentTick+1))}const t=this.getOpTrigger(),e=this.getApTrigger();if(t&&this.target instanceof Fn&&this.inOperableDistance(this.target)){const e=this.target;this.target=null,this.executeScript(Vc.init(t,this,e),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(e&&this.inApproachDistance(this.apRange,this.target)){const t=this.target;this.target=null,this.executeScript(Vc.init(e,this,t),!0),this.apRangeCalled?this.target=t:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if(this.target instanceof Fn&&this.inOperableDistance(this.target)){if(_t.NODE_DEBUG&&!t&&!e){let t='_';this.target instanceof Yc?t=-1!==this.targetSubject.com&&this.targetOp===In.APNPCT||this.targetOp===In.OPNPCT?Z.get(this.targetSubject.com)?.comName??this.targetSubject.toString():ht.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof _n?t=et.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof an?t=gt.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===In.APNPCT||this.targetOp===In.APPLAYERT||this.targetOp===In.APLOCT||this.targetOp===In.APOBJT?t=Z.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(t=gt.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${In[this.targetOp+7].toLowerCase()},${t}]`)}this.target=null,this.messageGame('Nothing interesting happens.'),this.interacted=!0,this.clearWaypoints()}const s=this.updateMovement();if(s&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1,this.lastMovement=rl.currentTick+1),this.target&&(!this.interacted||this.apRangeCalled))if(this.interacted=!1,t&&(this.target instanceof Fn||!s)&&this.inOperableDistance(this.target)){const e=this.target;this.target=null,this.executeScript(Vc.init(t,this,e),!0),null===this.target&&this.unsetMapFlag(),this.interacted=!0,this.clearWaypoints()}else if(e&&this.inApproachDistance(this.apRange,this.target)){this.apRangeCalled=!1;const t=this.target;this.target=null,this.executeScript(Vc.init(e,this,t),!0),this.apRangeCalled?this.target=t:(this.clearWaypoints(),this.interacted=!0),null===this.target&&this.unsetMapFlag()}else if((this.target instanceof Fn||!s)&&this.inOperableDistance(this.target)){if(!_t.NODE_PRODUCTION&&!t&&!e){let t='_';this.target instanceof Yc?t=ht.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof _n?t=et.get(this.target.type)?.debugname??this.target.type.toString():this.target instanceof an?t=gt.get(this.target.type)?.debugname??this.target.type.toString():-1!==this.targetSubject.com&&this.targetOp===In.APNPCT||this.targetOp===In.APPLAYERT||this.targetOp===In.APLOCT||this.targetOp===In.APOBJT?t=Z.get(this.targetSubject.com)?.comName??this.targetSubject.toString():-1!==this.targetSubject.type&&(t=gt.get(this.targetSubject.type)?.debugname??this.targetSubject.toString()),this.messageGame(`No trigger for [${In[this.targetOp+7].toLowerCase()},${t}]`)}this.target=null,this.messageGame('Nothing interesting happens.'),this.interacted=!0,this.clearWaypoints()}if(!this.interactWalkTrigger&&-1!==this.walktrigger&&!this.protect&&!this.delayed()){const t=Qt.get(this.walktrigger);if(this.walktrigger=-1,t){const e=Vc.init(t,this);this.interactWalkTrigger=!0,this.unsetMapFlag(),this.runScript(e,!0)}}this.interacted||this.hasWaypoints()||s||(this.messageGame("I can't reach that!"),this.clearInteraction()),this.interacted&&!this.apRangeCalled&&null===this.target&&this.clearInteraction()}getAppearanceInSlot(t){let e=-1;return 8===t?e=this.body[0]:11===t?e=this.body[1]:4===t?e=this.body[2]:6===t?e=this.body[3]:9===t?e=this.body[4]:7===t?e=this.body[5]:10===t&&(e=this.body[6]),-1===e?0:256+e}getCombatLevel(){const t=.25*(this.baseLevels[is.DEFENCE]+this.baseLevels[is.HITPOINTS]+Math.floor(this.baseLevels[is.PRAYER]/2)),e=.325*(this.baseLevels[is.ATTACK]+this.baseLevels[is.STRENGTH]),s=.325*(Math.floor(this.baseLevels[is.RANGED]/2)+this.baseLevels[is.RANGED]),n=.325*(Math.floor(this.baseLevels[is.MAGIC]/2)+this.baseLevels[is.MAGIC]);return Math.floor(t+Math.max(e,s,n))}generateAppearance(t){const e=f.alloc(0);e.p1(this.gender),e.p1(this.headicons);const s=[];let n=this.getInventory(t);n||(n=new ie(J.WORN,0));for(let t=0;t<n.capacity;t++){const e=n.get(t);if(!e)continue;const i=gt.get(e.id);-1!==i.wearpos2&&-1===s.indexOf(i.wearpos2)&&s.push(i.wearpos2),-1!==i.wearpos3&&-1===s.indexOf(i.wearpos3)&&s.push(i.wearpos3)}for(let t=0;t<12;t++){if(-1!==s.indexOf(t)){e.p1(0);continue}const i=n.get(t);if(i)e.p2(512+i.id);else{const s=this.getAppearanceInSlot(t);s<1?e.p1(0):e.p2(s)}}for(let t=0;t<this.colors.length;t++)e.p1(this.colors[t]);e.p2(this.basReadyAnim),e.p2(this.basTurnOnSpot),e.p2(this.basWalkForward),e.p2(this.basWalkBackward),e.p2(this.basWalkLeft),e.p2(this.basWalkRight),e.p2(this.basRunning),e.p8(this.username37),e.p1(this.combatLevel),this.mask|=Vr.APPEARANCE,this.appearance=new Uint8Array(e.pos),e.pos=0,e.gdata(this.appearance,0,this.appearance.length),e.release(),this.lastAppearance=rl.currentTick}getInventoryFromListener(t){if(-1===t.source)return rl.getInventory(t.type);{const e=rl.getPlayerByUid(t.source);return e?e.getInventory(t.type):null}}getInventory(t){if(-1===t)return null;const e=J.get(t);let s=null;return e?(e.scope===J.SCOPE_SHARED?s=rl.getInventory(t):(s=this.invs.get(t),s||(s=ie.fromType(t),this.invs.set(t,s))),s):null}invListenOnCom(t,e,s){if(-1===t)return;if(-1!==this.invListeners.findIndex((s=>s.type===t&&s.com===e)))return;J.get(t).scope===J.SCOPE_SHARED&&(s=-1),this.invListeners.push({type:t,com:e,source:s,firstSeen:!0})}invStopListenOnCom(t){const e=this.invListeners.findIndex((e=>e.com===t));-1!==e&&(this.invListeners.splice(e,1),this.write(new qn(t)))}invGetSlot(t,e){const s=this.getInventory(t);if(!s)throw new Error('invGetSlot: Invalid inventory type: '+t);if(!s.validSlot(e))throw new Error('invGetSlot: Invalid slot: '+e);return s.get(e)}invClear(t){const e=this.getInventory(t);if(!e)throw new Error('invClear: Invalid inventory type: '+t);e.removeAll()}invAdd(t,e,s,n=!0){const i=this.getInventory(t);if(!i)throw new Error('invAdd: Invalid inventory type: '+t);return i.add(e,s,-1,n).completed}invSet(t,e,s,n){const i=this.getInventory(t);if(!i)throw new Error('invSet: Invalid inventory type: '+t);if(!i.validSlot(n))throw new Error('invSet: Invalid slot: '+n);i.set(n,{id:e,count:s})}invDel(t,e,s,n=-1){const i=this.getInventory(t);if(!i)throw new Error('invDel: Invalid inventory type: '+t);if(n<-1||n>=this.invSize(t))throw new Error('invDel: Invalid beginSlot: '+n);return i.remove(e,s,n).completed}invDelSlot(t,e){const s=this.getInventory(t);if(!s)throw new Error('invDelSlot: Invalid inventory type: '+t);if(!s.validSlot(e))throw new Error('invDelSlot: Invalid slot: '+e);s.delete(e)}invSize(t){const e=this.getInventory(t);if(!e)throw new Error('invSize: Invalid inventory type: '+t);return e.capacity}invTotal(t,e){const s=this.getInventory(t);if(!s)throw new Error('invTotal: Invalid inventory type: '+t);return s.getItemCount(e)}invFreeSpace(t){const e=this.getInventory(t);if(!e)throw new Error('invFreeSpace: Invalid inventory type: '+t);return e.freeSlotCount}invItemSpace(t,e,s,n){const i=this.getInventory(t);if(!i)throw new Error('invItemSpace: Invalid inventory type: '+t);const a=gt.get(e);let r=e;if(a.certtemplate>=0&&a.certlink>=0&&(r=a.certlink),a.stackable||r!=e||i.stackType==ie.ALWAYS_STACK){const n=!0===J.get(t).stockobj?.includes(e);return 0!=this.invTotal(t,e)||0!=this.invFreeSpace(t)||n?Math.max(0,s-(ie.STACK_LIMIT-this.invTotal(t,e))):s}return Math.max(0,s-(this.invFreeSpace(t)-(this.invSize(t)-n)))}invMoveToSlot(t,e,s,n){const i=this.getInventory(t);if(!i)throw new Error('invMoveToSlot: Invalid inventory type: '+t);if(!i.validSlot(s))throw new Error('invMoveToSlot: Invalid from slot: '+s);const a=this.getInventory(e);if(!a)throw new Error('invMoveToSlot: Invalid inventory type: '+e);if(!a.validSlot(n))throw new Error('invMoveToSlot: Invalid to slot: '+n);const r=this.invGetSlot(t,s);if(!r)throw new Error(`invMoveToSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${s}`);const o=this.invGetSlot(e,n);this.invSet(e,r.id,r.count,n),o?this.invSet(t,o.id,o.count,s):this.invDelSlot(t,s)}invMoveFromSlot(t,e,s){const n=this.getInventory(t);if(!n)throw new Error('invMoveFromSlot: Invalid inventory type: '+t);if(!this.getInventory(e))throw new Error('invMoveFromSlot: Invalid inventory type: '+e);if(!n.validSlot(s))throw new Error('invMoveFromSlot: Invalid from slot: '+s);const i=this.invGetSlot(t,s);if(!i)throw new Error(`invMoveFromSlot: Invalid from obj was null. This means the obj does not exist at this slot: ${s}`);return{overflow:i.count-this.invAdd(e,i.id,i.count),fromObj:i.id}}invTotalCat(t,e){const s=this.getInventory(t);if(!s)throw new Error('invTotalCat: Invalid inventory type: '+t);return s.itemsFiltered.filter((t=>gt.get(t.id).category==e)).reduce(((t,e)=>t+e.count),0)}_invTotalParam(t,e,s){const n=this.getInventory(t);if(!n)throw new Error('invTotalParam: Invalid inventory type: '+t);const i=dt.get(e);let a=0;for(let t=0;t<n.capacity;t++){const e=n.items[t];if(!e||e.id<0||e.id>=gt.count)continue;const r=gt.get(e.id),o=q(i.id,r,i.defaultInt);a+=s?e.count*o:o}return a}invTotalParam(t,e){return this._invTotalParam(t,e,!1)}invTotalParamStack(t,e){return this._invTotalParam(t,e,!0)}getVar(t){const e=At.get(t);return e.type===I.STRING?this.varsString[e.id]:this.vars[e.id]}setVar(t,e){const s=At.get(t);s.type===I.STRING&&'string'==typeof e?this.varsString[s.id]=e:'number'==typeof e&&(this.vars[s.id]=e,s.transmit&&this.writeVarp(t,e))}writeVarp(t,e){e>=-128&&e<=127?this.write(new ti(t,e)):this.write(new ei(t,e))}addXp(t,e){if(e<0)throw new Error(`Invalid xp parameter for addXp call: Stat was: ${t}, Exp was: ${e}`);if(0==e)return;const s=Number(_t.NODE_XPRATE)||1;this.stats[t]+=e*s,this.stats[t]>2e9&&(this.stats[t]=2e9);const n=this.baseLevels[t];if(this.levels[t]===this.baseLevels[t]&&(this.levels[t]=Fr(this.stats[t])),this.baseLevels[t]=Fr(this.stats[t]),this.baseLevels[t]>n){this.levels[t]<n&&(this.levels[t]+=1);const e=Qt.getByTriggerSpecific(In.LEVELUP,t,-1);e&&this.enqueueScript(e,1)}this.combatLevel!=this.getCombatLevel()&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance(J.WORN))}setLevel(t,e){e=Math.min(99,Math.max(1,e)),this.baseLevels[t]=e,this.levels[t]=e,this.stats[t]=Gr(e),this.getCombatLevel()!=this.combatLevel&&(this.combatLevel=this.getCombatLevel(),this.generateAppearance(J.WORN))}playAnimation(t,e){t>=Et.count||this.animProtect||(-1==t||-1==this.animId||Et.get(t).priority>Et.get(this.animId).priority||0===Et.get(this.animId).priority)&&(this.animId=t,this.animDelay=e,this.mask|=Vr.ANIM)}spotanim(t,e,s){this.graphicId=t,this.graphicHeight=e,this.graphicDelay=s,this.mask|=Vr.SPOTANIM}applyDamage(t,e){this.damageTaken=t,this.damageType=e;const s=this.levels[is.HITPOINTS];s-t<=0?(this.levels[is.HITPOINTS]=0,this.damageTaken=s):this.levels[is.HITPOINTS]=s-t,this.mask|=Vr.DAMAGE}say(t){this.chat=t,this.mask|=Vr.SAY}faceSquare(t,e){this.faceX=2*t+1,this.faceZ=2*e+1,this.orientation=ts.face(this.x,this.z,t,e),this.mask|=Vr.FACE_COORD}playSong(t){if(!(t=t.toLowerCase().replaceAll(' ','_')))return;const e=Vn.get(t+'.mid'),s=Yn.get(t+'.mid');if(e&&s){const n=e.length;this.write(new si(t,s,n))}}playJingle(t,e){if(!(e=e.toLowerCase().replaceAll('_',' ')))return;const s=Vn.get(e+'.mid');s&&this.write(new ni(t,s))}openMainModal(t){4&this.modalState&&(this.write(new Zn),this.modalState&=-5,this.modalSidebar=-1),this.modalState|=1,this.modalTop=t,this.refreshModal=!0}openChat(t){this.modalState|=2,this.modalBottom=t,this.refreshModal=!0}openSideOverlay(t){this.modalState|=4,this.modalSidebar=t,this.refreshModal=!0}openChatSticky(t){this.write(new Qn(t)),this.modalState|=8,this.modalSticky=t}openMainModalSideOverlay(t,e){this.modalState|=1,this.modalTop=t,this.modalState|=4,this.modalSidebar=e,this.refreshModal=!0}exactMove(t,e,s,n,i,a,r){this.exactStartX=t,this.exactStartZ=e,this.exactEndX=s,this.exactEndZ=n,this.exactMoveStart=i,this.exactMoveEnd=a,this.exactMoveDirection=r,this.mask|=Vr.EXACT_MOVE,this.x=s,this.z=n,this.lastStepX=this.x-1,this.lastStepZ=this.z}setTab(t,e){this.overlaySide[e]=t,this.write(new ii(t,e))}isComponentVisible(t){return this.modalTop===t.rootLayer||this.modalBottom===t.rootLayer||this.modalSidebar===t.rootLayer||-1!==this.overlaySide.findIndex((e=>e===t.rootLayer))||this.modalSticky===t.rootLayer}updateAfkZones(){if(this.lastAfkZone=Math.min(1e3,this.lastAfkZone+1),this.withinAfkZone())return;const t=ts.packCoord(0,this.x-10,this.z-10);this.moveSpeed===Bn.INSTANT&&this.jump?this.afkZones[1]=t:this.afkZones[1]=this.afkZones[0],this.afkZones[0]=t,this.lastAfkZone=0}zonesAfk(){return 1e3===this.lastAfkZone}withinAfkZone(){for(let t=0;t<this.afkZones.length;t++){const e=ts.unpackCoord(this.afkZones[t]);if(ts.intersects(this.x,this.z,this.width,this.length,e.x,e.z,21,21))return!0}return!1}isInWilderness(){return this.x>=2944&&this.x<3392&&this.z>=3520&&this.z<6400||this.x>=2944&&this.x<3392&&this.z>=9920&&this.z<12800}runScript(t,e=!1,s=!1){if(!s&&e&&(this.protect||this.delayed()))return-1;e&&(t.pointerAdd(kt.ProtectedActivePlayer),this.protect=!0);const n=Vc.execute(t);return e&&(this.protect=!1),t.pointerGet(kt.ProtectedActivePlayer)&&t._activePlayer&&(t.pointerRemove(kt.ProtectedActivePlayer),t._activePlayer.protect=!1),t.pointerGet(kt.ProtectedActivePlayer2)&&t._activePlayer2&&(t.pointerRemove(kt.ProtectedActivePlayer2),t._activePlayer2.protect=!1),n}executeScript(t,e=!1,s=!1){const n=this.runScript(t,e,s);-1!==n&&(n!==se.FINISHED&&n!==se.ABORTED?n===se.WORLD_SUSPENDED?rl.enqueueScript(t,t.popInt()):n===se.NPC_SUSPENDED?t.activeNpc.activeScript=t:(t.activePlayer.activeScript=t,t.activePlayer.protect=e):t===this.activeScript&&(this.activeScript=null,1&this.modalState||this.closeModal()))}wrappedMessageGame(t){const e=b.get(1).split(t,456);for(const t of e)this.messageGame(t)}write(t){t.priority===jn.HIGH?this.highPriorityOut.push(t):this.lowPriorityOut.push(t)}unsetMapFlag(){this.clearWaypoints(),this.write(new ai)}hintNpc(t){this.write(new ri(1,t,0,0,0,0))}hintTile(t,e,s,n){this.write(new ri(t,0,0,e,s,n))}hintPlayer(t){this.write(new ri(10,0,t,0,0,0))}stopHint(){this.write(new ri(-1,0,0,0,0,0))}lastLoginInfo(t,e,s,n){this.write(new oi(t,e,s,n)),this.modalState|=16}logout(){}terminate(){}messageGame(t){this.write(new ci(t))}}class Yr{index;id;length;static all=[];static byId=[];static REBUILD_GETMAPS=new Yr(4,150,-1);static NO_TIMEOUT=new Yr(6,108,0);static IDLE_TIMER=new Yr(30,70,0);static EVENT_TRACKING=new Yr(34,81,-2);static EVENT_CAMERA_POSITION=new Yr(35,189,6);static ANTICHEAT_OPLOGIC1=new Yr(60,7,4);static ANTICHEAT_OPLOGIC2=new Yr(61,88,4);static ANTICHEAT_OPLOGIC3=new Yr(62,30,3);static ANTICHEAT_OPLOGIC4=new Yr(63,176,2);static ANTICHEAT_OPLOGIC5=new Yr(64,220,0);static ANTICHEAT_OPLOGIC6=new Yr(65,66,4);static ANTICHEAT_OPLOGIC7=new Yr(66,17,4);static ANTICHEAT_OPLOGIC8=new Yr(67,2,2);static ANTICHEAT_OPLOGIC9=new Yr(68,238,1);static ANTICHEAT_CYCLELOGIC1=new Yr(70,233,1);static ANTICHEAT_CYCLELOGIC2=new Yr(71,146,-1);static ANTICHEAT_CYCLELOGIC3=new Yr(74,215,3);static ANTICHEAT_CYCLELOGIC4=new Yr(72,236,4);static ANTICHEAT_CYCLELOGIC5=new Yr(75,85,0);static ANTICHEAT_CYCLELOGIC6=new Yr(73,219,-1);static OPOBJ1=new Yr(80,140,6);static OPOBJ2=new Yr(81,40,6);static OPOBJ3=new Yr(82,200,6);static OPOBJ4=new Yr(83,178,6);static OPOBJ5=new Yr(84,247,6);static OPOBJT=new Yr(88,138,8);static OPOBJU=new Yr(89,239,12);static OPNPC1=new Yr(100,194,2);static OPNPC2=new Yr(101,8,2);static OPNPC3=new Yr(102,27,2);static OPNPC4=new Yr(103,113,2);static OPNPC5=new Yr(104,100,2);static OPNPCT=new Yr(108,134,4);static OPNPCU=new Yr(109,202,8);static OPLOC1=new Yr(120,245,6);static OPLOC2=new Yr(121,172,6);static OPLOC3=new Yr(122,96,6);static OPLOC4=new Yr(123,97,6);static OPLOC5=new Yr(124,116,6);static OPLOCT=new Yr(128,9,8);static OPLOCU=new Yr(129,75,12);static OPPLAYER1=new Yr(140,164,2);static OPPLAYER2=new Yr(141,53,2);static OPPLAYER3=new Yr(142,185,2);static OPPLAYER4=new Yr(143,206,2);static OPPLAYERT=new Yr(148,177,4);static OPPLAYERU=new Yr(149,248,8);static OPHELD1=new Yr(160,195,6);static OPHELD2=new Yr(161,71,6);static OPHELD3=new Yr(162,133,6);static OPHELD4=new Yr(163,157,6);static OPHELD5=new Yr(164,211,6);static OPHELDT=new Yr(168,48,8);static OPHELDU=new Yr(169,130,12);static INV_BUTTON1=new Yr(190,31,6);static INV_BUTTON2=new Yr(191,59,6);static INV_BUTTON3=new Yr(192,212,6);static INV_BUTTON4=new Yr(193,38,6);static INV_BUTTON5=new Yr(194,6,6);static IF_BUTTON=new Yr(200,155,2);static RESUME_PAUSEBUTTON=new Yr(201,235,2);static CLOSE_MODAL=new Yr(202,231,0);static RESUME_P_COUNTDIALOG=new Yr(203,237,4);static TUTORIAL_CLICKSIDE=new Yr(204,175,1);static MOVE_OPCLICK=new Yr(242,93,-1);static BUG_REPORT=new Yr(243,190,10);static MOVE_MINIMAPCLICK=new Yr(244,165,-1);static INV_BUTTOND=new Yr(245,159,6);static IGNORELIST_DEL=new Yr(246,171,8);static IGNORELIST_ADD=new Yr(247,79,8);static IF_PLAYERDESIGN=new Yr(248,52,13);static CHAT_SETMODE=new Yr(249,244,3);static MESSAGE_PRIVATE=new Yr(250,148,-1);static FRIENDLIST_DEL=new Yr(251,11,8);static FRIENDLIST_ADD=new Yr(252,118,8);static CLIENT_CHEAT=new Yr(253,4,-1);static MESSAGE_PUBLIC=new Yr(254,158,-1);static MOVE_GAMECLICK=new Yr(255,181,-1);constructor(t,e,s){this.index=t,this.id=e,this.length=s,Yr.all[t]=this,Yr.byId[e]=this}}class Kr{}class jr{}class Zr{id;limit;static CLIENT_EVENT=new Zr(0,20);static USER_EVENT=new Zr(1,5);constructor(t,e){this.id=t,this.limit=e}}class Jr extends jr{input;category=Zr.USER_EVENT;constructor(t){super(),this.input=t}}class $r extends Kr{prot=Yr.CLIENT_CHEAT;decode(t){const e=t.gjstr();return new Jr(e)}}class Xr extends jr{category=Zr.USER_EVENT}class Qr extends Kr{prot=Yr.CLOSE_MODAL;decode(){return new Xr}}class qr extends jr{category=Zr.CLIENT_EVENT}class to extends Kr{prot=Yr.IDLE_TIMER;decode(){return new qr}}class eo extends jr{component;category=Zr.USER_EVENT;constructor(t){super(),this.component=t}}class so extends Kr{prot=Yr.IF_BUTTON;decode(t){const e=t.g2();return new eo(e)}}class no extends jr{gender;idkit;color;category=Zr.USER_EVENT;constructor(t,e,s){super(),this.gender=t,this.idkit=e,this.color=s}}class io extends Kr{prot=Yr.IF_PLAYERDESIGN;decode(t){const e=t.g1(),s=[];for(let e=0;e<7;e++)s[e]=t.g1(),255===s[e]&&(s[e]=-1);const n=[];for(let e=0;e<5;e++)n[e]=t.g1();return new no(e,s,n)}}class ao extends jr{op;obj;slot;component;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.obj=e,this.slot=s,this.component=n}}class ro extends Kr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new ao(this.op,e,s,n)}}class oo extends jr{component;slot;targetSlot;category=Zr.USER_EVENT;constructor(t,e,s){super(),this.component=t,this.slot=e,this.targetSlot=s}}class co extends Kr{prot=Yr.INV_BUTTOND;decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new oo(e,s,n)}}class lo extends jr{username;input;category=Zr.USER_EVENT;constructor(t,e){super(),this.username=t,this.input=e}}class ho extends Kr{prot=Yr.MESSAGE_PRIVATE;decode(t){const e=t.g8(),s=Wa.unpack(t,t.length-8);return new lo(e,s)}}class po extends jr{input;color;effect;category=Zr.USER_EVENT;constructor(t,e,s){super(),this.input=t,this.color=e,this.effect=s}}class uo extends Kr{prot=Yr.MESSAGE_PUBLIC;decode(t){const e=t.g1(),s=t.g1(),n=Wa.unpack(t,t.length-2);return new po(n,e,s)}}class _o extends jr{op;obj;slot;component;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.obj=e,this.slot=s,this.component=n}}class go extends Kr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new _o(this.op,e,s,n)}}class mo extends jr{obj;slot;component;spellComponent;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.obj=t,this.slot=e,this.component=s,this.spellComponent=n}}class Eo extends Kr{prot=Yr.OPHELDT;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new mo(e,s,n,i)}}class Oo extends jr{obj;slot;component;useObj;useSlot;useComponent;category=Zr.USER_EVENT;constructor(t,e,s,n,i,a){super(),this.obj=t,this.slot=e,this.component=s,this.useObj=n,this.useSlot=i,this.useComponent=a}}class fo extends Kr{prot=Yr.OPHELDU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new Oo(e,s,n,i,a,r)}}class Ao extends jr{op;x;z2;loc;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.x=e,this.z=s,this.loc=n}}class To extends Kr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new Ao(this.op,e,s,n)}}class Io extends jr{x;z2;loc;spellComponent;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.x=t,this.z=e,this.loc=s,this.spellComponent=n}}class No extends Kr{prot=Yr.OPLOCT;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new Io(e,s,n,i)}}class Po extends jr{x;z2;loc;useObj;useSlot;useComponent;category=Zr.USER_EVENT;constructor(t,e,s,n,i,a){super(),this.x=t,this.z=e,this.loc=s,this.useObj=n,this.useSlot=i,this.useComponent=a}}class Lo extends Kr{prot=Yr.OPLOCU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new Po(e,s,n,i,a,r)}}class So extends jr{op;nid;category=Zr.USER_EVENT;constructor(t,e){super(),this.op=t,this.nid=e}}class Co extends Kr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2();return new So(this.op,e)}}class yo extends jr{nid;spellComponent;category=Zr.USER_EVENT;constructor(t,e){super(),this.nid=t,this.spellComponent=e}}class vo extends Kr{prot=Yr.OPNPCT;decode(t){const e=t.g2(),s=t.g2();return new yo(e,s)}}class wo extends jr{nid;useObj;useSlot;useComponent;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.nid=t,this.useObj=e,this.useSlot=s,this.useComponent=n}}class Ro extends Kr{prot=Yr.OPNPCU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new wo(e,s,n,i)}}class bo extends jr{op;x;z2;obj;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.op=t,this.x=e,this.z=s,this.obj=n}}class Uo extends Kr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2(),s=t.g2(),n=t.g2();return new bo(this.op,e,s,n)}}class Do extends jr{x;z2;obj;spellComponent;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.x=t,this.z=e,this.obj=s,this.spellComponent=n}}class Mo extends Kr{prot=Yr.OPOBJT;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new Do(e,s,n,i)}}class ko extends jr{x;z2;obj;useObj;useSlot;useComponent;category=Zr.USER_EVENT;constructor(t,e,s,n,i,a){super(),this.x=t,this.z=e,this.obj=s,this.useObj=n,this.useSlot=i,this.useComponent=a}}class xo extends Kr{prot=Yr.OPOBJU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2(),a=t.g2(),r=t.g2();return new ko(e,s,n,i,a,r)}}class Bo extends jr{op;pid;category=Zr.USER_EVENT;constructor(t,e){super(),this.op=t,this.pid=e}}class Ho extends Kr{prot;op;constructor(t,e){super(),this.prot=t,this.op=e}decode(t){const e=t.g2();return new Bo(this.op,e)}}class Fo extends jr{pid;spellComponent;category=Zr.USER_EVENT;constructor(t,e){super(),this.pid=t,this.spellComponent=e}}class Go extends Kr{prot=Yr.OPPLAYERT;decode(t){const e=t.g2(),s=t.g2();return new Fo(e,s)}}class Wo extends jr{pid;useObj;useSlot;useComponent;category=Zr.USER_EVENT;constructor(t,e,s,n){super(),this.pid=t,this.useObj=e,this.useSlot=s,this.useComponent=n}}class zo extends Kr{prot=Yr.OPPLAYERU;decode(t){const e=t.g2(),s=t.g2(),n=t.g2(),i=t.g2();return new Wo(e,s,n,i)}}class Vo extends jr{maps;category=Zr.USER_EVENT;constructor(t){super(),this.maps=t}}class Yo extends Kr{prot=Yr.REBUILD_GETMAPS;decode(t){const e=[],s=t.length/3;for(let n=0;n<s;n++){const s=t.g1(),n=t.g1(),i=t.g1();e.push({type:s,x:n,z:i})}return new Vo(e)}}class Ko extends jr{category=Zr.USER_EVENT}class jo extends Kr{prot=Yr.RESUME_PAUSEBUTTON;decode(){return new Ko}}class Zo extends jr{input;category=Zr.USER_EVENT;constructor(t){super(),this.input=t}}class Jo extends Kr{prot=Yr.RESUME_P_COUNTDIALOG;decode(t){const e=t.g4();return new Zo(e)}}class $o extends jr{tab;category=Zr.USER_EVENT;constructor(t){super(),this.tab=t}}class Xo extends Kr{prot=Yr.TUTORIAL_CLICKSIDE;decode(t){const e=t.g1();return new $o(e)}}class Qo{}class qo extends Qo{handle(t,e){const{op:s,obj:n,slot:i,component:a}=t,r=Z.get(a);if(void 0===r||!r.inventoryOptions||!r.inventoryOptions.length||!e.isComponentVisible(r))return!1;if(!r.inventoryOptions[s-1])return!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,n))return!1;if(e.delayed())return!1;let l;e.lastItem=n,e.lastSlot=i,l=1===s?In.INV_BUTTON1:2===s?In.INV_BUTTON2:3===s?In.INV_BUTTON3:4===s?In.INV_BUTTON4:In.INV_BUTTON5;const h=Qt.getByTrigger(l,a,-1);if(h){const t=Z.get(r.rootLayer);e.executeScript(Vc.init(h,e),0==t.overlay)}else _t.NODE_DEBUG&&e.messageGame(`No trigger for [${In.toString(l)},${r.comName}]`);return!0}}class tc{state=-1;remoteAddress;totalBytesRead=0;totalBytesWritten=0;uniqueId='0';encryptor=null;decryptor=null;in=new Uint8Array(5e3);inOffset=0;inCount=new Uint8Array(256);out=new f(new Uint8Array(5e3));player=null;constructor(t="127.0.0.1",e=-1){this.remoteAddress=t,this.state=e}send(t){this.totalBytesWritten+=t.length,self.postMessage(t)}close(){setTimeout((()=>{self.close()}),100)}terminate(){self.close()}reset(){this.inOffset=0,this.inCount.fill(0)}writeImmediate(t){this.send(t)}flush(){const t=this.out;0!==t.pos&&(this.send(t.data.subarray(0,t.pos)),t.pos=0)}}class ec extends tc{constructor(){super(null,'')}isTCP(){return this.type===tc.TCP}isWebSocket(){return this.type===tc.WEBSOCKET}send(t){this.socket}close(){this.socket}terminate(){this.socket}reset(){this.inOffset=0,this.inCount.fill(0)}}function sc(t,e){if('number'==typeof t)return t;if('string'!=typeof t&&'number'!=typeof t)return e;const s=parseInt(t);return isNaN(s)?e:s}class nc extends Qo{handle(t,e){if(t.input.length>80)return!1;const{input:s}=t,n=s.toLowerCase().split(' '),i=n.shift();if(void 0===i||i.length<=0)return!1;if(e.playerLog('Cheat ran',s),e.staffModLevel>=3)if('reload'!==i||_t.NODE_PRODUCTION)if('rebuild'!==i||_t.NODE_PRODUCTION){if('serverdrop'===i)e.terminate();else if('bench'===i){const t=Date.now();for(let t=0;t<1e5;t++)le(e.level,e.x,e.z,e.x,e.z+10);const s=Date.now();console.log(`took = ${s-t} ms`)}else if('bots'===i){e.messageGame('Adding bots');for(let t=0;t<2e3;t++){const e=new Mc(`bot${t}`,p(`bot${t}`),new ec);e.onLogin(),rl.addPlayer(e)}}else if('teleall'===i){e.messageGame('Teleporting all players');for(const t of rl.players){t.closeModal();do{const e=Math.floor(64*Math.random())+3200,s=Math.floor(64*Math.random())+3200;t.teleport(e+Math.floor(64*Math.random())-32,s+Math.floor(64*Math.random())-32,0)}while(Ae(t.x,t.z,t.level,Fe.WALK_BLOCKED))}}else if('moveall'===i){e.messageGame('Moving all players'),console.time('moveall');for(const t of rl.players)t.closeModal(),t.queueWaypoints(le(t.level,t.x,t.z,32+(t.x>>>6<<6),32+(t.z>>>6<<6)));console.timeEnd('moveall')}else if('speed'===i){if(n.length<1)return e.messageGame('Usage: ::speed <ms>'),!1;const t=sc(n.shift(),20);if(t<20)return e.messageGame('::speed input was too low.'),!1;e.messageGame(`World speed was changed to ${t}ms`),rl.tickRate=t}else if('fly'===i)e.moveStrategy===Hn.FLY?e.moveStrategy=Hn.SMART:e.moveStrategy=Hn.FLY,e.messageGame(`Fly is on? ${e.moveStrategy===Hn.FLY}`);else if('naive'===i)e.moveStrategy===Hn.NAIVE?e.moveStrategy=Hn.SMART:e.moveStrategy=Hn.NAIVE,e.messageGame(`Naive is on? ${e.moveStrategy===Hn.NAIVE}`);else if('teleto'===i){if(n.length<1)return!1;const t=rl.getPlayerByUsername(n[0]);if(!t)return e.messageGame(`${n[0]} is not logged in.`),!1;e.teleJump(t.x,t.z,t.level)}else if('teleother'===i){if(n.length<1)return!1;const t=rl.getPlayerByUsername(n[0]);if(!t)return e.messageGame(`${n[0]} is not logged in.`),!1;t.teleJump(e.x,e.z,e.level)}else if('setvarother'===i){if(n.length<3)return!1;const t=rl.getPlayerByUsername(n[0]);if(!t)return e.messageGame(`${n[0]} is not logged in.`),!1;const s=At.getId(n[1]),i=Math.max(-2147483648,Math.min(sc(n[2],0),2147483647));if(-1===s)return!1;t.setVar(s,i),e.messageGame('set '+n[1]+': to '+i+' on '+t.username)}}else rl.devThread.postMessage({type:'pack'});else{rl.reload();const t=Qt.load('data/pack');e.messageGame(`Reloaded ${t} scripts.`)}if(_t.NODE_ALLOW_CHEATS||e.staffModLevel>=2)if('tele'===i){if(n.length<1)return!1;if('up'===n[0])e.teleJump(e.x,e.z,e.level+1),e.messageGame('::tele '+ts.formatString(e.level,e.x,e.z,','));else if('down'===n[0])e.teleJump(e.x,e.z,e.level-1),e.messageGame('::tele '+ts.formatString(e.level,e.x,e.z,','));else if(-1===n[0].indexOf(','))e.teleJump(sc(n[0],3200),sc(n[1],3200),sc(n[2],e.level));else{const t=n[0].split(',');if(5!==t.length)return!1;const s=sc(t[0],0),i=sc(t[1],50),a=sc(t[2],50),r=sc(t[3],0),o=sc(t[4],0);if(s<0||s>3||i<0||i>255||a<0||a>255||r<0||r>63||o<0||o>63)return!1;e.teleJump((i<<6)+r,(a<<6)+o,s)}}else if('setvar'===i){if(n.length<2)return!1;const t=At.getId(n[0]),s=Math.max(-2147483648,Math.min(sc(n[1],0),2147483647));if(-1===t)return!1;e.setVar(t,s),e.messageGame('set '+n[0]+': to '+s)}else if('random'===i)e.afkEventReady=!0;else if('minme'===i)for(let t=0;t<Vr.SKILLS.length;t++)t===is.HITPOINTS?e.setLevel(t,10):e.setLevel(t,1);else if('setxp'===i){if(n.length<2)return e.messageGame('Usage: ::setxp <stat> <xp>'),!1;const t=Vr.SKILLS.indexOf(n[0]);if(-1===t)return e.messageGame(`Unknown stat ${n[0]}`),!1;const s=10*parseInt(n[1]);e.stats[t]=s}else if('setstat'===i){if(n.length<2)return!1;const t=Vr.SKILLS.indexOf(n[0]);if(-1===t)return!1;e.setLevel(t,parseInt(n[1]))}else if('advancestat'===i){if(n.length<1)return!1;const t=Vr.SKILLS.indexOf(n[0]),s=Math.min(99,Math.max(1,sc(n[1],1)));if(-1===t)return!1;e.setLevel(t,e.baseLevels[t]+s)}else if('getvar'===i){if(n.length<1)return!1;const t=At.getId(n[0]);if(-1===t)return!1;const s=e.getVar(t);e.messageGame('get '+n[0]+': '+s)}else if('give'===i){if(n.length<1)return!1;const t=gt.getId(n[0]),s=Math.max(1,Math.min(sc(n[1],1),2147483647));if(-1===t)return!1;e.invAdd(J.INV,t,s,!1)}if((_t.NODE_ALLOW_CHEATS||e.staffModLevel>=1)&&'getcoord'===i&&e.messageGame(ts.formatString(e.level,e.x,e.z,'_')),_t.NODE_ALLOW_CHEATS||e.staffModLevel>=2){const t=Qt.getByName(`[debugproc,${i}]`);if(!t)return!1;const a=new Array(t.info.parameterTypes.length).fill(-1);for(let e=0;e<t.info.parameterTypes.length;e++){const i=t.info.parameterTypes[e];try{switch(i){case I.STRING:{const t=n.shift();a[e]=t??'';break}case I.INT:{const t=n.shift();a[e]=0|parseInt(t??'0',10);break}case I.OBJ:case I.NAMEDOBJ:{const t=n.shift();a[e]=gt.getId(t??'');break}case I.NPC:{const t=n.shift();a[e]=ht.getId(t??'');break}case I.LOC:{const t=n.shift();a[e]=et.getId(t??'');break}case I.SEQ:{const t=n.shift();a[e]=Et.getId(t??'');break}case I.STAT:{const t=n.shift();a[e]=Vr.SKILLS.indexOf(t??'');break}case I.INV:{const t=n.shift();a[e]=J.getId(t??'');break}case I.COORD:{const t=s.split('_'),n=parseInt(t[0].slice(6)),i=parseInt(t[1]),r=parseInt(t[2]),o=parseInt(t[3]),c=parseInt(t[4]);a[e]=ts.packCoord(n,(i<<6)+o,(r<<6)+c);break}case I.INTERFACE:{const t=n.shift();a[e]=Z.getId(t??'');break}case I.SPOTANIM:{const t=n.shift();a[e]=Ct.getId(t??'');break}case I.IDKIT:{const t=n.shift();a[e]=j.getId(t??'');break}}}catch(t){return!1}}e.executeScript(Vc.init(t,e,null,a),!1)}return!0}}class ic extends Qo{handle(t,e){return e.closeModal(),!0}}class ac extends Qo{handle(t,e){return _t.NODE_PRODUCTION&&(e.logout(),e.logoutRequested=!0),!0}}class rc extends Qo{handle(t,e){const{component:s}=t,n=Z.get(s);if(void 0===n||!e.isComponentVisible(n))return!1;if(e.lastCom=s,-1!==e.resumeButtons.indexOf(e.lastCom))e.activeScript&&e.executeScript(e.activeScript,!0);else{const t=Z.get(n.rootLayer),i=Qt.getByTriggerSpecific(In.IF_BUTTON,s,-1);i?e.executeScript(Vc.init(i,e),0==t.overlay):_t.NODE_DEBUG&&e.messageGame(`No trigger for [if_button,${n.comName}]`)}return!0}}class oc extends Qo{handle(t,e){const{gender:s,idkit:n,color:i}=t;if(!e.allowDesign)return!1;if(s>1)return!1;let a=!0;for(let t=0;t<7;t++){let e=t;if(1===s&&(e+=7),8==e&&-1===n[t])continue;const i=j.get(n[t]);if(!i||i.disable||i.type!=e){a=!1;break}}if(!a)return!1;for(let t=0;t<5;t++)if(i[t]>=Vr.DESIGN_BODY_COLORS[t].length){a=!1;break}return!!a&&(e.gender=s,e.body=n,e.colors=i,e.generateAppearance(J.WORN),!0)}}class cc extends Qo{handle(t,e){const{component:s,slot:n,targetSlot:i}=t,a=Z.get(s);if(void 0===a||!e.isComponentVisible(a))return!1;const r=e.invListeners.find((t=>t.com===s));if(!r)return!1;const o=e.getInventoryFromListener(r);if(!(o&&o.validSlot(n)&&o.get(n)&&o.validSlot(i)))return!1;if(e.delayed())return e.write(new gr(s,o,n,i)),!1;e.lastSlot=n,e.lastTargetSlot=i;const c=Qt.getByTrigger(In.INV_BUTTOND,s);if(c){const t=Z.get(a.rootLayer);e.executeScript(Vc.init(c,e),0==t.overlay)}else _t.NODE_DEBUG&&e.messageGame(`No trigger for [inv_buttond,${a.comName}]`);return!0}}class lc extends Qo{handle(t,e){return!0}}class hc extends Qo{handle(t,e){const{color:s,effect:n,input:i}=t;if(s<0||s>11||n<0||n>2||i.length>100)return!1;e.messageColor=s,e.messageEffect=n,e.messageType=0;const a=f.alloc(0);return Wa.pack(a,St.filter(i)),e.message=new Uint8Array(a.pos),a.pos=0,a.gdata(e.message,0,e.message.length),a.release(),e.mask|=Vr.CHAT,!0}}class dc extends Qo{handle(t,e){const{obj:s,slot:n,component:i}=t,a=Z.get(i);if(void 0===a||!e.isComponentVisible(a))return!1;const r=gt.get(s);if(5!==t.op&&(r.iop&&!r.iop[t.op-1]||!r.iop))return!1;const o=e.invListeners.find((t=>t.com===i));if(!o)return!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(n)||!c.hasAt(n,s))return!1;if(e.delayed())return!1;let l;e.lastItem=s,e.lastSlot=n,e.clearInteraction(),e.closeModal(),l=1===t.op?In.OPHELD1:2===t.op?In.OPHELD2:3===t.op?In.OPHELD3:4===t.op?In.OPHELD4:In.OPHELD5;const h=Qt.getByTrigger(l,r.id,r.category);return h?e.executeScript(Vc.init(h,e),!0):_t.NODE_DEBUG&&e.messageGame(`No trigger for [${In.toString(l)},${r.debugname}]`),!0}}class pc extends Qo{handle(t,e){const{obj:s,slot:n,component:i,spellComponent:a}=t,r=Z.get(i);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=Z.get(i);if(void 0===o||!e.isComponentVisible(o))return e.unsetMapFlag(),!1;const c=e.invListeners.find((t=>t.com===i));if(!c)return e.unsetMapFlag(),!1;const l=e.getInventoryFromListener(c);if(!l||!l.validSlot(n)||!l.hasAt(n,s))return e.unsetMapFlag(),!1;if(e.delayed())return e.unsetMapFlag(),!1;e.lastItem=s,e.lastSlot=n,e.clearInteraction(),e.closeModal();const h=Qt.getByTrigger(In.OPHELDT,a,-1);return h?e.executeScript(Vc.init(h,e),!0):(_t.NODE_DEBUG&&e.messageGame(`No trigger for [opheldt,${o.comName}]`),e.messageGame('Nothing interesting happens.')),!0}}class uc extends Qo{handle(t,e){const{obj:s,slot:n,component:i,useObj:a,useSlot:r,useComponent:o}=t,c=Z.get(i);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=Z.get(i);if(void 0===l||!e.isComponentVisible(l))return e.unsetMapFlag(),!1;{const t=e.invListeners.find((t=>t.com===i));if(!t)return e.unsetMapFlag(),!1;const a=e.getInventoryFromListener(t);if(!a||!a.validSlot(n)||!a.hasAt(n,s))return e.unsetMapFlag(),!1}{const t=e.invListeners.find((t=>t.com===o));if(!t)return e.unsetMapFlag(),!1;const s=e.getInventoryFromListener(t);if(!s||!s.validSlot(r)||!s.hasAt(r,a))return e.unsetMapFlag(),!1}if(e.delayed())return e.unsetMapFlag(),!1;e.lastItem=s,e.lastSlot=n,e.lastUseItem=a,e.lastUseSlot=r;const h=gt.get(e.lastItem),d=gt.get(e.lastUseItem);if((h.members||d.members)&&!_t.NODE_MEMBERS)return e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1;let p=Qt.getByTriggerSpecific(In.OPHELDU,h.id,-1);p||(p=Qt.getByTriggerSpecific(In.OPHELDU,d.id,-1),[e.lastItem,e.lastUseItem]=[e.lastUseItem,e.lastItem],[e.lastSlot,e.lastUseSlot]=[e.lastUseSlot,e.lastSlot]);const u=-1!==h.category?T.get(h.category):null;!p&&u&&(p=Qt.getByTriggerSpecific(In.OPHELDU,-1,u.id));const _=-1!==d.category?T.get(d.category):null;return!p&&_&&(p=Qt.getByTriggerSpecific(In.OPHELDU,-1,_.id),[e.lastItem,e.lastUseItem]=[e.lastUseItem,e.lastItem],[e.lastSlot,e.lastUseSlot]=[e.lastUseSlot,e.lastSlot]),e.clearInteraction(),e.closeModal(),p?e.executeScript(Vc.init(p,e),!0):(_t.NODE_DEBUG&&e.messageGame(`No trigger for [opheldu,${h.debugname}]`),e.messageGame('Nothing interesting happens.')),!0}}class _c extends Qo{handle(t,e){const{x:s,z:n,loc:i}=t;if(e.delayed())return e.unsetMapFlag(),!1;const a=e.originX-52,r=e.originX+52,o=e.originZ+52,c=e.originZ-52;if(s<a||s>r||n<c||n>o)return!1;const l=rl.getLoc(s,n,e.level,i);if(!l)return e.unsetMapFlag(),!1;const h=et.get(l.type);if(!h.op||!h.op[t.op-1])return e.unsetMapFlag(),!1;let d;return d=1===t.op?In.APLOC1:2===t.op?In.APLOC2:3===t.op?In.APLOC3:4===t.op?In.APLOC4:In.APLOC5,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,l,d),e.opcalled=!0,!0}}class gc extends Qo{handle(t,e){const{x:s,z:n,loc:i,spellComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.originX-52,c=e.originX+52,l=e.originZ+52,h=e.originZ-52;if(s<o||s>c||n<h||n>l)return e.unsetMapFlag(),!1;const d=rl.getLoc(s,n,e.level,i);return d?(e.clearPendingAction(),e.setInteraction(Nn.ENGINE,d,In.APLOCT,{type:d.type,com:a}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class mc extends Qo{handle(t,e){const{x:s,z:n,loc:i,useObj:a,useSlot:r,useComponent:o}=t;if(e.delayed())return e.unsetMapFlag(),!1;const c=Z.get(o);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=e.originX-52,h=e.originX+52,d=e.originZ+52,p=e.originZ-52;if(s<l||s>h||n<p||n>d)return e.unsetMapFlag(),!1;const u=e.invListeners.find((t=>t.com===o));if(!u)return e.unsetMapFlag(),!1;const _=e.getInventoryFromListener(u);if(!_||!_.validSlot(r)||!_.hasAt(r,a))return e.unsetMapFlag(),!1;const g=rl.getLoc(s,n,e.level,i);return g?gt.get(a).members&&!_t.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=a,e.lastUseSlot=r,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,g,In.APLOCU),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Ec extends Qo{handle(t,e){const{nid:s}=t;if(e.delayed())return e.unsetMapFlag(),!1;const n=rl.getNpc(s);if(!n||n.delayed())return e.unsetMapFlag(),!1;if(!e.buildArea.npcs.has(n.nid))return e.unsetMapFlag(),!1;const i=ht.get(n.type);if(!i.op||!i.op[t.op-1])return e.unsetMapFlag(),!1;let a;return a=1===t.op?In.APNPC1:2===t.op?In.APNPC2:3===t.op?In.APNPC3:4===t.op?In.APNPC4:In.APNPC5,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,n,a,{type:n.type,com:-1}),e.opcalled=!0,!0}}class Oc extends Qo{handle(t,e){const{nid:s,spellComponent:n}=t;if(e.delayed())return e.unsetMapFlag(),!1;const i=Z.get(n);if(void 0===i||!e.isComponentVisible(i))return e.unsetMapFlag(),!1;const a=rl.getNpc(s);return!a||a.delayed()?(e.unsetMapFlag(),!1):e.buildArea.npcs.has(a.nid)?(e.clearPendingAction(),e.setInteraction(Nn.ENGINE,a,In.APNPCT,{type:a.type,com:n}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class fc extends Qo{handle(t,e){const{nid:s,useObj:n,useSlot:i,useComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return e.unsetMapFlag(),!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,n))return e.unsetMapFlag(),!1;const l=rl.getNpc(s);return!l||l.delayed()?(e.unsetMapFlag(),!1):e.buildArea.npcs.has(l.nid)?gt.get(n).members&&!_t.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=n,e.lastUseSlot=i,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,l,In.APNPCU,{type:l.type,com:-1}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Ac extends Qo{handle(t,e){const{x:s,z:n,obj:i}=t;if(e.delayed())return e.unsetMapFlag(),!1;const a=e.originX-52,r=e.originX+52,o=e.originZ+52,c=e.originZ-52;if(s<a||s>r||n<c||n>o)return e.unsetMapFlag(),!1;const l=rl.getObj(s,n,e.level,i,e.pid);if(!l)return e.unsetMapFlag(),!1;const h=gt.get(l.type);if(1===t.op&&(h.op&&!h.op[0]||!h.op)||4===t.op&&(h.op&&!h.op[3]||!h.op))return e.unsetMapFlag(),!1;let d;return d=1===t.op?In.APOBJ1:2===t.op?In.APOBJ2:3===t.op?In.APOBJ3:4===t.op?In.APOBJ4:In.APOBJ5,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,l,d),e.opcalled=!0,!0}}class Tc extends Qo{handle(t,e){const{x:s,z:n,obj:i,spellComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.originX-52,c=e.originX+52,l=e.originZ+52,h=e.originZ-52;if(s<o||s>c||n<h||n>l)return e.unsetMapFlag(),!1;const d=rl.getObj(s,n,e.level,i,e.pid);return d?(e.clearPendingAction(),e.setInteraction(Nn.ENGINE,d,In.APOBJT,{type:d.type,com:a}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Ic extends Qo{handle(t,e){const{x:s,z:n,obj:i,useObj:a,useSlot:r,useComponent:o}=t;if(e.delayed())return e.unsetMapFlag(),!1;const c=Z.get(o);if(void 0===c||!e.isComponentVisible(c))return e.unsetMapFlag(),!1;const l=e.originX-52,h=e.originX+52,d=e.originZ+52,p=e.originZ-52;if(s<l||s>h||n<p||n>d)return e.unsetMapFlag(),!1;const u=e.invListeners.find((t=>t.com===o));if(!u)return e.unsetMapFlag(),!1;const _=e.getInventoryFromListener(u);if(!_||!_.validSlot(r)||!_.hasAt(r,a))return e.unsetMapFlag(),!1;const g=rl.getObj(s,n,e.level,i,e.pid);return g?gt.get(a).members&&!_t.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseItem=a,e.lastUseSlot=r,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,g,In.APOBJU),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Nc extends Qo{handle(t,e){const{pid:s}=t;if(e.delayed())return e.unsetMapFlag(),!1;const n=rl.getPlayer(s);if(!n)return e.unsetMapFlag(),!1;if(!e.buildArea.players.has(n.uid))return e.unsetMapFlag(),!1;let i;return i=1===t.op?In.APPLAYER1:2===t.op?In.APPLAYER2:3===t.op?In.APPLAYER3:In.APPLAYER4,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,n,i),e.opcalled=!0,!0}}class Pc extends Qo{handle(t,e){const{pid:s,spellComponent:n}=t;if(e.delayed())return e.unsetMapFlag(),!1;const i=Z.get(n);if(void 0===i||!e.isComponentVisible(i))return e.unsetMapFlag(),!1;const a=rl.getPlayer(s);return a&&e.buildArea.players.has(a.uid)?(e.clearPendingAction(),e.setInteraction(Nn.ENGINE,a,In.APPLAYERT,{type:-1,com:n}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Lc extends Qo{handle(t,e){const{pid:s,useObj:n,useSlot:i,useComponent:a}=t;if(e.delayed())return e.unsetMapFlag(),!1;const r=Z.get(a);if(void 0===r||!e.isComponentVisible(r))return e.unsetMapFlag(),!1;const o=e.invListeners.find((t=>t.com===a));if(!o)return e.unsetMapFlag(),!1;const c=e.getInventoryFromListener(o);if(!c||!c.validSlot(i)||!c.hasAt(i,n))return e.unsetMapFlag(),!1;const l=rl.getPlayer(s);return l&&e.buildArea.players.has(l.uid)?gt.get(n).members&&!_t.NODE_MEMBERS?(e.messageGame("To use this item please login to a members' server."),e.unsetMapFlag(),!1):(e.lastUseSlot=i,e.clearPendingAction(),e.setInteraction(Nn.ENGINE,l,In.APPLAYERU,{type:n,com:-1}),e.opcalled=!0,!0):(e.unsetMapFlag(),!1)}}class Sc extends Qo{handle(t,e){const{maps:s}=t;for(let t=0;t<s.length;t++){const{type:n,x:i,z:a}=s[t],r=991;if(0==n){const t=Vn.get(`m${i}_${a}`);if(!t)continue;for(let s=0;s<t.length;s+=r)e.write(new Ri(i,a,s,t.length,t.subarray(s,s+r)));e.write(new Ui(i,a))}else if(1==n){const t=Vn.get(`l${i}_${a}`);if(!t)continue;for(let s=0;s<t.length;s+=r)e.write(new Mi(i,a,s,t.length,t.subarray(s,s+r)));e.write(new xi(i,a))}}return!0}}class Cc extends Qo{handle(t,e){return!(!e.activeScript||e.activeScript.execution!==se.PAUSEBUTTON)&&(e.executeScript(e.activeScript,!0),!0)}}class yc extends Qo{handle(t,e){const{input:s}=t;return!(!e.activeScript||e.activeScript.execution!==se.COUNTDIALOG)&&(e.activeScript.lastInt=s,e.executeScript(e.activeScript,!0),!0)}}class vc extends Qo{handle(t,e){const{tab:s}=t;if(s<0||s>13)return!1;const n=Qt.getByTriggerSpecific(In.TUTORIAL_CLICKSIDE,-1,-1);return n&&e.executeScript(Vc.init(n,e),!0),!0}}class wc extends jr{path;ctrlHeld;opClick;category=Zr.USER_EVENT;constructor(t,e,s){super(),this.path=t,this.ctrlHeld=e,this.opClick=s}}class Rc extends Kr{prot;constructor(t){super(),this.prot=t}decode(t){const e=t.g1(),s=t.g2(),n=t.g2(),i=this.prot===Yr.MOVE_MINIMAPCLICK?14:0,a=t.available-i>>1,r=[{x:s,z:n}];for(let e=1;e<=a&&e<25;e++)r.push({x:s+t.g1b(),z:n+t.g1b()});return new wc(r,e,this.prot===Yr.MOVE_OPCLICK)}}class bc extends Qo{handle(t,e){const s=t.path[0];if(e.delayed()||t.ctrlHeld<0||t.ctrlHeld>1||ts.distanceToSW(e,{x:s.x,z:s.z})>104)return e.unsetMapFlag(),e.userPath=[],!1;if(_t.NODE_CLIENT_ROUTEFINDER){e.userPath=[];for(let s=0;s<t.path.length;s++)e.userPath[s]=ts.packCoord(e.level,t.path[s].x,t.path[s].z)}else{const s=t.path[t.path.length-1];e.userPath=[ts.packCoord(e.level,s.x,s.z)]}return e.interactWalkTrigger=!1,t.opClick||(e.clearInteraction(),e.closeModal()),e.runenergy<100?e.setVar(At.TEMP_RUN,0):e.setVar(At.TEMP_RUN,t.ctrlHeld),!0}}var Uc=new class{decoders=new Map;handlers=new Map;bind(t,e){if(this.decoders.has(t.prot.id))throw new Error(`[ClientProtRepository] Already defines a ${t.prot.id}.`);this.decoders.set(t.prot.id,t),e&&this.handlers.set(t.prot.id,e)}constructor(){this.bind(new $r,new nc),this.bind(new Qr,new ic),this.bind(new to,new ac),this.bind(new so,new rc),this.bind(new io,new oc),this.bind(new ro(Yr.INV_BUTTON1,1),new qo),this.bind(new ro(Yr.INV_BUTTON2,2),new qo),this.bind(new ro(Yr.INV_BUTTON3,3),new qo),this.bind(new ro(Yr.INV_BUTTON4,4),new qo),this.bind(new ro(Yr.INV_BUTTON5,5),new qo),this.bind(new co,new cc),this.bind(new ho,new lc),this.bind(new uo,new hc),this.bind(new Rc(Yr.MOVE_GAMECLICK),new bc),this.bind(new Rc(Yr.MOVE_OPCLICK),new bc),this.bind(new Rc(Yr.MOVE_MINIMAPCLICK),new bc),this.bind(new go(Yr.OPHELD1,1),new dc),this.bind(new go(Yr.OPHELD2,2),new dc),this.bind(new go(Yr.OPHELD3,3),new dc),this.bind(new go(Yr.OPHELD4,4),new dc),this.bind(new go(Yr.OPHELD5,5),new dc),this.bind(new Eo,new pc),this.bind(new fo,new uc),this.bind(new To(Yr.OPLOC1,1),new _c),this.bind(new To(Yr.OPLOC2,2),new _c),this.bind(new To(Yr.OPLOC3,3),new _c),this.bind(new To(Yr.OPLOC4,4),new _c),this.bind(new To(Yr.OPLOC5,5),new _c),this.bind(new No,new gc),this.bind(new Lo,new mc),this.bind(new Co(Yr.OPNPC1,1),new Ec),this.bind(new Co(Yr.OPNPC2,2),new Ec),this.bind(new Co(Yr.OPNPC3,3),new Ec),this.bind(new Co(Yr.OPNPC4,4),new Ec),this.bind(new Co(Yr.OPNPC5,5),new Ec),this.bind(new vo,new Oc),this.bind(new Ro,new fc),this.bind(new Uo(Yr.OPOBJ1,1),new Ac),this.bind(new Uo(Yr.OPOBJ2,2),new Ac),this.bind(new Uo(Yr.OPOBJ3,3),new Ac),this.bind(new Uo(Yr.OPOBJ4,4),new Ac),this.bind(new Uo(Yr.OPOBJ5,5),new Ac),this.bind(new Mo,new Tc),this.bind(new xo,new Ic),this.bind(new Ho(Yr.OPPLAYER1,1),new Nc),this.bind(new Ho(Yr.OPPLAYER2,2),new Nc),this.bind(new Ho(Yr.OPPLAYER3,3),new Nc),this.bind(new Ho(Yr.OPPLAYER4,4),new Nc),this.bind(new Go,new Pc),this.bind(new zo,new Lc),this.bind(new Yo,new Sc),this.bind(new jo,new Cc),this.bind(new Jo,new yc),this.bind(new Xo,new vc)}getDecoder(t){return this.decoders.get(t.id)}getHandler(t){return this.handlers.get(t.id)}};function Dc(t){return null!==t.client&&void 0!==t.client}class Mc extends Vr{client=null;userPath=[];opcalled=!1;constructor(t,e,s){super(t,e),this.client=s,this.client.player=this}decodeIn(){if(null===this.client||this.client.inOffset<1)return;let t=0;for(this.lastResponse=rl.currentTick,this.userPath=[],this.opcalled=!1,rl.cycleStats[Qs.BANDWIDTH_IN]+=this.client.inOffset;this.client.inOffset>t;){const e=Yr.byId[this.client.in[t++]];let s=e.length;-1==s?s=this.client.in[t++]:-2==s&&(s=this.client.in[t++]<<8|this.client.in[t++]);const n=new f(this.client.in.slice(t,t+s));t+=s;const i=Uc.getDecoder(e);if(i){const t=i.decode(n),s=Uc.getHandler(e);s&&s.handle(t,this)}}this.client?.reset()}encodeOut(){if(this.client){(this.modalTop!==this.lastModalTop||this.modalBottom!==this.lastModalBottom||this.modalSidebar!==this.lastModalSidebar||this.refreshModalClose)&&(this.refreshModalClose&&this.write(new Zn),this.refreshModalClose=!1,this.lastModalTop=this.modalTop,this.lastModalBottom=this.modalBottom,this.lastModalSidebar=this.modalSidebar),this.refreshModal&&(1&~this.modalState||4&~this.modalState?1&~this.modalState?2&~this.modalState?4&~this.modalState||this.write(new aa(this.modalSidebar)):this.write(new Si(this.modalBottom)):this.write(new ea(this.modalTop)):this.write(new na(this.modalTop,this.modalSidebar)),this.refreshModal=!1);for(let t=this.highPriorityOut.head();t;t=this.highPriorityOut.next())this.writeInner(t),t.uncache();for(let t=this.lowPriorityOut.head();t;t=this.lowPriorityOut.next())this.writeInner(t),t.uncache();this.client.flush()}}writeInner(t){const e=this.client;if(!e)return;const s=br.getEncoder(t);if(!s)return;const n=s.prot,i=e.out,a=1+(-1===n.length?1:-2===n.length?2:0)+s.test(t);i.pos+a>=i.length&&e.flush();const r=i.pos;i.p1(n.id),-1===n.length?i.pos+=1:-2===n.length&&(i.pos+=2);const o=i.pos;s.encode(i,t),-1===n.length?i.psize1(i.pos-o):-2===n.length&&i.psize2(i.pos-o),e.encryptor&&(i.data[r]=i.data[r]+e.encryptor.nextInt()&255),rl.cycleStats[Qs.BANDWIDTH_OUT]+=i.pos-r}logout(){this.writeInner(new xa),this.client?.flush()}terminate(){this.client?.terminate(),this.client=null}playerLog(t,...e){}updateMap(){const t=this.buildArea.loadedZones,e=this.buildArea.activeZones,s=ts.zone(this.originX)-4<<3,n=ts.zone(this.originX)+5<<3,i=ts.zone(this.originZ)+5<<3,a=ts.zone(this.originZ)-4<<3;(this.x<s||this.z<a||this.x>n-1||this.z>i-1||this.tele&&(ts.zone(this.x)!==ts.zone(this.originX)||ts.zone(this.z)!==ts.zone(this.originZ)))&&(this.write(new vi(ts.zone(this.x),ts.zone(this.z))),this.originX=this.x,this.originZ=this.z,t.clear());for(let t=this.cameraPackets.head();null!==t;t=this.cameraPackets.next()){const e=t.camX-ts.zoneOrigin(this.originX),s=t.camZ-ts.zoneOrigin(this.originZ);t.type===Mn.CAM_MOVETO?this.write(new Gi(e,s,t.height,t.rotationSpeed,t.rotationMultiplier)):t.type===Mn.CAM_LOOKAT&&this.write(new Hi(e,s,t.height,t.rotationSpeed,t.rotationMultiplier)),t.unlink()}this.moveSpeed===Bn.INSTANT&&this.jump&&t.clear(),e.clear();const r=ts.zone(this.x),o=ts.zone(this.z),c=ts.zone(this.originX)-6,l=ts.zone(this.originX)+6,h=ts.zone(this.originZ)+6,d=ts.zone(this.originZ)-6;for(let t=r-3;t<=r+3;t++)for(let s=o-3;s<=o+3;s++)t<c||t>l||s>h||s<d||e.add(Br.zoneIndex(t<<3,s<<3,this.level))}updatePlayers(){this.write(new Ci(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ,this.uid,this.mask,this.tele,this.jump,this.walkDir,this.runDir))}updateNpcs(){this.write(new wr(this.buildArea,this.level,this.x,this.z,this.originX,this.originZ))}updateZones(){const t=this.buildArea.loadedZones,e=this.buildArea.activeZones;for(const s of t)e.has(s)||t.delete(s);for(const s of e){const e=rl.getZoneIndex(s);t.has(e.index)?(e.writePartialEncloses(this),e.writePartialFollows(this)):e.writeFullFollows(this),t.add(e.index)}}updateStats(){for(let t=0;t<this.stats.length;t++)this.stats[t]===this.lastStats[t]&&this.levels[t]===this.lastLevels[t]||(this.write(new Ir(t,this.stats[t],this.levels[t])),this.lastStats[t]=this.stats[t],this.lastLevels[t]=this.levels[t]);Math.floor(this.runenergy)/100!=Math.floor(this.lastRunEnergy)/100&&(this.write(new Or(this.runenergy)),this.lastRunEnergy=this.runenergy)}updateInvs(){let t=!1,e=!1;for(let s=0;s<this.invListeners.length;s++){const n=this.invListeners[s];if(n)if(-1===n.source){const t=rl.getInventory(n.type);if(!t)continue;(t.update||n.firstSeen)&&(this.write(new ur(n.com,t)),n.firstSeen=!1)}else{const s=rl.getPlayerByUid(n.source);if(!s)continue;const i=s.getInventory(n.type);if(!i)continue;if(i.update||n.firstSeen){this.write(new ur(n.com,i)),n.firstSeen&&(e=!0),n.firstSeen=!1;J.get(n.type).runweight&&(t=!0)}}}if(t){const e=this.runweight;this.calculateRunWeight(),t=e!==this.runweight}(t||e)&&this.write(new Ar(Math.ceil(this.runweight/1e3)))}}class kc extends m{type;camX;camZ;height;rotationSpeed;rotationMultiplier;constructor(t,e,s,n,i,a){super(),this.type=t,this.camX=e,this.camZ=s,this.height=n,this.rotationSpeed=i,this.rotationMultiplier=a}}class xc{static hsl24to16(t,e,s){return s>243?e>>=4:s>217?e>>=3:s>192?e>>=2:s>179&&(e>>=1),((255&t)>>2<<10)+(e>>5<<7)+(s>>1)}static rgb15to24(t){return((t>>10&31)<<3<<16)+((t>>5&31)<<3<<8)+((31&t)<<3)}static rgb15toHsl16(t){const e=(t>>10&31)/31,s=(t>>5&31)/31,n=(31&t)/31;return xc.rgbToHsl(e,s,n)}static rgb24to15(t){return((t>>16&255)>>3<<10)+((t>>8&255)>>3<<5)+((255&t)>>3)}static rgb24toHsl16(t){const e=(t>>16&255)/256,s=(t>>8&255)/256,n=(255&t)/256;return xc.rgbToHsl(e,s,n)}static rgbToHsl(t,e,s){let n=t;e<n&&(n=e),s<n&&(n=s);let i=t;e>i&&(i=e),s>i&&(i=s);let a=0,r=0;const o=(n+i)/2;n!==i&&(o<.5?r=(i-n)/(i+n):o>=.5&&(r=(i-n)/(2-i-n)),t===i?a=(e-s)/(i-n):e===i?a=(s-t)/(i-n)+2:s===i&&(a=(t-e)/(i-n)+4)),a/=6;const c=256*a|0;let l=256*r|0,h=256*o|0;return l<0?l=0:l>255&&(l=255),h<0?h=0:h>255&&(h=255),xc.hsl24to16(c,l,h)}static RGB15_HSL16=new Int32Array(32768);static{for(let t=0;t<32768;t++)xc.RGB15_HSL16[t]=xc.rgb15toHsl16(t)}static reverseHsl(t){const e=[];for(let s=0;s<32768;s++)xc.RGB15_HSL16[s]===t&&e.push(s);return e}}var Bc=function(t){const e=t.popString(),s=[];for(let n=e.length-1;n>=0;n--){const i=e.charAt(n);s[n]='s'===i?t.popString():t.popInt()}return s},Hc={[$t.FINDUID]:t=>{const e=t.popInt(),s=rl.getPlayerByUid(e);s?(t.activePlayer=s,t.pointerAdd(Dt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.P_FINDUID]:t=>{const e=t.popInt()>>>0,s=rl.getPlayerByUid(e);t.pointerGet(Mt[t.intOperand])&&t.activePlayer.uid===e?t.pushInt(1):s&&s.canAccess()?(t.activePlayer=s,t.pointerAdd(Dt[t.intOperand]),t.pointerAdd(Mt[t.intOperand]),t.pushInt(1)):t.pushInt(0)},[$t.STRONGQUEUE]:yt(Dt,(t=>{const e=Bc(t),s=as(t.popInt(),hs),n=t.popInt(),i=Qt.get(n);if(!i)throw new Error(`Unable to find queue script: ${n}`);t.activePlayer.enqueueScript(i,3,s,e)})),[$t.WEAKQUEUE]:yt(Dt,(t=>{const e=Bc(t),s=as(t.popInt(),hs),n=t.popInt(),i=Qt.get(n);if(!i)throw new Error(`Unable to find queue script: ${n}`);t.activePlayer.enqueueScript(i,2,s,e)})),[$t.QUEUE]:yt(Dt,(t=>{const e=Bc(t),s=as(t.popInt(),hs),n=t.popInt(),i=Qt.get(n);if(!i)throw new Error(`Unable to find queue script: ${n}`);t.activePlayer.enqueueScript(i,0,s,e)})),[$t.ANIM]:yt(Dt,(t=>{const e=t.popInt(),s=t.popInt();t.activePlayer.playAnimation(s,e)})),[$t.BUFFER_FULL]:yt(Dt,(t=>{throw new Error('unimplemented')})),[$t.BUILDAPPEARANCE]:yt(Dt,(t=>{t.activePlayer.generateAppearance(as(t.popInt(),ws).id)})),[$t.CAM_LOOKAT]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ms);t.activePlayer.cameraPackets.addTail(new kc(Mn.CAM_LOOKAT,a.x,a.z,s,n,i))})),[$t.CAM_MOVETO]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ms);t.activePlayer.cameraPackets.addTail(new kc(Mn.CAM_MOVETO,a.x,a.z,s,n,i))})),[$t.CAM_SHAKE]:yt(Dt,(t=>{const[e,s,n,i]=t.popInts(4);t.activePlayer.write(new Yi(e,s,n,i))})),[$t.CAM_RESET]:yt(Dt,(t=>{t.activePlayer.write(new zi)})),[$t.COORD]:yt(Dt,(t=>{const e=t.activePlayer;t.pushInt(ts.packCoord(e.level,e.x,e.z))})),[$t.DISPLAYNAME]:yt(Dt,(t=>{t.pushString(t.activePlayer.displayName)})),[$t.FACESQUARE]:yt(Dt,(t=>{const e=as(t.popInt(),ms);t.activePlayer.faceSquare(e.x,e.z)})),[$t.IF_CLOSE]:yt(Dt,(t=>{t.activePlayer.closeModal()})),[$t.LAST_COM]:t=>{t.pushInt(t.activePlayer.lastCom)},[$t.LAST_INT]:t=>{t.pushInt(t.lastInt)},[$t.LAST_ITEM]:t=>{if(![In.OPHELD1,In.OPHELD2,In.OPHELD3,In.OPHELD4,In.OPHELD5,In.OPHELDU,In.OPHELDT,In.INV_BUTTON1,In.INV_BUTTON2,In.INV_BUTTON3,In.INV_BUTTON4,In.INV_BUTTON5].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastItem)},[$t.LAST_SLOT]:t=>{if(![In.OPHELD1,In.OPHELD2,In.OPHELD3,In.OPHELD4,In.OPHELD5,In.OPHELDU,In.OPHELDT,In.INV_BUTTON1,In.INV_BUTTON2,In.INV_BUTTON3,In.INV_BUTTON4,In.INV_BUTTON5,In.INV_BUTTOND].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastSlot)},[$t.LAST_USEITEM]:t=>{if(![In.OPHELDU,In.APOBJU,In.APLOCU,In.APNPCU,In.APPLAYERU,In.OPOBJU,In.OPLOCU,In.OPNPCU,In.OPPLAYERU].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastUseItem)},[$t.LAST_USESLOT]:t=>{if(![In.OPHELDU,In.APOBJU,In.APLOCU,In.APNPCU,In.APPLAYERU,In.OPOBJU,In.OPLOCU,In.OPNPCU,In.OPPLAYERU].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastUseSlot)},[$t.MES]:yt(Dt,(t=>{const e=t.popString();t.activePlayer.messageGame(e)})),[$t.NAME]:yt(Dt,(t=>{t.pushString(t.activePlayer.username)})),[$t.P_APRANGE]:yt(Mt,(t=>{t.activePlayer.apRange=as(t.popInt(),hs),t.activePlayer.apRangeCalled=!0})),[$t.P_ARRIVEDELAY]:yt(Mt,(t=>{t.activePlayer.lastMovement<rl.currentTick||(t.activePlayer.delay=1,t.execution=se.SUSPENDED)})),[$t.P_COUNTDIALOG]:yt(Mt,(t=>{t.activePlayer.write(new Xa),t.execution=se.COUNTDIALOG})),[$t.P_DELAY]:yt(Mt,(t=>{t.activePlayer.delay=as(t.popInt(),hs)+1,t.execution=se.SUSPENDED})),[$t.P_OPHELD]:yt(Mt,(t=>{throw new Error('unimplemented')})),[$t.P_OPLOC]:yt(Mt,(t=>{const e=as(t.popInt(),hs)-1;if(e<0||e>=5)throw new Error(`Invalid oploc: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(Nn.SCRIPT,t.activeLoc,In.APLOC1+e)})),[$t.P_OPNPC]:yt(Mt,(t=>{const e=as(t.popInt(),hs)-1;if(e<0||e>=5)throw new Error(`Invalid opnpc: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(Nn.SCRIPT,t.activeNpc,In.APNPC1+e,{type:t.activeNpc.type,com:-1})})),[$t.P_OPNPCT]:yt(Mt,(t=>{const e=as(t.popInt(),hs);t.activePlayer.stopAction(),t.activePlayer.setInteraction(Nn.SCRIPT,t.activeNpc,In.APNPCT,{type:t.activeNpc.type,com:e})})),[$t.P_PAUSEBUTTON]:yt(Mt,(t=>{t.execution=se.PAUSEBUTTON})),[$t.P_STOPACTION]:yt(Mt,(t=>{t.activePlayer.stopAction()})),[$t.P_CLEARPENDINGACTION]:yt(Mt,(t=>{t.activePlayer.clearPendingAction()})),[$t.P_TELEJUMP]:yt(Mt,(t=>{const e=as(t.popInt(),ms);t.activePlayer.teleJump(e.x,e.z,e.level)})),[$t.P_TELEPORT]:yt(Mt,(t=>{const e=as(t.popInt(),ms);t.activePlayer.teleport(e.x,e.z,e.level)})),[$t.P_WALK]:yt(Mt,(t=>{const e=as(t.popInt(),ms),s=t.activePlayer;s.queueWaypoints(le(s.level,s.x,s.z,e.x,e.z,s.width,s.width,s.length,s.orientation)),s.updateMovement(!1)})),[$t.SAY]:yt(Dt,(t=>{t.activePlayer.say(t.popString())})),[$t.SOUND_SYNTH]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);t.activePlayer.write(new nr(e,s,n))})),[$t.STAFFMODLEVEL]:yt(Dt,(t=>{t.pushInt(t.activePlayer.staffModLevel)})),[$t.STAT]:yt(Dt,(t=>{const e=as(t.popInt(),Ts);t.pushInt(t.activePlayer.levels[e])})),[$t.STAT_BASE]:yt(Dt,(t=>{const e=as(t.popInt(),Ts);t.pushInt(t.activePlayer.baseLevels[e])})),[$t.STAT_ADD]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,Ts),as(s,hs),as(n,hs);const i=t.activePlayer,a=i.levels[e],r=a+(s+a*n/100);i.levels[e]=Math.min(r,255),3===e&&i.levels[3]>=i.baseLevels[3]&&i.resetHeroPoints()})),[$t.STAT_SUB]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,Ts),as(s,hs),as(n,hs);const i=t.activePlayer,a=i.levels[e],r=a-(s+a*n/100);i.levels[e]=Math.max(r,0)})),[$t.SPOTANIM_PL]:yt(Dt,(t=>{const e=as(t.popInt(),hs),s=t.popInt(),n=as(t.popInt(),Ss);t.activePlayer.spotanim(n.id,s,e)})),[$t.STAT_HEAL]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,Ts),as(s,hs),as(n,hs);const i=t.activePlayer,a=i.baseLevels[e],r=i.levels[e],o=r+(s+r*n/100);i.levels[e]=Math.max(Math.min(o,a),r),3===e&&i.levels[3]>=i.baseLevels[3]&&i.resetHeroPoints()})),[$t.UID]:yt(Dt,(t=>{t.pushInt(t.activePlayer.uid)})),[$t.P_LOGOUT]:yt(Mt,(t=>{t.activePlayer.logoutRequested=!0})),[$t.IF_SETCOLOUR]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(e,hs),as(s,hs),t.activePlayer.write(new ha(e,xc.rgb24to15(s)))})),[$t.IF_OPENCHAT]:yt(Dt,(t=>{t.activePlayer.openChat(as(t.popInt(),hs))})),[$t.IF_OPENMAINMODALSIDEOVERLAY]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(e,hs),as(s,hs),t.activePlayer.openMainModalSideOverlay(e,s)})),[$t.IF_SETHIDE]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(e,hs),as(s,hs),t.activePlayer.write(new pa(e,1===s))})),[$t.IF_SETOBJECT]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,hs),as(s,ys),as(n,hs),t.activePlayer.write(new Oa(e,s,n))})),[$t.IF_SETTABACTIVE]:yt(Dt,(t=>{t.activePlayer.write(new ya(as(t.popInt(),hs)))})),[$t.IF_SETMODEL]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(e,hs),as(s,hs),t.activePlayer.write(new _a(e,s))})),[$t.IF_SETRECOL]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,hs),t.activePlayer.write(new Pa(e,s,n))})),[$t.IF_SETTABFLASH]:yt(Dt,(t=>{t.activePlayer.write(new ar(as(t.popInt(),hs)))})),[$t.IF_SETANIM]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(e,hs),-1!==s&&t.activePlayer.write(new ca(e,s))})),[$t.IF_SETTAB]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(s,hs),t.activePlayer.setTab(e,s)})),[$t.IF_OPENMAINMODAL]:yt(Dt,(t=>{t.activePlayer.openMainModal(as(t.popInt(),hs))})),[$t.IF_OPENCHATSTICKY]:yt(Dt,(t=>{t.activePlayer.openChatSticky(as(t.popInt(),hs))})),[$t.IF_OPENSIDEOVERLAY]:yt(Dt,(t=>{t.activePlayer.openSideOverlay(as(t.popInt(),hs))})),[$t.IF_SETPLAYERHEAD]:yt(Dt,(t=>{t.activePlayer.write(new Aa(as(t.popInt(),hs)))})),[$t.IF_SETTEXT]:yt(Dt,(t=>{const e=t.popString(),s=as(t.popInt(),hs);t.activePlayer.write(new Sa(s,e))})),[$t.IF_SETNPCHEAD]:yt(Dt,(t=>{const[e,s]=t.popInts(2);as(e,hs),as(s,Os),t.activePlayer.write(new ma(e,s))})),[$t.IF_SETPOSITION]:yt(Dt,(t=>{const[e,s,n]=t.popInts(3);as(e,hs),t.activePlayer.write(new Ia(e,s,n))})),[$t.IF_MULTIZONE]:yt(Dt,(t=>{t.activePlayer.write(new er(1===as(t.popInt(),hs)))})),[$t.GIVEXP]:yt(Mt,(t=>{const[e,s]=t.popInts(2);as(e,hs),as(s,hs),t.activePlayer.addXp(e,s)})),[$t.DAMAGE]:t=>{const e=as(t.popInt(),hs),s=as(t.popInt(),Ls),n=as(t.popInt(),hs),i=rl.getPlayerByUid(n);i&&i.applyDamage(e,s)},[$t.IF_SETRESUMEBUTTONS]:yt(Dt,(t=>{const[e,s,n,i,a]=t.popInts(5);t.activePlayer.resumeButtons=[e,s,n,i,a]})),[$t.TEXT_GENDER]:yt(Dt,(t=>{const[e,s]=t.popStrings(2);0==t.activePlayer.gender?t.pushString(e):t.pushString(s)})),[$t.MIDI_SONG]:t=>{t.activePlayer.playSong(as(t.popString(),ds))},[$t.MIDI_JINGLE]:t=>{const e=as(t.popInt(),hs),s=as(t.popString(),ds);t.activePlayer.playJingle(e,s)},[$t.SOFTTIMER]:yt(Dt,(t=>{const e=Bc(t),s=t.popInt(),n=t.popInt(),i=Qt.get(n);if(!i)throw new Error(`Unable to find timer script: ${n}`);t.activePlayer.setTimer(1,i,e,s)})),[$t.CLEARSOFTTIMER]:yt(Dt,(t=>{t.activePlayer.clearTimer(t.popInt())})),[$t.SETTIMER]:yt(Dt,(t=>{const e=Bc(t),s=t.popInt(),n=t.popInt(),i=Qt.get(n);if(!i)throw new Error(`Unable to find timer script: ${n}`);t.activePlayer.setTimer(0,i,e,s)})),[$t.CLEARTIMER]:yt(Dt,(t=>{t.activePlayer.clearTimer(t.popInt())})),[$t.HINT_COORD]:t=>{const[e,s,n]=t.popInts(3),i=as(s,ms);t.activePlayer.hintTile(e,i.x,i.z,n)},[$t.HINT_STOP]:t=>{t.activePlayer.stopHint()},[$t.IF_CLOSESTICKY]:t=>{t.activePlayer.closeSticky()},[$t.P_EXACTMOVE]:yt(Mt,(t=>{const[e,s,n,i,a]=t.popInts(5),r=as(e,ms),o=as(s,ms);t.activePlayer.unsetMapFlag(),t.activePlayer.exactMove(r.x,r.z,o.x,o.z,n,i,a)})),[$t.BUSY]:t=>{t.pushInt(t.activePlayer.busy()?1:0)},[$t.BUSY2]:t=>{t.pushInt(t.activePlayer.hasInteraction()||t.activePlayer.hasWaypoints()?1:0)},[$t.GETQUEUE]:t=>{const e=t.popInt();let s=0;for(let n=t.activePlayer.queue.head();null!==n;n=t.activePlayer.queue.next())n.script.id===e&&s++;for(let n=t.activePlayer.weakQueue.head();null!==n;n=t.activePlayer.weakQueue.next())n.script.id===e&&s++;t.pushInt(s)},[$t.P_LOCMERGE]:yt(Mt,(t=>{const[e,s,n,i]=t.popInts(4),a=as(n,ms),r=as(i,ms);rl.mergeLoc(t.activeLoc,t.activePlayer,e,s,a.z,a.x,r.z,r.x)})),[$t.LAST_LOGIN_INFO]:t=>{const e=t.activePlayer;if(!Dc(e)||null===e.client)return;const s=e.client.remoteAddress;if(null==s)return;const n=new Uint32Array(new Uint8Array(s.split('.').map((t=>parseInt(t)))).reverse().buffer)[0];e.lastLoginInfo(n,0,201,0)},[$t.BAS_READYANIM]:t=>{t.activePlayer.basReadyAnim=as(t.popInt(),Ds).id},[$t.BAS_TURNONSPOT]:t=>{t.activePlayer.basTurnOnSpot=as(t.popInt(),Ds).id},[$t.BAS_WALK_F]:t=>{t.activePlayer.basWalkForward=as(t.popInt(),Ds).id},[$t.BAS_WALK_B]:t=>{t.activePlayer.basWalkBackward=as(t.popInt(),Ds).id},[$t.BAS_WALK_L]:t=>{t.activePlayer.basWalkLeft=as(t.popInt(),Ds).id},[$t.BAS_WALK_R]:t=>{t.activePlayer.basWalkRight=as(t.popInt(),Ds).id},[$t.BAS_RUNNING]:t=>{const e=t.popInt();t.activePlayer.basRunning=-1!==e?as(e,Ds).id:-1},[$t.GENDER]:t=>{t.pushInt(t.activePlayer.gender)},[$t.HINT_NPC]:t=>{t.activePlayer.hintNpc(as(t.popInt(),hs))},[$t.HINT_PLAYER]:t=>{const e=as(t.popInt(),hs),s=rl.getPlayerByUid(e);s&&t.activePlayer.hintPlayer(s.pid)},[$t.HEADICONS_GET]:t=>{t.pushInt(t.activePlayer.headicons)},[$t.HEADICONS_SET]:t=>{t.activePlayer.headicons=as(t.popInt(),hs)},[$t.P_OPOBJ]:yt(Mt,(t=>{const e=as(t.popInt(),hs)-1;if(e<0||e>=5)throw new Error(`Invalid opobj: ${e+1}`);t.activePlayer.stopAction(),t.activePlayer.setInteraction(Nn.SCRIPT,t.activeObj,In.APOBJ1+e)})),[$t.P_OPPLAYER]:yt(Mt,(t=>{const e=as(t.popInt(),hs)-1;if(e<0||e>=5)throw new Error(`Invalid opplayer: ${e+1}`);const s=t._activePlayer2;s&&(t.activePlayer.stopAction(),t.activePlayer.setInteraction(Nn.SCRIPT,s,In.APPLAYER1+e))})),[$t.ALLOWDESIGN]:t=>{t.activePlayer.allowDesign=1===as(t.popInt(),hs)},[$t.LAST_TARGETSLOT]:t=>{if(![In.INV_BUTTOND].includes(t.trigger))throw new Error('is not safe to use in this trigger');t.pushInt(t.activePlayer.lastTargetSlot)},[$t.WALKTRIGGER]:t=>{t.activePlayer.walktrigger=t.popInt()},[$t.GETWALKTRIGGER]:t=>{t.pushInt(t.activePlayer.walktrigger)},[$t.CLEARQUEUE]:t=>{const e=t.popInt();for(let s=t.activePlayer.queue.head();null!==s;s=t.activePlayer.queue.next())s.script.id===e&&s.unlink();for(let s=t.activePlayer.weakQueue.head();null!==s;s=t.activePlayer.weakQueue.next())s.script.id===e&&s.unlink()},[$t.HEALENERGY]:t=>{const e=as(t.popInt(),hs),s=t.activePlayer;s.runenergy=Math.min(Math.max(s.runenergy+e,0),1e4)},[$t.AFK_EVENT]:t=>{t.pushInt(t.activePlayer.afkEventReady?1:0),t.activePlayer.afkEventReady=!1},[$t.LOWMEMORY]:t=>{t.pushInt(t.activePlayer.lowMemory?1:0)},[$t.SETIDKIT]:t=>{const[e,s]=t.popInts(2),n=as(e,bs);let i=n.type;1===t.activePlayer.gender&&(i-=7),t.activePlayer.body[i]=n.id;let a=n.type;1===t.activePlayer.gender&&(a-=7);let r=-1;0===a||1===a?r=0:2===a||3===a?r=1:4===a||(5===a?r=2:6===a&&(r=3)),-1!==r&&(t.activePlayer.colors[r]=s)},[$t.SETGENDER]:t=>{const e=as(t.popInt(),zs);for(let s=0;s<7;s++){t.activePlayer.body[s]=-1;for(let n=0;n<j.count;n++)if(!j.get(n).disable&&j.get(n).type==s+(0===e?0:7)){t.activePlayer.body[s]=n;break}}t.activePlayer.gender=e},[$t.SETSKINCOLOUR]:t=>{const e=as(t.popInt(),Vs);t.activePlayer.colors[4]=e},[$t.P_OPPLAYERT]:yt(Mt,(t=>{const e=as(t.popInt(),hs),s=t._activePlayer2;s&&(t.activePlayer.stopAction(),t.activePlayer.setInteraction(Nn.SCRIPT,s,In.APPLAYERT,{type:-1,com:e}))})),[$t.FINDHERO]:yt(Dt,(t=>{const e=t.activePlayer.findHero();if(-1===e)return void t.pushInt(0);const s=rl.getPlayerByUid(e);s?(t._activePlayer2=s,t.pointerAdd(kt.ActivePlayer2),t.pushInt(1)):t.pushInt(0)})),[$t.BOTH_HEROPOINTS]:yt(Dt,(t=>{const e=as(t.popInt(),hs),s=1===t.intOperand,n=s?t._activePlayer2:t._activePlayer,i=s?t._activePlayer:t._activePlayer2;if(!n||!i)throw new Error('player is null');i.addHero(n.uid,e)})),[$t.P_ANIMPROTECT]:yt(Mt,(t=>{t.activePlayer.animProtect=as(t.popInt(),hs)})),[$t.RUNENERGY]:yt(Dt,(t=>{const e=t.activePlayer;t.pushInt(e.runenergy)}))},Fc=Hc,Gc={[$t.MAP_CLOCK]:t=>{t.pushInt(rl.currentTick)},[$t.MAP_MEMBERS]:t=>{t.pushInt(_t.NODE_MEMBERS?1:0)},[$t.MAP_PLAYERCOUNT]:t=>{const[e,s]=t.popInts(2),n=as(e,ms),i=as(s,ms);let a=0;for(let t=Math.floor(n.x/8);t<=Math.ceil(i.x/8);t++)for(let e=Math.floor(n.z/8);e<=Math.ceil(i.z/8);e++)for(const s of rl.getZone(t<<3,e<<3,n.level).getAllPlayersSafe())s.x>=n.x&&s.x<=i.x&&s.z>=n.z&&s.z<=i.z&&a++;t.pushInt(a)},[$t.HUNTALL]:t=>{const[e,s,n]=t.popInts(3),i=as(e,ms);as(s,hs);const a=as(n,Us);t.huntIterator=new dn(rl.currentTick,i.level,i.x,i.z,s,a,-1,-1,B.PLAYER)},[$t.HUNTNEXT]:t=>{const e=t.huntIterator?.next();if(e&&!e.done){if(!(e.value instanceof Vr))throw new Error('[ServerOps] huntnext command must result instance of Player.');t.activePlayer=e.value,t.pointerAdd(Dt[t.intOperand]),t.pushInt(1)}else t.pushInt(0)},[$t.NPC_HUNTALL]:t=>{const[e,s,n]=t.popInts(3),i=as(e,ms);as(s,hs);const a=as(n,Us);t.huntIterator=new dn(rl.currentTick,i.level,i.x,i.z,s,a,-1,-1,B.NPC)},[$t.NPC_HUNTNEXT]:t=>{const e=t.huntIterator?.next();if(e&&!e.done){if(!(e.value instanceof Yc))throw new Error('[ServerOps] npc_huntnext command must result instance of Npc.');t.activeNpc=e.value,t.pointerAdd(Rt[t.intOperand]),t.pushInt(1)}else t.pushInt(0)},[$t.INZONE]:t=>{const[e,s,n]=t.popInts(3),i=as(e,ms),a=as(s,ms),r=as(n,ms);r.x<i.x||r.x>a.x||r.level<i.level||r.level>a.level||r.z<i.z||r.z>a.z?t.pushInt(0):t.pushInt(1)},[$t.LINEOFWALK]:t=>{const[e,s]=t.popInts(2),n=as(e,ms),i=as(s,ms);n.level===i.level?t.pushInt(Ne(n.level,n.x,n.z,i.x,i.z,1,1,1,1)?1:0):t.pushInt(0)},[$t.STAT_RANDOM]:t=>{const[e,s,n]=t.popInts(3),i=Math.floor(s*(99-e)/98)+Math.floor(n*(e-1)/98)+1,a=Math.floor(256*Math.random());t.pushInt(i>a?1:0)},[$t.SPOTANIM_MAP]:t=>{const[e,s,n,i]=t.popInts(4),a=as(s,ms),r=as(e,Ss);rl.animMap(a.level,a.x,a.z,r.id,n,i)},[$t.DISTANCE]:t=>{const[e,s]=t.popInts(2),n=as(e,ms),i=as(s,ms);t.pushInt(ts.distanceToSW(n,i))},[$t.MOVECOORD]:t=>{const[e,s,n,i]=t.popInts(4),a=as(e,ms);t.pushInt(ts.packCoord(a.level+n,a.x+s,a.z+i))},[$t.SEQLENGTH]:t=>{t.pushInt(as(t.popInt(),Ds).duration)},[$t.SPLIT_INIT]:t=>{const[e,s,n]=t.popInts(3);let i=t.popString();const a=as(n,Bs);if(i.startsWith('<p,')&&-1!==i.indexOf('>')){const e=i.substring(3,i.indexOf('>'));t.splitMesanim=st.getId(e),i=i.substring(i.indexOf('>')+1)}else t.splitMesanim=-1;t.splitPages=[];const r=a.split(i,e);for(;r.length>0;)t.splitPages.push(r.splice(0,s))},[$t.SPLIT_GET]:t=>{const[e,s]=t.popInts(2);t.pushString(t.splitPages[e][s])},[$t.SPLIT_PAGECOUNT]:t=>{t.pushInt(t.splitPages.length)},[$t.SPLIT_LINECOUNT]:t=>{const e=t.popInt();t.pushInt(t.splitPages[e].length)},[$t.SPLIT_GETANIM]:t=>{const e=t.popInt();-1!==t.splitMesanim?t.pushInt(as(t.splitMesanim,Hs).len[t.splitPages[e].length-1]):t.pushInt(-1)},[$t.STRUCT_PARAM]:t=>{const[e,s]=t.popInts(2),n=as(s,Es),i=as(e,Fs);n.isString()?t.pushString(Q(n.id,i,n.defaultString)):t.pushInt(q(n.id,i,n.defaultInt))},[$t.COORDX]:t=>{t.pushInt(as(t.popInt(),ms).x)},[$t.COORDY]:t=>{t.pushInt(as(t.popInt(),ms).level)},[$t.COORDZ]:t=>{t.pushInt(as(t.popInt(),ms).z)},[$t.PLAYERCOUNT]:t=>{t.pushInt(rl.getTotalPlayers())},[$t.MAP_BLOCKED]:t=>{const e=as(t.popInt(),ms);t.pushInt(Ae(e.x,e.z,e.level,Fe.WALK_BLOCKED)?1:0)},[$t.MAP_INDOORS]:t=>{const e=as(t.popInt(),ms);t.pushInt(Ae(e.x,e.z,e.level,Fe.ROOF)?1:0)},[$t.LINEOFSIGHT]:t=>{const[e,s]=t.popInts(2),n=as(e,ms),i=as(s,ms);n.level===i.level?t.pushInt(Ie(n.level,n.x,n.z,i.x,i.z,1,1,1,1)?1:0):t.pushInt(0)},[$t.WORLD_DELAY]:t=>{t.execution=se.WORLD_SUSPENDED},[$t.PROJANIM_PL]:t=>{const[e,s,n,i,a,r,o,c,l]=t.popInts(9),h=as(e,ms),d=as(n,Ss),p=rl.getPlayerByUid(s);if(!p)throw new Error(`attempted to use invalid player uid: ${s}`);rl.mapProjAnim(h.level,h.x,h.z,p.x,p.z,-p.pid-1,d.id,i+100,a+100,r,o,c,l)},[$t.PROJANIM_NPC]:t=>{const[e,s,n,i,a,r,o,c,l]=t.popInts(9),h=as(e,ms),d=as(n,Ss),p=65535&s,u=rl.getNpc(p);if(!u)throw new Error(`attempted to use invalid npc uid: ${s}`);rl.mapProjAnim(h.level,h.x,h.z,u.x,u.z,u.nid+1,d.id,i+100,a+100,r,o,c,l)},[$t.PROJANIM_MAP]:t=>{const[e,s,n,i,a,r,o,c,l]=t.popInts(9),h=as(n,Ss),d=as(e,ms),p=as(s,ms);rl.mapProjAnim(d.level,d.x,d.z,p.x,p.z,0,h.id,i+100,a,r,o,c,l)},[$t.MAP_LOCADDUNSAFE]:t=>{const e=as(t.popInt(),ms);for(const s of rl.getZone(e.x,e.z,e.level).getAllLocsUnsafe()){if(1!==as(s.type,ps).active)continue;const n=Ce(s.shape);if(s.checkLifeCycle(rl.currentTick)||n!==Ve.WALL)if(n===Ve.WALL){if(s.x===e.x&&s.z===e.z)return void t.pushInt(1)}else if(n===Ve.GROUND){const n=s.angle===We.NORTH||s.angle===We.SOUTH?s.length:s.width,i=s.angle===We.NORTH||s.angle===We.SOUTH?s.width:s.length;for(let a=0;a<n*i;a++){const i=s.x+a%n,r=s.z+(a/n|0);if(i===e.x&&r===e.z)return void t.pushInt(1)}}else if(n===Ve.GROUND_DECOR&&s.x===e.x&&s.z===e.z)return void t.pushInt(1)}t.pushInt(0)},[$t.NPCCOUNT]:t=>{t.pushInt(rl.getTotalNpcs())},[$t.ZONECOUNT]:t=>{t.pushInt(rl.getTotalZones())},[$t.LOCCOUNT]:t=>{t.pushInt(rl.getTotalLocs())},[$t.OBJCOUNT]:t=>{t.pushInt(rl.getTotalObjs())}},Wc=Gc,zc={[$t.APPEND_NUM]:t=>{const e=t.popString(),s=t.popInt();t.pushString(e+s)},[$t.APPEND]:t=>{const[e,s]=t.popStrings(2);t.pushString(e+s)},[$t.APPEND_SIGNNUM]:t=>{const e=t.popString(),s=t.popInt();s>=0?t.pushString(`${e}+${s}`):t.pushString(e+s)},[$t.LOWERCASE]:t=>{t.pushString(t.popString().toLowerCase())},[$t.TOSTRING]:t=>{t.pushString(t.popInt().toString())},[$t.COMPARE]:t=>{const[e,s]=t.popStrings(2);t.pushInt(function(t,e){const s=t.length,n=e.length,i=Math.min(s,n);let a=0;for(;a<i;){const s=t.charCodeAt(a),n=e.charCodeAt(a);if(s!=n)return s-n;a++}return s-n}(e,s))},[$t.TEXT_SWITCH]:t=>{const e=t.popInt(),[s,n]=t.popStrings(2);t.pushString(1===e?s:n)},[$t.APPEND_CHAR]:t=>{const e=t.popString(),s=t.popInt();t.pushString(e+String.fromCharCode(s))},[$t.STRING_LENGTH]:t=>{t.pushInt(t.popString().length)},[$t.SUBSTRING]:t=>{const e=t.popString(),[s,n]=t.popInts(2);t.pushString(e.substring(s,n))},[$t.STRING_INDEXOF_CHAR]:t=>{const e=t.popString(),s=String.fromCharCode(t.popInt());t.pushInt(e.indexOf(s))},[$t.STRING_INDEXOF_STRING]:t=>{const e=t.popString(),s=t.popString();t.pushInt(e.indexOf(s))}};class Vc{static HANDLERS={...Zs,...Wc,...Fc,...Pn,...On,...Rn,...Ln,...fn,...bn,...cn,...tn,...zc,...wn,...Js,...qs};static init(t,e=null,s=null,n=[]){const i=new se(t,n);return i.self=e,e instanceof Vr?(i._activePlayer=e,i.pointerAdd(kt.ActivePlayer)):e instanceof Yc?(i._activeNpc=e,i.pointerAdd(kt.ActiveNpc)):e instanceof _n?(i._activeLoc=e,i.pointerAdd(kt.ActiveLoc)):e instanceof an&&(i._activeObj=e,i.pointerAdd(kt.ActiveObj)),s instanceof Vr?e instanceof Vr?(i._activePlayer2=s,i.pointerAdd(kt.ActivePlayer2)):(i._activePlayer=s,i.pointerAdd(kt.ActivePlayer)):s instanceof Yc?e instanceof Yc?(i._activeNpc2=s,i.pointerAdd(kt.ActiveNpc2)):(i._activeNpc=s,i.pointerAdd(kt.ActiveNpc)):s instanceof _n?e instanceof _n?(i._activeLoc2=s,i.pointerAdd(kt.ActiveLoc2)):(i._activeLoc=s,i.pointerAdd(kt.ActiveLoc)):s instanceof an&&(e instanceof an?(i._activeObj2=s,i.pointerAdd(kt.ActiveObj2)):(i._activeObj=s,i.pointerAdd(kt.ActiveObj))),i}static execute(t,e=!1,s=!1){if(!t||!t.script||!t.script.info)return se.ABORTED;try{e&&t.reset(),t.execution!==se.RUNNING&&t.executionHistory.push(t.execution),t.execution=se.RUNNING;const n=1e3*performance.now();for(;t.execution===se.RUNNING;){if(t.pc>=t.script.opcodes.length||t.pc<-1)throw new Error('Invalid program counter: '+t.pc+', max expected: '+t.script.opcodes.length);if(!s&&t.opcount>5e5)throw new Error('Too many instructions');t.opcount++,Vc.executeInner(t,t.script.opcodes[++t.pc])}const i=1e3*performance.now()-n|0;if(_t.NODE_DEBUG_PROFILE&&i>1e3){const e=`Warning [cpu time]: Script: ${t.script.info.scriptName}, time: ${i}us`;t.self instanceof Vr?t.self.wrappedMessageGame(e):console.warn(e)}}catch(e){if(t.pc>=0&&t.pc<t.script.opcodes.length){const s=t.script.opcodes[t.pc];let n=t.intOperand;s===$t.POP_VARP||s===$t.POP_VARN||s===$t.PUSH_VARP||s===$t.PUSH_VARN?n=t.intOperand>>16&1:s<=$t.POP_ARRAY_INT&&(n=0),e.message=$t[s].toLowerCase()+' '+e.message,n&&(e.message='.'+e.message)}if(t.self instanceof Vr){t.self.wrappedMessageGame(`script error: ${e.message}`),t.self.wrappedMessageGame(`file: ${Jt.basename(t.script.info.sourceFilePath)}`),t.self.wrappedMessageGame(''),t.self.wrappedMessageGame('stack backtrace:'),t.self.wrappedMessageGame(`    1: ${t.script.name} - ${t.script.fileName}:${t.script.lineNumber(t.pc)}`);let s=1;for(let e=t.fp;e>0;e--){const n=t.frames[e];n&&(s++,t.self.wrappedMessageGame(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}for(let e=t.debugFp;e>=0;e--){const n=t.debugFrames[e];n&&(s++,t.self.wrappedMessageGame(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}}console.error(`script error: ${e.message}`),console.error(`file: ${Jt.basename(t.script.info.sourceFilePath)}`),console.error(''),console.error('stack backtrace:'),console.error(`    1: ${t.script.name} - ${t.script.fileName}:${t.script.lineNumber(t.pc)}`);let s=1;for(let e=t.fp;e>0;e--){const n=t.frames[e];n&&(s++,console.error(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}for(let e=t.debugFp;e>=0;e--){const n=t.debugFrames[e];n&&(s++,console.error(`    ${s}: ${n.script.name} - ${n.script.fileName}:${n.script.lineNumber(n.pc)}`))}t.execution=se.ABORTED}return t.execution}static executeInner(t,e){const s=Vc.HANDLERS[e];if(!s)throw new Error(`Unknown opcode ${e}`);s(t)}}class Yc extends Fn{static ANIM=2;static FACE_ENTITY=4;static SAY=8;static DAMAGE=16;static CHANGE_TYPE=32;static SPOTANIM=64;static FACE_COORD=128;nid;type;uid;origType;startX;startZ;levels=new Uint8Array(6);baseLevels=new Uint8Array(6);vars;varsString;activeScript=null;delay=0;queue=new E;timerInterval=0;timerClock=0;huntMode=-1;nextHuntTick=-1;huntrange=5;nextPatrolTick=-1;nextPatrolPoint=0;delayedPatrol=!1;heroPoints=new Array(16);constructor(t,e,s,n,i,a,r,o,c,l){super(t,e,s,n,i,a,c,l,Hn.NAIVE,Yc.FACE_COORD,Yc.FACE_ENTITY),this.nid=r,this.type=o,this.uid=o<<16|r,this.startX=this.x,this.startZ=this.z,this.origType=o;const h=ht.get(o);for(let t=0;t<h.stats.length;t++){const e=h.stats[t];this.levels[t]=e,this.baseLevels[t]=e}-1!==h.timer&&this.setTimer(h.timer),this.vars=new Int32Array(ft.count),this.varsString=new Array(ft.count),this.targetOp=h.defaultmode,this.huntMode=h.huntmode,this.huntrange=h.huntrange}resetHeroPoints(){this.heroPoints=new Array(16),this.heroPoints.fill({uid:-1,points:0})}addHero(t,e){const s=this.heroPoints.findIndex((e=>e&&e.uid===t));if(-1!==s)return void(this.heroPoints[s].points+=e);const n=this.heroPoints.findIndex((t=>t&&-1===t.uid));-1===n||(this.heroPoints[n]={uid:t,points:e})}findHero(){return this.heroPoints.sort(((t,e)=>e.points-t.points)),this.heroPoints[0]?.uid??-1}getVar(t){const e=ft.get(t);return e.type===I.STRING?this.varsString[e.id]:this.vars[e.id]}setVar(t,e){const s=ft.get(t);s.type===I.STRING&&'string'==typeof e?this.varsString[s.id]=e:'number'==typeof e&&(this.vars[s.id]=e)}resetEntity(t){if(t){this.type=this.origType,this.uid=this.type<<16|this.nid,this.orientation=Qe;for(let t=0;t<this.baseLevels.length;t++)this.levels[t]=this.baseLevels[t];this.resetHeroPoints(),this.defaultMode();const t=ht.get(this.type);this.huntrange=t.huntrange}super.resetPathingEntity()}updateMovement(t=!0){const e=ht.get(this.type);if(e.moverestrict===ct.NOMOVE)return!1;if(this.target&&this.targetOp!==Y.PLAYERFOLLOW){const t=ts.distanceTo(this,{x:this.startX,z:this.startZ,width:this.width,length:this.length});if(ts.distanceTo(this.target,{x:this.startX,z:this.startZ,width:this.target.width,length:this.target.length})>e.maxrange&&t>e.maxrange)return!1}if(t&&this.target instanceof Fn&&!this.interacted&&-1===this.walktrigger&&this.pathToPathingTarget(),-1!==this.walktrigger){const t=ht.get(this.type),e=Qt.getByTrigger(In.AI_QUEUE1+this.walktrigger,t.id,t.category);if(this.walktrigger=-1,e){const t=Vc.init(e,this,null,[this.walktriggerArg]);Vc.execute(t)}}return this.moveSpeed!==Bn.INSTANT&&(this.moveSpeed=this.defaultMoveSpeed()),super.processMovement()}blockWalkFlag(){return this.moveRestrict===ct.NORMAL?Fe.NPC:this.moveRestrict===ct.BLOCKED?Fe.OPEN:this.moveRestrict===ct.BLOCKED_NORMAL||this.moveRestrict===ct.INDOORS||this.moveRestrict===ct.OUTDOORS?Fe.NPC:this.moveRestrict===ct.NOMOVE?Fe.NULL:this.moveRestrict===ct.PASSTHRU?Fe.OPEN:Fe.NULL}defaultMoveSpeed(){return Bn.WALK}delayed(){return this.delay>0}setTimer(t){this.timerInterval=t,this.timerClock=0}executeScript(t){if(!t)return;const e=Vc.execute(t);e!==se.FINISHED&&e!==se.ABORTED?e===se.WORLD_SUSPENDED?rl.enqueueScript(t,t.popInt()):e===se.NPC_SUSPENDED?t.activeNpc.activeScript=t:t.activePlayer.activeScript=t:t===this.activeScript&&(this.activeScript=null),t.pointerGet(kt.ProtectedActivePlayer)&&t._activePlayer&&(t._activePlayer.protect=!1,t.pointerRemove(kt.ProtectedActivePlayer)),t.pointerGet(kt.ProtectedActivePlayer2)&&t._activePlayer2&&(t._activePlayer2.protect=!1,t.pointerRemove(kt.ProtectedActivePlayer2))}processTimers(){if(0!==this.timerInterval&&++this.timerClock>=this.timerInterval){this.timerClock=0;const t=ht.get(this.type),e=Qt.getByTrigger(In.AI_TIMER,t.id,t.category);e&&this.executeScript(Vc.init(e,this))}}processQueue(){for(let t=this.queue.head();null!==t;t=this.queue.next())if(this.delayed()||t.delay--,!this.delayed()&&t.delay<=0){const e=Vc.init(t.script,this,null,t.args);e.lastInt=t.lastInt,this.executeScript(e),t.unlink()}}enqueueScript(t,e=0,s=0){const n=new Un(0,t,[],e);n.lastInt=s,this.queue.addTail(n)}randomWalk(t){const e=Math.round(Math.random()*(2*t)-t),s=Math.round(Math.random()*(2*t)-t),n=this.startX+e,i=this.startZ+s;n===this.x&&i===this.z||this.queueWaypoint(n,i)}processNpcModes(){this.targetOp===Y.NULL?this.defaultMode():this.targetOp===Y.NONE?this.noMode():this.targetOp===Y.WANDER?this.wanderMode():this.targetOp===Y.PATROL?this.patrolMode():this.targetOp===Y.PLAYERESCAPE?this.playerEscapeMode():this.targetOp===Y.PLAYERFOLLOW?this.playerFollowMode():this.targetOp===Y.PLAYERFACE?this.playerFaceMode():this.targetOp===Y.PLAYERFACECLOSE?this.playerFaceCloseMode():this.aiMode()}noMode(){this.clearInteraction(),this.updateMovement(!1),this.targetOp=Y.NONE,this.faceEntity=-1,this.mask|=Yc.FACE_ENTITY}defaultMode(){this.clearInteraction(),this.updateMovement(!1);const t=ht.get(this.type);this.targetOp=t.defaultmode,this.faceEntity=-1,this.mask|=Yc.FACE_ENTITY}wanderMode(){const t=ht.get(this.type);t.moverestrict!==ct.NOMOVE&&Math.random()<.125&&this.randomWalk(t.wanderrange),this.updateMovement(!1)}patrolMode(){const t=ht.get(this.type),e=t.patrolCoord,s=t.patrolDelay[this.nextPatrolPoint];let n=ts.unpackCoord(e[this.nextPatrolPoint]);this.updateMovement(!1),this.hasWaypoints()||this.target||this.queueWaypoint(n.x,n.z),(this.x!==n.x||this.z!==n.z)&&rl.currentTick>=this.nextPatrolTick&&this.teleport(n.x,n.z,n.level),this.x!==n.x||this.z!==n.z||this.delayedPatrol||(this.nextPatrolTick=rl.currentTick+s,this.delayedPatrol=!0),this.nextPatrolTick>rl.currentTick||(this.nextPatrolPoint=(this.nextPatrolPoint+1)%e.length,this.nextPatrolTick=rl.currentTick+30,this.delayedPatrol=!1,n=ts.unpackCoord(e[this.nextPatrolPoint]),this.queueWaypoint(n.x,n.z))}playerEscapeMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof Vr))throw new Error('[Npc] Target must be a Player for playerescape mode.');if(null===rl.getPlayerByUid(this.target.uid))return void this.defaultMode();if(ts.distanceToSW(this,this.target)>25)return void this.defaultMode();let t,e;this.target.x>=this.x&&this.target.z>=this.z?(t=Xe,e=Fe.WALL_SOUTH|Fe.WALL_WEST):this.target.x>=this.x&&this.target.z<this.z?(t=Ke,e=Fe.WALL_NORTH|Fe.WALL_WEST):this.target.x<this.x&&this.target.z>=this.z?(t=qe,e=Fe.WALL_SOUTH|Fe.WALL_EAST):(t=Ze,e=Fe.WALL_NORTH|Fe.WALL_EAST);const s=ts.moveX(this.x,t),n=ts.moveZ(this.z,t);if(Ae(s,n,this.level,e))return void this.defaultMode();const i={x:s,z:n,level:this.level};if(ts.distanceToSW(i,{x:this.startX,z:this.startZ})<ht.get(this.type).maxrange)return this.queueWaypoint(i.x,i.z),void this.updateMovement(!1);t===Ze||t===Ke?this.queueWaypoint(this.x,i.z):this.queueWaypoint(i.x,this.z),this.updateMovement(!1)}playerFollowMode(){if(this.target){if(!(this.target instanceof Vr))throw new Error('[Npc] Target must be a Player for playerfollow mode.');null!==rl.getPlayerByUid(this.target.uid)&&this.level===this.target.level?(this.pathToTarget(),this.updateMovement()):this.defaultMode()}else this.defaultMode()}playerFaceMode(){if(!this.target)return void this.defaultMode();if(!(this.target instanceof Vr))throw new Error('[Npc] Target must be a Player for playerface mode.');if(null===rl.getPlayerByUid(this.target.uid))return void this.defaultMode();if(this.level!==this.target.level)return void this.defaultMode();const t=ht.get(this.type);ts.distanceTo(this,this.target)>t.maxrange?this.defaultMode():this.updateMovement(!1)}playerFaceCloseMode(){if(this.target){if(!(this.target instanceof Vr))throw new Error('[Npc] Target must be a Player for playerfaceclose mode.');null!=rl.getPlayerByUid(this.target.uid)&&this.level===this.target.level?ts.distanceTo(this,this.target)>1?this.defaultMode():this.updateMovement(!1):this.defaultMode()}else this.defaultMode()}aiMode(){if(this.delayed()||!this.target)return void this.defaultMode();if(this.target.level!==this.level)return void this.defaultMode();if(this.target instanceof Yc&&(void 0===rl.getNpc(this.target.nid)||this.target.delayed()))return void this.defaultMode();if(this.target instanceof Yc&&-1!==this.targetSubject.type&&null===rl.getNpcByUid(this.targetSubject.type<<16|this.target.nid))return void this.defaultMode();if(this.target instanceof an&&null===rl.getObj(this.target.x,this.target.z,this.level,this.target.type,-1))return void this.defaultMode();if(this.target instanceof _n&&null===rl.getLoc(this.target.x,this.target.z,this.level,this.target.type))return void this.defaultMode();if(this.target instanceof Vr&&null===rl.getPlayerByUid(this.target.uid))return void this.defaultMode();const t=ht.get(this.type);if(ts.distanceTo(this,this.target)>t.attackrange)return void this.defaultMode();const e=this.targetOp>=Y.APNPC1&&this.targetOp<=Y.APNPC5||this.targetOp>=Y.APPLAYER1&&this.targetOp<=Y.APPLAYER5||this.targetOp>=Y.APLOC1&&this.targetOp<=Y.APLOC5||this.targetOp>=Y.APOBJ1&&this.targetOp<=Y.APOBJ5,s=!e,n=this.getTrigger();n&&s&&this.inOperableDistance(this.target)&&this.target instanceof Fn||n&&e&&this.inApproachDistance(t.attackrange,this.target)?(this.executeScript(Vc.init(n,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&this.target instanceof Fn&&(this.target=null,this.interacted=!0,this.clearWaypoints());const i=this.updateMovement();i&&(this.alreadyFacedEntity=!1,this.alreadyFacedCoord=!1),this.target&&!this.interacted&&(this.interacted=!1,n&&s&&this.inOperableDistance(this.target)&&(this.target instanceof Fn||!i)||n&&e&&this.inApproachDistance(t.attackrange,this.target)?(this.executeScript(Vc.init(n,this,this.target)),this.interacted=!0,this.clearWaypoints()):this.inOperableDistance(this.target)&&(this.target instanceof Fn||!i)&&(this.target=null,this.interacted=!0,this.clearWaypoints()))}getTrigger(){const t=this.getTriggerForMode(this.targetOp);return t?Qt.getByTrigger(t,this.type,-1)??null:null}getTriggerForMode(t){return t===Y.OPPLAYER1?In.AI_OPPLAYER1:t===Y.OPPLAYER2?In.AI_OPPLAYER2:t===Y.OPPLAYER3?In.AI_OPPLAYER3:t===Y.OPPLAYER4?In.AI_OPPLAYER4:t===Y.OPPLAYER5?In.AI_OPPLAYER5:t===Y.APPLAYER1?In.AI_APPLAYER1:t===Y.APPLAYER2?In.AI_APPLAYER2:t===Y.APPLAYER3?In.AI_APPLAYER3:t===Y.APPLAYER4?In.AI_APPLAYER4:t===Y.APPLAYER5?In.AI_APPLAYER5:t===Y.OPLOC1?In.AI_OPLOC1:t===Y.OPLOC2?In.AI_OPLOC2:t===Y.OPLOC3?In.AI_OPLOC3:t===Y.OPLOC4?In.AI_OPLOC4:t===Y.OPLOC5?In.AI_OPLOC5:t===Y.APLOC1?In.AI_APLOC1:t===Y.APLOC2?In.AI_APLOC2:t===Y.APLOC3?In.AI_APLOC3:t===Y.APLOC4?In.AI_APLOC4:t===Y.APLOC5?In.AI_APLOC5:t===Y.OPOBJ1?In.AI_OPOBJ1:t===Y.OPOBJ2?In.AI_OPOBJ2:t===Y.OPOBJ3?In.AI_OPOBJ3:t===Y.OPOBJ4?In.AI_OPOBJ4:t===Y.OPOBJ5?In.AI_OPOBJ5:t===Y.APOBJ1?In.AI_APOBJ1:t===Y.APOBJ2?In.AI_APOBJ2:t===Y.APOBJ3?In.AI_APOBJ3:t===Y.APOBJ4?In.AI_APOBJ4:t===Y.APOBJ5?In.AI_APOBJ5:t===Y.OPNPC1?In.AI_OPNPC1:t===Y.OPNPC2?In.AI_OPNPC2:t===Y.OPNPC3?In.AI_OPNPC3:t===Y.OPNPC4?In.AI_OPNPC4:t===Y.OPNPC5?In.AI_OPNPC5:t===Y.APNPC1?In.AI_APNPC1:t===Y.APNPC2?In.AI_APNPC2:t===Y.APNPC3?In.AI_APNPC3:t===Y.APNPC4?In.AI_APNPC4:t===Y.APNPC5?In.AI_APNPC5:t===Y.QUEUE1?In.AI_QUEUE1:t===Y.QUEUE2?In.AI_QUEUE2:t===Y.QUEUE3?In.AI_QUEUE3:t===Y.QUEUE4?In.AI_QUEUE4:t===Y.QUEUE5?In.AI_QUEUE5:t===Y.QUEUE6?In.AI_QUEUE6:t===Y.QUEUE7?In.AI_QUEUE7:t===Y.QUEUE8?In.AI_QUEUE8:t===Y.QUEUE9?In.AI_QUEUE9:t===Y.QUEUE10?In.AI_QUEUE10:t===Y.QUEUE11?In.AI_QUEUE11:t===Y.QUEUE12?In.AI_QUEUE12:t===Y.QUEUE13?In.AI_QUEUE13:t===Y.QUEUE14?In.AI_QUEUE14:t===Y.QUEUE15?In.AI_QUEUE15:t===Y.QUEUE16?In.AI_QUEUE16:t===Y.QUEUE17?In.AI_QUEUE17:t===Y.QUEUE18?In.AI_QUEUE18:t===Y.QUEUE19?In.AI_QUEUE19:t===Y.QUEUE20?In.AI_QUEUE20:null}huntAll(){if(this.nextHuntTick>rl.currentTick)return;const t=K.get(this.huntMode);if(t.type===B.OFF)return;if(t.nobodyNear===G.PAUSEHUNT&&!rl.getZoneGrid(this.level).isFlagged(ts.zone(this.x),ts.zone(this.z),5))return;if(!t.findKeepHunting&&null!==this.target)return;let e;if(e=t.type===B.PLAYER?this.huntPlayers(t):t.type===B.NPC?this.huntNpcs(t):t.type===B.OBJ?this.huntObjs(t):this.huntLocs(t),e.length>0){const s=e[Math.floor(Math.random()*e.length)];this.setInteraction(Nn.SCRIPT,s,t.findNewMode)}this.nextHuntTick=rl.currentTick+t.rate}huntPlayers(t){const e=ht.get(this.type),s=[],n=new dn(rl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,-1,-1,B.PLAYER);for(const i of n){if(!(i instanceof Vr))throw new Error('[Npc] huntAll must be of type Player here.');if((!t.checkAfk||!i.zonesAfk())&&((t.checkNotTooStrong!==M.OUTSIDE_WILDERNESS||i.isInWilderness()||!(i.combatLevel>2*e.vislevel))&&!(-1!==t.checkNotCombat&&i.getVar(t.checkNotCombat)+8>rl.currentTick||-1!==t.checkNotCombatSelf&&this.getVar(t.checkNotCombatSelf)>=rl.currentTick))){if(-1!==t.checkInv){let e=0;if(-1!==t.checkObj?e=i.invTotal(t.checkInv,t.checkObj):-1!==t.checkObjParam&&(e=i.invTotalParam(t.checkInv,t.checkObjParam)),e<t.checkInvMinQuantity||e>t.checkInvMaxQuantity)continue}t.checkNotBusy&&i.busy()||s.push(i)}}return s}huntNpcs(t){return Array.from(new dn(rl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkNpc,t.checkCategory,B.NPC))}huntObjs(t){return Array.from(new dn(rl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkObj,t.checkCategory,B.OBJ))}huntLocs(t){return Array.from(new dn(rl.currentTick,this.level,this.x,this.z,this.huntrange,t.checkVis,t.checkLoc,t.checkCategory,B.SCENERY))}playAnimation(t,e){this.animId=t,this.animDelay=e,this.mask|=Yc.ANIM}spotanim(t,e,s){this.graphicId=t,this.graphicHeight=e,this.graphicDelay=s,this.mask|=Yc.SPOTANIM}applyDamage(t,e){this.damageTaken=t,this.damageType=e;const s=this.levels[lt.HITPOINTS];s-t<=0?(this.levels[lt.HITPOINTS]=0,this.damageTaken=s):this.levels[lt.HITPOINTS]=s-t,this.mask|=Yc.DAMAGE}say(t){t&&(this.chat=t,this.mask|=Yc.SAY)}faceSquare(t,e){this.faceX=2*t+1,this.faceZ=2*e+1,this.orientation=ts.face(this.x,this.z,t,e),this.mask|=Yc.FACE_COORD}changeType(t){this.type=t,this.mask|=Yc.CHANGE_TYPE,this.uid=t<<16|this.nid;const e=ht.get(t);this.setTimer(e.timer)}}class Kc{static OPEN=0;static BLOCKED=1;static BRIDGE=2;static ROOF=4;static WALL=8;static LOWMEMORY=16;static Y=4;static X=64;static Z=64;static MAPSQUARE=Kc.X*Kc.Y*Kc.Z;async init(t){console.time('Loading game map');const e='data/pack/server/maps/',s=['m29_75','m30_75','m31_75','m32_70','m32_71','m32_72','m32_73','m32_74','m32_75','m33_70','m33_71','m33_72','m33_73','m33_74','m33_75','m33_76','m34_70','m34_71','m34_72','m34_73','m34_74','m34_75','m34_76','m35_20','m35_75','m35_76','m36_146','m36_147','m36_148','m36_149','m36_150','m36_153','m36_154','m36_52','m36_53','m36_54','m36_72','m36_73','m36_74','m36_75','m36_76','m37_146','m37_147','m37_148','m37_149','m37_150','m37_151','m37_152','m37_153','m37_154','m37_48','m37_49','m37_50','m37_51','m37_52','m37_53','m37_54','m37_55','m37_72','m37_73','m37_74','m37_75','m38_146','m38_147','m38_148','m38_149','m38_150','m38_151','m38_152','m38_153','m38_154','m38_155','m38_45','m38_46','m38_47','m38_48','m38_49','m38_50','m38_51','m38_52','m38_53','m38_54','m38_55','m38_72','m38_73','m38_74','m39_147','m39_148','m39_149','m39_150','m39_151','m39_152','m39_153','m39_154','m39_155','m39_45','m39_46','m39_47','m39_48','m39_49','m39_50','m39_51','m39_52','m39_53','m39_54','m39_55','m39_72','m39_73','m39_74','m39_75','m39_76','m40_147','m40_148','m40_149','m40_150','m40_151','m40_152','m40_153','m40_154','m40_45','m40_46','m40_47','m40_48','m40_49','m40_50','m40_51','m40_52','m40_53','m40_54','m40_55','m40_72','m40_73','m40_74','m40_75','m40_76','m41_146','m41_149','m41_151','m41_152','m41_153','m41_154','m41_45','m41_46','m41_47','m41_48','m41_49','m41_50','m41_51','m41_52','m41_53','m41_54','m41_55','m41_56','m41_72','m41_73','m41_74','m41_75','m42_144','m42_145','m42_146','m42_151','m42_152','m42_153','m42_49','m42_50','m42_51','m42_52','m42_53','m42_54','m42_55','m42_56','m42_72','m42_73','m42_74','m42_75','m43_144','m43_145','m43_146','m43_153','m43_154','m43_45','m43_46','m43_47','m43_48','m43_49','m43_50','m43_51','m43_52','m43_53','m43_54','m43_55','m43_56','m43_72','m43_73','m43_74','m43_75','m44_144','m44_145','m44_146','m44_148','m44_149','m44_150','m44_151','m44_152','m44_153','m44_154','m44_155','m44_45','m44_46','m44_47','m44_48','m44_49','m44_50','m44_51','m44_52','m44_53','m44_54','m44_55','m44_72','m44_73','m44_74','m44_75','m45_145','m45_146','m45_148','m45_150','m45_151','m45_152','m45_153','m45_154','m45_155','m45_45','m45_46','m45_47','m45_48','m45_49','m45_50','m45_51','m45_52','m45_53','m45_54','m45_55','m45_56','m45_57','m45_58','m45_59','m45_60','m45_61','m45_62','m45_73','m45_74','m45_75','m45_76','m46_149','m46_150','m46_152','m46_153','m46_154','m46_161','m46_45','m46_46','m46_47','m46_48','m46_49','m46_50','m46_51','m46_52','m46_53','m46_54','m46_55','m46_56','m46_57','m46_58','m46_59','m46_60','m46_61','m46_62','m46_75','m47_148','m47_149','m47_150','m47_152','m47_153','m47_160','m47_161','m47_47','m47_48','m47_49','m47_50','m47_51','m47_52','m47_53','m47_54','m47_55','m47_56','m47_57','m47_58','m47_59','m47_60','m47_61','m47_62','m47_75','m48_148','m48_149','m48_152','m48_153','m48_154','m48_155','m48_156','m48_47','m48_48','m48_49','m48_50','m48_51','m48_52','m48_53','m48_54','m48_55','m48_56','m48_57','m48_58','m48_59','m48_60','m48_61','m48_62','m49_148','m49_149','m49_153','m49_154','m49_155','m49_156','m49_46','m49_47','m49_48','m49_49','m49_50','m49_51','m49_52','m49_53','m49_54','m49_55','m49_56','m49_57','m49_58','m49_59','m49_60','m49_61','m49_62','m50_149','m50_150','m50_152','m50_153','m50_154','m50_46','m50_47','m50_48','m50_49','m50_50','m50_51','m50_52','m50_53','m50_54','m50_55','m50_56','m50_57','m50_58','m50_59','m50_60','m50_61','m50_62','m51_147','m51_154','m51_46','m51_47','m51_48','m51_49','m51_50','m51_51','m51_52','m51_53','m51_54','m51_55','m51_56','m51_57','m51_58','m51_59','m51_60','m51_61','m51_62','m52_152','m52_153','m52_154','m52_46','m52_47','m52_48','m52_49','m52_50','m52_51','m52_52','m52_53','m52_54','m52_55','m52_56','m52_57','m52_58','m52_59','m52_60','m52_61','m52_62','m53_49','m53_50','m53_51','m53_52','m53_53'];for(let n=0;n<s.length;n++){const[i,a]=s[n].substring(1).split('_').map(Number),r=i<<6,o=a<<6;this.decodeNpcs(await f.load(`${e}n${i}_${a}`),r,o),this.decodeObjs(await f.load(`${e}o${i}_${a}`),r,o,t);const c=new Int8Array(Kc.MAPSQUARE);this.decodeLands(c,await f.load(`${e}m${i}_${a}`),r,o),this.decodeLocs(c,await f.load(`${e}l${i}_${a}`),r,o,t)}console.timeEnd('Loading game map')}changeLandCollision(t,e,s,n){de(t,e,s,n)}changeLocCollision(t,e,s,n,i,a,r,o,c,l){const h=Ce(t);h===Ve.WALL?me(r,o,c,e,t,s,!1,l):h===Ve.GROUND?e===We.NORTH||e===We.SOUTH?pe(r,o,c,n,i,s,!1,l):pe(r,o,c,i,n,s,!1,l):h===Ve.GROUND_DECOR&&1===a&&de(r,o,c,l)}changeNpcCollision(t,e,s,n,i){ue(e,s,n,t,i)}changePlayerCollision(t,e,s,n,i){_e(e,s,n,t,i)}changeRoofCollision(t,e,s,n){ge(t,e,s,n)}decodeNpcs(t,e,s){for(;t.available>0;){const{x:n,z:i,level:a}=this.unpackCoord(t.g2()),r=e+n,o=s+i,c=t.g1();for(let e=0;e<c;e++){const e=ht.get(t.g2()),s=e.size,n=new Yc(a,r,o,s,s,en.RESPAWN,rl.getNextNid(),e.id,e.moverestrict,e.blockwalk);(e.members&&_t.NODE_MEMBERS||!e.members)&&rl.addNpc(n,-1)}}}decodeObjs(t,e,s,n){for(;t.available>0;){const{x:i,z:a,level:r}=this.unpackCoord(t.g2()),o=e+i,c=s+a,l=t.g1();for(let e=0;e<l;e++){const e=gt.get(t.g2()),s=new an(r,o,c,en.RESPAWN,e.id,t.g1());(e.members&&_t.NODE_MEMBERS||!e.members)&&n.zone(s.x,s.z,s.level).addStaticObj(s)}}}decodeLands(t,e,s,n){for(let s=0;s<Kc.Y;s++)for(let n=0;n<Kc.X;n++)for(let i=0;i<Kc.Z;i++)for(;;){const a=e.g1();if(0===a)break;if(1===a){e.pos++;break}a<=49?e.pos++:a<=81&&(t[this.packCoord(n,i,s)]=a-49)}for(let e=0;e<Kc.Y;e++)for(let i=0;i<Kc.X;i++){const a=i+s;for(let s=0;s<Kc.Z;s++){const r=s+n;i%7==0&&s%7==0&&Ee(a,r,e);const o=t[this.packCoord(i,s,e)];if((o&Kc.ROOF)!==Kc.OPEN&&this.changeRoofCollision(a,r,e,!0),(o&Kc.BLOCKED)!==Kc.BLOCKED)continue;const c=(1===e?o&Kc.BRIDGE:t[this.packCoord(i,s,1)]&Kc.BRIDGE)===Kc.BRIDGE?e-1:e;c<0||this.changeLandCollision(a,r,c,!0)}}}decodeLocs(t,e,s,n,i){let a=-1,r=e.gsmart();for(;0!==r;){a+=r;let o=0,c=e.gsmart();for(;0!==c;){const{x:r,z:l,level:h}=this.unpackCoord(o+=c-1),d=e.g1();c=e.gsmart();const p=(1===h?t[o]&Kc.BRIDGE:t[this.packCoord(r,l,1)]&Kc.BRIDGE)===Kc.BRIDGE?h-1:h;if(p<0)continue;const u=et.get(a),_=u.width,g=u.length,m=d>>2,E=3&d,O=r+s,f=l+n;i.zone(O,f,p).addStaticLoc(new _n(p,O,f,_,g,en.RESPAWN,a,m,E)),u.blockwalk&&this.changeLocCollision(m,E,u.blockrange,g,_,u.active,O,f,p,!0)}r=e.gsmart()}}packCoord(t,e,s){return 63&e|(63&t)<<6|(3&s)<<12}unpackCoord(t){return{x:t>>6&63,z:63&t,level:t>>12&3}}}class jc{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(t=[0,0,0,0]){for(let e=0;e<t.length;e++)this.rsl[e]=t[e];this.init()}init(){let t=2654435769,e=2654435769,s=2654435769,n=2654435769,i=2654435769,a=2654435769,r=2654435769,o=2654435769;for(let c=0;c<4;c++)t^=e<<11,n+=t,e+=s,e^=s>>>2,i+=e,s+=n,s^=n<<8,a+=s,n+=i,n^=i>>>16,r+=n,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,s+=o,t+=e;for(let c=0;c<256;c+=8)t+=this.rsl[c],e+=this.rsl[c+1],s+=this.rsl[c+2],n+=this.rsl[c+3],i+=this.rsl[c+4],a+=this.rsl[c+5],r+=this.rsl[c+6],o+=this.rsl[c+7],t^=e<<11,n+=t,e+=s,e^=s>>>2,i+=e,s+=n,s^=n<<8,a+=s,n+=i,n^=i>>>16,r+=n,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,s+=o,t+=e,this.mem[c]=t,this.mem[c+1]=e,this.mem[c+2]=s,this.mem[c+3]=n,this.mem[c+4]=i,this.mem[c+5]=a,this.mem[c+6]=r,this.mem[c+7]=o;for(let c=0;c<256;c+=8)t+=this.mem[c],e+=this.mem[c+1],s+=this.mem[c+2],n+=this.mem[c+3],i+=this.mem[c+4],a+=this.mem[c+5],r+=this.mem[c+6],o+=this.mem[c+7],t^=e<<11,n+=t,e+=s,e^=s>>>2,i+=e,s+=n,s^=n<<8,a+=s,n+=i,n^=i>>>16,r+=n,i+=a,i^=a<<10,o+=i,a+=r,a^=r>>>4,t+=a,r+=o,r^=o<<8,e+=r,o+=t,o^=t>>>9,s+=o,t+=e,this.mem[c]=t,this.mem[c+1]=e,this.mem[c+2]=s,this.mem[c+3]=n,this.mem[c+4]=i,this.mem[c+5]=a,this.mem[c+6]=r,this.mem[c+7]=o;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let t=0;t<256;t++){const e=this.mem[t];switch(3&t){case 0:this.a^=this.a<<13;break;case 1:this.a^=this.a>>>6;break;case 2:this.a^=this.a<<2;break;case 3:this.a^=this.a>>>16}let s;this.a+=this.mem[t+128&255],this.mem[t]=s=this.mem[e>>>2&255]+this.a+this.b,this.rsl[t]=this.b=this.mem[s>>>8>>>2&255]+e}}nextInt(){return 0==this.count--&&(this.isaac(),this.count=255),this.rsl[this.count]}}class Zc{static loadFromFile(t){const e=u(p(t));let s;return s=fs.existsSync(`data/players/${e}.sav`)?f.load(`data/players/${e}.sav`):new f(new Uint8Array),Zc.load(t,s,null)}static load(t,e,s){const n=p(t),i=u(n),a=s?new Mc(i,n,s):new Vr(i,n);if(e.data.length<2){for(let t=0;t<21;t++)a.stats[t]=0,a.baseLevels[t]=1,a.levels[t]=1;return a.stats[is.HITPOINTS]=Gr(10),a.baseLevels[is.HITPOINTS]=10,a.levels[is.HITPOINTS]=10,a}if(8196!==e.g2())throw new Error('Invalid player save');const r=e.g2();if(r>3)throw new Error('Unsupported player save format');e.pos=e.data.length-4;if(e.g4()!=f.getcrc(e.data,0,e.data.length-4))throw new Error('Player save corrupted');e.pos=4,a.x=e.g2(),a.z=e.g2(),a.level=e.g1();for(let t=0;t<7;t++)a.body[t]=e.g1(),255===a.body[t]&&(a.body[t]=-1);for(let t=0;t<5;t++)a.colors[t]=e.g1();a.gender=e.g1(),a.runenergy=e.g2(),a.playtime=r>=2?e.g4():e.g2();for(let t=0;t<21;t++)a.stats[t]=e.g4(),a.baseLevels[t]=Fr(a.stats[t]),a.levels[t]=e.g1();const o=e.g2();for(let t=0;t<o;t++)a.vars[t]=e.g4();const c=e.g1();for(let t=0;t<c;t++){const t=e.g2(),s=a.getInventory(t);if(s)for(let t=0;t<s.capacity;t++){const n=e.g2();if(0===n)continue;let i=e.g1();255===i&&(i=e.g4()),s.set(t,{id:n-1,count:i})}}if(r>=3){const t=e.g1();for(let s=0;s<t;s++)a.afkZones[s]=e.g4();a.lastAfkZone=e.g2()}return a.combatLevel=a.getCombatLevel(),a.lastResponse=rl.currentTick,_t.NODE_PRODUCTION?void 0!==_t.NODE_STAFF.find((t=>t===i))&&(a.staffModLevel=3):a.staffModLevel=3,a}}class Jc{static SUCCESSFUL=Uint8Array.from([2]);static INVALID_USER_OR_PASS=Uint8Array.from([3]);static ACCOUNT_DISABLED=Uint8Array.from([4]);static LOGGED_IN=Uint8Array.from([5]);static SERVER_UPDATED=Uint8Array.from([6]);static WORLD_FULL=Uint8Array.from([7]);static LOGIN_SERVER_OFFLINE=Uint8Array.from([8]);static LOGIN_LIMIT_EXCEEDED=Uint8Array.from([9]);static UNABLE_TO_CONNECT=Uint8Array.from([10]);static LOGIN_REJECTED=Uint8Array.from([11]);static NEED_MEMBERS_ACCOUNT=Uint8Array.from([12]);static COULD_NOT_COMPLETE=Uint8Array.from([13]);static SERVER_UPDATING=Uint8Array.from([14]);static RECONNECTING=Uint8Array.from([15]);static LOGIN_ATTEMPTS_EXCEEDED=Uint8Array.from([16]);static STANDING_IN_MEMBERS=Uint8Array.from([17]);static STAFF_MOD_LEVEL=Uint8Array.from([18])}async function $c(t){if(!(await fetch(t)).ok)return;const e=await f.load(t),s=f.getcrc(e.data,0,e.data.length);console.log(s),Qc.push(s),Xc.p4(s)}var Xc=new f(new Uint8Array(36)),Qc=[],qc=0;(await fetch('data/pack/client/')).ok&&await async function(){Qc=[],Xc.pos=0,Xc.p4(0),await $c('data/pack/client/title'),await $c('data/pack/client/config'),await $c('data/pack/client/interface'),await $c('data/pack/client/media'),await $c('data/pack/client/models'),await $c('data/pack/client/textures'),await $c('data/pack/client/wordenc'),await $c('data/pack/client/sounds'),qc=f.getcrc(Xc.data,0,Xc.data.length)}();var tl=new class{loginThread=function(t){const e=new Blob([t],{type:'application/javascript'}),s=URL.createObjectURL(e);return new Worker(s,{type:'module'})}("\n// src/jagex2/datastruct/Linkable.ts\nclass Linkable {\n  key;\n  next;\n  prev;\n  constructor() {\n    this.key = 0n;\n    this.next = this;\n    this.prev = this;\n  }\n  unlink() {\n    if (!this.prev || !this.next) {\n      return;\n    }\n    this.prev.next = this.next;\n    this.next.prev = this.prev;\n    this.next = null;\n    this.prev = null;\n  }\n}\n\n// src/jagex2/datastruct/LinkList.ts\nclass LinkList {\n  sentinel;\n  cursor = null;\n  constructor() {\n    const head = new Linkable;\n    head.next = head;\n    head.prev = head;\n    this.sentinel = head;\n  }\n  addTail(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel.prev;\n    node.next = this.sentinel;\n    if (node.prev) {\n      node.prev.next = node;\n    }\n    node.next.prev = node;\n  }\n  addHead(node) {\n    if (node.prev) {\n      node.unlink();\n    }\n    node.prev = this.sentinel;\n    node.next = this.sentinel.next;\n    node.prev.next = node;\n    if (node.next) {\n      node.next.prev = node;\n    }\n  }\n  removeHead() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      return null;\n    }\n    node?.unlink();\n    return node;\n  }\n  head() {\n    const node = this.sentinel.next;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  tail() {\n    const node = this.sentinel.prev;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  next() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.next || null;\n    return node;\n  }\n  prev() {\n    const node = this.cursor;\n    if (node === this.sentinel) {\n      this.cursor = null;\n      return null;\n    }\n    this.cursor = node?.prev || null;\n    return node;\n  }\n  clear() {\n    while (true) {\n      const node = this.sentinel.next;\n      if (node === this.sentinel) {\n        return;\n      }\n      node?.unlink();\n    }\n  }\n}\n\n// src/jagex2/datastruct/Hashable.ts\nclass Hashable extends Linkable {\n  nextHashable;\n  prevHashable;\n  constructor() {\n    super();\n    this.nextHashable = this;\n    this.prevHashable = this;\n  }\n  uncache() {\n    if (!this.prevHashable || !this.nextHashable) {\n      return;\n    }\n    this.prevHashable.nextHashable = this.nextHashable;\n    this.nextHashable.prevHashable = this.prevHashable;\n    this.nextHashable = null;\n    this.prevHashable = null;\n  }\n}\n\n// src/jagex2/io/Packet.ts\nclass Packet extends Hashable {\n  static crctable = new Int32Array(256);\n  static bitmask = new Uint32Array(33);\n  static crc32b = 3988292384;\n  static {\n    for (let i = 0;i < 32; i++) {\n      this.bitmask[i] = (1 << i) - 1;\n    }\n    this.bitmask[32] = 4294967295;\n    for (let b = 0;b < 256; b++) {\n      let remainder = b;\n      for (let bit = 0;bit < 8; bit++) {\n        if ((remainder & 1) == 1) {\n          remainder = remainder >>> 1 ^ this.crc32b;\n        } else {\n          remainder >>>= 1;\n        }\n      }\n      this.crctable[b] = remainder;\n    }\n  }\n  static getcrc(src, offset, length) {\n    let crc = 4294967295;\n    for (let i = offset;i < length; i++) {\n      crc = crc >>> 8 ^ this.crctable[(crc ^ src[i]) & 255];\n    }\n    return ~crc;\n  }\n  static checkcrc(src, offset, length, expected = 0) {\n    const checksum = Packet.getcrc(src, offset, length);\n    console.log(checksum, expected);\n    return checksum == expected;\n  }\n  static alloc(type) {\n    let packet = null;\n    if (type === 0 && this.cacheMinCount > 0) {\n      packet = this.cacheMin.removeHead();\n      this.cacheMinCount--;\n    } else if (type === 1 && this.cacheMidCount > 0) {\n      packet = this.cacheMid.removeHead();\n      this.cacheMidCount--;\n    } else if (type === 2 && this.cacheMaxCount > 0) {\n      packet = this.cacheMax.removeHead();\n      this.cacheMaxCount--;\n    } else if (type === 3 && this.cacheBigCount > 0) {\n      packet = this.cacheBig.removeHead();\n      this.cacheBigCount--;\n    } else if (type === 4 && this.cacheHugeCount > 0) {\n      packet = this.cacheHuge.removeHead();\n      this.cacheHugeCount--;\n    } else if (type === 5 && this.cacheUnimaginableCount > 0) {\n      packet = this.cacheUnimaginable.removeHead();\n      this.cacheUnimaginableCount--;\n    }\n    if (packet !== null) {\n      packet.pos = 0;\n      packet.bitPos = 0;\n      return packet;\n    }\n    if (type === 0) {\n      return new Packet(new Uint8Array(100));\n    } else if (type === 1) {\n      return new Packet(new Uint8Array(5000));\n    } else if (type === 2) {\n      return new Packet(new Uint8Array(30000));\n    } else if (type === 3) {\n      return new Packet(new Uint8Array(1e5));\n    } else if (type === 4) {\n      return new Packet(new Uint8Array(500000));\n    } else if (type === 5) {\n      return new Packet(new Uint8Array(2000000));\n    } else {\n      return new Packet(new Uint8Array(type));\n    }\n  }\n  static async load(path, seekToEnd = false) {\n    const packet = new Packet(new Uint8Array(await (await fetch(path)).arrayBuffer()));\n    if (seekToEnd) {\n      packet.pos = packet.data.length;\n    }\n    return packet;\n  }\n  static cacheMinCount = 0;\n  static cacheMidCount = 0;\n  static cacheMaxCount = 0;\n  static cacheBigCount = 0;\n  static cacheHugeCount = 0;\n  static cacheUnimaginableCount = 0;\n  static cacheMin = new LinkList;\n  static cacheMid = new LinkList;\n  static cacheMax = new LinkList;\n  static cacheBig = new LinkList;\n  static cacheHuge = new LinkList;\n  static cacheUnimaginable = new LinkList;\n  data;\n  #view;\n  pos;\n  bitPos;\n  constructor(src) {\n    super();\n    this.data = src;\n    this.#view = new DataView(this.data.buffer);\n    this.pos = 0;\n    this.bitPos = 0;\n  }\n  get available() {\n    return this.data.length - this.pos;\n  }\n  get length() {\n    return this.data.length;\n  }\n  release() {\n    this.pos = 0;\n    this.bitPos = 0;\n    if (this.data.length === 100 && Packet.cacheMinCount < 1000) {\n      Packet.cacheMin.addTail(this);\n      Packet.cacheMinCount++;\n    } else if (this.data.length === 5000 && Packet.cacheMidCount < 250) {\n      Packet.cacheMid.addTail(this);\n      Packet.cacheMidCount++;\n    } else if (this.data.length === 30000 && Packet.cacheMaxCount < 50) {\n      Packet.cacheMax.addTail(this);\n      Packet.cacheMaxCount++;\n    } else if (this.data.length === 1e5 && Packet.cacheBigCount < 10) {\n      Packet.cacheBig.addTail(this);\n      Packet.cacheBigCount++;\n    } else if (this.data.length === 500000 && Packet.cacheHugeCount < 5) {\n      Packet.cacheHuge.addTail(this);\n      Packet.cacheHugeCount++;\n    } else if (this.data.length === 2000000 && Packet.cacheUnimaginableCount < 2) {\n      Packet.cacheUnimaginable.addTail(this);\n      Packet.cacheUnimaginableCount++;\n    }\n  }\n  p1(value) {\n    this.#view.setUint8(this.pos++, value);\n  }\n  p2(value) {\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  ip2(value) {\n    this.#view.setUint16(this.pos, value, true);\n    this.pos += 2;\n  }\n  p3(value) {\n    this.#view.setUint8(this.pos++, value >> 16);\n    this.#view.setUint16(this.pos, value);\n    this.pos += 2;\n  }\n  p4(value) {\n    this.#view.setInt32(this.pos, value);\n    this.pos += 4;\n  }\n  ip4(value) {\n    this.#view.setInt32(this.pos, value, true);\n    this.pos += 4;\n  }\n  p8(value) {\n    this.#view.setBigInt64(this.pos, value);\n    this.pos += 8;\n  }\n  pbool(value) {\n    this.p1(value ? 1 : 0);\n  }\n  pjstr(str, terminator = 10) {\n    const length = str.length;\n    for (let i = 0;i < length; i++) {\n      this.#view.setUint8(this.pos++, str.charCodeAt(i));\n    }\n    this.#view.setUint8(this.pos++, terminator);\n  }\n  pdata(src, offset, length) {\n    this.data.set(src.subarray(offset, offset + length), this.pos);\n    this.pos += length - offset;\n  }\n  psize4(size) {\n    this.#view.setUint32(this.pos - size - 4, size);\n  }\n  psize2(size) {\n    this.#view.setUint16(this.pos - size - 2, size);\n  }\n  psize1(size) {\n    this.#view.setUint8(this.pos - size - 1, size);\n  }\n  psmarts(value) {\n    if (value < 64 && value >= 64) {\n      this.p1(value + 64);\n    } else if (value < 16384 && value >= -16384) {\n      this.p2(value + 49152);\n    } else {\n      throw new Error(\"Error psmarts out of range: \" + value);\n    }\n  }\n  psmart(value) {\n    if (value >= 0 && value < 128) {\n      this.p1(value);\n    } else if (value >= 0 && value < 32768) {\n      this.p2(value + 32768);\n    } else {\n      throw new Error(\"Error psmart out of range: \" + value);\n    }\n  }\n  g1() {\n    return this.#view.getUint8(this.pos++);\n  }\n  g1b() {\n    return this.#view.getInt8(this.pos++);\n  }\n  g2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2);\n  }\n  g2s() {\n    this.pos += 2;\n    return this.#view.getInt16(this.pos - 2);\n  }\n  ig2() {\n    this.pos += 2;\n    return this.#view.getUint16(this.pos - 2, true);\n  }\n  g3() {\n    const result = this.#view.getUint8(this.pos++) << 16 | this.#view.getUint16(this.pos);\n    this.pos += 2;\n    return result;\n  }\n  g4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4);\n  }\n  ig4() {\n    this.pos += 4;\n    return this.#view.getInt32(this.pos - 4, true);\n  }\n  g8() {\n    this.pos += 8;\n    return this.#view.getBigInt64(this.pos - 8);\n  }\n  gbool() {\n    return this.g1() === 1;\n  }\n  gjstr(terminator = 10) {\n    const length = this.data.length;\n    let str = \"\";\n    let b;\n    while ((b = this.#view.getUint8(this.pos++)) !== terminator && this.pos < length) {\n      str += String.fromCharCode(b);\n    }\n    return str;\n  }\n  gdata(dest, offset, length) {\n    dest.set(this.data.subarray(this.pos, this.pos + length), offset);\n    this.pos += length;\n  }\n  gsmarts() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() - 64 : this.g2() - 49152;\n  }\n  gsmart() {\n    return this.#view.getUint8(this.pos) < 128 ? this.g1() : this.g2() - 32768;\n  }\n  bits() {\n    this.bitPos = this.pos << 3;\n  }\n  bytes() {\n    this.pos = this.bitPos + 7 >>> 3;\n  }\n  gBit(n) {\n    let bytePos = this.bitPos >>> 3;\n    let remaining = 8 - (this.bitPos & 7);\n    let value = 0;\n    this.bitPos += n;\n    for (;n > remaining; remaining = 8) {\n      value += (this.#view.getUint8(bytePos++) & Packet.bitmask[remaining]) << n - remaining;\n      n -= remaining;\n    }\n    if (n == remaining) {\n      value += this.#view.getUint8(bytePos) & Packet.bitmask[remaining];\n    } else {\n      value += this.#view.getUint8(bytePos) >>> remaining - n & Packet.bitmask[n];\n    }\n    return value;\n  }\n  pBit(n, value) {\n    const pos = this.bitPos;\n    this.bitPos += n;\n    let bytePos = pos >>> 3;\n    let remaining = 8 - (pos & 7);\n    const view = this.#view;\n    for (;n > remaining; remaining = 8) {\n      const shift2 = (1 << remaining) - 1;\n      const byte2 = view.getUint8(bytePos);\n      view.setUint8(bytePos++, byte2 & ~shift2 | value >>> n - remaining & shift2);\n      n -= remaining;\n    }\n    const r = remaining - n;\n    const shift = (1 << n) - 1;\n    const byte = view.getUint8(bytePos);\n    view.setUint8(bytePos, byte & ~shift << r | (value & shift) << r);\n  }\n}\n\n// src/jagex2/jstring/JString.ts\nfunction toBase37(string) {\n  string = string.trim();\n  let l = 0n;\n  for (let i = 0;i < string.length && i < 12; i++) {\n    const c = string.charCodeAt(i);\n    l *= 37n;\n    if (c >= 65 && c <= 90) {\n      l += BigInt(c + 1 - 65);\n    } else if (c >= 97 && c <= 122) {\n      l += BigInt(c + 1 - 97);\n    } else if (c >= 48 && c <= 57) {\n      l += BigInt(c + 27 - 48);\n    }\n  }\n  return l;\n}\nfunction fromBase37(value) {\n  if (value < 0n || value >= 6582952005840035281n) {\n    return \"invalid_name\";\n  }\n  if (value % 37n === 0n) {\n    return \"invalid_name\";\n  }\n  let len = 0;\n  const chars = Array(12);\n  while (value !== 0n) {\n    const l1 = value;\n    value /= 37n;\n    chars[11 - len++] = BASE37_LOOKUP[Number(l1 - value * 37n)];\n  }\n  return chars.slice(12 - len).join(\"\");\n}\nfunction toSafeName(name) {\n  return fromBase37(toBase37(name));\n}\nvar BASE37_LOOKUP = [\n  \"_\",\n  \"a\",\n  \"b\",\n  \"c\",\n  \"d\",\n  \"e\",\n  \"f\",\n  \"g\",\n  \"h\",\n  \"i\",\n  \"j\",\n  \"k\",\n  \"l\",\n  \"m\",\n  \"n\",\n  \"o\",\n  \"p\",\n  \"q\",\n  \"r\",\n  \"s\",\n  \"t\",\n  \"u\",\n  \"v\",\n  \"w\",\n  \"x\",\n  \"y\",\n  \"z\",\n  \"0\",\n  \"1\",\n  \"2\",\n  \"3\",\n  \"4\",\n  \"5\",\n  \"6\",\n  \"7\",\n  \"8\",\n  \"9\"\n];\n\n// src/lostcity/server/NetworkStream.ts\nclass NetworkStream {\n  queue = [];\n  available = 0;\n  buffer = null;\n  offset = 0;\n  waiting = 0;\n  received(buf) {\n    this.queue.push(buf);\n    this.available += buf.length;\n  }\n  clear() {\n    this.queue = [];\n    this.available = 0;\n    this.buffer = null;\n    this.offset = 0;\n  }\n  async readByte(socket) {\n    if (socket === null || socket.closed) {\n      return 0;\n    }\n    if (this.available < 1) {\n      await new Promise((res) => setTimeout(res, 10));\n      return this.readByte(socket);\n    }\n    if (this.buffer === null) {\n      this.buffer = this.queue.shift() ?? null;\n      this.offset = 0;\n    }\n    const value = this.buffer?.[this.offset] ?? 0;\n    this.offset++;\n    this.available--;\n    if (this.buffer && this.offset === this.buffer.length) {\n      this.buffer = null;\n    }\n    return value;\n  }\n  async readBytes(socket, destination, offset, length, full = true) {\n    if (socket === null || socket.closed) {\n      return 0;\n    }\n    if (this.available < length) {\n      if (full) {\n        await new Promise((res) => setTimeout(res, 10));\n        return this.readBytes(socket, destination, offset, length);\n      } else {\n        length = this.available;\n      }\n    }\n    destination.pos = offset;\n    for (let i = 0;i < length; i++) {\n      if (this.buffer === null) {\n        this.buffer = this.queue.shift() ?? null;\n        this.offset = 0;\n      }\n      destination.data[offset + i] = this.buffer?.[this.offset] ?? 0;\n      this.offset++;\n      this.available--;\n      if (this.buffer && this.offset === this.buffer.length) {\n        this.buffer = null;\n      }\n    }\n    return length;\n  }\n}\n\n// src/lostcity/util/Environment.ts\nvar Environment_default = {\n  WEB_PORT: 80,\n  WEB_CORS: true,\n  NODE_ID: 10,\n  NODE_PORT: 43594,\n  NODE_MEMBERS: true,\n  NODE_XPRATE: 1,\n  NODE_PRODUCTION: false,\n  NODE_KILLTIMER: 50,\n  NODE_ALLOW_CHEATS: true,\n  NODE_DEBUG: true,\n  NODE_DEBUG_PROFILE: false,\n  NODE_STAFF: [\"pazaz\"],\n  NODE_CLIENT_ROUTEFINDER: true,\n  NODE_SOCKET_TIMEOUT: true,\n  LOGIN_HOST: \"localhost\",\n  LOGIN_PORT: 43500,\n  LOGIN_KEY: \"\",\n  DB_HOST: \"localhost\",\n  DB_USER: \"root\",\n  DB_PASS: \"password\",\n  DB_NAME: \"lostcity\",\n  BUILD_JAVA_PATH: \"java\",\n  BUILD_STARTUP: true,\n  BUILD_STARTUP_UPDATE: true,\n  BUILD_VERIFY: true,\n  BUILD_VERIFY_FOLDER: true,\n  BUILD_VERIFY_PACK: true,\n  BUILD_SRC_DIR: \"data/src\"\n};\n\n// src/lostcity/server/LoginServer.ts\nclass LoginResponse {\n  static SUCCESSFUL = Uint8Array.from([2]);\n  static INVALID_USER_OR_PASS = Uint8Array.from([3]);\n  static ACCOUNT_DISABLED = Uint8Array.from([4]);\n  static LOGGED_IN = Uint8Array.from([5]);\n  static SERVER_UPDATED = Uint8Array.from([6]);\n  static WORLD_FULL = Uint8Array.from([7]);\n  static LOGIN_SERVER_OFFLINE = Uint8Array.from([8]);\n  static LOGIN_LIMIT_EXCEEDED = Uint8Array.from([9]);\n  static UNABLE_TO_CONNECT = Uint8Array.from([10]);\n  static LOGIN_REJECTED = Uint8Array.from([11]);\n  static NEED_MEMBERS_ACCOUNT = Uint8Array.from([12]);\n  static COULD_NOT_COMPLETE = Uint8Array.from([13]);\n  static SERVER_UPDATING = Uint8Array.from([14]);\n  static RECONNECTING = Uint8Array.from([15]);\n  static LOGIN_ATTEMPTS_EXCEEDED = Uint8Array.from([16]);\n  static STANDING_IN_MEMBERS = Uint8Array.from([17]);\n  static STAFF_MOD_LEVEL = Uint8Array.from([18]);\n}\nclass LoginClient {\n  socket = null;\n  stream = new NetworkStream;\n  async connect() {\n    if (this.socket) {\n      return;\n    }\n    return new Promise((res) => {\n      this.socket = net.createConnection({\n        port: Environment_default.LOGIN_PORT,\n        host: Environment_default.LOGIN_HOST\n      });\n      this.socket.setNoDelay(true);\n      this.socket.setTimeout(1000);\n      this.socket.on(\"data\", async (buf) => {\n        this.stream.received(buf);\n      });\n      this.socket.once(\"close\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"error\", () => {\n        this.disconnect();\n        res();\n      });\n      this.socket.once(\"connect\", () => {\n        res();\n      });\n    });\n  }\n  disconnect() {\n    if (this.socket === null) {\n      return;\n    }\n    this.socket.destroy();\n    this.socket = null;\n    this.stream.clear();\n  }\n  async write(socket, opcode, data = null, full = true) {\n    if (socket === null) {\n      return;\n    }\n    const packet = new Packet(new Uint8Array(1 + 2 + (data !== null ? data?.length : 0)));\n    packet.p1(opcode);\n    if (data !== null) {\n      packet.p2(data.length);\n      packet.pdata(data, 0, data.length);\n    } else {\n      packet.p2(0);\n    }\n    const done = socket.write(packet.data);\n    if (!done && full) {\n      await new Promise((res) => {\n        const interval = setInterval(() => {\n          if (socket === null || socket.closed) {\n            clearInterval(interval);\n            res();\n          }\n        }, 100);\n        socket.once(\"drain\", () => {\n          clearInterval(interval);\n          res();\n        });\n      });\n    }\n  }\n  async load(username37, password, uid) {\n    await this.connect();\n    if (this.socket === null) {\n      return { reply: -1, data: null };\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + password.length + 1 + 4));\n    request.p2(Environment_default.NODE_ID);\n    request.p8(username37);\n    request.pjstr(password);\n    request.p4(uid);\n    await this.write(this.socket, 1, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    if (reply !== 1) {\n      this.disconnect();\n      return { reply, data: null };\n    }\n    const data = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, data, 0, 2);\n    const length = data.g2();\n    const data2 = new Packet(new Uint8Array(length));\n    await this.stream.readBytes(this.socket, data2, 0, length);\n    this.disconnect();\n    return { reply, data: data2 };\n  }\n  async save(username37, save) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 8 + 2 + save.length));\n    request.p2(Environment_default.NODE_ID);\n    request.p8(username37);\n    request.p2(save.length);\n    request.pdata(save, 0, save.length);\n    await this.write(this.socket, 2, request.data);\n    const reply = await this.stream.readByte(this.socket);\n    this.disconnect();\n    return reply;\n  }\n  async reset() {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(Environment_default.NODE_ID);\n    await this.write(this.socket, 3, request.data);\n    this.disconnect();\n  }\n  async count(world) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2));\n    request.p2(world);\n    await this.write(this.socket, 4, request.data);\n    const reply = new Packet(new Uint8Array(2));\n    await this.stream.readBytes(this.socket, reply, 0, 2);\n    const count = reply.g2();\n    this.disconnect();\n    return count;\n  }\n  async heartbeat(players) {\n    await this.connect();\n    if (this.socket === null) {\n      return -1;\n    }\n    const request = new Packet(new Uint8Array(2 + 2 + players.length * 8));\n    request.p2(Environment_default.NODE_ID);\n    request.p2(players.length);\n    for (const player of players) {\n      request.p8(player);\n    }\n    await this.write(this.socket, 5, request.data);\n    this.disconnect();\n  }\n}\n\n// src/lostcity/server/LoginThread.ts\nself.onmessage = async (msg) => {\n  try {\n    switch (msg.data.type) {\n      case \"reset\": {\n        break;\n      }\n      case \"heartbeat\": {\n        break;\n      }\n      case \"loginreq\": {\n        const { opcode, data, socket } = msg.data;\n        const stream = new Packet(data);\n        const revision = stream.g1();\n        if (revision !== 225) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.SERVER_UPDATED,\n            socket\n          });\n          return;\n        }\n        const info = stream.g1();\n        const crcs = new Uint8Array(9 * 4);\n        stream.gdata(crcs, 0, crcs.length);\n        const enc = new Uint8Array(stream.g1());\n        stream.gdata(enc, 0, enc.length);\n        stream.pos = 0;\n        stream.pdata(enc, 0, enc.length);\n        stream.pos = 0;\n        if (stream.g1() !== 10) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.LOGIN_REJECTED,\n            socket\n          });\n          return;\n        }\n        const seed = [];\n        for (let i = 0;i < 4; i++) {\n          seed[i] = stream.g4();\n        }\n        const uid = stream.g4();\n        const username = stream.gjstr();\n        const password = stream.gjstr();\n        if (username.length < 1 || username.length > 12) {\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.INVALID_USER_OR_PASS,\n            socket\n          });\n          return;\n        }\n        if (Environment_default.LOGIN_KEY) {\n          if (password.length < 5 || password.length > 20) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.INVALID_USER_OR_PASS,\n              socket\n            });\n            return;\n          }\n          const login = new LoginClient;\n          const request = await login.load(toBase37(toSafeName(username)), password, uid);\n          if (request.reply === 1 && request.data) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.SUCCESSFUL,\n              socket,\n              info,\n              seed,\n              username: toSafeName(username),\n              save: request.data.data\n            });\n          } else if ((request.reply === 2 || request.reply === 3) && opcode === 16) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGGED_IN,\n              socket\n            });\n            return;\n          } else if (request.reply === 3 && opcode === 18) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGGED_IN,\n              socket\n            });\n            return;\n          } else if (request.reply === 4) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.SUCCESSFUL,\n              socket,\n              info,\n              seed,\n              username: toSafeName(username),\n              save: new Uint8Array\n            });\n          } else if (request.reply === 5) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.INVALID_USER_OR_PASS,\n              socket\n            });\n            return;\n          } else if (request.reply === -1) {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGIN_SERVER_OFFLINE,\n              socket\n            });\n            return;\n          } else {\n            self.postMessage({\n              type: \"loginreply\",\n              status: LoginResponse.LOGIN_REJECTED,\n              socket\n            });\n            return;\n          }\n        } else {\n          let save = new Uint8Array;\n          const safeName = toSafeName(username);\n          const url = new URL(\"data/players/\" + safeName + \".sav\", self.location.origin);\n          if ((await fetch(url)).ok) {\n            save = new Uint8Array(await (await fetch(url)).arrayBuffer());\n          }\n          self.postMessage({\n            type: \"loginreply\",\n            status: LoginResponse.SUCCESSFUL,\n            socket,\n            info,\n            seed,\n            username: safeName,\n            save\n          });\n        }\n        break;\n      }\n      case \"logout\": {\n        const { username, save } = msg.data;\n        if (Environment_default.LOGIN_KEY) {\n          const login = new LoginClient;\n          const reply = await login.save(toBase37(username), save);\n          if (reply === 0) {\n            self.postMessage({\n              type: \"logoutreply\",\n              username\n            });\n          }\n        } else {\n          self.postMessage({\n            type: \"logoutreply\",\n            username\n          });\n        }\n        break;\n      }\n      default:\n        console.error(\"Unknown message type: \" + msg.data.type);\n        break;\n    }\n  } catch (err) {\n    console.error(err);\n  }\n};\n");loginRequests=new Map;logoutRequests=new Set;constructor(){this.loginThread.onmessage=t=>{try{this.onMessage(t)}catch(t){console.error('Login Thread:',t)}}}async readIn(t,e){const s=e.g1();if(16===s){const n=e.g1();if(e.available<n)return void t.terminate();const i=new Uint8Array(n);e.gdata(i,0,i.length),e.pos-=i.length;if(225!==e.g1())return void t.writeImmediate(Jc.SERVER_UPDATED);e.pos+=1;const a=new Uint8Array(36);e.gdata(a,0,a.length),f.checkcrc(a,0,a.length,qc),this.loginThread.postMessage({type:'loginreq',opcode:s,data:i,socket:t.uniqueId}),this.loginRequests.set(t.uniqueId,t)}else t.terminate()}logout(t){this.logoutRequests.has(t.username37)||this.loginThread.postMessage({type:'logout',username:t.username})}onMessage(t){switch(t.data.type){case'loginreply':{const{status:e,socket:s}=t.data,n=this.loginRequests.get(s);if(!n)return;if(this.loginRequests.delete(s),2!==e[0])return n.writeImmediate(e),void n.close();const{info:i,seed:a,username:r,save:o}=t.data;if(rl.getTotalPlayers()>=2e3)return n.writeImmediate(Jc.WORLD_FULL),void n.close();if(rl.shutdownTick>-1&&rl.currentTick-rl.shutdownTick>0)return n.writeImmediate(Jc.SERVER_UPDATING),void n.close();if(!_t.LOGIN_KEY)for(const t of rl.players)if(t.username===r)return n.writeImmediate(Jc.LOGGED_IN),void n.close();n.decryptor=new jc(a);for(let t=0;t<4;t++)a[t]+=50;n.encryptor=new jc(a);const c=Zc.load(r,new f(o),n);c.lowMemory=!!(1&i),rl.addPlayer(c);break}case'logoutreply':{const{username:e}=t.data,s=rl.getPlayerByUsername(e);s&&(rl.getZone(s.x,s.z,s.level).leave(s),rl.players.remove(s.pid),s.pid=-1,s.terminate(),this.logoutRequests.delete(s.username37));break}default:throw new Error('Unknown message type: '+t.data.type)}}};class el extends Array{free;indexPadding;ids;lastUsedIndex=0;constructor(t,e){super(t),this.ids=new Int32Array(t).fill(-1),this.free=new Set(Array.from({length:t},((t,e)=>e))),this.indexPadding=e}next(t=!1,e=this.lastUsedIndex+1){const s=this.ids.length;for(let t=e;t<s;t++)if(-1===this.ids[t])return t;for(let t=this.indexPadding;t<e;t++)if(-1===this.ids[t])return t;throw new Error('[EntityList] cannot find next id')}*[Symbol.iterator](){for(const t of this.ids){if(-1===t)continue;const e=this[t];void 0!==e&&(yield e)}}get count(){let t=0;for(const e of this[Symbol.iterator]())t++;return t}get(t){const e=this.ids[t];return-1!==e?this[e]:void 0}set(t,e){if(!this.free.size)throw new Error('[EntityList] cannot find available entities slot.');const s=this.free.values().next().value;this.free.delete(s),this.ids[t]=s,this[s]=e,this.lastUsedIndex=t}remove(t){const e=this.ids[t];-1!==e&&(this.splice(e,1),this.ids[t]=-1,this.free.add(e))}reset(){this.length=0,this.ids.fill(-1),this.free.clear();for(let t=0;t<this.ids.length;t++)this.free.add(t)}}class sl extends el{constructor(t){super(t,0)}}class nl extends el{constructor(t){super(t,1)}next(t=!1,e=this.lastUsedIndex+1){if(t){for(let t=0===e?1:0;t<100;t++){const s=e+t;if(-1===this.ids[s])return s}}return super.next()}}class il extends Kn{ticks;priority=jn.LOW;constructor(t){super(),this.ticks=t}}class al{static PLAYERS=2048;static NPCS=8192;static NORMAL_TICKRATE=600;static SHUTDOWN_TICKRATE=1;static LOGIN_PINGRATE=100;static INV_STOCKRATE=100;static AFK_EVENTRATE=500;static PLAYER_SAVERATE=1500;static SHUTDOWN_TICKS=24e3;static TIMEOUT_IDLE_TICKS=75;static TIMEOUT_LOGOUT_TICKS=100;gameMap;zoneMap;invs;newPlayers;players;npcs;zonesTracking;queue;lastCycleStats;cycleStats;tickRate=al.NORMAL_TICKRATE;currentTick=0;shutdownTick=-1;allLastModified=0;datLastModified=new Map;vars=new Int32Array;varsString=[];constructor(){this.gameMap=new Kc,this.zoneMap=new Br,this.invs=new Set,this.newPlayers=new Set,this.players=new nl(al.PLAYERS),this.npcs=new sl(al.NPCS),this.zonesTracking=new Map,this.queue=new E,this.lastCycleStats=new Array(12).fill(0),this.cycleStats=new Array(12).fill(0)}shouldReload(t,e=!1){return!0}async reload(){let t=!1;if(this.shouldReload('varp',!0)&&(await At.load('data/pack'),t=!0),this.shouldReload('param')&&await dt.load('data/pack'),this.shouldReload('obj',!0)&&(await gt.load('data/pack'),t=!0),this.shouldReload('loc',!0)&&(await et.load('data/pack'),t=!0),this.shouldReload('npc',!0)&&(await ht.load('data/pack'),t=!0),this.shouldReload('idk',!0)&&(await j.load('data/pack'),t=!0),this.shouldReload('frame_del')&&await mt.load('data/pack'),this.shouldReload('seq',!0)&&(await Et.load('data/pack'),t=!0),this.shouldReload('spotanim',!0)&&(await Ct.load('data/pack'),t=!0),this.shouldReload('category')&&await T.load('data/pack'),this.shouldReload('enum')&&await L.load('data/pack'),this.shouldReload('struct')&&await Ot.load('data/pack'),this.shouldReload('inv')){await J.load('data/pack'),this.invs.clear();for(let t=0;t<J.count;t++){const e=J.get(t);e&&e.scope===J.SCOPE_SHARED&&this.invs.add(ie.fromType(t))}}if(this.shouldReload('mesanim')&&await st.load('data/pack'),this.shouldReload('dbtable')&&await N.load('data/pack'),this.shouldReload('dbrow')&&await P.load('data/pack'),this.shouldReload('hunt')&&await K.load('data/pack'),this.shouldReload('varn')&&await ft.load('data/pack'),this.shouldReload('vars')&&(await Tt.load('data/pack'),this.vars.length!==Tt.count)){const t=this.vars;this.vars=new Int32Array(Tt.count);for(let e=0;e<Tt.count&&e<t.length;e++)this.vars[e]=t[e];const e=this.varsString;this.varsString=new Array(Tt.count);for(let s=0;s<Tt.count&&s<t.length;s++)this.varsString[s]=e[s]}if(this.shouldReload('interface')&&(await Z.load('data/pack'),t=!0),this.shouldReload('script')){const t=await Qt.load('data/pack');-1===t?this.broadcastMes('There was an issue while reloading scripts.'):this.broadcastMes(`Reloaded ${t} scripts.`)}await async function(){const t=['l29_75','l30_75','l31_75','l32_70','l32_71','l32_72','l32_73','l32_74','l32_75','l33_70','l33_71','l33_72','l33_73','l33_74','l33_75','l33_76','l34_70','l34_71','l34_72','l34_73','l34_74','l34_75','l34_76','l35_20','l35_75','l35_76','l36_146','l36_147','l36_148','l36_149','l36_150','l36_153','l36_154','l36_52','l36_53','l36_54','l36_72','l36_73','l36_74','l36_75','l36_76','l37_146','l37_147','l37_148','l37_149','l37_150','l37_151','l37_152','l37_153','l37_154','l37_48','l37_49','l37_50','l37_51','l37_52','l37_53','l37_54','l37_55','l37_72','l37_73','l37_74','l37_75','l38_146','l38_147','l38_148','l38_149','l38_150','l38_151','l38_152','l38_153','l38_154','l38_155','l38_45','l38_46','l38_47','l38_48','l38_49','l38_50','l38_51','l38_52','l38_53','l38_54','l38_55','l38_72','l38_73','l38_74','l39_147','l39_148','l39_149','l39_150','l39_151','l39_152','l39_153','l39_154','l39_155','l39_45','l39_46','l39_47','l39_48','l39_49','l39_50','l39_51','l39_52','l39_53','l39_54','l39_55','l39_72','l39_73','l39_74','l39_75','l39_76','l40_147','l40_148','l40_149','l40_150','l40_151','l40_152','l40_153','l40_154','l40_45','l40_46','l40_47','l40_48','l40_49','l40_50','l40_51','l40_52','l40_53','l40_54','l40_55','l40_72','l40_73','l40_74','l40_75','l40_76','l41_146','l41_149','l41_151','l41_152','l41_153','l41_154','l41_45','l41_46','l41_47','l41_48','l41_49','l41_50','l41_51','l41_52','l41_53','l41_54','l41_55','l41_56','l41_72','l41_73','l41_74','l41_75','l42_144','l42_145','l42_146','l42_151','l42_152','l42_153','l42_49','l42_50','l42_51','l42_52','l42_53','l42_54','l42_55','l42_56','l42_72','l42_73','l42_74','l42_75','l43_144','l43_145','l43_146','l43_153','l43_154','l43_45','l43_46','l43_47','l43_48','l43_49','l43_50','l43_51','l43_52','l43_53','l43_54','l43_55','l43_56','l43_72','l43_73','l43_74','l43_75','l44_144','l44_145','l44_146','l44_148','l44_149','l44_150','l44_151','l44_152','l44_153','l44_154','l44_155','l44_45','l44_46','l44_47','l44_48','l44_49','l44_50','l44_51','l44_52','l44_53','l44_54','l44_55','l44_72','l44_73','l44_74','l44_75','l45_145','l45_146','l45_148','l45_150','l45_151','l45_152','l45_153','l45_154','l45_155','l45_45','l45_46','l45_47','l45_48','l45_49','l45_50','l45_51','l45_52','l45_53','l45_54','l45_55','l45_56','l45_57','l45_58','l45_59','l45_60','l45_61','l45_62','l45_73','l45_74','l45_75','l45_76','l46_149','l46_150','l46_152','l46_153','l46_154','l46_161','l46_45','l46_46','l46_47','l46_48','l46_49','l46_50','l46_51','l46_52','l46_53','l46_54','l46_55','l46_56','l46_57','l46_58','l46_59','l46_60','l46_61','l46_62','l46_75','l47_148','l47_149','l47_150','l47_152','l47_153','l47_160','l47_161','l47_47','l47_48','l47_49','l47_50','l47_51','l47_52','l47_53','l47_54','l47_55','l47_56','l47_57','l47_58','l47_59','l47_60','l47_61','l47_62','l47_75','l48_148','l48_149','l48_152','l48_153','l48_154','l48_155','l48_156','l48_47','l48_48','l48_49','l48_50','l48_51','l48_52','l48_53','l48_54','l48_55','l48_56','l48_57','l48_58','l48_59','l48_60','l48_61','l48_62','l49_148','l49_149','l49_153','l49_154','l49_155','l49_156','l49_46','l49_47','l49_48','l49_49','l49_50','l49_51','l49_52','l49_53','l49_54','l49_55','l49_56','l49_57','l49_58','l49_59','l49_60','l49_61','l49_62','l50_149','l50_150','l50_152','l50_153','l50_154','l50_46','l50_47','l50_48','l50_49','l50_50','l50_51','l50_52','l50_53','l50_54','l50_55','l50_56','l50_57','l50_58','l50_59','l50_60','l50_61','l50_62','l51_147','l51_154','l51_46','l51_47','l51_48','l51_49','l51_50','l51_51','l51_52','l51_53','l51_54','l51_55','l51_56','l51_57','l51_58','l51_59','l51_60','l51_61','l51_62','l52_152','l52_153','l52_154','l52_46','l52_47','l52_48','l52_49','l52_50','l52_51','l52_52','l52_53','l52_54','l52_55','l52_56','l52_57','l52_58','l52_59','l52_60','l52_61','l52_62','l53_49','l53_50','l53_51','l53_52','l53_53','m29_75','m30_75','m31_75','m32_70','m32_71','m32_72','m32_73','m32_74','m32_75','m33_70','m33_71','m33_72','m33_73','m33_74','m33_75','m33_76','m34_70','m34_71','m34_72','m34_73','m34_74','m34_75','m34_76','m35_20','m35_75','m35_76','m36_146','m36_147','m36_148','m36_149','m36_150','m36_153','m36_154','m36_52','m36_53','m36_54','m36_72','m36_73','m36_74','m36_75','m36_76','m37_146','m37_147','m37_148','m37_149','m37_150','m37_151','m37_152','m37_153','m37_154','m37_48','m37_49','m37_50','m37_51','m37_52','m37_53','m37_54','m37_55','m37_72','m37_73','m37_74','m37_75','m38_146','m38_147','m38_148','m38_149','m38_150','m38_151','m38_152','m38_153','m38_154','m38_155','m38_45','m38_46','m38_47','m38_48','m38_49','m38_50','m38_51','m38_52','m38_53','m38_54','m38_55','m38_72','m38_73','m38_74','m39_147','m39_148','m39_149','m39_150','m39_151','m39_152','m39_153','m39_154','m39_155','m39_45','m39_46','m39_47','m39_48','m39_49','m39_50','m39_51','m39_52','m39_53','m39_54','m39_55','m39_72','m39_73','m39_74','m39_75','m39_76','m40_147','m40_148','m40_149','m40_150','m40_151','m40_152','m40_153','m40_154','m40_45','m40_46','m40_47','m40_48','m40_49','m40_50','m40_51','m40_52','m40_53','m40_54','m40_55','m40_72','m40_73','m40_74','m40_75','m40_76','m41_146','m41_149','m41_151','m41_152','m41_153','m41_154','m41_45','m41_46','m41_47','m41_48','m41_49','m41_50','m41_51','m41_52','m41_53','m41_54','m41_55','m41_56','m41_72','m41_73','m41_74','m41_75','m42_144','m42_145','m42_146','m42_151','m42_152','m42_153','m42_49','m42_50','m42_51','m42_52','m42_53','m42_54','m42_55','m42_56','m42_72','m42_73','m42_74','m42_75','m43_144','m43_145','m43_146','m43_153','m43_154','m43_45','m43_46','m43_47','m43_48','m43_49','m43_50','m43_51','m43_52','m43_53','m43_54','m43_55','m43_56','m43_72','m43_73','m43_74','m43_75','m44_144','m44_145','m44_146','m44_148','m44_149','m44_150','m44_151','m44_152','m44_153','m44_154','m44_155','m44_45','m44_46','m44_47','m44_48','m44_49','m44_50','m44_51','m44_52','m44_53','m44_54','m44_55','m44_72','m44_73','m44_74','m44_75','m45_145','m45_146','m45_148','m45_150','m45_151','m45_152','m45_153','m45_154','m45_155','m45_45','m45_46','m45_47','m45_48','m45_49','m45_50','m45_51','m45_52','m45_53','m45_54','m45_55','m45_56','m45_57','m45_58','m45_59','m45_60','m45_61','m45_62','m45_73','m45_74','m45_75','m45_76','m46_149','m46_150','m46_152','m46_153','m46_154','m46_161','m46_45','m46_46','m46_47','m46_48','m46_49','m46_50','m46_51','m46_52','m46_53','m46_54','m46_55','m46_56','m46_57','m46_58','m46_59','m46_60','m46_61','m46_62','m46_75','m47_148','m47_149','m47_150','m47_152','m47_153','m47_160','m47_161','m47_47','m47_48','m47_49','m47_50','m47_51','m47_52','m47_53','m47_54','m47_55','m47_56','m47_57','m47_58','m47_59','m47_60','m47_61','m47_62','m47_75','m48_148','m48_149','m48_152','m48_153','m48_154','m48_155','m48_156','m48_47','m48_48','m48_49','m48_50','m48_51','m48_52','m48_53','m48_54','m48_55','m48_56','m48_57','m48_58','m48_59','m48_60','m48_61','m48_62','m49_148','m49_149','m49_153','m49_154','m49_155','m49_156','m49_46','m49_47','m49_48','m49_49','m49_50','m49_51','m49_52','m49_53','m49_54','m49_55','m49_56','m49_57','m49_58','m49_59','m49_60','m49_61','m49_62','m50_149','m50_150','m50_152','m50_153','m50_154','m50_46','m50_47','m50_48','m50_49','m50_50','m50_51','m50_52','m50_53','m50_54','m50_55','m50_56','m50_57','m50_58','m50_59','m50_60','m50_61','m50_62','m51_147','m51_154','m51_46','m51_47','m51_48','m51_49','m51_50','m51_51','m51_52','m51_53','m51_54','m51_55','m51_56','m51_57','m51_58','m51_59','m51_60','m51_61','m51_62','m52_152','m52_153','m52_154','m52_46','m52_47','m52_48','m52_49','m52_50','m52_51','m52_52','m52_53','m52_54','m52_55','m52_56','m52_57','m52_58','m52_59','m52_60','m52_61','m52_62','m53_49','m53_50','m53_51','m53_52','m53_53'];for(let e=0;e<t.length;e++){const s=t[e],n=new Uint8Array(await(await fetch(`data/pack/client/maps/${s}`)).arrayBuffer()),i=f.getcrc(n,0,n.length);Vn.set(s,n),Yn.set(s,i)}const e=['adventure.mid','al_kharid.mid','alone.mid','ambience_2.mid','ambience_3.mid','ambience_4.mid','ambient_jungle.mid','arabian.mid','arabian2.mid','arabian3.mid','arabique.mid','army_of_darkness.mid','arrival.mid','attack1.mid','attack2.mid','attack3.mid','attack4.mid','attack5.mid','attack6.mid','attention.mid','autumn_voyage.mid','background2.mid','ballad_of_enchantment.mid','baroque.mid','beyond.mid','big_chords.mid','book_of_spells.mid','camelot.mid','cave_background1.mid','cavern.mid','cellar_song1.mid','chain_of_command.mid','chompy_hunt.mid','close_quarters.mid','crystal_cave.mid','crystal_sword.mid','cursed.mid','dangerous.mid','dark2.mid','deep_wildy.mid','desert_voyage.mid','doorways.mid','dream1.mid','duel_arena.mid','dunjun.mid','egypt.mid','emotion.mid','emperor.mid','escape.mid','expanse.mid','expecting.mid','expedition.mid','fade_test.mid','faerie.mid','fanfare.mid','fanfare2.mid','fanfare3.mid','fishing.mid','flute_salad.mid','forbidden.mid','forever.mid','game_intro_1.mid','gaol.mid','garden.mid','gnome.mid','gnome_king.mid','gnome_theme.mid','gnome_village.mid','gnome_village2.mid','gnomeball.mid','greatness.mid','grumpy.mid','harmony.mid','harmony2.mid','heart_and_mind.mid','high_seas.mid','horizon.mid','iban.mid','ice_melody.mid','in_the_manor.mid','inspiration.mid','intrepid.mid','jolly-r.mid','jungle_island.mid','jungly1.mid','jungly2.mid','jungly3.mid','knightly.mid','landlubber.mid','lasting.mid','legion.mid','lightness.mid','lightwalk.mid','lonesome.mid','long_ago.mid','long_way_home.mid','lullaby.mid','mage_arena.mid','magic_dance.mid','magical_journey.mid','march2.mid','medieval.mid','mellow.mid','miles_away.mid','miracle_dance.mid','monarch_waltz.mid','moody.mid','neverland.mid','newbie_melody.mid','nightfall.mid','nomad.mid','null.mid','organ_music_1.mid','organ_music_2.mid','oriental.mid','overture.mid','parade.mid','quest.mid','regal2.mid','reggae.mid','reggae2.mid','riverside.mid','royale.mid','rune_essence.mid','sad_meadow.mid','scape_cave.mid','scape_main.mid','scape_sad1.mid','scape_soft.mid','scape_wild1.mid','sea_shanty.mid','sea_shanty2.mid','serenade.mid','serene.mid','shine.mid','shining.mid','silence.mid','soundscape.mid','spirit.mid','splendour.mid','spooky2.mid','spooky_jungle.mid','starlight.mid','start.mid','still_night.mid','talking_forest.mid','the_desert.mid','the_shadow.mid','the_tower.mid','theme.mid','tomorrow.mid','trawler.mid','trawler_minor.mid','tree_spirits.mid','tribal.mid','tribal2.mid','tribal_background.mid','trinity.mid','troubled.mid','undercurrent.mid','underground.mid','understanding.mid','unknown_land.mid','upass1.mid','upcoming.mid','venture.mid','venture2.mid','vision.mid','voodoo_cult.mid','voyage.mid','wander.mid','waterfall.mid','wilderness2.mid','wilderness3.mid','wilderness4.mid','witching.mid','wolf_mountain.mid','wonder.mid','wonderous.mid','workshop.mid','yesteryear.mid','zealot.mid'];for(let t=0;t<e.length;t++){const s=e[t],n=new Uint8Array(await(await fetch(`data/pack/client/songs/${s}`)).arrayBuffer()),i=f.getcrc(n,0,n.length);Vn.set(s,n),Yn.set(s,i)}const s=['advance agility.mid','advance attack.mid','advance attack2.mid','advance cooking.mid','advance cooking2.mid','advance crafting.mid','advance crafting2.mid','advance defense.mid','advance defense2.mid','advance firemarking.mid','advance firemarking2.mid','advance fishing.mid','advance fishing2.mid','advance fletching.mid','advance fletching2.mid','advance herblaw.mid','advance herblaw2.mid','advance hitpoints.mid','advance hitpoints2.mid','advance magic.mid','advance magic2.mid','advance mining.mid','advance mining2.mid','advance prayer.mid','advance prayer2.mid','advance ranged.mid','advance ranged2.mid','advance runecraft.mid','advance runecraft2.mid','advance smithing.mid','advance smithing2.mid','advance strength.mid','advance strength2.mid','advance thieving.mid','advance thieving2.mid','advance woodcutting.mid','advance woodcutting2.mid','death.mid','death2.mid','dice lose.mid','dice win.mid','duel start.mid','duel win2.mid','quest complete 1.mid','quest complete 2.mid','quest complete 3.mid','sailing journey.mid','treasure hunt win.mid'];for(let t=0;t<s.length;t++){const e=s[t],n=new Uint8Array(await(await fetch(`data/pack/client/jingles/${e}`)).arrayBuffer()).subarray(4),i=f.getcrc(n,0,n.length);Vn.set(e,n),Yn.set(e,i)}}()}broadcastMes(t){for(const e of this.players)e.messageGame(t)}async start(t=!1,e=!0){console.log('Starting world...'),await d.load(await(await fetch('bz2.wasm')).arrayBuffer()),await b.load('data/pack'),await St.load('data/pack'),await this.reload(),tl.loginThread.postMessage({type:'reset'}),80===_t.WEB_PORT?console.log(l.green().bold('World ready')+l.white().bold(': http://localhost')):console.log(l.green().bold('World ready')+l.white().bold(': http://localhost:'+_t.WEB_PORT)),e&&await this.cycle()}rebootTimer(t){this.shutdownTick=this.currentTick+t;for(const t of this.players)t.write(new il(this.shutdownTick-this.currentTick))}async cycle(t=!0){const e=Date.now();this.processWorld(),await this.processClientsIn(),this.processNpcs(),await this.processPlayers(),await this.processLogouts(),await this.processLogins(),this.processZones(),this.processMovementDirections(),await this.processClientsOut(),this.processCleanup();const s=this.currentTick;s%al.LOGIN_PINGRATE==0&&this.heartbeat(),this.shutdownTick>-1&&s>=this.shutdownTick&&await this.processShutdown(),s%al.PLAYER_SAVERATE==0&&s>0&&this.savePlayers(),this.currentTick++,this.cycleStats[Qs.CYCLE]=Date.now()-e,this.lastCycleStats[Qs.CYCLE]=this.cycleStats[Qs.CYCLE],this.lastCycleStats[Qs.WORLD]=this.cycleStats[Qs.WORLD],this.lastCycleStats[Qs.CLIENT_IN]=this.cycleStats[Qs.CLIENT_IN],this.lastCycleStats[Qs.NPC]=this.cycleStats[Qs.NPC],this.lastCycleStats[Qs.PLAYER]=this.cycleStats[Qs.PLAYER],this.lastCycleStats[Qs.LOGOUT]=this.cycleStats[Qs.LOGOUT],this.lastCycleStats[Qs.LOGIN]=this.cycleStats[Qs.LOGIN],this.lastCycleStats[Qs.ZONE]=this.cycleStats[Qs.ZONE],this.lastCycleStats[Qs.CLIENT_OUT]=this.cycleStats[Qs.CLIENT_OUT],this.lastCycleStats[Qs.CLEANUP]=this.cycleStats[Qs.CLEANUP],this.lastCycleStats[Qs.BANDWIDTH_IN]=this.cycleStats[Qs.BANDWIDTH_IN],this.lastCycleStats[Qs.BANDWIDTH_OUT]=this.cycleStats[Qs.BANDWIDTH_OUT],t&&setTimeout(this.cycle.bind(this),this.tickRate-this.cycleStats[Qs.CYCLE])}processWorld(){const t=Date.now(),e=this.currentTick;for(let t=this.queue.head();t;t=this.queue.next()){if(t.delay-- >0)continue;const e=t.script;try{const s=Vc.execute(e);t.unlink(),s===se.SUSPENDED?e.activePlayer.activeScript=e:s===se.NPC_SUSPENDED?e.activeNpc.activeScript=e:s===se.WORLD_SUSPENDED&&this.enqueueScript(e,e.popInt())}catch(t){console.error(t)}}if(e%al.AFK_EVENTRATE==0)for(const t of this.players)t.afkEventReady=Math.random()<(t.zonesAfk()?.1666:.0833);for(const t of this.npcs)t.updateLifeCycle(e)&&(t.lifecycle===en.RESPAWN?this.addNpc(t,-1):t.lifecycle===en.DESPAWN&&this.removeNpc(t,-1));for(const t of this.npcs)t.checkLifeCycle(e)&&!t.delayed()&&-1!==t.huntMode&&t.huntAll();this.cycleStats[Qs.WORLD]=Date.now()-t}async processClientsIn(){const t=Date.now();this.cycleStats[Qs.BANDWIDTH_IN]=0;for(const t of this.players)if(Dc(t))try{t.decodeIn()}catch(e){console.error(e),await this.removePlayer(t)}for(const t of this.players)if(Dc(t)){if(t.userPath.length>0||t.opcalled){if(t.delayed()){t.unsetMapFlag();continue}if((!t.target||t.target instanceof _n||t.target instanceof an)&&-1!==t.faceEntity&&(t.faceEntity=-1,t.mask|=Vr.FACE_ENTITY),t.opcalled&&(0===t.userPath.length||!_t.NODE_CLIENT_ROUTEFINDER)){t.pathToTarget();continue}t.pathToMoveClick(t.userPath,!_t.NODE_CLIENT_ROUTEFINDER)}t.target instanceof Vr&&(t.targetOp===In.APPLAYER3||t.targetOp===In.OPPLAYER3)&&(ts.distanceToSW(t,t.target)<=25?t.pathToPathingTarget():t.clearWaypoints())}this.cycleStats[Qs.CLIENT_IN]=Date.now()-t}processNpcs(){const t=Date.now();for(const t of this.npcs)if(t.checkLifeCycle(this.currentTick))try{if(t.delayed()&&t.delay--,t.delayed())continue;if(t.activeScript&&t.executeScript(t.activeScript),!t.checkLifeCycle(this.currentTick))continue;t.processTimers(),t.processQueue(),t.processNpcModes(),t.validateDistanceWalked()}catch(e){console.error(e),this.removeNpc(t,-1)}this.cycleStats[Qs.NPC]=Date.now()-t}async processPlayers(){const t=Date.now();for(const t of this.players)try{t.playtime++,t.delayed()&&t.delay--,t.activeScript&&!t.delayed()&&t.activeScript.execution===se.SUSPENDED&&t.executeScript(t.activeScript,!0),t.processQueues(),t.processTimers(0),t.processTimers(1),t.processEngineQueue(),t.processInteraction(),t.mask&Vr.EXACT_MOVE||t.validateDistanceWalked(),this.shutdownTick<this.currentTick&&_t.NODE_SOCKET_TIMEOUT&&this.currentTick-t.lastResponse>=al.TIMEOUT_IDLE_TICKS&&(t.logoutRequested=!0),t.logoutRequested&&t.closeModal()}catch(e){console.error(e),await this.removePlayer(t)}this.cycleStats[Qs.PLAYER]=Date.now()-t}async processLogouts(){const t=Date.now();for(const t of this.players)if(_t.NODE_SOCKET_TIMEOUT&&this.currentTick-t.lastResponse>=al.TIMEOUT_LOGOUT_TICKS&&(t.queue.clear(),t.weakQueue.clear(),t.engineQueue.clear(),t.clearInteraction(),t.closeModal(),t.unsetMapFlag(),t.logoutRequested=!0,t.setVar(At.LASTCOMBAT,0)),t.logoutRequested)if(null===t.queue.head()){const e=Qt.getByTriggerSpecific(In.LOGOUT,-1,-1);if(!e){console.error('LOGOUT TRIGGER IS BROKEN!');continue}const s=Vc.init(e,t);s.pointerAdd(kt.ProtectedActivePlayer),Vc.execute(s);0===s.popInt()&&(t.logoutRequested=!1),t.logoutRequested&&await this.removePlayer(t)}else t.messageGame('[DEBUG]: Waiting for queue to empty before logging out.');this.cycleStats[Qs.LOGOUT]=Date.now()-t}async processLogins(){const t=Date.now();t:for(const t of this.newPlayers){if(!Dc(t))continue;for(const e of this.players)if(t.username===e.username){t.client?.send(Jc.LOGGED_IN),t.client?.close();continue t}let e;try{e=this.getNextPid(t.client)}catch(e){t.client?.send(Jc.WORLD_FULL),t.client?.close();continue}this.players.set(e,t),t.pid=e,t.uid=(Number(0x1fffffn&t.username37)<<11|t.pid)>>>0,t.tele=!0,this.getZone(t.x,t.z,t.level).enter(t),t.onLogin(),this.shutdownTick>-1&&t.write(new il(this.shutdownTick-this.currentTick)),t.client&&(t.client.state=1,t.staffModLevel>=2?t.client.send(Jc.STAFF_MOD_LEVEL):t.client.send(Jc.SUCCESSFUL))}this.newPlayers.clear(),this.cycleStats[Qs.LOGIN]=Date.now()-t}processZones(){const t=Date.now(),e=this.currentTick,s=this.zonesTracking.get(e);if(void 0!==s)for(const t of s)t.tick(e);this.computeSharedEvents(),this.cycleStats[Qs.ZONE]=Date.now()-t}processMovementDirections(){for(const t of this.players)t.convertMovementDir();for(const t of this.npcs)t.convertMovementDir()}async processClientsOut(){const t=Date.now();this.cycleStats[Qs.BANDWIDTH_OUT]=0;for(const t of this.players)if(Dc(t))try{t.updateMap(),t.updatePlayers(),t.updateNpcs(),t.updateZones(),t.updateInvs(),t.updateStats(),t.updateAfkZones(),t.encodeOut()}catch(e){console.error(e),await this.removePlayer(t)}this.cycleStats[Qs.CLIENT_OUT]=Date.now()-t}processCleanup(){const t=Date.now(),e=this.currentTick,s=this.zonesTracking.get(e);if(void 0!==s)for(const t of s)t.reset();this.zonesTracking.delete(e);for(const t of this.players){t.resetEntity(!1);for(const e of t.invs.values())e&&(e.update=!1)}for(const t of this.npcs)t.checkLifeCycle(e)&&t.resetEntity(!1);for(const t of this.invs){t.update=!1;const s=J.get(t.type);if(s.restock&&s.stockcount&&s.stockrate)for(let n=0;n<t.items.length;n++){const i=t.items[n];i&&(i.count<s.stockcount[n]&&e%s.stockrate[n]==0?(t.add(i?.id,1,n,!0,!1,!1),t.update=!0):(i.count>s.stockcount[n]&&e%s.stockrate[n]==0||s.allstock&&!s.stockcount[n]&&e%al.INV_STOCKRATE==0)&&(t.remove(i?.id,1,n,!0),t.update=!0))}}this.cycleStats[Qs.CLEANUP]=Date.now()-t}heartbeat(){const t=[];for(const e of this.players)t.push(e.username37);tl.loginThread.postMessage({type:'heartbeat',players:t})}async processShutdown(){const t=this.currentTick-this.shutdownTick;if(this.getTotalPlayers()){for(const e of this.players)e.logoutRequested=!0,Dc(e)&&(e.logout(),e.client&&t>2&&e.client.close());if(this.npcs.reset(),t>2&&(this.tickRate>al.SHUTDOWN_TICKRATE&&(this.tickRate=al.SHUTDOWN_TICKRATE),t>al.SHUTDOWN_TICKS)){for(const t of this.players)await this.removePlayer(t);this.tickRate=al.NORMAL_TICKRATE}}else process.exit(0)}savePlayers(){}enqueueScript(t,e=0){this.queue.addTail(new Dn(t,e+1))}getInventory(t){if(-1===t)return null;for(const e of this.invs)if(e.type===t)return e;const e=ie.fromType(t);return this.invs.add(e),e}getZone(t,e,s){return this.zoneMap.zone(t,e,s)}getZoneIndex(t){return this.zoneMap.zoneByIndex(t)}getZoneGrid(t){return this.zoneMap.grid(t)}computeSharedEvents(){const t=new Set;for(const e of this.players)if(Dc(e))for(const s of e.buildArea.loadedZones)t.add(s);for(const e of t)this.getZoneIndex(e).computeShared()}addNpc(t,e){this.npcs.set(t.nid,t),t.x=t.startX,t.z=t.startZ;switch(this.getZone(t.x,t.z,t.level).enter(t),t.blockWalk){case at.NPC:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!0);break;case at.ALL:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!0),this.gameMap.changePlayerCollision(t.width,t.x,t.z,t.level,!0)}t.resetEntity(!0),t.playAnimation(-1,0),t.setLifeCycle(this.currentTick+e)}removeNpc(t,e){switch(this.getZone(t.x,t.z,t.level).leave(t),t.blockWalk){case at.NPC:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!1);break;case at.ALL:this.gameMap.changeNpcCollision(t.width,t.x,t.z,t.level,!1),this.gameMap.changePlayerCollision(t.width,t.x,t.z,t.level,!1)}t.lifecycle===en.DESPAWN?this.npcs.remove(t.nid):t.lifecycle===en.RESPAWN&&t.setLifeCycle(this.currentTick+e)}getLoc(t,e,s,n){return this.getZone(t,e,s).getLoc(t,e,n)}getObj(t,e,s,n,i){return this.getZone(t,e,s).getObj(t,e,n,i)}trackZone(t,e){let s;const n=this.zonesTracking.get(t);s=n||new Set,s.add(e),this.zonesTracking.set(t,s)}addLoc(t,e){const s=et.get(t.type);s.blockwalk&&this.gameMap.changeLocCollision(t.shape,t.angle,s.blockrange,s.length,s.width,s.active,t.x,t.z,t.level,!0);const n=this.getZone(t.x,t.z,t.level);n.addLoc(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,n),this.trackZone(this.currentTick,n)}mergeLoc(t,e,s,n,i,a,r,o){const c=this.getZone(t.x,t.z,t.level);c.mergeLoc(t,e,s,n,i,a,r,o),this.trackZone(this.currentTick,c)}animLoc(t,e){const s=this.getZone(t.x,t.z,t.level);s.animLoc(t,e),this.trackZone(this.currentTick,s)}removeLoc(t,e){const s=et.get(t.type);s.blockwalk&&this.gameMap.changeLocCollision(t.shape,t.angle,s.blockrange,s.length,s.width,s.active,t.x,t.z,t.level,!1);const n=this.getZone(t.x,t.z,t.level);n.removeLoc(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,n),this.trackZone(this.currentTick,n)}addObj(t,e,s){const n=gt.get(t.type),i=this.getObj(t.x,t.z,t.level,t.type,e);if(i&&i.lifecycle===en.DESPAWN&&t.lifecycle===en.DESPAWN){const s=t.count+i.count;if(n.stackable&&s<=ie.STACK_LIMIT)return void this.changeObj(i,e,s)}const a=this.getZone(t.x,t.z,t.level);a.addObj(t,e),-1!==e&&n.tradeable?(t.setLifeCycle(this.currentTick+100),this.trackZone(this.currentTick+100,a),this.trackZone(this.currentTick,a),t.receiverId=e,t.reveal=s):(t.setLifeCycle(this.currentTick+s),this.trackZone(this.currentTick+s,a),this.trackZone(this.currentTick,a))}revealObj(t){const e=t.reveal,s=this.getZone(t.x,t.z,t.level);s.revealObj(t,t.receiverId),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,s),this.trackZone(this.currentTick,s)}changeObj(t,e,s){const n=this.getZone(t.x,t.z,t.level);n.changeObj(t,e,t.count,s),this.trackZone(this.currentTick,n)}removeObj(t,e){const s=this.getZone(t.x,t.z,t.level);s.removeObj(t),t.setLifeCycle(this.currentTick+e),this.trackZone(this.currentTick+e,s),this.trackZone(this.currentTick,s)}animMap(t,e,s,n,i,a){const r=this.getZone(e,s,t);r.animMap(e,s,n,i,a),this.trackZone(this.currentTick,r)}mapProjAnim(t,e,s,n,i,a,r,o,c,l,h,d,p){const u=this.getZone(e,s,t);u.mapProjAnim(e,s,n,i,a,r,o,c,l,h,d,p),this.trackZone(this.currentTick,u)}async readIn(t,e){for(;e.available>0;){const s=e.pos;let n=e.g1();if(t.decryptor&&(n=n-t.decryptor.nextInt()&255,e.data[s]=n),void 0===Yr.byId[n])return t.state=-1,void t.close();let i=Yr.byId[n].length;if(-1===i?i=e.g1():-2===i&&(i=e.g2()),e.available<i)break;if(e.pos+=i,t.inCount[n]++,t.inCount[n]>5)continue;const a=new Uint8Array(e.pos-s),r=e.pos;e.pos=s,e.gdata(a,0,a.length),e.pos=r,t.in.set(a,t.inOffset),t.inOffset+=e.pos-s}}addPlayer(t){this.newPlayers.add(t)}async removePlayer(t){-1!==t.pid&&(t.playerLog('Logging out'),Dc(t)&&(t.logout(),t.client.close(),t.client=null),tl.logout(t))}getPlayer(t){return this.players.get(t)}getPlayerByUid(t){const e=2047&t,s=t>>11&2097151,n=this.getPlayer(e);return n?Number(0x1fffffn&n.username37)!==s?null:n:null}getPlayerByUsername(t){const e=p(t);for(const t of this.players)if(t.username37===e)return t;for(const t of this.newPlayers)if(t.username37===e)return t}getTotalPlayers(){return this.players.count}getTotalNpcs(){return this.npcs.count}getTotalZones(){return this.zoneMap.zoneCount()}getTotalLocs(){return this.zoneMap.locCount()}getTotalObjs(){return this.zoneMap.objCount()}getNpc(t){return this.npcs.get(t)}getNpcByUid(t){const e=65535&t,s=t>>16&65535,n=this.getNpc(e);return n&&n.type===s?n:null}getNextNid(){return this.npcs.next()}getNextPid(t=null){if(t){const e=t.remoteAddress.split('.'),s=parseInt(e[3])%20*100;return this.players.next(!0,s)}return this.players.next()}}var rl=new al;await rl.start();var ol=new class{socket=new tc;constructor(){}start(){const t=new f(new Uint8Array(8));t.p4(Math.floor(4294967295*Math.random())),t.p4(Math.floor(4294967295*Math.random())),this.socket.send(t.data),self.onmessage=async t=>{const e=new f(new Uint8Array(t.data));if('message'===t.type)try{1===this.socket.state?await rl.readIn(this.socket,e):await tl.readIn(this.socket,e)}catch(t){this.socket.close()}}}};ol.start();